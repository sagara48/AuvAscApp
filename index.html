<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockApp v6.0 - ElevatorPark</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23E11D48' rx='20' width='100' height='100'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='50' font-weight='bold' font-family='sans-serif'%3ES%3C/text%3E%3C/svg%3E">
    <!-- manifest.json désactivé pour ouverture locale -->
    <meta name="theme-color" content="#E11D48">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StockApp">
    <meta name="description" content="StockApp v5.6 - Gestion de stock et interventions terrain avec thèmes personnalisés, NFC, véhicules et mode hors-ligne">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <!-- v5.1 - SheetJS pour export Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- v5.1 - Chart.js pour graphiques -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- v6.0 - Leaflet pour cartes -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
:root {
    --primary: #E11D48;
    --primary-light: #FDA4AF;
    --primary-dark: #BE123C;
    --primary-pastel: #FFF1F2;
    --secondary: #F97316;
    --secondary-pastel: #FFF7ED;
    --success: #10B981;
    --success-pastel: #D1FAE5;
    --warning: #F59E0B;
    --warning-pastel: #FEF3C7;
    --danger: #EF4444;
    --danger-pastel: #FEE2E2;
    --info: #3B82F6;
    --info-pastel: #DBEAFE;
    --purple: #8B5CF6;
    --purple-pastel: #EDE9FE;
    --teal: #14B8A6;
    --teal-pastel: #CCFBF1;
    --text: #1E293B;
    --text-secondary: #475569;
    --muted: #94A3B8;
    --border: #E2E8F0;
    --background: #F8FAFC;
    --card: #FFFFFF;
    --sidebar-width: 260px;
    --sidebar-collapsed: 72px;
    --header-height: 64px;
    --radius: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.05);
    --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--background);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
}
#loading {
    position: fixed; inset: 0;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    display: flex; align-items: center; justify-content: center; z-index: 9999;
}
#loading .spinner {
    width: 48px; height: 48px;
    border: 3px solid rgba(255,255,255,0.2);
    border-top-color: white; border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

.app { display: flex; min-height: 100vh; }

/* Sidebar */
.sidebar {
    position: fixed; left: 0; top: 0; bottom: 0;
    width: var(--sidebar-width);
    background: var(--card);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    z-index: 100;
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow);
}
.sidebar.collapsed { width: var(--sidebar-collapsed); }
.sidebar-header {
    height: var(--header-height);
    padding: 0 20px;
    display: flex; align-items: center; gap: 12px;
    border-bottom: 1px solid var(--border);
}
.sidebar-logo {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 800; font-size: 16px; flex-shrink: 0;
}
.sidebar-title {
    font-size: 18px; font-weight: 700; color: var(--text);
    white-space: nowrap; overflow: hidden; transition: opacity 0.2s;
}
.sidebar.collapsed .sidebar-title { opacity: 0; width: 0; }
.sidebar-nav { flex: 1; padding: 16px 12px; overflow-y: auto; overflow-x: hidden; }
.nav-section { margin-bottom: 24px; }
.nav-section-title {
    font-size: 11px; font-weight: 600; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.5px;
    padding: 0 12px; margin-bottom: 8px;
    white-space: nowrap; overflow: hidden;
}
.sidebar.collapsed .nav-section-title { opacity: 0; height: 0; margin: 0; }
.nav-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px; border-radius: var(--radius);
    cursor: pointer; transition: var(--transition);
    color: var(--text-secondary); font-weight: 500; font-size: 14px;
    margin-bottom: 4px; white-space: nowrap; position: relative;
}
.nav-item:hover { background: var(--background); color: var(--text); }
.nav-item.active { background: var(--primary-pastel); color: var(--primary); }
.nav-item.active::before {
    content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%);
    width: 3px; height: 20px; background: var(--primary); border-radius: 0 3px 3px 0;
}
.nav-item-icon { width: 20px; height: 20px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
.nav-item-text { flex: 1; overflow: hidden; }
.sidebar.collapsed .nav-item-text { opacity: 0; width: 0; }
.nav-item-badge {
    padding: 2px 8px; background: var(--primary); color: white;
    font-size: 11px; font-weight: 600; border-radius: 10px; min-width: 20px; text-align: center;
}
.sidebar.collapsed .nav-item-badge { position: absolute; top: 6px; right: 6px; padding: 2px 5px; font-size: 9px; }
.sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
.sidebar-toggle {
    width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;
    padding: 10px; border: none; background: var(--background); border-radius: var(--radius);
    cursor: pointer; color: var(--text-secondary); font-size: 13px; font-weight: 500; transition: var(--transition);
}
.sidebar-toggle:hover { background: var(--border); }
.sidebar.collapsed .sidebar-toggle span { display: none; }

/* Main Content */
.main-content {
    flex: 1; margin-left: var(--sidebar-width);
    transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 100vh; display: flex; flex-direction: column;
    max-width: calc(100vw - var(--sidebar-width));
    overflow-x: hidden;
}
.sidebar.collapsed ~ .main-content { margin-left: var(--sidebar-collapsed); max-width: calc(100vw - var(--sidebar-collapsed)); }

/* Header */
.header {
    height: var(--header-height); background: var(--card);
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 24px; position: sticky; top: 0; z-index: 50;
}
.header-left { display: flex; align-items: center; gap: 16px; }
.header-search {
    display: flex; align-items: center; gap: 10px;
    background: var(--background); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 8px 16px; width: 320px;
    transition: var(--transition);
}
.header-search:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-pastel); }
.header-search input { flex: 1; border: none; background: none; font-size: 14px; color: var(--text); outline: none; font-family: inherit; }
.header-search input::placeholder { color: var(--muted); }
.header-actions { display: flex; align-items: center; gap: 8px; }
.header-btn {
    width: 40px; height: 40px; border: none; background: transparent;
    border-radius: var(--radius); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-secondary); transition: var(--transition); position: relative;
}
.header-btn:hover { background: var(--background); color: var(--text); }
.header-btn .notif-badge {
    position: absolute; top: 6px; right: 6px;
    width: 8px; height: 8px; background: var(--primary);
    border-radius: 50%; border: 2px solid var(--card);
}
.user-menu {
    display: flex; align-items: center; gap: 12px;
    padding: 6px 12px 6px 6px; border-radius: var(--radius);
    cursor: pointer; transition: var(--transition); margin-left: 8px;
}
.user-menu:hover { background: var(--background); }
.user-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 600; font-size: 14px;
}
.user-info { text-align: right; }
.user-name { font-size: 14px; font-weight: 600; color: var(--text); }
.user-role { font-size: 12px; color: var(--muted); }

/* Page Content */
.page-content { flex: 1; padding: 24px; overflow-x: auto; max-width: 100%; overflow-y: auto; }
.page-content.split-view-active { padding: 0; overflow: hidden; }
.page-content.split-view-active > div { height: 100%; }
.page-header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; }
.page-header-left {}
.page-title { font-size: 24px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
.page-subtitle { font-size: 14px; color: var(--muted); }
.page-actions { display: flex; gap: 12px; align-items: center; }

/* Cards */
.card {
    background: var(--card); border-radius: var(--radius-lg);
    border: 1px solid var(--border); box-shadow: var(--shadow-sm);
    transition: var(--transition); overflow: hidden;
}
.card:hover { box-shadow: var(--shadow); }
.card-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between; gap: 16px;
}
.card-title { font-size: 15px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px; }
.card-body { padding: 20px; }
.card-body.no-padding { padding: 0; }

/* KPI Cards */
.kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
.kpi-card {
    background: var(--card); border-radius: var(--radius-lg); border: 1px solid var(--border);
    padding: 20px; transition: var(--transition); position: relative; overflow: hidden;
}
.kpi-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }
.kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
.kpi-card.primary::before { background: var(--primary); }
.kpi-card.success::before { background: var(--success); }
.kpi-card.warning::before { background: var(--warning); }
.kpi-card.danger::before { background: var(--danger); }
.kpi-card.info::before { background: var(--info); }
.kpi-card.teal::before { background: var(--teal); }
.kpi-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 12px; }
.kpi-icon { width: 44px; height: 44px; border-radius: var(--radius); display: flex; align-items: center; justify-content: center; }
.kpi-card.primary .kpi-icon { background: var(--primary-pastel); color: var(--primary); }
.kpi-card.success .kpi-icon { background: var(--success-pastel); color: var(--success); }
.kpi-card.warning .kpi-icon { background: var(--warning-pastel); color: var(--warning); }
.kpi-card.danger .kpi-icon { background: var(--danger-pastel); color: var(--danger); }
.kpi-card.info .kpi-icon { background: var(--info-pastel); color: var(--info); }
.kpi-card.teal .kpi-icon { background: var(--teal-pastel); color: var(--teal); }
.kpi-label { font-size: 13px; color: var(--muted); font-weight: 500; margin-bottom: 6px; }
.kpi-value { font-size: 28px; font-weight: 700; color: var(--text); margin-bottom: 8px; letter-spacing: -0.5px; }
.kpi-trend { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; }
.kpi-trend.up { color: var(--success); }
.kpi-trend.down { color: var(--danger); }
.kpi-trend-text { color: var(--muted); }

/* Charts */
.charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px; }
.bar-chart { display: flex; align-items: flex-end; gap: 12px; height: 200px; padding: 20px 0; }
.bar-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; }
.bar-wrapper { width: 100%; height: 160px; display: flex; align-items: flex-end; justify-content: center; gap: 4px; }
.bar { width: 20px; border-radius: 4px 4px 0 0; transition: var(--transition); cursor: pointer; position: relative; }
.bar:hover { opacity: 0.8; }
.bar.entries { background: var(--primary); }
.bar.exits { background: var(--primary-light); }
.bar-label { font-size: 12px; color: var(--muted); font-weight: 500; }
.chart-legend { display: flex; justify-content: center; gap: 24px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
.legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); }
.legend-dot { width: 10px; height: 10px; border-radius: 50%; }
.legend-dot.entries { background: var(--primary); }
.legend-dot.exits { background: var(--primary-light); }

/* Donut */
.donut-container { display: flex; flex-direction: column; align-items: center; padding: 20px; }
.donut-chart { width: 160px; height: 160px; position: relative; margin-bottom: 20px; }
.donut-chart svg { width: 100%; height: 100%; transform: rotate(-90deg); }
.donut-chart circle { fill: none; stroke-width: 24; stroke-linecap: round; }
.donut-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
.donut-value { font-size: 24px; font-weight: 700; color: var(--text); }
.donut-label { font-size: 12px; color: var(--muted); }
.donut-legend { width: 100%; }
.donut-legend-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); }
.donut-legend-item:last-child { border-bottom: none; }
.donut-legend-left { display: flex; align-items: center; gap: 10px; }
.donut-legend-dot { width: 10px; height: 10px; border-radius: 50%; }
.donut-legend-label { font-size: 13px; color: var(--text-secondary); }
.donut-legend-value { font-size: 13px; font-weight: 600; color: var(--text); }

/* Bottom Grid */
.bottom-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

/* Tables */
.table-container { overflow-x: auto; max-width: 100%; }
.table-container table { min-width: 800px; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 14px 16px; text-align: left; border-bottom: 1px solid var(--border); }
th { font-size: 12px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; background: var(--background); }
td { font-size: 14px; }
tr:hover td { background: var(--background); }
tr:last-child td { border-bottom: none; }
.table-actions { display: flex; gap: 4px; }

/* Progress Bar */
.progress-bar { width: 100%; height: 6px; background: var(--background); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
.progress-fill.high { background: var(--success); }
.progress-fill.medium { background: var(--warning); }
.progress-fill.low { background: var(--primary); }
.progress-text { font-size: 12px; font-weight: 600; color: var(--text); margin-top: 4px; }

/* Timeline */
.timeline { padding: 0; }
.timeline-item { display: flex; gap: 12px; padding: 16px 0; border-bottom: 1px solid var(--border); position: relative; }
.timeline-item:last-child { border-bottom: none; }
.timeline-dot { width: 10px; height: 10px; border-radius: 50%; margin-top: 4px; flex-shrink: 0; }
.timeline-dot.urgent { background: var(--danger); }
.timeline-dot.warning { background: var(--warning); }
.timeline-dot.normal { background: var(--success); }
.timeline-content { flex: 1; }
.timeline-date { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.timeline-date-text { font-size: 12px; color: var(--muted); }
.timeline-badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; }
.timeline-badge.today { background: var(--danger-pastel); color: var(--danger); }
.timeline-badge.tomorrow { background: var(--warning-pastel); color: var(--warning); }
.timeline-badge.week { background: var(--success-pastel); color: var(--success); }
.timeline-title { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 2px; }
.timeline-desc { font-size: 12px; color: var(--muted); }

/* Buttons */
.btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 10px 18px; border-radius: var(--radius); font-size: 14px; font-weight: 600;
    cursor: pointer; transition: var(--transition); border: none; font-family: inherit;
    white-space: nowrap;
}
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-secondary { background: var(--background); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover { background: var(--border); }
.btn-success { background: var(--success); color: white; }
.btn-success:hover { background: #059669; }
.btn-warning { background: var(--warning); color: white; }
.btn-warning:hover { background: #D97706; }
.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover { background: #DC2626; }
.btn-ghost { background: transparent; color: var(--text-secondary); }
.btn-ghost:hover { background: var(--background); color: var(--text); }
.btn-sm { padding: 6px 12px; font-size: 13px; }
.btn-icon { width: 36px; height: 36px; padding: 0; }
.btn-icon.btn-sm { width: 32px; height: 32px; }

/* Fix pour eviter le contenu tronque */
.page-content { overflow-x: auto; }
.page-content > div { min-width: 0; }

/* Badges */
.badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 600; }
.badge-success { background: var(--success-pastel); color: var(--success); }
.badge-warning { background: var(--warning-pastel); color: var(--warning); }
.badge-danger { background: var(--danger-pastel); color: var(--danger); }
.badge-orange { background: #FED7AA; color: #EA580C; }
.badge-secondary { background: #F1F5F9; color: #64748B; }
.badge-info { background: var(--info-pastel); color: var(--info); }
.badge-primary { background: var(--primary-pastel); color: var(--primary); }
.badge-purple { background: var(--purple-pastel); color: var(--purple); }
.badge-teal { background: var(--teal-pastel); color: var(--teal); }
.badge-muted { background: var(--background); color: var(--muted); }

/* Status Dot */
.status-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.status-dot.completed, .status-dot.success { background: var(--success); }
.status-dot.in-progress, .status-dot.warning { background: var(--warning); }
.status-dot.pending, .status-dot.muted { background: var(--muted); }
.status-dot.danger { background: var(--danger); }

/* Modal */
.modal-overlay {
    position: fixed; inset: 0;
    background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000; padding: 20px; animation: fadeIn 0.2s ease;
}
.modal {
    background: var(--card); border-radius: var(--radius-xl); box-shadow: var(--shadow-xl);
    width: 100%; max-height: 90vh; overflow: hidden;
    display: flex; flex-direction: column; animation: slideUp 0.3s ease;
}
.modal.sm { max-width: 400px; }
.modal.md { max-width: 540px; }
.modal.lg { max-width: 720px; }
.modal.xl { max-width: 960px; }
.modal-header {
    padding: 20px 24px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
}
.modal-title { font-size: 18px; font-weight: 700; color: var(--text); }
.modal-close {
    width: 36px; height: 36px; border: none; background: var(--background);
    border-radius: var(--radius); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: var(--text-secondary); transition: var(--transition);
}
.modal-close:hover { background: var(--border); color: var(--text); }
.modal-body { padding: 24px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

/* Forms */
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
.form-input, .form-select, .form-textarea {
    width: 100%; padding: 10px 14px; border: 1px solid var(--border);
    border-radius: var(--radius); font-size: 14px; color: var(--text);
    background: var(--card); transition: var(--transition); font-family: inherit;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-pastel);
}
.form-textarea { min-height: 100px; resize: vertical; }
.form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
.form-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
.form-hint { font-size: 12px; color: var(--muted); margin-top: 4px; }

/* Info Grid */
.info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
.info-item {}
.info-item .label, .info-label { font-size: 12px; color: var(--muted); margin-bottom: 4px; }
.info-item .value, .info-value { font-size: 14px; font-weight: 600; color: var(--text); }
.info-value.large { font-size: 32px; }

/* Toast */
.toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 12px; }
.toast {
    padding: 14px 20px; background: var(--card); border-radius: var(--radius);
    box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px;
    animation: slideIn 0.3s ease; border-left: 4px solid;
}
.toast.success { border-color: var(--success); }
.toast.error { border-color: var(--danger); }
.toast.warning { border-color: var(--warning); }
.toast-message { font-size: 14px; color: var(--text); }

/* Empty State */
.empty-state { text-align: center; padding: 60px 20px; }
.empty-icon {
    width: 64px; height: 64px; margin: 0 auto 16px;
    background: var(--background); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; color: var(--muted);
}
.empty-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 4px; }
.empty-desc { font-size: 14px; color: var(--muted); }

/* Login */
.login-container {
    min-height: 100vh; display: flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, #7f1d1d 0%, #dc2626 50%, #ef4444 100%); 
    padding: 20px; position: relative; overflow: hidden;
}
.login-container::before {
    content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 50%);
    animation: pulse 15s ease-in-out infinite;
}
@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
.login-card {
    width: 100%; max-width: 420px; background: rgba(255, 255, 255, 0.98);
    border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4); padding: 48px 40px;
    position: relative; z-index: 10; backdrop-filter: blur(20px);
}
.login-logo-container {
    width: 140px; height: auto; margin: 0 auto 20px; text-align: center;
}
.login-logo-img {
    width: 100%; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
}
.login-logo {
    width: 56px; height: 56px;
    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    border-radius: 14px; display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 800; font-size: 24px; margin: 0 auto 24px;
    box-shadow: 0 10px 20px -5px rgba(220, 38, 38, 0.4);
}
.login-title { text-align: center; font-size: 28px; font-weight: 700; color: #1e293b; margin-bottom: 8px; }
.login-subtitle { text-align: center; font-size: 15px; color: #64748b; margin-bottom: 32px; }
.login-form .form-group { margin-bottom: 20px; }
.login-form .form-label { font-weight: 600; color: #334155; margin-bottom: 8px; display: block; font-size: 14px; }
.login-form .form-input {
    width: 100%; padding: 14px 16px; border-radius: 12px; border: 2px solid #e2e8f0;
    font-size: 15px; transition: all 0.2s; background: #f8fafc;
}
.login-form .form-input:focus { border-color: #dc2626; background: white; outline: none; box-shadow: 0 0 0 4px rgba(220, 38, 38, 0.1); }
.login-form .btn { 
    width: 100%; padding: 16px; font-size: 16px; font-weight: 600; border-radius: 12px;
    background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    box-shadow: 0 10px 20px -5px rgba(220, 38, 38, 0.4);
    transition: all 0.3s;
}
.login-form .btn:hover { transform: translateY(-2px); box-shadow: 0 15px 30px -5px rgba(220, 38, 38, 0.5); }
.login-footer { text-align: center; margin-top: 24px; font-size: 13px; color: #94a3b8; }

/* Tabs */
.tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); margin-bottom: 20px; padding: 0; background: var(--background); border-radius: var(--radius) var(--radius) 0 0; }
.tab {
    padding: 12px 20px; font-size: 14px; font-weight: 500;
    color: var(--muted); cursor: pointer; border: none; background: none;
    border-bottom: 2px solid transparent;
    transition: var(--transition); margin-bottom: -1px;
}
.tab:hover { color: var(--text); background: rgba(0,0,0,0.02); }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); background: white; }

/* Filters */
.filters { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
.filter-btn {
    padding: 8px 16px; border-radius: var(--radius); font-size: 13px; font-weight: 500;
    background: var(--background); color: var(--text-secondary); border: 1px solid var(--border);
    cursor: pointer; transition: var(--transition);
}
.filter-btn:hover { background: var(--border); }
.filter-btn.active { background: var(--primary-pastel); color: var(--primary); border-color: var(--primary); }
.filter-chip { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: white; cursor: pointer; font-size: 13px; transition: all .2s; display: inline-flex; align-items: center; gap: 6px; }
.filter-chip:hover { border-color: var(--primary); }
.filter-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
.filter-chip .count { background: rgba(0,0,0,.1); padding: 2px 8px; border-radius: 10px; font-size: 11px; }
.filter-chip.active .count { background: rgba(255,255,255,.2); }
.grid-auto { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }

/* Work List */
.work-list { display: flex; flex-direction: column; gap: 8px; }
.work-item {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 12px; background: var(--background); border-radius: var(--radius);
}
.work-item .status {
    padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600;
    text-transform: uppercase; flex-shrink: 0;
}
.work-item .status.termine, .work-item .status.effectue { background: var(--success-pastel); color: var(--success); }
.work-item .status.en-stock, .work-item .status.pret { background: var(--info-pastel); color: var(--info); }
.work-item .status.en-commande { background: var(--warning-pastel); color: var(--warning); }
.work-item .text { font-size: 14px; color: var(--text); flex: 1; }

/* Grid layouts */
.grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

/* Responsive */
@media (max-width: 1200px) {
    .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    .charts-grid, .bottom-grid, .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
}
.mobile-menu-btn { display: none; }
@media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0 !important; }
    .kpi-grid { grid-template-columns: 1fr; }
    .header-search { display: none; }
    .mobile-menu-btn { display: flex !important; }
    .form-row, .form-row-3 { grid-template-columns: 1fr; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--muted); }

/* Barcode */
.barcode-container { display: flex; justify-content: center; padding: 20px; background: white; border-radius: var(--radius); }
.barcode-container svg { max-width: 100%; }

/* Confirm Dialog */
.confirm-content { text-align: center; padding: 20px 0; }
.confirm-icon { width: 64px; height: 64px; margin: 0 auto 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
.confirm-icon.danger { background: var(--danger-pastel); color: var(--danger); }
.confirm-icon.warning { background: var(--warning-pastel); color: var(--warning); }
.confirm-title { font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.confirm-message { font-size: 14px; color: var(--muted); }

/* Notifications Dropdown */
.notif-dropdown { position: absolute; top: 100%; right: 0; width: 380px; max-height: 500px; background: white; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); z-index: 1000; overflow: hidden; margin-top: 8px; }
.notif-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
.notif-header-title { font-weight: 600; font-size: 16px; display: flex; align-items: center; gap: 8px; }
.notif-header-count { background: var(--primary); color: white; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
.notif-header-actions { display: flex; gap: 8px; }
.notif-list { max-height: 380px; overflow-y: auto; }
.notif-item { display: flex; gap: 12px; padding: 14px 20px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid var(--border); }
.notif-item:hover { background: var(--background); }
.notif-item.unread { background: var(--primary-pastel); }
.notif-item.unread:hover { background: #E0E7FF; }
.notif-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
.notif-icon.stock_alert { background: var(--warning-pastel); }
.notif-icon.stock_withdrawal { background: var(--primary-pastel); }
.notif-icon.part_request { background: #EDE9FE; }
.notif-icon.part_request_validated { background: var(--success-pastel); }
.notif-icon.part_request_rejected { background: var(--danger-pastel); }
.notif-icon.task_assigned { background: var(--primary-pastel); }
.notif-icon.task_completed { background: var(--success-pastel); }
.notif-icon.task_overdue { background: var(--danger-pastel); }
.notif-icon.order_created { background: #EDE9FE; }
.notif-icon.order_received { background: var(--success-pastel); }
.notif-icon.order_partial { background: var(--warning-pastel); }
.notif-icon.planning_event_created { background: var(--primary-pastel); }
.notif-icon.planning_event_modified { background: var(--warning-pastel); }
.notif-icon.planning_event_deleted { background: var(--danger-pastel); }
.notif-icon.planning_event_assigned { background: #EDE9FE; }
.notif-icon.timesheet_submitted { background: var(--primary-pastel); }
.notif-icon.timesheet_validated { background: var(--success-pastel); }
.notif-icon.timesheet_rejected { background: var(--danger-pastel); }
.notif-icon.timesheet_reminder { background: var(--warning-pastel); }
.notif-icon.device_created { background: #EDE9FE; }
.notif-icon.device_updated { background: var(--primary-pastel); }
.notif-icon.device_archived { background: var(--secondary-pastel); }
.notif-icon.inspection_report_created { background: var(--success-pastel); }
.notif-icon.inspection_report_validated { background: var(--success-pastel); }
.notif-icon.bc_report_created { background: var(--warning-pastel); }
.notif-icon.bc_report_favorable { background: var(--success-pastel); }
.notif-icon.bc_report_defavorable { background: var(--danger-pastel); }
.notif-icon.request_created { background: #FED7AA; }
.notif-icon.request_assigned { background: var(--primary-pastel); }
.notif-icon.request_completed { background: var(--success-pastel); }
.notif-icon.system_message { background: var(--secondary-pastel); }
.notif-icon.user_mention { background: #FCE7F3; }
.notif-icon.welcome { background: var(--success-pastel); }
.notif-content { flex: 1; min-width: 0; }
.notif-title { font-weight: 600; font-size: 14px; color: var(--text); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.notif-body { font-size: 13px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.notif-time { font-size: 11px; color: var(--muted); margin-top: 4px; }
.notif-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--primary); flex-shrink: 0; margin-top: 6px; }
.notif-empty { text-align: center; padding: 40px 20px; color: var(--muted); }
.notif-empty-icon { font-size: 48px; margin-bottom: 12px; }
.notif-footer { padding: 12px 20px; border-top: 1px solid var(--border); text-align: center; }
.notif-footer a { color: var(--primary); font-size: 13px; font-weight: 500; text-decoration: none; }
.notif-footer a:hover { text-decoration: underline; }
.notif-backdrop { position: fixed; inset: 0; z-index: 999; }
.notif-wrapper { position: relative; }
.header-btn { position: relative; width: 40px; height: 40px; border-radius: 10px; border: none; background: var(--background); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text); transition: all 0.2s; }
.header-btn:hover { background: var(--border); }
.header-btn .notif-badge { position: absolute; top: 6px; right: 6px; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; border: 2px solid white; }
.header-btn .notif-badge-count { position: absolute; top: 2px; right: 2px; min-width: 18px; height: 18px; background: var(--danger); border-radius: 9px; font-size: 10px; font-weight: 700; color: white; display: flex; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid white; }
@media (max-width: 768px) { .notif-dropdown { width: calc(100vw - 32px); right: -60px; } }

/* Realtime Status Indicator */
.realtime-indicator { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.realtime-indicator.connected { background: rgba(16, 185, 129, 0.1); color: #059669; }
.realtime-indicator.disconnected { background: rgba(239, 68, 68, 0.1); color: #DC2626; }
.realtime-indicator .dot { width: 8px; height: 8px; border-radius: 50%; }
.realtime-indicator.connected .dot { background: #10B981; animation: pulse 2s infinite; }
.realtime-indicator.disconnected .dot { background: #EF4444; }
@keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }

/* Flash animation for updated items */
@keyframes flash-update { 0% { background-color: rgba(79, 70, 229, 0.2); } 100% { background-color: transparent; } }
.flash-update { animation: flash-update 1s ease-out; }

/* ==========================================
   ANIMATIONS & TRANSITIONS
   ========================================== */

/* Nouvelles animations */
@keyframes fadeInUp { 
    from { opacity: 0; transform: translateY(20px); } 
    to { opacity: 1; transform: translateY(0); } 
}
@keyframes fadeInDown { 
    from { opacity: 0; transform: translateY(-20px); } 
    to { opacity: 1; transform: translateY(0); } 
}
@keyframes fadeInLeft { 
    from { opacity: 0; transform: translateX(-20px); } 
    to { opacity: 1; transform: translateX(0); } 
}
@keyframes fadeInRight { 
    from { opacity: 0; transform: translateX(20px); } 
    to { opacity: 1; transform: translateX(0); } 
}
@keyframes scaleIn { 
    from { opacity: 0; transform: scale(0.9); } 
    to { opacity: 1; transform: scale(1); } 
}
@keyframes scaleUp { 
    from { transform: scale(1); } 
    to { transform: scale(1.05); } 
}
@keyframes bounce { 
    0%, 100% { transform: translateY(0); } 
    50% { transform: translateY(-5px); } 
}
@keyframes shake { 
    0%, 100% { transform: translateX(0); } 
    25% { transform: translateX(-5px); } 
    75% { transform: translateX(5px); } 
}
@keyframes ripple {
    0% { transform: scale(0); opacity: 0.5; }
    100% { transform: scale(4); opacity: 0; }
}
@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}
@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
@keyframes glow {
    0%, 100% { box-shadow: 0 0 5px var(--primary); }
    50% { box-shadow: 0 0 20px var(--primary), 0 0 30px var(--primary-light); }
}
@keyframes checkmark {
    0% { stroke-dashoffset: 24; }
    100% { stroke-dashoffset: 0; }
}

/* Classes d'animation utilitaires */
.animate-fadeIn { animation: fadeIn 0.4s ease-out; }
.animate-fadeInUp { animation: fadeInUp 0.4s ease-out; }
.animate-fadeInDown { animation: fadeInDown 0.4s ease-out; }
.animate-fadeInLeft { animation: fadeInLeft 0.4s ease-out; }
.animate-fadeInRight { animation: fadeInRight 0.4s ease-out; }
.animate-scaleIn { animation: scaleIn 0.3s ease-out; }
.animate-bounce { animation: bounce 0.5s ease-in-out; }
.animate-shake { animation: shake 0.4s ease-in-out; }
.animate-float { animation: float 3s ease-in-out infinite; }

/* Delais d'animation */
.delay-100 { animation-delay: 0.1s; }
.delay-200 { animation-delay: 0.2s; }
.delay-300 { animation-delay: 0.3s; }
.delay-400 { animation-delay: 0.4s; }
.delay-500 { animation-delay: 0.5s; }

/* Transitions ameliorees pour les cartes */
.card {
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), 
                box-shadow 0.3s ease,
                border-color 0.2s ease;
}
.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 24px -8px rgba(0,0,0,0.15);
}
.card:active {
    transform: translateY(-2px);
}

/* Transitions pour les badges */
.badge {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.badge:hover {
    transform: scale(1.05);
}

/* Effet Ripple pour les boutons */
.btn {
    position: relative;
    overflow: hidden;
    transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1),
                box-shadow 0.2s ease,
                background 0.2s ease;
}
.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.btn::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    pointer-events: none;
    background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
    background-repeat: no-repeat;
    background-position: 50%;
    transform: scale(10, 10);
    opacity: 0;
    transition: transform 0.4s, opacity 0.8s;
}
.btn:active::after {
    transform: scale(0, 0);
    opacity: 0.3;
    transition: 0s;
}

/* Transitions pour les elements de navigation */
.nav-item {
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}
.nav-item:hover {
    transform: translateX(4px);
}
.nav-item.active {
    transform: translateX(0);
}

/* Transitions pour les inputs */
.form-input, .form-select, .form-textarea {
    transition: border-color 0.2s ease,
                box-shadow 0.2s ease,
                transform 0.2s ease;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
    transform: scale(1.01);
}

/* Transitions pour les lignes de tableau */
tr {
    transition: background-color 0.2s ease, transform 0.2s ease;
}
tr:hover {
    transform: scale(1.005);
}

/* Transitions pour les tabs */
.tab {
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}
.tab::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background: var(--primary);
    transition: all 0.3s ease;
    transform: translateX(-50%);
}
.tab:hover::after {
    width: 50%;
}
.tab.active::after {
    width: 100%;
}

/* ==========================================
   CHECKBOXES DESIGN MODERNE
   ========================================== */

/* Reset et base des checkboxes */
input[type="checkbox"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 22px;
    height: 22px;
    border: 2px solid var(--border);
    border-radius: 6px;
    background: white;
    cursor: pointer;
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
}

input[type="checkbox"]:hover {
    border-color: var(--primary);
    transform: scale(1.1);
    box-shadow: 0 0 0 4px var(--primary-pastel);
}

input[type="checkbox"]:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-pastel);
}

input[type="checkbox"]:checked {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border-color: var(--primary);
    animation: scaleIn 0.2s ease-out;
}

input[type="checkbox"]:checked::after {
    content: '';
    position: absolute;
    top: 3px;
    left: 7px;
    width: 6px;
    height: 10px;
    border: solid white;
    border-width: 0 2.5px 2.5px 0;
    transform: rotate(45deg);
    animation: checkmark 0.3s ease-out forwards;
}

input[type="checkbox"]:checked:hover {
    transform: scale(1.1);
    box-shadow: 0 0 0 4px var(--primary-pastel), 0 4px 12px rgba(225, 29, 72, 0.3);
}

/* Checkbox variante Success */
input[type="checkbox"].checkbox-success:checked {
    background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    border-color: var(--success);
}
input[type="checkbox"].checkbox-success:hover {
    border-color: var(--success);
    box-shadow: 0 0 0 4px var(--success-pastel);
}

/* Checkbox variante Warning */
input[type="checkbox"].checkbox-warning:checked {
    background: linear-gradient(135deg, var(--warning) 0%, #D97706 100%);
    border-color: var(--warning);
}
input[type="checkbox"].checkbox-warning:hover {
    border-color: var(--warning);
    box-shadow: 0 0 0 4px var(--warning-pastel);
}

/* Checkbox variante Info */
input[type="checkbox"].checkbox-info:checked {
    background: linear-gradient(135deg, var(--info) 0%, #2563EB 100%);
    border-color: var(--info);
}
input[type="checkbox"].checkbox-info:hover {
    border-color: var(--info);
    box-shadow: 0 0 0 4px var(--info-pastel);
}

/* Checkbox Large */
input[type="checkbox"].checkbox-lg {
    width: 26px;
    height: 26px;
    border-radius: 8px;
}
input[type="checkbox"].checkbox-lg:checked::after {
    top: 4px;
    left: 9px;
    width: 7px;
    height: 12px;
}

/* Checkbox Small */
input[type="checkbox"].checkbox-sm {
    width: 18px;
    height: 18px;
    border-radius: 4px;
}
input[type="checkbox"].checkbox-sm:checked::after {
    top: 2px;
    left: 5px;
    width: 5px;
    height: 9px;
    border-width: 0 2px 2px 0;
}

/* Toggle Switch Style */
input[type="checkbox"].toggle {
    width: 48px;
    height: 26px;
    border-radius: 26px;
    background: var(--border);
    border: none;
    padding: 3px;
}
input[type="checkbox"].toggle::before {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    left: 3px;
    top: 3px;
}
input[type="checkbox"].toggle:checked {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
}
input[type="checkbox"].toggle:checked::before {
    transform: translateX(22px);
}
input[type="checkbox"].toggle:checked::after {
    display: none;
}
input[type="checkbox"].toggle:hover {
    transform: scale(1.05);
}

/* Checkbox avec label personnalise */
.checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: var(--radius);
    transition: background 0.2s ease;
}
.checkbox-wrapper:hover {
    background: var(--background);
}
.checkbox-wrapper label {
    cursor: pointer;
    font-size: 14px;
    color: var(--text);
    user-select: none;
}

/* Animation de coche */
@keyframes checkBounce {
    0% { transform: scale(0) rotate(45deg); }
    50% { transform: scale(1.2) rotate(45deg); }
    100% { transform: scale(1) rotate(45deg); }
}

/* Effets speciaux pour les actions */
.pulse-on-hover:hover {
    animation: pulse 1s infinite;
}

/* Skeleton Loading */
.skeleton {
    background: linear-gradient(90deg, var(--background) 25%, var(--border) 50%, var(--background) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: var(--radius);
}

/* Modal animations ameliorees */
.modal {
    animation: fadeInUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}
.modal-overlay {
    animation: fadeIn 0.2s ease-out;
}

/* Toast animations ameliorees */
.toast {
    animation: fadeInRight 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Hover effect pour les elements cliquables */
.clickable {
    cursor: pointer;
    transition: all 0.2s ease;
}
.clickable:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.clickable:active {
    transform: translateY(0);
}

/* Focus visible pour l'accessibilite */
*:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Transitions pour les elements de liste */
.list-item {
    transition: all 0.2s ease;
}
.list-item:hover {
    background: var(--background);
    transform: translateX(4px);
}

/* Effet de surbrillance pour les nouveaux elements */
@keyframes highlight {
    0% { background-color: var(--warning-pastel); }
    100% { background-color: transparent; }
}
.highlight-new {
    animation: highlight 2s ease-out;
}

/* Bouton flottant anime */
.fab {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(225, 29, 72, 0.4);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
.fab:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 8px 24px rgba(225, 29, 72, 0.5);
}

/* Stagger animation pour les listes */
.stagger-item {
    opacity: 0;
    animation: fadeInUp 0.4s ease-out forwards;
}
.stagger-item:nth-child(1) { animation-delay: 0.05s; }
.stagger-item:nth-child(2) { animation-delay: 0.1s; }
.stagger-item:nth-child(3) { animation-delay: 0.15s; }
.stagger-item:nth-child(4) { animation-delay: 0.2s; }
.stagger-item:nth-child(5) { animation-delay: 0.25s; }
.stagger-item:nth-child(6) { animation-delay: 0.3s; }
.stagger-item:nth-child(7) { animation-delay: 0.35s; }
.stagger-item:nth-child(8) { animation-delay: 0.4s; }
.stagger-item:nth-child(9) { animation-delay: 0.45s; }
.stagger-item:nth-child(10) { animation-delay: 0.5s; }

/* Progress bar animee */
.progress-fill {
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}
.progress-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

/* KPI Card hover ameliore */
.kpi-card {
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1),
                box-shadow 0.3s ease;
}
.kpi-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px -12px rgba(0,0,0,0.2);
}
.kpi-card:hover .kpi-icon {
    animation: bounce 0.5s ease-in-out;
}

/* Disabled state avec animation */
.btn:disabled, input:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
}

/* Loading spinner dans les boutons */
.btn-loading {
    position: relative;
    color: transparent !important;
}
.btn-loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

/* ==========================================
   STOCKAPP v5.0 - NOUVELLES FONCTIONNALITÉS
   ========================================== */

/* THEME SOMBRE */
[data-theme="dark"] {
    --primary: #F43F5E;
    --primary-light: #FDA4AF;
    --primary-dark: #E11D48;
    --primary-pastel: #4C0519;
    --secondary: #FB923C;
    --secondary-pastel: #7C2D12;
    --success: #34D399;
    --success-pastel: #064E3B;
    --warning: #FBBF24;
    --warning-pastel: #78350F;
    --danger: #F87171;
    --danger-pastel: #7F1D1D;
    --info: #60A5FA;
    --info-pastel: #1E3A8A;
    --purple: #A78BFA;
    --purple-pastel: #4C1D95;
    --teal: #2DD4BF;
    --teal-pastel: #134E4A;
    --text: #F1F5F9;
    --text-secondary: #CBD5E1;
    --muted: #64748B;
    --border: #334155;
    --background: #0F172A;
    --card: #1E293B;
}

/* Thème sombre - Éléments additionnels */
[data-theme="dark"] body { background: var(--background); color: var(--text); }
[data-theme="dark"] .app { background: var(--background); }
[data-theme="dark"] .sidebar { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .header { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .page-content { background: var(--background); }

/* Inputs et formulaires */
[data-theme="dark"] .form-input,
[data-theme="dark"] .form-select,
[data-theme="dark"] .form-textarea,
[data-theme="dark"] input[type="text"],
[data-theme="dark"] input[type="number"],
[data-theme="dark"] input[type="email"],
[data-theme="dark"] input[type="password"],
[data-theme="dark"] input[type="date"],
[data-theme="dark"] input[type="time"],
[data-theme="dark"] input[type="datetime-local"],
[data-theme="dark"] input[type="search"],
[data-theme="dark"] select,
[data-theme="dark"] textarea {
    background: var(--background) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
}
[data-theme="dark"] .form-input::placeholder,
[data-theme="dark"] input::placeholder,
[data-theme="dark"] textarea::placeholder { color: var(--muted) !important; }
[data-theme="dark"] .form-input:focus,
[data-theme="dark"] input:focus,
[data-theme="dark"] select:focus,
[data-theme="dark"] textarea:focus { border-color: var(--primary) !important; }

/* Tables */
[data-theme="dark"] table { background: var(--card); }
[data-theme="dark"] th { background: var(--background); color: var(--text); border-color: var(--border); }
[data-theme="dark"] td { background: var(--card); color: var(--text); border-color: var(--border); }
[data-theme="dark"] tr:hover td { background: var(--background); }
[data-theme="dark"] .table-container { background: var(--card); }

/* Modals */
[data-theme="dark"] .modal-content,
[data-theme="dark"] .modal-body,
[data-theme="dark"] .modal { background: var(--card); color: var(--text); }
[data-theme="dark"] .modal-header { background: var(--background); border-color: var(--border); }
[data-theme="dark"] .modal-footer { background: var(--background); border-color: var(--border); }

/* Cards et containers */
[data-theme="dark"] .card,
[data-theme="dark"] .stat-card,
[data-theme="dark"] .kpi-card,
[data-theme="dark"] .dashboard-card { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .card-header { background: var(--background); border-color: var(--border); }

/* Tabs */
[data-theme="dark"] .tabs { background: var(--background); border-color: var(--border); }
[data-theme="dark"] .tab { color: var(--text-secondary); }
[data-theme="dark"] .tab:hover { color: var(--text); background: var(--card); }
[data-theme="dark"] .tab.active { color: var(--primary); background: var(--card); }

/* Dropdowns */
[data-theme="dark"] .dropdown-menu,
[data-theme="dark"] .notif-dropdown { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .dropdown-item:hover { background: var(--background); }

/* Badges et tags */
[data-theme="dark"] .badge { background: var(--background); color: var(--text); }

/* Boutons */
[data-theme="dark"] .btn-ghost { color: var(--text-secondary); }
[data-theme="dark"] .btn-ghost:hover { background: var(--background); color: var(--text); }
[data-theme="dark"] .btn-outline { border-color: var(--border); color: var(--text); }
[data-theme="dark"] .btn-outline:hover { background: var(--background); }

/* Signature pad - garder le fond blanc pour la signature */
[data-theme="dark"] .signature-canvas-wrapper { background: white; }
[data-theme="dark"] .signature-canvas { background: white; }

/* Scrollbar */
[data-theme="dark"] ::-webkit-scrollbar { width: 8px; height: 8px; }
[data-theme="dark"] ::-webkit-scrollbar-track { background: var(--background); }
[data-theme="dark"] ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
[data-theme="dark"] ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

/* Autres éléments */
[data-theme="dark"] .empty-state { color: var(--muted); }
[data-theme="dark"] .divider { background: var(--border); }
[data-theme="dark"] hr { border-color: var(--border); }
[data-theme="dark"] .tooltip { background: var(--card); color: var(--text); }
[data-theme="dark"] .popover { background: var(--card); border-color: var(--border); }
[data-theme="dark"] code { background: var(--background); color: var(--primary); }
[data-theme="dark"] pre { background: var(--background); }
[data-theme="dark"] .search-input { background: var(--background); color: var(--text); border-color: var(--border); }
[data-theme="dark"] .filter-group { background: var(--card); }
[data-theme="dark"] .list-item { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .list-item:hover { background: var(--background); }
[data-theme="dark"] .timeline-item { background: var(--card); }
[data-theme="dark"] .calendar-day { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .calendar-day:hover { background: var(--background); }
[data-theme="dark"] .calendar-day.today { background: var(--primary-pastel); }
[data-theme="dark"] .event-item { background: var(--background); }
[data-theme="dark"] .checkbox-wrapper { background: var(--card); }
[data-theme="dark"] .radio-wrapper { background: var(--card); }
[data-theme="dark"] .switch-wrapper { background: var(--card); }
[data-theme="dark"] .file-upload-zone { background: var(--background); border-color: var(--border); }
[data-theme="dark"] .breadcrumb { color: var(--muted); }
[data-theme="dark"] .breadcrumb a { color: var(--text-secondary); }
[data-theme="dark"] .progress-bar { background: var(--background); }
[data-theme="dark"] .avatar { background: var(--primary-pastel); color: var(--primary); }
[data-theme="dark"] .user-menu { background: var(--card); }
[data-theme="dark"] .nav-item { color: var(--text-secondary); }
[data-theme="dark"] .nav-item:hover { background: var(--background); color: var(--text); }
[data-theme="dark"] .nav-item.active { background: var(--primary-pastel); color: var(--primary); }

/* Thème sombre - Éléments supplémentaires */
[data-theme="dark"] .page-title,
[data-theme="dark"] .page-subtitle,
[data-theme="dark"] .card-title,
[data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3, 
[data-theme="dark"] h4, [data-theme="dark"] h5, [data-theme="dark"] h6 { color: var(--text); }

[data-theme="dark"] .kpi-card { background: var(--card); }
[data-theme="dark"] .kpi-value { color: var(--text); }
[data-theme="dark"] .kpi-label { color: var(--muted); }

[data-theme="dark"] .stats-card { background: var(--card); border: 1px solid var(--border); }
[data-theme="dark"] .stats-card-value { color: var(--text); }
[data-theme="dark"] .stats-card-label { color: var(--muted); }

[data-theme="dark"] .form-group label { color: var(--text); }
[data-theme="dark"] .form-label { color: var(--text); }
[data-theme="dark"] .form-hint { color: var(--muted); }
[data-theme="dark"] .form-error { color: var(--danger); }

[data-theme="dark"] .btn { color: var(--text); }
[data-theme="dark"] .btn-secondary { background: var(--card); border-color: var(--border); color: var(--text); }
[data-theme="dark"] .btn-secondary:hover { background: var(--background); }

[data-theme="dark"] .pagination { background: var(--card); }
[data-theme="dark"] .pagination-btn { background: var(--background); color: var(--text); border-color: var(--border); }
[data-theme="dark"] .pagination-btn:hover { background: var(--card); }
[data-theme="dark"] .pagination-info { color: var(--muted); }

[data-theme="dark"] .filter-bar { background: var(--card); }
[data-theme="dark"] .filter-btn { background: var(--background); color: var(--text); border-color: var(--border); }
[data-theme="dark"] .filter-btn:hover,
[data-theme="dark"] .filter-btn.active { background: var(--primary-pastel); color: var(--primary); }

[data-theme="dark"] .search-container input { background: var(--background); color: var(--text); border-color: var(--border); }
[data-theme="dark"] .search-container input::placeholder { color: var(--muted); }

[data-theme="dark"] .detail-row { border-color: var(--border); }
[data-theme="dark"] .detail-label { color: var(--muted); }
[data-theme="dark"] .detail-value { color: var(--text); }

[data-theme="dark"] .timeline { border-color: var(--border); }
[data-theme="dark"] .timeline-item { background: var(--card); }
[data-theme="dark"] .timeline-content { color: var(--text); }
[data-theme="dark"] .timeline-date { color: var(--muted); }

[data-theme="dark"] .chip { background: var(--background); color: var(--text); border-color: var(--border); }
[data-theme="dark"] .chip:hover { background: var(--card); }

[data-theme="dark"] .accordion { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .accordion-header { background: var(--background); color: var(--text); }
[data-theme="dark"] .accordion-content { background: var(--card); color: var(--text); }

[data-theme="dark"] .alert { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .alert-title { color: var(--text); }
[data-theme="dark"] .alert-message { color: var(--text-secondary); }

[data-theme="dark"] .stepper { background: var(--card); }
[data-theme="dark"] .step { color: var(--muted); }
[data-theme="dark"] .step.active { color: var(--primary); }
[data-theme="dark"] .step.completed { color: var(--success); }

[data-theme="dark"] .tooltip { background: var(--card); color: var(--text); border-color: var(--border); }
[data-theme="dark"] .popover-content { background: var(--card); color: var(--text); }

[data-theme="dark"] .menu { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .menu-item { color: var(--text); }
[data-theme="dark"] .menu-item:hover { background: var(--background); }

[data-theme="dark"] .sidebar-section { border-color: var(--border); }
[data-theme="dark"] .sidebar-title { color: var(--text); }

[data-theme="dark"] .header-actions .header-btn { background: var(--background); color: var(--text); }
[data-theme="dark"] .header-actions .header-btn:hover { background: var(--card); }

[data-theme="dark"] .user-dropdown { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .user-dropdown-item { color: var(--text); }
[data-theme="dark"] .user-dropdown-item:hover { background: var(--background); }

[data-theme="dark"] .notif-dropdown { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .notif-item { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .notif-item:hover { background: var(--background); }
[data-theme="dark"] .notif-title { color: var(--text); }
[data-theme="dark"] .notif-message { color: var(--text-secondary); }
[data-theme="dark"] .notif-time { color: var(--muted); }

[data-theme="dark"] .command-palette-overlay { background: rgba(0, 0, 0, 0.7); }
[data-theme="dark"] .command-palette { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .command-palette-input { background: var(--background); color: var(--text); border-color: var(--border); }
[data-theme="dark"] .command-palette-item { color: var(--text); }
[data-theme="dark"] .command-palette-item:hover,
[data-theme="dark"] .command-palette-item.selected { background: var(--background); }

[data-theme="dark"] .presentation-mode { background: var(--background); }
[data-theme="dark"] .presentation-header { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .presentation-kpi { background: var(--card); }
[data-theme="dark"] .presentation-tasks { background: var(--card); }
[data-theme="dark"] .presentation-task-item { background: var(--background); border-color: var(--border); }
[data-theme="dark"] .presentation-sidebar { background: var(--card); }
[data-theme="dark"] .presentation-alerts { background: var(--card); }
[data-theme="dark"] .presentation-alert-item { background: var(--background); }

[data-theme="dark"] .shortcuts-modal { background: var(--card); }
[data-theme="dark"] .shortcuts-section { border-color: var(--border); }
[data-theme="dark"] .shortcut-item { color: var(--text); }
[data-theme="dark"] .shortcut-key { background: var(--background); border-color: var(--border); color: var(--text); }

[data-theme="dark"] .offline-banner { background: var(--warning-pastel); color: var(--warning); }

[data-theme="dark"] select option { background: var(--card); color: var(--text); }
[data-theme="dark"] datalist { background: var(--card); }

[data-theme="dark"] .task-work-item { background: var(--background); border-color: var(--border); }
[data-theme="dark"] .work-item-text { color: var(--text); }

[data-theme="dark"] .timesheet-day { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .timesheet-header { background: var(--background); }
[data-theme="dark"] .timesheet-cell { border-color: var(--border); }
[data-theme="dark"] .timesheet-input { background: var(--background); color: var(--text); }

[data-theme="dark"] .calendar { background: var(--card); }
[data-theme="dark"] .calendar-header { background: var(--background); }
[data-theme="dark"] .calendar-day { background: var(--card); color: var(--text); }
[data-theme="dark"] .calendar-day:hover { background: var(--background); }
[data-theme="dark"] .calendar-day.other-month { color: var(--muted); }
[data-theme="dark"] .calendar-event { background: var(--primary-pastel); color: var(--primary); }

[data-theme="dark"] .request-card { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .request-header { color: var(--text); }
[data-theme="dark"] .request-body { color: var(--text-secondary); }

[data-theme="dark"] .order-card { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .order-header { color: var(--text); }
[data-theme="dark"] .order-total { color: var(--text); }

[data-theme="dark"] .part-card { background: var(--card); border-color: var(--border); }
[data-theme="dark"] .part-name { color: var(--text); }
[data-theme="dark"] .part-ref { color: var(--muted); }

[data-theme="dark"] .stock-badge { background: var(--background); }
[data-theme="dark"] .location-badge { background: var(--background); color: var(--text); }

[data-theme="dark"] .qr-container { background: var(--card); }
[data-theme="dark"] .barcode-container { background: white; }

[data-theme="dark"] .export-btn { background: var(--card); color: var(--text); border-color: var(--border); }
[data-theme="dark"] .export-btn:hover { background: var(--background); }

[data-theme="dark"] .print-preview { background: white; color: black; }

[data-theme="dark"] strong { color: var(--text); }
[data-theme="dark"] b { color: var(--text); }
[data-theme="dark"] p { color: var(--text-secondary); }
[data-theme="dark"] span { color: inherit; }
[data-theme="dark"] label { color: var(--text); }
[data-theme="dark"] legend { color: var(--text); }

[data-theme="dark"] ::selection { background: var(--primary); color: white; }

/* ============================================================================
   v5.1 - DARK MODE POUR NOUVELLES PAGES
   ============================================================================ */

/* Scanner Page */
[data-theme="dark"] .scanner-page { background: var(--background); }
[data-theme="dark"] .scanner-layout { background: var(--background); }
[data-theme="dark"] .scanner-main { background: var(--background); }
[data-theme="dark"] .scanner-mode-btn { 
    background: var(--card); 
    border-color: var(--border); 
    color: var(--text); 
}
[data-theme="dark"] .scanner-mode-btn:hover { 
    background: var(--background); 
    border-color: var(--primary); 
}
[data-theme="dark"] .scanner-mode-btn.active { 
    background: var(--primary-pastel); 
    border-color: var(--primary); 
    color: var(--primary); 
}
[data-theme="dark"] .scanner-container-wrapper { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .scanner-viewport { background: #000; }
[data-theme="dark"] .scanner-placeholder { color: var(--muted); }
[data-theme="dark"] .manual-input-section { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .manual-input-section label { color: var(--text); }
[data-theme="dark"] .last-scanned { 
    background: var(--info-pastel); 
    color: var(--info); 
}
[data-theme="dark"] .scanner-results { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .results-header { 
    background: var(--card); 
    border-color: var(--border); 
}
[data-theme="dark"] .results-header h3 { color: var(--text); }
[data-theme="dark"] .results-list { background: var(--card); }
[data-theme="dark"] .empty-results { color: var(--muted); }
[data-theme="dark"] .result-item { 
    background: var(--card); 
    border-color: var(--border); 
}
[data-theme="dark"] .result-item:hover { background: var(--background); }
[data-theme="dark"] .result-code { color: var(--text); }
[data-theme="dark"] .result-name { color: var(--text-secondary); }
[data-theme="dark"] .result-time { color: var(--muted); }

/* Audit Page */
[data-theme="dark"] .audit-page { background: var(--background); }
[data-theme="dark"] .audit-filters { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .audit-stats { background: var(--background); }
[data-theme="dark"] .audit-stat { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .audit-stat-value { color: var(--primary); }
[data-theme="dark"] .audit-stat-label { color: var(--muted); }
[data-theme="dark"] .audit-timeline { background: var(--background); }
[data-theme="dark"] .timeline-item { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .timeline-marker { 
    background: var(--card); 
    border-color: var(--border); 
}
[data-theme="dark"] .timeline-entity { color: var(--text); }
[data-theme="dark"] .timeline-meta { color: var(--muted); }
[data-theme="dark"] .detail-tag { 
    background: var(--background); 
    color: var(--text-secondary); 
}
[data-theme="dark"] .loading-state { color: var(--muted); }
[data-theme="dark"] .empty-state { color: var(--muted); }

/* Import Page */
[data-theme="dark"] .import-page { background: var(--background); }
[data-theme="dark"] .import-type-selector label { color: var(--text); }
[data-theme="dark"] .import-type-btn { 
    background: var(--card); 
    border-color: var(--border); 
    color: var(--text); 
}
[data-theme="dark"] .import-type-btn:hover { 
    background: var(--background); 
    border-color: var(--primary); 
}
[data-theme="dark"] .import-type-btn.active { 
    background: var(--primary); 
    color: white; 
    border-color: var(--primary); 
}
[data-theme="dark"] .import-dropzone { 
    background: var(--card); 
    border-color: var(--border); 
}
[data-theme="dark"] .import-dropzone:hover,
[data-theme="dark"] .import-dropzone.drag-over { 
    background: var(--background); 
    border-color: var(--primary); 
}
[data-theme="dark"] .dropzone-text { color: var(--text); }
[data-theme="dark"] .dropzone-subtext { color: var(--muted); }
[data-theme="dark"] .dropzone-formats { color: var(--muted); }
[data-theme="dark"] .import-preview { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .preview-header { 
    background: var(--background); 
    border-color: var(--border); 
}
[data-theme="dark"] .preview-header h3 { color: var(--text); }
[data-theme="dark"] .preview-count { color: var(--muted); }
[data-theme="dark"] .mapping-section { 
    background: var(--card); 
    border-color: var(--border); 
}
[data-theme="dark"] .mapping-section h4 { color: var(--text); }
[data-theme="dark"] .mapping-source { 
    background: var(--background); 
    color: var(--text); 
}
[data-theme="dark"] .mapping-arrow { color: var(--muted); }
[data-theme="dark"] .preview-table-wrapper { background: var(--card); }
[data-theme="dark"] .preview-table { background: var(--card); }
[data-theme="dark"] .preview-table th { 
    background: var(--background); 
    color: var(--text); 
    border-color: var(--border); 
}
[data-theme="dark"] .preview-table td { 
    background: var(--card); 
    color: var(--text); 
    border-color: var(--border); 
}
[data-theme="dark"] .import-actions { 
    background: var(--card); 
    border-color: var(--border); 
}
[data-theme="dark"] .import-results { 
    background: var(--background); 
    border-color: var(--border); 
}
[data-theme="dark"] .result-stat.success { 
    background: var(--success-pastel); 
    color: var(--success); 
}
[data-theme="dark"] .result-stat.error { 
    background: var(--danger-pastel); 
    color: var(--danger); 
}
[data-theme="dark"] .result-stat.total { 
    background: var(--info-pastel); 
    color: var(--info); 
}

/* Alerts Page */
[data-theme="dark"] .alerts-page { background: var(--background); }
[data-theme="dark"] .active-alerts { 
    background: var(--warning-pastel); 
    border-color: var(--warning); 
}
[data-theme="dark"] .active-alerts-header h3 { color: var(--warning); }
[data-theme="dark"] .active-alert-item { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .alert-count { color: var(--warning); }
[data-theme="dark"] .alerts-list { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .alerts-list-header { 
    background: var(--card); 
    border-color: var(--border); 
    color: var(--text); 
}
[data-theme="dark"] .alerts-list-header h3 { color: var(--text); }
[data-theme="dark"] .alert-rule-card { 
    background: var(--card); 
    border-color: var(--border); 
}
[data-theme="dark"] .alert-rule-card:hover { background: var(--background); }
[data-theme="dark"] .alert-rule-name { color: var(--text); }
[data-theme="dark"] .alert-rule-condition { color: var(--muted); }
[data-theme="dark"] .channels-label { color: var(--muted); }
[data-theme="dark"] .channel-badge { 
    background: var(--background); 
    color: var(--text-secondary); 
}
[data-theme="dark"] .toggle-slider { background: var(--border); }
[data-theme="dark"] .toggle-slider::before { background: var(--card); }
[data-theme="dark"] .alert-modal { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .alert-form { background: var(--card); }
[data-theme="dark"] .alert-form .form-group label { color: var(--text); }
[data-theme="dark"] .checkbox-group { background: var(--card); }
[data-theme="dark"] .checkbox-label { 
    background: var(--background); 
    color: var(--text); 
}

/* API Docs Page */
[data-theme="dark"] .api-docs-page { background: var(--background); }
[data-theme="dark"] .api-key-section { 
    background: var(--card); 
    border-color: var(--border); 
}
[data-theme="dark"] .api-key-header h3 { color: var(--text); }
[data-theme="dark"] .api-key-header p { color: var(--muted); }
[data-theme="dark"] .api-key-display { 
    background: var(--background); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .api-key-value { color: var(--text); }
[data-theme="dark"] .api-key-warning { 
    background: var(--warning-pastel); 
    color: var(--warning); 
}
[data-theme="dark"] .api-layout { background: var(--background); }
[data-theme="dark"] .api-sidebar { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .api-sidebar h4 { color: var(--muted); }
[data-theme="dark"] .api-nav-item { color: var(--text-secondary); }
[data-theme="dark"] .api-nav-item:hover { 
    background: var(--background); 
    color: var(--text); 
}
[data-theme="dark"] .api-nav-item.active { 
    background: var(--primary-pastel); 
    color: var(--primary); 
}
[data-theme="dark"] .api-content { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .endpoint-detail { background: var(--card); }
[data-theme="dark"] .endpoint-header h2 { color: var(--text); }
[data-theme="dark"] .endpoint-header p { color: var(--muted); }
[data-theme="dark"] .endpoint-methods { background: var(--card); }
[data-theme="dark"] .method-item { 
    background: var(--background); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .method-path { color: var(--text); }
[data-theme="dark"] .method-desc { color: var(--muted); }
[data-theme="dark"] .code-example { background: var(--card); }
[data-theme="dark"] .code-header { background: #1E293B; }
[data-theme="dark"] .code-block { background: #0F172A; color: #E2E8F0; }
[data-theme="dark"] .api-footer { background: var(--background); }
[data-theme="dark"] .rate-limits,
[data-theme="dark"] .api-support { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .rate-limits h4,
[data-theme="dark"] .api-support h4 { color: var(--text); }
[data-theme="dark"] .rate-limits p,
[data-theme="dark"] .api-support p { color: var(--text-secondary); }

/* Stats Page */
[data-theme="dark"] .stats-page { background: var(--background); }
[data-theme="dark"] .stats-header { color: var(--text); }
[data-theme="dark"] .stats-header h2 { color: var(--text); }
[data-theme="dark"] .stats-period-selector { background: var(--card); }
[data-theme="dark"] .stats-period-btn { 
    background: var(--card); 
    color: var(--text-secondary); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .stats-period-btn:hover { 
    background: var(--background); 
    color: var(--text); 
}
[data-theme="dark"] .stats-period-btn.active { 
    background: var(--primary); 
    color: white; 
    border-color: var(--primary); 
}
[data-theme="dark"] .stats-grid { background: var(--background); }
[data-theme="dark"] .stats-card { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .stats-card-value { color: var(--text); }
[data-theme="dark"] .stats-card-label { color: var(--muted); }
[data-theme="dark"] .stats-charts { background: var(--background); }
[data-theme="dark"] .chart-container { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .chart-header { background: var(--card); }
[data-theme="dark"] .chart-title { color: var(--text); }
[data-theme="dark"] .chart-legend-item { color: var(--text-secondary); }
[data-theme="dark"] .bar-chart { background: var(--card); }
[data-theme="dark"] .bar-label { color: var(--muted); }
[data-theme="dark"] .donut-chart { background: var(--card); }
[data-theme="dark"] .donut-center-value { color: var(--text); }
[data-theme="dark"] .donut-center-label { color: var(--muted); }
[data-theme="dark"] .donut-legend-label { color: var(--text-secondary); }
[data-theme="dark"] .donut-legend-value { color: var(--text); }

/* Kanban Board */
[data-theme="dark"] .kanban-board { background: var(--background); }
[data-theme="dark"] .kanban-column { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .kanban-column-header { 
    background: var(--background); 
    border-color: var(--border); 
    color: var(--text); 
}
[data-theme="dark"] .kanban-column-header h3 { color: var(--text); }
[data-theme="dark"] .kanban-cards { background: var(--card); }
[data-theme="dark"] .kanban-card { 
    background: var(--background); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .kanban-card:hover { 
    background: var(--card); 
    border-color: var(--primary); 
}
[data-theme="dark"] .kanban-card-title { color: var(--text); }
[data-theme="dark"] .kanban-card-meta { color: var(--muted); }
[data-theme="dark"] .kanban-empty { color: var(--muted); }

/* Command Palette améliorée */
[data-theme="dark"] .command-palette { 
    background: var(--card); 
    border: 1px solid var(--border); 
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
}
[data-theme="dark"] .command-palette-header { 
    background: var(--card); 
    border-color: var(--border); 
}
[data-theme="dark"] .command-palette-input { 
    background: var(--background); 
    color: var(--text); 
    border-color: var(--border); 
}
[data-theme="dark"] .command-palette-input::placeholder { color: var(--muted); }
[data-theme="dark"] .command-palette-results { background: var(--card); }
[data-theme="dark"] .command-palette-section { background: var(--card); }
[data-theme="dark"] .command-palette-section-title { color: var(--muted); }
[data-theme="dark"] .command-palette-item { 
    background: var(--card); 
    color: var(--text); 
}
[data-theme="dark"] .command-palette-item:hover,
[data-theme="dark"] .command-palette-item.selected { 
    background: var(--background); 
}
[data-theme="dark"] .command-palette-item-icon { color: var(--muted); }
[data-theme="dark"] .command-palette-item-name { color: var(--text); }
[data-theme="dark"] .command-palette-item-hint { color: var(--muted); }
[data-theme="dark"] .command-palette-footer { 
    background: var(--background); 
    border-color: var(--border); 
    color: var(--muted); 
}
[data-theme="dark"] .command-palette-kbd { 
    background: var(--card); 
    border-color: var(--border); 
    color: var(--text-secondary); 
}

/* Shortcuts Modal */
[data-theme="dark"] .shortcuts-modal { 
    background: rgba(0, 0, 0, 0.7); 
}
[data-theme="dark"] .shortcuts-content { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .shortcuts-header { 
    background: var(--background); 
    border-color: var(--border); 
}
[data-theme="dark"] .shortcuts-title { color: var(--text); }
[data-theme="dark"] .shortcuts-body { background: var(--card); }
[data-theme="dark"] .shortcuts-section { border-color: var(--border); }
[data-theme="dark"] .shortcuts-section-title { color: var(--muted); }
[data-theme="dark"] .shortcut-item { color: var(--text); }
[data-theme="dark"] .shortcut-label { color: var(--text); }
[data-theme="dark"] .shortcut-keys kbd { 
    background: var(--background); 
    border: 1px solid var(--border); 
    color: var(--text); 
}

/* Presentation Mode */
[data-theme="dark"] .presentation-overlay { background: var(--background); }
[data-theme="dark"] .presentation-content { background: var(--background); }
[data-theme="dark"] .presentation-card { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .presentation-card-header { 
    background: var(--background); 
    border-color: var(--border); 
}
[data-theme="dark"] .presentation-card-title { color: var(--text); }
[data-theme="dark"] .presentation-card-body { background: var(--card); }

/* Signature Pad - garder fond blanc pour signature visible */
[data-theme="dark"] .signature-pad { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .signature-header { 
    background: var(--background); 
    border-color: var(--border); 
}
[data-theme="dark"] .signature-title { color: var(--text); }

/* Export Button & Dropdown */
[data-theme="dark"] .export-dropdown { background: var(--background); }
[data-theme="dark"] .export-menu { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .export-menu-item { 
    color: var(--text); 
    background: var(--card); 
}
[data-theme="dark"] .export-menu-item:hover { background: var(--background); }

/* Éléments globaux supplémentaires */
[data-theme="dark"] .page-header { background: var(--background); }
[data-theme="dark"] .page-header h1,
[data-theme="dark"] .page-title { color: var(--text); }
[data-theme="dark"] .page-subtitle { color: var(--muted); }
[data-theme="dark"] .section-title { color: var(--text); }
[data-theme="dark"] .section-subtitle { color: var(--muted); }
[data-theme="dark"] .list-container { background: var(--card); }
[data-theme="dark"] .list-header { 
    background: var(--background); 
    border-color: var(--border); 
}
[data-theme="dark"] .list-body { background: var(--card); }
[data-theme="dark"] .list-footer { 
    background: var(--background); 
    border-color: var(--border); 
}
[data-theme="dark"] .grid-container { background: var(--background); }
[data-theme="dark"] .flex-container { background: var(--background); }
[data-theme="dark"] .content-wrapper { background: var(--background); }
[data-theme="dark"] .inner-content { background: var(--card); }
[data-theme="dark"] .section-content { background: var(--card); }
[data-theme="dark"] .panel { 
    background: var(--card); 
    border: 1px solid var(--border); 
}
[data-theme="dark"] .panel-header { 
    background: var(--background); 
    border-color: var(--border); 
}
[data-theme="dark"] .panel-body { background: var(--card); }
[data-theme="dark"] .panel-footer { 
    background: var(--background); 
    border-color: var(--border); 
}

/* Tous les conteneurs génériques */
[data-theme="dark"] div[class*="-container"],
[data-theme="dark"] div[class*="-wrapper"],
[data-theme="dark"] div[class*="-section"],
[data-theme="dark"] div[class*="-content"] {
    background-color: inherit;
}

/* Reset complet pour éviter les blancs */
[data-theme="dark"] * {
    border-color: var(--border);
}

/* ============================================================================
   DARK MODE - FORCE OVERRIDE POUR INLINE STYLES
   ============================================================================ */

/* Forcer les cards et containers */
[data-theme="dark"] .card,
[data-theme="dark"] .card-body,
[data-theme="dark"] .card-header,
[data-theme="dark"] .card-footer,
[data-theme="dark"] [class*="card"] {
    background: var(--card) !important;
    color: var(--text) !important;
}

/* Forcer les modals */
[data-theme="dark"] .modal,
[data-theme="dark"] .modal-content,
[data-theme="dark"] .modal-body,
[data-theme="dark"] .modal-header,
[data-theme="dark"] .modal-footer,
[data-theme="dark"] [class*="modal"] {
    background: var(--card) !important;
    color: var(--text) !important;
}

/* Forcer les dropdowns et menus */
[data-theme="dark"] .dropdown,
[data-theme="dark"] .dropdown-menu,
[data-theme="dark"] .notif-dropdown,
[data-theme="dark"] [class*="dropdown"] {
    background: var(--card) !important;
    color: var(--text) !important;
}

/* Forcer les tabs et filtres */
[data-theme="dark"] .tab,
[data-theme="dark"] .tab.active,
[data-theme="dark"] .filter-chip,
[data-theme="dark"] .filter-btn {
    background: var(--card) !important;
    color: var(--text) !important;
}
[data-theme="dark"] .filter-chip.active,
[data-theme="dark"] .filter-btn.active {
    background: var(--primary) !important;
    color: white !important;
}

/* Forcer les backgrounds des éléments avec style inline */
[data-theme="dark"] div[style*="background: white"],
[data-theme="dark"] div[style*="background:'white"],
[data-theme="dark"] div[style*="background: 'white"],
[data-theme="dark"] div[style*="background:#fff"],
[data-theme="dark"] div[style*="background: #fff"],
[data-theme="dark"] div[style*="background: #FFF"],
[data-theme="dark"] div[style*="background:#FFF"] {
    background: var(--card) !important;
}

/* Override couleurs pastels claires en inline */
[data-theme="dark"] div[style*="background: #FEF"],
[data-theme="dark"] div[style*="background:#FEF"],
[data-theme="dark"] div[style*="background: #FFF"],
[data-theme="dark"] div[style*="background:#FFF"],
[data-theme="dark"] div[style*="background: #EFF"],
[data-theme="dark"] div[style*="background:#EFF"],
[data-theme="dark"] div[style*="background: #E0E"],
[data-theme="dark"] div[style*="background:#E0E"],
[data-theme="dark"] div[style*="background: #DBE"],
[data-theme="dark"] div[style*="background:#DBE"],
[data-theme="dark"] div[style*="background: #DCF"],
[data-theme="dark"] div[style*="background:#DCF"],
[data-theme="dark"] div[style*="background: #D1F"],
[data-theme="dark"] div[style*="background:#D1F"],
[data-theme="dark"] span[style*="background: #FEF"],
[data-theme="dark"] span[style*="background:#FEF"],
[data-theme="dark"] span[style*="background: #DCF"],
[data-theme="dark"] span[style*="background:#DCF"],
[data-theme="dark"] span[style*="background: #E0E"],
[data-theme="dark"] span[style*="background:#E0E"] {
    background: var(--background) !important;
    border-color: var(--border) !important;
}

/* Forcer les labels et spans avec inline */
[data-theme="dark"] label[style*="background"],
[data-theme="dark"] span[style*="background: white"],
[data-theme="dark"] span[style*="background:'white"],
[data-theme="dark"] span[style*="background:#fff"],
[data-theme="dark"] span[style*="background: #fff"] {
    background: var(--card) !important;
}

/* Forcer tous les inputs, selects, textareas */
[data-theme="dark"] input,
[data-theme="dark"] select,
[data-theme="dark"] textarea {
    background: var(--background) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
}

/* Forcer les formulaires et leurs éléments */
[data-theme="dark"] .form-group,
[data-theme="dark"] .form-row,
[data-theme="dark"] .form-section {
    background: transparent !important;
}

/* Page login - forcer le fond du formulaire */
[data-theme="dark"] .login-form {
    background: var(--card) !important;
}
[data-theme="dark"] .login-form .form-input {
    background: var(--background) !important;
    color: var(--text) !important;
}
[data-theme="dark"] .login-form .form-input:focus {
    background: var(--background) !important;
}

/* Forcer les zones de texte et contenus */
[data-theme="dark"] .text-content,
[data-theme="dark"] .content-area,
[data-theme="dark"] .detail-section,
[data-theme="dark"] .info-box {
    background: var(--card) !important;
    color: var(--text) !important;
}

/* Forcer les éléments de liste */
[data-theme="dark"] .list-item,
[data-theme="dark"] .item-row,
[data-theme="dark"] .data-row,
[data-theme="dark"] li {
    background: transparent !important;
    color: var(--text) !important;
}
[data-theme="dark"] .list-item:hover,
[data-theme="dark"] .item-row:hover {
    background: var(--background) !important;
}

/* Forcer les éléments avec COLORS.background inline */
[data-theme="dark"] div[style*="rgb(248"],
[data-theme="dark"] div[style*="rgb(249"],
[data-theme="dark"] div[style*="rgb(250"],
[data-theme="dark"] div[style*="rgb(251"],
[data-theme="dark"] div[style*="rgb(252"],
[data-theme="dark"] div[style*="rgb(253"],
[data-theme="dark"] div[style*="rgb(254"],
[data-theme="dark"] div[style*="rgb(255"] {
    background: var(--card) !important;
}

/* Boutons view mode */
[data-theme="dark"] button[style*="background: white"],
[data-theme="dark"] button[style*="background:'white"] {
    background: var(--card) !important;
    color: var(--text) !important;
}

/* Alertes et notifications pastels */
[data-theme="dark"] .alert-info,
[data-theme="dark"] .alert-warning,
[data-theme="dark"] .alert-success,
[data-theme="dark"] .alert-danger,
[data-theme="dark"] div[style*="#FEF3C7"],
[data-theme="dark"] div[style*="#FEE2E2"],
[data-theme="dark"] div[style*="#DBEAFE"],
[data-theme="dark"] div[style*="#D1FAE5"],
[data-theme="dark"] div[style*="#FEF2F2"],
[data-theme="dark"] div[style*="#FFF7ED"],
[data-theme="dark"] div[style*="#DCFCE7"] {
    background: var(--background) !important;
    border-color: var(--border) !important;
}

/* Images et photos - garder fond si besoin */
[data-theme="dark"] .photo-container,
[data-theme="dark"] .image-wrapper {
    background: var(--background) !important;
}

/* QR Codes et Barcodes - garder fond blanc pour lisibilité */
[data-theme="dark"] .qr-container,
[data-theme="dark"] .barcode-container,
[data-theme="dark"] .signature-canvas-wrapper,
[data-theme="dark"] .signature-canvas,
[data-theme="dark"] .print-preview {
    background: white !important;
}

/* Planning et calendrier */
[data-theme="dark"] .planning-cell,
[data-theme="dark"] .calendar-cell,
[data-theme="dark"] .day-cell {
    background: var(--card) !important;
    border-color: var(--border) !important;
}

/* Table cells */
[data-theme="dark"] th,
[data-theme="dark"] td {
    background: var(--card) !important;
    color: var(--text) !important;
    border-color: var(--border) !important;
}
[data-theme="dark"] thead th {
    background: var(--background) !important;
}
[data-theme="dark"] tr:hover td {
    background: var(--background) !important;
}

/* Override labels de toggle view */
[data-theme="dark"] button[style*="boxShadow"] {
    background: var(--card) !important;
    color: var(--text) !important;
}

/* Notifications items */
[data-theme="dark"] .notif-item,
[data-theme="dark"] .notification-item {
    background: var(--card) !important;
    border-color: var(--border) !important;
}
[data-theme="dark"] .notif-item:hover,
[data-theme="dark"] .notification-item:hover {
    background: var(--background) !important;
}

/* Override tous les éléments div qui ont un background inline clair */
[data-theme="dark"] div[style*="248, 250, 252"],
[data-theme="dark"] div[style*="background: rgb(248"],
[data-theme="dark"] div[style*="background: rgb(249"],
[data-theme="dark"] div[style*="background: rgb(250"],
[data-theme="dark"] div[style*="background: rgb(251"],
[data-theme="dark"] div[style*="background: rgb(252"],
[data-theme="dark"] div[style*="background: rgb(253"],
[data-theme="dark"] div[style*="background: rgb(254"],
[data-theme="dark"] div[style*="background: rgb(255"] {
    background: var(--card) !important;
}

/* Force le texte sombre en texte clair */
[data-theme="dark"] [style*="color: #1"],
[data-theme="dark"] [style*="color: #2"],
[data-theme="dark"] [style*="color: #3"],
[data-theme="dark"] [style*="color: #4"],
[data-theme="dark"] [style*="color:#1"],
[data-theme="dark"] [style*="color:#2"],
[data-theme="dark"] [style*="color:#3"],
[data-theme="dark"] [style*="color:#4"],
[data-theme="dark"] [style*="color: rgb(0"],
[data-theme="dark"] [style*="color: rgb(1"],
[data-theme="dark"] [style*="color: rgb(2"],
[data-theme="dark"] [style*="color: rgb(3"],
[data-theme="dark"] [style*="color: rgb(4"],
[data-theme="dark"] [style*="color: rgb(5"],
[data-theme="dark"] [style*="color: rgb(6"],
[data-theme="dark"] [style*="color: rgb(7"],
[data-theme="dark"] [style*="color: rgb(8"],
[data-theme="dark"] [style*="color: rgb(9"] {
    color: var(--text) !important;
}

/* Cas particulier: couleurs warnings/infos qui doivent garder leur couleur de texte */
[data-theme="dark"] [style*="color: #92400E"],
[data-theme="dark"] [style*="color:#92400E"],
[data-theme="dark"] [style*="color: #DC2626"],
[data-theme="dark"] [style*="color:#DC2626"],
[data-theme="dark"] [style*="color: #16A34A"],
[data-theme="dark"] [style*="color:#16A34A"],
[data-theme="dark"] [style*="color: #1D4ED8"],
[data-theme="dark"] [style*="color:#1D4ED8"] {
    color: inherit !important;
}

/* Pastilles et badges colorés - adapter au dark */
[data-theme="dark"] span[style*="background: #FEF3C7"] { background: var(--warning-pastel) !important; color: var(--warning) !important; }
[data-theme="dark"] span[style*="background:#FEF3C7"] { background: var(--warning-pastel) !important; color: var(--warning) !important; }
[data-theme="dark"] span[style*="background: #FEE2E2"] { background: var(--danger-pastel) !important; color: var(--danger) !important; }
[data-theme="dark"] span[style*="background:#FEE2E2"] { background: var(--danger-pastel) !important; color: var(--danger) !important; }
[data-theme="dark"] span[style*="background: #DCFCE7"] { background: var(--success-pastel) !important; color: var(--success) !important; }
[data-theme="dark"] span[style*="background:#DCFCE7"] { background: var(--success-pastel) !important; color: var(--success) !important; }
[data-theme="dark"] span[style*="background: #DBEAFE"] { background: var(--info-pastel) !important; color: var(--info) !important; }
[data-theme="dark"] span[style*="background:#DBEAFE"] { background: var(--info-pastel) !important; color: var(--info) !important; }
[data-theme="dark"] span[style*="background: #E0E7FF"] { background: var(--purple-pastel) !important; color: var(--purple) !important; }
[data-theme="dark"] span[style*="background:#E0E7FF"] { background: var(--purple-pastel) !important; color: var(--purple) !important; }

/* Div avec backgrounds pastels warning/error/success */
[data-theme="dark"] div[style*="background: #FEF3C7"] { background: var(--warning-pastel) !important; border-color: var(--warning) !important; }
[data-theme="dark"] div[style*="background:#FEF3C7"] { background: var(--warning-pastel) !important; border-color: var(--warning) !important; }
[data-theme="dark"] div[style*="background: #FEE2E2"] { background: var(--danger-pastel) !important; border-color: var(--danger) !important; }
[data-theme="dark"] div[style*="background:#FEE2E2"] { background: var(--danger-pastel) !important; border-color: var(--danger) !important; }
[data-theme="dark"] div[style*="background: #DCFCE7"] { background: var(--success-pastel) !important; border-color: var(--success) !important; }
[data-theme="dark"] div[style*="background:#DCFCE7"] { background: var(--success-pastel) !important; border-color: var(--success) !important; }
[data-theme="dark"] div[style*="background: #D1FAE5"] { background: var(--success-pastel) !important; border-color: var(--success) !important; }
[data-theme="dark"] div[style*="background:#D1FAE5"] { background: var(--success-pastel) !important; border-color: var(--success) !important; }
[data-theme="dark"] div[style*="background: #DBEAFE"] { background: var(--info-pastel) !important; border-color: var(--info) !important; }
[data-theme="dark"] div[style*="background:#DBEAFE"] { background: var(--info-pastel) !important; border-color: var(--info) !important; }
[data-theme="dark"] div[style*="background: #FEF2F2"] { background: var(--danger-pastel) !important; border-color: var(--danger) !important; }
[data-theme="dark"] div[style*="background:#FEF2F2"] { background: var(--danger-pastel) !important; border-color: var(--danger) !important; }
[data-theme="dark"] div[style*="background: #FFF7ED"] { background: var(--warning-pastel) !important; border-color: var(--warning) !important; }
[data-theme="dark"] div[style*="background:#FFF7ED"] { background: var(--warning-pastel) !important; border-color: var(--warning) !important; }

/* Labels avec fond upload */  
[data-theme="dark"] label[style*="background: #FEF2F2"] { background: var(--danger-pastel) !important; border-color: var(--danger) !important; }
[data-theme="dark"] label[style*="border: 2px dashed #FCA5A5"] { border-color: var(--danger) !important; }

/* Sidebar et header */
[data-theme="dark"] .sidebar *,
[data-theme="dark"] .header * {
    color: inherit;
}

/* Fix pour éléments génériques restants */
[data-theme="dark"] article,
[data-theme="dark"] section,
[data-theme="dark"] aside,
[data-theme="dark"] main,
[data-theme="dark"] nav,
[data-theme="dark"] footer,
[data-theme="dark"] header {
    background: transparent !important;
    color: var(--text) !important;
}

.theme-toggle {
    width: 40px; height: 40px; border: none;
    background: var(--background); border-radius: var(--radius);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    color: var(--text-secondary); transition: var(--transition); font-size: 18px;
}
.theme-toggle:hover { background: var(--border); color: var(--text); }

/* RECHERCHE GLOBALE (CMD+K) */
.command-palette-overlay {
    position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px); z-index: 9999;
    display: flex; align-items: flex-start; justify-content: center;
    padding-top: 15vh; animation: fadeIn 0.15s ease-out;
}
.command-palette {
    width: 640px; max-width: 90vw; background: var(--card);
    border-radius: var(--radius-lg); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    overflow: hidden; animation: scaleIn 0.15s ease-out;
}
.command-palette-input {
    display: flex; align-items: center; gap: 12px;
    padding: 16px 20px; border-bottom: 1px solid var(--border);
}
.command-palette-input input {
    flex: 1; border: none; background: none; font-size: 16px;
    color: var(--text); outline: none; font-family: inherit;
}
.command-palette-input input::placeholder { color: var(--muted); }
.command-palette-kbd kbd {
    padding: 4px 8px; background: var(--background);
    border: 1px solid var(--border); border-radius: 6px;
    font-size: 11px; font-weight: 600; color: var(--muted);
}
.command-palette-results { max-height: 400px; overflow-y: auto; padding: 8px; }
.command-palette-group-title {
    font-size: 11px; font-weight: 600; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.5px; padding: 8px 12px 4px;
}
.command-palette-item {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 12px; border-radius: var(--radius);
    cursor: pointer; transition: var(--transition);
}
.command-palette-item:hover, .command-palette-item.selected { background: var(--background); }
.command-palette-item-icon {
    width: 36px; height: 36px; border-radius: 10px;
    background: var(--primary-pastel); display: flex;
    align-items: center; justify-content: center; font-size: 16px;
}
.command-palette-item-title { font-weight: 500; color: var(--text); }
.command-palette-item-subtitle { font-size: 12px; color: var(--muted); }
.command-palette-item-badge {
    padding: 4px 10px; background: var(--background);
    border-radius: 20px; font-size: 11px; color: var(--muted);
}
.command-palette-footer {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; border-top: 1px solid var(--border);
    background: var(--background); font-size: 12px; color: var(--muted);
}
.command-palette-shortcuts { display: flex; gap: 16px; }
.command-palette-shortcuts span { display: flex; align-items: center; gap: 6px; }
.command-palette-empty { text-align: center; padding: 40px 20px; color: var(--muted); }

/* MODE PRÉSENTATION */
.presentation-mode {
    position: fixed; inset: 0; background: var(--background);
    z-index: 10000; overflow: hidden; display: flex; flex-direction: column;
}
.presentation-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 32px; background: var(--card); border-bottom: 1px solid var(--border);
}
.presentation-logo { display: flex; align-items: center; gap: 16px; }
.presentation-logo-icon {
    width: 48px; height: 48px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 12px; display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 800; font-size: 20px;
}
.presentation-clock { font-size: 48px; font-weight: 700; color: var(--text); font-variant-numeric: tabular-nums; }
.presentation-date { font-size: 16px; color: var(--muted); text-transform: capitalize; }
.presentation-exit {
    padding: 12px 24px; background: var(--background);
    border: 1px solid var(--border); border-radius: var(--radius);
    font-size: 14px; font-weight: 500; color: var(--text); cursor: pointer;
}
.presentation-content {
    flex: 1; display: grid; grid-template-columns: 2fr 1fr;
    gap: 24px; padding: 24px 32px; overflow: hidden;
}
.presentation-kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
.presentation-kpi {
    background: var(--card); border-radius: var(--radius-lg);
    padding: 24px; text-align: center;
}
.presentation-kpi.alert { animation: pulse-alert 2s infinite; }
@keyframes pulse-alert {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
    50% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
}
.presentation-kpi-value { font-size: 56px; font-weight: 800; line-height: 1; margin-bottom: 8px; }
.presentation-kpi-label { font-size: 14px; font-weight: 500; color: var(--muted); text-transform: uppercase; }
.presentation-tasks {
    flex: 1; background: var(--card); border-radius: var(--radius-lg);
    overflow: hidden; display: flex; flex-direction: column;
}
.presentation-tasks-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px; border-bottom: 1px solid var(--border);
}
.presentation-tasks-title { font-size: 20px; font-weight: 700; color: var(--text); }
.presentation-tasks-list { flex: 1; overflow-y: auto; padding: 16px; }
.presentation-task-item {
    display: flex; align-items: center; gap: 16px;
    padding: 16px; background: var(--background);
    border-radius: var(--radius); margin-bottom: 12px;
}
.presentation-task-item.urgent { border-left: 4px solid var(--danger); background: var(--danger-pastel); }
.presentation-task-number { font-size: 24px; font-weight: 800; color: var(--primary); min-width: 120px; }
.presentation-task-status {
    padding: 8px 16px; border-radius: 20px;
    font-size: 12px; font-weight: 600; text-transform: uppercase;
}
.presentation-sidebar { display: flex; flex-direction: column; gap: 24px; }
.presentation-alerts { background: var(--card); border-radius: var(--radius-lg); padding: 20px; }
.presentation-alerts-title {
    font-size: 16px; font-weight: 700; color: var(--text);
    margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
}
.presentation-alert-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px; background: var(--danger-pastel);
    border-radius: var(--radius); margin-bottom: 8px;
}

/* STATISTIQUES */
.stats-page { padding: 24px; }
.stats-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
.stats-period-selector { display: flex; gap: 8px; background: var(--background); border-radius: var(--radius); padding: 4px; }
.stats-period-btn {
    padding: 8px 16px; border: none; background: transparent;
    border-radius: 8px; font-size: 13px; font-weight: 500;
    color: var(--muted); cursor: pointer;
}
.stats-period-btn.active { background: var(--card); color: var(--text); box-shadow: var(--shadow-sm); }
.stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 24px; }
.stats-card { background: var(--card); border-radius: var(--radius-lg); padding: 24px; }
.stats-card-icon {
    width: 48px; height: 48px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; margin-bottom: 16px;
}
.stats-card-value { font-size: 32px; font-weight: 800; color: var(--text); margin-bottom: 4px; }
.stats-card-label { font-size: 14px; color: var(--muted); }
.stats-card-trend { display: flex; align-items: center; gap: 4px; font-size: 13px; font-weight: 600; margin-top: 12px; }
.stats-card-trend.up { color: var(--success); }
.stats-card-trend.down { color: var(--danger); }
.stats-charts { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px; }
.chart-container { background: var(--card); border-radius: var(--radius-lg); padding: 24px; }
.chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.chart-title { font-size: 16px; font-weight: 700; color: var(--text); }
.chart-legend { display: flex; gap: 16px; }
.chart-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); }
.chart-legend-dot { width: 8px; height: 8px; border-radius: 50%; }
.bar-chart { display: flex; align-items: flex-end; justify-content: space-around; height: 250px; padding: 20px 0; gap: 16px; }
.bar-group { display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; }
.bar-wrapper { display: flex; gap: 4px; align-items: flex-end; height: 200px; }
.bar { width: 24px; border-radius: 4px 4px 0 0; transition: height 0.5s ease-out; }
.bar.entries { background: var(--success); }
.bar.exits { background: var(--danger); }
.bar-label { font-size: 12px; color: var(--muted); font-weight: 500; }
.donut-chart { display: flex; align-items: center; justify-content: center; gap: 32px; padding: 20px; }
.donut-visual { position: relative; width: 180px; height: 180px; }
.donut-visual svg { transform: rotate(-90deg); }
.donut-center {
    position: absolute; inset: 0; display: flex;
    flex-direction: column; align-items: center; justify-content: center;
}
.donut-center-value { font-size: 32px; font-weight: 800; color: var(--text); }
.donut-center-label { font-size: 12px; color: var(--muted); }
.donut-legend { display: flex; flex-direction: column; gap: 12px; }
.donut-legend-item { display: flex; align-items: center; gap: 12px; }
.donut-legend-color { width: 12px; height: 12px; border-radius: 3px; }
.donut-legend-label { flex: 1; font-size: 13px; color: var(--text); }
.donut-legend-value { font-size: 14px; font-weight: 600; color: var(--text); }

/* SIGNATURE ÉLECTRONIQUE */
.signature-pad-container { background: var(--card); border-radius: var(--radius-lg); padding: 24px; }
.signature-pad-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
.signature-pad-title { font-size: 16px; font-weight: 600; color: var(--text); }
.signature-pad-actions { display: flex; gap: 8px; }
.signature-canvas-wrapper {
    position: relative; border: 2px dashed var(--border);
    border-radius: var(--radius); overflow: hidden; background: white;
}
.signature-canvas { width: 100%; height: 200px; cursor: crosshair; touch-action: none; }
.signature-line { position: absolute; bottom: 40px; left: 24px; right: 24px; height: 1px; background: var(--border); }
.signature-label { position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%); font-size: 12px; color: var(--muted); }

/* IMPORT EN MASSE */
.import-zone {
    border: 2px dashed var(--border); border-radius: var(--radius-lg);
    padding: 48px; text-align: center; cursor: pointer;
}
.import-zone:hover, .import-zone.dragover { border-color: var(--primary); background: var(--primary-pastel); }
.import-zone-icon { font-size: 48px; margin-bottom: 16px; }
.import-zone-title { font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
.import-zone-subtitle { font-size: 14px; color: var(--muted); margin-bottom: 16px; }
.import-preview-table { max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius); }
.import-row {
    display: grid; grid-template-columns: 40px 1fr 1fr 1fr 80px 80px;
    gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border); font-size: 13px;
}
.import-row.header { background: var(--background); font-weight: 600; position: sticky; top: 0; }
.import-row.valid { background: var(--success-pastel); }
.import-row.invalid { background: var(--danger-pastel); }

/* AUDIT TRAIL */
.audit-timeline { padding: 24px; }
.audit-filters { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
.audit-filter {
    padding: 8px 16px; background: var(--background);
    border: 1px solid var(--border); border-radius: 20px;
    font-size: 13px; color: var(--text-secondary); cursor: pointer;
}
.audit-filter:hover { border-color: var(--primary); }
.audit-filter.active { background: var(--primary-pastel); border-color: var(--primary); color: var(--primary); }
.audit-list { position: relative; padding-left: 32px; }
.audit-list::before {
    content: ''; position: absolute; left: 11px; top: 0; bottom: 0;
    width: 2px; background: var(--border);
}
.audit-item {
    position: relative; padding: 16px 20px; background: var(--card);
    border-radius: var(--radius); margin-bottom: 16px; box-shadow: var(--shadow-sm);
}
.audit-item::before {
    content: ''; position: absolute; left: -26px; top: 24px;
    width: 12px; height: 12px; border-radius: 50%;
    background: var(--card); border: 3px solid var(--primary);
}
.audit-item.create::before { border-color: var(--success); }
.audit-item.update::before { border-color: var(--info); }
.audit-item.delete::before { border-color: var(--danger); }
.audit-item-type {
    padding: 4px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 600; text-transform: uppercase;
}
.audit-item-type.create { background: var(--success-pastel); color: var(--success); }
.audit-item-type.update { background: var(--info-pastel); color: var(--info); }
.audit-item-type.delete { background: var(--danger-pastel); color: var(--danger); }

/* KANBAN DRAG & DROP */
.kanban-board { display: flex; gap: 20px; padding: 20px; overflow-x: auto; min-height: calc(100vh - 200px); }
.kanban-column {
    flex: 0 0 320px; background: var(--background);
    border-radius: var(--radius-lg); display: flex;
    flex-direction: column; max-height: calc(100vh - 240px);
}
.kanban-column-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px; border-bottom: 1px solid var(--border);
}
.kanban-column-title { font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 8px; }
.kanban-column-count {
    padding: 2px 8px; background: var(--card); border-radius: 10px;
    font-size: 12px; font-weight: 500; color: var(--muted);
}
.kanban-column-body { flex: 1; padding: 12px; overflow-y: auto; min-height: 100px; }
.kanban-column-body.drag-over { background: var(--primary-pastel); }
.kanban-card {
    background: var(--card); border-radius: var(--radius);
    padding: 16px; margin-bottom: 12px; cursor: grab;
    border: 1px solid var(--border);
}
.kanban-card:hover { box-shadow: var(--shadow); }
.kanban-card.dragging { opacity: 0.5; transform: rotate(3deg); }
.kanban-card-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 8px; }
.kanban-card-number { font-weight: 700; color: var(--primary); font-size: 14px; }
.kanban-card-priority {
    padding: 2px 8px; border-radius: 4px;
    font-size: 10px; font-weight: 600; text-transform: uppercase;
}
.kanban-card-priority.urgent { background: var(--danger-pastel); color: var(--danger); }
.kanban-card-priority.haute { background: var(--warning-pastel); color: var(--warning); }
.kanban-card-title {
    font-size: 14px; color: var(--text); margin-bottom: 8px;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.kanban-card-footer { display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: var(--muted); }
.kanban-card-avatar {
    width: 20px; height: 20px; border-radius: 50%;
    background: var(--primary-pastel); color: var(--primary);
    display: flex; align-items: center; justify-content: center;
    font-size: 9px; font-weight: 600;
}

/* SCANNER WEB */
.scanner-container { position: relative; background: var(--card); border-radius: var(--radius-lg); overflow: hidden; }
.scanner-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
.scanner-frame { width: 280px; height: 180px; border: 3px solid var(--primary); border-radius: 12px; position: relative; }
.scanner-line {
    position: absolute; left: 10%; right: 10%; height: 2px;
    background: linear-gradient(90deg, transparent, var(--primary), transparent);
    animation: scan 2s linear infinite;
}
@keyframes scan { 0% { top: 10%; } 50% { top: 90%; } 100% { top: 10%; } }
.scanner-result {
    padding: 16px; background: var(--success-pastel);
    display: flex; align-items: center; gap: 12px;
}
.scanner-result-icon {
    width: 40px; height: 40px; background: var(--success); color: white;
    border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;
}
.scanner-result-code { font-family: monospace; font-size: 18px; font-weight: 600; color: var(--text); }

/* OFFLINE / PWA */
.offline-banner {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    display: flex; align-items: center; gap: 12px;
    padding: 12px 20px; background: var(--warning); color: white;
    border-radius: 30px; font-size: 14px; font-weight: 500;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); z-index: 9998;
}
.sync-indicator {
    position: fixed; bottom: 24px; right: 24px;
    display: flex; align-items: center; gap: 8px;
    padding: 10px 16px; background: var(--card); border-radius: 20px;
    font-size: 12px; font-weight: 500; color: var(--muted);
    box-shadow: var(--shadow-lg); z-index: 9997;
}

/* RACCOURCIS CLAVIER */
.shortcuts-modal {
    position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px); z-index: 9999;
    display: flex; align-items: center; justify-content: center;
}
.shortcuts-content {
    width: 600px; max-width: 100%; max-height: 80vh;
    background: var(--card); border-radius: var(--radius-lg); overflow: hidden;
}
.shortcuts-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 20px 24px; border-bottom: 1px solid var(--border);
}
.shortcuts-title { font-size: 18px; font-weight: 700; color: var(--text); }
.shortcuts-body { padding: 24px; overflow-y: auto; max-height: calc(80vh - 80px); }
.shortcuts-section { margin-bottom: 24px; }
.shortcuts-section-title {
    font-size: 12px; font-weight: 600; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;
}
.shortcut-item {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 0; border-bottom: 1px solid var(--border);
}
.shortcut-label { font-size: 14px; color: var(--text); }
.shortcut-keys { display: flex; gap: 4px; }
.shortcut-keys kbd {
    padding: 4px 10px; background: var(--background);
    border: 1px solid var(--border); border-radius: 6px;
    font-size: 12px; font-weight: 600; color: var(--text-secondary);
}

/* ALERTES CONFIGURABLES */
.alert-rule {
    display: flex; align-items: center; gap: 16px;
    padding: 20px; background: var(--card);
    border-radius: var(--radius-lg); border: 1px solid var(--border); margin-bottom: 12px;
}
.alert-rule-status {
    width: 40px; height: 40px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center; font-size: 20px;
}
.alert-rule-status.active { background: var(--success-pastel); }
.alert-rule-status.inactive { background: var(--background); }
.alert-rule-content { flex: 1; }
.alert-rule-name { font-weight: 600; color: var(--text); margin-bottom: 4px; }
.alert-rule-condition { font-size: 13px; color: var(--muted); }
.alert-rule-toggle {
    position: relative; width: 44px; height: 24px;
    background: var(--border); border-radius: 12px; cursor: pointer;
}
.alert-rule-toggle.active { background: var(--success); }
.alert-rule-toggle::after {
    content: ''; position: absolute; top: 2px; left: 2px;
    width: 20px; height: 20px; background: white;
    border-radius: 50%; transition: var(--transition);
}
.alert-rule-toggle.active::after { left: 22px; }

/* ============================================================================
   v5.1 - SCANNER PAGE STYLES
   ============================================================================ */
.scanner-page { padding: 24px; }
.scanner-layout { display: grid; grid-template-columns: 1fr 400px; gap: 24px; }
.scanner-main { display: flex; flex-direction: column; gap: 20px; }
.scanner-mode-selector { display: flex; gap: 8px; }
.scanner-mode-btn {
    padding: 12px 24px; border: 2px solid var(--border); background: var(--card);
    border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: var(--transition);
}
.scanner-mode-btn:hover { border-color: var(--primary); }
.scanner-mode-btn.active { background: var(--primary-pastel); border-color: var(--primary); color: var(--primary); }
.scanner-container-wrapper {
    background: var(--card); border-radius: var(--radius-lg); padding: 24px;
    display: flex; flex-direction: column; align-items: center; gap: 20px;
}
.scanner-viewport {
    width: 100%; max-width: 500px; aspect-ratio: 1; background: #111;
    border-radius: var(--radius); overflow: hidden; position: relative;
}
.scanner-placeholder {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center; color: #666; gap: 16px;
}
.scanner-icon { font-size: 64px; opacity: 0.5; }
.scanner-controls { display: flex; gap: 12px; }
.manual-input-section {
    width: 100%; display: flex; align-items: center; gap: 12px;
    padding: 16px; background: var(--background); border-radius: var(--radius);
}
.manual-input-section label { font-weight: 500; white-space: nowrap; }
.manual-input-section .form-input { flex: 1; }
.last-scanned {
    padding: 12px 16px; background: var(--info-pastel); border-radius: var(--radius);
    color: var(--info); font-size: 14px;
}
.last-scanned code { font-family: monospace; font-weight: 600; }
.scanner-results {
    background: var(--card); border-radius: var(--radius-lg); overflow: hidden;
}
.results-header {
    padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border);
}
.results-header h3 { margin: 0; font-size: 16px; }
.results-count { font-size: 13px; color: var(--muted); }
.results-list { max-height: 500px; overflow-y: auto; }
.empty-results { padding: 40px; text-align: center; color: var(--muted); }
.result-item {
    display: flex; align-items: center; gap: 12px; padding: 12px 16px;
    border-bottom: 1px solid var(--border); transition: var(--transition);
}
.result-item:hover { background: var(--background); }
.result-item.part .result-icon { color: var(--info); }
.result-item.task .result-icon { color: var(--warning); }
.result-item.device .result-icon { color: var(--purple); }
.result-item.unknown .result-icon { color: var(--muted); }
.result-icon { font-size: 20px; }
.result-info { flex: 1; min-width: 0; }
.result-code { font-family: monospace; font-weight: 600; color: var(--text); }
.result-name { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
.result-time { font-size: 12px; color: var(--muted); margin-top: 4px; }

/* ============================================================================
   v5.1 - AUDIT PAGE STYLES
   ============================================================================ */
.audit-page { padding: 24px; }
.audit-filters {
    display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 24px;
    padding: 16px; background: var(--card); border-radius: var(--radius-lg);
}
.audit-filters .filter-group { flex: 1; min-width: 200px; }
.audit-stats {
    display: flex; gap: 16px; margin-bottom: 24px;
}
.audit-stat {
    flex: 1; background: var(--card); padding: 16px 20px; border-radius: var(--radius);
    text-align: center;
}
.audit-stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
.audit-stat-label { font-size: 13px; color: var(--muted); margin-top: 4px; }
.audit-timeline { position: relative; padding-left: 40px; }
.timeline-item {
    position: relative; padding: 20px; margin-bottom: 16px;
    background: var(--card); border-radius: var(--radius); margin-left: 20px;
}
.timeline-marker {
    position: absolute; left: -30px; top: 20px;
    width: 40px; height: 40px; background: var(--card);
    border: 3px solid var(--border); border-radius: 50%;
    display: flex; align-items: center; justify-content: center; font-size: 16px;
}
.timeline-content { padding-left: 20px; }
.timeline-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.timeline-entity { font-weight: 600; color: var(--text); }
.timeline-badge {
    padding: 2px 8px; border-radius: 20px; font-size: 11px;
    color: white; text-transform: uppercase; font-weight: 600;
}
.timeline-meta { display: flex; gap: 16px; font-size: 13px; color: var(--muted); margin-bottom: 8px; }
.timeline-details { display: flex; gap: 8px; flex-wrap: wrap; }
.detail-tag {
    padding: 4px 10px; background: var(--background); border-radius: 20px;
    font-size: 12px; color: var(--text-secondary);
}

/* ============================================================================
   v5.1 - IMPORT PAGE STYLES
   ============================================================================ */
.import-page { padding: 24px; }
.import-type-selector { margin-bottom: 24px; }
.import-type-selector label { display: block; margin-bottom: 8px; font-weight: 500; }
.import-type-buttons { display: flex; gap: 12px; }
.import-type-btn {
    padding: 16px 24px; border: 2px solid var(--border); background: var(--card);
    border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: var(--transition);
    font-size: 15px;
}
.import-type-btn:hover { border-color: var(--primary); background: var(--primary-pastel); }
.import-type-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
.import-dropzone {
    border: 3px dashed var(--border); border-radius: var(--radius-xl);
    padding: 60px 40px; text-align: center; transition: var(--transition);
    cursor: pointer; background: var(--card);
}
.import-dropzone:hover, .import-dropzone.drag-over {
    border-color: var(--primary); background: var(--primary-pastel);
}
.dropzone-content { display: flex; flex-direction: column; align-items: center; gap: 16px; }
.dropzone-icon { font-size: 64px; }
.dropzone-text { font-size: 18px; font-weight: 600; color: var(--text); }
.dropzone-subtext { color: var(--muted); }
.dropzone-formats { font-size: 13px; color: var(--muted); margin-top: 8px; }
.import-preview { background: var(--card); border-radius: var(--radius-lg); overflow: hidden; }
.preview-header {
    padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border); background: var(--background);
}
.preview-header h3 { margin: 0; font-size: 16px; }
.preview-count { font-size: 13px; color: var(--muted); }
.mapping-section { padding: 20px; border-bottom: 1px solid var(--border); }
.mapping-section h4 { margin: 0 0 16px 0; font-size: 15px; }
.mapping-grid { display: flex; flex-direction: column; gap: 12px; }
.mapping-row { display: flex; align-items: center; gap: 12px; }
.mapping-source {
    flex: 1; padding: 8px 12px; background: var(--background); border-radius: var(--radius);
    font-family: monospace; font-size: 13px;
}
.mapping-arrow { color: var(--muted); font-size: 18px; }
.mapping-target { flex: 1; }
.preview-table-wrapper { max-height: 300px; overflow: auto; }
.preview-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.preview-table th, .preview-table td {
    padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border);
}
.preview-table th { background: var(--background); font-weight: 600; position: sticky; top: 0; }
.import-actions { padding: 20px; display: flex; gap: 12px; justify-content: flex-end; }
.import-results {
    display: flex; gap: 16px; padding: 20px; background: var(--background);
    border-top: 1px solid var(--border);
}
.result-stat { padding: 12px 20px; border-radius: var(--radius); font-weight: 600; }
.result-stat.success { background: var(--success-pastel); color: var(--success); }
.result-stat.error { background: var(--danger-pastel); color: var(--danger); }
.result-stat.total { background: var(--info-pastel); color: var(--info); }

/* ============================================================================
   v5.1 - ALERTS PAGE STYLES
   ============================================================================ */
.alerts-page { padding: 24px; }
.active-alerts {
    background: var(--warning-pastel); border-radius: var(--radius-lg);
    padding: 20px; margin-bottom: 24px; border: 1px solid var(--warning);
}
.active-alerts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.active-alerts-header h3 { margin: 0; color: var(--warning); }
.active-alerts-list { display: flex; flex-direction: column; gap: 8px; }
.active-alert-item {
    display: flex; align-items: center; gap: 12px; padding: 12px 16px;
    background: white; border-radius: var(--radius);
}
.alert-count { margin-left: auto; font-weight: 600; color: var(--warning); }
.alerts-list { background: var(--card); border-radius: var(--radius-lg); }
.alerts-list-header {
    padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--border);
}
.alerts-list-header h3 { margin: 0; font-size: 16px; }
.alert-rule-card {
    padding: 20px; border-bottom: 1px solid var(--border); transition: var(--transition);
}
.alert-rule-card:hover { background: var(--background); }
.alert-rule-card.disabled { opacity: 0.6; }
.alert-rule-header { display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
.alert-rule-icon { font-size: 24px; }
.alert-rule-info { flex: 1; }
.alert-rule-name { font-weight: 600; color: var(--text); }
.alert-rule-condition { font-size: 13px; color: var(--muted); font-family: monospace; }
.toggle-switch { position: relative; display: inline-block; width: 48px; height: 26px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
    position: absolute; cursor: pointer; inset: 0; background: var(--border);
    border-radius: 26px; transition: var(--transition);
}
.toggle-slider::before {
    content: ''; position: absolute; height: 20px; width: 20px;
    left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: var(--transition);
}
.toggle-switch input:checked + .toggle-slider { background: var(--success); }
.toggle-switch input:checked + .toggle-slider::before { transform: translateX(22px); }
.alert-rule-channels { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
.channels-label { font-size: 13px; color: var(--muted); }
.channel-badge {
    padding: 4px 10px; background: var(--background); border-radius: 20px;
    font-size: 12px; color: var(--text-secondary);
}
.alert-rule-actions { display: flex; gap: 8px; }
.alert-modal { max-width: 500px; }
.alert-form .form-group { margin-bottom: 16px; }
.alert-form label { display: block; margin-bottom: 6px; font-weight: 500; }
.checkbox-group { display: flex; flex-wrap: wrap; gap: 12px; }
.checkbox-label {
    display: flex; align-items: center; gap: 6px; cursor: pointer;
    padding: 8px 12px; background: var(--background); border-radius: var(--radius);
}
.checkbox-label input { margin: 0; }

/* ============================================================================
   v5.1 - API DOCS PAGE STYLES
   ============================================================================ */
.api-docs-page { padding: 24px; }
.api-key-section {
    background: var(--card); border-radius: var(--radius-lg); padding: 24px;
    margin-bottom: 24px; border: 1px solid var(--border);
}
.api-key-header { margin-bottom: 16px; }
.api-key-header h3 { margin: 0 0 4px 0; }
.api-key-header p { margin: 0; color: var(--muted); font-size: 14px; }
.api-key-display {
    display: flex; align-items: center; gap: 8px;
    padding: 12px 16px; background: var(--background); border-radius: var(--radius);
}
.api-key-value {
    flex: 1; font-family: monospace; font-size: 14px; letter-spacing: 1px;
}
.api-key-warning {
    margin-top: 12px; padding: 12px 16px; background: var(--warning-pastel);
    border-radius: var(--radius); font-size: 13px; color: var(--warning);
}
.api-layout { display: grid; grid-template-columns: 240px 1fr; gap: 24px; }
.api-sidebar {
    background: var(--card); border-radius: var(--radius-lg); padding: 16px;
    height: fit-content; position: sticky; top: 88px;
}
.api-sidebar h4 { margin: 0 0 12px 12px; font-size: 13px; color: var(--muted); text-transform: uppercase; }
.api-nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 12px 16px; border-radius: var(--radius); cursor: pointer;
    color: var(--text-secondary); font-weight: 500; transition: var(--transition);
}
.api-nav-item:hover { background: var(--background); color: var(--text); }
.api-nav-item.active { background: var(--primary-pastel); color: var(--primary); }
.api-content { background: var(--card); border-radius: var(--radius-lg); overflow: hidden; }
.endpoint-detail { padding: 24px; }
.endpoint-header { margin-bottom: 24px; }
.endpoint-header h2 { margin: 0 0 8px 0; }
.endpoint-header p { margin: 0; color: var(--muted); }
.endpoint-methods { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
.method-item {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 16px; background: var(--background); border-radius: var(--radius);
}
.method-badge {
    padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;
    text-transform: uppercase; min-width: 60px; text-align: center;
}
.method-badge.get { background: #10B98120; color: #10B981; }
.method-badge.post { background: #3B82F620; color: #3B82F6; }
.method-badge.put, .method-badge.patch { background: #F59E0B20; color: #F59E0B; }
.method-badge.delete { background: #EF444420; color: #EF4444; }
.method-path { font-family: monospace; font-size: 13px; flex: 1; }
.method-desc { font-size: 13px; color: var(--muted); }
.code-example { margin-top: 24px; }
.code-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 16px; background: #1E293B; border-radius: var(--radius) var(--radius) 0 0;
    color: white;
}
.code-header span { font-size: 13px; font-weight: 500; }
.code-block {
    margin: 0; padding: 16px; background: #0F172A; color: #E2E8F0;
    border-radius: 0 0 var(--radius) var(--radius); overflow-x: auto;
    font-size: 13px; line-height: 1.6;
}
.api-footer {
    display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
    margin-top: 24px;
}
.rate-limits, .api-support {
    background: var(--card); border-radius: var(--radius-lg); padding: 20px;
}
.rate-limits h4, .api-support h4 { margin: 0 0 12px 0; font-size: 15px; }
.rate-limits p, .api-support p { margin: 0 0 8px 0; font-size: 14px; color: var(--text-secondary); }

/* ============================================================================
   v5.1 - EXPORT BUTTON STYLES
   ============================================================================ */
.export-dropdown { position: relative; display: inline-block; }
.export-menu {
    position: absolute; top: 100%; right: 0; margin-top: 8px;
    background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
    box-shadow: var(--shadow-lg); z-index: 100; min-width: 160px;
}
.export-menu-item {
    display: flex; align-items: center; gap: 8px;
    padding: 10px 16px; cursor: pointer; font-size: 14px; transition: var(--transition);
}
.export-menu-item:hover { background: var(--background); }
.export-menu-item:first-child { border-radius: var(--radius) var(--radius) 0 0; }
.export-menu-item:last-child { border-radius: 0 0 var(--radius) var(--radius); }

/* RESPONSIVE */
@media (max-width: 1200px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .presentation-content { grid-template-columns: 1fr; }
    .presentation-kpis { grid-template-columns: repeat(2, 1fr); }
    .stats-charts { grid-template-columns: 1fr; }
    .scanner-layout { grid-template-columns: 1fr; }
    .scanner-results { max-height: 300px; }
    .api-layout { grid-template-columns: 1fr; }
    .api-sidebar { position: static; }
    .api-footer { grid-template-columns: 1fr; }
}
@media (max-width: 768px) {
    .command-palette { width: 100%; margin: 16px; }
    .kanban-board { flex-direction: column; }
    .kanban-column { flex: none; width: 100%; max-height: none; }
    .stats-grid { grid-template-columns: 1fr; }
    .presentation-kpis { grid-template-columns: 1fr; }
    .import-type-buttons { flex-direction: column; }
    .audit-stats { flex-direction: column; }
    .audit-timeline { padding-left: 20px; }
    .timeline-marker { left: -10px; width: 30px; height: 30px; font-size: 12px; }
}
    
/* ============================================================================
   STOCKAPP v5.2 - AMÉLIORATIONS CSS INTÉGRÉES
   ============================================================================ */

/**
 * ============================================================================
 * STOCKAPP v5.2 - STYLES AMÉLIORÉS
 * ============================================================================
 * Ce fichier contient tous les styles CSS pour les améliorations
 * À ajouter dans la section <style> de index.html
 * ============================================================================
 */

/* ============================================================================
   VARIABLES CSS - MODE SOMBRE AMÉLIORÉ
   ============================================================================ */

:root {
    /* Couleurs de base */
    --primary: #E11D48;
    --primary-light: #FDA4AF;
    --primary-dark: #BE123C;
    --primary-pastel: #FFF1F2;
    --secondary: #F97316;
    --secondary-pastel: #FFF7ED;
    --success: #10B981;
    --success-pastel: #D1FAE5;
    --warning: #F59E0B;
    --warning-pastel: #FEF3C7;
    --danger: #EF4444;
    --danger-pastel: #FEE2E2;
    --info: #3B82F6;
    --info-pastel: #DBEAFE;
    --purple: #8B5CF6;
    --purple-pastel: #EDE9FE;
    --teal: #14B8A6;
    --teal-pastel: #CCFBF1;
    
    /* Mode clair */
    --text: #1E293B;
    --text-secondary: #475569;
    --muted: #94A3B8;
    --border: #E2E8F0;
    --background: #F8FAFC;
    --card: #FFFFFF;
    --hover: #F1F5F9;
    
    /* Dimensions */
    --sidebar-width: 260px;
    --sidebar-collapsed: 72px;
    --header-height: 64px;
    --radius: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    
    /* Ombres */
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -2px rgba(0,0,0,0.05);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.05);
    
    /* Transitions */
    --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-fast: all 0.15s ease;
    --transition-slow: all 0.3s ease;
}

/* Mode sombre */
[data-theme="dark"] {
    --text: #F1F5F9;
    --text-secondary: #CBD5E1;
    --muted: #64748B;
    --border: #334155;
    --background: #0F172A;
    --card: #1E293B;
    --hover: #334155;
    
    --primary-pastel: rgba(225, 29, 72, 0.15);
    --secondary-pastel: rgba(249, 115, 22, 0.15);
    --success-pastel: rgba(16, 185, 129, 0.15);
    --warning-pastel: rgba(245, 158, 11, 0.15);
    --danger-pastel: rgba(239, 68, 68, 0.15);
    --info-pastel: rgba(59, 130, 246, 0.15);
    --purple-pastel: rgba(139, 92, 246, 0.15);
    --teal-pastel: rgba(20, 184, 166, 0.15);
    
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4);
    --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.5);
}

/* ============================================================================
   SKELETON LOADER
   ============================================================================ */

.skeleton-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.skeleton {
    background: linear-gradient(
        90deg,
        var(--border) 25%,
        var(--hover) 50%,
        var(--border) 75%
    );
    background-size: 200% 100%;
    animation: skeleton-shimmer 1.5s ease-in-out infinite;
}

@keyframes skeleton-shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

.skeleton-row {
    display: flex;
    gap: 16px;
    padding: 12px 16px;
    animation: skeleton-fade 0.5s ease-out both;
}

@keyframes skeleton-fade {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.skeleton-card {
    overflow: hidden;
}

.card-skeleton-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
}

/* ============================================================================
   BREADCRUMB
   ============================================================================ */

.breadcrumb {
    padding: 8px 0;
    margin-bottom: 16px;
}

.breadcrumb-list {
    display: flex;
    align-items: center;
    list-style: none;
    gap: 4px;
    flex-wrap: wrap;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.breadcrumb-item a {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
    padding: 4px 8px;
    border-radius: 6px;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: 6px;
}

.breadcrumb-item a:hover {
    color: var(--primary);
    background: var(--primary-pastel);
}

.breadcrumb-item.active span {
    color: var(--text);
    font-weight: 600;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.breadcrumb-separator {
    color: var(--muted);
    font-size: 12px;
    margin: 0 4px;
}

/* ============================================================================
   PROGRESS BAR
   ============================================================================ */

.progress-container {
    width: 100%;
    background: var(--border);
    border-radius: 100px;
    overflow: hidden;
    position: relative;
}

.progress-sm { height: 4px; }
.progress-md { height: 8px; }
.progress-lg { height: 12px; }

.progress-bar {
    height: 100%;
    border-radius: 100px;
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.progress-primary { background: linear-gradient(90deg, var(--primary), var(--primary-light)); }
.progress-success { background: linear-gradient(90deg, var(--success), #34D399); }
.progress-warning { background: linear-gradient(90deg, var(--warning), #FCD34D); }
.progress-danger { background: linear-gradient(90deg, var(--danger), #F87171); }
.progress-info { background: linear-gradient(90deg, var(--info), #60A5FA); }

.progress-animated {
    background-size: 200% 100%;
    animation: progress-stripe 1s linear infinite;
}

@keyframes progress-stripe {
    0% { background-position: 200% 0; }
    100% { background-position: 0 0; }
}

.progress-label {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    font-weight: 600;
    color: var(--text);
}

/* ============================================================================
   CONNECTION INDICATOR
   ============================================================================ */

.connection-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 100px;
    font-size: 12px;
    font-weight: 500;
    transition: var(--transition);
}

.connection-indicator.online {
    background: var(--success-pastel);
    color: var(--success);
}

.connection-indicator.offline {
    background: var(--danger-pastel);
    color: var(--danger);
    animation: pulse-danger 2s infinite;
}

.connection-indicator.slow {
    background: var(--warning-pastel);
    color: var(--warning);
}

.connection-indicator.medium {
    background: var(--info-pastel);
    color: var(--info);
}

@keyframes pulse-danger {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.connection-text {
    display: none;
}

@media (min-width: 768px) {
    .connection-text {
        display: inline;
    }
}

/* ============================================================================
   SESSION TIMEOUT WARNING
   ============================================================================ */

.session-warning-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
}

.session-warning-modal {
    background: var(--card);
    border-radius: var(--radius-xl);
    padding: 40px;
    max-width: 400px;
    text-align: center;
    animation: scaleIn 0.3s ease;
}

.session-warning-icon {
    width: 80px;
    height: 80px;
    background: var(--warning-pastel);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 24px;
    color: var(--warning);
    animation: pulse 2s infinite;
}

.session-warning-modal h3 {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
}

.session-warning-modal p {
    color: var(--text-secondary);
    font-size: 14px;
    margin-bottom: 8px;
}

.session-warning-hint {
    color: var(--muted);
    font-size: 13px !important;
}

.session-warning-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
    justify-content: center;
}

/* ============================================================================
   GUIDED TOUR
   ============================================================================ */

.tour-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9998;
    pointer-events: none;
}

.tour-highlight {
    position: relative;
    z-index: 9999;
    box-shadow: 0 0 0 4px var(--primary), 0 0 0 9999px rgba(0, 0, 0, 0.5);
    border-radius: var(--radius);
    pointer-events: auto;
}

.tour-tooltip {
    position: fixed;
    background: var(--card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    padding: 20px;
    max-width: 320px;
    z-index: 10000;
    animation: fadeInUp 0.3s ease;
}

.tour-tooltip::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 24px;
    width: 16px;
    height: 16px;
    background: var(--card);
    transform: rotate(45deg);
    box-shadow: -2px -2px 4px rgba(0, 0, 0, 0.05);
}

.tour-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.tour-step-indicator {
    font-size: 12px;
    font-weight: 600;
    color: var(--primary);
    background: var(--primary-pastel);
    padding: 4px 10px;
    border-radius: 100px;
}

.tour-close {
    width: 28px;
    height: 28px;
    border: none;
    background: var(--background);
    border-radius: 50%;
    cursor: pointer;
    color: var(--muted);
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition-fast);
}

.tour-close:hover {
    background: var(--border);
    color: var(--text);
}

.tour-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
}

.tour-content {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 16px;
}

.tour-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
}

/* ============================================================================
   SEARCH WITH HISTORY
   ============================================================================ */

.search-with-history {
    position: relative;
}

.search-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.search-input-wrapper .search-icon {
    position: absolute;
    left: 14px;
    color: var(--muted);
    pointer-events: none;
    transition: var(--transition-fast);
}

.search-input-wrapper.focused .search-icon {
    color: var(--primary);
}

.search-input-wrapper .search-input {
    padding-left: 44px;
    padding-right: 40px;
}

.search-clear {
    position: absolute;
    right: 10px;
    width: 28px;
    height: 28px;
    border: none;
    background: var(--border);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: var(--transition-fast);
}

.search-clear:hover {
    background: var(--danger-pastel);
    color: var(--danger);
}

.search-history-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    margin-top: 8px;
    z-index: 100;
    animation: fadeInUp 0.2s ease;
    overflow: hidden;
}

.search-history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
}

.search-history-header span {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
}

.search-history-clear {
    font-size: 12px;
    color: var(--primary);
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    transition: var(--transition-fast);
}

.search-history-clear:hover {
    background: var(--primary-pastel);
}

.search-history-list {
    list-style: none;
    max-height: 240px;
    overflow-y: auto;
}

.search-history-list li {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 14px;
    transition: var(--transition-fast);
}

.search-history-list li:hover {
    background: var(--hover);
    color: var(--text);
}

.search-history-list li svg {
    color: var(--muted);
}

/* ============================================================================
   FAVORITES
   ============================================================================ */

.favorites-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
}

.favorites-empty svg {
    margin-bottom: 12px;
    opacity: 0.5;
}

.favorites-empty p {
    font-size: 14px;
    margin-bottom: 4px;
}

.favorites-empty small {
    font-size: 12px;
}

.favorites-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.favorite-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition-fast);
}

.favorite-item:hover {
    background: var(--hover);
}

.favorite-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.favorite-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
}

.favorite-category {
    font-size: 12px;
    color: var(--muted);
}

.favorite-remove {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: var(--transition-fast);
    opacity: 0;
}

.favorite-item:hover .favorite-remove {
    opacity: 1;
}

.favorite-remove:hover {
    background: var(--danger-pastel);
    color: var(--danger);
}

.favorite-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: var(--transition);
}

.favorite-btn:hover {
    color: var(--warning);
    background: var(--warning-pastel);
    transform: scale(1.1);
}

.favorite-btn.active {
    color: var(--warning);
}

.favorite-btn.active svg {
    fill: var(--warning);
}

/* ============================================================================
   FILTER PRESETS
   ============================================================================ */

.filter-presets {
    background: var(--card);
    border-radius: var(--radius);
    border: 1px solid var(--border);
    overflow: hidden;
}

.filter-presets-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
}

.filter-presets-header span {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
}

.filter-preset-save {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    animation: fadeInUp 0.2s ease;
}

.filter-preset-save .form-input {
    flex: 1;
    padding: 8px 12px;
    font-size: 13px;
}

.filter-presets-list {
    padding: 8px;
}

.filter-presets-empty {
    padding: 20px;
    text-align: center;
    color: var(--muted);
    font-size: 13px;
}

.filter-preset-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 4px;
}

.filter-preset-apply {
    flex: 1;
    text-align: left;
    padding: 10px 12px;
    border: none;
    background: transparent;
    border-radius: var(--radius);
    font-size: 13px;
    color: var(--text);
    cursor: pointer;
    transition: var(--transition-fast);
}

.filter-preset-apply:hover {
    background: var(--hover);
}

.filter-preset-delete {
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    border-radius: var(--radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: var(--transition-fast);
}

.filter-preset-delete:hover {
    background: var(--danger-pastel);
    color: var(--danger);
}

/* ============================================================================
   VIEW MODE SELECTOR
   ============================================================================ */

.view-mode-selector {
    display: flex;
    background: var(--background);
    border-radius: var(--radius);
    padding: 4px;
    gap: 4px;
}

.view-mode-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: var(--transition-fast);
}

.view-mode-btn:hover {
    color: var(--text);
    background: var(--card);
}

.view-mode-btn.active {
    color: var(--primary);
    background: var(--card);
    box-shadow: var(--shadow-sm);
}

/* ============================================================================
   QUICK ACTIONS (FAB)
   ============================================================================ */

.quick-actions {
    position: fixed;
    z-index: 100;
}

.quick-actions.bottom-right {
    bottom: 24px;
    right: 24px;
}

.quick-actions.bottom-left {
    bottom: 24px;
    left: 24px;
}

.quick-actions-trigger {
    width: 56px;
    height: 56px;
    border: none;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    box-shadow: var(--shadow-lg), 0 4px 20px rgba(225, 29, 72, 0.3);
    transition: var(--transition);
}

.quick-actions-trigger:hover {
    transform: scale(1.1);
}

.quick-actions-trigger svg {
    transition: transform 0.3s ease;
}

.quick-actions.open .quick-actions-trigger svg {
    transform: rotate(45deg);
}

.quick-actions-menu {
    position: absolute;
    bottom: 70px;
    right: 0;
    display: flex;
    flex-direction: column;
    gap: 12px;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: var(--transition);
}

.quick-actions.open .quick-actions-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.quick-action-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border: none;
    background: var(--card);
    border-radius: 100px;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    color: var(--text);
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    transition: var(--transition);
    transform: translateX(20px);
    opacity: 0;
}

.quick-actions.open .quick-action-item {
    transform: translateX(0);
    opacity: 1;
}

.quick-action-item:hover {
    background: var(--primary);
    color: white;
    transform: translateX(-4px) !important;
}

.quick-action-label {
    display: none;
}

@media (min-width: 768px) {
    .quick-action-label {
        display: inline;
    }
}

/* ============================================================================
   TOAST IMPROVED
   ============================================================================ */

.toast {
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 16px;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    min-width: 300px;
    max-width: 420px;
    animation: slideInRight 0.3s ease;
    overflow: hidden;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.toast-icon {
    flex-shrink: 0;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.toast-success .toast-icon { color: var(--success); }
.toast-error .toast-icon { color: var(--danger); }
.toast-warning .toast-icon { color: var(--warning); }
.toast-info .toast-icon { color: var(--info); }

.toast-content {
    flex: 1;
    min-width: 0;
}

.toast-message {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    display: block;
    margin-bottom: 4px;
}

.toast-action {
    font-size: 13px;
    font-weight: 600;
    color: var(--primary);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    text-decoration: underline;
}

.toast-close {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    border: none;
    background: transparent;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: var(--transition-fast);
}

.toast-close:hover {
    background: var(--hover);
    color: var(--text);
}

.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    transition: width 0.05s linear;
}

.toast-success .toast-progress { background: var(--success); }
.toast-error .toast-progress { background: var(--danger); }
.toast-warning .toast-progress { background: var(--warning); }
.toast-info .toast-progress { background: var(--info); }

/* ============================================================================
   EMPTY STATE IMPROVED
   ============================================================================ */

.empty-state-improved {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 40px;
    text-align: center;
}

.empty-state-illustration {
    max-width: 200px;
    margin-bottom: 24px;
}

.empty-state-icon {
    width: 100px;
    height: 100px;
    background: var(--background);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    color: var(--muted);
}

.empty-state-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
}

.empty-state-description {
    font-size: 14px;
    color: var(--text-secondary);
    max-width: 400px;
    margin-bottom: 24px;
    line-height: 1.6;
}

.empty-state-actions {
    display: flex;
    gap: 12px;
}

/* ============================================================================
   PAGINATION
   ============================================================================ */

.pagination-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 0;
    gap: 16px;
    flex-wrap: wrap;
}

.pagination-info {
    font-size: 13px;
    color: var(--text-secondary);
}

.pagination {
    display: flex;
    gap: 4px;
}

.pagination-btn {
    min-width: 36px;
    height: 36px;
    border: 1px solid var(--border);
    background: var(--card);
    border-radius: var(--radius);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text);
    font-size: 14px;
    font-weight: 500;
    transition: var(--transition-fast);
}

.pagination-btn:hover:not(:disabled) {
    border-color: var(--primary);
    color: var(--primary);
}

.pagination-btn.active {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ============================================================================
   VALIDATED INPUT
   ============================================================================ */

.form-group.has-error .form-input,
.input-error {
    border-color: var(--danger);
}

.form-group.has-error .form-input:focus {
    box-shadow: 0 0 0 3px var(--danger-pastel);
}

.form-error {
    font-size: 12px;
    color: var(--danger);
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 4px;
}

.form-error::before {
    content: '⚠';
}

.required-indicator {
    color: var(--danger);
    margin-left: 4px;
}

/* ============================================================================
   EXPORT MODAL
   ============================================================================ */

.export-modal-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.export-format-buttons {
    display: flex;
    gap: 12px;
}

.export-format-buttons .btn {
    flex: 1;
}

.export-columns-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
    padding: 12px;
    background: var(--background);
    border-radius: var(--radius);
}

.export-column-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text);
    cursor: pointer;
}

.export-summary {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px;
    background: var(--info-pastel);
    border-radius: var(--radius);
    font-size: 13px;
    color: var(--info);
}

/* ============================================================================
   DIFF VIEWER
   ============================================================================ */

.diff-viewer {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.diff-row {
    padding: 12px;
    background: var(--background);
    border-radius: var(--radius);
}

.diff-field {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 8px;
    display: block;
}

.diff-values {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.diff-before,
.diff-after {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    padding: 8px 12px;
    border-radius: 6px;
}

.diff-before {
    background: var(--danger-pastel);
    color: var(--danger);
    text-decoration: line-through;
}

.diff-after {
    background: var(--success-pastel);
    color: var(--success);
}

.diff-no-changes {
    text-align: center;
    color: var(--muted);
    padding: 20px;
}

/* ============================================================================
   OFFLINE SYNC INDICATOR
   ============================================================================ */

.offline-sync-indicator {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    padding: 12px 16px;
    background: var(--warning-pastel);
    border-radius: var(--radius);
    border: 1px solid var(--warning);
}

.offline-sync-info {
    display: flex;
    align-items: center;
    gap: 10px;
    color: var(--warning);
    font-size: 14px;
    font-weight: 500;
}

.offline-sync-info .spinning {
    animation: spin 1s linear infinite;
}

.offline-sync-actions {
    display: flex;
    gap: 8px;
}

/* ============================================================================
   ERROR BOUNDARY
   ============================================================================ */

.error-boundary {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--background);
    padding: 20px;
}

.error-boundary-content {
    text-align: center;
    max-width: 500px;
}

.error-boundary-icon {
    width: 120px;
    height: 120px;
    background: var(--danger-pastel);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 32px;
    color: var(--danger);
}

.error-boundary-content h2 {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 12px;
}

.error-boundary-content p {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 24px;
}

.error-boundary-content details {
    text-align: left;
    margin-bottom: 24px;
}

.error-boundary-content summary {
    cursor: pointer;
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 8px;
}

.error-boundary-content pre {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px;
    font-size: 11px;
    overflow-x: auto;
    white-space: pre-wrap;
    word-break: break-word;
}

.error-boundary-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
}

/* ============================================================================
   VIRTUALIZED LIST/TABLE
   ============================================================================ */

.virtualized-list,
.virtualized-table-container {
    will-change: transform;
}

.virtualized-table-container table {
    table-layout: fixed;
}

/* ============================================================================
   ANIMATIONS UTILITAIRES
   ============================================================================ */

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes fadeInUp {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes fadeInDown {
    from { 
        opacity: 0; 
        transform: translateY(-20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

@keyframes scaleIn {
    from { 
        opacity: 0; 
        transform: scale(0.9); 
    }
    to { 
        opacity: 1; 
        transform: scale(1); 
    }
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* ============================================================================
   RESPONSIVE
   ============================================================================ */

@media (max-width: 768px) {
    .pagination-container {
        flex-direction: column;
        align-items: stretch;
    }
    
    .pagination {
        justify-content: center;
    }
    
    .export-columns-list {
        grid-template-columns: 1fr;
    }
    
    .export-format-buttons {
        flex-direction: column;
    }
    
    .session-warning-modal {
        padding: 24px;
        margin: 20px;
    }
    
    .quick-actions.bottom-right,
    .quick-actions.bottom-left {
        bottom: 16px;
    }
    
    .quick-actions.bottom-right {
        right: 16px;
    }
    
    .quick-actions.bottom-left {
        left: 16px;
    }
}


/* ============================================================================
   STOCKAPP v5.2 - STYLES MOBILE
   ============================================================================ */

/**
 * ============================================================================
 * STOCKAPP v5.2 - STYLES MOBILES
 * ============================================================================
 * Styles pour les composants mobiles et interactions tactiles
 * ============================================================================
 */

/* ============================================================================
   SWIPEABLE ROW
   ============================================================================ */

.swipeable-row-container {
    position: relative;
    overflow: hidden;
    touch-action: pan-y pinch-zoom;
}

.swipeable-row-content {
    background: var(--card);
    position: relative;
    z-index: 1;
}

.swipe-actions {
    position: absolute;
    top: 0;
    bottom: 0;
    display: flex;
}

.swipe-actions-left {
    left: 0;
}

.swipe-actions-right {
    right: 0;
}

.swipe-action {
    width: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    border: none;
    cursor: pointer;
    color: white;
    font-size: 11px;
    font-weight: 600;
    transition: opacity 0.2s;
}

.swipe-action:active {
    opacity: 0.8;
}

.swipe-action-primary {
    background: var(--primary);
}

.swipe-action-success {
    background: var(--success);
}

.swipe-action-warning {
    background: var(--warning);
}

.swipe-action-danger {
    background: var(--danger);
}

.swipe-action-info {
    background: var(--info);
}

/* ============================================================================
   PULL TO REFRESH
   ============================================================================ */

.pull-to-refresh-container {
    overflow: auto;
    -webkit-overflow-scrolling: touch;
}

.pull-to-refresh-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--background);
    overflow: hidden;
}

.pull-to-refresh-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
}

.pull-to-refresh-icon {
    color: var(--primary);
    transition: transform 0.1s linear;
}

.pull-to-refresh-icon.spinning {
    animation: spin 1s linear infinite;
}

.pull-to-refresh-text {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 500;
}

/* ============================================================================
   BOTTOM SHEET
   ============================================================================ */

.bottom-sheet-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    animation: fadeIn 0.3s ease;
}

.bottom-sheet {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--card);
    border-radius: 20px 20px 0 0;
    box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    animation: slideUp 0.3s ease;
    max-height: 95vh;
}

@keyframes slideUp {
    from {
        transform: translateY(100%);
    }
    to {
        transform: translateY(0);
    }
}

.bottom-sheet-handle {
    padding: 12px;
    display: flex;
    justify-content: center;
    cursor: grab;
    touch-action: none;
}

.bottom-sheet-handle:active {
    cursor: grabbing;
}

.bottom-sheet-handle-bar {
    width: 36px;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
}

.bottom-sheet-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px 16px;
    border-bottom: 1px solid var(--border);
}

.bottom-sheet-header h3 {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    margin: 0;
}

.bottom-sheet-close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--background);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    transition: var(--transition-fast);
}

.bottom-sheet-close:hover {
    background: var(--border);
    color: var(--text);
}

.bottom-sheet-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    -webkit-overflow-scrolling: touch;
}

/* ============================================================================
   LONG PRESSABLE
   ============================================================================ */

.long-pressable {
    user-select: none;
    -webkit-user-select: none;
    -webkit-touch-callout: none;
    cursor: pointer;
}

.long-pressable:active {
    opacity: 0.9;
}

/* ============================================================================
   MOBILE CONTEXT MENU
   ============================================================================ */

.mobile-context-menu {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-xl);
    min-width: 180px;
    overflow: hidden;
    animation: scaleIn 0.15s ease;
    transform-origin: top left;
}

.context-menu-item {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 15px;
    color: var(--text);
    text-align: left;
    transition: var(--transition-fast);
}

.context-menu-item:not(:last-child) {
    border-bottom: 1px solid var(--border);
}

.context-menu-item:hover,
.context-menu-item:active {
    background: var(--hover);
}

.context-menu-item.danger {
    color: var(--danger);
}

.context-menu-item:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.context-menu-item svg {
    color: var(--muted);
}

.context-menu-item.danger svg {
    color: var(--danger);
}

/* ============================================================================
   FLOATING LABEL INPUT
   ============================================================================ */

.floating-input {
    position: relative;
    margin-bottom: 24px;
}

.floating-input input {
    width: 100%;
    padding: 20px 0 8px;
    border: none;
    border-bottom: 2px solid var(--border);
    background: transparent;
    font-size: 16px;
    color: var(--text);
    transition: border-color 0.2s;
}

.floating-input input:focus {
    outline: none;
}

.floating-input label {
    position: absolute;
    left: 0;
    top: 20px;
    font-size: 16px;
    color: var(--muted);
    pointer-events: none;
    transition: all 0.2s ease;
    transform-origin: left top;
}

.floating-input.focused label,
.floating-input.has-value label {
    transform: translateY(-16px) scale(0.75);
    color: var(--primary);
}

.floating-input.has-value:not(.focused) label {
    color: var(--text-secondary);
}

.floating-input-line {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 0;
    height: 2px;
    background: var(--primary);
    transition: all 0.2s ease;
    transform: translateX(-50%);
}

.floating-input.focused .floating-input-line {
    width: 100%;
}

.floating-input.has-error input {
    border-color: var(--danger);
}

.floating-input.has-error label {
    color: var(--danger);
}

.floating-input.has-error .floating-input-line {
    background: var(--danger);
}

.floating-input-error {
    position: absolute;
    bottom: -20px;
    left: 0;
    font-size: 12px;
    color: var(--danger);
}

.floating-input.disabled {
    opacity: 0.6;
    pointer-events: none;
}

.floating-input .required {
    color: var(--danger);
}

/* ============================================================================
   CHIP INPUT
   ============================================================================ */

.chip-input-container {
    position: relative;
}

.chip-input {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 10px 12px;
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    min-height: 48px;
    cursor: text;
    transition: border-color 0.2s;
}

.chip-input:focus-within {
    border-color: var(--primary);
}

.chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: var(--primary-pastel);
    color: var(--primary);
    border-radius: 100px;
    font-size: 13px;
    font-weight: 500;
    animation: scaleIn 0.2s ease;
}

.chip-remove {
    width: 18px;
    height: 18px;
    border: none;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    color: var(--primary);
    transition: var(--transition-fast);
}

.chip-remove:hover {
    background: rgba(0, 0, 0, 0.2);
}

.chip-input input {
    flex: 1;
    min-width: 100px;
    border: none;
    background: transparent;
    font-size: 14px;
    color: var(--text);
    outline: none;
}

.chip-input input::placeholder {
    color: var(--muted);
}

.chip-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    margin-top: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 100;
}

.chip-suggestion {
    width: 100%;
    padding: 12px 16px;
    border: none;
    background: transparent;
    text-align: left;
    font-size: 14px;
    color: var(--text);
    cursor: pointer;
    transition: var(--transition-fast);
}

.chip-suggestion:hover {
    background: var(--hover);
}

/* ============================================================================
   SEGMENTED CONTROL
   ============================================================================ */

.segmented-control {
    display: inline-flex;
    background: var(--background);
    border-radius: var(--radius);
    padding: 4px;
    position: relative;
}

.segmented-control.full-width {
    display: flex;
    width: 100%;
}

.segmented-indicator {
    position: absolute;
    top: 4px;
    bottom: 4px;
    left: 4px;
    background: var(--card);
    border-radius: 8px;
    box-shadow: var(--shadow-sm);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.segmented-option {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 16px;
    border: none;
    background: transparent;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    position: relative;
    z-index: 1;
    transition: color 0.2s;
}

.segmented-option.active {
    color: var(--text);
}

.segmented-option:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.segmented-sm .segmented-option {
    padding: 6px 12px;
    font-size: 13px;
}

.segmented-lg .segmented-option {
    padding: 14px 20px;
    font-size: 15px;
}

/* ============================================================================
   STEPPER
   ============================================================================ */

.stepper {
    display: inline-flex;
    align-items: center;
    background: var(--background);
    border-radius: var(--radius);
    overflow: hidden;
}

.stepper.disabled {
    opacity: 0.5;
    pointer-events: none;
}

.stepper-btn {
    width: 44px;
    height: 44px;
    border: none;
    background: transparent;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--primary);
    transition: var(--transition-fast);
}

.stepper-btn:hover:not(:disabled) {
    background: var(--primary-pastel);
}

.stepper-btn:active:not(:disabled) {
    background: var(--primary);
    color: white;
}

.stepper-btn:disabled {
    color: var(--muted);
    cursor: not-allowed;
}

.stepper-value {
    min-width: 48px;
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
}

.stepper-sm .stepper-btn {
    width: 36px;
    height: 36px;
}

.stepper-sm .stepper-value {
    min-width: 40px;
    font-size: 14px;
}

.stepper-lg .stepper-btn {
    width: 52px;
    height: 52px;
}

.stepper-lg .stepper-value {
    min-width: 56px;
    font-size: 18px;
}

/* ============================================================================
   ACTION SHEET
   ============================================================================ */

.action-sheet-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 10px;
    animation: fadeIn 0.2s ease;
}

.action-sheet {
    width: 100%;
    max-width: 500px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.action-sheet-content {
    background: var(--card);
    border-radius: 14px;
    overflow: hidden;
}

.action-sheet-header {
    padding: 16px 20px;
    text-align: center;
    border-bottom: 1px solid var(--border);
}

.action-sheet-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.action-sheet-message {
    font-size: 13px;
    color: var(--muted);
    margin-top: 4px;
}

.action-sheet-actions {
    display: flex;
    flex-direction: column;
}

.action-sheet-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 18px 20px;
    border: none;
    background: transparent;
    font-size: 18px;
    color: var(--primary);
    cursor: pointer;
    transition: var(--transition-fast);
}

.action-sheet-btn:not(:last-child) {
    border-bottom: 1px solid var(--border);
}

.action-sheet-btn:active {
    background: var(--hover);
}

.action-sheet-btn.destructive {
    color: var(--danger);
}

.action-sheet-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.action-sheet-cancel {
    width: 100%;
    padding: 18px 20px;
    border: none;
    background: var(--card);
    border-radius: 14px;
    font-size: 18px;
    font-weight: 600;
    color: var(--primary);
    cursor: pointer;
    transition: var(--transition-fast);
}

.action-sheet-cancel:active {
    background: var(--hover);
}

/* ============================================================================
   TOUCH OPTIMIZATIONS
   ============================================================================ */

/* Désactiver le highlight sur mobile */
* {
    -webkit-tap-highlight-color: transparent;
}

/* Améliorer le scroll sur iOS */
.scroll-container {
    -webkit-overflow-scrolling: touch;
    overflow-y: auto;
}

/* Safe areas pour les iPhones avec notch */
.safe-area-top {
    padding-top: env(safe-area-inset-top, 0);
}

.safe-area-bottom {
    padding-bottom: env(safe-area-inset-bottom, 0);
}

/* Optimiser les inputs sur mobile */
@media (max-width: 768px) {
    input, textarea, select {
        font-size: 16px !important; /* Empêche le zoom automatique sur iOS */
    }
}

/* ============================================================================
   RESPONSIVE HELPERS
   ============================================================================ */

/* Visible seulement sur mobile */
.mobile-only {
    display: none;
}

@media (max-width: 768px) {
    .mobile-only {
        display: block;
    }
    
    .desktop-only {
        display: none !important;
    }
}

/* Visible seulement sur desktop */
.desktop-only {
    display: block;
}

/* Touch device detection */
@media (hover: none) and (pointer: coarse) {
    /* Styles spécifiques pour les appareils tactiles */
    .hover-effect:hover {
        /* Désactiver les effets hover sur tactile */
        background: transparent;
        transform: none;
    }
    
    /* Augmenter les zones de clic */
    .touch-target {
        min-height: 44px;
        min-width: 44px;
    }
}

/* ============================================================================
   DARK MODE MOBILE
   ============================================================================ */

@media (prefers-color-scheme: dark) {
    .auto-dark-mode {
        --text: #F1F5F9;
        --text-secondary: #CBD5E1;
        --muted: #64748B;
        --border: #334155;
        --background: #0F172A;
        --card: #1E293B;
        --hover: #334155;
    }
}

/* ============================================================================
   ACCESSIBILITY
   ============================================================================ */

/* Focus visible pour navigation clavier */
:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Réduire les animations pour les utilisateurs qui le préfèrent */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Mode contraste élevé */
@media (prefers-contrast: high) {
    .chip {
        border: 2px solid currentColor;
    }
    
    .segmented-option {
        border: 1px solid var(--border);
    }
    
    .action-sheet-btn {
        border: 1px solid var(--border);
    }
}

/* ==========================================================================
   v5.5 - STYLES POUR NOUVELLES FONCTIONNALITÉS
   ========================================================================== */

/* Véhicules Layout */
.vehicles-layout {
    display: grid;
    grid-template-columns: 350px 1fr;
    gap: 20px;
    min-height: calc(100vh - 200px);
}

.vehicles-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.vehicle-card {
    padding: 16px;
    border-radius: 12px;
    background: var(--card);
    border: 2px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
}

.vehicle-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.vehicle-card.selected {
    border-color: var(--primary);
    background: var(--primary-pastel);
}

.vehicle-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
}

.vehicle-icon {
    font-size: 28px;
}

.vehicle-details {
    flex: 1;
}

.vehicle-name {
    font-weight: 600;
    font-size: 15px;
}

.vehicle-plate {
    font-size: 12px;
    color: var(--muted);
    font-family: monospace;
}

.vehicle-meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.vehicle-stock-detail {
    padding: 20px;
}

/* Theme Customizer Modal */
.theme-modal .modal-body {
    display: grid;
    grid-template-columns: 250px 1fr;
    gap: 24px;
    max-height: 70vh;
}

.theme-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 12px;
    margin-top: 12px;
}

.theme-card {
    padding: 12px;
    border-radius: 12px;
    border: 2px solid var(--border);
    cursor: pointer;
    transition: all 0.2s;
}

.theme-card:hover {
    border-color: var(--primary);
}

.theme-card.active {
    border-color: var(--primary);
    background: var(--primary-pastel);
}

.theme-preview {
    height: 60px;
    border-radius: 8px;
    border: 1px solid;
    margin-bottom: 8px;
    overflow: hidden;
}

.theme-preview-header {
    height: 12px;
}

.theme-preview-card {
    margin: 4px;
    padding: 4px;
    border-radius: 4px;
    border: 1px solid;
}

.theme-preview-text {
    height: 4px;
    width: 60%;
    border-radius: 2px;
    margin-bottom: 3px;
}

.theme-preview-text-secondary {
    height: 4px;
    width: 40%;
    border-radius: 2px;
    opacity: 0.5;
}

.theme-info {
    display: flex;
    align-items: center;
    gap: 6px;
}

.theme-icon {
    font-size: 16px;
}

.theme-name {
    font-size: 12px;
    font-weight: 500;
}

.theme-active-badge {
    margin-left: auto;
    color: var(--success);
    font-weight: 600;
}

.color-picker-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.color-picker-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.color-picker-item label {
    font-size: 12px;
    flex: 1;
}

.color-picker-item input[type="color"] {
    width: 32px;
    height: 32px;
    padding: 0;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}

/* NFC Inventory */
.nfc-scanner {
    text-align: center;
    padding: 40px;
}

.nfc-icon {
    font-size: 64px;
    margin-bottom: 20px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.05); }
}

.nfc-status {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 12px;
}

.nfc-instruction {
    color: var(--muted);
    margin-bottom: 24px;
}

.scanned-items-list {
    max-height: 300px;
    overflow-y: auto;
}

.scanned-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--background);
    border-radius: 8px;
    margin-bottom: 8px;
}

.scanned-item-icon {
    font-size: 24px;
}

.scanned-item-info {
    flex: 1;
}

.scanned-item-name {
    font-weight: 500;
}

.scanned-item-ref {
    font-size: 12px;
    color: var(--muted);
}

/* Video Call Panel */
.video-call-panel {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 320px;
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    overflow: hidden;
    z-index: 1000;
}

.video-call-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: var(--primary);
    color: white;
}

.video-container {
    position: relative;
    background: #000;
    aspect-ratio: 4/3;
}

.remote-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.local-video {
    position: absolute;
    bottom: 12px;
    right: 12px;
    width: 80px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
    border: 2px solid white;
}

.video-controls {
    display: flex;
    justify-content: center;
    gap: 12px;
    padding: 16px;
    background: var(--background);
}

.video-control-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    transition: all 0.2s;
}

.video-control-btn.muted,
.video-control-btn.video-off {
    background: var(--danger);
    color: white;
}

.video-control-btn.end-call {
    background: var(--danger);
    color: white;
}

/* Offline Indicator */
.offline-indicator {
    position: fixed;
    bottom: 20px;
    left: 20px;
    padding: 12px 20px;
    background: var(--warning);
    color: #000;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { transform: translateY(100px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

.offline-indicator.online {
    background: var(--success);
    color: white;
}

/* Photo Annotator */
.photo-annotator {
    position: relative;
    background: #000;
    border-radius: 12px;
    overflow: hidden;
}

.annotator-canvas {
    display: block;
    max-width: 100%;
    cursor: crosshair;
}

.annotator-toolbar {
    display: flex;
    gap: 8px;
    padding: 12px;
    background: var(--card);
    border-top: 1px solid var(--border);
}

.annotator-tool {
    padding: 8px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--background);
    cursor: pointer;
    transition: all 0.2s;
}

.annotator-tool.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* Comparison Widget */
.comparison-widget {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
}

.comparison-period {
    padding: 16px;
    border-radius: 12px;
    background: var(--background);
}

.comparison-period-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
}

.comparison-stat {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
}

.comparison-change {
    font-weight: 600;
}

.comparison-change.positive { color: var(--success); }
.comparison-change.negative { color: var(--danger); }

/* Responsive */
@media (max-width: 768px) {
    .vehicles-layout {
        grid-template-columns: 1fr;
    }
    
    .theme-modal .modal-body {
        grid-template-columns: 1fr;
    }
    
    .video-call-panel {
        width: calc(100% - 40px);
        bottom: 10px;
        right: 20px;
        left: 20px;
    }
}

/* ==========================================
   v5.8 - STYLES HMI AVANCÉS
   ========================================== */

/* Glassmorphism */
.glass { background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.3); }
.glass-card { background: rgba(255,255,255,0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 8px 32px rgba(0,0,0,0.08); }

/* Animations */
@keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
@keyframes scaleIn { from { opacity:0; transform:scale(0.9); } to { opacity:1; transform:scale(1); } }
@keyframes slideInRight { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
@keyframes slideOutRight { from { transform:translateX(0); opacity:1; } to { transform:translateX(100%); opacity:0; } }
@keyframes shimmer { 0% { background-position:-200% 0; } 100% { background-position:200% 0; } }
@keyframes countUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.animate-fade-in-up { animation: fadeInUp 0.4s ease-out; }
.animate-scale-in { animation: scaleIn 0.3s ease-out; }
.animate-slide-in-right { animation: slideInRight 0.3s ease-out; }

/* Skeleton Loader */
.skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius); }
.skeleton-text { height: 16px; margin-bottom: 8px; }
.skeleton-card { height: 120px; }

/* Hover effects */
.hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
.hover-lift:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }

/* Toasts v5.8 */
.toast-v58-container { position:fixed; z-index:10000; display:flex; flex-direction:column; gap:12px; max-width:420px; width:calc(100% - 32px); }
.toast-v58-container.top-right { top:20px; right:20px; }
.toast-v58-container.bottom-right { bottom:20px; right:20px; }
.toast-v58 { display:flex; align-items:flex-start; gap:12px; padding:16px; background:var(--card); border-radius:var(--radius-lg); box-shadow:0 10px 40px rgba(0,0,0,0.15); animation:slideInRight 0.3s ease-out; border-left:4px solid var(--primary); position:relative; }
.toast-v58.exiting { animation:slideOutRight 0.3s ease-out forwards; }
.toast-v58.success { border-left-color:var(--success); }
.toast-v58.error { border-left-color:var(--danger); }
.toast-v58.warning { border-left-color:var(--warning); }
.toast-v58-icon { width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:14px; flex-shrink:0; }
.toast-v58.success .toast-v58-icon { background:var(--success-pastel); color:var(--success); }
.toast-v58.error .toast-v58-icon { background:var(--danger-pastel); color:var(--danger); }
.toast-v58.warning .toast-v58-icon { background:var(--warning-pastel); color:var(--warning); }
.toast-v58-content { flex:1; }
.toast-v58-title { font-weight:600; font-size:14px; margin-bottom:4px; }
.toast-v58-message { font-size:13px; color:var(--text-secondary); }
.toast-v58-close { position:absolute; top:8px; right:8px; width:20px; height:20px; border:none; background:transparent; color:var(--muted); cursor:pointer; border-radius:4px; }
.toast-v58-progress { position:absolute; bottom:0; left:0; height:3px; background:var(--primary); border-radius:0 0 0 var(--radius-lg); }

/* Quick Actions Menu */
.quick-actions-menu { position:fixed; background:var(--card); border-radius:var(--radius-lg); box-shadow:0 10px 40px rgba(0,0,0,0.2); padding:8px; min-width:200px; z-index:10000; animation:scaleIn 0.15s ease-out; }
.quick-actions-item { display:flex; align-items:center; gap:12px; padding:10px 14px; border-radius:var(--radius); cursor:pointer; font-size:14px; transition:background 0.15s; }
.quick-actions-item:hover { background:var(--background); }
.quick-actions-item.danger { color:var(--danger); }
.quick-actions-divider { height:1px; background:var(--border); margin:6px 0; }

/* Bulk Actions Bar */
.bulk-actions-bar { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:var(--text); color:white; padding:12px 24px; border-radius:var(--radius-xl); display:flex; align-items:center; gap:16px; box-shadow:0 10px 40px rgba(0,0,0,0.3); animation:fadeInUp 0.3s ease-out; z-index:1000; }
.bulk-actions-count { font-weight:600; padding-right:16px; border-right:1px solid rgba(255,255,255,0.2); }
.bulk-actions-btn { display:flex; align-items:center; gap:6px; padding:8px 14px; background:rgba(255,255,255,0.1); border:none; border-radius:var(--radius); color:white; font-size:13px; cursor:pointer; transition:background 0.15s; }
.bulk-actions-btn:hover { background:rgba(255,255,255,0.2); }
.bulk-actions-btn.danger { background:var(--danger); }

/* View Switcher */
.view-switcher { display:flex; background:var(--background); border-radius:var(--radius); padding:4px; }
.view-switcher-btn { padding:8px 14px; border:none; background:transparent; border-radius:8px; cursor:pointer; font-size:13px; color:var(--muted); transition:all 0.15s; display:flex; align-items:center; gap:6px; }
.view-switcher-btn:hover { color:var(--text); }
.view-switcher-btn.active { background:var(--card); color:var(--primary); box-shadow:var(--shadow-sm); }

/* Timeline View */
.timeline-view { position:relative; padding-left:32px; }
.timeline-view::before { content:''; position:absolute; left:11px; top:0; bottom:0; width:2px; background:var(--border); }
.timeline-item { position:relative; padding-bottom:24px; animation:fadeInUp 0.3s ease-out; }
.timeline-item::before { content:''; position:absolute; left:-27px; top:6px; width:12px; height:12px; background:var(--card); border:3px solid var(--primary); border-radius:50%; z-index:1; }
.timeline-item.completed::before { background:var(--success); border-color:var(--success); }

/* Grid View */
.grid-view { display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:20px; }
.grid-card { background:var(--card); border-radius:var(--radius-lg); padding:20px; box-shadow:var(--shadow); transition:transform 0.2s, box-shadow 0.2s; cursor:pointer; }
.grid-card:hover { transform:translateY(-4px); box-shadow:var(--shadow-lg); }

/* KPI Animated */
.kpi-animated { position:relative; overflow:hidden; }
.kpi-animated-value { font-size:32px; font-weight:800; background:linear-gradient(135deg, var(--primary), var(--purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; animation:countUp 0.6s ease-out; }
.kpi-trend { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:20px; font-size:12px; font-weight:600; }
.kpi-trend.up { background:var(--success-pastel); color:var(--success); }
.kpi-trend.down { background:var(--danger-pastel); color:var(--danger); }

/* PDF Template Selector */
.pdf-template-selector { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:16px; margin-bottom:20px; }
.pdf-template-card { border:2px solid var(--border); border-radius:var(--radius-lg); padding:20px; cursor:pointer; transition:all 0.2s; text-align:center; }
.pdf-template-card:hover { border-color:var(--primary-light); transform:translateY(-2px); }
.pdf-template-card.selected { border-color:var(--primary); background:var(--primary-pastel); }
.pdf-template-icon { font-size:32px; margin-bottom:12px; }
.pdf-template-name { font-weight:600; margin-bottom:4px; }
.pdf-template-desc { font-size:12px; color:var(--muted); }

/* Thèmes couleurs - avec spécificité suffisante pour override :root */
:root[data-theme="blue"], html[data-theme="blue"] { --primary:#3B82F6 !important; --primary-light:#93C5FD !important; --primary-dark:#1D4ED8 !important; --primary-pastel:#DBEAFE !important; }
:root[data-theme="green"], html[data-theme="green"] { --primary:#10B981 !important; --primary-light:#6EE7B7 !important; --primary-dark:#059669 !important; --primary-pastel:#D1FAE5 !important; }
:root[data-theme="purple"], html[data-theme="purple"] { --primary:#8B5CF6 !important; --primary-light:#C4B5FD !important; --primary-dark:#7C3AED !important; --primary-pastel:#EDE9FE !important; }
:root[data-theme="orange"], html[data-theme="orange"] { --primary:#F97316 !important; --primary-light:#FDBA74 !important; --primary-dark:#EA580C !important; --primary-pastel:#FFF7ED !important; }
:root[data-theme="teal"], html[data-theme="teal"] { --primary:#14B8A6 !important; --primary-light:#5EEAD4 !important; --primary-dark:#0D9488 !important; --primary-pastel:#CCFBF1 !important; }

/* Mode sombre */
:root[data-theme="dark"], html[data-theme="dark"], .dark-mode { --text:#F1F5F9 !important; --text-secondary:#CBD5E1 !important; --muted:#64748B !important; --border:#334155 !important; --background:#0F172A !important; --card:#1E293B !important; }
:root[data-theme="dark"] .skeleton, html[data-theme="dark"] .skeleton, .dark-mode .skeleton { background:linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%) !important; }

/* Notification Center */
.notification-center { position:fixed; top:0; right:0; width:400px; max-width:100vw; height:100vh; background:var(--card); box-shadow:-10px 0 40px rgba(0,0,0,0.15); z-index:1000; display:flex; flex-direction:column; animation:slideInRight 0.3s ease-out; }
.notification-center-header { padding:20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.notification-center-title { font-size:18px; font-weight:700; }
.notification-center-tabs { display:flex; gap:4px; padding:0 20px; border-bottom:1px solid var(--border); }
.notification-center-tab { padding:12px 16px; font-size:13px; font-weight:600; color:var(--muted); border:none; background:none; cursor:pointer; border-bottom:2px solid transparent; transition:all 0.2s; }
.notification-center-tab:hover { color:var(--text); }
.notification-center-tab.active { color:var(--primary); border-bottom-color:var(--primary); }
.notification-center-list { flex:1; overflow-y:auto; padding:12px; }
.notification-center-item { display:flex; gap:12px; padding:14px; border-radius:var(--radius); cursor:pointer; transition:background 0.15s; margin-bottom:8px; }
.notification-center-item:hover { background:var(--background); }
.notification-center-item.unread { background:var(--primary-pastel); }

/* Bottom Navigation Mobile */
.bottom-nav { position:fixed; bottom:0; left:0; right:0; background:var(--card); border-top:1px solid var(--border); display:none; justify-content:space-around; padding:8px 0; padding-bottom:max(8px, env(safe-area-inset-bottom)); z-index:100; }
@media (max-width:768px) { .bottom-nav { display:flex; } .sidebar { display:none !important; } .main-content { margin-left:0 !important; padding-bottom:70px; } }
.bottom-nav-item { display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px 16px; border:none; background:none; color:var(--muted); font-size:11px; cursor:pointer; transition:color 0.15s; }
.bottom-nav-item.active { color:var(--primary); }
.bottom-nav-icon { font-size:20px; }

/* FAB */
.fab { position:fixed; bottom:80px; right:20px; width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg, var(--primary), var(--primary-dark)); color:white; border:none; box-shadow:0 4px 20px rgba(225,29,72,0.4); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:24px; z-index:99; transition:transform 0.2s, box-shadow 0.2s; }
.fab:hover { transform:scale(1.1); box-shadow:0 6px 30px rgba(225,29,72,0.5); }
.fab:active { transform:scale(0.95); }

/* Sidebar Favorites */
.sidebar-favorites { padding:12px; border-bottom:1px solid var(--border); }
.sidebar-favorites-title { font-size:11px; font-weight:700; text-transform:uppercase; color:var(--muted); margin-bottom:8px; padding:0 8px; }
.sidebar-favorite-item { display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:var(--radius); cursor:pointer; font-size:13px; color:var(--text-secondary); transition:all 0.15s; }
.sidebar-favorite-item:hover { background:var(--background); color:var(--text); }

/* Tablet Layout */
@media (min-width:768px) and (max-width:1024px) {
    .tablet-2cols { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .tablet-full { grid-column:span 2; }
}

/* Chat WhatsApp Style */
.chat-whatsapp { position:fixed; right:20px; bottom:20px; width:420px; height:600px; background:var(--card); border-radius:16px; box-shadow:0 10px 50px rgba(0,0,0,0.25); display:flex; flex-direction:column; z-index:9998; overflow:hidden; }
.chat-whatsapp-header { padding:12px 16px; background:linear-gradient(135deg, #25D366, #128C7E); color:white; display:flex; align-items:center; gap:12px; }
.chat-whatsapp-messages { flex:1; overflow-y:auto; padding:12px; background:#E5DDD5; }
.chat-whatsapp-input { padding:8px; background:#F0F0F0; display:flex; align-items:center; gap:8px; }
.chat-message { margin-bottom:8px; display:flex; }
.chat-message.mine { justify-content:flex-end; }
.chat-message.other { justify-content:flex-start; }
.chat-bubble { max-width:75%; padding:8px 12px; border-radius:12px; box-shadow:0 1px 2px rgba(0,0,0,0.1); }
.chat-bubble.mine { background:#DCF8C6; border-radius:12px 12px 0 12px; }
.chat-bubble.other { background:white; border-radius:12px 12px 12px 0; }
.chat-status { font-size:10px; color:#667781; display:flex; align-items:center; gap:4px; justify-content:flex-end; margin-top:4px; }
.chat-status.read { color:#53BDEB; }

/* Split View */
.split-view-container { display:flex; height:100%; width:100%; }
.split-view-container.row { flex-direction:row; }
.split-view-container.column { flex-direction:column; }
.split-view-container.grid { flex-wrap:wrap; }
.split-view-panel { overflow:auto; position:relative; }
.split-view-panel-header { position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--border); padding:8px 12px; display:flex; align-items:center; gap:8px; }
.split-view-resize-handle { position:absolute; background:transparent; z-index:20; transition:background 0.15s; }
.split-view-resize-handle:hover { background:var(--primary); }
.split-view-resize-handle.horizontal { right:-3px; top:0; bottom:0; width:6px; cursor:col-resize; }
.split-view-resize-handle.vertical { bottom:-3px; left:0; right:0; height:6px; cursor:row-resize; }

/* Layout Control Button */
.layout-control-menu { position:absolute; top:100%; right:0; margin-top:8px; background:var(--card); border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.2); padding:8px; z-index:1000; min-width:180px; }
.layout-control-option { display:flex; align-items:center; gap:10px; width:100%; padding:10px 12px; border:none; background:transparent; border-radius:8px; cursor:pointer; text-align:left; font-size:14px; color:var(--text); transition:background 0.15s; }
.layout-control-option:hover { background:var(--background); }
.layout-control-option.active { background:var(--primary-pastel); color:var(--primary); }


</style>
</head>
<body>
    <div id="loading"><div class="spinner"></div></div>
    <div id="root"></div>
    <script>
const { createElement: h, useState, useEffect, useCallback, useMemo, useRef, Fragment, createContext, useContext } = React;
const SUPABASE_URL = 'https://fgyxinizcaghcjuwrkyp.supabase.co';
const SUPABASE_KEY = 'sb_publishable_0bPSrcO4VWXBRgCqz_hbIg_o-rszG0B';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Client Supabase pour les tables progilift_* (schéma public)
// Les tables progilift_* sont dans le schéma public, pas besoin de client séparé
// On utilise le client db standard avec les noms de tables préfixés progilift_

// Fonction pour charger tous les enregistrements avec pagination (contourne la limite de 1000)
const fetchAllRows = async (client, table, selectColumns, orderColumn = null) => {
    const PAGE_SIZE = 1000;
    let allData = [];
    let from = 0;
    let hasMore = true;
    
    while (hasMore) {
        let query = client.from(table).select(selectColumns).range(from, from + PAGE_SIZE - 1);
        if (orderColumn) {
            query = query.order(orderColumn);
        }
        
        const { data, error } = await query;
        
        if (error) {
            console.error(`Erreur fetchAllRows ${table}:`, error);
            throw error;
        }
        
        if (data && data.length > 0) {
            allData = allData.concat(data);
            from += PAGE_SIZE;
            hasMore = data.length === PAGE_SIZE;
        } else {
            hasMore = false;
        }
    }
    
    console.log(`📊 fetchAllRows ${table}: ${allData.length} enregistrements`);
    return allData;
};

// Couleurs de l'application - mis à jour dynamiquement selon le thème
const COLORS_LIGHT = {
    primary: '#E11D48', primaryLight: '#FDA4AF', primaryDark: '#BE123C', primaryPastel: '#FFF1F2',
    secondary: '#F97316', secondaryPastel: '#FFF7ED',
    success: '#10B981', successPastel: '#D1FAE5',
    warning: '#F59E0B', warningPastel: '#FEF3C7',
    danger: '#EF4444', dangerPastel: '#FEE2E2',
    info: '#3B82F6', infoPastel: '#DBEAFE',
    purple: '#8B5CF6', purplePastel: '#EDE9FE',
    teal: '#14B8A6', tealPastel: '#CCFBF1',
    text: '#1E293B', textSecondary: '#475569', muted: '#94A3B8',
    border: '#E2E8F0', background: '#F8FAFC', card: '#FFFFFF'
};

const COLORS_DARK = {
    primary: '#F43F5E', primaryLight: '#FDA4AF', primaryDark: '#E11D48', primaryPastel: '#4C0519',
    secondary: '#FB923C', secondaryPastel: '#7C2D12',
    success: '#34D399', successPastel: '#064E3B',
    warning: '#FBBF24', warningPastel: '#78350F',
    danger: '#F87171', dangerPastel: '#7F1D1D',
    info: '#60A5FA', infoPastel: '#1E3A8A',
    purple: '#A78BFA', purplePastel: '#4C1D95',
    teal: '#2DD4BF', tealPastel: '#134E4A',
    text: '#F1F5F9', textSecondary: '#CBD5E1', muted: '#64748B',
    border: '#334155', background: '#0F172A', card: '#1E293B'
};

// COLORS est un objet mutable qui est mis à jour quand le thème change
let COLORS = { ...COLORS_LIGHT };

// Fonction pour mettre à jour COLORS selon le mode
const updateColors = (isDark) => {
    Object.assign(COLORS, isDark ? COLORS_DARK : COLORS_LIGHT);
};

// Écouter les changements de thème
window.addEventListener('theme-changed', (e) => {
    updateColors(e.detail.darkMode);
});

// Logo entreprise Auvergne Ascenseurs (base64 PNG)
const COMPANY_LOGO = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAZAAAADECAYAAACx13eZAAABAGlDQ1BpY2MAABiVY2BgPMEABCwGDAy5eSVFQe5OChGRUQrsDxgYgRAMEpOLCxhwA6Cqb9cgai/r4lGHC3CmpBYnA+kPQKxSBLQcaKQIkC2SDmFrgNhJELYNiF1eUlACZAeA2EUhQc5AdgqQrZGOxE5CYicXFIHU9wDZNrk5pckIdzPwpOaFBgNpDiCWYShmCGJwZ3AC+R+iJH8RA4PFVwYG5gkIsaSZDAzbWxkYJG4hxFQWMDDwtzAwbDuPEEOESUFiUSJYiAWImdLSGBg+LWdg4I1kYBC+wMDAFQ0LCBxuUwC7zZ0hHwjTGXIYUoEingx5DMkMekCWEYMBgyGDGQCm1j8/yRb+6wAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH6QwbEBcB0dXKBQAAgABJREFUeNrsvXWcHNeZNXzOvdUwIGa2jDHEEGNsi+XIJJnCzBvY0JtkN/Tut282m6VkQ5tscENOHHDMMltoTByzY8u2bIvBYg001L3n+6OquntGPTM9mpHkrOv411ZPV9Xlus99mHgZ4xfLzgaEnIw+C+gOEA+8a+b9h7pZKVKkSJECgDnUDegJv771bRA6AWk25D5Fb/6PLeaH/PLOGYe6aSlSpEiRAi9jAuLyq2GRG0fqc0YcSbhLYDvfsb3zbvx66axD3bwUKVKkeMXjZUlAfnb7qQi3vkBJ7yc5kwAAnwP56THN550inzvUTUyRIkWKVzxedgTk+tv/DYHJIDvqyNfC8yOQDCgAgKDDPXd/wXPX0F8uee2hbmqKFClSvKLxsiMgbWYxDJpGgP7zNJgoOgiASHgKoF9EmHc9nb0PVy2Ze6ibmyJFihSvWLysCMiv7ngddo5YAU//Dg+/QPAQCMXXCUJgFtSnjwtPP03ci0/+btGhbnaKFClSvCLxsiIgyGzHiN1nnAxT+ISojJgQD4IiqIiIeGiaI74g2uGnj91yqFudIkWKFK9IvGwIyC/vOgPeBS2e+izoD2ekOQcBUIq/oPIjxYs99e63zXqA37/vpEPd/BQpUqR4xYEDL2Lg+OXt58LkO+DLTe+iKX8fZF4AIroREQ+BUWMFiJFgS8BaCG8Q3B/HP/ZHLPhEcKi7kiJFihSvGLwsOBCTKQFh9miY8mcF5j0AQCAFkFXiAUTcBwCIoMxUIvMlw8yIrSeec6i7kSJFihSvKBxyAvLrJbNg1JoT7KcAHo8alXnCIO3LJhEiIQJgeIGBf1+gEq9ceuah7k6KFClSvGJwSAnIL+6YBdh2eLZdRPq3JoShanfVOyiBUCCZT4TInuUQ4uc/+/qh7FKKFClSvGJwSAmIsSV4l50i8e8BDY0cBoVGVDOM7xQMRE6Ggi9anxtppv7+UHYpRYoUKV4xOGQE5FdLTofxPiDDvyVxxoD1+bZ8vkz4fmxbwCvvTB0MU6RIkeJA45AQkJ/cOQeihzOaK/j3RQ4ejYmt6kMAaQHzCY1edg7h8K3Hjj0UXUuRIkWKVwwOCQGxgUMZLWO94eeEYJQX4eHjq41zImTNvRH9mQh2fNGZXaNHbEsDLqZIkSLFgcRBJyA/v+sslAslY1B8P+FniYnRbqPaj30hCZKAqKzzDJo/ELbNMD+/4/yD3b0UKVKkeMXgoBIQHSfQhMhn/ZkG/iMUDaXYMTDx9ei/KIskSEaOh6QV+THb8uC5DHbhpze+6WB2MUWKFCleMTioBOTX35qLIBw+DLKfEzgpqv4AOMOzPIHkl0zYOiZo2nYwu5giRYoUrxgcNAJy1YrXYsfOzfB27ztBfwEACKrxMh+IECtCxIUwSiFCzYPt/JAx7SZ1MEyRIkWKwcdBIyAK8xg1etJJZPAJGGZIgIzClUiJ1/nAuRFG0RcBeAOGH/XALAD46e0nH6yupkiRIsUrAgeFgPxqySxIvsWj9FnBHYGKxdVATHd7Q4WnGQeYLyFsHZfhiIPR1RQpUqR4xeCAE5Cr7joOzmbhTOEKoXy54AEotpxKFN+DWycBiIhjZWk2g/YPZ80oe9WSBQe6uylSpEjxisEBJyDO5mG0/Sgg/CzomyoXYsupyJdj8DmRJPQ76IyAj5TNxjkhduDXt73+QHc5RYoUKV4ROKAE5NdLz4F1Q3NC5v8A9gRVIlixNkD7AURUl6gxEr5E5cf7YPNBqDdFihQp/vfjgBGQ39x1EbzZCcfChRTfChqAPhIrVVAbun3wQcZppwR4upnelj4atrQFP7/79APV7RQpUqR4xeCAERBnXwJ96xSSfw9gKOARpYaqxYHnQhjlv42/6EO2kJnry8IfHkhNe1OkSJFiIDggBORXd86BKYy3kvmIhztTB8zaqlHEiamE0ZD/UlbZCZ3thzyXVooUKVL8VWPQd9Ff3XIZjCGQ6ZxNBO+v5KAVMFi+HgMBEcwAgo9nylOCq+688JC2JUWKFCn+mjHoBMRnNyNUcawzu78gUxrNLjUMnsPg/kIAxNIHS5k1rwvNFvzyjtS0N0WKFCn2B4NKQH591+vQVDqDhvb9Amd7ADrU0qsYERMU6UNENxLUF4HcZAS7D3XTUqRIkeKvEoNGQK5edgJg2lDK/elM0H2EoKnlMzjY3oL7AXb5Zs6mMh83pdbgyrtmHuqmpUiRIsVfHQaNgBTC4fBhMEzwfw/4SWISHjH672WB2EU9Usd4yBTe723hfNoifn77jEPduhQpUqT4q8KgEJArl54KlY4DjHm7R3ChZ0Q0oqAlsc7jZUJDIp0+k+aMAMMvIcxNsalRVooUKVL0C4OybQpZoOnxE2U6PiWWswnH0SXbx6GXYHVD7B9icCaM+1TAfObXd8051I1KkSJFir8aDJiA/PquGQhcplnAZz1xRJSiNhJeUYx9+F5+qEbgEgT3Hsc9F5Z8O/5w97xD3bQUKVKk+KvAgAjIr++4AC7YCtniFYQuj4RVjAkHoZcr9YjBmIyIfrinvhhYO62z1Haom5UiRYoUfxUYEAHx5iUwHHakFz4LqJkvFz1Hf0BCkYXY6YL5lFFr9ldLzz3UrUqRIkWKlz32m4D86vYFsOVpWQCfFNyrq+loI85DVEMRd9Xtg0a+x196uq9eHT19V+VBAnTvCdF5sUc7fnHn3AM99ilSpEjxV41gfx769e0XQKYTMsULCfsOHydvYrctvLv5LoVKNF7G9GYfrqX2tx6+dymjzn3V+qs/9fS9mjgEkDgURl+CyT5K07b6YE5EihQpUvy1od8aip/f8HbYphcB2Kkwxd+D/gxfs3v3VqASqiETeYQjdgyvMhYJL6D4iyqa7ip1UrLdm4gg+bhoKbpfrObMrWr0q5+aawJhPGSk6HcPAqL9nm173Tdc7iH/zvOuO9RzlCJFihQvS+wXBwIC8HakwNsB3AbRARDJkBGVCOMN3yHZmAEn6ySfDeGaJHoHJPfIC/CiHAUJcpEOXvHz8pA8AC96F9Ee73yUEdcRkAgvwJuImPhq2RWi4WPaU7lGeMANd3BDRXpB9KKHglJRTX/pkkAxRYoUKVJ0xX4REF8YQTZteRTNWx7lkDV6xwmHuhspUqRIkSJFihQpUqRIkSJFihQpUqRIkSJFihQpUqRIkSJFihQpUqRIkSJFihQpUqRIkSJFihQpUqRIkSJFihQpUqRIkSJFihQpUqRIkSJFihQpUqRIkSJFilcKDkrC2QsuvAwv7S6gKRtMBDgOPNi5CwkKNOIGUVuXL73u4FafIkWKFP8LcVAIyMzzLoG1JhOWw/+W5xUkXSMUpKdEUP3pXM0zljI/zncO/btSbq+WL7/mYHQ9RYoUKf7XYv/ygfQT3gveu6mAmUNieJJXCqiTpRDx36rNGFjNYFjvmd6eFxmnJhFAP7+c3zMW0Jb+9mH2nIUAkPOwR3gyC0AUSZlNoNuyYum1DZc1Z/4lANTsPQ/3oAUMKILSBsBsgy2B0EgvO0UVEk/S86XQhBsyocHy5df1q/3nzrwYkCxtdjoMWgXIQKTQCa/VAMLly6/f57kZc98EX0aWmeIUyh9H8kiS4wDkRJQAvQRgNaSnLPFiKUShJR/i9ltv7nks5y5EmU2wvjxBxLgonYsIb4qiVgMorVx6Hc5bcAmygTXtxfIEB3McxGMMNR7C9ST/tOzO+mMwZ/6l8C4MYOxEJx0P8GhDM55AHlBR8JsBPE3i8cCYzWHo3PIlN+K0M2cDUGu+qfVwYzOMUh6HKJc711mb2XHvslsrdcyccykADQM4TWQ0S5IAvAhgz8ql12Hm7DdAzlpkOicB5tUQjqHROBJZAQWAGyU9TbknjA23SPTL7+x53HrDrDkXA/JWJhgv4FiCR5NmoogWCCFldniEawj/FGmea3Z72wqmWUuX3LRf9aVIARwkAgIRBjjDg1PjP2svVdKpqxvLIXW7r6fvvTxPJERGgHRU2RdPtja4rd9dgAGgySCuIjEZgCe9pfQVwP9n/8cEx5D4HYERUETnCP29oJ/EeR1fRfBXgoaIkJEsDW7OgO9H4Av9rc4GAQBMBnCViMMBeIoB6a+lxYfUjRmdMe8SQGoGCrOCTPAW0cwQNBEw2cq9SvISowxqq4QHAut/Vyy23jpr/mW7M2XizjqcnjEGUhk0eD+gTwFwBI3I5z3tpYQ2XH/NF/jN/1p1VDkM3yNwIYnDRTR5QYR5TsKfupc7Y/YCePms5M4gzdsEzDXGTJWQj8c8bq8FoAKE553TDSR/du6sy58pFHYIwEkAfkOiCYIESl5/C6Pf1dYVzRHPAfETAJl46ZUAvBvA7XPmzzNeHSd4Bu8BzQUEDgORIwiDavpLAp2keVY+ezVgfzpnwevXhwWPlQ1yyDPnXgDJByJeQxO8lTDnQTwMRDNUe6gSIDiAOwE+1m6GXkOG186a/ZmNCB7C8juX9HsJp0hxwAnIObNeB5Z3WAXDzwNNkLARVLRrRn/UiJtYw1Wwd26jQkj6eD76mRDU4r3mTJ0+6bbTzpyHBx+4qx89IQBaASMBjGTyC9CsfgoCJQFCIGIUgRFRgwGATQQBLwB4CsQGAudU5XCaC/mjQTzWn/qmjZgDGELenQPakwEEjEbEE7hXMqWRo6M99qyz52HkuHHYs33nsSYIPg/wUlBDCAI0STtiYi0w6nyGMJMEXA7wQjC8gx5fQYf+NHvupVq25Lpu/SdkQ8gHLQJGMJ44ErtI2Lvv/AOCeVdcCuIrkjkOVHUjRJxzsmbM5593OUJXhqTJhubTEt8OcHQ0bawcIsAuE5UXeBzgj4PMpdb6f3zmuft+e9wxZweGHI2Y6BCUxDxguvQhYjqUFTiaQAAIhqYMIbvTrTPDzIT3AvwCDKcn6y9K2ly75gkCTYA9EcCrKSxQufxpQz0wf8HluPO2nonIuWeci8yQ0aD8eEd+XMB7BTOO1bUOEcn8xFUaC2C0wLkgZgn2ncY8/VXjmxbPmXtRuHTJ4v4t5BSveJiBF9E7CAvY1omCP5uqSW1e82JX6ECN2IrJ6am37309X9MOITr7ZYLc7I0vbhzZ0tTcv36Q0aZRuyFViFP/IDAmnuyS7L1ynYQP7E7B3xS12sS1aAKJefLA+Rdd2nB9004eAZVsBgguRHxoiGnWi15YJgjX/P4qzJ79BmjqOnTs6Zhrbfa3pH0HaYZEm56vNM9QRSPfTvkC5H0tqygwL2qhwKvCIVp43LQmnrfg8n3GMhm5aJ6q7CPhNWvepVcI+r7gjwMjohFRDBN/yGTUZ897E5zKAIOTweBK0H4SMKMR308lW7fKku+QfAflw6TeiLPkqwB+75QTL3hXJps3pFVSl+JeqdssJb9UryjuPu2wzMSPEuYblJ1OGFRnOqK6PppkdDMlIahzSPMDGwQnuLBnjd+sOW9AZsgoeOlVgvkpYD4HmnGV9cTKKisJvl3wHZRc8m7EbbaAOUO0P/UI/hZozs6ee0U/V3KKVzoOggjLAOIZAA9PToC1+owuu29/vzdyH4Eux1XiWBAnAFhx4PveE3owCYhf7uVLrseseYsg4nbAfwo0YxP2SjAXEPpRR6dva7g66wDjDgPMucmmHbdhBcUXYYg5cy6BUxb5zafMlg1/CIMjIEWij+iBbYJfRprlmWzwfKnQ2R6WXd6aYAKtPVXSfIBHgzACIOJwit99Yk17J729Y875i7D01ht6H5IoT/1pIv6V8GMrPB7QLmAzoE0EthF4XiIuvOhNaOssAN6eSIsfCTwNMcEABUHtEB4AtVQ+fMqHbgdIBIEZRdpXAZgFmTNBP0TgSAD/bEz+54iFc+rWuH2bW4VICPCELoDMZaJaQQ8ALxH4I4Q/k1wf6Y0wHPBHSToH4Alk9B7GzMJJkv8Sffl9c+YubF+65MZ96vYAvM8cCbofCJhZ4eojwtAO8D4Sd0H+KReWd5EMrMmMAXkiPOaSPAX0sSiSI0D+k1Qq2cJL35895yK/bGnKiaRoDAeUgMyYeyGU32vYOeI8ApnohWT/j+wDRFJdzNIPFTQXyK6YPecCLFt6y8FtTNSSrm1T918B70JAeopB5j5AlyQnasGfSvrjATzQSE3nzJgHRSKx2YSmsMrxFCHdBGvD5Xddi5mzL4Th7iOFzNcEHlGrZgJ0B2S+Cnbeb9Bc3Nn2DB5cEUnRZs5eCIXhLxgE00h+GOKHRbRGneNkwv4zrXtWZbzY14gQGALg84COBAjJPyf5awzNHRCfBf1OCxQgFwpEe4cHZcaL/muSTiNMTZP1R9D/G8E7O8LmPa3BXiyN53r23NchLJwGm33iW6RmC/p7wJ4jchKBDwPIVUl8TMR6kFMm98WHlCygt5NsgVgQ/dWEvguHR/dgbOdosx53LLkF58y+EIIzlsE4YzLvhsxnRYyo1EhdJGNmA9hnJ585ZxGIwnAP+1UBM0lWuWHiMUJfAXBrqD178xyD5Ssion3m2bPRVnjyt6OGvHY0jX2ziM8BmBhVqFaAX3S50U+AWDHznIVYcc+NSJGiLxxQAkIFYGH4eFHnImblDx0StocgMBdq+4bA3YemKYlVWCSaUq1oLoYxFsYEnYBfLHGhEJ3sCY6UzyzItu594Nyz34S77/1tH5Xl4Mth3mZyF4Ey1XHQM6TuA0LMmbsQgLISPw3i1GS0YjnXb8nwU4LfbGix7M6ucvkVy24EAD977sIXKHxJMC8Z8J8k5mIzuNMJ8/4sd/3f2bMv1rJl9a1+Yh3FOALjATpAv6fw/7Zt3rCqZehw/emBrkre2XMvgrVtJiznPwpwPlRDPOBvAdzHspnc6u1bN+Lhh+7r8uyyJbcDuB1z5i3c6+BvJPQohG8BvFTkiERvwEQUJF9H0FinD5HcqwVSJ2G+amS/AbJ96bKru9x3z7KbAcDPmnPFJoT232HLZUr/IpgAADzYCthLTbn51llzXu+WL42eP2fGxcg0NyHs7Hw7oUsjUWpiLeIfIPAB0DwO73DPkq7j9cC9ywBAs+b7l5qyG/+rozBxPWl/QJkxUS81ETSfUpkPwaJx7jbFKxoHWAeSARScCpkj+u/FMfiIbS0h6HgPc6w/8CqgulB8oN1nRGoOusuX3AjBQdAyQWsS0VO8sV9Q3Ns00mQ7G6kNgI6GcCa7aoXuzOdu2wQotgjC2aJ5Y9KIiKD5+6Hy57zX5hVLFmP5nT2LNpYtuRFOvuRR/m9C17NGSSTwzUUNOxLW9jQpCfWMTWd1DYCPyfDpvzz10D7EAwBkAjg1nwJr3gMaRmoRgdQjpP8UwdWh3bAP8ajF0rtuxIq7bgDBtYT7tIH/E1Gdm1r1c0+Hn1hcV71TAOB/Llf4ulRuX3rX1T3Wv3zpH0Db4YjyTwX/x6ouiQB4pmznGMBV7jfGotRWmCbZvyGZSQ4gINcD+DSUfdz53Vi2pGdR4fI7b0J7xxiV3PrrKf1XrXKH1HyT8eea4NC/qyn+OnDAdtAzz3wdViy9jkB5HuHzh7qjsYIBoiByJBjMIgOcM/vCQ9oqocbUsts1Dwex8IKg5bVXZfwJDHAqbO9lz5x3MbLZPGwQzCU1PlHYE2oj/c2F0vky8rDotATfgsjCLEEHia9Zm11TLpQa6suKpYthTL6NND8muCexhhNwOMB53hOXXfaGHkYhVknLr/Ny/+Lktq2467q69cw971JMyYsS3yKYSaCJT+IsAP7fAbtK8Fi2+P6G2t3cnIV3et5Q/wmooFr714oepmf+WV2+aQ2J75gg6Fy29Ab0hdA5uCCzHeBtsd4mss4SJgOaktw3e+5CGGNgDC4mcVzSpmh89aPl5evvDVXAyiV9m+OuXHYLspzsJfcr0D9b089WUIvod5lZcy9uaOxSvLJxwAhIJpvHOTMuGiNxRl8v4MEHAXKOhBaDzKGovfJvcuKt/T3BijsXQy4fQv4mwBerUnnTKpjzV9x1A2bM6flFlxfKvtAKmvMjeUzMEYiPwevPkI8ZjsxUEnOrDfQA3P2Q7pR3uP++2xvum4+cDf4s4Mmq5ycpaI73O4OXdtSTGjLWIQiQv23z1rWPFQs9c1feOazv0EQK58c9jQ4G4B/heau8sLwfJqk333g1rCUkf7vg/9xVXKWaT50xrsxjdI+XW7J926ZVncXGXHXuXn5LNNw0jwMsx70BwFbCTkxeUS8HodAi4mIRJuISCQovEv63szKX6u6ljestvMooF3a9KO9WAgmhJwhzDoOho42xDZeV4pWLA0ZAGAgm0MkEjjnUnaw2KrGLJySeDOCoQ9aWRqUECgG5eyWtUq1rPjBv5tzLJpA9E0DSwjBzHMhTEyNSQiBxM2h3urJiE1l7ssipqBXdkLd5E+xW1Xy3wfYKHbkXdgp4RDX2EoJOIPOjqr4k3ceBgIwn7NJJ445wf7r3zp6rICDqRFA1yn4BdLeFVjvJ/m9+Xg4yzTsALEnIWSOomHTH343Bg6NGT3D33924r6okKPLoL9TIwwIAIxPDAGOyMCY3jTQnVQ1RBMDfa23peWNcw/UBEeHKN491pPljbW8kTPPCYV6pGCtF3zggSvSZsy5FMVdCthTMEUxLont4WXAh1dP+OMHNyOWaHjnmuNdg1V8eOmhNqC83r09TJCE7/rRNpa2P3SbgxCovx2MAnEma6+rVcfY5cxFkmuHKHfMBjI68FAgCL4H+NkAIggCKHAxPEpiN9iUBUDvoHiqqiCG22Z4374qKfqYicuvqZFPzN9G2Z4Jjzj9fUfZQIDmONjMeQC9hZLiHtM/1Nnbzz1+AQtmDwEmA8lX/CnQQeNDIYNmS/sc5W7H0FsyaewkIPgSyrNi7vC8RVq2HjICQ4iY1fDrosgDKEh27Fp2vrlcDQMckDpKxQQUA/qlUnlgOzDY7b/6lIG2X2mv9prrOH9FRyLhsxq8R0AmgKV4iQwBOB/BHpEjRBw6MFZYNkStxJMA5Fe/fJK7IywCUEgujuZ1te380ZvSEwqqD3QZ0Ny+u7x2yctktmDkvBxKLIf0NgKHxRp8H/IXG77lx9ryL3LK7uopsgkwLwmLbMBqzIKoE8c7h/2iovwiEE2FLNC4wRzBhP6IbAyj4ZF7Bu0KnCv2vpRO1GoLKU/G3odkmSapydyJA0wxgdM8jIoBsh8yO3tZJuZTDb5aM51vnbTqidhSdC3eXip3rBrLIyuUiAKwLMtk20o6o9qx3EVZlTkVRLDfOvyRjyO5FVS9VBprwvnw4GWSqIy+BuNzaHadKhqGvfWDfhnadPyGTLUjAGABB1QKQBol5b4oUfeCAEBAXhpB0gg3ssTR4ORhgdQUZ71f29EzWTAfw1EGtHtUwUvWudYd3ZUB6xFj7EBjMRiIbImaJTVMAvrhPOSYDACcC/qRKrLAo9sjNoUwHWYLgEBqfIXNjKv7aAgTmCFxU3wO70oP479rv1R5UNtEquxIAZmjPYyIIKoEq975giLfP2RoQdkyXdsm3FTo72rqFK+kXnCsDwF6bCQrsy0Khdi67/GV6sdnqqRAmQ9Bj4Zl8Dp3thQmGVd5DkTx2BoAZYGKl13v86tr56xI/QBVnSBAY5gcwjileORh0Hci5My+BMR6GuXkAh77siEeC6AWZKOjs/p4YB4pEhFXx/6oRYdUbrlKxE02tQ3cDugX0scIYEOzhHtlzXTdDgFlzF6JsCMGfD2pYcsAVsM57LJU8lt95M4gsDPNWUHOk66iNEQN0Fd90F+XU+85KR1j5JI5uNEA1Flp1HpKeR030gHxf80EYCLmaJwEwpDEhOYAlHXUhGYj6faszl1URrWIdU38Xfc8cToIg1wQPNHe/k1Vleh/zsu/8VZ+N/aOqXHDQk+NkihS1GHQOhIEg5YfRcm4XBefLDLEYmBBfB+d/MXPWwvKK5QfP+7aeCqGHACf4431LMHv+IhhjbvfgpwCMj0sJAF1kVfjtrLkLy8vjsBdyIQJXHg2beZ1gY7NQAtTdoHkucbpjJT5KVzswSiUSm2JzrOql7jKsnvQgdbkr70C079v7boPS0yAkt5CgKAGuC/kggyAIgoGcBawxAJABurMfPTeoEhVmQGikABuTpjgEowRG87OJUKn+BAH1J6W377KA33nQc76l+KvE4IuwlAGB40F3giKzTACoCaD3MoIAwJwB+mkAnhtgaQ0jEWFV1EPVeBg9SmDKYQhIT5sgdz/BS6PN3wPguUL2SNSI4STAe5xmDeJghASBMoWbAFO+b3usZDYegBzFYkXLGrELzxP+LSK2VWaOqGlcnYayh+9x/wgPwW+PfqjhmKpxuVDZ9HrZvAyBAHRF+C72wMZwSFNTfuhARFjWtgDCKAIt3RqI7kSkaq3W3YbgwKzzsFwEwGJt/YbYS+BvhPBhwNqqOr+WCnenyD1di76TnoTfjYFwcileMRhUAjJz7oWQtyBLsyEM77rpvLxQDQevybQ6kzD7RUD255zWoxVWL0OVyxg4lykAugnSQkQhY0FhEoC5hHlqxsyLYPNZNI1sZdvW3RcApjmJSAu41VB4twCUHo3K9N4DUAhjd9aaoko+11ns3AVg/f333DHoYz93/mX1ZgQNncTp0Sk5A61DchoHANrhDPKHkXpyf9tljIGgYwC0oNYGudK+ff9iLSWJzGD3Y8135xb2RanYAWO4rdoAwkEZUEUg2Ljyzmv3t9spUuw3BvWY4UIP73cPEfycfW09B4Qy+u2Q0CgUCJgfqhScG2UdbByJ6Lif3fTRYd+oH9rWJXfcBNKB8ssAvZh4LCsyKrvAq9xMayAvdGzbO4G0cyrS+chq665Ws2q9YdVfwLIJYhBS5sWoP7GfujBC4viDEO2/3nz0enV756MwFED/OECnSvwXk4eC14bZELPmXNZYVTWYOeciyLcFgGaCrJnT+oStVhdRyzAdKJdZuTIszYum6zmjScJUpT4bKQ4RBnWHMDYDY7NHAzxpsF6j2L5nuagXlNgiDgZqNgjBvNYgO5F9D0dl3xATgQHzvp+NYhQtdgSSTHk1Bku9jVoYllFo3/WigOURpxBLxI05g7TH0kQExDt3JoSja+yjOkTe1IYTtGxJNfpwKVwba0jwBGNZYyQasUNzuabjc9kmzD2ooV7qi4tq8ejda+Jd2jwEcHNF6gXBUBfmOpsm7o8i3RgLY3PHApjT1agiERX2PsddM7v0d5H2TXYiXourAOyqMbemAU5+4/brOHteGnokxcHHoImwZs+9DGU5GHAmgDGD4TcY6QnkCP3GA3MAHgFi0JibJHMbwekkTgOxtse2wINRHutCxXIfhOTHrnzzDZyLRVp6Z9+xj2bPWwjRgtCJAvPqZp/fG+5efgtmzb/UAbhBwttI5uJLYwBznmf5z5Yl69R0gYAcqyzO4558sPvGdu/y+zFr7sWA8BAYbAE4ARXuiHNJ8wuHpnJ/x3XB+Vegs7NjiLG5oUqIsi/7YqFtG+JwHTWTgGoQwTg4YF8sXSS7e17QSgBvriqTcJJn+JZ/evt1X/98+Drcs6Ix8du58xahTJ8NEHyQMFPq29P20JSKDoSoXRf9Q98irJhoPAdwlYizktVL4JxrR148FurNQbM+5sx9IyTlQT8SSHwYjUjtBNi59K7+O2SmeGVh0DgQLwcLNYGYVzVsHAi7kBzHtQVwd3v4ew4Iox5Vk4Uwb+OqZ80ZZ53XQ/9COJX3AtoRPcck290xc65a2KqGBWwGdBoh8UKgqxVrww2G7iNQlfWToDEL8rZliNg8GTSzAEaZXwXAm9syobbB7zvdBEH6ZwlzXySPS0yEMdc7f5J3/ZMczp59ATbf+gcaG3xSxDIQdwFYCpifW2tHGdvLkqsbonhfFN1ewNsioV+S2hulCCYAGYCf+r9XXjIPasK8BZf23d45i9DU4U2A7NsF8y6QqI0k3JMZb+XXOu09EOu0UAgRtDbtFHVb4mUTt+gEgfMlg/Ma6G/XTgiCWyjoLoF3CbgL8DeBOB6pFVaKBjCoIiwBRxI4td+OVD0UFv/zuEW4xsD80QDbD6BH+7njpx8+NputHzjYWoN8hm0knu3yahHHgzxRDShOZ81ehNbJRwHgmwHz2v3pSLlchg1at0q+EmwpFmedUiyXXg3PsygcXuNxvMOFxdvKclhZJ8QHi8Mg5AqSrgLUmZyiDTjeEJ+w8C2z517acPtk8hg277KJYnC5wCMFHQPqKNJ0BgF2BUE9C9lEhud73pVrcP/SpTAkAmOWQrgmCaYYPzwJMP8VBGYBnMyceZf0WM45M89H2Rebinl8AF7/CmAIJC91iROAeiKsWmFVrD6viLD6P6t9i7Duv+dGlNs6QekaAuuqz5ksGHyM1k4pu8Zf55lzLkXoSnnQXQ76V4E6BsQxApu895sjA4sUKXrHoBCQWefNRCR60LkSxoPa14hlPyGYewpoLkB+taSnD9hIkEeZwJ5ibH2pXsYSRReEkL+PkUd3sl2MlMyHnQ+HzJzbsxL+nLkL0JndYvaue26RwC8CyAr1wvb1Pmr3Lr8ZYbkTgLkFwK6qBRCGAVgk6WIoCk0Ry83/bK19vKcAg0vvuRKSg1d4m/fhrdXTLQHwDQI/RYZNs+f2bWAwf84iNLlyxsi/3wMnJluqgFDk9bDDC9Zke5uEhqdr6Z3XInS2Ewj+leQjjB0g41zzrxL089Dry6F3x86ee1HupPPejgVz5mH2vEWYO/9Szpq7cFgQZOZYm/mRYP5TwBgKBUi3ASr01a4urnqquBA23P6uaOy0L4VwxV1PkPgFYwtHkhDMmRK+Argxs+Zfhsveemav5cyYvwBmx5kwxl4CmAujFjCOlcbbsmbIRh6CKNUp/vowKARE4XAAPkfa10WS2SSD20BJiNoA3WPh8eIWu4vQfQMssDc0kZrrOAwz51y0z8U7brsB8iHk3RJKa4Dk5E8IfIM1wZcNOWnmrLM5e171+dPPOgfHHj+Z1uUm5MKxn/bw3wcxCUDYxVGv0uUGNpPo1P6ogIeiRyrPvAPgBUxCt0eZD2+mxV72cqBcsfQGZLLBXsD9C6jna6rJifq8h/kPDx716lNfa848d18R36uOOxUA2BGWxnUa+wWAn2bkspEE3bgP9IvBEEt7DDne3QGub1gKYPFpA32CwKrk8cgoi+NE8wUae5tncNUw3/7VDjPks17mi87ju4S9CTDXAsHbGMXp8oL/mXz5+4pzAFfb1TOHsG8ok/0VYfX91IolNyHIj/Qg/hvQclPrOkO+jcCPLXDmnpcmZOaet68l2mlnnIP5r3s9jAuG+DH3vkf0/wFgaMJxiVwL439RRptftuTqPtuTIsWgKNF9JHI4nMLp+6dErA9Cq43hkwBw2DgCMPcA/Big3ODLsTwkzQ6wfbRgttW7gwJUeGkVmqdeKelLkV8wADALmI8Lmg0z+hbn8OjMOZdtAwjv3NjsqOGvATEfMCcQCgCUANxEYC6A4epSQd8tLRUN8q1ujw9xs4S5FdUt2SUIHqGNAO6CgGUrruu1TPkyHEb/yXLX5yR8F1GQPQCmWcBHBL9gSMuIm60xK2fNvfQFwe6J6VSL9+GkkaPGnW6MvQiGJwsMatqwBXL/bGi3ONdXYqrk0NHYFrzkrj9g1twLkAmOWlF2L7wX4NcBnJXUHI0opwCYUhWTVWuK/iQAdkruh+XQ/X8qdZ6cyTWT1tS0pe9QI1Fhvm8DgPoPNnynVRlCdoPkPgPwZwCPj0O7WcksoniGgDsk3TVr7uWrQO4E6CA1SRpXKpVOBIMLKHOO4gi88UAVAPP1Mrc9HGjEfvQhxSsRAyYgZ884L3LAcjobxASoaouyf4jtoqJ3948Bii95ZOEi5e4jJNYJOHLQLLHIyBw2KutVAk6UUDet24plizFr3mUC/PcInAngvMQVWaAhcTJpTwbhSIYQYYIgA1hTo/gUhKsA/QrA7KgRqHAejew/999zNc6dcykA3ElyE4kJACr9qHiIQPdS5hk1oBBdeudNmD1vEYz0BycakP9GmmkxiSRpjgyC7MdJfgRAW6QvgUDkjbGtNCabzLti+SXltgD+7wLtvcOjCSuW3VKZ4eoEILEwQsUKqx9YvuQWzJ5HOG/vDQK+yYf4GMG3AmaiyAonnHj+x/7WyVpzFB4H8A3S/l5hR6cqvomNtUN1/jiQrrN33XUT5p53McKifdBm3AdEfBMwZyDhIqDxAN5B8m0g2gB1xOHFMgSHiDbPRFzFis6mA/Rfzxj+yGqMltz1hwPYgxT/mzBgEVYmaAJDZQmeR8EMRgy2WDTkBK4s+7xfeucNMPQIWN4I6pHBHgTGUUhFtMJgbpBtxTmzF9S916sTkN0k4RMSbxPgFUcOTDzMSVhBOdHnSG8SBw9S7YT+m/SfAbCzoiaKZC7xxtbYlLiyQ6lQfJrSvbUSeSWxNUAHmBtlVFy2ZHhDZS676waUw7LvaN/xO8i/BfCLKRWZKLojKhsIGE5ogqCJgkaKykZ7kpIYY47SfaDeDe39lTPNfmmN/wkhGJmK0rmiTYq9IvtrALTsrpuxcumNKBY61xYKez4PuIsB/D8IK6Vwk3zYSSokvAN8AXIbJd0O8JMAFm1fu/2XPgw7s7k8cvlmwtiuYilSPeuqWNGDNOBHVH/9qcZugN25nX0HY8kdN6GztAMmn7vPq/xWwP8I0O7ImADJxwgaKmh8PE9jROWZUFH6WPTpnyH0Sch8tex855I7U+KRonEMgg7EQXBTCZwxmA0jtJnwf4Iiz2nDEhzyJQorD1xsRkLirFK5fThZ3xpr5ZJb4YoGxuIpCO8W/P8F9DSBsDanR8WYKDJN3QvoTkDvgcLPQtwW6wdKAMoESoTKRnKmQa/ioc170dLcVDQGNxLqhFAiUKJQInxIYJWhWW5gAfys4RFYufxWtGaMQHMfFL6N0HsA3QT4lxI2qVbSVom6CyDaxPxKwH8S1BW5IWNudS7rlt11c9dK5GFhYaSQgiNQghgCKoFe4P5ZAN278g788b5loQ9zD6uc/39y5YWlYsf8cqmwyEBvIfxbSXeJfHm+KxWveHPr578bhJl1Tzy3XCuX3wDSgDTDWMOZE3AkO7rrpmJS7QGVog/KAEpILEj6ASPBSD6aP5apaF1Eh5P6ZT34wEosufl3MMqsVug+Tvk3CPgFgLUEXBeihOp3AZDUAegRQl8mtMhyx48NOgrLl6ThUFL0DwMSYb37o+/F809uAYizBD9lMOiRYl8EAI+Rfk2yNS1bcjtmzFoIAfeD3AmDQRXUJgmVPHk8qOME3NvTvXff8zsAwLlzFm6Wd/8aMPtLAmdROsXLT42yusEZme0AnwHxAIhHiiW/Z3hLEwoFAdBzIN5OuCwijxISvuE4Trfdvgxz5i0EI6fCjZTNRMMXUS3Cb7PA+v56yQPA0rtXAABmzzt/t5C5Cihfb2SOEvkaCMdBmgCpNRIRoZ0ymwE86+UeodFTEyaP3rNl0w7dft2P65bvnUM22wJf6vwlYe6NWBDSA+2efls/mloXK1f8AYj2yt3x5y/17rsXXQmbgYWg6ajR4QAoWGO27RsMVAD0AMErUF34HjAP9VeIFd/9LIW3QyaDSApIgE/29U4tX3o9ABRmzbvkDtItg8xh9HwNgBMEP0XAMEbsbSfAbSBWy7vHSD5uiJck6a4lywc65CleoRiQwGnGvEsgmAAKfwTg3UwC9w2g1MjJWCDwOdD+G1nCsrtuAgCcfuY8SBqeb2q+2Vj72kHowj6VRwYB/KIz7qvZ0GL5susaevSYKRPQtmkTx510qmGmyQbWKuzc6Uy21f/p/nsbKuPljpPPmYQSt7CpeLIhmw1sAIPQb1/3pG9qHaEnnj44AY3nzFsEAK1ewXGADWI/DRpqnXNmrdSOlctv7VeZs+YuhHyYgcn9kjRvAhLrNq2Rd/MArF657OCF+x8IprUCh73uI9jzwv3GZFtsEAT05U7f2b7F0QR6/PFnD3UTU/wvwYA4kFjhMcnDnD0wr/MqCEHye0IX3gsA9668peaiMGrcYbs69m67F8BrD8SAxKKYORmnb4thW6PPrVq3CQC04c9/dgBco8/9NeGRezYAgIAH6/Rx+0FrR2y2PFbwPxUxFYAnZD30m0y2+GHvs/0OvwIANOZ4QedW/iYh6An5cOOAElUdZKxpA9Zc8z0goqypR2CKA4aBvRWegNfpFA4zSVjawWAIqGe9Kz8Vpxit4E/3L0HH3u0AuFJiqZpIY5AQF0f4kwAdnSbVeXlCIuDNZgEvAmolNBRRDo/zvcOJDfnS1GD2nMtAZZuB4G9JTIryYjB2jcAtNtfcWQ77MkFOkeKVh/0mIDNmXwCntRTdfABZYD9N4LshMuHlA6PM+u257L5ey6KD6B4F/DoNirNiN0QhlcYQdoYQYPasiwZcZIrBhRSgHKhDwHWR8UIlpeskyfw/7zFl9vxLMW/W+X2WNXv+QsCWW8XwswDfVg3oCBjgMUvcaOlxIPKipEjx1479JiCkgTHjJgCYgYrvwUAQmy9KZYAr92RfpRXLbt73Lnk4H24E8NCBs7cnIM63Uh528JM2phgYViy7BsYbALqe4j01JsYQzYWg/SW8LlKQH3rhuW/gnFld42Gd/Orj8J5Pfh2z5l7QLK9z5M0PBXxeRL4a40od3uMbnYXc2mzmr0d8lSLFwcR+746xXfxpII8YjCQ6sbsXCGyU9FBPaoRCZweGtA4vuTC8W7RvGGwiUnExI0/18EdCeGKQq0gxCMgEFr7stoL+HwX+AuIU0YARHzxL4KlOergtW3rAIHh61tzLXgJZFBQQGLn68buPInJnADhd4MiuWQQVQvouPH+btSXcujg1b02Roh7262h13oI34NLXziFh5kPMJSz/gFCJ6YNHDbG2p4b9+f5lcN4D5AMAdhyIbGyRIazGe+BcGIPjTztzwGWmGFwsuf0PAMvYuP7R5VLpbwG/GlJsj0V4olXgDICfEfQjEVcL/noA13rw5wD/r8gFIkYmznuxO2cbpK9J+groC8uXpcQjRYqesF8EpFgq4ob7lo8lzIyEdgyKPjtSotztvS1k873ljRAAPAvqmX6ETmoQlRAPFDCvvX13tiU7dDArSDFIWLZkMSZMPkY2/+KNknsz5K8G0F6Jxs5KWB0CzADMAcjEXEqciziOWQyFBnqA0Psh/SPJPbGPRYoUKXrAfgp3BVCniDi6wTBzfZWWhAPcDW/uNSTuuKXnl9d5h+yI4Tsk3Re3ZVAHRbFFmRFPz+eaD8tmsgMvNMUBwfIlt2IospLPPQjP91B8g5H+x3isotAOQIIqIVKYxN2KDiFFCusIXU/5DwD+0lFTT/qtd8Xi8iXXHequpUjxske/VQgz516IsDwCQWbPvwvms5V4tBhYqtkovzcepHC+iO0r+jj9zZizEJIup7FXAcwOukI92mgcgPeC/hcb1nZi9XN3DnYtKQYZc+ZeAgMfOHCchCOdd4eDmGiNHU7YrOR92RX3EtwSmOwLhvYZ0K8Pw0xh6JBOLF5806HuQooUfzXotxLdyYDBrlEOZtY+aT0HvIvrvm2d07ePam7Ao9l7EHiE0gYA0/sTQbXvZiDJcGcJzPfO/nrC5JZw9cFxtE4xACxdcj0AhAA2xJ80TkeKFAcI+yHCIiDzaoDHdv95fxFxHyyTZvnolrVYsXRxA894eB+uB/zDjebR6E8Xq//oLKI0mQoHsYIUKVKk+OtHvwjIa2eej8A0wdDOMeKQCs0YlIO/1sv7h6TGIi8U9CIyuaYSiBWDpsSvQY1aZZrA02hSX4AUKVKkqEW/dsVSsYS9bVuHebm5ICtKyYHu21H+Dz1UKu3dUC53NPTMgyufgpcA2vtF7hzsgalK5UzWmsx8FXabmTMvHOxqUqRIkeKvFv3SgWRMAADHQzphsIKIVHIVAStzzcNLe7a/1Piz0S7/DMBVqKQyHVxE4VL8ucgOHSdg04GoI8F/nHYSPvPgo/j9tOnZlnLnsBI5vCAOFZHxEimVs0RHXtrtjNn1l4mms7no/ScfO3DN+s6xJ6ItmzNH7djWYsNwZAEcGQZq3Subt6DPeVfMyrU1AztpufOZpub20Xva3Xu2bDiQQ5UixtdOPhoXPdaJPx2RzYxoKw8tIRxRNG6op7LyJGHDDNGRg3YXM8Gup8bkO/Kh8597+PlD3fQUBwk/P/IYFE1gRnXsac7Ij+j0Gl6GmkFjAHkrU8wBe3PQLm9a91y8wZf/4cQs/umxvrNLNEwDZs65EFIOpPsSwH+qTXSz34RESb4l7SBwIYQHVvbD9n7GnEXI+2YUbOc3IHwSSSrcQYMiIiUVIbwe4E0rlw+ub8A/nngW/r/H7scNk6YMC5xOBsy5Ik4jy0cAHCWgSUAQU0vHyPR0jyc2kfYvEO4H3X2hCV8gfPmS9QOPinvL+DFoo820AIfJB2eJ9mxRJ1j5yRCGli1yJWMtAAXe+4z3BQvt9cZsDmmeznn3R3jdHwalVaPaMh1LJwJfeKp3IveHw4/GZmDRmGLhouawpIQ5jlwDCcGAcWDZKPOfj4PfGESG176SEVDw8e+If08yPkbPF2wGGxFcmSfvHpIJIGB4c6njUxnvxptkyntYR0m8TQM+D9j/EtF+0aa1vfbt+nFTQWiYkfsUqAmoSeKb1BMn5TKAXwXqO5ApXbxlc93ybhh7JIa7LdiTaR1CmRM9OYMGpxmPIwmN9vDNoALJADAeRJHQXkdtIsxTVnjAS/fuUcvqIa6ztHDbuh7b/u3Dj4anGTm6VPrk0FLnOAIyisefAOLxj3JrxQINenRJkRLpTVFNFGZQCRKs+Hl6CIYA1sgE3wpp2p9vHmOndW57X94VTyPgaxO1iVEs1zhmGSiwbINrRxXabp2xY0efa3zx+EkgdbYH34G+dg2CBROs226y37Lye30+wAeefRo3T5j8dhAzub8Z0AR5+QKAXQA2g1xH+BdcYDc8On7Y3pEdJX30yWf2q+grx0xDQSYYlwmnGehsgGcLOh7SJBBDBOSQLGeZMoEOUtslviDpYVD3eKOHLzlj0a6vPbZUn3l+Vd16GudAaGBQGuJp5wADM9mtmRjEr9EqD/cM+7n7r1x6A2bOXQgCd4PmIwCySe7rQQMJwuQAP3+3PnvTjNllrKwTo6u/uHXSZLQDyG5bP/rGSZMvtdDbQJ1K+SFGAGSr8Z2Aas706P/jjHAUhJmgPgBxQybM3mrAn944YeqDVggv3Ly23226ftI4CLapBJ6TFd9Cr3kkJgPeVi3TgKwnMj6M854LAFs8OQrSYRb+LAe8CwbbHDL3bWrNXfXqXeFtN0ycutPD4dKN9TmTbBDAdXacYYEPGtpoc0AlQXmFCMSTAsCAld8BwFau1T7VNfVslF04ihytPxO428rBgy2G5s2kjlY1T3jPSwKAB9sL8KvHBdmrP90yDF9v393zA1HTmozHm0VzTK3RYnc9IoGVlPtvEPuE/71qwtFokoOXRuwJRlxsvX8HqDMADIu2sCS8qImjSseIKhwbiEeAOJfE+yhsGsLiHcrwp78bP/2+ACpfvvnFfZpeLpfgyFYQbwlojmScs9jToNbykbAwPvrmTZKsOJ4LRd88TeLCGc1fPBcRMbDRr9IjZRP+wMO0hx17KWoBaS6P0iDHOx5rhjUhIhRo3IsZj4YSwVhDAHwVpA9V9a71hfHRq2cf9/A/pPxeJg0QZ0P+fQNJZdFlnUlFEjtMqGdPWb9npRFuvnHi+IcDbzov2LyxofJumDwFAKyjf02LzLsyIS8ENNXD24SQc58WCIAfJWgKgZNJXEagTbCPXPOnm3+d97r6+vFTXsoGAS5Y/0KXpxvWgcRZAl9F6MT9Hq3uEwPFZ0vdN9xP2intRxoNeUD+EQobBtklvTK88Zs+cyi+OlaDEHL4hsnj0JHpMFlojhV/Yz2+R3E2wCGVoJLx+Cj5O1Y4kVGocUapukHREphK6oOCrvXAF3bDjfjduEkNt+f3kw7HTw472jifPT1w9sfWm6sD4b0Cpwmwqm0JkSQQrAxMdctNskmSAMdYbxZlvfsZgasEzmsLRtnfTz6ql4GuSDSjTT4O0cmGv7NCVHq+r5J7XRSQcQ5Z72S6xIBnLx8kfW5xwMfWFAtjT21p7X0NsbKO4v719F/X2mtxy5gTMG73mcyw8NqApV+R/keizvMGwyr56Mk6H3W5BgASDMlJFu7dVv4PLSx/OWPKYxZPmLpv2yVQklGSJDE+SLDruCax75OOJteqIQHidVv7DFk5iVb6n4yRgOG+hEC+5nRfnYdqWVE58RpU2E9bl+hdSj4GlWjMlQNL9HtECKkod6hFOZ7Y6H2Mu9KlLNa8p90/NddrVxWRE8wEI8w00hcBfyNlfhIann3TxIn2xgm9v9PXTJyKcmhHW48vZZy7PuvCj4qaLshW+9v9qWh/EVWTmpoATKv1Ojfr9W3J/9YynLlHp/C6iUd3ebqh4X7N6TOQyeXhpVkQRg8K91FFCcDde7kJ9yy9pd8Px+fK9QAeSU5dg0dGktIEAEfTBCcZYwdU4q1jRqOlvRA0FbLvMl6/ojCPYqa20T6K5QRJlU+9TSxRHsVvNQCMtwj/IW/xrSATjP3D5Gl9tueWiVMwVMWW8YWOj2aFawzwViMOi8QEvmYDUpR4FzUbEZIIUvGyU5ycN/7XiCCUo7Ag8LpqVGnbJ4e73c23Txjf+6irWhbUvdzevnf/dL2vFslwZ+SQ9SGM1NWnCb2VKRgIrcI5wxi8eSwcrp3Q81gbVQU96FZH3XrQ9fW6fuJE7GleazqHLHsjxN+Q/gICOZlaPouoT/LY5RoQr6vq7I0m8PdW+j68n3zThCn7tr0m2EOSMLnadlavsWsfK9fiaN3d5xKV9VN9JjmMBATGWI8MqvOSiK26n+GSaxJRbpCA+DgYgTwhxQQoXt/Rxm4q31EJeVNLXGrWUp/x+ITag2HXxjMmREkdNfGgqZEE32KlPwj8mCGbbqpDRD4Kg9snHgbr/GF54Qfw+L8UJxAOHi4es1i8T1/nE3OtjD5xLpzocC8FoOYY8MoW/+Bl2Y0LuHjUEdX10chgN7cMQaGjvVk0c6OTTGOT1BjMOogP7y9FsnDwJigCuDteo4NI26oLH0CLyDnyAc6ds3C/yvrDpPH43rEhC/mmtwrB1yE7oSqY8khaX3n5a04qvSM+hUWnMpv1fHvOuS9nFLbcMHFyj08tnjQJnhot4V8t+B9WmAxEOVcqsuu4/NpkYbUkTPH7VcOpdaN1MecEPwbQV8qwXyyZ5ubFE6d3aUtlo0LXTYLsodz9+FQ2s5rd2kiwMSdcY9BR2ZTql1XhFiyMPlS09qicek6C2H32VFNHbT313qubxx4DP3ojhhSHX27ovm2gqVT0DtYjjI0gOb2renInYC6Hxb86NA2/cUKVS6xseWz8YLbPWkD9sdxn/dTUSgl5H9ZsqOxe5D61VriaxltZ+bfHpxTpZyJdmgP3SfDI3p7udk8jbatMLBLxn8DxFP/Fy3yuZEz+uoldifz5k6eiQE20xHdIdzkgWxH8Kv7UbUsfbWLtxHAKxW9q/A2zrfW4dkrUhoYICI2FCTJHgeYUNTQIjaCSQeRBwGzY37BcS5beAngHwd8rYOegUo+atsZs3WzYcGR/dTUA8OCwC2BBvP+5prMEfkXUiErpyUa7T53q5fd9UTlxSgT0bke+5fBdO/DN40/e597FEyaDTqPg+TUPfgRArjp2iUAgKRV91NkzkoCFouBh8hD/D1X48J5gjLlmcpUdzpQ9mlxERNSPzWp/QAA5Aln4JHBmzbkPDVWu+LRo4I8VzAfb8q32uh44Pl+vyB7rYKxYTri8XeCmsScL7qsAx3Z5uPvg1218z52p5SNjvDFAx7tfVTa4any0QTR7otkRQaLz3s/3i7383v1aNbJFfyPt7Y9PQV8PRK0z8GiSQ34fMXtfG3E/Nux6o1IVCeY98ZkC9fYw14rfTY44kd9MOwI7M9mclfu8ob9Y8DEN7V5f137WXY89DUW8Hi3DKaT/ciHgBOMi9XmfSvQZc86DhwHhzgU4vsLmD9JGLYCkvwKgmTlnUfRbjRw1+qFGL5CwW7X9liRguAE6JIwYTCJSOZ9QIP1xkI4DcHd/y9nU/BgCzxaKnwYxJSpVNS9k152gwvInfVb0R6KDYW+TEDU3Z7z56FMjxt06edfu9bWXr500FZ1Ec9b7f7Dy7xBofBeHnuR4WDPIrJ2LHgdq3zZVTv7JC6E8wb8f6jY8Cpk775wyDfPXrQFIuOQUfgCphwAEEIYEFlnvKztipdpumpC+EG/C72gpdlwL4N66dcaF14qx6g5d5a9oIG6YeBhKJsgFYccnAX9UF3FhnX5V9AlS17JQCc2z72ZdK47yyoj80FOZ8o0tyK4GYnEXuY/YrY8BGRCSQ0f/yoqPtg031Pd+NkoWBKNRCwS0xuKeQl0i3XNjBdTMSbdK+uxjIlYRAql5aIjPete5EgpWffm1M5Bb8wJytHMlvIO9lVdL+amuqyjZW1BvhSSvriKxH3U2UX6zDfWNmyZO7ZuAeGdAdOQQ5Od3Z/sGAwTeIPD1qChmk0FP5LSooahxmyrmnDWlAJBoOJjUrWbs4wEfBmi2sebuc2ZciHtWNm6NJQpla8/OhjqvKmvv+qJXI8UiZt25V+ALlF6KqcdYENMhtCq+tz43FO3agfevDuAWGPEnPzniaLxv9TO4Y/xkPNI8FCe07Xmnp/0gIEMJte9sZRHVrse4PpFwZJeW2zjSbfRDnfGv+TPmO8fA8zNOerDTh7sAoBQQRRvbajY2ouh9B+hWcZdfhQBi0C3qAXt/bJ97RcYvn8YJ+FiJ/pFrJ07quKybpVlFHOdr3uO64tZk14oOSFknyIWvEc3Foodkau5U5f5q7wUA7QBeELGVghc4hvDTKVVzEtRZM0pmRjiGDBdRxW8sHncUVgUleAolAM2+2/5ce1BWTfNrOaSed7SuNszdDlB9CJZ6mFXs5+GjQilqOlbTfkUHtup6qbXaqoxbz+c5CZ6EixKexWLL2ICoRh/U4/NEzcHNHA25Nw0r+y8fv3YjSrY53xp2vttIw1RvbhnPbeVkRgdhI4G1INshtIiY5uknUjQVYtetnITjBmQIvXlX3l5J6KW+CUhkfT09EE5PvM8rsu0BbdSV1RbbYtSYXtbdgwhUBr6GdNScEgZfA5LUXRGeg8Ac7/23TDbY2+jzV42fgIW5JlxbLF4AJC9yJK+td2CKOA7eDvDrnnzEerYZAKKGCDgV1GcIzOm1r1GTrScvKBpdObrQUQQi74nj2nadbGT+jmLeUzGBZI/lqLrCCyKf2ZXJPFWEtgG0TcDEEaXSCQIOA2CYCOfR6yYFQLMIuyDjS7/99vQzkCvvRVMI2Manb7egLd0Zp0rfu37pcpkC4LVroMulZn8BhYuzsucDuuaOsRNx3taq2WUXXUdN03qThHoQLaUi9uRzC6w0qgtH3o1k1CixVxDuP4jgQQ/tpYycMS1W4UmA/g9oz0cP23r10OBBuvM7GPwQbG/PuyxEIqC61L6P3iKhpYAHuV7wnQCY/NhtIaCiBOoyIDCA1oDcD3PM7rM8iIg6hSJtvBf4KF8qY6ehnuggKrIEhDTPbAmCZwInZrzgs2ITXWtrUZNFTAaQhXrxY4sPK6KHpy7Y3MT/yvvijlzII4z8uZU5VD2dUrQ3EtjmiG968eosuMnAlEVkigEnluHe2FT2Hwc0qnaKuo5qsv/r+JzcyQDv6JOABEEWJM8VOLHr/AzGRLHON8QHaO57W/ff6z14QFB9dQScJNhjBDzY6NMtJoMbi+WhOa/TKsVxn6Kjfwg4w0dDE3wE8Kv3NLfi3av+AgC4esrUjtbQ3eyBpwlcJeCM6KEe9BMCDHRixnEcgbXfP2oKHs6Z7FG73Mfyoaazr+Na5e3wEnG/ZL8VkstXGWz75xdecDj+GHyrPcwOEyYTfAvgPw5iTLSp78sddf2beZFv3JZrvn5caWvBZJoiJXofU5ickETeIuizrGzF7OHuff/yIEoOO40Msnb/fMBq+hGJIsFWwn7cwa8sGHQJp2BqLJgaxS4Qj+Va8kfQn9lcEUt1P/5HJ0tPIDR4xtF+hNCT25rz+OAzzwIAPn3CqR1zdmy908k/DZorrTTL9KorINotj38pCCYbYFWmM+IKbTcVZb1TM6OpaBP5EUgPoeqcU2lv1+8JtxWbREWTXwLsnv6zEgnXM9jyz4gEOBq0y1QOk/2rRch6/9sfFsr/dHqpaHOhR1PzUBxrkWkplUdJmGVlPi3q1XV2/y5DaETA8KjQ2sPh/Q4jvFrguL50XSI8pf8YU+LX9gTy522pSLU7rxszbY8r5b+Cps5dAL4GIMMeLcuIwKMlkD8944u9E5BZ8y4G6bPeZ86rduvAnPLr9ro/vx8ExKZ+o4w0y5MPzpl1KZYuv67P52KxzHBLTIqYt30XSeXgDiDwWJorda7uzGcqxAMAXr9uLZZOmII2Ez4fiD8BeJoEIyZvd3VuWDnvc7wRpgJYO6EjxIQOng5wUWIzWfWO6N5Z1Zhr8ndE+bM0bp03wD+/sDX6+clV+ARQvGHiYaubitmv7mxpfyHn+F+Bx/CI607s/bsOYkRcAIvwrGFldwSBJztbiDYHDBMQNHD+FNh+8fee3/Ddz52qj656fL/n9OZJU/b72X1Af64M3zw0LH3nD5On44rY6arCsPcDhSBAE80wLz+1vv1v18OXke7549jDnzpyz0Z88Jmq9/LXn/gzDpsyHkeUc+sLhj8wcmcLyKjOwStZM16ZUSrzcECr2gIHR2AIIhFWwn2gtkndpB3OcCuU2bRoQ/+dWRMs7sV6sFcMPv0ACDgQBWMq5t79BSH3ZevKF+3aGpnrtW0DgMIto0/ZG+ZffBFh61OA/y2Iw/ra/AKvYUPK5emB54MhgyMMnE30a7Vn09o+iNjaEZhbOgL4K9Z3FbFe+tIaXDdxsi8RVwWebwNwRi2J77rSBMJAMMcVAhv0zoFEq2OaqDMh01UZ+gpElVngfOPMfzuqociPmUh22gywuaIZr1t2IipDaU++GcOKnfvcN2fTOlw5bTxA3R2Uca83mZGdxsgIyIoomkgm3hICJQM4a0JamzfyCPPrzPidk98AYHTSjt50brGsdrkz/KyQWXfJhvresIs2vohrph7hXTD8tzbcfTqgTySF10o8K3qWRB4rM87AvIbik/RCxvfnfEDgT6sq1kGHEol8mPI24/nhnUHuFuPdc9XrSb8bL3OMdxgF12ThW5Pu1hM8JYNrPIr//PAy/62p+zoDfmzdZvxy8hHwwH3GmrsD78d1WMjGyuGiidrWEhKdVnBGajLlHGnhi4QFYY32IR51x6KLrONgYvD1s7XFGQgZORgJIYTu3mD7q3q9YNvDuH7SVPx6yvY/vXXDqOut/Cck9Wi6LwJGCAL5sfnQY1Nzfnhr2aOuqLD6FDzoSrSlnu7YkzM4a+KGbSvXTb4J4tAWR1eiULJAk4te5EIAZD0QONj2gAUH5XokIMPjYYN0FoHJB3s5vFwRcSE6RSwdBfDRRp4JYsrtgF451AqFpzujVRod5oJt9e76CwxC4ZkxZXc5A2t3ei8Lg6G02B2WIRCjFaCtHMIHOeSz+T1HtO1CtjBpoujnoyeuo7aPADy1R+C/G691O/O9p/W9fO1q3Dx+XAji15B9m8jRXcliHXESZSWdNL687ZfbwynIxpZKpkbCUlcWm/zQWRUPHUrUHCwA6diML32wkB35+esmTXeXbngBnok4sfEDMpnEeGLFAq8u4gEqW5x6zZSJk6b6sG6smL+UyyjBrxtlgjfmvAt2QsrAookGe8IyDIjRymBHGAJZoNmEe8MsMLbDQkzWcAOo6M8P9kHzQImw4lO/PFpjz/PdYJegOhqgUOaSDWux2E9XUXiCAAxcn3IewTaHRsi6BpwKSFhpzLBy+SyGbtVNUybj4nVdDDPxzg6Hf1k9TrtR/oYBfjQGWbXLoVPCCARwzmMPPFpkkQ3Fnd6XDNnZIwE59tzz0Nm2J8g3D50P0B4A46a/UgiixkI4F+SjM+dcgBV9eNCXYCCiZBWW+h5HwZPnwtuvh7Lf/MHUSU9/cO03O7919GfwyWfWAAC+umYjEGXdazh08Y3jJ8ERJ0PmCNOr7j2xEiFCgxW7cmZZ4IF3vPBin3V0BHl4clVz6FYZ+dHVnbXWyixCYokC+qPW5sdmgwxLbQ4Y7rtKy3toJEChqbz7AGwYvVTbm46mxjLNiu8YUtxxLcD7Kt1HNyusPrAtyKHDZkpjSoVCiyv1fGNMUbMep9LzG0762i8nTHriHZ+4ufOrv/yovvBkZHH+L1vWAoADsK3v2qv45qRpcARaCTTF3F59SVpiBMr9cm4cNByA5UBFsbaa4AABuyvS/MHrZ3tgUZAvDvPwxvftFCfQFY1Fzrl29iVNAEAgC/L/UzYwnTA3f/vIV780uljwb10X6cqwZQM+H31riz8NoUcCYoM8bJCbLJjXRtZCKQWpviIgaOaB7seALfb9JEFpL4BdIqZGv9S9DRQhMCDwTsItGBeaB2+e8KmHjt4dPH3DhOnrrddLoTE7S1m7p9M2dWZ8qLe8+Jdea//5q1+NphdfxJ5hQ08LQpenTJ+iSAqw0k3jO1zHbcMbi7npfBahhrZRW/8Aupco41QrWqCPxD1KFMAyMO7JnAmNQ8ThiFHI4aQNPUuDhc6p06OgjgcBsUYpjPTWsvXO2Il+S8D4MuzHOk3w6LUTpnUglpv3Z7/xpRL2UO2jqJ29c60xdxcpwt5gqNnDwYdu/uaCP0t8+rqJE9dax20ZZHd0ZrQ7V+gs2CDjF2xe31A7nInmI5EUJtZkPUtLoohRB9SZp+dRwIHZo7r715iKI0EUF66vQekd35w0ESTgDcdLvROPyHeMErjTeMCZ0haLyD+sp1e6ap/K6RD+u8npqcPadv3JyD9+44RJzxuZzWWr7Z3G7vJg+29nnRJe+Men9KFnnu6z7T3uDDFjdAaAw/pvk/2/HQSA0wROB9DnKGcUgvB7yhYvUjyxB1u7uOg4fAE9LDDOChdBuEgMnYXpBLU3kNthS+UNORSec+QT10+c9mgQulUh/Q4AumRLV13F2J1bEY7KZ3Ild3wkze1LTUdA3BGE5kFP4BtPr2loVN608Vn85Dg4u33ytwsBvkOfBRDH9YKLnR+jUOuEh5FHFg45b1wnbZeYS33Bkcf95HuzPrKn4PCvE6eiyXsYBWi3Hjk5ZH2ANhOFumn2hjsQlNcZf4MRNv13naizfSIi7KsJv5XCjJrB2vdWAKBfmPflBYS/Vsr0zVV1w0h4vNA8rC1X2P4chDMr5ro9nzySCsYYaAFgFpD0GY8OEG1CuCPrtNEFdvXmnJ74zYSpjza77NOdI7Lbg5LzV7xQP1x3Inrb16Szx4HKlYzesFXBaf82caqx8mj2Bu2GEB1aPFGERdk4NHvBKzDFLJ5pbRpyR1uh0//d2uewv6gKTA80GB9yqiPRi/V6nzhMAMvtrU3iLLIP5kOAN+zoFNfkjIGFew4ynQSaGqwuZ7xONsDJ8aIsAmoPvHYPdeFWK635wF0PPrWXevTKyROeGKL82rF7XPE/5mZwzfWr9ymsLgGZPfcSZGlMQX4eoEzU7oMv1Xy5odspciKE1xoGT79mzqvx0NKeLYFCW4TxLcUywwcywiJT8Xjq+cjQ3YxOhKVcK4hWCBMoHE/ydTaK5LZH1j9rgDstgutunDT+EcoUL94YERLnADi0EJja1yxWQ3RosxE39Bknrhve9xcAWN9vO/6bjx5d34Kk57l47Yhy+bXDDFE2READ44GyMTCK7EdDQ4AWAYE8TXsZ5kkD9T/7Vsx9e2InwW8a6FWCxkTtqGcRIRBqNcTHFXAlvd/W330tL4+z9m50MuY+Am9LYkahxzFKDiRdfAEMgVZIrR5+PIXjDDl/mCMy0F5jSqtbdhfuAnDtdZOn/jnjXeGibk6QleCOfQvaYyKmpsDjs2PhMIIGMFFgREfC0yKDiJtxxiCIByWU/y2LpbtGcD/zakST9LLcn5JwQIo/3bF4wmTAu5xo32+geYn1Yz1LqupXrQ1t5lkrDyvzNOXXAjimtz2FiR8Jam8hCOQE5YwwEsB0T55pILSAZXi72aD0p52tuv4DD5RvP3bCaVtOw2ZdtqnKvdYlIN4DBfgJNObcqhNZKsICusjnLWHmIbRXtpqjykDPBOTijS9h8YQMsp63AfgYwPF1F0mXivZ1BepuaBITGYoYRvA0wpwm6P2BD67zwrfuP+KIJ7d3FOUiNrvFiiOqqtye5jNWeZMvuYwaloUOFI5dRSW9QSSs97DJ3b6qZGiqlWglZIxAGUSr5/4p3VnZSG1HJr+yyXVcReHjUbTgboqRylcDADNsCW9xAb9Tsb7rR/2WALxfImNe9OBhFS1LL+KS+sZaNaHiBTSFgqghIE+meDKF98LpppD2m9ePPf1h2F26ZNOzlfL6ZRkXRUBAAI98j40UECZ9cKDzIDNRiur9xoEUYdXvQt9I3iXAE8M87OTrJk22cewGA4StEo4yMJdZ4DIP5qOp7fZu1jjzCkBozJJdmWDD2FIZbWbYhlbtuoPwx1T0jL3o6eoKPWosJqO+CQGUATgFwBSAiwQ+eq7b/N2yNb+/aeLUtos3RibadfklIYRX6VRBR1RanaKCaihqc5azmuwbWE2eBoJ9lNJvRY8ko97AGkJ0CVcrAfCjBb2f9L9/qbNj4fpMQAMDK5unTHOfRSbtBfZ4x7I/SGaytSaiiShLvW6SrNndtO+HtX8PZjt9ycF9D57PRl73lTi+Ne1L5oNWCD4klztCUNcJb2CfC00WJYxeFRpcSfok2PjA9kgijm3VJQz7CELvsNLvjdn4xkKhYK4dHZkDtzii1RHZhnlKVuem3lzUHkiV/EN4WWg/A6oeClTTl6ESaWDfeWGl70Z4VyC/NONxV8a7JRkf3pXxupPCVQDfIaC1OmZdiUe3PzaWjPnF+FKnf/2GF5DXXlc29meCXVsT3Wa/UHmdatZHopMFeKoMvmcR/mcJpXGLx48DUIeAzJizACuXLSYNz5OUk0fv1ievWBCemgaGZ6CByAsLN64HUQhF958EliULL5ntgWx1FRKShJuIGJNXGZn/nlQKFxgJgZcFYKqbXZ8TGistDu7EV15I1Ir1++h5LSHt/n0fDJSgyAR21CrPzPdA43qauISsePrjwNIHABPU9q0RXLxpDfJ2q8/AfdeIt9RyAwPOgldZNB7RgUYg/OEG/E5LHpcOC4lrp01FiUKRqhg29KuWnualhsgIkQLYyQ5QCNXfYIoDQ61cpla8WG8cYlPskRSOpHAEhSMIHW6EcZRyguCVZJPsWlA1Fw9AoEToG23a/KDxkWVeKcjhpte96yEJX4XQphpuZUConSpURF95iB8IxH934LCbxo+vQ/IZYMbci8aBdmby8IEIUPi/AUYIjHBeptRkZs66vM/7SxgDsrxW8B+heKtj5KQuJacYDWhjqH054/xxEw31ZTKYJNREDmxggQ3wnNv/lqvq/9ElH8ig1tIPLX39p+FJdLKAYtb+KjRaqVhBsG+pcTY6eBi4dwD+jNgVqF9oa5kG74PNHsHHPf11jolEskamPSB0z4qoMYD/8o5WHOWdUDKRo2HYXZM+qOhZR9C/MnCApCVRu3xNVse6E6leHmeVaCbWlpVkUqhmJ6xfoACiCPpvBwj/e2o4zF+6aQsA4I1rVmHhjT9WWAx/6qjPefotsa9a/OQgrZGa2DVWfAvAd2WLHfV4RgvAnCKYow7A63tQPn1O6ED7wS4nyXNc0DYRLPX53GWbngSVRyGbe6qQ4btLAf8RwAukKmft6v5W25v+8ycRJyuAOk0sv7FsbFlQuI98tWc0WcgeLKFCNs4HYmsCnQ6OmX31zD6wczsqJ+YygRHF0kuO+BbEvTWymPqPCROt198KbFE/WfnLn/sjLvzgLHTacPXeTPD+Ts/PC3pWoJSY11eqrv3//veR4PE5799++YZ1aPFEiyMyvh8F97RcDwpz0Pj4VlUufTzDKH5aARaFZMsc6Nps8PnobTXrSXzOEP8oY9pfFxOPBJdu2wDfypKR/34hy7cKvFlgh1SNwitEgR+1z+Q07Noa/T9i8zIW5n3l3LDDu+wPc+ecj+ezx4HQPDRuFtb4QMSn7AP9QXySFweH/tYfSiQbynQBpzVaywWbNuKKNWuQdXZLzue+6qkLIfd5T90dGu6K3AgUpdmMU20m31HpW+MtlUhIl5DlPOj6oxQf6Yi8P1h8SJzGF6jJSt2LCKsS7l99fOIXpsKRD0RRmxwaBLTlLHwmuE201zEO81NPdJAkxxI4m8SU/RrOL/8Kr1+/AUF7YXtY6Pw64C/05GcELHMGOzwhSpU1knCyXcan8S7GYnt/0VVTJ4wNYild44xbxOUl716X/+r8ljyzr7K+MndsbJNTlZXv76TW/FPvugCENGgH0R6fauoaYzQ8uX0fCKO540ue/H5nYC7JGfttb4L28zdsrnv/Fes2oC3vXKY4ZIlX7i0yfJPofg6Y5ylTYoUjjtj7JK2xKpxsY+NWibAH8ypC53Wxwioqh8MKT40GzcxqHL3B2UFief89jKLYHtCDbWykIlHNEC+TMGrQdTismDbnQDuvVNx+/YzZF2nlssUNPX7RxjUA4G4cO/Xp0VtHrlozdef3Af+q5nJ4qoM5hTRHA5pkoJGiaYGQDW2c+tUn8tK4IfVNKyIuRARgjrXSGMBt783+qtsYjnMwowDtPHAzVUUhQ3SGgPOEfF+e6ALIRwDdFJPaXiRujDd+lSisG+jCS/anS9e+iJvGT+l0NN8mNAfAZNZpBlFJAd2PSPX18fptWwHA/3bS9OfedOrz31j8x6k/2pu1x7SU3akQTiF0jCcmG3Ek5VsA5DwNREZBABMZTy8vQ5IWwQpHDi1mjwSxdUdQzQfSKwSALAr6FaD1qHU6ql10XRegIfGoyQRevkYwpH5EvI2VOiJtv4IrE0HiH10hkt2HJrlOemczMrEkuHsok173F3UtrJLtpBfVACMd65899LnA+d1zN25EX3jzmq0AtgLAnt9OOewmALc2OU4WdTKBU43nCfSYLuPHGmEopCZPY6J9zFf7il7eJiXrWVkCc7sQkChEmE6U/KuShdSnuWlfiE9mhEqkvg7g2uVLbhxIiQ1h1tyFIHxeyIwBcMkBNUMmzg1yI8cB2NzfRxduXQtgrbAWuwE8cPWkKQ+sb2o1h3W0txhgZODd2JCcIGja7gyPyZX9Ca0wxxEYA8Rj29P+WV24I5ww1sCsbcRhNnqZNNbSHUOpX55dV005AoSyrWHpTUacjtgyt6sBUqKWExyt2pG7HkX3RMbHeqBak8J6bYu+/fmiv1v/Dz/47gn6m+eeHNTp7AkVwwcmbQnQxsl/Ho7V/0PhH1SRbe/73GDiTRteADZQFwF7ATx44+hxD+5qbjEjSoXmks2MzIRurJXGe5hpHYbHlInjR3h/nMhxaGCvi8/YQ0AekRPubfKRz0Zl/1c9S+LKTtvpjfk+gD8t3NifaLxdN8hQBkUaNcGVq8YmPb3DsfpZptkjixsnjMPCbmKefZ8gKDR373UvKENxkKp+IcnoqMgbC56iCfp8DSOidG5W5jygfPW1U47GZeueaaxKAG9a9yIQhTt68W1nnvbir04+/PrfLX4404T2YaIZE3iM89SkEniEYI7Lw50g4ggAuaj+hrSgx1UIyIxZ56OsHALTPgcwQ/o7TH0OI7UO0CODXW5PcGEZ1gwrAKW7QVwiDL6jUWLyJuBoQCd78NaBlvn6DeuAaNPdG3/WAMCHjpyI1TnwnVvC1qGZ7FEA3inw/YBaejvHgIIHM6Id7uSfNg15WgCgzwGYd8HmsYtvmFzCovWNhd1qCguIidvnRRxbjxKochL2IFg2xj3qvXnCIA6m6KuuHT2vYwJb7oI5yFFfa9uycPMLuGVsUQB+DJqLRJ16KPylFm7bAkRrJoljtBYALmgdinsKJf7biOaW4UH+cIBvFfRhQEN7OhZWzKfpjSfHWueR8VnYbuPcPR9I0utIHWzYH7FZPewR8PbNL7rFE6a0mYq4qxcuE0AgN2rklMksvvRSr5Ufc/lbwXtXQsDYPkVeTMxZ1eaAsqlrLoE+aJuHqKtCBleKPkPhk4Ewr7dqo0McWz3xib3Z/Aqqc+v+juWvHngQeOBBvREoIYqf9xKAvyw85lTcsOrP+PFhR2fGFQtjpWBGAH2awGk9vneszr2gcRUCImYRoH04gTlgJXfcILwKShxjHqbKG0Q74BIbwd0rbsXM2ZcCxH2gdiEJMDzIiMeymdScQt7cOnP2IqxYdkPl+tfGjgeB/FCbPdkSTVZWxTivQFZCMY5smPUeRWu4M8/NS6dNePrErTv1749XT9bff24jAOgOYO/N4yc/ROpJQFmAH+4rhkLsO5AH7EMUSpCyPS6Q2EIgVulfuHjCS981LrsaDcKCEHUSPad1zfle25rqadJAeyy0HpYoAnB9BBxMTFAFYdyuzEEP3Oe7SeSzasae3N512TDzHSD8PsD8QOsggOeD1uyPJx55MuFa8pCaqarjZAwHYicsPfhSBvyLE/x7N1an6pa2PQCgD79UaLtx7FGPlXzzX7LZ7aT0dz1ueDUEAVRTyQJ7jO9PPhBUlUX7j+Ytm7F89FgA2uLpsa+Ba7f6okZNf+GlLU0Cek2z8NU//gl7skOD1vLeI1mb34P1So6uG+ilvc3Z4vBiMR772nHqeSxiQgACzwbwt8EbhIYlSK8BMKKnd5eITXhhzs4V9Y4xe3Jf/93UKXjj2nUAgCsnHQ4PHlaCpktQVh7NFHKV/baKkozr8HiMwO63b1lT+f3GVX+Oan7xmfLicUdtKLDjNx58ISCvsdDEHgewYiHJfIWAGFoAOl7Q8RWb6sEgH6wM7EowX/LqHHCZDddtQgB6WjDPEub0A3E4ZFXDOKu5MxwFcnvt9VabAYERI4DvB8IxhHNOHlG4EMDHsl4LwXkfDC3ppvc8t+ZtxqPHII0Xbl6PGydMLXqaJYHCD1A9RNtOiER85LcsPebBtQKO7FHslehOIvv1Y6z0gfZM+KUbJk4IF23sPQrIbRMmggibygjeRqI5UoJXK+maB74iKlvf5MINVICcA0ysM+hJhFWLLcM4SJZajSH2KO6CeS89h+smTkPJ4tqMx2WELol1AQOpSWNVbjXy3wR1ioF39RIZGQjDiUDSUsFcAbLHjXPh1mexeMKkUMISAB9DD0YysfI2mgfRW09kwSqnd5DG+wqUcFuUJml1XxVXXmvPV4GcaqBe49MFKCLwxQlW7sSIIPYtprfyz5+/blP57kmjEKCGQ0YfrUuUJCApj9AAhJZ72j8Y4P1RGts6G1PFoEQmR31o17DSLc1lVqKmDvchSsZeSvl/AeSIyL99Xw5JzMEXAmPfaqTbemrmRVuexa+nTIcz5olhYflpeE3sLS9J3HcXxVuY/TpIFkI4G8DwSuafwbJgInZC/n4pxN1Lbxt4eY1WK+G9py/eYWAfqCp/BruS+H+yx8Lb46GuHFarPFrgO/JSMe99PivXkvdhS867loxcS86HLXkftmTkWvLe5YaW3UlDy35Sa+j7rraRHkX7gXdwO7fvHrHOkyugvua2Ov+e+pucC94Wcoi5fuJhPT5x69TD4IaPNiHtOyhd2lCSBBEiHzLq3BGAyMahRljz6bGVBGAHy9R3YNiSzyLv/B7BfMtT2/oc3j4gkFmVC1mFHTnv8hn5FiO1sM4n730uJ7xa1h4G04CJQB+ChYruE4A8tlsPNDlEZrw4aH56AICiJbzxTwvc3VC9RlMMdEkxezRunDCp7i2/m3YYMmWBHhcJ5oje97mKPM9Z6PG1w/L40LPPABCSeHb9kdKIwKKNG1A0QbEz4PdcLGrscS4qi1tHGriPCMzcOCHJ1CgY+B0573I571qyci1Wvtv6QAuFZgIjDf1ZGRG/n9JzpschzmNo2cGo77cqNhjfGa04YwHTNgTE/ME01k7YN8g8RbBxDdAgYcXSxfjJfRdLzq0QfFgVnQwu4rPhUBjNER1mzV1UuTZCHkPh2iz882LNkmOdT3TtcA9cvnrMDt4weULd+m4dezgC1xRkvJtJKejJt6ByupL2WujF5iE70eHxh6JBu+Lgaj2B8bOAGW7Er2d952eLvjD2tLcP50+mV7nb68YejtunA2Gxc5R2bf8UxK9KphnoGuIjka2r0lcAYNkjuANsdsWcQVsgODagq0qm8dgZAzPL7f9E1/Uk/5vnn0Vb1mBXk10J6teDUdXCD7y50xu8kGxirPtBYmE2qcWV3zy8uMPeMmF83fKumzIRT01uI4AZAHoVs0XTow4jPF8wwJ5AKNbQploCv6/IRj2M0v4MdwYOmWcFs7o3Y97I0k0AQUv8rXWrL7xrzJHmh0cc3+W+GyZMQamzRECzMt5/mlDQe/1MzodbPPVIrdmxrdyB6lw02GUbCr/LTXsENP/D3hyeKkICD8K/2aA0gwixfMRkEB7Wu+cB344e9xRUDriULvcsH94c9vy+GDkE3h1D6Zgo7XQvYvHIqm9VAMR+BuCxJE9kRUkyWPIeAcC93nCXCQ9+rJtyWICgh7K5pg2EmXYgePBq3CbOpXffELQnuTZxj8fWIdY5qz8JfHPlmboFAQINpE8ftm3k1jLyV1972BEd2c17cFEhUmJfN3Ei2k1nrjl0bzGyb/F0qDdXVcmaQHB1xmF1uzzWqn3ltGzzUoEX9zUSEREBKIyi9JVmmCv+8Y6Wmx3sI9dNnLrNwMurNKrUOf5EA1wA6XTBZGoFAkkema4Ss8TSyj0RIFwOAFJzhWj1lg8k0c5ZmZNv/vspXxCAxZMmx850/fCQEULI/EHCc41Kmyp8WZ1q3rB2DX43dVrYEeS+lw/dAgt/zEBSQN/8w6sk8kFR7wPE+iJHVvLOU/pI0TZt9MZcef2k0W2t5ZGYtzU6s900djoKpUz2+LW8DMR7Ez1Gj8cOEZ5Y25n1T3ckXGEv+pJuX/Okfw/E+TdPmGYQ+380qlQXvRHMc5kw+/syfLhow4vbbpg4ZYkRXlM5LNRrTPUVmJzx/ifztr1wJWRuWzx+8jrCFwWblfzEEZbzjMc7IUxVr9rvaO16Ap58AMis7hLHq6Zigf2a5ss3r8Pi8aFE/hTgJYBO6XFfEoAoxPsoAJ8QzIN78tpjWYKBVnsGaykeF7WX9V4YRNGhcSJl/53KfuFbxx727IQ26I2RpRZunnIELli3GrfJHu7k/gHQxF7zHEbd9wSXB3PnXogyLCw028OMHMwNNjqDquhdeSW9wfLljflIDCaUAWS0jsY8BM9pB0SGmxw/hFcTPA7C/cmlUzq34MbhUwBhpYHfRmB0A97I4yl+N+MLr99V0p07xzSv/j6mt5WhzI7QHTZcOs/TnU9iaJRBsEeNOADBG93xyXM2vvSfd0/CscGQvR76FoXXAhhVkyoIvSnzKAYETwd4OqmSpCIhGSFPmCxi/YBRlcvr8dUU4Y182eCXWTd2YzH3AprDYch7wvZBBBKBg6hTKZ5acSBDP1euTBHAExCe68+Dtel2u6MQ5HDK5rWr1gwb/T0AX4+C0O3fGxVG5PAeA2wywMS+7hcwCuDXKVyyp2nYHXtN+Zn/mjJ9L+WDrXJTR3o3T+JFgIb3XlB8mgeXbm8asjG7pxOtMsiY6pzWV6LHpjL0eYgfrr2J/XF+lQGBO5zx19IrvHnCJBC6lsK7AY5WXxyqBAuNF/AZSB8mtAtkEfJZAsMptPouhGPf0modJ0vGFnfn7O+MR2FIKZP0aD9mtCvamccItK8tmMx3jfA9StkalqNmgGPfi+ivBaUAl03b3f7zx0e3YFVT55bT9piVTU7H9azTZEUPKvIKoHzCYbu5eJsJHvzRpGlbqMC9aM2I6ydNPSXr3WUATmhomoh1nrw1cCAsfItg5yYyt2pb9p8LqU4C15L20UMVjdF4i6xpLUlaCeCyA1VPHDJghIDZQZC9/+wZr8O9K28HABSiiK2PN4tLQLyxMj71ygHilxitJBa2wCxs9r7ogdATxpK5QDK9cb6ojj1C69e35/i7f/jzBCzYsgE3TpkMl/XL2G6/D+DzrHGq7dlIMtlUEs7YZwlkUcmCFj1pgC7e2IkyvrbsiDUGrLBStL+W3YEr1uzBTUdPQqkseK/qQa9XO8JYWNJry3tGnPek/1b9vYhS3vn8M7h5/BRYj6tAXCZodjRP/felKhmDv7TmV716b+etOa/39uR6S0ZcSDxPzQDObymWzzdepawxZUYC6pyFN0m/0cMmnLi5CdjWafnr0R1tbhMNvPEYSvQZa5+xiJY+np8us9bbCES+Esn9RogJiUOIAB54EPDXA3pfz3VXxyGqDwDVArAlup70rssd3b5V/06Mf3JlLWsVbzUSLt80eFL4N256AddNngKR12RD/wYRC9DTYTD29RKQC6RPbBjeumRUGetmFVq8k64m3ZsBDOttt44OrR4UjgnEY0Z450SUCCcXukzgfQZSl/e52xTF5SQvHa8PaZ4wAuFhjvJeJws+ts1PAt8MwqZPPeRzbiOCg2uvn+D+lbfBw0Hy9wnaeQBUIEC8wUYfMyd0viXIVI1c/v7VF6AZLBRt5vse9qVIlt7LqYyxjJFEzgN553PNzrW0hq6pSd4Eqoae65Ftjf7xkv1xVsVHmsrRTQvXrUemLRMamW86mms8TEWG27tanTWbQCJz7fm+RFdbOeNVRExESK4vW/1j2fstzGUqRfquBfXeFkUeB11kvQ19VHcTaQQCYpFGz/dkfYDdebxUyJhvhgZ7+1VBDVqdx5m7SuW8sz80sBsiRqv+DJHVsaCIfOiQ9T7bGrqWltA15Z03NjatrYSzqNe7+NBhhJ93Gt7vBZQtULJRMMW6O0I946GkLTWf3uckOWoo3nvikkgs2rwGoCmVTfBtgM/0tk671tedu6geNbp/9hmJisUbt4j4j5awtCtfLuzvVPaI0DYjV/I7BX4bMrsr87BvzyprN+N0Sq7o3zd8b45eHt7gHgnX9rVbJ29jEj8t70Pb5FxT3ofNLWE5Y+JEVj0Rj2R/AwAPPi3iB4F3oSEtSHsuaMYN5uBU0rsIK7OlprLJ9TsQ6aDBGMAYPEMeSEV+PIU0Jws6unYZPH/bD1Ag0WayK0n/HQNf7vNMyu6LPxYNVdyAWb3UrRWJsl7gDd757wYdOb9oQ9XT96Ita7A3wLb2wH5GwOJ9CjgAIxOdrgDKbDPKfO5fL92yvJA1uHj18/tX6IDPNkJj6au61llr918P87e+AOOzKDB/mxGuAdAnce4JpWAISrk5f/K0XwN9oUr8eimtxlCheqjpo9EVpYiHjLvNm+Dro0OFb1q/Ds0uDqboqrdWlOgDnYLaZidK+Rpetdo8j2bf/piD/sHT7Ih+VNWYYjCguMzYBVxAh4h/ac9yaTkgLtrW/0SWfeH1a1ZByMOGLXcBuDbZ5ut3KeGgCEe9d2e+7TUuOhh3huC/e8NHFY9Lb5GtqgS+y6BXRV09PgQAHpB2APzHEcVtfymxGUZik4R5kdLE1HwGujwEwG+X1wNOZaxYfMugT0CjsLRYcVfzDkD3HyhRWvWszbEkZggWs2a9rnL99RvXYGx5V2hU+ibhv48oJxv6fANqT2m1J+4u41z7Z6z3oG71xv6fjA22XVL80j7F7h07GiPKhTUG+JvQ6GciSlEYkTrLr/+Cnsq/qjnZAlwn8BN0Lb/50u8P19teWNeto4cKDXYw2TT7uP2N61ZjSNhR8OR3ALN+PwcRCzc+gUz5Tk+4HwLhtwAUWVFCdPWn6SouSv7tyjf22PVYJEhguYw+KZY25ZraAUSxMEIkIpCaCgZ9uuJCa+SySZ8u27gGu0wTdprs1QL/HsD2yKIvORUPkIpUTtiV+ts9+NWQ/EGTk79k47qBld8LLtryHAqZvcUS3Xcgvz46aNXnQiojQ04JaP7WGp+3dGixegrEJwk8U00G1ZfeqYYH683XI6GpAgizQ9QXyj64entmDC7f+AyMoGM8dKrqeDAOaE4EeO+fKhbbnyuWOgZe4ACw9M7rMGNuCQJXCigdkGM2as4O4lzjOvKeXa0EL9i8BYHnXsJ/UdD/C8ltHkQSYTc5QfRnQ6sK5Ss2nZ0lq5+0G/fBgul84bmmJmDXR/Z59P0P/xnnb96EzsBtKBh8HDSfFrk68bxNTrr9iWosKf7E2oU4h56I0BNLYPi2h8aMuGpXS7u7aMuzB2QOGpml7oPoUQ1wVx3Xbp/k6ZpDW28oZ/J45JSzHgqN/bGn6fd5Paniws3rUTauo8zsl0XzRcBsjqabSCLtxiaVja2aLv2K5tYRRRG/Esx74YKngTzmr44O+iUjFK0Q1oafPRCvT8Um2cezxC7j/IaNazAcofPkTwW8X9DjFQ5SAzDQ7/a+eeJ5wX+saIP/cDSFRQeQeCQISiWEuzY8DOmn8WD0/L7F50cZXV425rxAQME1oTRs/TJS7wS4zFdyy9ezGmtkTKpLhIkVHfU0oQ/5IPxJNuhwizZH42IAzAUwscZIcRCGJFG48r7R40/c5X35gE9CX/DewPvgEQgbDpg2RpUwgad6NB+exCWrxeu2bEaJwV6j8F87rHmTgOsA7qmEooe6znudTax6qK8lPCxLvD80/CCN+USrseveuH4LPrl6Va9Nfv26Tcj65r02HPa9tqxZ5Gn+A8JqKkrB2sV7vC9mKZFBA7G4h2UIDwv20wXDN8vbldM7d+ltL7xQb/Dip5I/1finwTWbEGhWOwZPIqSFyMrhvir6qYqAYusfJqmP+sJla57DSQ89IMn/D6U/s4F+JCdP0tck8ImczwDb4ZH5Zgi+QcTvAOzqemBvYAwqJ+1I1ykwhPDnksFHHfhhD//8xZvWY+GG6vxUw9HXMh79mZv+ICaGEBhHa6jFoo1rUQrK7qJN465z5OWe/E/Kro+iJviaGE29b52Vg1qSdCmivls99MOS4WV789mfEWHp8g1remimushoiL773BvTtnDbS2gaPkme5n8APgok9LSnNUJQdqiR+ZSzdrSxnbDtU1AKWx8oM/OWsuWXBK6C4KMDXbe+14xRt20lbmz1qie2hnD/XQYvX/K6w64umUx48YZqoMoA0CUEbaIIbnQx9kRqkkhHBIqkvbt994t48IEV/VxIg49QFl5ufZP1D0OcPihpH+sMSixjnATLc0T+5bXnXo777r6my20LN23EIwZhYdL0JVblBwR7poEWim5GyMwRgIZaH9kz1o53lcGJ5jg0tixicwD9EZ7XefD2GRvWbF1y2PG49MXGI9ReuvE5APA3j5/wF099nt7+UMR8EueF5CmAHU+oqRLyuVufq9pVwtEWDPxGwP8R4GJPuyTwxU2Bz+iCLS/22IYiA5SMaS/B7Aw8XaJUJyKv38RKJzGjFaPfTUX52rfRR2TXT4Q09GSBQskZg4INfLMLd1hypycc4jp9zNobAR6wntxZNLbhhZOBR4lcJ+hbZdp/B5ilJCVK45hmRnYQkam0qN2OZp8gYpdsXANcDHfzg0feXYZ9iCifKmqhJ2c5mKMyXsMMvKlapu0LESgblimzNVD4oMDrRXPbiMzOTWU3XAs27RsyvGQMHOlL4M6S0U4jOddz++GZzFkUVoON5MOOFbhhpOoPAOw2pOplfXjD2o0ANuIGP/G5kP7vLcxPPcKFBv51njxe4sgAssm67MnS0ZMuJHcF0ioCd8rwxpDFx/K0pctf6J3rcDRwAELavQB2eTIkolAi7NZnCvA0tgzbIfascysFBs0FvVjO4LsSvwJY6+PcQNW1WPsukMbrOCd/YYuzv1jbQnxozSrcNmHqZuvNv3UCvwHCBYA53xmcQmFcIOWSw1297S+2PpOj2UvoGUJ3hDTXbgv4aM6j9B8/v3efZwKANwNmSaMvRWXOe/xd8ZLCXgn3HShxUX9B7EFTNl9kiO964nEcoIbFZxoDuPV22DaUN9U34T/ZA1j3AgC0Xzd5yhLALCvDjCja7OEZXz6m1bvpnpzowREimgEGFDyhDiO/DeSaTpt52pNPZl24rj3D4hE+i5EA0A/iUYsLN28CAHf9yNHPdY4Y91zQufd/nDETnbFH5X14ZD500zzNOE8OVeTNTEBlA+0xwlZPvLjX2FUZZ1flTbixbGz58nUvNFT3HmOx29ifDoG52ZMCDcoErBwCEmFMIjJQ9ALTI+s9muSRifb8hqREDgZ7TAaeFIU1oSE6bLDdCe8OgHwZkoWHAVEmYRDl6AxJOqKjk5m9jXo1XLhpA66cfBgIXe2UeQhAJqBUpgHgkZEgGIQAAgk0hiHVFgQo1rXRvgm4EM8BQMdN48evzJdx9/aW3PAS7eFDiu7orPeHi2aiI0cKbAEYxEfXDuv9dlFr92QyT8PxyaFhsKaUGVKw4RYsfCEJ/LwvdhsLZ/hSq+y7MjS5AF4l02P7UaZg5dEEh1wdLqI3dNCiREsj7DUw5d7GedHmjQAQ3jj2qCdG7Truyc1jH/pOh8x0hO7Y4eSRBCZ7ciSIlogo0VHoMPI7CGzoAFbvCTJPtco8P3lv+56duawu29JYxOlOEO0jgQ5jv+7An4UwysijCR5Z7WssVKJhO7ObfS/9uXzdOvx60hQA/BVh7gWDoETKysGCiNaMQwZASAtPDysy40o7Hxm7maOK4wUACzatBQD/+2mtL8hP/X7Od/y0g6XJxRBHDxeOzBpOFTBG5FCAOVBUlGt9t5E2OfC5PdY+aZh5ZnxHcUdHYPX+DT2/w4dSc/m/Fsce+U7YwNI7D0l66rlf9LuMvz39EuzODuHRu5+3Ta5gAk8SVNEa/2LrNDek3KZ/e/jgGSacvOhLePiGr+DLr55jhhU7rFVIMKSnVXvQ7B4Y/Wo/prBTP37gNwdzqFPU4FOnvgGFXAun7nrONLmiNRGVVCfpN3CUa0ZJ//b0XYe6mQcc/9+J56MjaOHEjvU25zpNJFvJqGzyfme2xWV8qC8+ufRQN/Og4/KLP40/3PR1fPX4OWZ4aY+1KhvIoBgYvzOfc//4yL165zkL9Yt7bzrUTU2RIkWKFClSpEiRIkWKFClSpEiRIkWKFClSpEiRIkWKFClSpEiRIkWKFClSpEiRIkWKFClSpEgxyEgdCetgydiTWQyEzkDY3iR9YNXjh7pJKVKkSPGyQ7A/D31/0lRIZAv8UMdyxldzGJoo/BxpENAZywKcaSrn6B1NR9Yx72VMCLZlZHKCCcoB2oPQBgyZdYHpjDLamLy3piSPcuBskzcohwyKmZB50frQsNM6k6Msw4CdxtkMPY0LbJGepLMZBaYoUcbZHCzLnrZlWJZHFEqBiUKvWpKG8gaijYLX+IAQi9gaEHZJSyl8aFfz6EM9RylSpEjxssR+EZAsDN6zaYOunTDpzRlnPiR4E8XnkkVESYwIU6IQ0pqMEUmYIomMkbGWHGJAK5ogAIZZWtAgA5qQpDdgxtF4GJQtTDYO81oKMgi8SJClgAgABjQsWkNCCAwZGktvLLPOwAMs24BZD8gb+tDBKE4XAxLySMKXR0gisGmVp7tZg5EWJUWKFCn+l2K/t8cbJk3D/9/evcXGcZVxAP9/Z/ZiJ3ETJU2UpKlKqwoh9a0SD7yABEioTVLcBoFK4QEey+WVN4QgaZsoSkK49YLohZREIkJRImi4KIIGQqtSKChQSIXt2Gs7thPXTeo4uzvn/HmYnfXabmgSr3c29v8nOQ8z2dkzsjSfvznnfF8wuzPnedgY7q01XJ5x5WBphbvpE0arHeGs6r8Gx6T6ZpjRJKbWyS6p8VmrMcf64NNLzG4z6q5yvN53uP69nG6CDIBmZRq/hkrxmbizjO6BwWx+MyIibc7d6AfHVzjk46neqXz8be/CRDAiuPSnVoq7sdHRnEqUVzsOoN6T/T3Oce7nOeNaVz/WWLK1sT7/dB8IIABHY+QP+YJX8BAR+T+iG/3gkQsT+HzXargQ9TrDrQZ8JMkIWE8Nphv3TD+uZyQE9Sbus9KEeg/ntBX87MYYM89Pt2Wc/Zm5x+eMoeH/BFh/JbKvO/q+7hZ0IhMRuZndcAYCAFuGB5A3VhzcPgd7dearqtprJqY9etNYkrZItIZzaevT2hQ8Z56DWdKv2KabB1nDm6e0wVLjT/04Zp0D6q2XWesxnnw/Y8C++1Bp4PVyrjPr34uISNub9xTxS+s/BJ8bA9i51cgXLGBVOuvBhrkFs+nXR22FSfO32NlLjKIvABzv7u/PelQiIm1vXhkIANx37t8IKMI7Hg+wH895JVVvtd5+wSOZFTEQNuKd21mo+vF/rC3O+7oiIkvBvAMIADxQGkIIVq067POGU/Xso74Ci22XfLD2GowGVpw97VetOVnp6MQ3X38r66GJiNwUmhJAACBfibDCh0FH7gAwXp+wrs1jtEdn9EaWzqecIvCj/Pj50N2r4CEicq2aFkC2jJ3F5agD7xaX/Sa43DPTOzTYbskH0r0lhL0NRI+t8GH4Ul4T5yIi16NpAQQAuks96KhW4xhuPxlOJSuxrLYno10QZLLiyxufn8q7317JRfhi35msByYiclNpagABAOswVPDuUNnF3wmG8+lyWWuTGJLmQ4T9zczv76xOVT9d0qorEZHr1fQA8kBPL3yxCxdXrP1dMPcUUKtY0gbvsdKJcwebNNqugrfeK7Ys62GJiNyUFuyxfnTjJgTDhog8GBEf48z95JlI9jESBjwbu/AVAFNbh4YzHpWIyM2p6RlI6s2VnbilWh32hh0BGAMAkiCze5dlJGj2n6q53Z6RgoeIyDwsWAD5xptvYSK/HJNu1Ylg9iQBmjmYZZOHJNV/USa4p9Nf/hdtwW5dRGRJWPCn+dGNt4HAujxx0GAfb33+UdstaIQBh73DlwFc2jqoSrsiIvOx4H+GL6/m4RGPxgg7PDnS8tdYrHUfMfYHF+8K8AoeIiJNsOAB5BNjfTCfw2TAH0D7IWDB6iVOWoMwT0Tf/+DtI3/JhXLLvldEZDFr2YTEsfUfAGDrIoQXAf9JgkkbjgUcQn3VFfFrD/eIARc2j6jPh4hIM7RsJrmcK6Cj4EatkN9OF43AbGGTENaLqYzEFp6Inb/QVc16IbGIyOLRsgDymdIZTBU6EO748EkP7ifhaQtTZLHeb91Ig3u6GionXSA+Oq4d5yIizdLyP8mPbtgAArdGiA4Y8KmksKE1byRpN8Kk0u6fYPnPghzaPKzgISLSTC3fDOHiAqIodx4O22kcqvcMaVYqUr8c3/EWdnqbHELQng8RkWZr+ZN1y9hZhFBGHJVOEfweQJ8UXJx/ECEA1JcIu+cuR3Y8ZgGbR/pafZsiIoteZrPKxzauB83WGN0LjnY/kKyYwjx2qidl4w1g9EaZbpuRPQ+O9mV1iyIii1pm73YO3X03HO2CN7edtMFae9kbxlqhdiMnvWFXl1V6Koizuj0RkUUvswDy4st/RMU6cGLdPa+A2Afc+NOetYl4whA7+3kU7EiVOXxutJTV7YmILHqZb4w4vOl2EFhdDP65iG5rmolc98AIeODMlShsywec7h4eyvrWREQWtcyXJy3jJRhtPDbsiMkBoFZ2/VovkKy4gjdWyLCns3rxdPAdWd+WiMiil3kAuX9wAufiMh4sDb7q43gvgOq1ph9s+PeK2bGh4A+OcDkeGu3J+rZERBa9zAMIAHx1ZAS/2nAH8lHxWcB+Cdr7ZiFpnauE9XfS7dqYz13859gTWd/0/pyIAAABiklEQVSOiMiS0BYBBADO3nIXCvQTwewxB/ZdWxJiMJh3xA9w8a7XnM9jD76U9a2IiCwJbRNAHj3ze4wXDZuH+1/zxr0AqkmGMTMPSTcL1golwhtOlF3uJ2FlL7dow6CISMu0TQABgIcHSjiy7jZc8e75MsOxUFuSNfdlliEpw8hRx/D4srh8/vTqlVkPX0RkScl8Ge97+dmmjYjJe7sQHS543Glo3KGeBJVgpHdhB+m+FYF+65CW7YqItFJbZSCpIoq4J0z8NQ/bbQ4VWGMWklZL5J8JPgnzCh4iIhloywCyrdSLc9E6wNyBABxJ5j2ScyRBwzsw21mkG5wy7fkQEclCWwYQANhcOgv66sUq+LhH+C8AoLa018N+WrCO42AOD5f6sh6qiMiS1LYBBAAqlsea8eE3KuBugGUa4YC/G21vJZQr96lJlIhIZto6gGwbOou3u9YiX/EHjO4XgF2GYVent55yPmQ9PBGRJS3KegDv59DlSTyyak0FsAEHlPPkU7RQ0cS5iEi2/gdz/Ro1f3ljFQAAAB50RVh0aWNjOmNvcHlyaWdodABHb29nbGUgSW5jLiAyMDE2rAszOAAAABR0RVh0aWNjOmRlc2NyaXB0aW9uAHNSR0K6kHMHAAAAAElFTkSuQmCC';

// Fonction helper pour ajouter l'en-tête avec logo aux exports PDF
const drawPDFHeader = (doc, title, subtitle = '') => {
    const pageWidth = doc.internal.pageSize.getWidth();
    const logoWidth = 45;
    const logoHeight = 22;
    const headerHeight = 38;
    const margin = 12;
    
    // Fond dégradé simulé (du foncé vers le clair)
    const gradientSteps = 8;
    for (let i = 0; i < gradientSteps; i++) {
        const ratio = i / gradientSteps;
        // Dégradé rouge foncé (#7F1D1D) vers rouge vif (#EF4444)
        const r = Math.round(127 + ratio * 112);
        const g = Math.round(29 + ratio * 39);
        const b = Math.round(29 + ratio * 39);
        doc.setFillColor(r, g, b);
        doc.rect(0, (headerHeight / gradientSteps) * i, pageWidth, headerHeight / gradientSteps + 1, 'F');
    }
    
    // Bande décorative en bas de l'en-tête (gris foncé pour contraster)
    doc.setFillColor(55, 65, 81);
    doc.rect(0, headerHeight - 3, pageWidth, 3, 'F');
    
    // Logo (à gauche avec fond blanc arrondi)
    doc.setFillColor(255, 255, 255);
    doc.roundedRect(margin - 2, 5, logoWidth + 4, logoHeight + 4, 3, 3, 'F');
    try {
        doc.addImage(COMPANY_LOGO, 'PNG', margin, 7, logoWidth, logoHeight);
    } catch (e) {
        doc.setFontSize(9);
        doc.setTextColor(225, 29, 72);
        doc.text('Auvergne', margin + 5, 16);
        doc.text('Ascenseurs', margin + 5, 22);
    }
    
    // Zone titre (décalée vers la droite du logo)
    const titleX = margin + logoWidth + 20;
    const titleWidth = pageWidth - titleX - margin;
    
    // Titre principal
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont('helvetica', 'bold');
    doc.text(title, titleX + titleWidth / 2, subtitle ? 14 : 18, { align: 'center' });
    
    // Sous-titre
    if (subtitle) {
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(226, 232, 240);
        doc.text(subtitle, titleX + titleWidth / 2, 24, { align: 'center' });
    }
    
    // Date en petit en bas à droite
    doc.setFontSize(7);
    doc.setTextColor(200, 200, 220);
    doc.text(new Date().toLocaleDateString('fr-FR'), pageWidth - margin, headerHeight - 6, { align: 'right' });
    
    return headerHeight + 8;
};

const ICONS = {
    dashboard: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zm10 0a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>',
    stock: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>',
    tasks: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>',
    orders: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>',
    planning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>',
    inspection: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
    settings: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>',
    logout: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>',
    search: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>',
    bell: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>',
    chevronLeft: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>',
    chevronRight: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>',
    chevronDown: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>',
    plus: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>',
    x: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',
    edit: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>',
    trash: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>',
    menu: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>',
    more: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/>',
    arrowUp: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"/>',
    arrowDown: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"/>',
    check: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
    alert: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>',
    barcode: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7V4h3M4 17v3h3M17 4h3v3M17 20h3v-3M7 8v8M10 8v8M13 8v8M16 8v8"/>',
    eye: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>',
    users: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>',
    folder: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>',
    archive: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>',
    download: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>',
    upload: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>',
    filter: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>',
    refresh: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>',
    pdf: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>',
    print: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>',
    link: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>',
    copy: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>',
    user: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>',
    clock: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>',
    location: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>',
    mail: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>',
    send: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>',
    camera: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>',
    file: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>',
    clipboard: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>',
    checkCircle: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>',
    mapPin: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>',
    // v5.1 - Nouvelles icônes
    chart: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>',
    qrcode: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>',
    history: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12a9 9 0 0118 0"/>',
    code: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>',
    // v5.4 - Nouvelles icônes
    map: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>',
    ai: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/><circle cx="12" cy="9" r="2" stroke-width="2"/>',
    chat: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>',
    scan: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h4M4 8V4m12 0h4m0 4V4M4 16v4h4m12 0h-4m4-4v4M9 9h6v6H9z"/>',
    presentation: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>',
    // v5.5 - Nouvelles icônes
    truck: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17h8M8 17H5a1 1 0 01-1-1v-6a1 1 0 011-1h9v8H8zm8 0h3a1 1 0 001-1v-4a1 1 0 00-.293-.707l-3-3A1 1 0 0016 7h-2v10h2zm-4 0a2 2 0 11-4 0m8 0a2 2 0 11-4 0"/>',
    route: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/><circle cx="7" cy="10" r="1.5" fill="currentColor"/><circle cx="17" cy="8" r="1.5" fill="currentColor"/><circle cx="12" cy="14" r="1.5" fill="currentColor"/>',
    video: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>',
    nfc: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 9a3 3 0 016 0v1a3 3 0 01-6 0V9z"/>',
    palette: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>',
    keyboard: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h18a1 1 0 011 1v12a1 1 0 01-1 1H3a1 1 0 01-1-1V6a1 1 0 011-1zm3 4h2m4 0h2m4 0h2m-14 4h2m4 0h2m4 0h2m-10 4h4"/>',
    wifi: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0"/>',
    wifiOff: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 20h.01m-7.08-7.071c1.953-1.952 4.503-2.928 7.07-2.928m7.07 2.928a11.95 11.95 0 00-2.929-2.929M1.394 9.393a15.935 15.935 0 014.265-3.169M22.606 9.393a15.935 15.935 0 00-4.265-3.169M3 3l18 18"/>',
    image: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>',
    // v5.8 - Icône bâtiment pour parc ascenseurs
    building: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>',
    list: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>',
    grid: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>',
};

// ==========================================
// SERVICES v5.7 - Nouvelles fonctionnalités
// ==========================================

// Service Mode Hors-ligne amélioré avec IndexedDB
const OfflineService = {
    dbName: 'stockapp-offline',
    dbVersion: 1,
    db: null,
    syncQueue: [],
    isOnline: navigator.onLine,
    
    async init() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, this.dbVersion);
            
            request.onerror = () => reject(request.error);
            request.onsuccess = () => {
                this.db = request.result;
                this.loadSyncQueue();
                resolve(this.db);
            };
            
            request.onupgradeneeded = (e) => {
                const db = e.target.result;
                // Store pour les données en cache
                if (!db.objectStoreNames.contains('cache')) {
                    db.createObjectStore('cache', { keyPath: 'key' });
                }
                // Store pour la file de synchronisation
                if (!db.objectStoreNames.contains('syncQueue')) {
                    db.createObjectStore('syncQueue', { keyPath: 'id', autoIncrement: true });
                }
                // Store pour les données locales
                if (!db.objectStoreNames.contains('localData')) {
                    const store = db.createObjectStore('localData', { keyPath: 'id' });
                    store.createIndex('type', 'type');
                    store.createIndex('synced', 'synced');
                }
            };
        });
    },
    
    async cacheData(key, data) {
        if (!this.db) await this.init();
        const tx = this.db.transaction('cache', 'readwrite');
        tx.objectStore('cache').put({ key, data, timestamp: Date.now() });
        return new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = rej; });
    },
    
    async getCachedData(key) {
        if (!this.db) await this.init();
        const tx = this.db.transaction('cache', 'readonly');
        const request = tx.objectStore('cache').get(key);
        return new Promise((res, rej) => {
            request.onsuccess = () => res(request.result?.data);
            request.onerror = rej;
        });
    },
    
    async addToSyncQueue(action) {
        if (!this.db) await this.init();
        const item = { ...action, timestamp: Date.now(), status: 'pending' };
        const tx = this.db.transaction('syncQueue', 'readwrite');
        tx.objectStore('syncQueue').add(item);
        this.syncQueue.push(item);
        this.updateSyncBadge();
        return new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = rej; });
    },
    
    async loadSyncQueue() {
        if (!this.db) return;
        const tx = this.db.transaction('syncQueue', 'readonly');
        const request = tx.objectStore('syncQueue').getAll();
        return new Promise((res) => {
            request.onsuccess = () => {
                this.syncQueue = request.result.filter(i => i.status === 'pending');
                this.updateSyncBadge();
                res(this.syncQueue);
            };
        });
    },
    
    async sync() {
        if (!navigator.onLine || this.syncQueue.length === 0) return { synced: 0, failed: 0 };
        
        let synced = 0, failed = 0;
        const toSync = [...this.syncQueue];
        
        for (const item of toSync) {
            try {
                const { table, operation, data } = item;
                if (operation === 'insert') {
                    await db.from(table).insert(data);
                } else if (operation === 'update') {
                    await db.from(table).update(data).eq('id', data.id);
                } else if (operation === 'delete') {
                    await db.from(table).delete().eq('id', data.id);
                }
                
                // Marquer comme synchronisé
                const tx = this.db.transaction('syncQueue', 'readwrite');
                tx.objectStore('syncQueue').delete(item.id);
                this.syncQueue = this.syncQueue.filter(i => i.id !== item.id);
                synced++;
            } catch (err) {
                console.error('Sync error:', err);
                failed++;
            }
        }
        
        this.updateSyncBadge();
        return { synced, failed };
    },
    
    updateSyncBadge() {
        window.dispatchEvent(new CustomEvent('offline-queue-update', { 
            detail: { count: this.syncQueue.length } 
        }));
    },
    
    getPendingCount() {
        return this.syncQueue.length;
    }
};

// Service Notifications Push
const PushNotificationService = {
    permission: Notification.permission,
    supported: 'Notification' in window && 'serviceWorker' in navigator,
    SETTINGS_KEY: 'stockapp-notification-settings',
    
    // Méthodes de compatibilité avec l'ancienne API
    isSupported() {
        return 'Notification' in window && 'serviceWorker' in navigator;
    },
    
    getPermission() {
        if (!this.isSupported()) return 'denied';
        return Notification.permission;
    },
    
    getSettings() {
        try {
            const saved = localStorage.getItem(this.SETTINGS_KEY);
            if (saved) return JSON.parse(saved);
        } catch (e) {}
        
        // Paramètres par défaut
        return {
            enabled: true,
            sound: true,
            categories: {
                tasks: { enabled: true, label: 'Tâches assignées' },
                reminders: { enabled: true, label: 'Rappels' },
                stock: { enabled: true, label: 'Alertes stock' },
                chat: { enabled: true, label: 'Messages chat' },
                system: { enabled: true, label: 'Système' }
            }
        };
    },
    
    saveSettings(settings) {
        try {
            localStorage.setItem(this.SETTINGS_KEY, JSON.stringify(settings));
        } catch (e) {
            console.warn('Failed to save notification settings:', e);
        }
    },
    
    async send(title, options = {}) {
        return this.notify(title, options);
    },
    
    async requestPermission() {
        if (!this.supported) return false;
        const permission = await Notification.requestPermission();
        this.permission = permission;
        return permission === 'granted';
    },
    
    async notify(title, options = {}) {
        if (this.getPermission() !== 'granted') {
            const granted = await this.requestPermission();
            if (!granted) return null;
        }
        
        const defaultOptions = {
            icon: '/icon-192.png',
            badge: '/badge-72.png',
            vibrate: [200, 100, 200],
            tag: 'stockapp-notification',
            renotify: true,
            ...options
        };
        
        try {
            return new Notification(title, defaultOptions);
        } catch (e) {
            console.warn('Notification error:', e);
            return null;
        }
    },
    
    // Notifications prédéfinies
    async notifyTaskAssigned(task, assignee) {
        return this.notify(`Nouvelle tâche assignée`, {
            body: `${task.device_number || task.location || 'Tâche'} - ${task.event_category || ''}`,
            tag: `task-${task.id}`,
            data: { type: 'task', id: task.id }
        });
    },
    
    async notifyTaskReminder(task) {
        return this.notify(`Rappel: Intervention demain`, {
            body: `${task.device_number || task.location || 'Tâche'} à ${task.scheduled_time || ''}`,
            tag: `reminder-${task.id}`,
            data: { type: 'reminder', id: task.id }
        });
    },
    
    async notifyStockAlert(part) {
        return this.notify(`⚠️ Stock critique`, {
            body: `${part.name} (${part.ref}): ${part.quantity} restant`,
            tag: `stock-${part.id}`,
            data: { type: 'stock', id: part.id }
        });
    },
    
    async notifyChatMessage(message, sender) {
        return this.notify(`💬 ${sender.first_name || sender.email}`, {
            body: message.content.substring(0, 100),
            tag: `chat-${message.id}`,
            data: { type: 'chat', id: message.id }
        });
    }
};

// Service Calcul d'itinéraire
const RoutingService = {
    // Calcul distance entre deux points (Haversine)
    calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // km
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },
    
    // Algorithme du plus proche voisin pour optimiser l'ordre
    optimizeRoute(tasks, startLat = null, startLon = null) {
        const geoTasks = tasks.filter(t => t.latitude && t.longitude);
        if (geoTasks.length < 2) return geoTasks;
        
        const optimized = [];
        const remaining = [...geoTasks];
        
        // Point de départ (première tâche ou position donnée)
        let current = startLat && startLon 
            ? { latitude: startLat, longitude: startLon }
            : remaining.shift();
        
        if (!startLat) optimized.push(current);
        
        while (remaining.length > 0) {
            let nearestIdx = 0;
            let nearestDist = Infinity;
            
            remaining.forEach((task, idx) => {
                const dist = this.calculateDistance(
                    current.latitude, current.longitude,
                    task.latitude, task.longitude
                );
                if (dist < nearestDist) {
                    nearestDist = dist;
                    nearestIdx = idx;
                }
            });
            
            current = remaining.splice(nearestIdx, 1)[0];
            optimized.push(current);
        }
        
        return optimized;
    },
    
    // Calculer la distance totale d'un itinéraire
    calculateTotalDistance(tasks) {
        let total = 0;
        for (let i = 0; i < tasks.length - 1; i++) {
            if (tasks[i].latitude && tasks[i+1].latitude) {
                total += this.calculateDistance(
                    tasks[i].latitude, tasks[i].longitude,
                    tasks[i+1].latitude, tasks[i+1].longitude
                );
            }
        }
        return total;
    },
    
    // Ouvrir dans Google Maps ou Waze
    openInMaps(tasks, app = 'google') {
        const geoTasks = tasks.filter(t => t.latitude && t.longitude);
        if (geoTasks.length === 0) return;
        
        if (app === 'waze') {
            // Waze ne supporte qu'une destination
            const dest = geoTasks[geoTasks.length - 1];
            window.open(`https://waze.com/ul?ll=${dest.latitude},${dest.longitude}&navigate=yes`, '_blank');
        } else {
            // Google Maps avec waypoints
            const origin = geoTasks[0];
            const destination = geoTasks[geoTasks.length - 1];
            const waypoints = geoTasks.slice(1, -1).map(t => `${t.latitude},${t.longitude}`).join('|');
            
            let url = `https://www.google.com/maps/dir/?api=1&origin=${origin.latitude},${origin.longitude}&destination=${destination.latitude},${destination.longitude}`;
            if (waypoints) url += `&waypoints=${waypoints}`;
            window.open(url, '_blank');
        }
    },
    
    // Estimer le temps de trajet (basé sur 50 km/h moyenne en ville)
    estimateTravelTime(distanceKm, avgSpeedKmh = 50) {
        const hours = distanceKm / avgSpeedKmh;
        const minutes = Math.round(hours * 60);
        return { hours: Math.floor(minutes / 60), minutes: minutes % 60 };
    }
};

// Service Historique des actions (Audit Log)
const AuditLogService = {
    logs: [],
    maxLogs: 1000,
    
    async init() {
        try {
            const saved = localStorage.getItem('stockapp-audit-log');
            if (saved) this.logs = JSON.parse(saved);
        } catch (e) {}
    },
    
    log(action, details = {}, user = null) {
        const entry = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            timestamp: new Date().toISOString(),
            action,
            details,
            userId: user?.id || null,
            userName: user ? `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email : 'Système',
            userAgent: navigator.userAgent.substring(0, 100)
        };
        
        this.logs.unshift(entry);
        if (this.logs.length > this.maxLogs) {
            this.logs = this.logs.slice(0, this.maxLogs);
        }
        
        this.save();
        window.dispatchEvent(new CustomEvent('audit-log-update', { detail: entry }));
        
        return entry;
    },
    
    save() {
        try {
            localStorage.setItem('stockapp-audit-log', JSON.stringify(this.logs));
        } catch (e) {}
    },
    
    // Actions prédéfinies
    logLogin(user) {
        return this.log('LOGIN', { email: user.email }, user);
    },
    
    logLogout(user) {
        return this.log('LOGOUT', {}, user);
    },
    
    logCreate(table, record, user) {
        return this.log('CREATE', { table, recordId: record.id, summary: this.getSummary(table, record) }, user);
    },
    
    logUpdate(table, record, changes, user) {
        return this.log('UPDATE', { table, recordId: record.id, changes, summary: this.getSummary(table, record) }, user);
    },
    
    logDelete(table, record, user) {
        return this.log('DELETE', { table, recordId: record.id, summary: this.getSummary(table, record) }, user);
    },
    
    getSummary(table, record) {
        switch(table) {
            case 'tasks': return record.device_number || record.location || 'Tâche';
            case 'parts': return `${record.ref} - ${record.name}`;
            case 'vehicles': return `${record.name} (${record.plate})`;
            case 'users': return record.email;
            default: return record.id;
        }
    },
    
    getRecentLogs(limit = 50) {
        return this.logs.slice(0, limit);
    },
    
    getLogsByUser(userId, limit = 50) {
        return this.logs.filter(l => l.userId === userId).slice(0, limit);
    },
    
    getLogsByAction(action, limit = 50) {
        return this.logs.filter(l => l.action === action).slice(0, limit);
    },
    
    getLogsByDateRange(startDate, endDate) {
        return this.logs.filter(l => {
            const d = new Date(l.timestamp);
            return d >= startDate && d <= endDate;
        });
    },
    
    exportLogs() {
        return JSON.stringify(this.logs, null, 2);
    },
    
    clearLogs() {
        this.logs = [];
        this.save();
    }
};

// Service Rapports automatiques PDF
const AutoReportService = {
    templates: {
        monthly_activity: {
            name: 'Rapport mensuel d\'activité',
            generate: async (data, options) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const now = new Date();
                const monthName = now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                
                // En-tête
                doc.setFontSize(20);
                doc.text(`Rapport d'activité - ${monthName}`, 20, 20);
                
                // Stats générales
                doc.setFontSize(12);
                let y = 40;
                
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const monthTasks = data.tasks.filter(t => new Date(t.created_at) >= monthStart);
                const completedTasks = monthTasks.filter(t => t.status === 'termine');
                
                doc.text(`Période: ${monthStart.toLocaleDateString('fr-FR')} - ${now.toLocaleDateString('fr-FR')}`, 20, y);
                y += 15;
                
                doc.setFontSize(14);
                doc.text('Résumé des interventions', 20, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.text(`• Tâches créées: ${monthTasks.length}`, 25, y); y += 7;
                doc.text(`• Tâches terminées: ${completedTasks.length}`, 25, y); y += 7;
                doc.text(`• Taux de complétion: ${monthTasks.length > 0 ? Math.round(completedTasks.length / monthTasks.length * 100) : 0}%`, 25, y); y += 15;
                
                // Par technicien
                doc.setFontSize(14);
                doc.text('Performance par technicien', 20, y);
                y += 10;
                
                const techStats = {};
                completedTasks.forEach(t => {
                    if (t.assigned_to) {
                        if (!techStats[t.assigned_to]) techStats[t.assigned_to] = 0;
                        techStats[t.assigned_to]++;
                    }
                });
                
                doc.setFontSize(11);
                Object.entries(techStats).forEach(([userId, count]) => {
                    const user = data.users.find(u => u.id === userId);
                    const name = user ? `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.email : 'Inconnu';
                    doc.text(`• ${name}: ${count} interventions`, 25, y);
                    y += 7;
                });
                
                // Stock
                y += 10;
                doc.setFontSize(14);
                doc.text('État du stock', 20, y);
                y += 10;
                
                const lowStock = data.parts.filter(p => p.quantity <= (p.min_stock || 0));
                doc.setFontSize(11);
                doc.text(`• Total références: ${data.parts.length}`, 25, y); y += 7;
                doc.text(`• En alerte: ${lowStock.length}`, 25, y); y += 7;
                doc.text(`• Valeur totale: ${data.parts.reduce((s, p) => s + (p.quantity * (p.price || 0)), 0).toFixed(2)} €`, 25, y);
                
                // Footer
                doc.setFontSize(9);
                doc.text(`Généré le ${now.toLocaleString('fr-FR')} - StockApp v5.8`, 20, 280);
                
                return doc;
            }
        },
        
        stock_inventory: {
            name: 'Inventaire du stock',
            generate: async (data) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text('Inventaire du Stock', 20, 20);
                doc.setFontSize(10);
                doc.text(`Généré le ${new Date().toLocaleString('fr-FR')}`, 20, 28);
                
                let y = 40;
                doc.setFontSize(9);
                
                // En-têtes tableau
                doc.setFont(undefined, 'bold');
                doc.text('Réf.', 20, y);
                doc.text('Désignation', 45, y);
                doc.text('Cat.', 110, y);
                doc.text('Qté', 145, y);
                doc.text('Min', 160, y);
                doc.text('Valeur', 175, y);
                y += 7;
                
                doc.setFont(undefined, 'normal');
                data.parts.forEach(p => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    const isLow = p.quantity <= (p.min_stock || 0);
                    if (isLow) doc.setTextColor(220, 38, 38);
                    
                    doc.text((p.ref || '').substring(0, 12), 20, y);
                    doc.text((p.name || '').substring(0, 35), 45, y);
                    doc.text((p.category || '').substring(0, 15), 110, y);
                    doc.text(String(p.quantity || 0), 145, y);
                    doc.text(String(p.min_stock || 0), 160, y);
                    doc.text(`${((p.quantity || 0) * (p.price || 0)).toFixed(0)}€`, 175, y);
                    
                    doc.setTextColor(0, 0, 0);
                    y += 6;
                });
                
                return doc;
            }
        },
        
        technician_schedule: {
            name: 'Planning technicien',
            generate: async (data, options) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');
                const techId = options?.technicianId;
                const tech = data.users.find(u => u.id === techId);
                
                doc.setFontSize(16);
                doc.text(`Planning - ${tech ? `${tech.first_name} ${tech.last_name}` : 'Tous'}`, 20, 20);
                
                // Semaine en cours
                const now = new Date();
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - now.getDay() + 1);
                
                let y = 35;
                const tasks = data.tasks.filter(t => {
                    if (techId && t.assigned_to !== techId) return false;
                    if (!t.scheduled_date) return false;
                    const d = new Date(t.scheduled_date);
                    return d >= weekStart;
                }).slice(0, 30);
                
                doc.setFontSize(9);
                tasks.forEach(t => {
                    if (y > 190) { doc.addPage(); y = 20; }
                    doc.text(t.scheduled_date || '', 20, y);
                    doc.text(t.scheduled_time || '', 50, y);
                    doc.text((t.device_number || t.location || '').substring(0, 30), 70, y);
                    doc.text((t.event_category || '').substring(0, 20), 150, y);
                    doc.text(t.status || '', 220, y);
                    y += 6;
                });
                
                return doc;
            }
        }
    },
    
    scheduledReports: [],
    
    async init() {
        try {
            const saved = localStorage.getItem('stockapp-scheduled-reports');
            if (saved) this.scheduledReports = JSON.parse(saved);
        } catch (e) {}
    },
    
    scheduleReport(config) {
        const report = {
            id: Date.now().toString(36),
            templateId: config.templateId,
            schedule: config.schedule, // { frequency: 'weekly', dayOfWeek: 1, hour: 8 }
            recipients: config.recipients || [],
            enabled: true,
            lastRun: null,
            nextRun: this.calculateNextRun(config.schedule),
            createdAt: new Date().toISOString()
        };
        
        this.scheduledReports.push(report);
        this.save();
        return report;
    },
    
    calculateNextRun(schedule) {
        const now = new Date();
        const next = new Date();
        
        if (schedule.frequency === 'daily') {
            next.setHours(schedule.hour || 8, 0, 0, 0);
            if (next <= now) next.setDate(next.getDate() + 1);
        } else if (schedule.frequency === 'weekly') {
            next.setHours(schedule.hour || 8, 0, 0, 0);
            const daysUntil = (schedule.dayOfWeek - now.getDay() + 7) % 7 || 7;
            next.setDate(now.getDate() + daysUntil);
        } else if (schedule.frequency === 'monthly') {
            next.setDate(schedule.dayOfMonth || 1);
            next.setHours(schedule.hour || 8, 0, 0, 0);
            if (next <= now) next.setMonth(next.getMonth() + 1);
        }
        
        return next.toISOString();
    },
    
    save() {
        localStorage.setItem('stockapp-scheduled-reports', JSON.stringify(this.scheduledReports));
    },
    
    async generateReport(templateId, data, options = {}) {
        const template = this.templates[templateId];
        if (!template) throw new Error('Template inconnu');
        
        const doc = await template.generate(data, options);
        return doc;
    },
    
    async downloadReport(templateId, data, options = {}) {
        const doc = await this.generateReport(templateId, data, options);
        const filename = `${templateId}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
        return filename;
    }
};

// Service Chat interne v5.7 (amélioré)
// ==========================================
// SERVICE CHAT UNIFIÉ v5.8 - Style WhatsApp
// ==========================================
const ChatServiceUnified = {
    conversations: [],
    messages: {},
    currentUserId: null,
    
    async init(userId) {
        this.currentUserId = userId;
        await this.loadConversations();
    },
    
    async loadConversations() {
        try {
            // Charger depuis Supabase
            const { data } = await db.from('chat_conversations')
                .select('*, participants:chat_participants(user_id, users(id, first_name, last_name, email, avatar_url))')
                .order('last_message_at', { ascending: false });
            this.conversations = data || [];
        } catch (e) {
            // Fallback localStorage
            this.conversations = JSON.parse(localStorage.getItem('stockapp-chat-convs') || '[]');
        }
        return this.conversations;
    },
    
    async loadMessages(conversationId) {
        try {
            const { data } = await db.from('chat_messages')
                .select('*, sender:users(id, first_name, last_name, email, avatar_url)')
                .eq('conversation_id', conversationId)
                .order('created_at', { ascending: true })
                .limit(100);
            this.messages[conversationId] = data || [];
        } catch (e) {
            this.messages[conversationId] = JSON.parse(localStorage.getItem(`stockapp-chat-${conversationId}`) || '[]');
        }
        return this.messages[conversationId] || [];
    },
    
    async sendMessage(conversationId, content, type = 'text', fileData = null) {
        const message = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            conversation_id: conversationId,
            sender_id: this.currentUserId,
            content,
            type, // text, image, file, audio
            file_url: fileData?.url || null,
            file_name: fileData?.name || null,
            file_size: fileData?.size || null,
            file_type: fileData?.type || null,
            status: 'sent', // sent, delivered, read
            created_at: new Date().toISOString(),
            read_by: [this.currentUserId]
        };
        
        try {
            const { data, error } = await db.from('chat_messages').insert(message).select('*, sender:users(id, first_name, last_name, email)');
            if (!error && data) {
                if (!this.messages[conversationId]) this.messages[conversationId] = [];
                this.messages[conversationId].push(data[0]);
                // Mettre à jour last_message
                await db.from('chat_conversations').update({ 
                    last_message: content.substring(0, 100),
                    last_message_at: message.created_at 
                }).eq('id', conversationId);
                return data[0];
            }
        } catch (e) {}
        
        // Fallback localStorage
        if (!this.messages[conversationId]) this.messages[conversationId] = [];
        this.messages[conversationId].push(message);
        localStorage.setItem(`stockapp-chat-${conversationId}`, JSON.stringify(this.messages[conversationId]));
        return message;
    },
    
    async uploadFile(file) {
        // Simuler upload - en production utiliser Supabase Storage
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                resolve({
                    url: e.target.result,
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
            };
            reader.readAsDataURL(file);
        });
    },
    
    async createConversation(participantIds, name = null, isGroup = false) {
        const conversation = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            name: name || null,
            is_group: isGroup,
            created_by: this.currentUserId,
            created_at: new Date().toISOString(),
            last_message: null,
            last_message_at: new Date().toISOString()
        };
        
        try {
            const { data: convData } = await db.from('chat_conversations').insert(conversation).select();
            if (convData) {
                // Ajouter participants
                const participants = [...participantIds, this.currentUserId].map(uid => ({
                    conversation_id: convData[0].id,
                    user_id: uid
                }));
                await db.from('chat_participants').insert(participants);
                this.conversations.unshift(convData[0]);
                return convData[0];
            }
        } catch (e) {}
        
        // Fallback
        this.conversations.unshift(conversation);
        localStorage.setItem('stockapp-chat-convs', JSON.stringify(this.conversations));
        return conversation;
    },
    
    async markAsRead(conversationId, messageIds) {
        try {
            for (const id of messageIds) {
                await db.from('chat_messages')
                    .update({ status: 'read' })
                    .eq('id', id)
                    .neq('sender_id', this.currentUserId);
            }
        } catch (e) {}
    },
    
    getUnreadCount(conversationId = null) {
        if (conversationId) {
            return (this.messages[conversationId] || []).filter(m => 
                m.sender_id !== this.currentUserId && m.status !== 'read'
            ).length;
        }
        return Object.values(this.messages).flat().filter(m => 
            m.sender_id !== this.currentUserId && m.status !== 'read'
        ).length;
    },
    
    findOrCreateDirectConversation(userId, users) {
        // Chercher conversation existante
        const existing = this.conversations.find(c => 
            !c.is_group && 
            c.participants?.some(p => p.user_id === userId)
        );
        if (existing) return existing;
        
        // Créer nouvelle conversation
        return this.createConversation([userId], null, false);
    }
};

// ==========================================
// COMPOSANT CHAT WHATSAPP v5.8
// ==========================================
const ChatWhatsApp = ({ isOpen, onClose, user, users }) => {
    const [conversations, setConversations] = useState([]);
    const [activeConv, setActiveConv] = useState(null);
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [loading, setLoading] = useState(true);
    const [showNewChat, setShowNewChat] = useState(false);
    const [searchUsers, setSearchUsers] = useState('');
    const [showAttachMenu, setShowAttachMenu] = useState(false);
    const [uploadingFile, setUploadingFile] = useState(false);
    const messagesEndRef = useRef(null);
    const fileInputRef = useRef(null);
    
    useEffect(() => {
        if (isOpen && user) {
            ChatServiceUnified.init(user.id).then(() => {
                loadConversations();
            });
        }
    }, [isOpen, user]);
    
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);
    
    const loadConversations = async () => {
        setLoading(true);
        const convs = await ChatServiceUnified.loadConversations();
        setConversations(convs);
        setLoading(false);
    };
    
    const selectConversation = async (conv) => {
        setActiveConv(conv);
        const msgs = await ChatServiceUnified.loadMessages(conv.id);
        setMessages(msgs);
        // Marquer comme lu
        const unreadIds = msgs.filter(m => m.sender_id !== user.id && m.status !== 'read').map(m => m.id);
        if (unreadIds.length) ChatServiceUnified.markAsRead(conv.id, unreadIds);
    };
    
    const sendMessage = async (type = 'text', fileData = null) => {
        const content = type === 'text' ? newMessage.trim() : (fileData?.name || 'Fichier');
        if (!content && type === 'text') return;
        
        const msg = await ChatServiceUnified.sendMessage(activeConv.id, content, type, fileData);
        setMessages([...messages, { ...msg, sender: user }]);
        setNewMessage('');
        setShowAttachMenu(false);
    };
    
    const handleFileSelect = async (e, type) => {
        const file = e.target.files[0];
        if (!file) return;
        
        setUploadingFile(true);
        const fileData = await ChatServiceUnified.uploadFile(file);
        await sendMessage(type === 'image' ? 'image' : 'file', fileData);
        setUploadingFile(false);
    };
    
    const startNewChat = async (targetUser) => {
        const conv = await ChatServiceUnified.findOrCreateDirectConversation(targetUser.id, users);
        setConversations([conv, ...conversations.filter(c => c.id !== conv.id)]);
        selectConversation(conv);
        setShowNewChat(false);
    };
    
    const getConvName = (conv) => {
        if (conv.name) return conv.name;
        if (conv.is_group) return 'Groupe';
        const other = conv.participants?.find(p => p.user_id !== user.id);
        return other?.users?.first_name || other?.users?.email?.split('@')[0] || 'Chat';
    };
    
    const getConvAvatar = (conv) => {
        if (conv.is_group) return '👥';
        const other = conv.participants?.find(p => p.user_id !== user.id);
        return (other?.users?.first_name?.[0] || '?').toUpperCase();
    };
    
    const formatFileSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    };
    
    if (!isOpen) return null;
    
    return h('div', { 
        style: { 
            position: 'fixed', 
            right: 20, 
            bottom: 20, 
            width: 420, 
            height: 600, 
            background: 'var(--card)', 
            borderRadius: 16, 
            boxShadow: '0 10px 50px rgba(0,0,0,0.25)',
            display: 'flex',
            flexDirection: 'column',
            zIndex: 9998,
            overflow: 'hidden'
        } 
    },
        // Header WhatsApp style
        h('div', { style: { 
            padding: '12px 16px', 
            background: 'linear-gradient(135deg, #25D366, #128C7E)', 
            color: 'white', 
            display: 'flex', 
            alignItems: 'center',
            gap: 12
        } },
            activeConv ? h(Fragment, null,
                h('button', { 
                    onClick: () => setActiveConv(null), 
                    style: { background: 'none', border: 'none', color: 'white', cursor: 'pointer', fontSize: 18 } 
                }, '←'),
                h('div', { style: { width: 40, height: 40, borderRadius: '50%', background: 'rgba(255,255,255,0.2)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 700 } }, 
                    getConvAvatar(activeConv)
                ),
                h('div', { style: { flex: 1 } },
                    h('div', { style: { fontWeight: 600 } }, getConvName(activeConv)),
                    h('div', { style: { fontSize: 11, opacity: 0.8 } }, 'en ligne')
                ),
                // Bouton appel vidéo
                !activeConv.is_group && h('button', {
                    onClick: () => {
                        const other = activeConv.participants?.find(p => p.user_id !== user.id);
                        if (other) {
                            window.dispatchEvent(new CustomEvent('open-video-call', { 
                                detail: { 
                                    id: other.user_id, 
                                    first_name: other.users?.first_name || other.users?.email?.split('@')[0] || 'Utilisateur'
                                } 
                            }));
                            onClose();
                        }
                    },
                    style: { background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: 8, padding: 8, color: 'white', cursor: 'pointer', marginRight: 8 },
                    title: 'Appel vidéo'
                }, '📹')
            ) : h(Fragment, null,
                h('div', { style: { width: 40, height: 40, borderRadius: '50%', background: 'rgba(255,255,255,0.2)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 } }, '💬'),
                h('div', { style: { flex: 1 } },
                    h('div', { style: { fontWeight: 700, fontSize: 16 } }, 'Messages'),
                    h('div', { style: { fontSize: 11, opacity: 0.8 } }, `${conversations.length} conversation(s)`)
                ),
                h('button', { 
                    onClick: () => setShowNewChat(true),
                    style: { background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: 8, padding: 8, color: 'white', cursor: 'pointer' } 
                }, '✏️')
            ),
            h('button', { 
                onClick: onClose, 
                style: { background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: 8, padding: '6px 10px', color: 'white', cursor: 'pointer' } 
            }, '✕')
        ),
        
        // Content
        activeConv ? h(Fragment, null,
            // Messages list
            h('div', { style: { flex: 1, overflowY: 'auto', padding: 12, background: '#E5DDD5' } },
                messages.map(msg => {
                    const isMine = msg.sender_id === user.id;
                    const sender = msg.sender || users.find(u => u.id === msg.sender_id) || {};
                    return h('div', { 
                        key: msg.id, 
                        className: 'animate-fade-in-up',
                        style: { 
                            marginBottom: 8, 
                            display: 'flex', 
                            justifyContent: isMine ? 'flex-end' : 'flex-start' 
                        } 
                    },
                        h('div', { style: { 
                            maxWidth: '75%', 
                            padding: '8px 12px', 
                            borderRadius: isMine ? '12px 12px 0 12px' : '12px 12px 12px 0',
                            background: isMine ? '#DCF8C6' : 'white',
                            boxShadow: '0 1px 2px rgba(0,0,0,0.1)'
                        } },
                            !isMine && activeConv.is_group && h('div', { style: { fontSize: 11, color: '#128C7E', fontWeight: 600, marginBottom: 4 } }, 
                                sender.first_name || sender.email?.split('@')[0]
                            ),
                            // Contenu selon type
                            msg.type === 'image' ? h('img', { 
                                src: msg.file_url, 
                                style: { maxWidth: '100%', borderRadius: 8, cursor: 'pointer' },
                                onClick: () => window.open(msg.file_url, '_blank')
                            }) :
                            msg.type === 'file' ? h('div', { 
                                style: { display: 'flex', alignItems: 'center', gap: 8, padding: 8, background: 'rgba(0,0,0,0.05)', borderRadius: 8, cursor: 'pointer' },
                                onClick: () => {
                                    const a = document.createElement('a');
                                    a.href = msg.file_url;
                                    a.download = msg.file_name;
                                    a.click();
                                }
                            },
                                h('span', { style: { fontSize: 24 } }, '📎'),
                                h('div', null,
                                    h('div', { style: { fontSize: 13, fontWeight: 500 } }, msg.file_name),
                                    h('div', { style: { fontSize: 11, color: '#666' } }, formatFileSize(msg.file_size))
                                )
                            ) :
                            h('div', { style: { fontSize: 14, wordBreak: 'break-word' } }, msg.content),
                            // Heure + statut
                            h('div', { style: { display: 'flex', justifyContent: 'flex-end', alignItems: 'center', gap: 4, marginTop: 4 } },
                                h('span', { style: { fontSize: 10, color: '#667781' } }, 
                                    new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
                                ),
                                isMine && h('span', { style: { fontSize: 12, color: msg.status === 'read' ? '#53BDEB' : '#667781' } }, 
                                    msg.status === 'read' ? '✓✓' : msg.status === 'delivered' ? '✓✓' : '✓'
                                )
                            )
                        )
                    );
                }),
                h('div', { ref: messagesEndRef })
            ),
            
            // Input area
            h('div', { style: { padding: 8, background: '#F0F0F0', display: 'flex', alignItems: 'center', gap: 8 } },
                // Attach button
                h('div', { style: { position: 'relative' } },
                    h('button', { 
                        onClick: () => setShowAttachMenu(!showAttachMenu),
                        style: { background: 'none', border: 'none', fontSize: 20, cursor: 'pointer', padding: 8 } 
                    }, '📎'),
                    showAttachMenu && h('div', { 
                        className: 'animate-scale-in',
                        style: { 
                            position: 'absolute', 
                            bottom: '100%', 
                            left: 0, 
                            background: 'white', 
                            borderRadius: 12, 
                            boxShadow: '0 4px 20px rgba(0,0,0,0.15)',
                            padding: 8,
                            marginBottom: 8
                        } 
                    },
                        h('button', { 
                            onClick: () => { fileInputRef.current.accept = 'image/*'; fileInputRef.current.click(); },
                            style: { display: 'flex', alignItems: 'center', gap: 8, padding: '8px 12px', background: 'none', border: 'none', cursor: 'pointer', width: '100%', textAlign: 'left', borderRadius: 8 }
                        }, '🖼️ Photo'),
                        h('button', { 
                            onClick: () => { fileInputRef.current.accept = '*/*'; fileInputRef.current.click(); },
                            style: { display: 'flex', alignItems: 'center', gap: 8, padding: '8px 12px', background: 'none', border: 'none', cursor: 'pointer', width: '100%', textAlign: 'left', borderRadius: 8 }
                        }, '📄 Document')
                    )
                ),
                h('input', { 
                    ref: fileInputRef,
                    type: 'file',
                    style: { display: 'none' },
                    onChange: (e) => handleFileSelect(e, e.target.accept.includes('image') ? 'image' : 'file')
                }),
                h('input', { 
                    type: 'text', 
                    placeholder: 'Écrire un message...',
                    value: newMessage,
                    onChange: e => setNewMessage(e.target.value),
                    onKeyPress: e => e.key === 'Enter' && sendMessage(),
                    disabled: uploadingFile,
                    style: { 
                        flex: 1, 
                        padding: '10px 16px', 
                        border: 'none', 
                        borderRadius: 24, 
                        outline: 'none',
                        fontSize: 14
                    }
                }),
                h('button', { 
                    onClick: () => sendMessage(), 
                    disabled: !newMessage.trim() || uploadingFile,
                    style: { 
                        width: 40,
                        height: 40,
                        borderRadius: '50%',
                        background: '#25D366', 
                        color: 'white', 
                        border: 'none', 
                        cursor: 'pointer',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: 18,
                        opacity: (newMessage.trim() && !uploadingFile) ? 1 : 0.5
                    } 
                }, uploadingFile ? '⏳' : '➤')
            )
        ) : h(Fragment, null,
            // Conversations list
            showNewChat ? h('div', { style: { flex: 1, overflowY: 'auto' } },
                h('div', { style: { padding: 12 } },
                    h('input', { 
                        type: 'text',
                        placeholder: 'Rechercher un utilisateur...',
                        value: searchUsers,
                        onChange: e => setSearchUsers(e.target.value),
                        style: { width: '100%', padding: '10px 14px', border: '1px solid #ddd', borderRadius: 24, outline: 'none' }
                    })
                ),
                h('div', null,
                    users.filter(u => 
                        u.id !== user.id && 
                        (u.first_name?.toLowerCase().includes(searchUsers.toLowerCase()) || 
                         u.email?.toLowerCase().includes(searchUsers.toLowerCase()))
                    ).map(u => h('div', { 
                        key: u.id,
                        onClick: () => startNewChat(u),
                        style: { 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: 12, 
                            padding: '12px 16px', 
                            cursor: 'pointer',
                            borderBottom: '1px solid #f0f0f0'
                        }
                    },
                        h('div', { style: { width: 48, height: 48, borderRadius: '50%', background: '#25D366', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 700 } }, 
                            (u.first_name?.[0] || u.email[0]).toUpperCase()
                        ),
                        h('div', null,
                            h('div', { style: { fontWeight: 600 } }, u.first_name ? `${u.first_name} ${u.last_name || ''}` : u.email.split('@')[0]),
                            h('div', { style: { fontSize: 12, color: '#666' } }, u.email)
                        )
                    ))
                ),
                h('button', { 
                    onClick: () => setShowNewChat(false),
                    style: { position: 'absolute', bottom: 16, left: '50%', transform: 'translateX(-50%)', padding: '8px 24px', background: '#f0f0f0', border: 'none', borderRadius: 24, cursor: 'pointer' }
                }, 'Annuler')
            ) : h('div', { style: { flex: 1, overflowY: 'auto' } },
                loading ? h('div', { style: { textAlign: 'center', padding: 40 } }, '⏳ Chargement...') :
                conversations.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: '#666' } },
                    h('div', { style: { fontSize: 48, marginBottom: 16 } }, '💬'),
                    h('div', null, 'Aucune conversation'),
                    h('button', { 
                        onClick: () => setShowNewChat(true),
                        style: { marginTop: 16, padding: '10px 24px', background: '#25D366', color: 'white', border: 'none', borderRadius: 24, cursor: 'pointer' }
                    }, 'Nouvelle conversation')
                ) :
                conversations.map(conv => {
                    const unread = ChatServiceUnified.getUnreadCount(conv.id);
                    return h('div', { 
                        key: conv.id,
                        onClick: () => selectConversation(conv),
                        style: { 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: 12, 
                            padding: '12px 16px', 
                            cursor: 'pointer',
                            background: unread > 0 ? '#F0FFF4' : 'transparent',
                            borderBottom: '1px solid #f0f0f0'
                        }
                    },
                        h('div', { style: { width: 50, height: 50, borderRadius: '50%', background: '#DDD', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 700, fontSize: 18 } }, 
                            getConvAvatar(conv)
                        ),
                        h('div', { style: { flex: 1, minWidth: 0 } },
                            h('div', { style: { display: 'flex', justifyContent: 'space-between' } },
                                h('span', { style: { fontWeight: 600 } }, getConvName(conv)),
                                h('span', { style: { fontSize: 11, color: '#667781' } }, 
                                    conv.last_message_at ? new Date(conv.last_message_at).toLocaleDateString('fr-FR') : ''
                                )
                            ),
                            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: 4 } },
                                h('span', { style: { fontSize: 13, color: '#667781', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap', maxWidth: 200 } }, 
                                    conv.last_message || 'Aucun message'
                                ),
                                unread > 0 && h('span', { style: { background: '#25D366', color: 'white', borderRadius: '50%', minWidth: 20, height: 20, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, fontWeight: 700 } }, unread)
                            )
                        )
                    );
                })
            )
        )
    );
};

// Ancien service pour compatibilité
const ChatServiceV2 = {
    messages: [],
    unreadCount: 0,
    
    async loadMessages(taskId = null) {
        try {
            let query = db.from('chat_messages').select('*, sender:users(id, first_name, last_name, email)').order('created_at', { ascending: true });
            if (taskId) query = query.eq('task_id', taskId);
            const { data } = await query.limit(100);
            this.messages = data || [];
            return this.messages;
        } catch (e) {
            // Fallback localStorage
            const saved = localStorage.getItem('stockapp-chat');
            this.messages = saved ? JSON.parse(saved) : [];
            return this.messages;
        }
    },
    
    async sendMessage(content, userId, taskId = null, mentions = []) {
        const message = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            content,
            user_id: userId,
            task_id: taskId,
            mentions,
            created_at: new Date().toISOString(),
            read_by: [userId]
        };
        
        try {
            const { data, error } = await db.from('chat_messages').insert(message).select();
            if (!error && data) {
                this.messages.push(data[0]);
                // Notifier les mentions
                mentions.forEach(mentionId => {
                    window.dispatchEvent(new CustomEvent('chat-mention', { detail: { message, mentionId } }));
                });
                return data[0];
            }
        } catch (e) {}
        
        // Fallback localStorage
        this.messages.push(message);
        localStorage.setItem('stockapp-chat', JSON.stringify(this.messages));
        return message;
    },
    
    async markAsRead(messageId, userId) {
        const msg = this.messages.find(m => m.id === messageId);
        if (msg && !msg.read_by?.includes(userId)) {
            msg.read_by = [...(msg.read_by || []), userId];
            try {
                await db.from('chat_messages').update({ read_by: msg.read_by }).eq('id', messageId);
            } catch (e) {}
        }
    },
    
    getUnreadCount(userId) {
        return this.messages.filter(m => !m.read_by?.includes(userId)).length;
    },
    
    subscribeToMessages(callback) {
        // Polling simple (remplacer par Supabase Realtime si disponible)
        const interval = setInterval(async () => {
            const oldCount = this.messages.length;
            await this.loadMessages();
            if (this.messages.length > oldCount) {
                callback(this.messages.slice(oldCount));
            }
        }, 10000);
        
        return () => clearInterval(interval);
    }
};

// Initialisation des services
(async () => {
    await OfflineService.init();
    await AuditLogService.init();
    await AutoReportService.init();
    
    // Écouteurs connexion
    window.addEventListener('online', async () => {
        OfflineService.isOnline = true;
        const result = await OfflineService.sync();
        if (result.synced > 0) {
            window.dispatchEvent(new CustomEvent('show-toast', { 
                detail: { message: `${result.synced} modification(s) synchronisée(s)`, type: 'success' } 
            }));
        }
    });
    
    window.addEventListener('offline', () => {
        OfflineService.isOnline = false;
        window.dispatchEvent(new CustomEvent('show-toast', { 
            detail: { message: 'Mode hors-ligne activé', type: 'warning' } 
        }));
    });
})();

// ==========================================
// SERVICES v5.8 - HMI Avancé
// ==========================================

// Service Thèmes v5.8 avec mode sombre automatique
const ThemeServiceV58 = {
    STORAGE_KEY: 'stockapp-theme-v58',
    currentTheme: 'default',
    darkMode: false,
    autoDarkMode: true,
    themes: {
        default: { name: 'Rose', color: '#E11D48' },
        blue: { name: 'Bleu', color: '#3B82F6' },
        green: { name: 'Vert', color: '#10B981' },
        purple: { name: 'Violet', color: '#8B5CF6' },
        orange: { name: 'Orange', color: '#F97316' },
        teal: { name: 'Turquoise', color: '#14B8A6' }
    },
    
    init() {
        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (saved) {
                const config = JSON.parse(saved);
                this.currentTheme = config.theme || 'default';
                this.darkMode = config.darkMode || false;
                this.autoDarkMode = config.autoDarkMode !== false;
            }
        } catch (e) {}
        // Mettre à jour COLORS selon le mode actuel
        updateColors(this.darkMode);
        this.applyTheme();
        if (this.autoDarkMode) this.checkAutoDarkMode();
    },
    
    checkAutoDarkMode() {
        const hour = new Date().getHours();
        const shouldBeDark = hour >= 19 || hour < 7;
        if (shouldBeDark !== this.darkMode) {
            this.darkMode = shouldBeDark;
            this.applyTheme();
            this.save();
        }
    },
    
    setTheme(themeId) {
        this.currentTheme = themeId;
        this.applyTheme();
        this.save();
    },
    
    toggleDarkMode() {
        this.darkMode = !this.darkMode;
        this.autoDarkMode = false;
        this.applyTheme();
        this.save();
    },
    
    applyTheme() {
        const html = document.documentElement;
        // Supprimer tous les thèmes précédents
        html.removeAttribute('data-theme');
        html.classList.remove('dark-mode');
        
        // Mettre à jour les couleurs JavaScript
        updateColors(this.darkMode);
        
        // Appliquer le nouveau thème
        if (this.darkMode) {
            html.setAttribute('data-theme', 'dark');
            html.classList.add('dark-mode');
        } else if (this.currentTheme !== 'default') {
            html.setAttribute('data-theme', this.currentTheme);
        }
        
        // Mettre à jour meta theme-color
        const meta = document.querySelector('meta[name="theme-color"]');
        if (meta) {
            meta.setAttribute('content', this.darkMode ? '#1E293B' : (this.themes[this.currentTheme]?.color || '#E11D48'));
        }
        
        // Forcer le re-render des composants React
        window.dispatchEvent(new CustomEvent('theme-changed', { detail: { theme: this.currentTheme, darkMode: this.darkMode } }));
    },
    
    save() {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify({
            theme: this.currentTheme,
            darkMode: this.darkMode,
            autoDarkMode: this.autoDarkMode
        }));
    },
    
    getConfig() {
        return { theme: this.currentTheme, darkMode: this.darkMode, autoDarkMode: this.autoDarkMode, themes: this.themes };
    }
};

// Service Toasts améliorés v5.8
const ToastServiceV58 = {
    toasts: [],
    position: 'top-right',
    maxToasts: 5,
    defaultDuration: 5000,
    listeners: [],
    
    show(options) {
        const toast = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            title: options.title || '',
            message: options.message || '',
            type: options.type || 'info',
            duration: options.duration ?? this.defaultDuration,
            actions: options.actions || [],
            closable: options.closable !== false,
            createdAt: Date.now()
        };
        this.toasts.unshift(toast);
        if (this.toasts.length > this.maxToasts) {
            this.toasts = this.toasts.slice(0, this.maxToasts);
        }
        this.notify();
        if (toast.duration > 0) {
            setTimeout(() => this.dismiss(toast.id), toast.duration);
        }
        return toast.id;
    },
    
    success(message, options = {}) { return this.show({ ...options, message, type: 'success', title: options.title || 'Succès' }); },
    error(message, options = {}) { return this.show({ ...options, message, type: 'error', title: options.title || 'Erreur', duration: 8000 }); },
    warning(message, options = {}) { return this.show({ ...options, message, type: 'warning', title: options.title || 'Attention' }); },
    info(message, options = {}) { return this.show({ ...options, message, type: 'info', title: options.title || 'Information' }); },
    
    dismiss(id) {
        const index = this.toasts.findIndex(t => t.id === id);
        if (index > -1) {
            this.toasts[index].exiting = true;
            this.notify();
            setTimeout(() => {
                this.toasts = this.toasts.filter(t => t.id !== id);
                this.notify();
            }, 300);
        }
    },
    
    setPosition(pos) { this.position = pos; localStorage.setItem('stockapp-toast-pos', pos); this.notify(); },
    subscribe(cb) { this.listeners.push(cb); return () => { this.listeners = this.listeners.filter(l => l !== cb); }; },
    notify() { this.listeners.forEach(cb => cb(this.toasts, this.position)); }
};

// Service Navigation mémorisée v5.8
const NavigationServiceV58 = {
    STORAGE_KEY: 'stockapp-nav-v58',
    lastTabs: {},
    favorites: [],
    
    init() {
        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                this.lastTabs = data.lastTabs || {};
                this.favorites = data.favorites || [];
            }
        } catch (e) {}
    },
    
    recordTab(page, tab) {
        this.lastTabs[page] = tab;
        this.save();
    },
    
    getLastTab(page) { return this.lastTabs[page] || null; },
    
    addFavorite(page, label, icon) {
        if (!this.favorites.find(f => f.page === page)) {
            this.favorites.push({ page, label, icon });
            this.save();
        }
    },
    
    removeFavorite(page) {
        this.favorites = this.favorites.filter(f => f.page !== page);
        this.save();
    },
    
    isFavorite(page) { return this.favorites.some(f => f.page === page); },
    save() { localStorage.setItem(this.STORAGE_KEY, JSON.stringify({ lastTabs: this.lastTabs, favorites: this.favorites })); }
};

// Service Templates PDF avancés v5.8
// Service de personnalisation PDF
const PDFCustomizationService = {
    STORAGE_KEY: 'stockapp-pdf-customization',
    defaults: {
        companyName: 'StockApp',
        logo: null,
        primaryColor: '#E11D48',
        footerText: 'StockApp v5.8 - Gestion de stock',
        showDate: true,
        showPageNumbers: true
    },
    config: null,
    
    init() {
        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            this.config = saved ? { ...this.defaults, ...JSON.parse(saved) } : { ...this.defaults };
        } catch (e) {
            this.config = { ...this.defaults };
        }
    },
    
    getConfig() {
        if (!this.config) this.init();
        return { ...this.config };
    },
    
    setConfig(newConfig) {
        this.config = { ...this.config, ...newConfig };
        this.save();
    },
    
    setLogo(base64) {
        this.config.logo = base64;
        this.save();
    },
    
    save() {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.config));
    },
    
    hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : [225, 29, 72];
    }
};

PDFCustomizationService.init();

const PDFTemplateServiceV58 = {
    templates: {
        stock_standard: { id: 'stock_standard', name: 'Inventaire standard', category: 'stock', icon: '📦', description: 'Liste simple du stock' },
        stock_valorise: { id: 'stock_valorise', name: 'Stock valorisé', category: 'stock', icon: '💰', description: 'Avec valeurs et totaux' },
        stock_alerte: { id: 'stock_alerte', name: 'Alertes stock', category: 'stock', icon: '⚠️', description: 'Pièces en rupture' },
        tasks_daily: { id: 'tasks_daily', name: 'Planning du jour', category: 'tasks', icon: '📅', description: 'Tâches du jour' },
        tasks_technician: { id: 'tasks_technician', name: 'Feuille technicien', category: 'tasks', icon: '👷', description: 'Planning semaine' },
        tasks_report: { id: 'tasks_report', name: 'Rapport activité', category: 'tasks', icon: '📊', description: 'Synthèse mensuelle' }
    },
    
    getTemplates(category) {
        const all = Object.values(this.templates);
        return category ? all.filter(t => t.category === category) : all;
    },
    
    getCategories() {
        return [
            { id: 'stock', name: 'Stock', icon: '📦' },
            { id: 'tasks', name: 'Tâches', icon: '📋' }
        ];
    },
    
    async generate(templateId, data, options = {}) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF(templateId.includes('technician') ? 'landscape' : 'portrait');
        const template = this.templates[templateId];
        if (!template) throw new Error('Template non trouvé');
        
        // Récupérer la personnalisation
        const custom = PDFCustomizationService.getConfig();
        const primaryColor = PDFCustomizationService.hexToRgb(custom.primaryColor);
        
        // En-tête avec logo et couleur personnalisée
        doc.setFillColor(...primaryColor);
        doc.rect(0, 0, doc.internal.pageSize.getWidth(), 35, 'F');
        
        // Logo si présent
        let titleX = doc.internal.pageSize.getWidth() / 2;
        if (custom.logo) {
            try {
                doc.addImage(custom.logo, 'PNG', 15, 5, 25, 25);
                titleX = (doc.internal.pageSize.getWidth() + 40) / 2;
            } catch (e) {}
        }
        
        // Nom entreprise
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(custom.companyName, custom.logo ? 45 : 15, 12);
        
        // Titre du template
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text(template.name.toUpperCase(), titleX, 25, { align: 'center' });
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        
        if (custom.showDate) {
            doc.text('Généré le ' + new Date().toLocaleString('fr-FR'), doc.internal.pageSize.getWidth() / 2, 45, { align: 'center' });
        }
        
        let y = 55;
        
        // Contenu selon template
        if (templateId === 'stock_standard' || templateId === 'stock_valorise') {
            const parts = data.parts || [];
            
            // En-tête de tableau
            doc.setFillColor(240, 240, 240);
            doc.rect(15, y - 4, 180, 10, 'F');
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('REF', 18, y + 2);
            doc.text('DÉSIGNATION', 50, y + 2);
            doc.text('QTÉ', 140, y + 2);
            if (templateId === 'stock_valorise') {
                doc.text('VALEUR', 160, y + 2);
            }
            y += 12;
            doc.setFont(undefined, 'normal');
            
            let totalValue = 0;
            parts.slice(0, 50).forEach((p, i) => {
                if (y > 270) { doc.addPage(); y = 20; }
                if (i % 2 === 0) { doc.setFillColor(248, 250, 252); doc.rect(15, y - 4, 180, 8, 'F'); }
                doc.text((p.ref || '-').substring(0, 15), 18, y);
                doc.text((p.name || '-').substring(0, 35), 50, y);
                doc.text(String(p.quantity || 0), 140, y);
                if (templateId === 'stock_valorise') {
                    const value = (p.quantity || 0) * (p.price || 0);
                    totalValue += value;
                    doc.text(value.toFixed(2) + ' €', 160, y);
                }
                y += 8;
            });
            
            if (templateId === 'stock_valorise') {
                y += 5;
                doc.setFillColor(...primaryColor);
                doc.rect(120, y - 4, 75, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.text('TOTAL: ' + totalValue.toFixed(2) + ' €', 125, y + 2);
                doc.setTextColor(0, 0, 0);
            }
        } else if (templateId === 'stock_alerte') {
            const alerts = (data.parts || []).filter(p => (p.quantity || 0) <= (p.min_stock || 0));
            
            doc.setFillColor(...primaryColor);
            doc.setTextColor(255, 255, 255);
            doc.roundedRect(60, y - 5, 90, 15, 3, 3, 'F');
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(alerts.length + ' pièce(s) en alerte', 105, y + 5, { align: 'center' });
            doc.setTextColor(0, 0, 0);
            y += 20;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            
            alerts.forEach(p => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.setFillColor(254, 226, 226);
                doc.roundedRect(15, y - 2, 180, 12, 2, 2, 'F');
                doc.text(p.ref + ' - ' + (p.name || '').substring(0, 40), 20, y + 5);
                doc.setTextColor(239, 68, 68);
                doc.text('Stock: ' + (p.quantity || 0) + ' / Min: ' + (p.min_stock || 0), 150, y + 5);
                doc.setTextColor(0, 0, 0);
                y += 16;
            });
        } else if (templateId.startsWith('tasks')) {
            const tasks = data.tasks || [];
            doc.setFontSize(9);
            
            // En-tête
            doc.setFillColor(240, 240, 240);
            doc.rect(15, y - 4, 180, 10, 'F');
            doc.setFont(undefined, 'bold');
            doc.text('DATE', 18, y + 2);
            doc.text('HEURE', 45, y + 2);
            doc.text('ÉQUIPEMENT/LIEU', 70, y + 2);
            doc.text('TYPE', 140, y + 2);
            doc.text('STATUT', 175, y + 2);
            y += 12;
            doc.setFont(undefined, 'normal');
            
            tasks.slice(0, 30).forEach((t, i) => {
                if (y > 270) { doc.addPage(); y = 20; }
                if (i % 2 === 0) { doc.setFillColor(248, 250, 252); doc.rect(15, y - 4, 180, 8, 'F'); }
                doc.text((t.scheduled_date || '-'), 18, y);
                doc.text((t.scheduled_time || '--:--'), 45, y);
                doc.text((t.device_number || t.location || '-').substring(0, 30), 70, y);
                doc.text((t.event_category || '-').substring(0, 20), 140, y);
                
                if (t.status === 'termine') {
                    doc.setTextColor(16, 185, 129);
                    doc.text('✓', 180, y);
                } else {
                    doc.setTextColor(148, 163, 184);
                    doc.text('○', 180, y);
                }
                doc.setTextColor(0, 0, 0);
                y += 8;
            });
        }
        
        // Pied de page personnalisé
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(148, 163, 184);
            
            let footerText = custom.footerText;
            if (custom.showPageNumbers) {
                footerText += ' - Page ' + i + '/' + pageCount;
            }
            doc.text(footerText, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
        }
        
        return doc;
    },
    
    async download(templateId, data, options = {}) {
        const doc = await this.generate(templateId, data, options);
        const custom = PDFCustomizationService.getConfig();
        const fileName = (custom.companyName.replace(/\s+/g, '_') + '_' + templateId + '_' + new Date().toISOString().split('T')[0] + '.pdf').toLowerCase();
        doc.save(fileName);
    }
};

// Initialiser les services v5.8
ThemeServiceV58.init();
NavigationServiceV58.init();

const Icon = ({ name, size = 20, color = 'currentColor' }) => h('svg', {
    width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: color,
    dangerouslySetInnerHTML: { __html: ICONS[name] || '' }
});

const formatDate = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : '-';
const formatDateTime = (d) => d ? new Date(d).toLocaleString('fr-FR') : '-';
const formatRelative = (d) => { 
    if (!d) return '-'; 
    const dt = new Date(d); 
    const now = new Date(); 
    const diff = (now - dt) / 1000; 
    if (diff < 60) return "À l'instant"; 
    if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`; 
    if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)}h`; 
    if (diff < 604800) return `Il y a ${Math.floor(diff / 86400)}j`; 
    return formatDate(d); 
};
const formatNumber = (n) => new Intl.NumberFormat('fr-FR').format(n || 0);

// Helpers pour les demandes
const getRequestType = (t) => ({ 
    'aide': { label: '🔧 Aide technique', color: COLORS.primary }, 
    'devis': { label: '💰 Devis', color: COLORS.success }, 
    'documentation': { label: '📄 Documentation', color: COLORS.info }, 
    'amelioration': { label: '💡 Amélioration', color: '#8B5CF6' } 
}[t] || { label: t, color: COLORS.muted });

const getRequestStatus = (s) => ({ 
    'nouveau': { label: 'Nouveau', color: 'primary' }, 
    'en_cours': { label: 'En cours', color: 'info' }, 
    'en_attente': { label: 'En attente', color: 'warning' }, 
    'planifie': { label: 'Planifié', color: 'purple' }, 
    'resolu': { label: 'Résolu', color: 'success' }, 
    'cloture': { label: 'Clôturé', color: 'secondary' } 
}[s] || { label: s, color: 'secondary' });

// Helper pour les statuts de mise en service
const getDeviceStatus = (s) => ({ 
    'non_commence': { label: 'Non commencé', color: 'secondary', bg: COLORS.muted }, 
    'monte': { label: 'Monté', color: 'info', bg: COLORS.info }, 
    'mes_ok_sans_reserves': { label: 'MES OK', color: 'success', bg: COLORS.success }, 
    'mes_ok_avec_reserves': { label: 'MES avec réserves', color: 'orange', bg: '#F97316' }, 
    'levee_reserves': { label: 'Levée réserves', color: 'purple', bg: '#8B5CF6' }, 
    'termine': { label: 'Terminé', color: 'teal', bg: '#14B8A6' } 
}[s] || { label: s || 'Non défini', color: 'secondary', bg: COLORS.muted });

// Helper pour récupérer le nom d'un utilisateur
const getUserName = (userId, users) => {
    if (!userId || !users) return null;
    const u = users.find(u => u.id === userId);
    if (!u) return null;
    return ((u.first_name || '') + ' ' + (u.last_name || '')).trim() || u.email;
};

// Helper pour infos rapport inspection
const getReportStatusInfo = (s) => ({ 
    'brouillon': { label: 'Brouillon', color: 'secondary' }, 
    'en_cours': { label: 'En cours', color: 'info' }, 
    'termine': { label: 'Terminé', color: 'success' }, 
    'valide': { label: 'Validé', color: 'purple' } 
}[s] || { label: s, color: 'secondary' });

const getBCStatusInfo = (s) => ({ 
    'en_attente': { label: 'En attente', color: 'warning' }, 
    'conforme': { label: 'Conforme', color: 'success' }, 
    'non_conforme': { label: 'Non conforme', color: 'danger' } 
}[s] || { label: s, color: 'secondary' });

const getCheckpointStatusInfo = (status) => ({
    'C': { label: 'Conforme', color: 'success', icon: '✓' },
    'NC': { label: 'Non Conforme', color: 'danger', icon: '✗' },
    'NA': { label: 'Non Applicable', color: 'secondary', icon: '-' },
    'NV': { label: 'Non Vérifié', color: 'info', icon: '?' }
}[status] || { label: status || 'N/A', color: 'secondary', icon: '?' });

// Toast
const Toast = ({ message, type = 'success', onClose }) => {
    useEffect(() => { const t = setTimeout(onClose, 4000); return () => clearTimeout(t); }, []);
    return h('div', { className: `toast ${type}` },
        h(Icon, { name: type === 'success' ? 'check' : type === 'error' ? 'alert' : 'alert', size: 18 }),
        h('span', { className: 'toast-message' }, message)
    );
};

// Modal
const Modal = ({ isOpen, onClose, title, children, footer, size = 'md' }) => {
    if (!isOpen) return null;
    return h('div', { className: 'modal-overlay', onClick: e => e.target === e.currentTarget && onClose() },
        h('div', { className: `modal ${size}` },
            h('div', { className: 'modal-header' },
                h('h2', { className: 'modal-title' }, title),
                h('button', { className: 'modal-close', onClick: onClose }, h(Icon, { name: 'x', size: 18 }))
            ),
            h('div', { className: 'modal-body' }, children),
            footer && h('div', { className: 'modal-footer' }, footer)
        )
    );
};

// Confirm Dialog
const ConfirmDialog = ({ isOpen, onClose, onConfirm, title, message, confirmText = 'Confirmer', type = 'danger' }) => {
    if (!isOpen) return null;
    return h('div', { className: 'modal-overlay', onClick: e => e.target === e.currentTarget && onClose() },
        h('div', { className: 'modal sm' },
            h('div', { className: 'modal-body' },
                h('div', { className: 'confirm-content' },
                    h('div', { className: `confirm-icon ${type}` }, h(Icon, { name: 'alert', size: 28 })),
                    h('h3', { className: 'confirm-title' }, title),
                    h('p', { className: 'confirm-message' }, message)
                )
            ),
            h('div', { className: 'modal-footer' },
                h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Annuler'),
                h('button', { className: `btn btn-${type}`, onClick: () => { onConfirm(); onClose(); } }, confirmText)
            )
        )
    );
};

// ==========================================
// NOTIFICATIONS SYSTEM
// ==========================================

// Hook useNotifications
const useNotifications = (userId) => {
    const [notifications, setNotifications] = useState([]);
    const [unreadCount, setUnreadCount] = useState(0);
    const [loading, setLoading] = useState(true);
    const [preferences, setPreferences] = useState(null);
    const [tableExists, setTableExists] = useState(true);

    // Charger les notifications
    const loadNotifications = useCallback(async () => {
        if (!userId) {
            setLoading(false);
            return;
        }
        
        try {
            const { data, error } = await db.from('notifications')
                .select('*')
                .eq('user_id', userId)
                .order('created_at', { ascending: false })
                .limit(50);

            if (error) {
                console.log('Notifications table error:', error.message);
                if (error.code === '42P01' || error.message?.includes('does not exist')) {
                    setTableExists(false);
                }
                setNotifications([]);
                setUnreadCount(0);
            } else if (data) {
                setNotifications(data);
                setUnreadCount(data.filter(n => !n.is_read).length);
            }
        } catch (err) {
            console.log('Erreur chargement notifications:', err);
            setNotifications([]);
            setUnreadCount(0);
        } finally {
            setLoading(false);
        }
    }, [userId]);

    // Charger les préférences
    const loadPreferences = useCallback(async () => {
        if (!userId) return;
        
        try {
            const { data, error } = await db.from('notification_preferences')
                .select('*')
                .eq('user_id', userId)
                .maybeSingle();
            
            if (error && error.code !== 'PGRST116') {
                console.log('Preferences error:', error.message);
                return;
            }
            
            if (data) {
                setPreferences(data);
            } else {
                // Créer les préférences par défaut
                const defaultPrefs = {
                    user_id: userId,
                    push_enabled: true,
                    in_app_enabled: true,
                    sound_enabled: true,
                    type_preferences: {
                        // Stock
                        stock_alert: true,
                        stock_withdrawal: false,
                        part_request: true,
                        part_request_validated: true,
                        part_request_rejected: true,
                        // Travaux
                        task_assigned: true,
                        task_completed: true,
                        task_overdue: true,
                        // Commandes
                        order_created: true,
                        order_received: true,
                        order_partial: true,
                        // Planning
                        planning_event_created: false,
                        planning_event_modified: true,
                        planning_event_deleted: true,
                        planning_event_assigned: true,
                        // Feuilles d'heures
                        timesheet_submitted: true,
                        timesheet_validated: true,
                        timesheet_rejected: true,
                        timesheet_reminder: true,
                        // Mise en service
                        device_created: true,
                        device_updated: false,
                        device_archived: false,
                        inspection_report_created: true,
                        inspection_report_validated: true,
                        bc_report_created: true,
                        bc_report_favorable: true,
                        bc_report_defavorable: true,
                        // Demandes
                        request_created: true,
                        request_assigned: true,
                        request_completed: true,
                        // Système
                        system_message: true,
                        user_mention: true
                    }
                };
                try {
                    await db.from('notification_preferences').insert(defaultPrefs);
                } catch (e) {
                    console.log('Could not create default preferences');
                }
                setPreferences(defaultPrefs);
            }
        } catch (err) {
            console.log('Erreur chargement préférences:', err);
        }
    }, [userId]);

    // Marquer comme lue
    const markAsRead = useCallback(async (notificationId) => {
        try {
            await db.from('notifications')
                .update({ is_read: true, read_at: new Date().toISOString() })
                .eq('id', notificationId);

            setNotifications(prev =>
                prev.map(n => n.id === notificationId ? { ...n, is_read: true, read_at: new Date().toISOString() } : n)
            );
            setUnreadCount(prev => Math.max(0, prev - 1));
        } catch (err) {
            console.error('Erreur markAsRead:', err);
        }
    }, []);

    // Marquer toutes comme lues
    const markAllAsRead = useCallback(async () => {
        try {
            await db.from('notifications')
                .update({ is_read: true, read_at: new Date().toISOString() })
                .eq('user_id', userId)
                .eq('is_read', false);

            setNotifications(prev => prev.map(n => ({ ...n, is_read: true })));
            setUnreadCount(0);
        } catch (err) {
            console.error('Erreur markAllAsRead:', err);
        }
    }, [userId]);

    // Supprimer une notification
    const deleteNotification = useCallback(async (notificationId) => {
        try {
            const notif = notifications.find(n => n.id === notificationId);
            
            await db.from('notifications').delete().eq('id', notificationId);

            setNotifications(prev => prev.filter(n => n.id !== notificationId));
            if (notif && !notif.is_read) {
                setUnreadCount(prev => Math.max(0, prev - 1));
            }
        } catch (err) {
            console.error('Erreur deleteNotification:', err);
        }
    }, [notifications]);

    // Sauvegarder les préférences
    const savePreferences = useCallback(async (newPrefs) => {
        try {
            await db.from('notification_preferences')
                .upsert({ ...newPrefs, user_id: userId, updated_at: new Date().toISOString() });
            setPreferences(newPrefs);
        } catch (err) {
            console.error('Erreur savePreferences:', err);
        }
    }, [userId]);

    // Effet initial + temps réel
    useEffect(() => {
        if (!userId) return;

        loadNotifications();
        loadPreferences();

        // Écouter les nouvelles notifications en temps réel
        const channel = db.channel('notifications-realtime-' + userId)
            .on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'notifications',
                filter: `user_id=eq.${userId}`
            }, (payload) => {
                const newNotif = payload.new;
                setNotifications(prev => [newNotif, ...prev]);
                setUnreadCount(prev => prev + 1);
                
                // Jouer un son si activé
                if (preferences?.sound_enabled !== false) {
                    try {
                        // Créer un son simple avec l'API Web Audio
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.frequency.value = 800;
                        oscillator.type = 'sine';
                        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                    } catch (e) {}
                }
            })
            .subscribe();

        return () => {
            db.removeChannel(channel);
        };
    }, [userId, loadNotifications, loadPreferences]);

    return {
        notifications,
        unreadCount,
        loading,
        preferences,
        markAsRead,
        markAllAsRead,
        deleteNotification,
        savePreferences,
        refresh: loadNotifications
    };
};

// Formater le temps relatif
const formatTimeAgo = (dateString) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return "À l'instant";
    if (diffMins < 60) return `Il y a ${diffMins} min`;
    if (diffHours < 24) return `Il y a ${diffHours}h`;
    if (diffDays < 7) return `Il y a ${diffDays}j`;
    return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
};

// ==========================================
// SYSTÈME DE NOTIFICATIONS AMÉLIORÉ
// ==========================================

// Types de notifications avec leurs icônes et couleurs
const NOTIFICATION_TYPES = {
    // Stock
    stock_alert: { icon: '⚠️', color: '#F59E0B', label: 'Alerte stock' },
    stock_withdrawal: { icon: '📦', color: '#3B82F6', label: 'Sortie de stock' },
    part_request: { icon: '🛒', color: '#8B5CF6', label: 'Demande de pièce' },
    part_request_validated: { icon: '✅', color: '#10B981', label: 'Demande validée' },
    part_request_rejected: { icon: '❌', color: '#EF4444', label: 'Demande refusée' },
    
    // Travaux
    task_assigned: { icon: '📋', color: '#3B82F6', label: 'Travail assigné' },
    task_completed: { icon: '✅', color: '#10B981', label: 'Travail terminé' },
    task_overdue: { icon: '⏰', color: '#EF4444', label: 'Travail en retard' },
    
    // Commandes
    order_created: { icon: '🛍️', color: '#8B5CF6', label: 'Nouvelle commande' },
    order_received: { icon: '📬', color: '#10B981', label: 'Commande reçue' },
    order_partial: { icon: '📦', color: '#F59E0B', label: 'Réception partielle' },
    
    // Planning
    planning_event_created: { icon: '📅', color: '#3B82F6', label: 'Événement créé' },
    planning_event_modified: { icon: '✏️', color: '#F59E0B', label: 'Événement modifié' },
    planning_event_deleted: { icon: '🗑️', color: '#EF4444', label: 'Événement supprimé' },
    planning_event_assigned: { icon: '👤', color: '#8B5CF6', label: 'Événement assigné' },
    
    // Feuilles d'heures
    timesheet_submitted: { icon: '📝', color: '#3B82F6', label: 'Feuille soumise' },
    timesheet_validated: { icon: '✅', color: '#10B981', label: 'Feuille validée' },
    timesheet_rejected: { icon: '❌', color: '#EF4444', label: 'Feuille refusée' },
    timesheet_reminder: { icon: '⏰', color: '#F59E0B', label: 'Rappel feuille d\'heures' },
    
    // Mise en service
    device_created: { icon: '🏗️', color: '#8B5CF6', label: 'Nouvel appareil MES' },
    device_updated: { icon: '✏️', color: '#3B82F6', label: 'Appareil modifié' },
    device_archived: { icon: '📦', color: '#6B7280', label: 'Appareil archivé' },
    inspection_report_created: { icon: '📋', color: '#10B981', label: 'Rapport d\'inspection' },
    inspection_report_validated: { icon: '✅', color: '#10B981', label: 'Inspection validée' },
    bc_report_created: { icon: '🏛️', color: '#F59E0B', label: 'Rapport BC créé' },
    bc_report_favorable: { icon: '✅', color: '#10B981', label: 'BC favorable' },
    bc_report_defavorable: { icon: '❌', color: '#EF4444', label: 'BC défavorable' },
    
    // Demandes intervention
    request_created: { icon: '🔧', color: '#F97316', label: 'Nouvelle demande' },
    request_assigned: { icon: '👤', color: '#3B82F6', label: 'Demande assignée' },
    request_completed: { icon: '✅', color: '#10B981', label: 'Demande traitée' },
    
    // Système
    system_message: { icon: '💬', color: '#6B7280', label: 'Message système' },
    user_mention: { icon: '@', color: '#EC4899', label: 'Mention' },
    welcome: { icon: '👋', color: '#10B981', label: 'Bienvenue' }
};

// Fonction pour créer une notification
const createNotification = async (params) => {
    const { 
        userId,          // ID de l'utilisateur destinataire (requis)
        type,            // Type de notification (requis)
        title,           // Titre (requis)
        body = null,     // Corps du message (optionnel)
        actionUrl = null // URL d'action (optionnel)
    } = params;
    
    if (!userId || !type || !title) {
        console.error('createNotification: paramètres manquants', params);
        return null;
    }
    
    const notifType = NOTIFICATION_TYPES[type] || NOTIFICATION_TYPES.system_message;
    
    try {
        const { data, error } = await db.from('notifications').insert({
            user_id: userId,
            type: type,
            icon: notifType.icon,
            title: title,
            body: body,
            action_url: actionUrl,
            is_read: false,
            created_at: new Date().toISOString()
        }).select().single();
        
        if (error) {
            console.error('Erreur création notification:', error);
            return null;
        }
        
        console.log('📬 Notification créée:', type, title);
        return data;
    } catch (err) {
        console.error('Erreur création notification:', err);
        return null;
    }
};

// Fonction pour envoyer une notification à plusieurs utilisateurs
const createNotificationForUsers = async (userIds, params) => {
    const results = await Promise.all(
        userIds.map(userId => createNotification({ ...params, userId }))
    );
    return results.filter(r => r !== null);
};

// Fonction pour envoyer une notification à tous les admins
const notifyAdmins = async (users, params) => {
    const adminIds = users.filter(u => u.role === 'admin').map(u => u.id);
    return createNotificationForUsers(adminIds, params);
};

// Fonction pour envoyer une notification à tous les techniciens
const notifyTechnicians = async (users, params) => {
    const techIds = users.filter(u => u.role === 'admin' || u.role === 'technicien').map(u => u.id);
    return createNotificationForUsers(techIds, params);
};

// Composant NotificationDropdown
const NotificationDropdown = ({ notifications, unreadCount, loading, onMarkAsRead, onMarkAllAsRead, onDelete, onClose, onNavigate, userId, allUsers }) => {
    // Grouper par date
    const groupedNotifications = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        const groups = { today: [], yesterday: [], older: [] };

        notifications.forEach(n => {
            const date = new Date(n.created_at);
            date.setHours(0, 0, 0, 0);

            if (date.getTime() === today.getTime()) {
                groups.today.push(n);
            } else if (date.getTime() === yesterday.getTime()) {
                groups.yesterday.push(n);
            } else {
                groups.older.push(n);
            }
        });

        return groups;
    }, [notifications]);

    const handleClick = (notif) => {
        if (!notif.is_read) {
            onMarkAsRead(notif.id);
        }
        if (notif.action_url) {
            onNavigate(notif.action_url);
        }
        onClose();
    };
    
    // Créer une notification de test pour TOUS les utilisateurs
    const createTestNotification = async () => {
        if (!userId) return;
        const messages = [
            { type: 'task_assigned', title: 'Nouveau travail assigné', body: 'Ascenseur A123 - Remplacement câbles' },
            { type: 'order_received', title: 'Commande reçue', body: 'Câbles 8mm x 50m - En stock' },
            { type: 'planning_event_assigned', title: 'Événement planifié', body: 'Contrôle BC demain 9h00' },
            { type: 'device_created', title: 'Nouvel appareil MES', body: 'AP-2024-015 - Résidence Les Lilas' },
            { type: 'system_message', title: '🔔 Test temps réel', body: 'Cette notification a été envoyée à tous les utilisateurs !' }
        ];
        const msg = messages[Math.floor(Math.random() * messages.length)];
        
        // Envoyer à TOUS les utilisateurs pour tester le temps réel
        const users = allUsers || [];
        if (users.length > 0) {
            for (const user of users) {
                await createNotification({
                    userId: user.id,
                    type: msg.type,
                    title: msg.title,
                    body: msg.body,
                    actionUrl: '/dashboard'
                });
            }
            console.log(`📬 Notification envoyée à ${users.length} utilisateur(s)`);
        } else {
            // Fallback: envoyer à soi-même
            await createNotification({
                userId: userId,
                type: msg.type,
                title: msg.title,
                body: msg.body,
                actionUrl: '/dashboard'
            });
        }
    };

    const renderNotificationItem = (notif) => h('div', {
        key: notif.id,
        className: `notif-item ${notif.is_read ? '' : 'unread'}`,
        onClick: () => handleClick(notif)
    },
        h('div', { className: `notif-icon ${notif.type}` }, notif.icon || '🔔'),
        h('div', { className: 'notif-content' },
            h('div', { className: 'notif-title' }, notif.title),
            notif.body && h('div', { className: 'notif-body' }, notif.body),
            h('div', { className: 'notif-time' }, formatTimeAgo(notif.created_at))
        ),
        !notif.is_read && h('div', { className: 'notif-dot' }),
        h('button', {
            className: 'btn btn-ghost btn-sm',
            onClick: (e) => { e.stopPropagation(); onDelete(notif.id); },
            title: 'Supprimer',
            style: { padding: '4px', marginLeft: 4, opacity: 0.5 }
        }, '×')
    );

    return h('div', { className: 'notif-dropdown' },
        h('div', { className: 'notif-header' },
            h('div', { className: 'notif-header-title' },
                '🔔 Notifications',
                unreadCount > 0 && h('span', { className: 'notif-header-count' }, unreadCount)
            ),
            h('div', { className: 'notif-header-actions' },
                unreadCount > 0 && h('button', {
                    className: 'btn btn-ghost btn-sm',
                    onClick: onMarkAllAsRead,
                    title: 'Tout marquer comme lu'
                }, h(Icon, { name: 'check', size: 14 }), 'Tout lu')
            )
        ),
        
        h('div', { className: 'notif-list' },
            loading ? h('div', { className: 'notif-empty' }, 'Chargement...') :
            notifications.length === 0 ? h('div', { className: 'notif-empty' },
                h('div', { className: 'notif-empty-icon' }, '🔔'),
                h('div', null, 'Aucune notification'),
                h('button', { 
                    className: 'btn btn-primary btn-sm', 
                    onClick: createTestNotification,
                    style: { marginTop: 12 }
                }, '📢 Notifier tout le monde')
            ) : h(Fragment, null,
                groupedNotifications.today.length > 0 && h(Fragment, null,
                    h('div', { style: { padding: '8px 20px', fontSize: 11, fontWeight: 600, color: COLORS.muted, textTransform: 'uppercase', background: COLORS.background } }, "Aujourd'hui"),
                    groupedNotifications.today.map(renderNotificationItem)
                ),
                groupedNotifications.yesterday.length > 0 && h(Fragment, null,
                    h('div', { style: { padding: '8px 20px', fontSize: 11, fontWeight: 600, color: COLORS.muted, textTransform: 'uppercase', background: COLORS.background } }, 'Hier'),
                    groupedNotifications.yesterday.map(renderNotificationItem)
                ),
                groupedNotifications.older.length > 0 && h(Fragment, null,
                    h('div', { style: { padding: '8px 20px', fontSize: 11, fontWeight: 600, color: COLORS.muted, textTransform: 'uppercase', background: COLORS.background } }, 'Plus ancien'),
                    groupedNotifications.older.map(renderNotificationItem)
                )
            )
        ),
        
        // Footer avec bouton de test
        h('div', { className: 'notif-footer', style: { borderTop: `1px solid ${COLORS.border}`, padding: '8px 16px', display: 'flex', justifyContent: 'center' } },
            h('button', { 
                className: 'btn btn-ghost btn-sm',
                onClick: createTestNotification,
                style: { fontSize: 12 }
            }, '📢 Notifier tout le monde')
        )
    );
};

// Empty State Component
const EmptyState = ({ icon, title, description, action }) => h('div', { className: 'empty-state' }, 
    h(Icon, { name: icon, size: 64 }), 
    h('h3', null, title), 
    h('p', null, description), 
    action
);

// ==========================================
// COMPOSANTS v5.7 - Nouvelles fonctionnalités
// ==========================================

// Indicateur de connexion hors-ligne
const OfflineIndicator = () => {
    const [isOnline, setIsOnline] = useState(navigator.onLine);
    const [pendingSync, setPendingSync] = useState(0);
    const [showDetails, setShowDetails] = useState(false);
    
    useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        const handleQueueUpdate = (e) => setPendingSync(e.detail.count);
        
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        window.addEventListener('offline-queue-update', handleQueueUpdate);
        
        setPendingSync(OfflineService.getPendingCount());
        
        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
            window.removeEventListener('offline-queue-update', handleQueueUpdate);
        };
    }, []);
    
    if (isOnline && pendingSync === 0) return null;
    
    return h('div', { 
        style: { 
            position: 'fixed', 
            bottom: 20, 
            left: 20, 
            zIndex: 9999,
            display: 'flex',
            flexDirection: 'column',
            gap: 8
        }
    },
        !isOnline && h('div', {
            style: {
                display: 'flex',
                alignItems: 'center',
                gap: 8,
                padding: '10px 16px',
                background: '#FEF3C7',
                border: '1px solid #F59E0B',
                borderRadius: 12,
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                cursor: 'pointer'
            },
            onClick: () => setShowDetails(!showDetails)
        },
            h('div', { style: { width: 10, height: 10, borderRadius: '50%', background: '#F59E0B', animation: 'pulse 2s infinite' } }),
            h('span', { style: { fontWeight: 600, color: '#92400E' } }, '📴 Mode hors-ligne'),
            pendingSync > 0 && h('span', { 
                style: { 
                    background: '#F59E0B', 
                    color: 'white', 
                    padding: '2px 8px', 
                    borderRadius: 10, 
                    fontSize: 12,
                    fontWeight: 600 
                } 
            }, pendingSync)
        ),
        
        isOnline && pendingSync > 0 && h('div', {
            style: {
                display: 'flex',
                alignItems: 'center',
                gap: 8,
                padding: '10px 16px',
                background: '#DBEAFE',
                border: '1px solid #3B82F6',
                borderRadius: 12,
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                cursor: 'pointer'
            },
            onClick: async () => {
                const result = await OfflineService.sync();
                window.dispatchEvent(new CustomEvent('show-toast', { 
                    detail: { message: `${result.synced} synchronisé(s)`, type: 'success' } 
                }));
            }
        },
            h('div', { style: { width: 10, height: 10, borderRadius: '50%', background: '#3B82F6', animation: 'pulse 1s infinite' } }),
            h('span', { style: { fontWeight: 600, color: '#1E40AF' } }, '🔄 Synchronisation...'),
            h('span', { style: { color: '#1E40AF', fontSize: 13 } }, `${pendingSync} en attente`)
        )
    );
};

// Panneau Chat interne v5.7
const ChatPanelV2 = ({ isOpen, onClose, user, data, taskId = null }) => {
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [loading, setLoading] = useState(true);
    const messagesEndRef = useRef(null);
    
    useEffect(() => {
        if (isOpen) {
            loadMessages();
        }
    }, [isOpen, taskId]);
    
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);
    
    const loadMessages = async () => {
        setLoading(true);
        const msgs = await ChatServiceV2.loadMessages(taskId);
        setMessages(msgs);
        setLoading(false);
    };
    
    const sendMessage = async () => {
        if (!newMessage.trim()) return;
        
        // Détecter les mentions @nom
        const mentionRegex = /@(\w+)/g;
        const mentions = [];
        let match;
        while ((match = mentionRegex.exec(newMessage)) !== null) {
            const mentioned = data.users.find(u => 
                u.first_name?.toLowerCase() === match[1].toLowerCase() ||
                u.email.split('@')[0].toLowerCase() === match[1].toLowerCase()
            );
            if (mentioned) mentions.push(mentioned.id);
        }
        
        const msg = await ChatServiceV2.sendMessage(newMessage, user.id, taskId, mentions);
        setMessages([...messages, { ...msg, sender: user }]);
        setNewMessage('');
        
        // Notifier les mentions
        mentions.forEach(mentionId => {
            const mentioned = data.users.find(u => u.id === mentionId);
            if (mentioned) {
                PushNotificationService.notifyChatMessage(msg, user);
            }
        });
    };
    
    if (!isOpen) return null;
    
    return h('div', { 
        style: { 
            position: 'fixed', 
            right: 20, 
            bottom: 20, 
            width: 380, 
            height: 500, 
            background: 'var(--card)', 
            borderRadius: 16, 
            boxShadow: '0 10px 40px rgba(0,0,0,0.2)',
            display: 'flex',
            flexDirection: 'column',
            zIndex: 9998,
            overflow: 'hidden'
        } 
    },
        // Header
        h('div', { style: { padding: '16px 20px', background: 'linear-gradient(135deg, #3B82F6, #8B5CF6)', color: 'white', display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
            h('div', null,
                h('div', { style: { fontWeight: 700, fontSize: 16 } }, '💬 Chat équipe'),
                taskId && h('div', { style: { fontSize: 12, opacity: 0.8 } }, 'Discussion liée à la tâche')
            ),
            h('button', { onClick: onClose, style: { background: 'rgba(255,255,255,0.2)', border: 'none', borderRadius: 8, padding: '6px 10px', color: 'white', cursor: 'pointer' } }, '✕')
        ),
        
        // Messages
        h('div', { style: { flex: 1, overflowY: 'auto', padding: 16 } },
            loading ? h('div', { style: { textAlign: 'center', padding: 20, color: COLORS.muted } }, 'Chargement...') :
            messages.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun message') :
            messages.map(msg => {
                const isMine = msg.user_id === user.id;
                const sender = msg.sender || data.users.find(u => u.id === msg.user_id) || {};
                return h('div', { 
                    key: msg.id, 
                    style: { 
                        marginBottom: 12, 
                        display: 'flex', 
                        justifyContent: isMine ? 'flex-end' : 'flex-start' 
                    } 
                },
                    h('div', { style: { maxWidth: '80%' } },
                        !isMine && h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 
                            sender.first_name || sender.email?.split('@')[0] || 'Inconnu'
                        ),
                        h('div', { 
                            style: { 
                                padding: '10px 14px', 
                                borderRadius: 16, 
                                background: isMine ? '#3B82F6' : COLORS.background,
                                color: isMine ? 'white' : COLORS.text,
                                fontSize: 14
                            } 
                        }, msg.content),
                        h('div', { style: { fontSize: 10, color: COLORS.muted, marginTop: 4, textAlign: isMine ? 'right' : 'left' } }, 
                            new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
                        )
                    )
                );
            }),
            h('div', { ref: messagesEndRef })
        ),
        
        // Input
        h('div', { style: { padding: 12, borderTop: '1px solid ' + COLORS.border, display: 'flex', gap: 8 } },
            h('input', { 
                type: 'text', 
                placeholder: 'Écrire un message... (@nom pour mentionner)',
                value: newMessage,
                onChange: e => setNewMessage(e.target.value),
                onKeyPress: e => e.key === 'Enter' && sendMessage(),
                style: { flex: 1, padding: '10px 14px', border: '1px solid ' + COLORS.border, borderRadius: 24, outline: 'none' }
            }),
            h('button', { 
                onClick: sendMessage, 
                disabled: !newMessage.trim(),
                style: { 
                    padding: '10px 16px', 
                    background: '#3B82F6', 
                    color: 'white', 
                    border: 'none', 
                    borderRadius: 24, 
                    cursor: 'pointer',
                    opacity: newMessage.trim() ? 1 : 0.5
                } 
            }, '➤')
        )
    );
};

// Visualiseur d'historique des actions
const AuditLogViewer = ({ isOpen, onClose, user }) => {
    const [logs, setLogs] = useState([]);
    const [filter, setFilter] = useState({ action: '', user: '' });
    const [dateRange, setDateRange] = useState({ start: '', end: '' });
    
    useEffect(() => {
        if (isOpen) {
            setLogs(AuditLogService.getRecentLogs(100));
        }
    }, [isOpen]);
    
    const filteredLogs = useMemo(() => {
        return logs.filter(log => {
            if (filter.action && log.action !== filter.action) return false;
            if (filter.user && log.userId !== filter.user) return false;
            if (dateRange.start && new Date(log.timestamp) < new Date(dateRange.start)) return false;
            if (dateRange.end && new Date(log.timestamp) > new Date(dateRange.end + 'T23:59:59')) return false;
            return true;
        });
    }, [logs, filter, dateRange]);
    
    const actionColors = {
        'LOGIN': '#10B981',
        'LOGOUT': '#6B7280',
        'CREATE': '#3B82F6',
        'UPDATE': '#F59E0B',
        'DELETE': '#EF4444'
    };
    
    const actionIcons = {
        'LOGIN': '🔓',
        'LOGOUT': '🔒',
        'CREATE': '➕',
        'UPDATE': '✏️',
        'DELETE': '🗑️'
    };
    
    if (!isOpen) return null;
    
    return h(Modal, { isOpen: true, onClose, title: '📋 Historique des actions', size: 'xl' },
        h('div', null,
            // Filtres
            h('div', { style: { display: 'flex', gap: 12, marginBottom: 20, flexWrap: 'wrap' } },
                h('select', { 
                    className: 'form-select', 
                    style: { width: 150 },
                    value: filter.action, 
                    onChange: e => setFilter({...filter, action: e.target.value}) 
                },
                    h('option', { value: '' }, 'Toutes actions'),
                    h('option', { value: 'LOGIN' }, '🔓 Connexion'),
                    h('option', { value: 'LOGOUT' }, '🔒 Déconnexion'),
                    h('option', { value: 'CREATE' }, '➕ Création'),
                    h('option', { value: 'UPDATE' }, '✏️ Modification'),
                    h('option', { value: 'DELETE' }, '🗑️ Suppression')
                ),
                h('input', { 
                    type: 'date', 
                    className: 'form-input', 
                    style: { width: 150 },
                    value: dateRange.start,
                    onChange: e => setDateRange({...dateRange, start: e.target.value}),
                    placeholder: 'Date début'
                }),
                h('input', { 
                    type: 'date', 
                    className: 'form-input', 
                    style: { width: 150 },
                    value: dateRange.end,
                    onChange: e => setDateRange({...dateRange, end: e.target.value}),
                    placeholder: 'Date fin'
                }),
                h('button', { 
                    className: 'btn btn-ghost', 
                    onClick: () => { setFilter({ action: '', user: '' }); setDateRange({ start: '', end: '' }); }
                }, '↺ Reset'),
                h('button', { 
                    className: 'btn btn-secondary',
                    style: { marginLeft: 'auto' },
                    onClick: () => {
                        const blob = new Blob([AuditLogService.exportLogs()], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `audit-log-${new Date().toISOString().split('T')[0]}.json`;
                        a.click();
                    }
                }, '📥 Exporter')
            ),
            
            // Résumé
            h('div', { style: { display: 'flex', gap: 12, marginBottom: 16 } },
                h('div', { style: { padding: '8px 16px', background: COLORS.background, borderRadius: 8, fontSize: 13 } },
                    h('strong', null, filteredLogs.length), ' entrée(s)'
                )
            ),
            
            // Liste des logs
            h('div', { style: { maxHeight: 500, overflowY: 'auto' } },
                filteredLogs.length === 0 ? 
                    h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune entrée') :
                    filteredLogs.map(log => h('div', { 
                        key: log.id, 
                        style: { 
                            display: 'flex', 
                            alignItems: 'flex-start', 
                            gap: 12, 
                            padding: 12, 
                            borderBottom: '1px solid ' + COLORS.border,
                            background: 'transparent',
                            transition: 'background 0.2s'
                        },
                        onMouseOver: e => e.currentTarget.style.background = COLORS.background,
                        onMouseOut: e => e.currentTarget.style.background = 'transparent'
                    },
                        h('div', { 
                            style: { 
                                width: 36, 
                                height: 36, 
                                borderRadius: 8, 
                                background: actionColors[log.action] + '20',
                                display: 'flex', 
                                alignItems: 'center', 
                                justifyContent: 'center',
                                fontSize: 16,
                                flexShrink: 0
                            } 
                        }, actionIcons[log.action] || '📌'),
                        h('div', { style: { flex: 1, minWidth: 0 } },
                            h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 4 } },
                                h('span', { style: { fontWeight: 600 } }, log.action),
                                h('span', { style: { fontSize: 12, color: COLORS.muted } }, 
                                    new Date(log.timestamp).toLocaleString('fr-FR')
                                )
                            ),
                            h('div', { style: { fontSize: 13, color: COLORS.text } }, 
                                log.details?.summary || log.details?.table || '-'
                            ),
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 4 } }, 
                                '👤 ', log.userName
                            )
                        )
                    ))
            )
        )
    );
};

// Composant Optimiseur de route
const RouteOptimizer = ({ tasks, isOpen, onClose, onApply }) => {
    const [optimizedTasks, setOptimizedTasks] = useState([]);
    const [stats, setStats] = useState({ before: 0, after: 0, saved: 0 });
    const [startLocation, setStartLocation] = useState({ lat: '', lon: '' });
    
    useEffect(() => {
        if (isOpen && tasks.length > 0) {
            optimize();
        }
    }, [isOpen, tasks]);
    
    const optimize = () => {
        const geoTasks = tasks.filter(t => t.latitude && t.longitude);
        if (geoTasks.length < 2) {
            setOptimizedTasks(geoTasks);
            return;
        }
        
        // Calculer distance avant optimisation
        const distBefore = RoutingService.calculateTotalDistance(geoTasks);
        
        // Optimiser
        const startLat = startLocation.lat ? parseFloat(startLocation.lat) : null;
        const startLon = startLocation.lon ? parseFloat(startLocation.lon) : null;
        const optimized = RoutingService.optimizeRoute(geoTasks, startLat, startLon);
        
        // Calculer distance après
        const distAfter = RoutingService.calculateTotalDistance(optimized);
        
        setOptimizedTasks(optimized);
        setStats({
            before: distBefore,
            after: distAfter,
            saved: distBefore - distAfter,
            time: RoutingService.estimateTravelTime(distAfter)
        });
    };
    
    if (!isOpen) return null;
    
    return h(Modal, { isOpen: true, onClose, title: '🗺️ Optimisation d\'itinéraire', size: 'lg' },
        h('div', null,
            // Point de départ optionnel
            h('div', { style: { marginBottom: 20, padding: 16, background: COLORS.background, borderRadius: 8 } },
                h('div', { style: { fontWeight: 600, marginBottom: 8 } }, '📍 Point de départ (optionnel)'),
                h('div', { style: { display: 'flex', gap: 12 } },
                    h('input', { 
                        type: 'number', 
                        step: 'any',
                        className: 'form-input', 
                        placeholder: 'Latitude',
                        value: startLocation.lat,
                        onChange: e => setStartLocation({...startLocation, lat: e.target.value}),
                        style: { width: 150 }
                    }),
                    h('input', { 
                        type: 'number',
                        step: 'any', 
                        className: 'form-input', 
                        placeholder: 'Longitude',
                        value: startLocation.lon,
                        onChange: e => setStartLocation({...startLocation, lon: e.target.value}),
                        style: { width: 150 }
                    }),
                    h('button', { className: 'btn btn-secondary', onClick: optimize }, '🔄 Recalculer')
                )
            ),
            
            // Statistiques
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 12, marginBottom: 20 } },
                h('div', { style: { padding: 16, background: COLORS.infoPastel, borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.info } }, optimizedTasks.length),
                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Étapes')
                ),
                h('div', { style: { padding: 16, background: COLORS.warningPastel, borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.warning } }, stats.before.toFixed(1), ' km'),
                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Avant')
                ),
                h('div', { style: { padding: 16, background: COLORS.successPastel, borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.success } }, stats.after.toFixed(1), ' km'),
                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Après')
                ),
                h('div', { style: { padding: 16, background: stats.saved > 0 ? '#D1FAE5' : COLORS.background, borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: stats.saved > 0 ? COLORS.success : COLORS.muted } }, 
                        stats.saved > 0 ? '-' + stats.saved.toFixed(1) + ' km' : '0 km'
                    ),
                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Économie')
                )
            ),
            
            // Liste des étapes optimisées
            h('div', { style: { marginBottom: 20 } },
                h('div', { style: { fontWeight: 600, marginBottom: 12 } }, 'Ordre optimisé'),
                h('div', { style: { maxHeight: 250, overflowY: 'auto' } },
                    optimizedTasks.map((task, idx) => h('div', { 
                        key: task.id, 
                        style: { 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: 12, 
                            padding: '10px 12px', 
                            borderBottom: '1px solid ' + COLORS.border 
                        } 
                    },
                        h('div', { 
                            style: { 
                                width: 28, 
                                height: 28, 
                                borderRadius: '50%', 
                                background: COLORS.primary, 
                                color: 'white', 
                                display: 'flex', 
                                alignItems: 'center', 
                                justifyContent: 'center',
                                fontSize: 12,
                                fontWeight: 700
                            } 
                        }, idx + 1),
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { fontWeight: 500 } }, task.device_number || task.location || 'Tâche'),
                            h('div', { style: { fontSize: 12, color: COLORS.muted } }, task.event_category || task.scheduled_time || '')
                        ),
                        idx < optimizedTasks.length - 1 && h('div', { style: { fontSize: 12, color: COLORS.muted } },
                            RoutingService.calculateDistance(
                                task.latitude, task.longitude,
                                optimizedTasks[idx + 1].latitude, optimizedTasks[idx + 1].longitude
                            ).toFixed(1), ' km →'
                        )
                    ))
                )
            ),
            
            // Actions
            h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end' } },
                h('button', { 
                    className: 'btn btn-secondary', 
                    onClick: () => RoutingService.openInMaps(optimizedTasks, 'waze')
                }, '🚗 Waze'),
                h('button', { 
                    className: 'btn btn-secondary', 
                    onClick: () => RoutingService.openInMaps(optimizedTasks, 'google')
                }, '🗺️ Google Maps'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, 'Fermer'),
                onApply && h('button', { 
                    className: 'btn btn-primary', 
                    onClick: () => { onApply(optimizedTasks); onClose(); }
                }, '✓ Appliquer cet ordre')
            )
        )
    );
};

// Gestionnaire de rapports automatiques
const AutoReportsManager = ({ isOpen, onClose, data }) => {
    const [reports, setReports] = useState([]);
    const [generating, setGenerating] = useState(false);
    const [showSchedule, setShowSchedule] = useState(false);
    const [scheduleForm, setScheduleForm] = useState({
        templateId: 'monthly_activity',
        frequency: 'monthly',
        dayOfMonth: 1,
        dayOfWeek: 1,
        hour: 8
    });
    
    useEffect(() => {
        setReports(AutoReportService.scheduledReports);
    }, [isOpen]);
    
    const generateNow = async (templateId) => {
        setGenerating(true);
        try {
            await AutoReportService.downloadReport(templateId, data);
            window.dispatchEvent(new CustomEvent('show-toast', { 
                detail: { message: 'Rapport généré et téléchargé', type: 'success' } 
            }));
        } catch (err) {
            window.dispatchEvent(new CustomEvent('show-toast', { 
                detail: { message: 'Erreur: ' + err.message, type: 'error' } 
            }));
        }
        setGenerating(false);
    };
    
    const scheduleReport = () => {
        AutoReportService.scheduleReport({
            templateId: scheduleForm.templateId,
            schedule: {
                frequency: scheduleForm.frequency,
                dayOfMonth: scheduleForm.dayOfMonth,
                dayOfWeek: scheduleForm.dayOfWeek,
                hour: scheduleForm.hour
            }
        });
        setReports([...AutoReportService.scheduledReports]);
        setShowSchedule(false);
        window.dispatchEvent(new CustomEvent('show-toast', { 
            detail: { message: 'Rapport planifié', type: 'success' } 
        }));
    };
    
    if (!isOpen) return null;
    
    return h(Modal, { isOpen: true, onClose, title: '📊 Rapports automatiques', size: 'lg' },
        h('div', null,
            // Templates disponibles
            h('div', { style: { marginBottom: 24 } },
                h('h4', { style: { marginBottom: 12 } }, 'Générer maintenant'),
                h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12 } },
                    Object.entries(AutoReportService.templates).map(([id, template]) => 
                        h('div', { 
                            key: id, 
                            style: { 
                                padding: 16, 
                                border: '1px solid ' + COLORS.border, 
                                borderRadius: 12,
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            },
                            onClick: () => generateNow(id),
                            onMouseOver: e => e.currentTarget.style.borderColor = COLORS.primary,
                            onMouseOut: e => e.currentTarget.style.borderColor = COLORS.border
                        },
                            h('div', { style: { fontSize: 24, marginBottom: 8 } }, 
                                id === 'monthly_activity' ? '📈' : id === 'stock_inventory' ? '📦' : '📅'
                            ),
                            h('div', { style: { fontWeight: 600, marginBottom: 4 } }, template.name),
                            h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Cliquer pour générer')
                        )
                    )
                )
            ),
            
            generating && h('div', { style: { textAlign: 'center', padding: 20 } },
                h('div', { style: { fontSize: 32, marginBottom: 8 } }, '⏳'),
                'Génération en cours...'
            ),
            
            // Planification
            h('div', { style: { marginBottom: 24 } },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                    h('h4', null, 'Rapports planifiés'),
                    h('button', { className: 'btn btn-sm btn-primary', onClick: () => setShowSchedule(true) }, '+ Planifier')
                ),
                
                reports.length === 0 ? 
                    h('div', { style: { padding: 20, textAlign: 'center', color: COLORS.muted, background: COLORS.background, borderRadius: 8 } }, 
                        'Aucun rapport planifié'
                    ) :
                    h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                        reports.map(report => {
                            const template = AutoReportService.templates[report.templateId];
                            return h('div', { 
                                key: report.id, 
                                style: { 
                                    display: 'flex', 
                                    justifyContent: 'space-between', 
                                    alignItems: 'center', 
                                    padding: 12, 
                                    background: COLORS.background, 
                                    borderRadius: 8 
                                } 
                            },
                                h('div', null,
                                    h('div', { style: { fontWeight: 600 } }, template?.name || report.templateId),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 
                                        report.schedule.frequency === 'daily' ? 'Quotidien' :
                                        report.schedule.frequency === 'weekly' ? `Hebdo (${['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'][report.schedule.dayOfWeek]})` :
                                        `Mensuel (${report.schedule.dayOfMonth})`
                                    )
                                ),
                                h('div', { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                                    h('span', { className: `badge badge-${report.enabled ? 'success' : 'secondary'}` }, 
                                        report.enabled ? 'Actif' : 'Inactif'
                                    ),
                                    h('button', { 
                                        className: 'btn btn-sm btn-danger',
                                        onClick: () => {
                                            AutoReportService.scheduledReports = AutoReportService.scheduledReports.filter(r => r.id !== report.id);
                                            AutoReportService.save();
                                            setReports([...AutoReportService.scheduledReports]);
                                        }
                                    }, '🗑️')
                                )
                            );
                        })
                    )
            ),
            
            // Formulaire de planification
            showSchedule && h('div', { style: { padding: 16, background: COLORS.infoPastel, borderRadius: 8, marginBottom: 16 } },
                h('h5', { style: { marginBottom: 12 } }, 'Nouveau rapport planifié'),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' },
                        h('label', null, 'Rapport'),
                        h('select', { className: 'form-select', value: scheduleForm.templateId, onChange: e => setScheduleForm({...scheduleForm, templateId: e.target.value}) },
                            Object.entries(AutoReportService.templates).map(([id, t]) => 
                                h('option', { key: id, value: id }, t.name)
                            )
                        )
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Fréquence'),
                        h('select', { className: 'form-select', value: scheduleForm.frequency, onChange: e => setScheduleForm({...scheduleForm, frequency: e.target.value}) },
                            h('option', { value: 'daily' }, 'Quotidien'),
                            h('option', { value: 'weekly' }, 'Hebdomadaire'),
                            h('option', { value: 'monthly' }, 'Mensuel')
                        )
                    ),
                    scheduleForm.frequency === 'weekly' && h('div', { className: 'form-group' },
                        h('label', null, 'Jour'),
                        h('select', { className: 'form-select', value: scheduleForm.dayOfWeek, onChange: e => setScheduleForm({...scheduleForm, dayOfWeek: parseInt(e.target.value)}) },
                            h('option', { value: 1 }, 'Lundi'),
                            h('option', { value: 2 }, 'Mardi'),
                            h('option', { value: 3 }, 'Mercredi'),
                            h('option', { value: 4 }, 'Jeudi'),
                            h('option', { value: 5 }, 'Vendredi')
                        )
                    ),
                    scheduleForm.frequency === 'monthly' && h('div', { className: 'form-group' },
                        h('label', null, 'Jour du mois'),
                        h('input', { type: 'number', className: 'form-input', min: 1, max: 28, value: scheduleForm.dayOfMonth, onChange: e => setScheduleForm({...scheduleForm, dayOfMonth: parseInt(e.target.value)}) })
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Heure'),
                        h('input', { type: 'number', className: 'form-input', min: 0, max: 23, value: scheduleForm.hour, onChange: e => setScheduleForm({...scheduleForm, hour: parseInt(e.target.value)}) })
                    )
                ),
                h('div', { style: { display: 'flex', gap: 8, marginTop: 12 } },
                    h('button', { className: 'btn btn-secondary', onClick: () => setShowSchedule(false) }, 'Annuler'),
                    h('button', { className: 'btn btn-primary', onClick: scheduleReport }, 'Planifier')
                )
            )
        )
    );
};

// ==========================================
// COMPOSANTS v5.8 - HMI Avancé
// ==========================================

// Container Toasts améliorés v5.8
const ToastContainerV58 = () => {
    const [toasts, setToasts] = useState([]);
    const [position, setPosition] = useState('top-right');
    
    useEffect(() => {
        const unsubscribe = ToastServiceV58.subscribe((newToasts, newPos) => {
            setToasts([...newToasts]);
            setPosition(newPos);
        });
        return unsubscribe;
    }, []);
    
    const icons = { success: '✓', error: '✕', warning: '⚠', info: 'ℹ' };
    
    return h('div', { className: `toast-v58-container ${position}` },
        toasts.map(toast => h('div', { 
            key: toast.id, 
            className: `toast-v58 ${toast.type} ${toast.exiting ? 'exiting' : ''}`
        },
            h('div', { className: 'toast-v58-icon' }, icons[toast.type] || 'ℹ'),
            h('div', { className: 'toast-v58-content' },
                toast.title && h('div', { className: 'toast-v58-title' }, toast.title),
                h('div', { className: 'toast-v58-message' }, toast.message)
            ),
            toast.closable && h('button', { className: 'toast-v58-close', onClick: () => ToastServiceV58.dismiss(toast.id) }, '×')
        ))
    );
};

// Centre de notifications v5.8
const NotificationCenterV58 = ({ isOpen, onClose, notifications, onMarkAsRead, onMarkAllAsRead }) => {
    const [activeTab, setActiveTab] = useState('all');
    
    const filteredNotifs = useMemo(() => {
        let notifs = notifications || [];
        if (activeTab === 'unread') return notifs.filter(n => !n.read);
        if (activeTab !== 'all') return notifs.filter(n => n.type === activeTab);
        return notifs;
    }, [notifications, activeTab]);
    
    const unreadCount = (notifications || []).filter(n => !n.read).length;
    
    if (!isOpen) return null;
    
    return h('div', null,
        h('div', { className: 'modal-overlay', style: { background: 'rgba(0,0,0,0.3)' }, onClick: onClose }),
        h('div', { className: 'notification-center' },
            h('div', { className: 'notification-center-header' },
                h('div', { className: 'notification-center-title' }, '🔔 Notifications ', unreadCount > 0 && h('span', { style: { fontSize: 13, color: COLORS.muted } }, `(${unreadCount})`)),
                h('div', { style: { display: 'flex', gap: 8 } },
                    unreadCount > 0 && h('button', { className: 'btn btn-sm btn-ghost', onClick: onMarkAllAsRead }, 'Tout marquer lu'),
                    h('button', { className: 'btn btn-sm btn-ghost', onClick: onClose }, '✕')
                )
            ),
            h('div', { className: 'notification-center-tabs' },
                [{ id: 'all', label: 'Tout' }, { id: 'unread', label: 'Non lues' }, { id: 'task', label: '📋' }, { id: 'stock', label: '📦' }].map(tab =>
                    h('button', { key: tab.id, className: `notification-center-tab ${activeTab === tab.id ? 'active' : ''}`, onClick: () => setActiveTab(tab.id) }, tab.label)
                )
            ),
            h('div', { className: 'notification-center-list' },
                filteredNotifs.length === 0 ?
                    h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, '🔔 Aucune notification') :
                    filteredNotifs.slice(0, 50).map(n => h('div', {
                        key: n.id,
                        className: `notification-center-item ${!n.read ? 'unread' : ''}`,
                        onClick: () => onMarkAsRead?.(n.id)
                    },
                        h('div', { style: { width: 40, height: 40, borderRadius: 10, background: COLORS.background, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 18 } },
                            n.type === 'task' ? '📋' : n.type === 'stock' ? '📦' : '🔔'
                        ),
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { fontWeight: !n.read ? 600 : 400 } }, n.title || 'Notification'),
                            h('div', { style: { fontSize: 13, color: COLORS.textSecondary } }, n.message || ''),
                            h('div', { style: { fontSize: 11, color: COLORS.muted, marginTop: 4 } }, formatRelative(n.created_at))
                        ),
                        !n.read && h('div', { style: { width: 8, height: 8, borderRadius: '50%', background: COLORS.primary } })
                    ))
            )
        )
    );
};

// Quick Actions Menu (menu contextuel)
const QuickActionsMenu = ({ isOpen, position, type, item, onAction, onClose }) => {
    const actions = {
        task: [
            { id: 'view', icon: '👁️', label: 'Voir' },
            { id: 'edit', icon: '✏️', label: 'Modifier' },
            { id: 'assign', icon: '👤', label: 'Assigner' },
            { id: 'divider' },
            { id: 'complete', icon: '✅', label: 'Terminer' },
            { id: 'delete', icon: '🗑️', label: 'Supprimer', danger: true }
        ],
        part: [
            { id: 'view', icon: '👁️', label: 'Voir' },
            { id: 'edit', icon: '✏️', label: 'Modifier' },
            { id: 'adjust', icon: '📦', label: 'Ajuster stock' },
            { id: 'divider' },
            { id: 'delete', icon: '🗑️', label: 'Supprimer', danger: true }
        ]
    };
    
    useEffect(() => {
        if (isOpen) {
            const handleClick = () => onClose();
            const handleEsc = (e) => { if (e.key === 'Escape') onClose(); };
            setTimeout(() => document.addEventListener('click', handleClick), 10);
            document.addEventListener('keydown', handleEsc);
            return () => { document.removeEventListener('click', handleClick); document.removeEventListener('keydown', handleEsc); };
        }
    }, [isOpen, onClose]);
    
    if (!isOpen || !position) return null;
    
    return h('div', { className: 'quick-actions-menu', style: { top: position.y, left: position.x } },
        (actions[type] || []).map((action, i) =>
            action.id === 'divider' ? h('div', { key: i, className: 'quick-actions-divider' }) :
            h('div', { key: action.id, className: `quick-actions-item ${action.danger ? 'danger' : ''}`, onClick: (e) => { e.stopPropagation(); onAction(action.id, item); onClose(); } },
                h('span', null, action.icon), h('span', null, action.label)
            )
        )
    );
};

// Barre d'actions groupées
const BulkActionsBar = ({ selectedCount, onAction, onClear, type }) => {
    if (selectedCount === 0) return null;
    
    const actions = type === 'tasks' ? 
        [{ id: 'assign', icon: '👤', label: 'Assigner' }, { id: 'complete', icon: '✅', label: 'Terminer' }, { id: 'export', icon: '📥', label: 'Exporter' }] :
        [{ id: 'export', icon: '📥', label: 'Exporter' }, { id: 'adjust', icon: '📦', label: 'Ajuster' }];
    
    return h('div', { className: 'bulk-actions-bar' },
        h('span', { className: 'bulk-actions-count' }, `${selectedCount} sélectionné(s)`),
        actions.map(a => h('button', { key: a.id, className: 'bulk-actions-btn', onClick: () => onAction(a.id) }, a.icon, ' ', a.label)),
        h('button', { className: 'bulk-actions-btn danger', onClick: () => onAction('delete') }, '🗑️ Supprimer'),
        h('button', { className: 'bulk-actions-btn', onClick: onClear, style: { marginLeft: 8 } }, '✕')
    );
};

// Switcher de vues
const ViewSwitcher = ({ currentView, views, onChange }) => {
    return h('div', { className: 'view-switcher' },
        views.map(v => h('button', {
            key: v.id,
            className: `view-switcher-btn ${currentView === v.id ? 'active' : ''}`,
            onClick: () => onChange(v.id)
        }, v.icon && h('span', null, v.icon), ' ', v.label))
    );
};

// Skeleton Loader v5.8
const SkeletonLoaderV58 = ({ type = 'card', count = 3 }) => {
    return h('div', { className: type === 'card' ? 'grid-view' : null },
        Array.from({ length: count }).map((_, i) => 
            h('div', { key: i, className: `skeleton ${type === 'card' ? 'skeleton-card' : 'skeleton-text'}`, style: { height: type === 'card' ? 120 : 20, marginBottom: 12 } })
        )
    );
};

// KPI animé
const AnimatedKPI = ({ value, label, trend, icon, color }) => {
    const [displayValue, setDisplayValue] = useState(0);
    
    useEffect(() => {
        const numValue = typeof value === 'number' ? value : parseInt(value) || 0;
        const duration = 1000;
        const steps = 30;
        let current = 0;
        let step = 0;
        const increment = numValue / steps;
        
        const timer = setInterval(() => {
            step++;
            current = Math.min(numValue, Math.round(increment * step));
            setDisplayValue(current);
            if (step >= steps) clearInterval(timer);
        }, duration / steps);
        
        return () => clearInterval(timer);
    }, [value]);
    
    return h('div', { className: 'kpi-animated glass-card', style: { padding: 20, borderRadius: 16 } },
        h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 12 } },
            h('div', { style: { width: 48, height: 48, borderRadius: 12, background: `${color || COLORS.primary}20`, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 24 } }, icon || '📊'),
            trend && h('div', { className: `kpi-trend ${trend}` }, trend === 'up' ? '↑' : '↓')
        ),
        h('div', { className: 'kpi-animated-value' }, formatNumber(displayValue)),
        h('div', { style: { fontSize: 13, color: COLORS.textSecondary, marginTop: 4 } }, label)
    );
};

// Sélecteur de Template PDF
const PDFTemplateModal = ({ isOpen, onClose, data, category }) => {
    const [selectedTemplate, setSelectedTemplate] = useState(null);
    const [generating, setGenerating] = useState(false);
    const [activeCategory, setActiveCategory] = useState(category || 'stock');
    const [activeTab, setActiveTab] = useState('templates'); // templates, customize
    const [customConfig, setCustomConfig] = useState(PDFCustomizationService.getConfig());
    const logoInputRef = useRef(null);
    
    const templates = useMemo(() => PDFTemplateServiceV58.getTemplates(activeCategory), [activeCategory]);
    const categories = PDFTemplateServiceV58.getCategories();
    
    const colorOptions = [
        { id: '#E11D48', name: 'Rose' },
        { id: '#3B82F6', name: 'Bleu' },
        { id: '#10B981', name: 'Vert' },
        { id: '#8B5CF6', name: 'Violet' },
        { id: '#F97316', name: 'Orange' },
        { id: '#14B8A6', name: 'Turquoise' },
        { id: '#1E293B', name: 'Sombre' }
    ];
    
    const handleGenerate = async () => {
        if (!selectedTemplate) return;
        setGenerating(true);
        try {
            await PDFTemplateServiceV58.download(selectedTemplate, data);
            ToastServiceV58.success('PDF généré avec succès');
            onClose();
        } catch (err) {
            ToastServiceV58.error('Erreur: ' + err.message);
        }
        setGenerating(false);
    };
    
    const handleLogoUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 500000) {
            ToastServiceV58.error('Le logo doit faire moins de 500 KB');
            return;
        }
        const reader = new FileReader();
        reader.onload = (ev) => {
            const newConfig = { ...customConfig, logo: ev.target.result };
            setCustomConfig(newConfig);
            PDFCustomizationService.setConfig(newConfig);
            ToastServiceV58.success('Logo ajouté');
        };
        reader.readAsDataURL(file);
    };
    
    const handleConfigChange = (key, value) => {
        const newConfig = { ...customConfig, [key]: value };
        setCustomConfig(newConfig);
        PDFCustomizationService.setConfig(newConfig);
    };
    
    const removeLogo = () => {
        const newConfig = { ...customConfig, logo: null };
        setCustomConfig(newConfig);
        PDFCustomizationService.setConfig(newConfig);
        ToastServiceV58.info('Logo supprimé');
    };
    
    if (!isOpen) return null;
    
    return h(Modal, { isOpen: true, onClose, title: '📄 Exporter en PDF', size: 'lg' },
        h('div', null,
            // Onglets Templates / Personnalisation
            h('div', { style: { display: 'flex', gap: 0, marginBottom: 20, borderBottom: '2px solid #E2E8F0' } },
                h('button', {
                    onClick: () => setActiveTab('templates'),
                    style: {
                        padding: '12px 24px',
                        border: 'none',
                        background: 'transparent',
                        fontWeight: activeTab === 'templates' ? 600 : 400,
                        color: activeTab === 'templates' ? '#E11D48' : '#64748B',
                        borderBottom: activeTab === 'templates' ? '2px solid #E11D48' : '2px solid transparent',
                        marginBottom: -2,
                        cursor: 'pointer'
                    }
                }, '📋 Templates'),
                h('button', {
                    onClick: () => setActiveTab('customize'),
                    style: {
                        padding: '12px 24px',
                        border: 'none',
                        background: 'transparent',
                        fontWeight: activeTab === 'customize' ? 600 : 400,
                        color: activeTab === 'customize' ? '#E11D48' : '#64748B',
                        borderBottom: activeTab === 'customize' ? '2px solid #E11D48' : '2px solid transparent',
                        marginBottom: -2,
                        cursor: 'pointer'
                    }
                }, '⚙️ Personnalisation')
            ),
            
            activeTab === 'templates' ? h(Fragment, null,
                // Catégories
                h('div', { style: { display: 'flex', gap: 8, marginBottom: 20 } },
                    categories.map(cat => h('button', {
                        key: cat.id,
                        className: `btn ${activeCategory === cat.id ? 'btn-primary' : 'btn-secondary'}`,
                        onClick: () => { setActiveCategory(cat.id); setSelectedTemplate(null); }
                    }, cat.icon, ' ', cat.name))
                ),
                // Templates
                h('div', { className: 'pdf-template-selector' },
                    templates.map(t => h('div', {
                        key: t.id,
                        className: `pdf-template-card hover-lift ${selectedTemplate === t.id ? 'selected' : ''}`,
                        onClick: () => setSelectedTemplate(t.id)
                    },
                        h('div', { className: 'pdf-template-icon' }, t.icon),
                        h('div', { className: 'pdf-template-name' }, t.name),
                        h('div', { className: 'pdf-template-desc' }, t.description)
                    ))
                ),
                // Boutons
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 12, marginTop: 24 } },
                    h('button', { className: 'btn btn-ghost', onClick: onClose }, 'Annuler'),
                    h('button', { className: 'btn btn-primary', disabled: !selectedTemplate || generating, onClick: handleGenerate },
                        generating ? '⏳ Génération...' : '📥 Télécharger PDF'
                    )
                )
            ) : h('div', null,
                // Section Logo
                h('div', { style: { marginBottom: 24 } },
                    h('label', { style: { display: 'block', fontWeight: 600, marginBottom: 8 } }, '🖼️ Logo entreprise'),
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 16 } },
                        h('div', { 
                            style: { 
                                width: 80, 
                                height: 80, 
                                border: '2px dashed #CBD5E1', 
                                borderRadius: 12, 
                                display: 'flex', 
                                alignItems: 'center', 
                                justifyContent: 'center',
                                overflow: 'hidden',
                                background: '#F8FAFC'
                            } 
                        },
                            customConfig.logo ? 
                                h('img', { src: customConfig.logo, style: { maxWidth: '100%', maxHeight: '100%' } }) :
                                h('span', { style: { color: '#94A3B8', fontSize: 24 } }, '📷')
                        ),
                        h('div', null,
                            h('input', { 
                                ref: logoInputRef, 
                                type: 'file', 
                                accept: 'image/*', 
                                style: { display: 'none' },
                                onChange: handleLogoUpload
                            }),
                            h('button', { 
                                className: 'btn btn-secondary btn-sm', 
                                onClick: () => logoInputRef.current?.click(),
                                style: { marginRight: 8 }
                            }, customConfig.logo ? 'Changer' : 'Ajouter'),
                            customConfig.logo && h('button', { 
                                className: 'btn btn-ghost btn-sm', 
                                onClick: removeLogo,
                                style: { color: '#EF4444' }
                            }, 'Supprimer'),
                            h('div', { style: { fontSize: 11, color: '#94A3B8', marginTop: 4 } }, 'PNG, JPG - Max 500 KB')
                        )
                    )
                ),
                
                // Nom entreprise
                h('div', { style: { marginBottom: 20 } },
                    h('label', { style: { display: 'block', fontWeight: 600, marginBottom: 8 } }, '🏢 Nom de l\'entreprise'),
                    h('input', {
                        type: 'text',
                        value: customConfig.companyName,
                        onChange: (e) => handleConfigChange('companyName', e.target.value),
                        className: 'form-input',
                        placeholder: 'StockApp',
                        style: { width: '100%' }
                    })
                ),
                
                // Couleur principale
                h('div', { style: { marginBottom: 20 } },
                    h('label', { style: { display: 'block', fontWeight: 600, marginBottom: 8 } }, '🎨 Couleur principale'),
                    h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                        colorOptions.map(c => h('div', {
                            key: c.id,
                            onClick: () => handleConfigChange('primaryColor', c.id),
                            style: {
                                width: 40,
                                height: 40,
                                borderRadius: 8,
                                background: c.id,
                                cursor: 'pointer',
                                border: customConfig.primaryColor === c.id ? '3px solid #1E293B' : '3px solid transparent',
                                boxShadow: customConfig.primaryColor === c.id ? '0 0 0 2px white' : 'none',
                                transition: 'all 0.15s'
                            },
                            title: c.name
                        }))
                    )
                ),
                
                // Pied de page
                h('div', { style: { marginBottom: 20 } },
                    h('label', { style: { display: 'block', fontWeight: 600, marginBottom: 8 } }, '📝 Texte pied de page'),
                    h('input', {
                        type: 'text',
                        value: customConfig.footerText,
                        onChange: (e) => handleConfigChange('footerText', e.target.value),
                        className: 'form-input',
                        placeholder: 'StockApp v5.8 - Gestion de stock',
                        style: { width: '100%' }
                    })
                ),
                
                // Options
                h('div', { style: { display: 'flex', gap: 24 } },
                    h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                        h('input', {
                            type: 'checkbox',
                            checked: customConfig.showDate,
                            onChange: (e) => handleConfigChange('showDate', e.target.checked),
                            style: { width: 18, height: 18 }
                        }),
                        'Afficher la date'
                    ),
                    h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                        h('input', {
                            type: 'checkbox',
                            checked: customConfig.showPageNumbers,
                            onChange: (e) => handleConfigChange('showPageNumbers', e.target.checked),
                            style: { width: 18, height: 18 }
                        }),
                        'Numéros de page'
                    )
                ),
                
                // Aperçu
                h('div', { style: { marginTop: 24, padding: 16, background: '#F8FAFC', borderRadius: 12, border: '1px solid #E2E8F0' } },
                    h('div', { style: { fontSize: 11, color: '#94A3B8', marginBottom: 8, fontWeight: 600 } }, 'APERÇU EN-TÊTE'),
                    h('div', { style: { background: customConfig.primaryColor, padding: '12px 16px', borderRadius: 8, color: 'white', display: 'flex', alignItems: 'center', gap: 12 } },
                        customConfig.logo && h('img', { src: customConfig.logo, style: { width: 30, height: 30, borderRadius: 4, background: 'white' } }),
                        h('div', null,
                            h('div', { style: { fontSize: 11 } }, customConfig.companyName),
                            h('div', { style: { fontSize: 14, fontWeight: 700 } }, 'TITRE DU DOCUMENT')
                        )
                    )
                ),
                
                // Bouton sauvegarder
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', marginTop: 24 } },
                    h('button', { 
                        className: 'btn btn-primary', 
                        onClick: () => { ToastServiceV58.success('Personnalisation sauvegardée'); setActiveTab('templates'); }
                    }, '✓ Appliquer')
                )
            )
        )
    );
};

// Sélecteur de thème
const ThemeSelectorV58 = ({ isOpen, onClose }) => {
    const [config, setConfig] = useState(ThemeServiceV58.getConfig());
    
    useEffect(() => {
        setConfig(ThemeServiceV58.getConfig());
    }, [isOpen]);
    
    const handleThemeChange = (id) => {
        ThemeServiceV58.setTheme(id);
        setConfig(ThemeServiceV58.getConfig());
        ToastServiceV58.success(`Thème ${ThemeServiceV58.themes[id].name} appliqué`);
    };
    
    const handleDarkModeToggle = () => {
        ThemeServiceV58.toggleDarkMode();
        setConfig(ThemeServiceV58.getConfig());
        ToastServiceV58.info(ThemeServiceV58.darkMode ? 'Mode sombre activé' : 'Mode clair activé');
    };
    
    if (!isOpen) return null;
    
    return h(Modal, { isOpen: true, onClose, title: '🎨 Personnalisation', size: 'md' },
        h('div', null,
            h('h4', { style: { marginBottom: 12 } }, 'Couleur principale'),
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12, marginBottom: 24 } },
                Object.entries(config.themes).map(([id, theme]) => h('div', {
                    key: id,
                    onClick: () => handleThemeChange(id),
                    style: { 
                        padding: 16, 
                        borderRadius: 12, 
                        border: `3px solid ${config.theme === id ? theme.color : '#e2e8f0'}`, 
                        cursor: 'pointer', 
                        textAlign: 'center',
                        background: config.theme === id ? `${theme.color}10` : 'white',
                        transition: 'all 0.2s'
                    }
                },
                    h('div', { style: { width: 48, height: 48, borderRadius: '50%', background: theme.color, margin: '0 auto 8px', boxShadow: '0 4px 12px rgba(0,0,0,0.15)' } }),
                    h('div', { style: { fontWeight: 600, color: config.theme === id ? theme.color : '#334155' } }, theme.name),
                    config.theme === id && h('div', { style: { color: theme.color, fontSize: 12, marginTop: 4, fontWeight: 700 } }, '✓ Actif')
                ))
            ),
            h('h4', { style: { marginBottom: 12 } }, 'Mode sombre'),
            h('label', { style: { display: 'flex', alignItems: 'center', gap: 12, cursor: 'pointer', marginBottom: 12, padding: 12, background: '#f8fafc', borderRadius: 8 } },
                h('input', { type: 'checkbox', checked: config.darkMode, onChange: handleDarkModeToggle, style: { width: 20, height: 20 } }),
                h('span', { style: { fontWeight: 500 } }, '🌙 Activer le mode sombre')
            ),
            h('label', { style: { display: 'flex', alignItems: 'center', gap: 12, cursor: 'pointer', padding: 12, background: '#f8fafc', borderRadius: 8 } },
                h('input', { type: 'checkbox', checked: config.autoDarkMode, onChange: (e) => { 
                    ThemeServiceV58.autoDarkMode = e.target.checked; 
                    ThemeServiceV58.save(); 
                    if (e.target.checked) ThemeServiceV58.checkAutoDarkMode(); 
                    setConfig(ThemeServiceV58.getConfig()); 
                    ToastServiceV58.info(e.target.checked ? 'Mode automatique activé' : 'Mode automatique désactivé');
                }, style: { width: 20, height: 20 } }),
                h('span', { style: { fontWeight: 500 } }, '⏰ Mode sombre automatique (19h-7h)')
            )
        )
    );
};

// Bottom Navigation Mobile
const BottomNavigation = ({ currentPage, onNavigate }) => {
    const items = [
        { id: 'dashboard', icon: '🏠', label: 'Accueil' },
        { id: 'tasks', icon: '📋', label: 'Tâches' },
        { id: 'stock', icon: '📦', label: 'Stock' },
        { id: 'planning', icon: '📅', label: 'Planning' }
    ];
    
    return h('nav', { className: 'bottom-nav' },
        items.map(item => h('button', {
            key: item.id,
            className: `bottom-nav-item ${currentPage === item.id ? 'active' : ''}`,
            onClick: () => onNavigate(item.id)
        },
            h('span', { className: 'bottom-nav-icon' }, item.icon),
            h('span', null, item.label)
        ))
    );
};

// FAB (Floating Action Button)
const FloatingActionButton = ({ icon, onClick, actions }) => {
    const [expanded, setExpanded] = useState(false);
    
    if (actions && actions.length > 0) {
        return h('div', { style: { position: 'fixed', bottom: 80, right: 20, zIndex: 99 } },
            expanded && h('div', { className: 'animate-fade-in-up', style: { position: 'absolute', bottom: 70, right: 0, display: 'flex', flexDirection: 'column', gap: 12, alignItems: 'flex-end' } },
                actions.map((a, i) => h('button', { key: i, className: 'btn btn-secondary hover-lift', style: { padding: '10px 16px', borderRadius: 24 }, onClick: () => { a.onClick(); setExpanded(false); } }, a.icon, ' ', a.label))
            ),
            h('button', { className: 'fab', onClick: () => setExpanded(!expanded), style: { transform: expanded ? 'rotate(45deg)' : 'none' } }, expanded ? '✕' : (icon || '+'))
        );
    }
    return h('button', { className: 'fab', onClick }, icon || '+');
};

// ==========================================
// SYSTÈME SPLIT VIEW / VUES MULTIPLES v5.8
// ==========================================

const SplitViewService = {
    STORAGE_KEY: 'stockapp-splitview',
    layouts: {
        single: { panels: 1, sizes: ['100%'] },
        vertical2: { panels: 2, sizes: ['50%', '50%'], direction: 'row' },
        horizontal2: { panels: 2, sizes: ['50%', '50%'], direction: 'column' },
        vertical3: { panels: 3, sizes: ['33.33%', '33.33%', '33.33%'], direction: 'row' },
        grid4: { panels: 4, sizes: ['50%', '50%', '50%', '50%'], direction: 'grid' }
    },
    
    currentLayout: 'single',
    panelPages: ['dashboard'],
    panelSizes: ['100%'],
    
    init() {
        try {
            const saved = localStorage.getItem(this.STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                this.currentLayout = data.layout || 'single';
                this.panelPages = data.pages || ['dashboard'];
                this.panelSizes = data.sizes || ['100%'];
            }
        } catch (e) {}
    },
    
    setLayout(layoutId) {
        const layout = this.layouts[layoutId];
        if (!layout) return;
        this.currentLayout = layoutId;
        // Ajuster le nombre de pages
        while (this.panelPages.length < layout.panels) {
            this.panelPages.push('dashboard');
        }
        this.panelPages = this.panelPages.slice(0, layout.panels);
        this.panelSizes = [...layout.sizes];
        this.save();
    },
    
    setPanelPage(panelIndex, pageId) {
        if (panelIndex < this.panelPages.length) {
            this.panelPages[panelIndex] = pageId;
            this.save();
        }
    },
    
    resizePanel(panelIndex, newSize) {
        if (panelIndex < this.panelSizes.length) {
            this.panelSizes[panelIndex] = newSize;
            this.save();
        }
    },
    
    save() {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify({
            layout: this.currentLayout,
            pages: this.panelPages,
            sizes: this.panelSizes
        }));
    },
    
    getConfig() {
        return {
            layout: this.currentLayout,
            layoutConfig: this.layouts[this.currentLayout],
            pages: [...this.panelPages],
            sizes: [...this.panelSizes]
        };
    }
};

// Initialiser le service
SplitViewService.init();

// Composant SplitView
const SplitView = ({ renderPage, navItems, currentPages, onPageChange }) => {
    const [config, setConfig] = useState(SplitViewService.getConfig());
    const [resizing, setResizing] = useState(null);
    const [showLayoutPicker, setShowLayoutPicker] = useState(false);
    const containerRef = useRef(null);
    
    const updateConfig = () => setConfig(SplitViewService.getConfig());
    
    const handleLayoutChange = (layoutId) => {
        SplitViewService.setLayout(layoutId);
        updateConfig();
        setShowLayoutPicker(false);
    };
    
    const handlePanelPageChange = (panelIndex, pageId) => {
        SplitViewService.setPanelPage(panelIndex, pageId);
        updateConfig();
        onPageChange?.(panelIndex, pageId);
    };
    
    const handleResizeStart = (e, panelIndex) => {
        e.preventDefault();
        setResizing({ index: panelIndex, startX: e.clientX, startY: e.clientY });
    };
    
    const handleResizeMove = useCallback((e) => {
        if (!resizing || !containerRef.current) return;
        const container = containerRef.current;
        const rect = container.getBoundingClientRect();
        const layout = config.layoutConfig;
        
        if (layout.direction === 'row') {
            const percent = ((e.clientX - rect.left) / rect.width) * 100;
            const newSizes = [...config.sizes];
            newSizes[resizing.index] = Math.max(20, Math.min(80, percent)) + '%';
            newSizes[resizing.index + 1] = (100 - parseFloat(newSizes[resizing.index])) + '%';
            SplitViewService.panelSizes = newSizes;
            updateConfig();
        } else if (layout.direction === 'column') {
            const percent = ((e.clientY - rect.top) / rect.height) * 100;
            const newSizes = [...config.sizes];
            newSizes[resizing.index] = Math.max(20, Math.min(80, percent)) + '%';
            newSizes[resizing.index + 1] = (100 - parseFloat(newSizes[resizing.index])) + '%';
            SplitViewService.panelSizes = newSizes;
            updateConfig();
        }
    }, [resizing, config]);
    
    const handleResizeEnd = () => {
        if (resizing) {
            SplitViewService.save();
            setResizing(null);
        }
    };
    
    useEffect(() => {
        if (resizing) {
            window.addEventListener('mousemove', handleResizeMove);
            window.addEventListener('mouseup', handleResizeEnd);
            return () => {
                window.removeEventListener('mousemove', handleResizeMove);
                window.removeEventListener('mouseup', handleResizeEnd);
            };
        }
    }, [resizing, handleResizeMove]);
    
    const layoutOptions = [
        { id: 'single', icon: '◻️', label: 'Simple' },
        { id: 'vertical2', icon: '▯▯', label: '2 colonnes' },
        { id: 'horizontal2', icon: '▭▭', label: '2 lignes' },
        { id: 'grid4', icon: '▦', label: '4 panneaux' }
    ];
    
    if (config.layout === 'single') {
        return renderPage(config.pages[0], 0);
    }
    
    const getFlexDirection = () => {
        if (config.layoutConfig.direction === 'row') return 'row';
        if (config.layoutConfig.direction === 'column') return 'column';
        return 'row';
    };
    
    const renderPanel = (pageId, index) => {
        return h('div', { 
            key: index,
            style: { 
                flex: config.layoutConfig.direction === 'grid' ? '0 0 50%' : `0 0 ${config.sizes[index]}`,
                overflow: 'auto',
                position: 'relative',
                borderRight: config.layoutConfig.direction === 'row' && index < config.pages.length - 1 ? '1px solid var(--border)' : 'none',
                borderBottom: config.layoutConfig.direction === 'column' && index < config.pages.length - 1 ? '1px solid var(--border)' : 'none'
            }
        },
            // Panel header avec sélecteur de page
            h('div', { 
                style: { 
                    position: 'sticky', 
                    top: 0, 
                    zIndex: 10, 
                    background: 'var(--card)', 
                    borderBottom: '1px solid var(--border)',
                    padding: '8px 12px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: 8
                }
            },
                h('select', {
                    value: pageId,
                    onChange: (e) => handlePanelPageChange(index, e.target.value),
                    style: { 
                        flex: 1,
                        padding: '6px 10px', 
                        border: '1px solid var(--border)', 
                        borderRadius: 8, 
                        background: 'var(--background)',
                        fontSize: 13,
                        fontWeight: 500
                    }
                },
                    navItems.map(item => h('option', { key: item.id, value: item.id }, item.icon || '', ' ', item.label))
                ),
                h('span', { style: { fontSize: 11, color: 'var(--muted)', padding: '2px 8px', background: 'var(--background)', borderRadius: 4 } }, `#${index + 1}`)
            ),
            // Contenu de la page
            h('div', { style: { padding: 0 } }, renderPage(pageId, index)),
            // Resize handle
            (config.layoutConfig.direction === 'row' && index < config.pages.length - 1) && h('div', {
                onMouseDown: (e) => handleResizeStart(e, index),
                style: {
                    position: 'absolute',
                    right: -3,
                    top: 0,
                    bottom: 0,
                    width: 6,
                    cursor: 'col-resize',
                    background: resizing?.index === index ? 'var(--primary)' : 'transparent',
                    zIndex: 20
                }
            }),
            (config.layoutConfig.direction === 'column' && index < config.pages.length - 1) && h('div', {
                onMouseDown: (e) => handleResizeStart(e, index),
                style: {
                    position: 'absolute',
                    bottom: -3,
                    left: 0,
                    right: 0,
                    height: 6,
                    cursor: 'row-resize',
                    background: resizing?.index === index ? 'var(--primary)' : 'transparent',
                    zIndex: 20
                }
            })
        );
    };
    
    return h('div', { 
        ref: containerRef,
        style: { 
            display: 'flex', 
            flexDirection: getFlexDirection(),
            flexWrap: config.layoutConfig.direction === 'grid' ? 'wrap' : 'nowrap',
            height: '100%',
            width: '100%'
        }
    },
        config.pages.map((pageId, index) => renderPanel(pageId, index))
    );
};

// Bouton de contrôle SplitView
const SplitViewControl = ({ onLayoutChange }) => {
    const [showMenu, setShowMenu] = useState(false);
    const [config, setConfig] = useState(SplitViewService.getConfig());
    
    const layoutOptions = [
        { id: 'single', icon: '◻️', label: 'Vue simple' },
        { id: 'vertical2', icon: '▯▯', label: '2 colonnes' },
        { id: 'horizontal2', icon: '▭', label: '2 lignes' },
        { id: 'grid4', icon: '▦', label: '4 panneaux' }
    ];
    
    // Fermer le menu quand on clique ailleurs
    useEffect(() => {
        if (showMenu) {
            const handleClickOutside = (e) => {
                if (!e.target.closest('.split-view-control')) {
                    setShowMenu(false);
                }
            };
            setTimeout(() => document.addEventListener('click', handleClickOutside), 10);
            return () => document.removeEventListener('click', handleClickOutside);
        }
    }, [showMenu]);
    
    const handleSelect = (layoutId) => {
        SplitViewService.setLayout(layoutId);
        setConfig(SplitViewService.getConfig());
        setShowMenu(false);
        onLayoutChange?.(layoutId);
        ToastServiceV58.success(`Disposition "${layoutOptions.find(o => o.id === layoutId)?.label}" appliquée`);
    };
    
    return h('div', { className: 'split-view-control', style: { position: 'relative' } },
        h('button', { 
            className: 'header-btn',
            onClick: (e) => { e.stopPropagation(); setShowMenu(!showMenu); },
            title: 'Changer la disposition',
            style: { background: showMenu ? 'var(--primary-pastel)' : undefined }
        }, '⊞'),
        showMenu && h('div', {
            className: 'animate-scale-in',
            onClick: (e) => e.stopPropagation(),
            style: {
                position: 'absolute',
                top: '100%',
                right: 0,
                marginTop: 8,
                background: 'white',
                borderRadius: 12,
                boxShadow: '0 10px 40px rgba(0,0,0,0.25)',
                padding: 8,
                zIndex: 10000,
                minWidth: 200
            }
        },
            h('div', { style: { padding: '8px 12px', fontSize: 11, fontWeight: 700, color: '#64748B', borderBottom: '1px solid #E2E8F0', marginBottom: 8, letterSpacing: '0.5px' } }, 'DISPOSITION'),
            layoutOptions.map(opt => h('button', {
                key: opt.id,
                onClick: () => handleSelect(opt.id),
                style: {
                    display: 'flex',
                    alignItems: 'center',
                    gap: 12,
                    width: '100%',
                    padding: '12px 14px',
                    border: 'none',
                    background: config.layout === opt.id ? '#FFF1F2' : 'transparent',
                    borderRadius: 8,
                    cursor: 'pointer',
                    textAlign: 'left',
                    fontSize: 14,
                    fontWeight: config.layout === opt.id ? 600 : 400,
                    color: config.layout === opt.id ? '#E11D48' : '#334155',
                    transition: 'all 0.15s'
                },
                onMouseOver: (e) => { if (config.layout !== opt.id) e.target.style.background = '#F8FAFC'; },
                onMouseOut: (e) => { if (config.layout !== opt.id) e.target.style.background = 'transparent'; }
            },
                h('span', { style: { fontSize: 20, width: 28 } }, opt.icon),
                h('span', { style: { flex: 1 } }, opt.label),
                config.layout === opt.id && h('span', { style: { color: '#E11D48', fontWeight: 700 } }, '✓')
            ))
        )
    );
};

// Filterable Table Header Component
/**
 * En-tête de colonne filtrable, redimensionnable et déplaçable
 */
const FilterableTh = ({ 
    label, 
    filterKey, 
    filters, 
    setFilters, 
    type = 'text', 
    options = [], 
    style = {},
    // Props pour redimensionnement/déplacement
    colConfig,
    onResize,
    onDragStart,
    onDragOver,
    onDrop,
    onDragEnd,
    isDragOver,
    isResizing
}) => {
    const [showFilter, setShowFilter] = useState(false);
    const filterValue = filters?.[filterKey] || '';
    const hasFilter = filterValue !== '';
    
    // Utiliser colConfig.key pour le drag & drop
    const colKey = colConfig?.key || filterKey;
    
    const thStyle = {
        ...style,
        position: 'relative',
        width: colConfig?.width,
        minWidth: 60,
        cursor: onDragStart ? 'grab' : 'default',
        background: isDragOver ? 'var(--primary-pastel)' : undefined,
        userSelect: 'none',
        transition: 'background 0.15s'
    };
    
    const handleResizeStart = (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (onResize && colKey) onResize(colKey, e.clientX);
    };
    
    return h('th', { 
        style: thStyle,
        draggable: !!onDragStart && !!colKey,
        onDragStart: onDragStart && colKey ? (e) => onDragStart(e, colKey) : undefined,
        onDragOver: onDragOver && colKey ? (e) => { e.preventDefault(); onDragOver(colKey); } : undefined,
        onDragLeave: onDragOver ? () => onDragOver(null) : undefined,
        onDrop: onDrop && colKey ? (e) => { e.preventDefault(); onDrop(colKey); } : undefined,
        onDragEnd: onDragEnd
    },
        h('div', { style: { display: 'flex', alignItems: 'center', gap: 6 } },
            h('span', { style: { flex: 1 } }, label),
            setFilters && h('button', {
                onClick: (e) => { e.stopPropagation(); setShowFilter(!showFilter); },
                style: { 
                    background: hasFilter ? COLORS.primary : 'transparent', 
                    border: 'none', 
                    cursor: 'pointer', 
                    padding: 4, 
                    borderRadius: 4,
                    display: 'flex',
                    alignItems: 'center'
                },
                title: 'Filtrer'
            }, h(Icon, { name: 'filter', size: 12, color: hasFilter ? 'white' : COLORS.muted }))
        ),
        // Handle de redimensionnement
        onResize && h('div', {
            style: {
                position: 'absolute',
                right: 0,
                top: 0,
                width: 8,
                height: '100%',
                cursor: 'col-resize',
                background: isResizing ? 'var(--primary)' : 'transparent',
                zIndex: 2
            },
            onMouseDown: handleResizeStart,
            onClick: (e) => e.stopPropagation(),
            onMouseEnter: (e) => { if (!isResizing) e.target.style.background = 'var(--border)'; },
            onMouseLeave: (e) => { if (!isResizing) e.target.style.background = 'transparent'; }
        }),
        showFilter && h('div', { 
            style: { 
                position: 'absolute', 
                top: '100%', 
                left: 0, 
                zIndex: 100, 
                background: 'var(--card)', 
                border: '1px solid var(--border)', 
                borderRadius: 8, 
                padding: 8, 
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
                minWidth: 180
            },
            onClick: e => e.stopPropagation()
        },
            type === 'select' ? 
                h('select', { 
                    value: filterValue, 
                    onChange: e => { setFilters({ ...filters, [filterKey]: e.target.value }); setShowFilter(false); },
                    style: { width: '100%', padding: '6px 8px', borderRadius: 6, border: '1px solid var(--border)', fontSize: 12 },
                    autoFocus: true
                },
                    h('option', { value: '' }, '-- Tous --'),
                    options.map(opt => h('option', { key: opt.value, value: opt.value }, opt.label))
                ) :
                h('input', { 
                    type: 'text', 
                    placeholder: `Filtrer ${label.toLowerCase()}...`,
                    value: filterValue,
                    onChange: e => setFilters({ ...filters, [filterKey]: e.target.value }),
                    onKeyDown: e => { if (e.key === 'Enter' || e.key === 'Escape') setShowFilter(false); },
                    style: { width: '100%', padding: '6px 8px', borderRadius: 6, border: '1px solid var(--border)', fontSize: 12 },
                    autoFocus: true
                }),
            hasFilter && h('button', {
                onClick: () => { setFilters({ ...filters, [filterKey]: '' }); setShowFilter(false); },
                style: { marginTop: 6, width: '100%', padding: '4px 8px', fontSize: 11, background: COLORS.dangerPastel, color: COLORS.danger, border: 'none', borderRadius: 4, cursor: 'pointer' }
            }, 'Effacer le filtre')
        )
    );
};

// Page Header Component with gradient
const PageHeader = ({ title, subtitle, color, searchValue, onSearchChange, actions }) => h('div', { 
    className: 'page-header', 
    style: { background: `linear-gradient(135deg, ${color} 0%, ${color}CC 100%)` } 
}, h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', flexWrap: 'wrap', gap: 16 } }, 
    h('div', null, h('h1', null, title), subtitle && h('p', null, subtitle)), 
    actions && h('div', { className: 'header-actions' }, 
        onSearchChange && h('div', { className: 'search-box' }, 
            h(Icon, { name: 'search', size: 18 }), 
            h('input', { type: 'text', placeholder: 'Rechercher...', value: searchValue || '', onChange: e => onSearchChange(e.target.value) })
        ), 
        actions
    )
));

// Barcode Display
const BarcodeDisplay = ({ value, size = 200 }) => {
    const svgRef = useRef(null);
    useEffect(() => {
        if (svgRef.current && value) {
            try { JsBarcode(svgRef.current, value, { format: "CODE128", width: 2, height: 80, displayValue: true, fontSize: 14, margin: 10, background: "#FFFFFF", lineColor: "#1E293B" }); } catch (e) {}
        }
    }, [value, size]);
    return h('div', { className: 'barcode-container' }, h('svg', { ref: svgRef }));
};

// Donut Chart
const DonutChart = ({ data, size = 160, strokeWidth = 24 }) => {
    const radius = (size - strokeWidth) / 2;
    const circumference = 2 * Math.PI * radius;
    const total = data.reduce((sum, item) => sum + item.value, 0);
    let offset = 0;
    const segments = data.map((item, i) => {
        const percentage = total > 0 ? item.value / total : 0;
        const strokeDasharray = `${circumference * percentage} ${circumference * (1 - percentage)}`;
        const strokeDashoffset = -offset;
        offset += circumference * percentage;
        return h('circle', { key: i, cx: size / 2, cy: size / 2, r: radius, stroke: item.color, strokeDasharray, strokeDashoffset, style: { transition: 'stroke-dasharray 0.5s ease' } });
    });
    return h('div', { className: 'donut-chart', style: { width: size, height: size } },
        h('svg', { width: size, height: size }, segments),
        h('div', { className: 'donut-center' },
            h('div', { className: 'donut-value' }, total),
            h('div', { className: 'donut-label' }, 'Total')
        )
    );
};

// Bar Chart
const BarChart = ({ data }) => {
    const maxValue = Math.max(...data.flatMap(d => [d.entries || 0, d.exits || 0]), 1);
    return h('div', null,
        h('div', { className: 'bar-chart' },
            data.map((item, i) => h('div', { key: i, className: 'bar-item' },
                h('div', { className: 'bar-wrapper' },
                    h('div', { className: 'bar entries', style: { height: `${(item.entries / maxValue) * 100}%` }, title: `Entrées: ${item.entries}` }),
                    h('div', { className: 'bar exits', style: { height: `${(item.exits / maxValue) * 100}%` }, title: `Sorties: ${item.exits}` })
                ),
                h('span', { className: 'bar-label' }, item.label)
            ))
        ),
        h('div', { className: 'chart-legend' },
            h('div', { className: 'legend-item' }, h('span', { className: 'legend-dot entries' }), h('span', null, 'Entrées')),
            h('div', { className: 'legend-item' }, h('span', { className: 'legend-dot exits' }), h('span', null, 'Sorties'))
        )
    );
};

// Progress Bar
const ProgressBar = ({ value, max = 100 }) => {
    const percentage = Math.min(100, (value / max) * 100);
    const colorClass = percentage >= 75 ? 'high' : percentage >= 40 ? 'medium' : 'low';
    return h('div', null,
        h('div', { className: 'progress-bar' }, h('div', { className: `progress-fill ${colorClass}`, style: { width: `${percentage}%` } })),
        h('div', { className: 'progress-text' }, `${Math.round(percentage)}%`)
    );
};

// PhotoManager Component pour la gestion des photos
const PhotoManager = ({ photos, onAdd, onDelete, onUpdateCaption }) => {
    const fileRef = useRef();
    const [editingCaption, setEditingCaption] = useState(null);
    const [captionText, setCaptionText] = useState('');
    
    const handleCaptionEdit = (photo) => {
        setEditingCaption(photo.id);
        setCaptionText(photo.caption || '');
    };
    
    const saveCaption = async (photoId) => {
        if (onUpdateCaption) {
            await onUpdateCaption(photoId, captionText);
        }
        setEditingCaption(null);
        setCaptionText('');
    };
    
    return h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: 16 } },
        photos.map(p => h('div', { key: p.id, style: { position: 'relative', background: COLORS.background, borderRadius: 12, overflow: 'hidden' } },
            h('div', { style: { position: 'relative', paddingTop: '100%' } },
                h('img', { 
                    src: p.photo_url || '/placeholder.jpg', 
                    alt: p.caption || 'Photo',
                    style: { position: 'absolute', top: 0, left: 0, width: '100%', height: '100%', objectFit: 'cover', cursor: 'pointer' },
                    onClick: () => window.open(p.photo_url, '_blank')
                }),
                onDelete && h('button', { 
                    style: { position: 'absolute', top: 8, right: 8, width: 28, height: 28, borderRadius: '50%', background: 'rgba(239,68,68,0.9)', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' },
                    onClick: () => onDelete(p.id) 
                }, h(Icon, { name: 'x', size: 14, color: 'white' }))
            ),
            h('div', { style: { padding: 8 } },
                editingCaption === p.id ? 
                    h('div', { style: { display: 'flex', gap: 4 } },
                        h('input', { 
                            type: 'text',
                            value: captionText,
                            onChange: (e) => setCaptionText(e.target.value),
                            placeholder: 'Légende...',
                            style: { flex: 1, padding: '4px 8px', fontSize: 12, border: `1px solid ${COLORS.border}`, borderRadius: 4 },
                            autoFocus: true,
                            onKeyPress: (e) => e.key === 'Enter' && saveCaption(p.id)
                        }),
                        h('button', { className: 'btn btn-primary', style: { padding: '4px 8px', fontSize: 10 }, onClick: () => saveCaption(p.id) }, '✓'),
                        h('button', { className: 'btn btn-ghost', style: { padding: '4px 8px', fontSize: 10 }, onClick: () => setEditingCaption(null) }, '✗')
                    ) :
                    h('div', { 
                        style: { fontSize: 12, color: p.caption ? COLORS.text : COLORS.muted, cursor: onUpdateCaption ? 'pointer' : 'default', minHeight: 20 },
                        onClick: () => onUpdateCaption && handleCaptionEdit(p)
                    }, p.caption || (onUpdateCaption ? '+ Ajouter légende' : ''))
            )
        )),
        onAdd && h('div', { 
            style: { 
                display: 'flex', 
                flexDirection: 'column', 
                alignItems: 'center', 
                justifyContent: 'center', 
                minHeight: 150, 
                background: COLORS.background, 
                borderRadius: 12, 
                border: `2px dashed ${COLORS.border}`, 
                cursor: 'pointer'
            }, 
            onClick: () => fileRef.current?.click()
        },
            h(Icon, { name: 'camera', size: 32, color: COLORS.muted }),
            h('span', { style: { marginTop: 8, fontSize: 13, color: COLORS.muted } }, 'Ajouter une photo'),
            h('input', { ref: fileRef, type: 'file', accept: 'image/*', style: { display: 'none' }, onChange: (e) => e.target.files?.[0] && onAdd(e.target.files[0]) })
        )
    );
};

// Permissions par défaut selon le rôle (global)
const DEFAULT_PERMISSIONS = {
    admin: { stock_read: true, stock_write: true, tasks_read: true, tasks_write: true, orders_read: true, orders_write: true, planning_read: true, planning_write: true, users_manage: true, settings_manage: true, timesheets_view_all: true },
    technicien: { stock_read: true, stock_write: false, tasks_read: true, tasks_write: true, orders_read: true, orders_write: false, planning_read: true, planning_write: true, users_manage: false, settings_manage: false, timesheets_view_all: false },
    lecteur: { stock_read: true, stock_write: false, tasks_read: true, tasks_write: false, orders_read: true, orders_write: false, planning_read: true, planning_write: false, users_manage: false, settings_manage: false, timesheets_view_all: false }
};

// Fonction pour parser les permissions (peut être string JSON ou objet)
const parsePermissions = (perms) => {
    if (!perms) return null;
    if (typeof perms === 'string') {
        try {
            return JSON.parse(perms);
        } catch (e) {
            return null;
        }
    }
    return perms;
};

// Fonction pour obtenir les permissions d'un utilisateur
const getUserPermissions = (user) => {
    if (user.role === 'admin') return DEFAULT_PERMISSIONS.admin;
    const parsed = parsePermissions(user.permissions);
    if (parsed && Object.keys(parsed).length > 0) return parsed;
    return DEFAULT_PERMISSIONS[user.role] || DEFAULT_PERMISSIONS.lecteur;
};


// ==========================================
// LOGIN PAGE
// ==========================================
const LoginPage = ({ onLogin, showToast }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        try {
            const { data, error } = await db.auth.signInWithPassword({ email, password });
            if (error) throw error;
            
            // Essayer de récupérer le profil
            let profile = null;
            try {
                const { data: profileData } = await db.from('profiles').select('*').eq('id', data.user.id).single();
                if (profileData) profile = profileData;
            } catch (e) {
                console.log('No profiles table or no profile found');
            }
            
            // Si pas de profil, utiliser les métadonnées
            if (!profile) {
                const metadata = data.user.user_metadata || {};
                profile = {
                    id: data.user.id,
                    email: data.user.email,
                    first_name: metadata.first_name || metadata.name || email.split('@')[0],
                    last_name: metadata.last_name || '',
                    role: metadata.role || 'admin'
                };
            }
            
            console.log('Logged in user profile:', profile);
            onLogin(profile);
        } catch (err) {
            showToast(err.message, 'error');
        }
        setLoading(false);
    };
    
    return h('div', { className: 'login-container' },
        h('div', { className: 'login-card' },
            h('div', { className: 'login-logo-container' },
                h('img', { src: COMPANY_LOGO, alt: 'Auvergne Ascenseurs', className: 'login-logo-img' })
            ),
            h('h1', { className: 'login-title' }, 'Bienvenue'),
            h('p', { className: 'login-subtitle' }, 'Connectez-vous à votre espace'),
            h('form', { className: 'login-form', onSubmit: handleSubmit },
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Adresse email'),
                    h('input', { type: 'email', className: 'form-input', value: email, onChange: e => setEmail(e.target.value), placeholder: 'votre@email.com', required: true })
                ),
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Mot de passe'),
                    h('input', { type: 'password', className: 'form-input', value: password, onChange: e => setPassword(e.target.value), placeholder: '••••••••', required: true })
                ),
                h('button', { type: 'submit', className: 'btn btn-primary', disabled: loading }, loading ? 'Connexion...' : 'Se connecter')
            ),
            h('p', { className: 'login-footer' }, 'Gestion des interventions et du stock')
        )
    );
};

// ==========================================
// DASHBOARD PAGE
// ==========================================
const DashboardPage = ({ data, user, showToast }) => {
    const [timesheetData, setTimesheetData] = useState(null);
    const [leaveBalances, setLeaveBalances] = useState(null);
    const [loading, setLoading] = useState(true);
    const [activeTab, setActiveTab] = useState('overview'); // 'overview', 'statistics', 'kpis'
    const [widgetLayout, setWidgetLayout] = useState(() => WidgetSystem.getLayout());
    const [refreshKey, setRefreshKey] = useState(0);
    
    // Nouveaux états v5.6
    const [comparisonPeriod, setComparisonPeriod] = useState('month'); // 'week', 'month', 'quarter'
    const [showDigestModal, setShowDigestModal] = useState(false);
    const [digestPrefs, setDigestPrefs] = useState({ daily_digest: false, weekly_digest: true, weekly_digest_day: 1, include_tasks: true, include_stock: true, include_stats: true });
    const [notificationRules, setNotificationRules] = useState([]);
    const [showRulesModal, setShowRulesModal] = useState(false);
    
    // Charger préférences notifications
    useEffect(() => {
        const loadNotificationSettings = async () => {
            try {
                const [digestRes, rulesRes] = await Promise.all([
                    db.from('digest_preferences').select('*').eq('user_id', user.id).maybeSingle(),
                    db.from('notification_rules').select('*').eq('is_active', true)
                ]);
                if (digestRes.data) setDigestPrefs(digestRes.data);
                if (rulesRes.data) setNotificationRules(rulesRes.data);
            } catch (err) { console.log('Tables notifications non disponibles'); }
        };
        loadNotificationSettings();
    }, [user.id]);
    
    // Sauvegarder préférences digest
    const saveDigestPrefs = async () => {
        try {
            const prefs = { ...digestPrefs, user_id: user.id };
            const { data: existing } = await db.from('digest_preferences').select('id').eq('user_id', user.id).maybeSingle();
            if (existing) {
                await db.from('digest_preferences').update(prefs).eq('user_id', user.id);
            } else {
                await db.from('digest_preferences').insert(prefs);
            }
            showToast('Préférences sauvegardées', 'success');
            setShowDigestModal(false);
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    // Calculs des KPIs avancés v5.6
    const advancedKPIs = useMemo(() => {
        const now = new Date();
        const periods = {
            week: { start: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000), prevStart: new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000), prevEnd: new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000) },
            month: { start: new Date(now.getFullYear(), now.getMonth(), 1), prevStart: new Date(now.getFullYear(), now.getMonth() - 1, 1), prevEnd: new Date(now.getFullYear(), now.getMonth(), 0) },
            quarter: { start: new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1), prevStart: new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3 - 3, 1), prevEnd: new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 0) }
        };
        const period = periods[comparisonPeriod];
        
        const filterByDate = (items, start, end, dateField = 'created_at') => 
            items.filter(item => {
                const d = new Date(item[dateField] || item.scheduled_date);
                return d >= start && d <= (end || now);
            });
        
        // Tâches période actuelle vs précédente
        const currentTasks = filterByDate(data.tasks, period.start, now);
        const prevTasks = filterByDate(data.tasks, period.prevStart, period.prevEnd);
        const completedCurrent = currentTasks.filter(t => t.status === 'termine').length;
        const completedPrev = prevTasks.filter(t => t.status === 'termine').length;
        
        // Taux de résolution
        const resolutionRate = currentTasks.length > 0 ? Math.round((completedCurrent / currentTasks.length) * 100) : 0;
        const prevResolutionRate = prevTasks.length > 0 ? Math.round((completedPrev / prevTasks.length) * 100) : 0;
        
        // Temps moyen de traitement (simulé)
        const avgTime = currentTasks.length > 0 ? Math.round(currentTasks.reduce((sum, t) => sum + (t.estimated_duration || 60), 0) / currentTasks.length) : 0;
        
        // Performance par technicien
        const techPerformance = {};
        data.tasks.filter(t => t.assigned_to && t.status === 'termine').forEach(t => {
            if (!techPerformance[t.assigned_to]) techPerformance[t.assigned_to] = { completed: 0, total: 0 };
            techPerformance[t.assigned_to].completed++;
        });
        data.tasks.filter(t => t.assigned_to).forEach(t => {
            if (!techPerformance[t.assigned_to]) techPerformance[t.assigned_to] = { completed: 0, total: 0 };
            techPerformance[t.assigned_to].total++;
        });
        
        // Top performer
        const performers = Object.entries(techPerformance)
            .map(([id, stats]) => ({ id, ...stats, rate: stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0 }))
            .sort((a, b) => b.completed - a.completed);
        
        return {
            currentTasks: currentTasks.length,
            prevTasks: prevTasks.length,
            tasksTrend: currentTasks.length - prevTasks.length,
            completedCurrent,
            completedPrev,
            completionTrend: completedCurrent - completedPrev,
            resolutionRate,
            resolutionTrend: resolutionRate - prevResolutionRate,
            avgTime,
            performers: performers.slice(0, 5)
        };
    }, [data.tasks, comparisonPeriod]);

    // Écouter les changements de widgets
    useEffect(() => {
        console.log('[Dashboard] Mounting widget listener...');
        const handleWidgetChange = () => {
            const newLayout = WidgetSystem.getLayout();
            console.log('[Dashboard] Widget layout changed:', newLayout);
            setWidgetLayout([...newLayout]); // Créer une nouvelle référence pour forcer le re-render
            setRefreshKey(k => k + 1);
        };
        
        // Recharger le layout quand la page devient visible ou au focus
        const handleVisibility = () => {
            if (document.visibilityState === 'visible') {
                const currentLayout = WidgetSystem.getLayout();
                console.log('[Dashboard] Page visible, layout:', currentLayout);
                setWidgetLayout([...currentLayout]);
            }
        };
        
        window.addEventListener('widget-layout-changed', handleWidgetChange);
        document.addEventListener('visibilitychange', handleVisibility);
        
        // Charger le layout initial
        const initialLayout = WidgetSystem.getLayout();
        console.log('[Dashboard] Layout initial:', initialLayout);
        setWidgetLayout([...initialLayout]);
        
        return () => {
            console.log('[Dashboard] Unmounting widget listener...');
            window.removeEventListener('widget-layout-changed', handleWidgetChange);
            document.removeEventListener('visibilitychange', handleVisibility);
        };
    }, []);

    // Calculer la semaine courante
    const getWeekInfo = () => {
        const now = new Date();
        const startOfYear = new Date(now.getFullYear(), 0, 1);
        const days = Math.floor((now - startOfYear) / (24 * 60 * 60 * 1000));
        const weekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7);
        return { week: weekNumber, year: now.getFullYear() };
    };
    const currentWeek = getWeekInfo();

    // Charger les données de la feuille d'heures
    useEffect(() => {
        const loadTimesheetData = async () => {
            try {
                // Charger la feuille de la semaine courante
                const { data: ts } = await db.from('timesheets')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('week_number', currentWeek.week)
                    .eq('year', currentWeek.year)
                    .maybeSingle();
                
                setTimesheetData(ts);

                // Charger les compteurs (année de congés juin-mai)
                const month = new Date().getMonth();
                const year = new Date().getFullYear();
                const leaveYear = month >= 5 ? year + 1 : year;
                
                const { data: balances } = await db.from('user_leave_balances')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('year', leaveYear)
                    .maybeSingle();
                
                setLeaveBalances(balances || { conges_solde: 0, recup_solde: 0 });
            } catch (err) {
                console.log('Pas de données feuille d\'heures:', err);
            } finally {
                setLoading(false);
            }
        };
        loadTimesheetData();
    }, [user.id]);

    const totalStock = data.parts.reduce((sum, p) => sum + (p.quantity || 0), 0);
    const lowStockCount = data.parts.filter(p => p.quantity <= (p.min_stock || 0)).length;
    const pendingTasks = data.tasks.filter(t => t.status !== 'termine').length;
    const pendingOrders = data.orders.filter(o => o.status === 'en-commande').length;
    const completedTasks = data.tasks.filter(t => t.status === 'termine').length;
    const totalValue = data.parts.reduce((sum, p) => sum + ((p.unit_price || 0) * (p.quantity || 0)), 0);
    
    // Mes travaux assignés
    const myTasks = data.tasks.filter(t => t.assigned_to === user.id && t.status !== 'termine');
    
    const categories = {};
    data.parts.forEach(p => { const cat = p.category || 'Autres'; categories[cat] = (categories[cat] || 0) + 1; });
    const categoryColors = [COLORS.primary, COLORS.secondary, COLORS.success, COLORS.warning, COLORS.purple];
    const categoryData = Object.entries(categories).slice(0, 5).map(([name, value], i) => ({ name, value, color: categoryColors[i % categoryColors.length] }));
    
    const recentTasks = data.tasks.slice(0, 5);
    
    // Formater les heures
    const formatHours = (hours) => {
        if (!hours) return '0h';
        const h = Math.floor(hours);
        const m = Math.round((hours - h) * 60);
        return m > 0 ? `${h}h${m.toString().padStart(2, '0')}` : `${h}h`;
    };

    const minutesToHM = (mins) => {
        if (!mins) return '0h00';
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return `${h}h${m.toString().padStart(2, '0')}`;
    };

    // Données pour les graphiques de statistiques
    const monthlyData = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin'].map(month => ({
        month, entries: Math.floor(Math.random() * 100) + 30, exits: Math.floor(Math.random() * 80) + 20
    }));
    const maxBarValue = Math.max(...monthlyData.map(d => Math.max(d.entries, d.exits)));

    // Contenu de l'onglet Statistiques
    // Données enrichies pour les statistiques
    const urgentTasksCount = data.tasks.filter(t => t.priority === 'urgente' && t.status !== 'termine').length;
    const tasksThisWeek = data.tasks.filter(t => {
        const created = new Date(t.created_at);
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        return created >= weekAgo;
    }).length;
    const tasksCompletedThisWeek = data.tasks.filter(t => {
        if (t.status !== 'termine') return false;
        const updated = new Date(t.updated_at || t.created_at);
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        return updated >= weekAgo;
    }).length;
    
    // Répartition par statut des tâches
    const tasksByStatus = {
        'non-defini': data.tasks.filter(t => t.status === 'non-defini' || !t.status).length,
        'en-commande': data.tasks.filter(t => t.status === 'en-commande').length,
        'en-stock': data.tasks.filter(t => t.status === 'en-stock').length,
        'termine': data.tasks.filter(t => t.status === 'termine').length
    };
    const totalTasksForPercent = Math.max(data.tasks.length, 1);

    // Répartition par priorité
    const tasksByPriority = {
        urgente: data.tasks.filter(t => t.priority === 'urgente').length,
        haute: data.tasks.filter(t => t.priority === 'haute').length,
        normal: data.tasks.filter(t => t.priority === 'normal' || !t.priority).length,
        basse: data.tasks.filter(t => t.priority === 'basse').length
    };

    // Top 5 catégories par quantité
    const categoryQuantities = {};
    data.parts.forEach(p => {
        const cat = p.category || 'Autres';
        categoryQuantities[cat] = (categoryQuantities[cat] || 0) + (p.quantity || 0);
    });
    const topCategories = Object.entries(categoryQuantities)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    // Top 5 emplacements
    const locationCounts = {};
    data.parts.forEach(p => {
        const loc = p.location || 'Non défini';
        locationCounts[loc] = (locationCounts[loc] || 0) + 1;
    });
    const topLocations = Object.entries(locationCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

    // Pièces les plus en stock
    const topStockParts = [...data.parts]
        .sort((a, b) => (b.quantity || 0) - (a.quantity || 0))
        .slice(0, 5);

    // Commandes par statut
    const ordersByStatus = {
        'en-commande': data.orders?.filter(o => o.status === 'en-commande').length || 0,
        'recue': data.orders?.filter(o => o.status === 'recue').length || 0,
        'annulee': data.orders?.filter(o => o.status === 'annulee').length || 0
    };
    const totalOrdersValue = data.orders?.reduce((sum, o) => sum + (o.total_amount || 0), 0) || 0;

    // Utilisateurs et leur activité
    const userTaskCounts = {};
    data.tasks.forEach(t => {
        if (t.assigned_to) {
            userTaskCounts[t.assigned_to] = (userTaskCounts[t.assigned_to] || 0) + 1;
        }
    });
    const topUsers = Object.entries(userTaskCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([userId, count]) => {
            const user = data.users?.find(u => u.id === userId);
            return { user, count };
        });

    const renderStatistics = () => h('div', { className: 'stats-content' },
        // KPIs principaux - Ligne 1
        h('div', { className: 'stats-grid', style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16, marginBottom: 24 } },
            h('div', { className: 'stats-card', style: { background: 'var(--card)', borderRadius: 16, padding: 20, border: '1px solid var(--border)' } },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--primary-pastel)', color: 'var(--primary)', width: 48, height: 48, borderRadius: 12, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 24, marginBottom: 16 } }, '📦'),
                h('div', { className: 'stats-card-value', style: { fontSize: 32, fontWeight: 800, color: 'var(--text)', marginBottom: 4 } }, data.parts.length),
                h('div', { className: 'stats-card-label', style: { fontSize: 14, color: 'var(--muted)' } }, 'Références')
            ),
            h('div', { className: 'stats-card', style: { background: 'var(--card)', borderRadius: 16, padding: 20, border: '1px solid var(--border)' } },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--info-pastel)', color: 'var(--info)', width: 48, height: 48, borderRadius: 12, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 24, marginBottom: 16 } }, '📊'),
                h('div', { className: 'stats-card-value', style: { fontSize: 32, fontWeight: 800, color: 'var(--text)', marginBottom: 4 } }, totalStock.toLocaleString()),
                h('div', { className: 'stats-card-label', style: { fontSize: 14, color: 'var(--muted)' } }, 'Quantité totale')
            ),
            h('div', { className: 'stats-card', style: { background: 'var(--card)', borderRadius: 16, padding: 20, border: '1px solid var(--border)' } },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--warning-pastel)', color: 'var(--warning)', width: 48, height: 48, borderRadius: 12, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 24, marginBottom: 16 } }, '⚠️'),
                h('div', { className: 'stats-card-value', style: { fontSize: 32, fontWeight: 800, color: 'var(--text)', marginBottom: 4 } }, lowStockCount),
                h('div', { className: 'stats-card-label', style: { fontSize: 14, color: 'var(--muted)' } }, 'Alertes stock')
            ),
            h('div', { className: 'stats-card', style: { background: 'var(--card)', borderRadius: 16, padding: 20, border: '1px solid var(--border)' } },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--success-pastel)', color: 'var(--success)', width: 48, height: 48, borderRadius: 12, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 24, marginBottom: 16 } }, '💰'),
                h('div', { className: 'stats-card-value', style: { fontSize: 32, fontWeight: 800, color: 'var(--text)', marginBottom: 4 } }, totalValue.toLocaleString() + ' €'),
                h('div', { className: 'stats-card-label', style: { fontSize: 14, color: 'var(--muted)' } }, 'Valeur stock')
            )
        ),

        // KPIs Tâches - Ligne 2
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 16, marginBottom: 24 } },
            h('div', { className: 'stats-card', style: { background: 'var(--card)', borderRadius: 16, padding: 20, border: '1px solid var(--border)' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('div', { style: { background: 'var(--info-pastel)', color: 'var(--info)', width: 40, height: 40, borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 } }, '🔧'),
                    h('div', null,
                        h('div', { style: { fontSize: 24, fontWeight: 800, color: 'var(--text)' } }, pendingTasks),
                        h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Tâches actives')
                    )
                )
            ),
            h('div', { className: 'stats-card', style: { background: 'var(--card)', borderRadius: 16, padding: 20, border: '1px solid var(--border)' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('div', { style: { background: 'var(--success-pastel)', color: 'var(--success)', width: 40, height: 40, borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 } }, '✅'),
                    h('div', null,
                        h('div', { style: { fontSize: 24, fontWeight: 800, color: 'var(--text)' } }, completedTasks),
                        h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Terminées')
                    )
                )
            ),
            h('div', { className: 'stats-card', style: { background: 'var(--card)', borderRadius: 16, padding: 20, border: '1px solid var(--border)' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('div', { style: { background: 'var(--danger-pastel)', color: 'var(--danger)', width: 40, height: 40, borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 } }, '🚨'),
                    h('div', null,
                        h('div', { style: { fontSize: 24, fontWeight: 800, color: 'var(--text)' } }, urgentTasksCount),
                        h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Urgentes')
                    )
                )
            ),
            h('div', { className: 'stats-card', style: { background: 'var(--card)', borderRadius: 16, padding: 20, border: '1px solid var(--border)' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('div', { style: { background: 'var(--purple-pastel)', color: 'var(--purple)', width: 40, height: 40, borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 } }, '📅'),
                    h('div', null,
                        h('div', { style: { fontSize: 24, fontWeight: 800, color: 'var(--text)' } }, tasksThisWeek),
                        h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Cette semaine')
                    )
                )
            ),
            h('div', { className: 'stats-card', style: { background: 'var(--card)', borderRadius: 16, padding: 20, border: '1px solid var(--border)' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('div', { style: { background: 'var(--teal-pastel)', color: 'var(--teal)', width: 40, height: 40, borderRadius: 10, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 20 } }, '🛒'),
                    h('div', null,
                        h('div', { style: { fontSize: 24, fontWeight: 800, color: 'var(--text)' } }, data.orders?.length || 0),
                        h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Commandes')
                    )
                )
            )
        ),

        // Graphiques - Ligne 3
        h('div', { style: { display: 'grid', gridTemplateColumns: '2fr 1fr', gap: 20, marginBottom: 24 } },
            h('div', { className: 'card' },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '📈 Mouvements de stock'),
                    h('div', { style: { display: 'flex', gap: 16 } },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 6, fontSize: 12, color: 'var(--muted)' } },
                            h('div', { style: { width: 8, height: 8, borderRadius: '50%', background: 'var(--success)' } }), 'Entrées'),
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 6, fontSize: 12, color: 'var(--muted)' } },
                            h('div', { style: { width: 8, height: 8, borderRadius: '50%', background: 'var(--danger)' } }), 'Sorties')
                    )
                ),
                h('div', { className: 'card-body' },
                    h('div', { className: 'bar-chart', style: { display: 'flex', alignItems: 'flex-end', justifyContent: 'space-around', height: 200, padding: '20px 0', gap: 16 } },
                        monthlyData.map((d, idx) =>
                            h('div', { key: idx, style: { display: 'flex', flexDirection: 'column', alignItems: 'center', gap: 8, flex: 1 } },
                                h('div', { style: { display: 'flex', gap: 4, alignItems: 'flex-end', height: 160 } },
                                    h('div', { style: { width: 20, borderRadius: '4px 4px 0 0', background: 'var(--success)', height: (d.entries / maxBarValue) * 100 + '%', minHeight: 4, transition: 'height 0.5s ease-out' } }),
                                    h('div', { style: { width: 20, borderRadius: '4px 4px 0 0', background: 'var(--danger)', height: (d.exits / maxBarValue) * 100 + '%', minHeight: 4, transition: 'height 0.5s ease-out' } })
                                ),
                                h('div', { style: { fontSize: 12, color: 'var(--muted)', fontWeight: 500 } }, d.month)
                            )
                        )
                    )
                )
            ),
            h('div', { className: 'card' },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '📊 Répartition catégories')
                ),
                h('div', { className: 'card-body' },
                    h('div', { className: 'donut-container' },
                        categoryData.length > 0 ? h(Fragment, null,
                            h(DonutChart, { data: categoryData }),
                            h('div', { className: 'donut-legend' },
                                categoryData.map((item, i) => h('div', { key: i, className: 'donut-legend-item' },
                                    h('div', { className: 'donut-legend-left' },
                                        h('span', { className: 'donut-legend-dot', style: { background: item.color } }),
                                        h('span', { className: 'donut-legend-label' }, item.name)
                                    ),
                                    h('span', { className: 'donut-legend-value' }, item.value)
                                ))
                            )
                        ) : h('div', { className: 'empty-state' }, h('p', { className: 'empty-desc' }, 'Aucune donnée'))
                    )
                )
            )
        ),

        // Répartition tâches par statut - Ligne 4
        h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 20, marginBottom: 24 } },
            h('div', { className: 'card' },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '📋 Tâches par statut')
                ),
                h('div', { className: 'card-body' },
                    h('div', { style: { display: 'flex', flexDirection: 'column', gap: 12 } },
                        [
                            { label: 'Non défini', value: tasksByStatus['non-defini'], color: 'var(--muted)', icon: '⏳' },
                            { label: 'En commande', value: tasksByStatus['en-commande'], color: 'var(--warning)', icon: '🛒' },
                            { label: 'En stock', value: tasksByStatus['en-stock'], color: 'var(--info)', icon: '📦' },
                            { label: 'Terminé', value: tasksByStatus['termine'], color: 'var(--success)', icon: '✅' }
                        ].map((item, idx) => 
                            h('div', { key: idx, style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                h('span', { style: { fontSize: 18, width: 30 } }, item.icon),
                                h('div', { style: { flex: 1 } },
                                    h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 4 } },
                                        h('span', { style: { fontSize: 13, color: 'var(--text)' } }, item.label),
                                        h('span', { style: { fontSize: 13, fontWeight: 600, color: 'var(--text)' } }, item.value)
                                    ),
                                    h('div', { style: { height: 8, background: 'var(--background)', borderRadius: 4, overflow: 'hidden' } },
                                        h('div', { style: { height: '100%', width: ((item.value / totalTasksForPercent) * 100) + '%', background: item.color, borderRadius: 4, transition: 'width 0.5s ease-out' } })
                                    )
                                ),
                                h('span', { style: { fontSize: 12, color: 'var(--muted)', width: 40, textAlign: 'right' } }, Math.round((item.value / totalTasksForPercent) * 100) + '%')
                            )
                        )
                    )
                )
            ),
            h('div', { className: 'card' },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '🎯 Tâches par priorité')
                ),
                h('div', { className: 'card-body' },
                    h('div', { style: { display: 'flex', flexDirection: 'column', gap: 12 } },
                        [
                            { label: 'Urgente', value: tasksByPriority.urgente, color: 'var(--danger)', icon: '🚨' },
                            { label: 'Haute', value: tasksByPriority.haute, color: 'var(--warning)', icon: '🔴' },
                            { label: 'Normal', value: tasksByPriority.normal, color: 'var(--info)', icon: '🔵' },
                            { label: 'Basse', value: tasksByPriority.basse, color: 'var(--muted)', icon: '⚪' }
                        ].map((item, idx) => 
                            h('div', { key: idx, style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                h('span', { style: { fontSize: 18, width: 30 } }, item.icon),
                                h('div', { style: { flex: 1 } },
                                    h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 4 } },
                                        h('span', { style: { fontSize: 13, color: 'var(--text)' } }, item.label),
                                        h('span', { style: { fontSize: 13, fontWeight: 600, color: 'var(--text)' } }, item.value)
                                    ),
                                    h('div', { style: { height: 8, background: 'var(--background)', borderRadius: 4, overflow: 'hidden' } },
                                        h('div', { style: { height: '100%', width: ((item.value / totalTasksForPercent) * 100) + '%', background: item.color, borderRadius: 4, transition: 'width 0.5s ease-out' } })
                                    )
                                ),
                                h('span', { style: { fontSize: 12, color: 'var(--muted)', width: 40, textAlign: 'right' } }, Math.round((item.value / totalTasksForPercent) * 100) + '%')
                            )
                        )
                    )
                )
            )
        ),

        // Tableaux - Ligne 5
        h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 20, marginBottom: 24 } },
            // Top catégories
            h('div', { className: 'card' },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '📁 Top catégories')
                ),
                h('div', { className: 'card-body no-padding' },
                    h('table', { style: { width: '100%' } },
                        h('tbody', null,
                            topCategories.map(([cat, qty], idx) =>
                                h('tr', { key: idx },
                                    h('td', { style: { padding: '10px 16px' } },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            h('span', { style: { width: 24, height: 24, borderRadius: '50%', background: categoryColors[idx % categoryColors.length], color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 12, fontWeight: 600 } }, idx + 1),
                                            h('span', { style: { color: 'var(--text)' } }, cat)
                                        )
                                    ),
                                    h('td', { style: { padding: '10px 16px', textAlign: 'right', fontWeight: 600, color: 'var(--text)' } }, qty.toLocaleString())
                                )
                            ),
                            topCategories.length === 0 && h('tr', null, h('td', { colSpan: 2, style: { padding: 20, textAlign: 'center', color: 'var(--muted)' } }, 'Aucune catégorie'))
                        )
                    )
                )
            ),
            // Top emplacements
            h('div', { className: 'card' },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '📍 Top emplacements')
                ),
                h('div', { className: 'card-body no-padding' },
                    h('table', { style: { width: '100%' } },
                        h('tbody', null,
                            topLocations.map(([loc, count], idx) =>
                                h('tr', { key: idx },
                                    h('td', { style: { padding: '10px 16px' } },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            h('span', { style: { width: 24, height: 24, borderRadius: '50%', background: 'var(--info-pastel)', color: 'var(--info)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 12, fontWeight: 600 } }, idx + 1),
                                            h('span', { style: { color: 'var(--text)' } }, loc)
                                        )
                                    ),
                                    h('td', { style: { padding: '10px 16px', textAlign: 'right' } },
                                        h('span', { className: 'badge badge-info' }, count, ' réf.')
                                    )
                                )
                            ),
                            topLocations.length === 0 && h('tr', null, h('td', { colSpan: 2, style: { padding: 20, textAlign: 'center', color: 'var(--muted)' } }, 'Aucun emplacement'))
                        )
                    )
                )
            ),
            // Top pièces en stock
            h('div', { className: 'card' },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '📦 Top stock')
                ),
                h('div', { className: 'card-body no-padding' },
                    h('table', { style: { width: '100%' } },
                        h('tbody', null,
                            topStockParts.map((part, idx) =>
                                h('tr', { key: idx },
                                    h('td', { style: { padding: '10px 16px' } },
                                        h('div', null,
                                            h('div', { style: { fontWeight: 600, color: 'var(--text)', fontSize: 13 } }, part.ref),
                                            h('div', { style: { fontSize: 11, color: 'var(--muted)' } }, part.name?.substring(0, 25) || '-')
                                        )
                                    ),
                                    h('td', { style: { padding: '10px 16px', textAlign: 'right' } },
                                        h('span', { className: 'badge badge-success' }, part.quantity?.toLocaleString())
                                    )
                                )
                            ),
                            topStockParts.length === 0 && h('tr', null, h('td', { colSpan: 2, style: { padding: 20, textAlign: 'center', color: 'var(--muted)' } }, 'Aucune pièce'))
                        )
                    )
                )
            )
        ),

        // Commandes et Utilisateurs - Ligne 6
        h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 20, marginBottom: 24 } },
            // Statistiques commandes
            h('div', { className: 'card' },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '🛒 Commandes')
                ),
                h('div', { className: 'card-body' },
                    h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16, marginBottom: 20 } },
                        h('div', { style: { textAlign: 'center', padding: 16, background: 'var(--warning-pastel)', borderRadius: 12 } },
                            h('div', { style: { fontSize: 28, fontWeight: 800, color: 'var(--warning)' } }, ordersByStatus['en-commande']),
                            h('div', { style: { fontSize: 12, color: 'var(--warning)' } }, 'En cours')
                        ),
                        h('div', { style: { textAlign: 'center', padding: 16, background: 'var(--success-pastel)', borderRadius: 12 } },
                            h('div', { style: { fontSize: 28, fontWeight: 800, color: 'var(--success)' } }, ordersByStatus['recue']),
                            h('div', { style: { fontSize: 12, color: 'var(--success)' } }, 'Reçues')
                        ),
                        h('div', { style: { textAlign: 'center', padding: 16, background: 'var(--danger-pastel)', borderRadius: 12 } },
                            h('div', { style: { fontSize: 28, fontWeight: 800, color: 'var(--danger)' } }, ordersByStatus['annulee']),
                            h('div', { style: { fontSize: 12, color: 'var(--danger)' } }, 'Annulées')
                        )
                    ),
                    h('div', { style: { padding: 16, background: 'var(--background)', borderRadius: 12, textAlign: 'center' } },
                        h('div', { style: { fontSize: 12, color: 'var(--muted)', marginBottom: 4 } }, 'Valeur totale des commandes'),
                        h('div', { style: { fontSize: 28, fontWeight: 800, color: 'var(--text)' } }, totalOrdersValue.toLocaleString(), ' €')
                    )
                )
            ),
            // Top utilisateurs
            h('div', { className: 'card' },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '👥 Activité utilisateurs')
                ),
                h('div', { className: 'card-body no-padding' },
                    h('table', { style: { width: '100%' } },
                        h('tbody', null,
                            topUsers.map((item, idx) =>
                                h('tr', { key: idx },
                                    h('td', { style: { padding: '12px 16px' } },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                            h('div', { style: { width: 36, height: 36, borderRadius: '50%', background: 'var(--primary-pastel)', color: 'var(--primary)', display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 600, fontSize: 14 } }, 
                                                (item.user?.first_name?.[0] || '?') + (item.user?.last_name?.[0] || '')
                                            ),
                                            h('div', null,
                                                h('div', { style: { fontWeight: 600, color: 'var(--text)' } }, item.user?.first_name || 'Utilisateur', ' ', item.user?.last_name || ''),
                                                h('div', { style: { fontSize: 11, color: 'var(--muted)' } }, item.user?.role || 'Utilisateur')
                                            )
                                        )
                                    ),
                                    h('td', { style: { padding: '12px 16px', textAlign: 'right' } },
                                        h('span', { className: 'badge badge-primary' }, item.count, ' tâches')
                                    )
                                )
                            ),
                            topUsers.length === 0 && h('tr', null, h('td', { colSpan: 2, style: { padding: 20, textAlign: 'center', color: 'var(--muted)' } }, 'Aucune activité'))
                        )
                    )
                )
            )
        ),

        // Alertes stock détaillées - Ligne 7
        h('div', { className: 'card', style: { marginBottom: 24 } },
            h('div', { className: 'card-header' },
                h('h3', { className: 'card-title' }, '⚠️ Détail des alertes stock (', lowStockCount, ')')
            ),
            h('div', { className: 'card-body no-padding' },
                lowStockCount > 0 ? h('table', null,
                    h('thead', null, 
                        h('tr', null, 
                            h('th', null, 'Référence'), 
                            h('th', null, 'Désignation'), 
                            h('th', null, 'Catégorie'), 
                            h('th', null, 'Emplacement'), 
                            h('th', { style: { textAlign: 'center' } }, 'Stock'), 
                            h('th', { style: { textAlign: 'center' } }, 'Min'), 
                            h('th', { style: { textAlign: 'center' } }, 'Écart')
                        )
                    ),
                    h('tbody', null, 
                        data.parts.filter(p => p.quantity <= (p.min_stock || 0)).slice(0, 10).map(part =>
                            h('tr', { key: part.id },
                                h('td', null, h('code', { style: { fontSize: 12 } }, part.ref)),
                                h('td', { style: { color: 'var(--text)' } }, part.name?.substring(0, 40) || '-'),
                                h('td', null, h('span', { className: 'badge badge-secondary' }, part.category || 'Autres')),
                                h('td', { style: { fontSize: 13, color: 'var(--muted)' } }, part.location || '-'),
                                h('td', { style: { textAlign: 'center' } }, h('span', { className: 'badge badge-danger' }, part.quantity || 0)),
                                h('td', { style: { textAlign: 'center', color: 'var(--muted)' } }, part.min_stock || 0),
                                h('td', { style: { textAlign: 'center' } }, 
                                    h('span', { style: { color: 'var(--danger)', fontWeight: 600 } }, (part.quantity || 0) - (part.min_stock || 0))
                                )
                            )
                        )
                    )
                ) : h('div', { style: { padding: 40, textAlign: 'center' } },
                    h('div', { style: { fontSize: 48, marginBottom: 12 } }, '✅'),
                    h('p', { style: { color: 'var(--muted)' } }, 'Aucune alerte de stock')
                )
            )
        )
    );
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' },
                h('h1', { className: 'page-title' }, `Bonjour, ${user.first_name || 'Utilisateur'} 👋`),
                h('p', { className: 'page-subtitle' }, `Semaine ${currentWeek.week} • ${new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`)
            ),
            h('div', { className: 'page-header-right', style: { display: 'flex', gap: 8 } },
                h('button', {
                    className: 'btn btn-ghost',
                    onClick: () => {
                        const layout = WidgetSystem.getLayout();
                        console.log('[Dashboard] Rafraîchissement manuel, layout:', layout);
                        setWidgetLayout([...layout]);
                        showToast(layout.length > 0 ? `${layout.length} widget(s) chargé(s)` : 'Aucun widget configuré', 'info');
                    },
                    title: 'Rafraîchir les widgets'
                }, '🔄'),
                h('button', {
                    className: 'btn btn-secondary',
                    onClick: () => setShowDigestModal(true),
                    title: 'Configurer les emails récapitulatifs'
                }, '📧 Digest'),
                h('button', {
                    className: 'btn btn-secondary',
                    onClick: () => setShowRulesModal(true),
                    title: 'Gérer les règles de notification'
                }, '🔔 Alertes'),
                h('button', {
                    className: 'btn btn-secondary',
                    onClick: () => window.dispatchEvent(new CustomEvent('open-widget-picker')),
                    title: 'Configurer les widgets du tableau de bord'
                }, '⚙️ Personnaliser')
            )
        ),

        // Onglets Dashboard / Statistiques / Comparaison / KPIs
        h('div', { className: 'tabs', style: { marginBottom: 20, display: 'flex', gap: 4, background: 'var(--background)', padding: 4, borderRadius: 12, width: 'fit-content' } },
            h('button', { 
                className: 'tab ' + (activeTab === 'overview' ? 'active' : ''),
                onClick: () => setActiveTab('overview'),
                style: { padding: '10px 20px', border: 'none', borderRadius: 8, cursor: 'pointer', fontWeight: 500, fontSize: 14, background: activeTab === 'overview' ? 'var(--card)' : 'transparent', color: activeTab === 'overview' ? 'var(--primary)' : 'var(--muted)', boxShadow: activeTab === 'overview' ? 'var(--shadow-sm)' : 'none' }
            }, '📋 Vue d\'ensemble'),
            h('button', { 
                className: 'tab ' + (activeTab === 'statistics' ? 'active' : ''),
                onClick: () => setActiveTab('statistics'),
                style: { padding: '10px 20px', border: 'none', borderRadius: 8, cursor: 'pointer', fontWeight: 500, fontSize: 14, background: activeTab === 'statistics' ? 'var(--card)' : 'transparent', color: activeTab === 'statistics' ? 'var(--primary)' : 'var(--muted)', boxShadow: activeTab === 'statistics' ? 'var(--shadow-sm)' : 'none' }
            }, '📊 Statistiques'),
            h('button', { 
                className: 'tab ' + (activeTab === 'comparison' ? 'active' : ''),
                onClick: () => setActiveTab('comparison'),
                style: { padding: '10px 20px', border: 'none', borderRadius: 8, cursor: 'pointer', fontWeight: 500, fontSize: 14, background: activeTab === 'comparison' ? 'var(--card)' : 'transparent', color: activeTab === 'comparison' ? 'var(--primary)' : 'var(--muted)', boxShadow: activeTab === 'comparison' ? 'var(--shadow-sm)' : 'none' }
            }, '📈 Comparaison'),
            h('button', { 
                className: 'tab ' + (activeTab === 'kpis' ? 'active' : ''),
                onClick: () => setActiveTab('kpis'),
                style: { padding: '10px 20px', border: 'none', borderRadius: 8, cursor: 'pointer', fontWeight: 500, fontSize: 14, background: activeTab === 'kpis' ? 'var(--card)' : 'transparent', color: activeTab === 'kpis' ? 'var(--primary)' : 'var(--muted)', boxShadow: activeTab === 'kpis' ? 'var(--shadow-sm)' : 'none' }
            }, '🎯 KPIs avancés')
        ),

        // Contenu selon l'onglet actif
        activeTab === 'kpis' ? (
            // Onglet KPIs avancés v5.6
            h('div', null,
                // Sélecteur de période
                h('div', { style: { marginBottom: 20, display: 'flex', gap: 8, alignItems: 'center' } },
                    h('span', { style: { color: COLORS.muted, fontSize: 14 } }, 'Comparer par:'),
                    h('button', { className: `btn btn-sm ${comparisonPeriod === 'week' ? 'btn-primary' : 'btn-secondary'}`, onClick: () => setComparisonPeriod('week') }, 'Semaine'),
                    h('button', { className: `btn btn-sm ${comparisonPeriod === 'month' ? 'btn-primary' : 'btn-secondary'}`, onClick: () => setComparisonPeriod('month') }, 'Mois'),
                    h('button', { className: `btn btn-sm ${comparisonPeriod === 'quarter' ? 'btn-primary' : 'btn-secondary'}`, onClick: () => setComparisonPeriod('quarter') }, 'Trimestre')
                ),
                
                // KPIs principaux avec tendances
                h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16, marginBottom: 24 } },
                    h('div', { className: 'card', style: { padding: 20 } },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
                            h('div', null,
                                h('div', { style: { color: COLORS.muted, fontSize: 12, marginBottom: 4 } }, 'Tâches créées'),
                                h('div', { style: { fontSize: 32, fontWeight: 700 } }, advancedKPIs.currentTasks)
                            ),
                            h('div', { style: { padding: '4px 10px', borderRadius: 20, fontSize: 12, fontWeight: 600, background: advancedKPIs.tasksTrend >= 0 ? COLORS.successPastel : COLORS.dangerPastel, color: advancedKPIs.tasksTrend >= 0 ? COLORS.success : COLORS.danger } },
                                advancedKPIs.tasksTrend >= 0 ? '↑' : '↓', ' ', Math.abs(advancedKPIs.tasksTrend)
                            )
                        ),
                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginTop: 8 } }, 'vs période précédente: ', advancedKPIs.prevTasks)
                    ),
                    h('div', { className: 'card', style: { padding: 20 } },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
                            h('div', null,
                                h('div', { style: { color: COLORS.muted, fontSize: 12, marginBottom: 4 } }, 'Tâches terminées'),
                                h('div', { style: { fontSize: 32, fontWeight: 700, color: COLORS.success } }, advancedKPIs.completedCurrent)
                            ),
                            h('div', { style: { padding: '4px 10px', borderRadius: 20, fontSize: 12, fontWeight: 600, background: advancedKPIs.completionTrend >= 0 ? COLORS.successPastel : COLORS.dangerPastel, color: advancedKPIs.completionTrend >= 0 ? COLORS.success : COLORS.danger } },
                                advancedKPIs.completionTrend >= 0 ? '↑' : '↓', ' ', Math.abs(advancedKPIs.completionTrend)
                            )
                        ),
                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginTop: 8 } }, 'vs période précédente: ', advancedKPIs.completedPrev)
                    ),
                    h('div', { className: 'card', style: { padding: 20 } },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
                            h('div', null,
                                h('div', { style: { color: COLORS.muted, fontSize: 12, marginBottom: 4 } }, 'Taux de résolution'),
                                h('div', { style: { fontSize: 32, fontWeight: 700, color: advancedKPIs.resolutionRate >= 70 ? COLORS.success : advancedKPIs.resolutionRate >= 50 ? COLORS.warning : COLORS.danger } }, advancedKPIs.resolutionRate, '%')
                            ),
                            h('div', { style: { padding: '4px 10px', borderRadius: 20, fontSize: 12, fontWeight: 600, background: advancedKPIs.resolutionTrend >= 0 ? COLORS.successPastel : COLORS.dangerPastel, color: advancedKPIs.resolutionTrend >= 0 ? COLORS.success : COLORS.danger } },
                                advancedKPIs.resolutionTrend >= 0 ? '↑' : '↓', ' ', Math.abs(advancedKPIs.resolutionTrend), '%'
                            )
                        ),
                        h('div', { style: { width: '100%', height: 6, background: COLORS.background, borderRadius: 3, marginTop: 12 } },
                            h('div', { style: { width: advancedKPIs.resolutionRate + '%', height: '100%', background: advancedKPIs.resolutionRate >= 70 ? COLORS.success : advancedKPIs.resolutionRate >= 50 ? COLORS.warning : COLORS.danger, borderRadius: 3, transition: 'width 0.5s' } })
                        )
                    ),
                    h('div', { className: 'card', style: { padding: 20 } },
                        h('div', null,
                            h('div', { style: { color: COLORS.muted, fontSize: 12, marginBottom: 4 } }, 'Temps moyen'),
                            h('div', { style: { fontSize: 32, fontWeight: 700, color: COLORS.info } }, advancedKPIs.avgTime, ' min')
                        ),
                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginTop: 8 } }, 'Durée moyenne estimée par tâche')
                    )
                ),
                
                // Performance par technicien
                h('div', { className: 'card', style: { marginBottom: 24 } },
                    h('div', { className: 'card-header' },
                        h('h3', { className: 'card-title' }, '🏆 Performance par technicien')
                    ),
                    h('div', { className: 'card-body' },
                        advancedKPIs.performers.length > 0 ?
                            h('div', { style: { display: 'flex', flexDirection: 'column', gap: 12 } },
                                advancedKPIs.performers.map((perf, idx) => {
                                    const tech = data.users?.find(u => u.id === perf.id);
                                    return h('div', { key: perf.id, style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                        h('div', { style: { width: 28, height: 28, borderRadius: '50%', background: idx === 0 ? '#FFD700' : idx === 1 ? '#C0C0C0' : idx === 2 ? '#CD7F32' : COLORS.background, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 12, fontWeight: 600 } }, idx + 1),
                                        h('div', { style: { flex: 1 } },
                                            h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 4 } },
                                                h('span', { style: { fontWeight: 600 } }, tech ? `${tech.first_name || ''} ${tech.last_name || ''}`.trim() : 'Inconnu'),
                                                h('span', { style: { color: COLORS.muted, fontSize: 13 } }, `${perf.completed}/${perf.total} (${perf.rate}%)`)
                                            ),
                                            h('div', { style: { width: '100%', height: 8, background: COLORS.background, borderRadius: 4 } },
                                                h('div', { style: { width: perf.rate + '%', height: '100%', background: perf.rate >= 80 ? COLORS.success : perf.rate >= 60 ? COLORS.warning : COLORS.danger, borderRadius: 4, transition: 'width 0.5s' } })
                                            )
                                        )
                                    );
                                })
                            ) :
                            h('p', { style: { color: COLORS.muted, textAlign: 'center' } }, 'Aucune donnée de performance')
                    )
                ),
                
                // Alertes intelligentes
                h('div', { className: 'card' },
                    h('div', { className: 'card-header' },
                        h('h3', { className: 'card-title' }, '⚠️ Alertes intelligentes')
                    ),
                    h('div', { className: 'card-body' },
                        h('div', { style: { display: 'flex', flexDirection: 'column', gap: 12 } },
                            lowStockCount > 0 && h('div', { style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: COLORS.warningPastel, borderRadius: 8, borderLeft: '4px solid ' + COLORS.warning } },
                                h('span', { style: { fontSize: 24 } }, '📦'),
                                h('div', null,
                                    h('div', { style: { fontWeight: 600, color: COLORS.warning } }, `${lowStockCount} pièce(s) en stock critique`),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Vérifier les niveaux et passer commande')
                                )
                            ),
                            pendingTasks > 10 && h('div', { style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: COLORS.infoPastel, borderRadius: 8, borderLeft: '4px solid ' + COLORS.info } },
                                h('span', { style: { fontSize: 24 } }, '📋'),
                                h('div', null,
                                    h('div', { style: { fontWeight: 600, color: COLORS.info } }, `${pendingTasks} tâches en attente`),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Considérer une répartition des charges')
                                )
                            ),
                            advancedKPIs.resolutionRate < 50 && h('div', { style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: COLORS.dangerPastel, borderRadius: 8, borderLeft: '4px solid ' + COLORS.danger } },
                                h('span', { style: { fontSize: 24 } }, '📉'),
                                h('div', null,
                                    h('div', { style: { fontWeight: 600, color: COLORS.danger } }, 'Taux de résolution faible'),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Analyser les causes de blocage')
                                )
                            ),
                            lowStockCount === 0 && pendingTasks <= 10 && advancedKPIs.resolutionRate >= 50 && h('div', { style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: COLORS.successPastel, borderRadius: 8, borderLeft: '4px solid ' + COLORS.success } },
                                h('span', { style: { fontSize: 24 } }, '✅'),
                                h('div', null,
                                    h('div', { style: { fontWeight: 600, color: COLORS.success } }, 'Tout est sous contrôle'),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Aucune alerte critique')
                                )
                            )
                        )
                    )
                )
            )
        ) :
        activeTab === 'comparison' ? (
            h(PeriodComparisonWidget, { data })
        ) :
        activeTab === 'statistics' ? renderStatistics() : h(Fragment, null,
            // Section Feuille d'heures
            h('div', { className: 'card', style: { marginBottom: 20, background: 'linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%)' } },
                h('div', { className: 'card-body', style: { padding: 20 } },
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 16 } },
                        h('div', null,
                            h('div', { style: { color: 'rgba(255,255,255,0.8)', fontSize: 13, marginBottom: 4 } }, '📅 Ma feuille d\'heures - Semaine ' + currentWeek.week),
                            h('div', { style: { color: 'white', fontSize: 24, fontWeight: 700 } },
                                loading ? 'Chargement...' :
                                timesheetData ? 
                                    (timesheetData.status === 'valide' ? '✅ Validée' : 
                                     timesheetData.status === 'brouillon' ? '📝 Brouillon' : '⏳ En attente') :
                                    '🆕 Non commencée'
                            ),
                            timesheetData && h('div', { style: { color: 'rgba(255,255,255,0.9)', fontSize: 14, marginTop: 8 } },
                                `Travail: ${minutesToHM(timesheetData.total_work_minutes || 0)} • Trajet: ${minutesToHM(timesheetData.total_travel_minutes || 0)}`
                            )
                        ),
                        h('div', { style: { display: 'flex', gap: 16 } },
                            h('div', { style: { textAlign: 'center', background: 'rgba(255,255,255,0.15)', padding: '12px 20px', borderRadius: 10 } },
                                h('div', { style: { color: 'rgba(255,255,255,0.8)', fontSize: 11 } }, '🏖️ Congés'),
                                h('div', { style: { color: 'white', fontSize: 20, fontWeight: 700 } }, 
                                    loading ? '-' : `${(leaveBalances?.conges_solde || 0).toFixed(1)}j`
                                )
                            ),
                            h('div', { style: { textAlign: 'center', background: 'rgba(255,255,255,0.15)', padding: '12px 20px', borderRadius: 10 } },
                                h('div', { style: { color: 'rgba(255,255,255,0.8)', fontSize: 11 } }, '🔄 Récup'),
                                h('div', { style: { color: 'white', fontSize: 20, fontWeight: 700 } }, 
                                    loading ? '-' : `${(leaveBalances?.recup_solde || 0).toFixed(1)}h`
                                )
                            )
                        )
                    )
                )
            ),
            
            h('div', { className: 'kpi-grid' },
                h('div', { className: 'kpi-card primary' },
                    h('div', { className: 'kpi-header' },
                        h('div', { className: 'kpi-icon' }, h(Icon, { name: 'stock', size: 22 }))
                    ),
                    h('div', { className: 'kpi-label' }, 'Total Pièces'),
                    h('div', { className: 'kpi-value' }, formatNumber(totalStock)),
                    lowStockCount > 0 && h('div', { className: 'kpi-trend down' }, h(Icon, { name: 'alert', size: 14 }), lowStockCount, h('span', { className: 'kpi-trend-text' }, ' en alerte'))
                ),
                h('div', { className: 'kpi-card success' },
                    h('div', { className: 'kpi-header' },
                        h('div', { className: 'kpi-icon' }, h(Icon, { name: 'tasks', size: 22 }))
                    ),
                    h('div', { className: 'kpi-label' }, 'Mes travaux'),
                    h('div', { className: 'kpi-value' }, myTasks.length),
                    h('div', { className: 'kpi-trend' }, h('span', { className: 'kpi-trend-text' }, 'à réaliser'))
                ),
                h('div', { className: 'kpi-card warning' },
                    h('div', { className: 'kpi-header' },
                        h('div', { className: 'kpi-icon' }, h(Icon, { name: 'orders', size: 22 }))
                    ),
                    h('div', { className: 'kpi-label' }, 'Commandes'),
                    h('div', { className: 'kpi-value' }, pendingOrders),
                    h('div', { className: 'kpi-trend' }, h('span', { className: 'kpi-trend-text' }, 'en attente'))
                ),
                h('div', { className: 'kpi-card danger' },
                    h('div', { className: 'kpi-header' },
                        h('div', { className: 'kpi-icon' }, h(Icon, { name: 'alert', size: 22 }))
                    ),
                    h('div', { className: 'kpi-label' }, 'Alertes Stock'),
                    h('div', { className: 'kpi-value' }, lowStockCount),
                    h('div', { className: 'kpi-trend' }, h('span', { className: 'kpi-trend-text' }, 'stock critique'))
                )
            ),
            
            h('div', { className: 'charts-grid' },
                h('div', { className: 'card' },
                    h('div', { className: 'card-header' },
                        h('h3', { className: 'card-title' }, h(Icon, { name: 'tasks', size: 18 }), 'Mes travaux assignés')
                    ),
                    h('div', { className: 'card-body no-padding' },
                        myTasks.length > 0 ? h('table', null,
                            h('thead', null, h('tr', null, h('th', null, 'Appareil'), h('th', null, 'Lieu'), h('th', null, 'Priorité'), h('th', null, 'Statut'))),
                            h('tbody', null, myTasks.slice(0, 5).map(task => {
                                const priorityColors = { urgente: 'danger', haute: 'orange', normal: 'info', basse: 'secondary' };
                                const statusColors = { 'non-defini': 'secondary', 'en-stock': 'info', 'en-commande': 'warning', 'termine': 'success' };
                                return h('tr', { key: task.id },
                                    h('td', null, h('strong', null, task.device_number)),
                                    h('td', { style: { fontSize: 13, color: 'var(--muted)' } }, task.location || task.tournee || '-'),
                                    h('td', null, h('span', { className: `badge badge-${priorityColors[task.priority] || 'secondary'}` }, task.priority || 'Normal')),
                                    h('td', null, h('span', { className: `badge badge-${statusColors[task.status] || 'secondary'}` }, task.status || 'Non défini'))
                                );
                            }))
                        ) : h('div', { className: 'empty-state', style: { padding: 40 } }, 
                            h('div', { style: { fontSize: 48, marginBottom: 12 } }, '🎉'),
                            h('p', { className: 'empty-desc' }, 'Aucun travail assigné en cours')
                        )
                    )
                ),
                h('div', { className: 'card' },
                    h('div', { className: 'card-header' },
                        h('h3', { className: 'card-title' }, h(Icon, { name: 'folder', size: 18 }), 'Répartition du stock')
                    ),
                    h('div', { className: 'card-body' },
                        h('div', { className: 'donut-container' },
                            categoryData.length > 0 ? h(Fragment, null,
                                h(DonutChart, { data: categoryData }),
                                h('div', { className: 'donut-legend' },
                                    categoryData.map((item, i) => h('div', { key: i, className: 'donut-legend-item' },
                                        h('div', { className: 'donut-legend-left' },
                                            h('span', { className: 'donut-legend-dot', style: { background: item.color } }),
                                            h('span', { className: 'donut-legend-label' }, item.name)
                                        ),
                                        h('span', { className: 'donut-legend-value' }, item.value)
                                    ))
                                )
                            ) : h('div', { className: 'empty-state' }, h('p', { className: 'empty-desc' }, 'Aucune donnée'))
                        )
                    )
                )
            ),
            
            h('div', { className: 'bottom-grid' },
                h('div', { className: 'card' },
                    h('div', { className: 'card-header' },
                        h('h3', { className: 'card-title' }, h(Icon, { name: 'tasks', size: 18 }), 'Tous les travaux récents')
                    ),
                    h('div', { className: 'card-body no-padding' },
                        recentTasks.length > 0 ? h('table', null,
                            h('thead', null, h('tr', null, h('th', { style: { width: 40 } }, ''), h('th', null, 'Appareil'), h('th', null, 'Assigné à'), h('th', null, 'Statut'))),
                            h('tbody', null, recentTasks.map(task => {
                                const statusClass = task.status === 'termine' ? 'completed' : task.status === 'en-stock' ? 'in-progress' : 'pending';
                                const badgeClass = task.status === 'termine' ? 'success' : task.status === 'en-stock' ? 'info' : 'warning';
                                const assignee = data.users.find(u => u.id === task.assigned_to);
                                return h('tr', { key: task.id },
                                    h('td', null, h('div', { className: `status-dot ${statusClass}` })),
                                    h('td', null, h('strong', null, task.device_number), h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, task.location || task.tournee)),
                                    h('td', { style: { fontSize: 13 } }, assignee ? `${assignee.first_name || ''} ${assignee.last_name || ''}`.trim() : '-'),
                                    h('td', null, h('span', { className: `badge badge-${badgeClass}` }, task.status || 'En attente'))
                                );
                            }))
                        ) : h('div', { className: 'empty-state' }, h('p', { className: 'empty-desc' }, 'Aucun travail'))
                    )
                ),
                h('div', { className: 'card' },
                    h('div', { className: 'card-header' },
                        h('h3', { className: 'card-title' }, h(Icon, { name: 'alert', size: 18 }), 'Pièces en alerte')
                    ),
                    h('div', { className: 'card-body no-padding' },
                        (() => {
                            const lowStockParts = data.parts.filter(p => p.quantity <= (p.min_stock || 0)).slice(0, 5);
                            return lowStockParts.length > 0 ? h('table', null,
                                h('thead', null, h('tr', null, h('th', null, 'Réf.'), h('th', null, 'Désignation'), h('th', null, 'Stock'), h('th', null, 'Min'))),
                                h('tbody', null, lowStockParts.map(part => 
                                    h('tr', { key: part.id },
                                        h('td', null, h('code', { style: { fontSize: 12 } }, part.ref)),
                                        h('td', { style: { fontSize: 13 } }, part.name?.substring(0, 30) || '-'),
                                        h('td', null, h('span', { className: 'badge badge-danger' }, part.quantity || 0)),
                                        h('td', { style: { fontSize: 13, color: 'var(--muted)' } }, part.min_stock || 0)
                                    )
                                ))
                            ) : h('div', { className: 'empty-state', style: { padding: 40 } },
                                h('div', { style: { fontSize: 48, marginBottom: 12 } }, '✅'),
                                h('p', { className: 'empty-desc' }, 'Aucune alerte de stock')
                            );
                        })()
                    )
                )
            ),
            
            // Section Widgets personnalisés
            h('div', { className: 'card', style: { marginTop: 20 } },
                h('div', { className: 'card-header' },
                    h('h3', { className: 'card-title' }, '📊 Widgets personnalisés'),
                    h('div', { style: { display: 'flex', gap: 8, marginLeft: 'auto' } },
                        h('button', { 
                            className: 'btn btn-primary btn-sm',
                            onClick: () => window.dispatchEvent(new CustomEvent('open-widget-picker'))
                        }, '+ Ajouter'),
                        widgetLayout.length > 0 && h('button', { 
                            className: 'btn btn-ghost btn-sm',
                            onClick: () => {
                                if (confirm('Réinitialiser tous les widgets ?')) {
                                    WidgetSystem.resetLayout();
                                    window.dispatchEvent(new CustomEvent('widget-layout-changed'));
                                    showToast('Widgets réinitialisés', 'success');
                                }
                            }
                        }, '↺ Réinitialiser')
                    )
                ),
                h('div', { className: 'card-body' },
                    widgetLayout.length === 0 
                        ? h('div', { style: { textAlign: 'center', padding: 40, color: 'var(--muted)' } },
                            h('div', { style: { fontSize: 48, marginBottom: 16 } }, '📊'),
                            h('p', { style: { marginBottom: 16 } }, 'Personnalisez votre tableau de bord en ajoutant des widgets'),
                            h('button', { 
                                className: 'btn btn-primary',
                                onClick: () => window.dispatchEvent(new CustomEvent('open-widget-picker'))
                            }, '+ Ajouter mon premier widget')
                        )
                        : h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 16 } },
                            widgetLayout.map(widget => {
                                const widgetInfo = WidgetSystem.availableWidgets.find(w => w.id === widget.id) || {};
                                return h('div', { 
                                    key: widget.id,
                                    className: 'widget-card',
                                    style: { 
                                        padding: 16, 
                                        background: 'var(--background)', 
                                        borderRadius: 12,
                                        border: '1px solid var(--border)'
                                    }
                                },
                                    h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 12 } },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                            h('span', { style: { fontSize: 20 } }, widgetInfo.icon || '📊'),
                                            h('span', { style: { fontWeight: 600 } }, widgetInfo.name || widget.id)
                                        ),
                                        h('button', {
                                            className: 'btn btn-ghost btn-sm',
                                            onClick: () => {
                                                const newLayout = widgetLayout.filter(w => w.id !== widget.id);
                                                WidgetSystem.saveLayout(newLayout);
                                                window.dispatchEvent(new CustomEvent('widget-layout-changed'));
                                                showToast('Widget supprimé', 'success');
                                            },
                                            title: 'Supprimer ce widget'
                                        }, '✕')
                                    ),
                                    h('div', { style: { color: 'var(--muted)', fontSize: 13 } },
                                        widgetInfo.category === 'kpi' ? 
                                            h('div', { style: { fontSize: 32, fontWeight: 700, color: 'var(--primary)' } }, 
                                                widget.id === 'kpi-stock' ? totalStock :
                                                widget.id === 'kpi-tasks' ? pendingTasks :
                                                widget.id === 'kpi-orders' ? pendingOrders :
                                                widget.id === 'kpi-team' ? (data.users || []).length :
                                                '-'
                                            ) :
                                        widgetInfo.category === 'list' ?
                                            h('div', { style: { maxHeight: 150, overflow: 'auto' } },
                                                widget.id === 'list-low-stock' ? 
                                                    (data.parts.filter(p => p.quantity <= (p.min_stock || 0)).slice(0, 5).map(p => 
                                                        h('div', { key: p.id, style: { padding: '4px 0', borderBottom: '1px solid var(--border)', fontSize: 12 } },
                                                            h('span', { style: { fontWeight: 500 } }, p.name?.substring(0, 25) || p.ref),
                                                            h('span', { style: { float: 'right', color: '#EF4444' } }, p.quantity)
                                                        )
                                                    )) :
                                                widget.id === 'list-recent-tasks' ?
                                                    (data.tasks.slice(0, 5).map(t => 
                                                        h('div', { key: t.id, style: { padding: '4px 0', borderBottom: '1px solid var(--border)', fontSize: 12 } },
                                                            h('span', null, t.device_number || 'Tâche'),
                                                            h('span', { style: { float: 'right', color: 'var(--muted)' } }, t.status)
                                                        )
                                                    )) :
                                                widget.id === 'list-pending-orders' ?
                                                    (data.orders.filter(o => o.status === 'en-commande').slice(0, 5).map(o => 
                                                        h('div', { key: o.id, style: { padding: '4px 0', borderBottom: '1px solid var(--border)', fontSize: 12 } },
                                                            h('span', null, o.name?.substring(0, 25) || 'Commande'),
                                                            h('span', { style: { float: 'right' } }, o.quantity || '-')
                                                        )
                                                    )) :
                                                h('p', null, 'Aucune donnée')
                                            ) :
                                        widgetInfo.category === 'utility' && widget.id === 'weather' ?
                                            h('div', { style: { textAlign: 'center' } },
                                                h('div', { style: { fontSize: 32 } }, '☀️'),
                                                h('div', null, 'Météo locale')
                                            ) :
                                        widgetInfo.category === 'utility' && widget.id === 'clock' ?
                                            h('div', { style: { textAlign: 'center', fontSize: 24, fontWeight: 600 } },
                                                new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
                                            ) :
                                        widgetInfo.category === 'utility' && widget.id === 'quick-actions' ?
                                            h('div', { style: { display: 'flex', flexWrap: 'wrap', gap: 8 } },
                                                h('button', { className: 'btn btn-sm btn-ghost', onClick: () => window.location.hash = '#stock' }, '📦 Stock'),
                                                h('button', { className: 'btn btn-sm btn-ghost', onClick: () => window.location.hash = '#tasks' }, '📋 Tâches'),
                                                h('button', { className: 'btn btn-sm btn-ghost', onClick: () => window.location.hash = '#orders' }, '🛒 Commandes')
                                            ) :
                                        widgetInfo.category === 'team' && widget.id === 'team-presence' ?
                                            h('div', null,
                                                (data.users || []).slice(0, 5).map(u => 
                                                    h('div', { key: u.id, style: { display: 'flex', alignItems: 'center', gap: 8, padding: '4px 0' } },
                                                        h('span', { style: { width: 8, height: 8, borderRadius: '50%', background: '#22C55E' } }),
                                                        h('span', { style: { fontSize: 12 } }, u.first_name || u.email)
                                                    )
                                                )
                                            ) :
                                        widgetInfo.category === 'fleet' && widget.id === 'vehicle-status' ?
                                            h('div', null,
                                                h('div', { style: { fontSize: 24, fontWeight: 600, marginBottom: 8 } }, 
                                                    (data.vehicles || []).length, ' véhicules'
                                                )
                                            ) :
                                        h('p', null, widgetInfo.description || `Widget ${widget.id}`)
                                    )
                                );
                            })
                        )
                )
            )
        ),
        
        // Modal Email Digest v5.6
        showDigestModal && h(Modal, { isOpen: true, onClose: () => setShowDigestModal(false), title: '📧 Préférences Email Digest', size: 'md' },
            h('div', null,
                h('p', { style: { marginBottom: 20, color: COLORS.muted } }, 
                    'Recevez un récapitulatif automatique de votre activité par email.'
                ),
                h('div', { className: 'form-group' },
                    h('label', { style: { display: 'flex', alignItems: 'center', gap: 12, cursor: 'pointer' } },
                        h('input', { type: 'checkbox', checked: digestPrefs.daily_digest, onChange: e => setDigestPrefs({...digestPrefs, daily_digest: e.target.checked}) }),
                        h('span', null, 'Digest quotidien'),
                        digestPrefs.daily_digest && h('input', { type: 'time', className: 'form-input', style: { width: 120, marginLeft: 12 }, value: digestPrefs.daily_digest_time || '08:00', onChange: e => setDigestPrefs({...digestPrefs, daily_digest_time: e.target.value}) })
                    )
                ),
                h('div', { className: 'form-group' },
                    h('label', { style: { display: 'flex', alignItems: 'center', gap: 12, cursor: 'pointer' } },
                        h('input', { type: 'checkbox', checked: digestPrefs.weekly_digest, onChange: e => setDigestPrefs({...digestPrefs, weekly_digest: e.target.checked}) }),
                        h('span', null, 'Digest hebdomadaire'),
                        digestPrefs.weekly_digest && h('select', { className: 'form-select', style: { width: 130, marginLeft: 12 }, value: digestPrefs.weekly_digest_day, onChange: e => setDigestPrefs({...digestPrefs, weekly_digest_day: parseInt(e.target.value)}) },
                            h('option', { value: 1 }, 'Lundi'),
                            h('option', { value: 2 }, 'Mardi'),
                            h('option', { value: 3 }, 'Mercredi'),
                            h('option', { value: 4 }, 'Jeudi'),
                            h('option', { value: 5 }, 'Vendredi')
                        )
                    )
                ),
                h('hr', { style: { margin: '20px 0' } }),
                h('h4', { style: { marginBottom: 12 } }, 'Contenu du digest'),
                h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                    h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                        h('input', { type: 'checkbox', checked: digestPrefs.include_tasks, onChange: e => setDigestPrefs({...digestPrefs, include_tasks: e.target.checked}) }),
                        '📋 Résumé des tâches'
                    ),
                    h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                        h('input', { type: 'checkbox', checked: digestPrefs.include_stock, onChange: e => setDigestPrefs({...digestPrefs, include_stock: e.target.checked}) }),
                        '📦 Alertes stock'
                    ),
                    h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                        h('input', { type: 'checkbox', checked: digestPrefs.include_stats, onChange: e => setDigestPrefs({...digestPrefs, include_stats: e.target.checked}) }),
                        '📊 Statistiques clés'
                    )
                ),
                h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end', marginTop: 24 } },
                    h('button', { className: 'btn btn-secondary', onClick: () => setShowDigestModal(false) }, 'Annuler'),
                    h('button', { className: 'btn btn-primary', onClick: saveDigestPrefs }, 'Enregistrer')
                )
            )
        ),
        
        // Modal Règles de notification v5.6
        showRulesModal && h(Modal, { isOpen: true, onClose: () => setShowRulesModal(false), title: '🔔 Règles de notification', size: 'lg' },
            h('div', null,
                h('p', { style: { marginBottom: 20, color: COLORS.muted } }, 
                    'Configurez les alertes automatiques pour être notifié des événements importants.'
                ),
                h('div', { style: { display: 'flex', flexDirection: 'column', gap: 12 } },
                    notificationRules.map(rule => h('div', { key: rule.id, style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: 16, background: COLORS.background, borderRadius: 8 } },
                        h('div', null,
                            h('div', { style: { fontWeight: 600, marginBottom: 4 } }, rule.name),
                            h('div', { style: { fontSize: 12, color: COLORS.muted } }, 
                                'Déclencheur: ', rule.trigger_event, ' • ',
                                'Canaux: ', Array.isArray(rule.channels) ? rule.channels.join(', ') : rule.channels
                            )
                        ),
                        h('div', { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                            h('span', { className: `badge badge-${rule.is_active ? 'success' : 'secondary'}` }, rule.is_active ? 'Actif' : 'Inactif'),
                            h('button', { className: 'btn btn-sm btn-ghost', onClick: async () => {
                                await db.from('notification_rules').update({ is_active: !rule.is_active }).eq('id', rule.id);
                                setNotificationRules(notificationRules.map(r => r.id === rule.id ? {...r, is_active: !r.is_active} : r));
                            } }, rule.is_active ? '⏸️' : '▶️')
                        )
                    )),
                    notificationRules.length === 0 && h('p', { style: { textAlign: 'center', padding: 20, color: COLORS.muted } }, 'Aucune règle configurée')
                ),
                h('hr', { style: { margin: '20px 0' } }),
                h('h4', { style: { marginBottom: 12 } }, 'Règles prédéfinies disponibles'),
                h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12 } },
                    h('div', { style: { padding: 12, border: '1px dashed ' + COLORS.border, borderRadius: 8 } },
                        h('div', { style: { fontWeight: 600, marginBottom: 4 } }, '📦 Stock critique'),
                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Alerte quand une pièce passe sous le seuil minimum')
                    ),
                    h('div', { style: { padding: 12, border: '1px dashed ' + COLORS.border, borderRadius: 8 } },
                        h('div', { style: { fontWeight: 600, marginBottom: 4 } }, '⏰ Tâche en retard'),
                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Alerte si une tâche dépasse sa date prévue')
                    ),
                    h('div', { style: { padding: 12, border: '1px dashed ' + COLORS.border, borderRadius: 8 } },
                        h('div', { style: { fontWeight: 600, marginBottom: 4 } }, '🚗 CT véhicule'),
                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Rappel 30 jours avant expiration du CT')
                    ),
                    h('div', { style: { padding: 12, border: '1px dashed ' + COLORS.border, borderRadius: 8 } },
                        h('div', { style: { fontWeight: 600, marginBottom: 4 } }, '🛡️ Assurance'),
                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Rappel avant expiration assurance')
                    )
                ),
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', marginTop: 20 } },
                    h('button', { className: 'btn btn-secondary', onClick: () => setShowRulesModal(false) }, 'Fermer')
                )
            )
        )
    );
};


// ==========================================
// STOCK PAGE
// ==========================================
const StockPage = ({ data, user, refresh, showToast }) => {
    const [search, setSearch] = useState('');
    const [categoryFilter, setCategoryFilter] = useState('all');
    const [viewMode, setViewMode] = useState('list');
    const [columnFilters, setColumnFilters] = useState({});
    const [showAdd, setShowAdd] = useState(false);
    const [editPart, setEditPart] = useState(null);
    const [viewPart, setViewPart] = useState(null);
    const [showBarcode, setShowBarcode] = useState(null);
    const [showAdjust, setShowAdjust] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [showScanner, setShowScanner] = useState(false);
    const [showHistory, setShowHistory] = useState(null);
    const [movements, setMovements] = useState([]);
    const [cart, setCart] = useState([]);
    const [showCart, setShowCart] = useState(false);
    const [showRequests, setShowRequests] = useState(false);
    const [showGlobalHistory, setShowGlobalHistory] = useState(false);
    const [showAddRequest, setShowAddRequest] = useState(null);
    const [showCategories, setShowCategories] = useState(false);
    const [editCategory, setEditCategory] = useState(null);
    const [newCategoryName, setNewCategoryName] = useState('');
    const [orderPreview, setOrderPreview] = useState(null); // { name, items, notes, onConfirm }
    // Module Étiquettes
    const [showLabels, setShowLabels] = useState(false);
    const [labelSelection, setLabelSelection] = useState({}); // { partId: quantity }
    const [labelFormat, setLabelFormat] = useState('medium'); // small, medium, large
    const [labelContent, setLabelContent] = useState({ ref: true, name: true, category: false, location: false });
    
    // v5.8 - États HMI avancé
    const [selectedParts, setSelectedParts] = useState([]);
    const [contextMenu, setContextMenu] = useState({ show: false, x: 0, y: 0, part: null });
    const [currentViewMode, setCurrentViewMode] = useState('table'); // table, grid, timeline
    
    // === NOUVEAUTÉS v5.6 : Inventaire NFC ===
    const [showInventoryModal, setShowInventoryModal] = useState(false);
    const [inventoryMode, setInventoryMode] = useState(false);
    const [inventoryItems, setInventoryItems] = useState([]);
    const [nfcSupported, setNfcSupported] = useState(false);
    
    // Vérifier support NFC
    useEffect(() => {
        if ('NDEFReader' in window) {
            setNfcSupported(true);
        }
    }, []);
    
    // Scanner NFC pour inventaire
    const startNFCInventory = async () => {
        if (!nfcSupported) {
            showToast('NFC non supporté sur cet appareil', 'error');
            return;
        }
        
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            showToast('Mode scan NFC activé', 'success');
            setInventoryMode(true);
            
            ndef.addEventListener('reading', ({ message, serialNumber }) => {
                // Chercher l'article par référence NFC
                const textRecord = message.records.find(r => r.recordType === 'text');
                if (textRecord) {
                    const decoder = new TextDecoder();
                    const refOrId = decoder.decode(textRecord.data);
                    const part = data.parts.find(p => p.ref === refOrId || p.id === refOrId || p.nfc_tag === serialNumber);
                    
                    if (part) {
                        // Ajouter à l'inventaire
                        setInventoryItems(prev => {
                            const existing = prev.find(i => i.partId === part.id);
                            if (existing) {
                                return prev.map(i => i.partId === part.id ? { ...i, scanned: i.scanned + 1 } : i);
                            }
                            return [...prev, { partId: part.id, part, expected: part.quantity, scanned: 1 }];
                        });
                        showToast(`${part.ref} scanné!`, 'success');
                    } else {
                        showToast('Article non reconnu', 'warning');
                    }
                }
            });
        } catch (err) {
            showToast('Erreur NFC: ' + err.message, 'error');
        }
    };
    
    // Terminer l'inventaire
    const finishInventory = async () => {
        for (const item of inventoryItems) {
            if (item.scanned !== item.expected) {
                // Créer mouvement d'ajustement
                const diff = item.scanned - item.expected;
                await db.from('stock_movements').insert({
                    part_id: item.partId,
                    type: diff > 0 ? 'entree' : 'sortie',
                    quantity: Math.abs(diff),
                    reason: 'inventaire',
                    user_id: user.id,
                    notes: `Inventaire NFC: attendu ${item.expected}, compté ${item.scanned}`
                });
                
                // Mettre à jour le stock
                await db.from('parts').update({ quantity: item.scanned }).eq('id', item.partId);
            }
        }
        
        showToast(`Inventaire terminé: ${inventoryItems.length} articles vérifiés`, 'success');
        setInventoryMode(false);
        setInventoryItems([]);
        refresh();
    };
    
    // Colonnes redimensionnables
    const stockColumns = useMemo(() => [
        { key: 'ref', label: 'Référence', width: 120 },
        { key: 'name', label: 'Désignation', width: 200 },
        { key: 'category', label: 'Catégorie', width: 130 },
        { key: 'quantity', label: 'Stock', width: 100 },
        { key: 'min_stock', label: 'Min', width: 80 },
        { key: 'actions', label: 'Actions', width: 180 }
    ], []);
    
    const { columns: resizableCols, getColumnProps, resetColumns } = useResizableColumns('stock-table', stockColumns);
    
    const userPerms = getUserPermissions(user);
    const canEdit = userPerms.stock_write === true;
    const canViewHistory = userPerms.stock_write === true;
    const canRequest = user.role === 'technicien'; // Les techniciens peuvent faire des demandes
    const canAdjustStock = user.role === 'admin' || user.role === 'technicien'; // Les techniciens peuvent ajuster le stock
    const isAdmin = user.role === 'admin';
    const categories = [...new Set(data.parts.map(p => p.category).filter(Boolean))];
    
    const filteredParts = data.parts.filter(p => {
        const matchSearch = !search || p.name?.toLowerCase().includes(search.toLowerCase()) || p.ref?.toLowerCase().includes(search.toLowerCase());
        const matchCategory = categoryFilter === 'all' || p.category === categoryFilter;
        // Filtres de colonnes
        if (columnFilters.ref && !p.ref?.toLowerCase().includes(columnFilters.ref.toLowerCase())) return false;
        if (columnFilters.name && !p.name?.toLowerCase().includes(columnFilters.name.toLowerCase())) return false;
        if (columnFilters.category && p.category !== columnFilters.category) return false;
        if (columnFilters.stock_status) {
            const isLow = p.quantity <= (p.min_stock || 0);
            if (columnFilters.stock_status === 'low' && !isLow) return false;
            if (columnFilters.stock_status === 'ok' && isLow) return false;
        }
        return matchSearch && matchCategory;
    });
    
    // Multi-sélection v5.3 (après filteredParts)
    const multiSelect = typeof window.StockAppV53 !== 'undefined' 
        ? window.StockAppV53.useMultiSelect(filteredParts, 'id')
        : { selectedIds: new Set(), selectedItems: [], selectedCount: 0, toggleSelect: () => {}, selectAll: () => {}, clearSelection: () => {}, isSelected: () => false };
    
    const lowStockCount = data.parts.filter(p => p.quantity <= (p.min_stock || 0)).length;
    const cartTotal = cart.reduce((sum, item) => sum + item.quantity, 0);
    const pendingRequestsCount = (data.partRequests || []).filter(r => r.status === 'pending').length;
    
    // Créer une demande de pièce
    const createPartRequest = async (part, quantity, reason) => {
        try {
            const existingRequest = (data.partRequests || []).find(r => r.part_ref === part.ref && r.status === 'pending');
            if (existingRequest) {
                showToast('Une demande existe déjà pour cette pièce', 'warning');
                return;
            }
            await db.from('wishlist').insert({
                part_ref: part.ref,
                part_name: part.name,
                quantity: quantity || 1,
                reason: reason || '',
                requested_by: ((user.first_name || '') + ' ' + (user.last_name || '')).trim() || user.email,
                user_id: user.id
            });
            
            // Notifier tous les admins
            const admins = (data.users || []).filter(u => u.role === 'admin' && u.id !== user.id);
            const userName = ((user.first_name || '') + ' ' + (user.last_name || '')).trim() || user.email;
            for (const admin of admins) {
                await createNotification({
                    userId: admin.id,
                    type: 'part_request',
                    title: 'Nouvelle demande de pièce',
                    body: `${userName} demande ${quantity || 1}x ${part.name || part.ref}`,
                    actionUrl: '/stock'
                });
            }
            
            showToast('Demande créée');
            refresh();
        } catch (err) {
            showToast(err.message, 'error');
        }
    };
    
    // Approuver/Rejeter une demande
    const updateRequestStatus = async (requestId, status) => {
        try {
            const request = (data.partRequests || []).find(r => r.id === requestId);
            await db.from('wishlist').update({ status }).eq('id', requestId);
            
            // Notifier l'utilisateur qui a fait la demande
            if (request && request.user_id && request.user_id !== user.id) {
                await createNotification({
                    userId: request.user_id,
                    type: status === 'approved' ? 'part_request_validated' : 'part_request_rejected',
                    title: status === 'approved' ? 'Demande approuvée ✅' : 'Demande refusée ❌',
                    body: `Votre demande pour ${request.part_name || request.part_ref} a été ${status === 'approved' ? 'approuvée' : 'refusée'}`,
                    actionUrl: '/stock'
                });
            }
            
            showToast(status === 'approved' ? 'Demande approuvée' : 'Demande rejetée');
            refresh();
        } catch (err) {
            showToast(err.message, 'error');
        }
    };
    
    // Supprimer une demande
    const deleteRequest = async (requestId) => {
        try {
            await db.from('wishlist').delete().eq('id', requestId);
            showToast('Demande supprimée');
            refresh();
        } catch (err) {
            showToast(err.message, 'error');
        }
    };
    
    // Vérifier si une demande existe pour cette pièce
    const hasRequest = (partRef) => (data.partRequests || []).some(r => r.part_ref === partRef && r.status === 'pending');
    
    // Charger l'historique d'une pièce
    const loadHistory = async (part) => {
        try {
            console.log('Loading history for part:', part.id, part.ref);
            const { data: mvts, error } = await db.from('stock_withdrawals').select('*').eq('part_id', part.id).order('withdrawn_at', { ascending: false }).limit(500);
            console.log('History result:', mvts, 'Error:', error);
            setMovements(mvts || []);
            setShowHistory(part);
        } catch (err) { 
            console.error('History load error:', err);
            setMovements([]); 
            setShowHistory(part); 
        }
    };
    
    // Export PDF
    const exportPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // En-tête avec logo
        let y = drawPDFHeader(doc, 'INVENTAIRE STOCK', 'Généré le ' + new Date().toLocaleDateString('fr-FR') + ' à ' + new Date().toLocaleTimeString('fr-FR'));
        
        // Stats
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(11);
        doc.text(`Total: ${data.parts.length} pièces | En alerte: ${lowStockCount} | Catégories: ${categories.length}`, 14, y);
        y += 10;
        
        // Tableau
        const headers = ['Référence', 'Désignation', 'Catégorie', 'Stock', 'Min'];
        const colWidths = [35, 70, 40, 20, 20];
        let x = 14;
        
        // En-tête tableau
        doc.setFillColor(240, 240, 240);
        doc.rect(14, y, 185, 8, 'F');
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        headers.forEach((h, i) => {
            doc.text(h, x + 2, y + 6);
            x += colWidths[i];
        });
        y += 10;
        doc.setFont(undefined, 'normal');
        
        // Lignes
        const partsToExport = categoryFilter === 'all' ? data.parts : data.parts.filter(p => p.category === categoryFilter);
        partsToExport.forEach((part, idx) => {
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
            
            const isLow = part.quantity <= (part.min_stock || 0);
            if (isLow) {
                doc.setFillColor(254, 226, 226);
                doc.rect(14, y - 4, 185, 7, 'F');
            }
            
            x = 14;
            doc.setFontSize(8);
            doc.text((part.ref || '').substring(0, 20), x + 2, y);
            x += colWidths[0];
            doc.text((part.name || '').substring(0, 40), x + 2, y);
            x += colWidths[1];
            doc.text((part.category || '-').substring(0, 20), x + 2, y);
            x += colWidths[2];
            doc.text(String(part.quantity || 0), x + 2, y);
            x += colWidths[3];
            doc.text(String(part.min_stock || 0), x + 2, y);
            
            y += 7;
        });
        
        // Pied de page
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text('StockApp - Inventaire généré automatiquement', 14, 290);
        
        doc.save('inventaire-stock-' + new Date().toISOString().split('T')[0] + '.pdf');
        showToast('PDF exporté');
    };
    
    // Gestion catégories
    const updateCategory = async (oldName, newName) => {
        if (!newName.trim()) return;
        try {
            await db.from('parts').update({ category: newName.trim() }).eq('category', oldName);
            showToast('Catégorie renommée');
            setEditCategory(null);
            refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const deleteCategory = async (catName) => {
        try {
            await db.from('parts').update({ category: null }).eq('category', catName);
            showToast('Catégorie supprimée');
            refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const addCategory = async () => {
        if (!newCategoryName.trim()) return;
        if (categories.includes(newCategoryName.trim())) {
            showToast('Cette catégorie existe déjà', 'warning');
            return;
        }
        // On ne peut pas créer une catégorie vide, on informe l'utilisateur
        showToast('Créez une pièce avec cette catégorie');
        setNewCategoryName('');
    };
    
    const handleSavePart = async (formData) => {
        try {
            if (editPart) { await db.from('parts').update(formData).eq('id', editPart.id); showToast('Pièce modifiée'); }
            else { await db.from('parts').insert(formData); showToast('Pièce ajoutée'); }
            setShowAdd(false); setEditPart(null); refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const handleDelete = async (part) => {
        try { await db.from('parts').delete().eq('id', part.id); showToast('Pièce supprimée'); setDeleteConfirm(null); refresh(); } catch (err) { showToast(err.message, 'error'); }
    };
    
    const handleAdjustStock = async (partId, adjustment, reason) => {
        try {
            const part = data.parts.find(p => p.id === partId);
            const newQty = Math.max(0, part.quantity + adjustment);
            await db.from('parts').update({ quantity: newQty }).eq('id', partId);
            // Enregistrer le mouvement dans stock_withdrawals (entrées et sorties)
            const isEntry = adjustment > 0;
            const userName = ((user.first_name || '') + ' ' + (user.last_name || '')).trim() || user.email;
            const movementData = { 
                part_id: partId, 
                part_ref: part.ref,
                part_name: part.name,
                quantity: isEntry ? adjustment : Math.abs(adjustment), 
                reason: reason || (isEntry ? 'Entrée stock' : 'Sortie stock'),
                withdrawn_by: userName,
                user_id: user.id,
                withdrawn_at: new Date().toISOString(),
                type: isEntry ? 'entree' : 'sortie'
            };
            console.log('Inserting movement:', movementData);
            const { error } = await db.from('stock_withdrawals').insert(movementData);
            if (error) {
                console.error('Error inserting movement:', error);
                showToast('Erreur enregistrement historique: ' + error.message, 'warning');
            }
            
            // Notifier les admins des mouvements de stock importants
            const admins = (data.users || []).filter(u => u.role === 'admin' && u.id !== user.id);
            const absQty = Math.abs(adjustment);
            for (const admin of admins) {
                await createNotification({
                    userId: admin.id,
                    type: isEntry ? 'stock_withdrawal' : 'stock_alert',
                    title: isEntry ? `📥 Entrée stock` : `📤 Sortie stock`,
                    body: `${userName}: ${isEntry ? '+' : '-'}${absQty} ${part.name || part.ref}${reason ? ` (${reason})` : ''}`,
                    actionUrl: '/stock'
                });
            }
            
            // Si le stock passe en dessous du minimum, notifier TOUS les utilisateurs
            const minStock = part.min_stock || 0;
            if (newQty <= minStock && part.quantity > minStock) {
                // Le stock vient de passer sous le minimum
                const allUsers = (data.users || []).filter(u => u.id !== user.id);
                for (const targetUser of allUsers) {
                    await createNotification({
                        userId: targetUser.id,
                        type: 'stock_alert',
                        title: '⚠️ Stock critique',
                        body: `${part.name || part.ref} est passé sous le stock minimum (${newQty}/${minStock})`,
                        actionUrl: '/stock'
                    });
                }
            }
            
            showToast(`Stock ajusté: ${adjustment > 0 ? '+' : ''}${adjustment}`);
            setShowAdjust(null); refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    // Panier
    const addToCart = (part, qty = 1) => {
        const existing = cart.find(c => c.part.id === part.id);
        if (existing) { setCart(cart.map(c => c.part.id === part.id ? {...c, quantity: c.quantity + qty} : c)); }
        else { setCart([...cart, { part, quantity: qty }]); }
        showToast(`${part.ref} ajouté au panier`);
    };
    
    const updateCartQty = (partId, qty) => {
        if (qty <= 0) { setCart(cart.filter(c => c.part.id !== partId)); }
        else { setCart(cart.map(c => c.part.id === partId ? {...c, quantity: qty} : c)); }
    };
    
    const removeFromCart = (partId) => setCart(cart.filter(c => c.part.id !== partId));
    const clearCart = () => setCart([]);
    
    const createOrderFromCart = async () => {
        if (cart.length === 0) return;
        const items = cart.map(c => ({ part_id: c.part.id, part_ref: c.part.ref, part_name: c.part.name, quantity: c.quantity }));
        setOrderPreview({
            name: `Commande du ${new Date().toLocaleDateString('fr-FR')}`,
            items: items,
            onConfirm: async (finalOrder) => {
                try {
                    const orderData = {
                        name: finalOrder.name,
                        items: JSON.stringify(finalOrder.items),
                        status: 'en-commande'
                    };
                    const { error } = await db.from('orders').insert(orderData);
                    if (error) throw error;
                    showToast('Commande créée avec succès');
                    setCart([]); setShowCart(false); setOrderPreview(null); refresh();
                } catch (err) { 
                    console.error('Erreur création commande:', err);
                    showToast('Erreur: ' + (err.message || JSON.stringify(err)), 'error'); 
                }
            }
        });
    };
    
    // Modal de prévisualisation de commande
    const OrderPreviewModal = ({ preview, onClose }) => {
        const [name, setName] = useState(preview.name);
        const [items, setItems] = useState(preview.items);
        
        const updateItemQty = (idx, qty) => {
            if (qty <= 0) {
                setItems(items.filter((_, i) => i !== idx));
            } else {
                const newItems = [...items];
                newItems[idx] = { ...newItems[idx], quantity: qty };
                setItems(newItems);
            }
        };
        
        const removeItem = (idx) => setItems(items.filter((_, i) => i !== idx));
        
        const totalQty = items.reduce((sum, i) => sum + i.quantity, 0);
        
        const handleConfirm = () => {
            if (items.length === 0) {
                showToast('Ajoutez au moins une pièce', 'error');
                return;
            }
            preview.onConfirm({ name, items });
        };
        
        return h(Modal, { isOpen: true, onClose, title: '📦 Nouvelle commande', size: 'lg',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Annuler'),
                h('button', { className: 'btn btn-primary', onClick: handleConfirm, disabled: items.length === 0 }, h(Icon, { name: 'cart', size: 16 }), 'Créer la commande')
            )
        },
            // Nom de la commande
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Nom de la commande'),
                h('input', { className: 'form-input', value: name, onChange: e => setName(e.target.value), placeholder: 'Ex: Commande pièces moteur' })
            ),
            // Liste des pièces
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, `Pièces à commander (${items.length})`),
                h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8, maxHeight: 300, overflowY: 'auto' } },
                    items.length === 0 ? h('div', { style: { padding: 20, textAlign: 'center', color: COLORS.muted, background: COLORS.background, borderRadius: 8 } }, 'Aucune pièce') :
                    items.map((item, idx) => h('div', { key: idx, style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: COLORS.background, borderRadius: 8, border: '1px solid ' + COLORS.border } },
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { fontWeight: 600, fontFamily: 'monospace' } }, item.part_ref),
                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, item.part_name)
                        ),
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                            h('button', { className: 'btn btn-ghost btn-sm', onClick: () => updateItemQty(idx, item.quantity - 1) }, '-'),
                            h('input', { 
                                type: 'number', 
                                value: item.quantity, 
                                onChange: e => updateItemQty(idx, parseInt(e.target.value) || 0),
                                min: 1,
                                style: { width: 60, padding: '6px', borderRadius: 6, border: '1px solid ' + COLORS.border, textAlign: 'center', fontWeight: 600 }
                            }),
                            h('button', { className: 'btn btn-ghost btn-sm', onClick: () => updateItemQty(idx, item.quantity + 1) }, '+'),
                            h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => removeItem(idx), style: { color: COLORS.danger, marginLeft: 8 } }, h(Icon, { name: 'trash', size: 16 }))
                        )
                    ))
                )
            ),
            // Info statut
            h('div', { style: { padding: 12, background: '#FEF3C7', borderRadius: 8, fontSize: 13, color: '#92400E', marginBottom: 16 } },
                '📋 Statut par défaut: En commande'
            ),
            // Résumé
            h('div', { style: { padding: 16, background: '#DBEAFE', borderRadius: 8, display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                h('span', { style: { fontWeight: 600 } }, 'Total articles:'),
                h('span', { style: { fontWeight: 700, fontSize: 18, color: COLORS.primary } }, totalQty)
            )
        );
    };
    
    // Scanner
    const ScannerModal = () => {
        const scannerRef = useRef(null);
        const html5QrCodeRef = useRef(null);
        
        useEffect(() => {
            if (scannerRef.current && !html5QrCodeRef.current) {
                html5QrCodeRef.current = new Html5Qrcode("scanner-reader");
                html5QrCodeRef.current.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 100 } },
                    (decodedText) => {
                        const foundPart = data.parts.find(p => p.ref === decodedText || p.ref?.toLowerCase() === decodedText.toLowerCase());
                        if (foundPart) { setSearch(foundPart.ref); showToast(`Trouvé: ${foundPart.name}`); }
                        else { setSearch(decodedText); showToast('Code scanné: ' + decodedText, 'warning'); }
                        html5QrCodeRef.current.stop().then(() => { setShowScanner(false); });
                    },
                    () => {}
                ).catch(err => showToast('Erreur caméra: ' + err, 'error'));
            }
            return () => { if (html5QrCodeRef.current) { html5QrCodeRef.current.stop().catch(() => {}); } };
        }, []);
        
        return h(Modal, { isOpen: true, onClose: () => { if (html5QrCodeRef.current) html5QrCodeRef.current.stop().catch(() => {}); setShowScanner(false); }, title: 'Scanner un code-barres', size: 'md' },
            h('div', { id: 'scanner-reader', ref: scannerRef, style: { width: '100%' } }),
            h('p', { style: { textAlign: 'center', marginTop: 16, color: COLORS.muted, fontSize: 13 } }, 'Placez le code-barres devant la caméra')
        );
    };
    
    // Cart Modal
    // Part Requests Modal (remplace Wishlist)
    const PartRequestsModal = () => {
        const requests = data.partRequests || [];
        const pendingRequests = requests.filter(r => r.status === 'pending');
        const processedRequests = requests.filter(r => r.status !== 'pending');
        const [viewTab, setViewTab] = useState('pending');
        const displayRequests = viewTab === 'pending' ? pendingRequests : processedRequests;
        
        return h(Modal, { isOpen: true, onClose: () => setShowRequests(false), title: `Demandes de pièces (${pendingRequests.length} en attente)`, size: 'lg' },
            h('div', { style: { display: 'flex', gap: 4, background: COLORS.background, borderRadius: 8, padding: 4, marginBottom: 16 } },
                h('button', { className: `btn btn-sm ${viewTab === 'pending' ? 'btn-primary' : 'btn-ghost'}`, onClick: () => setViewTab('pending'), style: { flex: 1 } }, `En attente (${pendingRequests.length})`),
                h('button', { className: `btn btn-sm ${viewTab === 'processed' ? 'btn-primary' : 'btn-ghost'}`, onClick: () => setViewTab('processed'), style: { flex: 1 } }, `Traitées (${processedRequests.length})`)
            ),
            displayRequests.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 
                viewTab === 'pending' ? 'Aucune demande en attente' : 'Aucune demande traitée',
                viewTab === 'pending' && h('p', { style: { fontSize: 13, marginTop: 8 } }, 'Cliquez sur 📋 sur une pièce pour créer une demande')
            ) :
            h('div', null,
                displayRequests.map(req => {
                    const part = data.parts.find(p => p.ref === req.part_ref);
                    return h('div', { key: req.id, style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 12, borderBottom: `1px solid ${COLORS.border}` } },
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                h('span', { style: { fontWeight: 600, color: COLORS.primary } }, req.part_ref),
                                h('span', { className: `badge badge-${req.status === 'approved' ? 'success' : req.status === 'rejected' ? 'danger' : 'warning'}` }, 
                                    req.status === 'approved' ? 'Approuvée' : req.status === 'rejected' ? 'Rejetée' : 'En attente'
                                )
                            ),
                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, req.part_name),
                            h('div', { style: { fontSize: 12, display: 'flex', gap: 12, marginTop: 4 } },
                                h('span', null, '📦 ', req.quantity || 1),
                                h('span', { style: { color: COLORS.muted } }, '👤 ', req.requested_by || 'Inconnu'),
                                h('span', { style: { color: COLORS.muted } }, '📅 ', formatDateTime(req.created_at))
                            ),
                            req.reason && h('div', { style: { fontSize: 12, marginTop: 4, fontStyle: 'italic', color: COLORS.text } }, '💬 ', req.reason),
                            part && h('div', { style: { fontSize: 12, marginTop: 4 } },
                                h('span', { style: { color: part.quantity <= (part.min_stock || 0) ? COLORS.danger : COLORS.success, fontWeight: 600 } }, part.quantity, ' en stock')
                            )
                        ),
                        h('div', { style: { display: 'flex', gap: 8 } },
                            req.status === 'pending' && isAdmin && h(Fragment, null,
                                h('button', { className: 'btn btn-success btn-sm', onClick: () => updateRequestStatus(req.id, 'approved'), title: 'Approuver' }, '✓'),
                                h('button', { className: 'btn btn-danger btn-sm', onClick: () => updateRequestStatus(req.id, 'rejected'), title: 'Rejeter' }, '✗')
                            ),
                            req.status === 'pending' && part && isAdmin && h('button', { className: 'btn btn-primary btn-sm', onClick: () => { addToCart(part); showToast('Ajouté au panier'); } }, h(Icon, { name: 'orders', size: 14 })),
                            (isAdmin || req.user_id === user.id) && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => deleteRequest(req.id), style: { color: COLORS.danger } }, h(Icon, { name: 'trash', size: 16 }))
                        )
                    );
                })
            )
        );
    };
    
    // Add Request Modal
    const AddRequestModal = ({ part, onClose }) => {
        const [qty, setQty] = useState(1);
        const [reason, setReason] = useState('');
        return h(Modal, { isOpen: true, onClose, title: `Demande de pièce: ${part.ref}`, size: 'sm',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Annuler'),
                h('button', { className: 'btn btn-primary', onClick: () => { createPartRequest(part, qty, reason); onClose(); } }, 'Créer la demande')
            )
        },
            h('div', { style: { textAlign: 'center', marginBottom: 20, padding: 16, background: COLORS.background, borderRadius: 8 } },
                h('div', { style: { fontWeight: 600 } }, part.name),
                h('div', { style: { fontSize: 13, color: COLORS.muted } }, part.ref),
                h('div', { style: { marginTop: 8, fontSize: 14 } },
                    h('span', { style: { color: part.quantity <= (part.min_stock || 0) ? COLORS.danger : COLORS.success, fontWeight: 600 } }, part.quantity, ' en stock')
                )
            ),
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Quantité demandée'),
                h('input', { type: 'number', className: 'form-input', value: qty, onChange: e => setQty(Math.max(1, parseInt(e.target.value) || 1)), min: 1 })
            ),
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Motif de la demande'),
                h('textarea', { className: 'form-input', value: reason, onChange: e => setReason(e.target.value), placeholder: 'Pourquoi avez-vous besoin de cette pièce ?', rows: 3 })
            )
        );
    };
    
    // Global History Modal (Mouvements de stock)
    const GlobalHistoryModal = () => {
        const allMovements = data.stockMovements || [];
        const [searchRef, setSearchRef] = useState('');
        const [filterType, setFilterType] = useState('all');
        
        // Dates par défaut: mois en cours
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        const [dateFrom, setDateFrom] = useState(firstDayOfMonth);
        const [dateTo, setDateTo] = useState(lastDayOfMonth);
        
        const filteredMovements = allMovements.filter(m => {
            const matchSearch = !searchRef || m.part_ref?.toLowerCase().includes(searchRef.toLowerCase()) || m.part_name?.toLowerCase().includes(searchRef.toLowerCase()) || m.withdrawn_by?.toLowerCase().includes(searchRef.toLowerCase());
            const matchType = filterType === 'all' || m.type === filterType;
            // Filtre par date
            const movementDate = m.withdrawn_at ? m.withdrawn_at.split('T')[0] : null;
            const matchDateFrom = !dateFrom || (movementDate && movementDate >= dateFrom);
            const matchDateTo = !dateTo || (movementDate && movementDate <= dateTo);
            return matchSearch && matchType && matchDateFrom && matchDateTo;
        });
        
        const stats = {
            total: filteredMovements.length,
            entries: filteredMovements.filter(m => m.type === 'entree').length,
            exits: filteredMovements.filter(m => m.type !== 'entree').length,
            totalIn: filteredMovements.filter(m => m.type === 'entree').reduce((sum, m) => sum + (m.quantity || 0), 0),
            totalOut: filteredMovements.filter(m => m.type !== 'entree').reduce((sum, m) => sum + (m.quantity || 0), 0)
        };
        
        // Export PDF
        const exportHistoryPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-tête avec logo
            const periodText = `Du ${new Date(dateFrom).toLocaleDateString('fr-FR')} au ${new Date(dateTo).toLocaleDateString('fr-FR')}`;
            let y = drawPDFHeader(doc, 'Historique des Mouvements', periodText);
            
            // Statistiques
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('Résumé:', 14, y);
            doc.setFont('helvetica', 'normal');
            y += 7;
            doc.text(`Total mouvements: ${stats.total}`, 14, y);
            doc.setTextColor(34, 197, 94);
            doc.text(`Entrées: ${stats.entries} (+${stats.totalIn} pièces)`, 80, y);
            doc.setTextColor(245, 158, 11);
            doc.text(`Sorties: ${stats.exits} (-${stats.totalOut} pièces)`, 145, y);
            doc.setTextColor(0, 0, 0);
            
            // Tableau
            y += 12;
            const headers = ['Date', 'Référence', 'Pièce', 'Type', 'Qté', 'Par', 'Motif'];
            const colWidths = [28, 25, 40, 18, 15, 30, 34];
            let x = 14;
            
            // En-tête tableau
            doc.setFillColor(240, 240, 240);
            doc.rect(14, y - 5, 182, 8, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            headers.forEach((header, i) => {
                doc.text(header, x, y);
                x += colWidths[i];
            });
            
            // Lignes
            y += 8;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            
            filteredMovements.forEach((m, index) => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                    // Répéter en-tête
                    x = 14;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(14, y - 5, 182, 8, 'F');
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    headers.forEach((header, i) => {
                        doc.text(header, x, y);
                        x += colWidths[i];
                    });
                    y += 8;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                }
                
                const isEntry = m.type === 'entree';
                x = 14;
                
                // Alternance couleur fond
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(14, y - 4, 182, 6, 'F');
                }
                
                doc.setTextColor(100, 100, 100);
                doc.text(m.withdrawn_at ? new Date(m.withdrawn_at).toLocaleDateString('fr-FR') : '-', x, y);
                x += colWidths[0];
                
                doc.setTextColor(225, 29, 72);
                doc.text((m.part_ref || '-').substring(0, 12), x, y);
                x += colWidths[1];
                
                doc.setTextColor(0, 0, 0);
                doc.text((m.part_name || '-').substring(0, 22), x, y);
                x += colWidths[2];
                
                doc.setTextColor(isEntry ? 34 : 245, isEntry ? 197 : 158, isEntry ? 94 : 11);
                doc.text(isEntry ? 'Entrée' : 'Sortie', x, y);
                x += colWidths[3];
                
                doc.text((isEntry ? '+' : '-') + m.quantity, x, y);
                x += colWidths[4];
                
                doc.setTextColor(0, 0, 0);
                doc.text((m.withdrawn_by || '-').substring(0, 18), x, y);
                x += colWidths[5];
                
                doc.setTextColor(100, 100, 100);
                doc.text((m.reason || '-').substring(0, 20), x, y);
                
                y += 6;
            });
            
            // Pied de page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i}/${pageCount}`, 105, 290, { align: 'center' });
            }
            
            const fileName = `mouvements-stock-${dateFrom}-${dateTo}.pdf`;
            doc.save(fileName);
            showToast(`PDF exporté: ${filteredMovements.length} mouvements`);
        };
        
        return h(Modal, { isOpen: true, onClose: () => setShowGlobalHistory(false), title: 'Historique des mouvements de stock', size: 'xl' },
            // Filtres de date
            h('div', { style: { display: 'flex', gap: 12, marginBottom: 16, alignItems: 'center', flexWrap: 'wrap' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                    h('label', { style: { fontSize: 13, color: COLORS.muted } }, 'Du'),
                    h('input', { type: 'date', className: 'form-input', value: dateFrom, onChange: e => setDateFrom(e.target.value), style: { width: 150 } })
                ),
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                    h('label', { style: { fontSize: 13, color: COLORS.muted } }, 'Au'),
                    h('input', { type: 'date', className: 'form-input', value: dateTo, onChange: e => setDateTo(e.target.value), style: { width: 150 } })
                ),
                h('button', { className: 'btn btn-secondary btn-sm', onClick: () => { setDateFrom(firstDayOfMonth); setDateTo(lastDayOfMonth); } }, 'Mois en cours'),
                h('div', { style: { flex: 1 } }),
                h('button', { className: 'btn btn-primary', onClick: exportHistoryPDF, disabled: filteredMovements.length === 0 }, h(Icon, { name: 'download', size: 16 }), ' Exporter PDF')
            ),
            // Statistiques
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12, marginBottom: 16 } },
                h('div', { style: { padding: 12, background: COLORS.info + '15', borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.info } }, stats.total),
                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Total mouvements')
                ),
                h('div', { style: { padding: 12, background: COLORS.success + '15', borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.success } }, '+', stats.totalIn),
                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, stats.entries, ' entrées')
                ),
                h('div', { style: { padding: 12, background: COLORS.warning + '15', borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.warning } }, '-', stats.totalOut),
                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, stats.exits, ' sorties')
                )
            ),
            // Recherche et filtre type
            h('div', { style: { display: 'flex', gap: 8, marginBottom: 16 } },
                h('div', { className: 'header-search', style: { flex: 1 } }, 
                    h(Icon, { name: 'search', size: 18, color: COLORS.muted }),
                    h('input', { type: 'text', placeholder: 'Rechercher par référence, pièce ou utilisateur...', value: searchRef, onChange: e => setSearchRef(e.target.value) })
                ),
                h('select', { className: 'form-select', value: filterType, onChange: e => setFilterType(e.target.value), style: { width: 'auto' } },
                    h('option', { value: 'all' }, 'Tous'),
                    h('option', { value: 'entree' }, '+ Entrées'),
                    h('option', { value: 'sortie' }, '- Sorties')
                )
            ),
            // Tableau
            filteredMovements.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun mouvement sur cette période') :
            h('div', { className: 'table-container', style: { maxHeight: 350, overflow: 'auto' } },
                h('table', null,
                    h('thead', null, h('tr', null, 
                        h('th', null, 'Date'),
                        h('th', null, 'Référence'),
                        h('th', null, 'Pièce'),
                        h('th', null, 'Type'),
                        h('th', { style: { textAlign: 'center' } }, 'Qté'),
                        h('th', null, 'Par'),
                        h('th', null, 'Motif')
                    )),
                    h('tbody', null, filteredMovements.slice(0, 100).map(m => {
                        const isEntry = m.type === 'entree';
                        return h('tr', { key: m.id },
                            h('td', { style: { fontSize: 13, color: COLORS.muted } }, formatDateTime(m.withdrawn_at)),
                            h('td', null, h('span', { style: { fontFamily: 'monospace', fontWeight: 600, color: COLORS.primary } }, m.part_ref || '-')),
                            h('td', { style: { fontSize: 13 } }, m.part_name || '-'),
                            h('td', null, h('span', { className: `badge badge-${isEntry ? 'success' : 'warning'}` }, isEntry ? '+ Entrée' : '- Sortie')),
                            h('td', { style: { textAlign: 'center', fontWeight: 600, color: isEntry ? COLORS.success : COLORS.warning } }, (isEntry ? '+' : '-') + m.quantity),
                            h('td', { style: { fontSize: 13 } }, m.withdrawn_by || '-'),
                            h('td', { style: { color: COLORS.muted, fontSize: 13 } }, m.reason || '-')
                        );
                    }))
                )
            ),
            filteredMovements.length > 100 && h('div', { style: { textAlign: 'center', padding: 12, color: COLORS.muted, fontSize: 13 } }, `Affichage limité aux 100 derniers mouvements sur ${filteredMovements.length}`)
        );
    };
    
    // Categories Modal
    const CategoriesModal = () => h(Modal, { isOpen: true, onClose: () => { setShowCategories(false); setEditCategory(null); setNewCategoryName(''); }, title: 'Gestion des catégories', size: 'md' },
        h('div', { style: { marginBottom: 16 } },
            h('div', { style: { display: 'flex', gap: 8 } },
                h('input', { className: 'form-input', placeholder: 'Nouvelle catégorie...', value: newCategoryName, onChange: e => setNewCategoryName(e.target.value), style: { flex: 1 } }),
                h('button', { className: 'btn btn-primary', onClick: addCategory, disabled: !newCategoryName.trim() }, h(Icon, { name: 'plus', size: 16 }))
            ),
            h('p', { style: { fontSize: 12, color: COLORS.muted, marginTop: 8 } }, 'Note: Les catégories sont créées automatiquement lors de l\'ajout de pièces.')
        ),
        categories.length === 0 ? h('div', { style: { textAlign: 'center', padding: 30, color: COLORS.muted } }, 'Aucune catégorie') :
        h('div', null,
            categories.map(cat => {
                const count = data.parts.filter(p => p.category === cat).length;
                const isEditing = editCategory === cat;
                return h('div', { key: cat, style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 12, borderBottom: `1px solid ${COLORS.border}` } },
                    isEditing ? h('input', { className: 'form-input', defaultValue: cat, style: { flex: 1, marginRight: 8 }, autoFocus: true,
                        onKeyDown: e => { if (e.key === 'Enter') { updateCategory(cat, e.target.value); } if (e.key === 'Escape') setEditCategory(null); },
                        onBlur: e => updateCategory(cat, e.target.value)
                    }) : h('div', { style: { flex: 1 } },
                        h('span', { style: { fontWeight: 500 } }, cat),
                        h('span', { style: { marginLeft: 8, fontSize: 12, color: COLORS.muted } }, `(${count} pièce${count > 1 ? 's' : ''})`)
                    ),
                    !isEditing && h('div', { style: { display: 'flex', gap: 4 } },
                        h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setEditCategory(cat), title: 'Renommer' }, h(Icon, { name: 'edit', size: 16 })),
                        h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => { if(confirm(`Supprimer la catégorie "${cat}" ? Les ${count} pièces seront sans catégorie.`)) deleteCategory(cat); }, title: 'Supprimer', style: { color: COLORS.danger } }, h(Icon, { name: 'trash', size: 16 }))
                    )
                );
            })
        )
    );
    
    const CartModal = () => h(Modal, { isOpen: true, onClose: () => setShowCart(false), title: `Panier (${cart.length} article${cart.length > 1 ? 's' : ''})`, size: 'lg',
        footer: h(Fragment, null,
            h('button', { className: 'btn btn-secondary', onClick: clearCart, disabled: cart.length === 0 }, 'Vider'),
            h('button', { className: 'btn btn-primary', onClick: createOrderFromCart, disabled: cart.length === 0 }, h(Icon, { name: 'orders', size: 16 }), 'Commander')
        )
    },
        cart.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Votre panier est vide') :
        h('div', null,
            cart.map(item => h('div', { key: item.part.id, style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 12, borderBottom: `1px solid ${COLORS.border}` } },
                h('div', { style: { flex: 1 } },
                    h('div', { style: { fontWeight: 600 } }, item.part.ref),
                    h('div', { style: { fontSize: 13, color: COLORS.muted } }, item.part.name),
                    item.part.supplier && h('div', { style: { fontSize: 12, color: COLORS.info } }, item.part.supplier)
                ),
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                    h('button', { className: 'btn btn-ghost btn-sm', onClick: () => updateCartQty(item.part.id, item.quantity - 1) }, '-'),
                    h('span', { style: { minWidth: 40, textAlign: 'center', fontWeight: 600 } }, item.quantity),
                    h('button', { className: 'btn btn-ghost btn-sm', onClick: () => updateCartQty(item.part.id, item.quantity + 1) }, '+'),
                    h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => removeFromCart(item.part.id), style: { color: COLORS.danger, marginLeft: 8 } }, h(Icon, { name: 'trash', size: 16 }))
                )
            )),
            h('div', { style: { padding: 16, background: COLORS.background, marginTop: 16, borderRadius: 8, display: 'flex', justifyContent: 'space-between', fontWeight: 600 } },
                h('span', null, 'Total articles:'),
                h('span', null, cartTotal)
            )
        )
    );
    
    // History Modal (par pièce)
    const HistoryModal = () => {
        // Dates par défaut: mois en cours
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const lastDayOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        const [dateFrom, setDateFrom] = useState(firstDayOfMonth);
        const [dateTo, setDateTo] = useState(lastDayOfMonth);
        const [filterType, setFilterType] = useState('all');
        
        const filteredMovements = movements.filter(m => {
            const matchType = filterType === 'all' || m.type === filterType;
            const movementDate = m.withdrawn_at ? m.withdrawn_at.split('T')[0] : null;
            const matchDateFrom = !dateFrom || (movementDate && movementDate >= dateFrom);
            const matchDateTo = !dateTo || (movementDate && movementDate <= dateTo);
            return matchType && matchDateFrom && matchDateTo;
        });
        
        const stats = {
            total: filteredMovements.length,
            entries: filteredMovements.filter(m => m.type === 'entree').length,
            exits: filteredMovements.filter(m => m.type !== 'entree').length,
            totalIn: filteredMovements.filter(m => m.type === 'entree').reduce((sum, m) => sum + (m.quantity || 0), 0),
            totalOut: filteredMovements.filter(m => m.type !== 'entree').reduce((sum, m) => sum + (m.quantity || 0), 0)
        };
        
        // Export PDF
        const exportPartHistoryPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // En-tête avec logo
            const periodText = `Du ${new Date(dateFrom).toLocaleDateString('fr-FR')} au ${new Date(dateTo).toLocaleDateString('fr-FR')}`;
            let y = drawPDFHeader(doc, 'Historique Mouvements', `${showHistory.ref} - ${showHistory.name}`);
            
            // Période
            doc.setTextColor(100, 100, 100);
            doc.setFontSize(9);
            doc.text(periodText, 105, y - 3, { align: 'center' });
            
            // Infos pièce
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('Informations pièce:', 14, y + 5);
            doc.setFont('helvetica', 'normal');
            y += 12;
            doc.text(`Stock actuel: ${showHistory.quantity}`, 14, y);
            doc.text(`Stock minimum: ${showHistory.min_stock || 0}`, 80, y);
            if (showHistory.supplier) doc.text(`Fournisseur: ${showHistory.supplier}`, 140, y);
            
            // Statistiques période
            y += 10;
            doc.setFont('helvetica', 'bold');
            doc.text('Résumé période:', 14, y);
            doc.setFont('helvetica', 'normal');
            y += 7;
            doc.text(`Total mouvements: ${stats.total}`, 14, y);
            doc.setTextColor(34, 197, 94);
            doc.text(`Entrées: ${stats.entries} (+${stats.totalIn})`, 80, y);
            doc.setTextColor(245, 158, 11);
            doc.text(`Sorties: ${stats.exits} (-${stats.totalOut})`, 140, y);
            doc.setTextColor(0, 0, 0);
            
            // Tableau
            y += 12;
            const headers = ['Date', 'Type', 'Quantité', 'Par', 'Motif'];
            const colWidths = [35, 25, 25, 45, 60];
            let x = 14;
            
            doc.setFillColor(240, 240, 240);
            doc.rect(14, y - 5, 182, 8, 'F');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            headers.forEach((header, i) => {
                doc.text(header, x, y);
                x += colWidths[i];
            });
            
            y += 8;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            
            filteredMovements.forEach((m, index) => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                    x = 14;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(14, y - 5, 182, 8, 'F');
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    headers.forEach((header, i) => {
                        doc.text(header, x, y);
                        x += colWidths[i];
                    });
                    y += 8;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                }
                
                const isEntry = m.type === 'entree';
                x = 14;
                
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(14, y - 4, 182, 6, 'F');
                }
                
                doc.setTextColor(100, 100, 100);
                doc.text(m.withdrawn_at ? new Date(m.withdrawn_at).toLocaleDateString('fr-FR') : '-', x, y);
                x += colWidths[0];
                
                doc.setTextColor(isEntry ? 34 : 245, isEntry ? 197 : 158, isEntry ? 94 : 11);
                doc.text(isEntry ? 'Entrée' : 'Sortie', x, y);
                x += colWidths[1];
                
                doc.text((isEntry ? '+' : '-') + m.quantity, x, y);
                x += colWidths[2];
                
                doc.setTextColor(0, 0, 0);
                doc.text((m.withdrawn_by || '-').substring(0, 25), x, y);
                x += colWidths[3];
                
                doc.setTextColor(100, 100, 100);
                doc.text((m.reason || '-').substring(0, 35), x, y);
                
                y += 6;
            });
            
            // Pied de page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(150, 150, 150);
                doc.text(`Page ${i}/${pageCount} - Généré le ${new Date().toLocaleDateString('fr-FR')}`, 105, 290, { align: 'center' });
            }
            
            const fileName = `historique-${showHistory.ref}-${dateFrom}-${dateTo}.pdf`;
            doc.save(fileName);
            showToast(`PDF exporté: ${filteredMovements.length} mouvements`);
        };
        
        return h(Modal, { isOpen: true, onClose: () => setShowHistory(null), title: `Historique: ${showHistory.ref}`, size: 'lg' },
            // Info pièce
            h('div', { style: { marginBottom: 16, padding: 16, background: COLORS.background, borderRadius: 8, display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                h('div', null, 
                    h('div', { style: { fontWeight: 600 } }, showHistory.name), 
                    h('div', { style: { color: COLORS.muted, fontSize: 13 } }, showHistory.ref),
                    showHistory.supplier && h('div', { style: { color: COLORS.info, fontSize: 12, marginTop: 4 } }, showHistory.supplier)
                ),
                h('div', { style: { textAlign: 'right' } },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: showHistory.quantity <= (showHistory.min_stock || 0) ? COLORS.danger : COLORS.success } }, showHistory.quantity),
                    h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'en stock')
                )
            ),
            // Filtres de date
            h('div', { style: { display: 'flex', gap: 12, marginBottom: 16, alignItems: 'center', flexWrap: 'wrap' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                    h('label', { style: { fontSize: 13, color: COLORS.muted } }, 'Du'),
                    h('input', { type: 'date', className: 'form-input', value: dateFrom, onChange: e => setDateFrom(e.target.value), style: { width: 140 } })
                ),
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                    h('label', { style: { fontSize: 13, color: COLORS.muted } }, 'Au'),
                    h('input', { type: 'date', className: 'form-input', value: dateTo, onChange: e => setDateTo(e.target.value), style: { width: 140 } })
                ),
                h('select', { className: 'form-select', value: filterType, onChange: e => setFilterType(e.target.value), style: { width: 'auto' } },
                    h('option', { value: 'all' }, 'Tous'),
                    h('option', { value: 'entree' }, '+ Entrées'),
                    h('option', { value: 'sortie' }, '- Sorties')
                ),
                h('div', { style: { flex: 1 } }),
                h('button', { className: 'btn btn-primary btn-sm', onClick: exportPartHistoryPDF, disabled: filteredMovements.length === 0 }, h(Icon, { name: 'download', size: 14 }), ' PDF')
            ),
            // Statistiques
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 8, marginBottom: 16 } },
                h('div', { style: { padding: 10, background: COLORS.info + '15', borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 18, fontWeight: 700, color: COLORS.info } }, stats.total),
                    h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'mouvements')
                ),
                h('div', { style: { padding: 10, background: COLORS.success + '15', borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 18, fontWeight: 700, color: COLORS.success } }, '+', stats.totalIn),
                    h('div', { style: { fontSize: 11, color: COLORS.muted } }, stats.entries, ' entrées')
                ),
                h('div', { style: { padding: 10, background: COLORS.warning + '15', borderRadius: 8, textAlign: 'center' } },
                    h('div', { style: { fontSize: 18, fontWeight: 700, color: COLORS.warning } }, '-', stats.totalOut),
                    h('div', { style: { fontSize: 11, color: COLORS.muted } }, stats.exits, ' sorties')
                )
            ),
            // Tableau
            filteredMovements.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun mouvement sur cette période') :
            h('div', { className: 'table-container', style: { maxHeight: 300, overflow: 'auto' } },
                h('table', null,
                    h('thead', null, h('tr', null, h('th', null, 'Date'), h('th', null, 'Type'), h('th', { style: { textAlign: 'center' } }, 'Quantité'), h('th', null, 'Par'), h('th', null, 'Motif'))),
                    h('tbody', null, filteredMovements.map(m => {
                        const isEntry = m.type === 'entree';
                        return h('tr', { key: m.id },
                            h('td', { style: { fontSize: 13, color: COLORS.muted } }, formatDateTime(m.withdrawn_at)),
                            h('td', null, h('span', { className: `badge badge-${isEntry ? 'success' : 'warning'}` }, isEntry ? '+ Entrée' : '- Sortie')),
                            h('td', { style: { textAlign: 'center', fontWeight: 600, color: isEntry ? COLORS.success : COLORS.warning } }, (isEntry ? '+' : '-') + m.quantity),
                            h('td', { style: { fontSize: 13 } }, m.withdrawn_by || '-'),
                            h('td', { style: { color: COLORS.muted } }, m.reason || '-')
                        );
                    }))
                )
            )
        );
    };
    
    const PartFormModal = ({ part, onClose, onSave }) => {
        const [form, setForm] = useState(part || { name: '', ref: '', category: '', quantity: 0, min_stock: 0, supplier: '', location: '' });
        return h(Modal, { isOpen: true, onClose, title: part ? 'Modifier la pièce' : 'Nouvelle pièce', size: 'lg', footer: h(Fragment, null, h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Annuler'), h('button', { className: 'btn btn-primary', onClick: () => onSave(form) }, 'Enregistrer'))},
            h('div', { className: 'form-row' }, h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Référence *'), h('input', { className: 'form-input', value: form.ref, onChange: e => setForm({...form, ref: e.target.value}) })), h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Catégorie'), h('input', { className: 'form-input', value: form.category, onChange: e => setForm({...form, category: e.target.value}), list: 'categories' }), h('datalist', { id: 'categories' }, categories.map(c => h('option', { key: c, value: c }))))),
            h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Désignation *'), h('input', { className: 'form-input', value: form.name, onChange: e => setForm({...form, name: e.target.value}) })),
            h('div', { className: 'form-row' }, h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Quantité'), h('input', { type: 'number', className: 'form-input', value: form.quantity, onChange: e => setForm({...form, quantity: parseInt(e.target.value) || 0}) })), h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Stock minimum'), h('input', { type: 'number', className: 'form-input', value: form.min_stock, onChange: e => setForm({...form, min_stock: parseInt(e.target.value) || 0}) }))),
            h('div', { className: 'form-row' }, h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Fournisseur'), h('input', { className: 'form-input', value: form.supplier || '', onChange: e => setForm({...form, supplier: e.target.value}) })), h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Emplacement'), h('input', { className: 'form-input', value: form.location || '', onChange: e => setForm({...form, location: e.target.value}) }))
        ));
    };
    
    const AdjustStockModal = ({ part, onClose }) => {
        const [qty, setQty] = useState(1);
        const [reason, setReason] = useState('');
        const [type, setType] = useState('entree');
        return h(Modal, { isOpen: true, onClose, title: `Ajuster stock: ${part.ref}`, size: 'sm', footer: h(Fragment, null, h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Annuler'), h('button', { className: `btn ${type === 'entree' ? 'btn-success' : 'btn-warning'}`, onClick: () => handleAdjustStock(part.id, type === 'entree' ? qty : -qty, reason) }, type === 'entree' ? `+ ${qty}` : `- ${qty}`))},
            h('div', { style: { textAlign: 'center', marginBottom: 20 } }, h('div', { style: { fontSize: 14, color: COLORS.muted } }, 'Stock actuel'), h('div', { style: { fontSize: 32, fontWeight: 700 } }, part.quantity)),
            h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Type'), h('div', { style: { display: 'flex', gap: 8 } }, h('button', { className: `btn ${type === 'entree' ? 'btn-success' : 'btn-secondary'}`, style: { flex: 1 }, onClick: () => setType('entree') }, '+ Entrée'), h('button', { className: `btn ${type === 'sortie' ? 'btn-warning' : 'btn-secondary'}`, style: { flex: 1 }, onClick: () => setType('sortie') }, '- Sortie'))),
            h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Quantité'), h('input', { type: 'number', className: 'form-input', value: qty, onChange: e => setQty(Math.max(1, parseInt(e.target.value) || 1)), min: 1 })),
            h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Motif'), h('input', { className: 'form-input', value: reason, onChange: e => setReason(e.target.value), placeholder: 'Optionnel' }))
        );
    };
    
    const PartCard = ({ part }) => {
        const isLow = part.quantity <= (part.min_stock || 0);
        const hasPendingRequest = hasRequest(part.ref);
        return h('div', { className: 'card', style: { cursor: 'pointer', position: 'relative' }, onClick: () => setViewPart(part) },
            canRequest && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: e => { e.stopPropagation(); setShowAddRequest(part); }, style: { position: 'absolute', top: 8, right: 8, color: hasPendingRequest ? COLORS.warning : COLORS.muted, fontSize: 16 }, title: hasPendingRequest ? 'Demande en attente' : 'Créer une demande' }, hasPendingRequest ? '📋' : '📝'),
            h('div', { className: 'card-body' },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12, paddingRight: 24 } },
                    h('div', null, h('div', { style: { fontFamily: 'monospace', fontWeight: 600, color: COLORS.primary, marginBottom: 4 } }, part.ref), h('div', { style: { fontWeight: 600, fontSize: 14 } }, part.name)),
                    h('div', { style: { textAlign: 'right' } }, h('div', { style: { fontSize: 24, fontWeight: 700, color: isLow ? COLORS.danger : COLORS.success } }, part.quantity), isLow && h('span', { className: 'badge badge-danger', style: { fontSize: 10 } }, 'Stock bas'))
                ),
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                    part.category ? h('span', { className: 'badge badge-info' }, part.category) : h('span', { style: { color: COLORS.muted, fontSize: 12 } }, 'Sans catégorie'),
                    h('div', { className: 'table-actions', onClick: e => e.stopPropagation() },
                        canEdit && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => addToCart(part), title: 'Ajouter au panier', style: { color: COLORS.primary } }, h(Icon, { name: 'orders', size: 14 })),
                        canViewHistory && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => loadHistory(part), title: 'Historique' }, h(Icon, { name: 'clock', size: 14 })),
                        canAdjustStock && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setShowAdjust(part), title: 'Ajuster' }, h(Icon, { name: 'refresh', size: 14 })),
                        canEdit && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setEditPart(part), title: 'Modifier' }, h(Icon, { name: 'edit', size: 14 }))
                    )
                )
            )
        );
    };
    
    // Générer le PDF d'étiquettes
    const generateLabelsPDF = (partsToLabel = null) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configuration des formats (en mm)
        const formats = {
            small: { width: 38, height: 21, cols: 5, rows: 13, marginX: 5, marginY: 8, fontSize: 6, barcodeHeight: 8 },
            medium: { width: 52, height: 30, cols: 4, rows: 9, marginX: 4, marginY: 8, fontSize: 8, barcodeHeight: 12 },
            large: { width: 70, height: 42, cols: 3, rows: 6, marginX: 3, marginY: 12, fontSize: 10, barcodeHeight: 18 }
        };
        const fmt = formats[labelFormat];
        
        // Collecter les pièces à imprimer
        let labels = [];
        if (partsToLabel) {
            labels = [{ part: partsToLabel, qty: 1 }];
        } else {
            Object.entries(labelSelection).forEach(([partId, qty]) => {
                if (qty > 0) {
                    const part = data.parts.find(p => p.id === parseInt(partId));
                    if (part) labels.push({ part, qty });
                }
            });
        }
        
        if (labels.length === 0) { showToast('Aucune pièce sélectionnée', 'warning'); return; }
        
        let allLabels = [];
        labels.forEach(({ part, qty }) => { for (let i = 0; i < qty; i++) allLabels.push(part); });
        
        allLabels.forEach((part, i) => {
            const labelsPerPage = fmt.cols * fmt.rows;
            const labelIndex = i % labelsPerPage;
            if (i > 0 && labelIndex === 0) doc.addPage();
            
            const col = labelIndex % fmt.cols;
            const row = Math.floor(labelIndex / fmt.cols);
            const x = fmt.marginX + col * fmt.width;
            const y = fmt.marginY + row * fmt.height;
            
            // Générer le code-barres
            const canvas = document.createElement('canvas');
            try {
                JsBarcode(canvas, part.ref || 'NOREF', { format: 'CODE128', width: 1.5, height: 40, displayValue: false, margin: 0 });
                const barcodeImg = canvas.toDataURL('image/png');
                const barcodeW = fmt.width - 4;
                doc.addImage(barcodeImg, 'PNG', x + 2, y + 2, barcodeW, fmt.barcodeHeight);
            } catch (e) {}
            
            let textY = y + 2 + fmt.barcodeHeight + 3;
            doc.setFontSize(fmt.fontSize);
            doc.setFont(undefined, 'bold');
            doc.text(part.ref || '', x + fmt.width / 2, textY, { align: 'center' });
            
            if (labelContent.name) {
                textY += fmt.fontSize * 0.4;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(fmt.fontSize - 1);
                const maxLen = labelFormat === 'small' ? 15 : labelFormat === 'medium' ? 22 : 30;
                doc.text((part.name || '').substring(0, maxLen), x + fmt.width / 2, textY, { align: 'center' });
            }
            if (labelContent.category && part.category) {
                textY += fmt.fontSize * 0.35;
                doc.setFontSize(fmt.fontSize - 2);
                doc.text(part.category.substring(0, 15), x + fmt.width / 2, textY, { align: 'center' });
            }
            if (labelContent.location && part.location) {
                textY += fmt.fontSize * 0.35;
                doc.setFontSize(fmt.fontSize - 2);
                doc.text(part.location.substring(0, 15), x + fmt.width / 2, textY, { align: 'center' });
            }
        });
        
        doc.save(`etiquettes-stock-${new Date().toISOString().split('T')[0]}.pdf`);
        showToast(`${allLabels.length} étiquette(s) générée(s)`);
        if (!partsToLabel) setShowLabels(false);
    };
    
    const selectAllLabels = (select) => {
        if (select) {
            const newSel = {};
            filteredParts.forEach(p => { newSel[p.id] = 1; });
            setLabelSelection(newSel);
        } else setLabelSelection({});
    };
    
    const selectedLabelCount = Object.values(labelSelection).reduce((sum, qty) => sum + (qty || 0), 0);
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' }, h('h1', { className: 'page-title' }, 'Stock'), h('p', { className: 'page-subtitle' }, `${data.parts.length} pièces • ${lowStockCount > 0 ? lowStockCount + ' en alerte' : 'Tout est OK'}`)),
            h('div', { className: 'page-actions' },
                // v5.6 - Inventaire NFC amélioré
                (nfcSupported || NFCService.isSupported) && canEdit && h('button', { 
                    className: `btn ${inventoryMode ? 'btn-success' : 'btn-secondary'}`, 
                    onClick: inventoryMode ? finishInventory : startNFCInventory,
                    title: inventoryMode ? 'Terminer l\'inventaire' : 'Démarrer inventaire NFC'
                }, inventoryMode ? '✅ Terminer' : '📱 Inventaire NFC'),
                inventoryMode && h('span', { className: 'badge badge-info', style: { marginRight: 8 } }, inventoryItems.length, ' scanné(s)'),
                // v5.5 - Bouton vue sauvegardée
                h('button', { 
                    className: 'btn btn-ghost', 
                    onClick: () => {
                        SavedViewsSystem.saveView('stock', { search, categoryFilter, viewMode });
                        showToast('Vue sauvegardée', 'success');
                    },
                    title: 'Sauvegarder la vue actuelle'
                }, '💾'),
                // v5.8 - ViewSwitcher amélioré
                h(ViewSwitcher, {
                    currentView: currentViewMode,
                    views: [
                        { id: 'table', icon: '📋', label: 'Tableau' },
                        { id: 'grid', icon: '🔲', label: 'Grille' }
                    ],
                    onChange: setCurrentViewMode
                }),
                // v5.5 - Inventaire NFC
                NFCService.isSupported && canEdit && 
                    h('button', { className: 'btn btn-secondary', onClick: () => window.dispatchEvent(new CustomEvent('open-nfc-inventory')), title: 'Inventaire par badge NFC' }, h(Icon, { name: 'nfc', size: 16 }), 'Inventaire NFC'),
                canEdit && h('button', { className: 'btn btn-secondary', onClick: () => { setLabelSelection({}); setShowLabels(true); } }, h(Icon, { name: 'barcode', size: 16 }), 'Étiquettes'),
                canEdit && h('button', { className: 'btn btn-secondary', onClick: exportPDF, title: 'Exporter PDF' }, h(Icon, { name: 'pdf', size: 16 }), 'PDF'),
                canEdit && h('button', { className: 'btn btn-secondary', onClick: () => setShowCategories(true) }, h(Icon, { name: 'settings', size: 16 }), 'Catégories'),
                canViewHistory && h('button', { className: 'btn btn-info', onClick: () => setShowGlobalHistory(true), title: 'Historique des mouvements de stock' }, h(Icon, { name: 'clock', size: 16 }), 'Historique'),
                isAdmin && h('button', { className: `btn ${pendingRequestsCount > 0 ? 'btn-warning' : 'btn-secondary'}`, onClick: () => setShowRequests(true), style: { position: 'relative' } }, '📋', ' Demandes', pendingRequestsCount > 0 && h('span', { style: { position: 'absolute', top: -8, right: -8, background: COLORS.danger, color: 'white', borderRadius: '50%', width: 20, height: 20, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, fontWeight: 700 } }, pendingRequestsCount)),
                canEdit && cart.length > 0 && h('button', { className: 'btn btn-warning', onClick: () => setShowCart(true), style: { position: 'relative' } }, h(Icon, { name: 'orders', size: 16 }), 'Panier', h('span', { style: { position: 'absolute', top: -8, right: -8, background: COLORS.danger, color: 'white', borderRadius: '50%', width: 20, height: 20, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, fontWeight: 700 } }, cartTotal)),
                canEdit && h('button', { className: 'btn btn-primary', onClick: () => setShowAdd(true) }, h(Icon, { name: 'plus', size: 18 }), 'Ajouter')
            )
        ),
        
        h('div', { className: 'card' },
            h('div', { className: 'card-header' },
                h('div', { className: 'header-search', style: { width: 300 } }, h(Icon, { name: 'search', size: 18, color: COLORS.muted }), h('input', { type: 'text', placeholder: 'Rechercher par nom ou référence...', value: search, onChange: e => setSearch(e.target.value) })),
                h('select', { className: 'form-select', style: { width: 'auto' }, value: categoryFilter, onChange: e => setCategoryFilter(e.target.value) }, h('option', { value: 'all' }, 'Toutes catégories'), categories.map(c => h('option', { key: c, value: c }, c))),
                h('button', { 
                    className: 'btn btn-ghost btn-sm', 
                    onClick: resetColumns, 
                    title: 'Réinitialiser les colonnes',
                    style: { marginLeft: 'auto' }
                }, '↺ Colonnes'),
                // v5.8 - Compteur sélection
                selectedParts.length > 0 && h('span', { 
                    style: { 
                        background: COLORS.primary, 
                        color: 'white', 
                        padding: '4px 12px', 
                        borderRadius: 20, 
                        fontSize: 13, 
                        fontWeight: 600 
                    } 
                }, `${selectedParts.length} sélectionné(s)`)
            ),
            // v5.8 - Menu contextuel
            contextMenu.show && h(QuickActionsMenu, {
                isOpen: contextMenu.show,
                position: { x: contextMenu.x, y: contextMenu.y },
                type: 'part',
                item: contextMenu.part,
                onAction: (actionId, item) => {
                    if (actionId === 'view') setViewPart(item);
                    else if (actionId === 'edit') setEditPart(item);
                    else if (actionId === 'adjust') setShowAdjust(item);
                    else if (actionId === 'delete') setDeleteConfirm(item);
                },
                onClose: () => setContextMenu({ show: false, x: 0, y: 0, part: null })
            }),
            // v5.8 - Barre actions groupées
            selectedParts.length > 0 && h(BulkActionsBar, {
                selectedCount: selectedParts.length,
                type: 'parts',
                onAction: async (actionId) => {
                    if (actionId === 'export') {
                        // Export des pièces sélectionnées
                        const selectedData = data.parts.filter(p => selectedParts.includes(p.id));
                        console.log('Export:', selectedData);
                        showToast(`${selectedParts.length} pièce(s) exportée(s)`, 'success');
                    } else if (actionId === 'delete') {
                        if (confirm(`Supprimer ${selectedParts.length} pièce(s) ?`)) {
                            for (const id of selectedParts) {
                                await db.from('parts').delete().eq('id', id);
                            }
                            showToast(`${selectedParts.length} pièce(s) supprimée(s)`, 'success');
                            setSelectedParts([]);
                            refresh();
                        }
                    }
                },
                onClear: () => setSelectedParts([])
            }),
            currentViewMode === 'table' ? h('div', { className: 'table-container', style: { overflowX: 'auto' } },
                h('table', { style: { tableLayout: 'fixed', width: '100%' } },
                    h('thead', null, h('tr', null, 
                        // v5.8 - Checkbox sélection tout
                        h('th', { style: { width: 40, textAlign: 'center' } },
                            h('input', { 
                                type: 'checkbox',
                                checked: selectedParts.length === filteredParts.length && filteredParts.length > 0,
                                onChange: (e) => {
                                    if (e.target.checked) {
                                        setSelectedParts(filteredParts.map(p => p.id));
                                    } else {
                                        setSelectedParts([]);
                                    }
                                },
                                style: { cursor: 'pointer', width: 18, height: 18 }
                            })
                        ),
                        resizableCols.map(col => {
                            const colProps = getColumnProps(col.key);
                            if (col.key === 'ref') {
                                return h(FilterableTh, { 
                                    key: col.key,
                                    label: 'Référence', 
                                    filterKey: 'ref', 
                                    filters: columnFilters, 
                                    setFilters: setColumnFilters,
                                    ...colProps
                                });
                            }
                            if (col.key === 'name') {
                                return h(FilterableTh, { 
                                    key: col.key,
                                    label: 'Désignation', 
                                    filterKey: 'name', 
                                    filters: columnFilters, 
                                    setFilters: setColumnFilters,
                                    ...colProps
                                });
                            }
                            if (col.key === 'category') {
                                return h(FilterableTh, { 
                                    key: col.key,
                                    label: 'Catégorie', 
                                    filterKey: 'category', 
                                    filters: columnFilters, 
                                    setFilters: setColumnFilters, 
                                    type: 'select', 
                                    options: categories.map(c => ({ value: c, label: c })),
                                    ...colProps
                                });
                            }
                            if (col.key === 'quantity') {
                                return h(FilterableTh, { 
                                    key: col.key,
                                    label: 'Stock', 
                                    filterKey: 'stock_status', 
                                    filters: columnFilters, 
                                    setFilters: setColumnFilters, 
                                    type: 'select', 
                                    style: { textAlign: 'center' }, 
                                    options: [
                                        { value: 'low', label: '⚠️ Stock bas' },
                                        { value: 'ok', label: '✓ Stock OK' }
                                    ],
                                    ...colProps
                                });
                            }
                            if (col.key === 'min_stock') {
                                return h(FilterableTh, { 
                                    key: col.key,
                                    label: 'Min', 
                                    filterKey: null,
                                    filters: null,
                                    setFilters: null,
                                    style: { textAlign: 'center' },
                                    ...colProps
                                });
                            }
                            if (col.key === 'actions') {
                                return h(FilterableTh, { 
                                    key: col.key,
                                    label: 'Actions',
                                    filterKey: null,
                                    filters: null,
                                    setFilters: null,
                                    ...colProps
                                });
                            }
                            return null;
                        }).filter(Boolean)
                    )),
                    h('tbody', null,
                        filteredParts.length === 0 ? h('tr', null, h('td', { colSpan: 6, style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune pièce')) :
                        filteredParts.map(part => {
                            const isLow = part.quantity <= (part.min_stock || 0);
                            
                            // Fonction pour rendre une cellule selon la clé de colonne
                            const renderCell = (colKey) => {
                                const col = resizableCols.find(c => c.key === colKey);
                                const width = col?.width;
                                
                                switch(colKey) {
                                    case 'ref':
                                        return h('td', { key: colKey, style: { width } }, h('span', { style: { fontFamily: 'monospace', fontWeight: 600, color: COLORS.primary } }, part.ref));
                                    case 'name':
                                        return h('td', { key: colKey, style: { width } }, part.name);
                                    case 'category':
                                        return h('td', { key: colKey, style: { width } }, part.category ? h('span', { className: 'badge badge-info' }, part.category) : '-');
                                    case 'quantity':
                                        return h('td', { key: colKey, style: { textAlign: 'center', width } }, h('span', { style: { fontWeight: 700, color: isLow ? COLORS.danger : COLORS.success, fontSize: 16 } }, part.quantity), isLow && h('span', { className: 'badge badge-danger', style: { marginLeft: 8, fontSize: 10 } }, '!'));
                                    case 'min_stock':
                                        return h('td', { key: colKey, style: { textAlign: 'center', color: COLORS.muted, width } }, part.min_stock || 0);
                                    case 'actions':
                                        return h('td', { key: colKey, style: { width } }, h('div', { className: 'table-actions' },
                                            h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setViewPart(part), title: 'Voir' }, h(Icon, { name: 'eye', size: 16 })),
                                            h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setShowBarcode(part), title: 'Code-barres' }, h(Icon, { name: 'barcode', size: 16 })),
                                            canViewHistory && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => loadHistory(part), title: 'Historique' }, h(Icon, { name: 'clock', size: 16 })),
                                            canRequest && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setShowAddRequest(part), title: hasRequest(part.ref) ? 'Demande en attente' : 'Créer une demande', style: { color: hasRequest(part.ref) ? COLORS.warning : COLORS.muted } }, hasRequest(part.ref) ? '📋' : '📝'),
                                            canEdit && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => addToCart(part), title: 'Ajouter au panier', style: { color: COLORS.primary } }, h(Icon, { name: 'orders', size: 16 })),
                                            canAdjustStock && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setShowAdjust(part), title: 'Ajuster' }, h(Icon, { name: 'refresh', size: 16 })),
                                            canEdit && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setEditPart(part), title: 'Modifier' }, h(Icon, { name: 'edit', size: 16 })),
                                            user.role === 'admin' && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setDeleteConfirm(part), title: 'Supprimer', style: { color: COLORS.danger } }, h(Icon, { name: 'trash', size: 16 }))
                                        ));
                                    default:
                                        return h('td', { key: colKey }, '-');
                                }
                            };
                            
                            const isSelected = selectedParts.includes(part.id);
                            
                            // Rendre les cellules dans l'ordre des colonnes avec checkbox et clic droit
                            return h('tr', { 
                                key: part.id,
                                style: { 
                                    background: isSelected ? COLORS.primaryPastel : undefined,
                                    cursor: 'pointer'
                                },
                                onContextMenu: (e) => {
                                    e.preventDefault();
                                    setContextMenu({ show: true, x: e.clientX, y: e.clientY, part });
                                },
                                onClick: (e) => {
                                    // Si on clique sur la ligne (pas sur un bouton), ouvrir les détails
                                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                                        setViewPart(part);
                                    }
                                }
                            },
                                // Checkbox
                                h('td', { style: { width: 40, textAlign: 'center' }, onClick: e => e.stopPropagation() },
                                    h('input', { 
                                        type: 'checkbox',
                                        checked: isSelected,
                                        onChange: (e) => {
                                            if (e.target.checked) {
                                                setSelectedParts([...selectedParts, part.id]);
                                            } else {
                                                setSelectedParts(selectedParts.filter(id => id !== part.id));
                                            }
                                        },
                                        style: { cursor: 'pointer', width: 18, height: 18 }
                                    })
                                ),
                                resizableCols.map(col => renderCell(col.key))
                            );
                        })
                    )
                )
            ) : h('div', { style: { padding: 16 } },
                filteredParts.length === 0 ? h('div', { className: 'empty-state' }, h('p', null, 'Aucune pièce')) :
                h('div', { className: 'grid-view' }, filteredParts.map(part => {
                    const isSelected = selectedParts.includes(part.id);
                    const isLow = part.quantity <= (part.min_stock || 0);
                    return h('div', { 
                        key: part.id, 
                        className: 'grid-card hover-lift',
                        style: { border: isSelected ? `2px solid ${COLORS.primary}` : undefined },
                        onClick: () => setViewPart(part),
                        onContextMenu: (e) => {
                            e.preventDefault();
                            setContextMenu({ show: true, x: e.clientX, y: e.clientY, part });
                        }
                    },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 12 } },
                            h('input', { 
                                type: 'checkbox',
                                checked: isSelected,
                                onChange: (e) => {
                                    e.stopPropagation();
                                    if (e.target.checked) {
                                        setSelectedParts([...selectedParts, part.id]);
                                    } else {
                                        setSelectedParts(selectedParts.filter(id => id !== part.id));
                                    }
                                },
                                onClick: e => e.stopPropagation(),
                                style: { cursor: 'pointer', width: 18, height: 18 }
                            }),
                            h('span', { 
                                style: { 
                                    fontSize: 24, 
                                    fontWeight: 700, 
                                    color: isLow ? COLORS.danger : COLORS.success 
                                } 
                            }, part.quantity)
                        ),
                        h('div', { style: { fontWeight: 600, marginBottom: 4 } }, part.name),
                        h('div', { style: { fontFamily: 'monospace', color: COLORS.primary, marginBottom: 8 } }, part.ref),
                        part.category && h('span', { className: 'badge badge-info' }, part.category),
                        isLow && h('span', { className: 'badge badge-danger', style: { marginLeft: 8 } }, 'Stock bas')
                    );
                }))
            )
        ),
        
        viewPart && h(Modal, { isOpen: true, onClose: () => setViewPart(null), title: viewPart.name, size: 'md',
            footer: (canEdit || canViewHistory) && h(Fragment, null,
                canEdit && h('button', { className: 'btn btn-secondary', onClick: () => generateLabelsPDF(viewPart), title: 'Imprimer 1 étiquette' }, h(Icon, { name: 'barcode', size: 16 }), 'Étiquette'),
                canViewHistory && h('button', { className: 'btn btn-secondary', onClick: () => { loadHistory(viewPart); setViewPart(null); } }, h(Icon, { name: 'clock', size: 16 }), 'Historique'),
                canEdit && h('button', { className: 'btn btn-secondary', onClick: () => { setEditPart(viewPart); setViewPart(null); } }, h(Icon, { name: 'edit', size: 16 }), 'Modifier'),
                canEdit && h('button', { className: 'btn btn-primary', onClick: () => { addToCart(viewPart); setViewPart(null); } }, h(Icon, { name: 'orders', size: 16 }), 'Commander')
            )
        },
            h('div', { style: { textAlign: 'center', padding: '20px 0', borderBottom: `1px solid ${COLORS.border}`, marginBottom: 20 } },
                h('div', { style: { fontSize: 48, fontWeight: 700, color: viewPart.quantity <= (viewPart.min_stock || 0) ? COLORS.danger : COLORS.success } }, viewPart.quantity),
                h('div', { style: { color: COLORS.muted } }, 'en stock')
            ),
            h('div', { className: 'info-grid' },
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Référence'), h('div', { className: 'info-value' }, viewPart.ref)),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Catégorie'), h('div', { className: 'info-value' }, viewPart.category || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Stock minimum'), h('div', { className: 'info-value' }, viewPart.min_stock || 0)),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Fournisseur'), h('div', { className: 'info-value' }, viewPart.supplier || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Emplacement'), h('div', { className: 'info-value' }, viewPart.location || '-'))
            )
        ),
        showBarcode && h(Modal, { isOpen: true, onClose: () => setShowBarcode(null), title: 'Code-barres', size: 'sm' }, h(BarcodeDisplay, { value: showBarcode.ref }), h('div', { style: { textAlign: 'center', marginTop: 16 } }, h('div', { style: { fontWeight: 600 } }, showBarcode.ref), h('div', { style: { color: COLORS.muted, fontSize: 13 } }, showBarcode.name))),
        (showAdd || editPart) && h(PartFormModal, { part: editPart, onClose: () => { setShowAdd(false); setEditPart(null); }, onSave: handleSavePart }),
        showAdjust && h(AdjustStockModal, { part: showAdjust, onClose: () => setShowAdjust(null) }),
        deleteConfirm && h(ConfirmDialog, { isOpen: true, onClose: () => setDeleteConfirm(null), onConfirm: () => handleDelete(deleteConfirm), title: 'Supprimer la pièce ?', message: `${deleteConfirm.ref} - ${deleteConfirm.name}`, confirmText: 'Supprimer', type: 'danger' }),
        showCart && h(CartModal),
        showHistory && h(HistoryModal),
        showRequests && h(PartRequestsModal),
        showGlobalHistory && h(GlobalHistoryModal),
        orderPreview && h(OrderPreviewModal, { preview: orderPreview, onClose: () => setOrderPreview(null) }),
        showAddRequest && h(AddRequestModal, { part: showAddRequest, onClose: () => setShowAddRequest(null) }),
        showCategories && h(CategoriesModal),
        // Modal Étiquettes
        showLabels && h(Modal, { isOpen: true, onClose: () => setShowLabels(false), title: '🏷️ Imprimer des étiquettes', size: 'xl',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => setShowLabels(false) }, 'Fermer'),
                h('button', { className: 'btn btn-primary', onClick: () => generateLabelsPDF(), disabled: selectedLabelCount === 0 }, h(Icon, { name: 'download', size: 16 }), `Générer PDF (${selectedLabelCount} étiquette${selectedLabelCount > 1 ? 's' : ''})`)
            )
        },
            h('div', { style: { display: 'flex', gap: 24 } },
                // Colonne gauche : sélection des pièces
                h('div', { style: { flex: 2 } },
                    h('div', { style: { display: 'flex', gap: 12, marginBottom: 16, alignItems: 'center' } },
                        h('div', { className: 'header-search', style: { flex: 1 } }, h(Icon, { name: 'search', size: 16, color: COLORS.muted }), h('input', { type: 'text', placeholder: 'Rechercher...', value: search, onChange: e => setSearch(e.target.value), style: { border: 'none', outline: 'none', width: '100%' } })),
                        h('button', { className: 'btn btn-secondary btn-sm', onClick: () => selectAllLabels(true) }, 'Tout sélectionner'),
                        h('button', { className: 'btn btn-ghost btn-sm', onClick: () => selectAllLabels(false) }, 'Désélectionner')
                    ),
                    h('div', { style: { maxHeight: 400, overflowY: 'auto', border: `1px solid ${COLORS.border}`, borderRadius: 8 } },
                        h('table', { className: 'table', style: { marginBottom: 0 } },
                            h('thead', null, h('tr', null,
                                h('th', { style: { width: 50 } }, ''),
                                h('th', null, 'Référence'),
                                h('th', null, 'Désignation'),
                                h('th', { style: { width: 80, textAlign: 'center' } }, 'Qté')
                            )),
                            h('tbody', null, filteredParts.map(part => h('tr', { key: part.id, style: { background: labelSelection[part.id] ? '#EFF6FF' : 'transparent' } },
                                h('td', null, h('input', { type: 'checkbox', checked: !!labelSelection[part.id], onChange: e => setLabelSelection(prev => ({ ...prev, [part.id]: e.target.checked ? 1 : 0 })) })),
                                h('td', null, h('span', { style: { fontFamily: 'monospace', fontWeight: 600, color: COLORS.primary } }, part.ref)),
                                h('td', null, part.name),
                                h('td', { style: { textAlign: 'center' } }, labelSelection[part.id] ? h('input', { type: 'number', min: 1, max: 100, value: labelSelection[part.id] || 1, onChange: e => setLabelSelection(prev => ({ ...prev, [part.id]: parseInt(e.target.value) || 1 })), style: { width: 60, textAlign: 'center', padding: 4, border: `1px solid ${COLORS.border}`, borderRadius: 4 } }) : '-')
                            )))
                        )
                    )
                ),
                // Colonne droite : configuration
                h('div', { style: { flex: 1, background: COLORS.background, padding: 16, borderRadius: 12 } },
                    h('h4', { style: { marginBottom: 16 } }, 'Configuration'),
                    h('div', { className: 'form-group' },
                        h('label', { className: 'form-label' }, 'Format des étiquettes'),
                        h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                            h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                                h('input', { type: 'radio', name: 'labelFormat', checked: labelFormat === 'small', onChange: () => setLabelFormat('small') }),
                                h('span', null, 'Petit (38×21mm) - 65 par page')
                            ),
                            h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                                h('input', { type: 'radio', name: 'labelFormat', checked: labelFormat === 'medium', onChange: () => setLabelFormat('medium') }),
                                h('span', null, 'Moyen (52×30mm) - 36 par page')
                            ),
                            h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                                h('input', { type: 'radio', name: 'labelFormat', checked: labelFormat === 'large', onChange: () => setLabelFormat('large') }),
                                h('span', null, 'Grand (70×42mm) - 18 par page')
                            )
                        )
                    ),
                    h('div', { className: 'form-group', style: { marginTop: 20 } },
                        h('label', { className: 'form-label' }, 'Contenu affiché'),
                        h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                            h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer', opacity: 0.5 } },
                                h('input', { type: 'checkbox', checked: true, disabled: true }),
                                h('span', null, 'Référence (toujours)')
                            ),
                            h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                                h('input', { type: 'checkbox', checked: labelContent.name, onChange: e => setLabelContent(prev => ({ ...prev, name: e.target.checked })) }),
                                h('span', null, 'Nom de la pièce')
                            ),
                            h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                                h('input', { type: 'checkbox', checked: labelContent.category, onChange: e => setLabelContent(prev => ({ ...prev, category: e.target.checked })) }),
                                h('span', null, 'Catégorie')
                            ),
                            h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' } },
                                h('input', { type: 'checkbox', checked: labelContent.location, onChange: e => setLabelContent(prev => ({ ...prev, location: e.target.checked })) }),
                                h('span', null, 'Emplacement')
                            )
                        )
                    ),
                    h('div', { style: { marginTop: 20, padding: 12, background: 'white', borderRadius: 8, border: `1px dashed ${COLORS.border}` } },
                        h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 8 } }, 'Aperçu :'),
                        h('div', { style: { textAlign: 'center', padding: 8, border: `1px solid ${COLORS.border}`, borderRadius: 4, background: '#FAFAFA' } },
                            h('div', { style: { fontSize: 10, marginBottom: 4, letterSpacing: 2 } }, '|||||||||||||||'),
                            h('div', { style: { fontWeight: 700, fontSize: labelFormat === 'small' ? 9 : labelFormat === 'medium' ? 11 : 13 } }, 'REF-001'),
                            labelContent.name && h('div', { style: { fontSize: labelFormat === 'small' ? 8 : labelFormat === 'medium' ? 10 : 12 } }, 'Nom de la pièce'),
                            labelContent.category && h('div', { style: { fontSize: labelFormat === 'small' ? 7 : 9, color: COLORS.muted } }, 'Catégorie'),
                            labelContent.location && h('div', { style: { fontSize: labelFormat === 'small' ? 7 : 9, color: COLORS.muted } }, 'Emplacement')
                        )
                    )
                )
            )
        ),
        
        // Barre d'inventaire NFC v5.6
        inventoryMode && h('div', { style: { position: 'fixed', bottom: 0, left: 0, right: 0, background: COLORS.success, color: 'white', padding: 16, zIndex: 1000 } },
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', maxWidth: 1200, margin: '0 auto' } },
                h('div', null,
                    h('div', { style: { fontWeight: 600, marginBottom: 4 } }, '📱 Mode Inventaire NFC actif'),
                    h('div', { style: { fontSize: 13, opacity: 0.9 } }, `${inventoryItems.length} article(s) scanné(s) • Approchez un badge NFC`)
                ),
                h('div', { style: { display: 'flex', gap: 12 } },
                    h('button', { className: 'btn', style: { background: 'rgba(255,255,255,0.2)', color: 'white' }, onClick: () => setShowInventoryModal(true) }, '📋 Voir liste'),
                    h('button', { className: 'btn', style: { background: 'white', color: COLORS.success }, onClick: finishInventory }, '✅ Terminer')
                )
            )
        ),
        
        // Modal détail inventaire v5.6
        showInventoryModal && h(Modal, { isOpen: true, onClose: () => setShowInventoryModal(false), title: '📋 Détail de l\'inventaire', size: 'md' },
            h('div', null,
                inventoryItems.length === 0 ?
                    h('p', { style: { textAlign: 'center', padding: 20, color: COLORS.muted } }, 'Aucun article scanné') :
                    h('div', { style: { maxHeight: 400, overflowY: 'auto' } },
                        inventoryItems.map(item => h('div', { key: item.partId, style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: 12, borderBottom: '1px solid ' + COLORS.border } },
                            h('div', null,
                                h('div', { style: { fontWeight: 600 } }, item.part?.ref || 'Article'),
                                h('div', { style: { fontSize: 12, color: COLORS.muted } }, item.part?.name)
                            ),
                            h('div', { style: { textAlign: 'right' } },
                                h('div', { style: { fontWeight: 600, color: item.scanned === item.expected ? COLORS.success : COLORS.warning } }, `${item.scanned} / ${item.expected}`),
                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, item.scanned === item.expected ? '✓ OK' : item.scanned > item.expected ? '↑ Surplus' : '↓ Manquant')
                            )
                        ))
                    ),
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', marginTop: 20 } },
                    h('button', { className: 'btn btn-secondary', onClick: () => setShowInventoryModal(false) }, 'Fermer')
                )
            )
        )
    );
};


// ==========================================
// TASKS PAGE
// ==========================================
const TasksPage = ({ data, user, refresh, showToast }) => {
    const [search, setSearch] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [viewMode, setViewMode] = useState('list');
    const [columnFilters, setColumnFilters] = useState({});
    const [showAdd, setShowAdd] = useState(false);
    const [editTask, setEditTask] = useState(null);
    const [viewTask, setViewTask] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [orderPreview, setOrderPreview] = useState(null); // Pour commander les pièces manquantes
    // Archives
    const [showArchives, setShowArchives] = useState(false);
    const [archivedTasks, setArchivedTasks] = useState([]);
    const [archiveSearch, setArchiveSearch] = useState('');
    const [archiveTechFilter, setArchiveTechFilter] = useState('');
    const [archiveTourneeFilter, setArchiveTourneeFilter] = useState('');
    const [archiveDateFrom, setArchiveDateFrom] = useState(() => { const d = new Date(); d.setDate(1); return d.toISOString().split('T')[0]; });
    const [archiveDateTo, setArchiveDateTo] = useState(() => new Date().toISOString().split('T')[0]);
    const [archiveExportWithDetails, setArchiveExportWithDetails] = useState(false);
    const [archiveExportAll, setArchiveExportAll] = useState(false);
    const [viewArchivedTask, setViewArchivedTask] = useState(null);
    const [deleteArchiveConfirm, setDeleteArchiveConfirm] = useState(null);
    // Options export travaux actifs
    const [showExportOptions, setShowExportOptions] = useState(false);
    const [exportWithDetails, setExportWithDetails] = useState(false);
    const [exportDateFrom, setExportDateFrom] = useState('');
    const [exportDateTo, setExportDateTo] = useState('');
    
    // v5.8 - États HMI avancé
    const [selectedTasks, setSelectedTasks] = useState([]);
    const [contextMenu, setContextMenu] = useState({ show: false, x: 0, y: 0, task: null });
    const [currentViewMode, setCurrentViewMode] = useState('table'); // table, grid, timeline
    
    // Photos annotées
    const [taskAnnotatedPhotos, setTaskAnnotatedPhotos] = useState([]);
    const [loadingPhotos, setLoadingPhotos] = useState(false);
    
    // Fonction pour charger les photos annotées
    const loadAnnotatedPhotos = useCallback((taskId) => {
        if (!taskId) return;
        
        setLoadingPhotos(true);
        const id = String(taskId);
        
        db.from('annotated_photos')
            .select('*')
            .eq('related_type', 'task')
            .eq('related_id', id)
            .order('created_at', { ascending: false })
            .then(({ data: photos, error }) => {
                if (error) {
                    console.error('[TasksPage] Erreur chargement photos annotées:', error);
                    // Fallback: charger depuis localStorage
                    const localPhotos = JSON.parse(localStorage.getItem('annotatedPhotos') || '[]');
                    const filtered = localPhotos.filter(p => p.relatedType === 'task' && String(p.relatedId) === id);
                    setTaskAnnotatedPhotos(filtered.map(p => ({ id: p.id, annotated_url: p.data, created_at: p.createdAt, source: 'local' })));
                } else {
                    console.log('[TasksPage] Photos annotées chargées pour task:', id, '-', photos?.length || 0, 'photos');
                    setTaskAnnotatedPhotos(photos || []);
                }
                setLoadingPhotos(false);
            });
    }, []);
    
    // Charger les photos annotées quand on ouvre une tâche
    useEffect(() => {
        if (viewTask) {
            loadAnnotatedPhotos(viewTask.id);
        } else {
            setTaskAnnotatedPhotos([]);
        }
    }, [viewTask, loadAnnotatedPhotos]);
    
    // Écouter l'événement de sauvegarde de photo pour rafraîchir en temps réel
    useEffect(() => {
        const handlePhotoSaved = (e) => {
            const { relatedType, relatedId } = e.detail || {};
            console.log('[TasksPage] Photo sauvegardée détectée:', relatedType, relatedId);
            
            // Si la photo concerne la tâche actuellement ouverte, rafraîchir
            if (viewTask && relatedType === 'task' && String(relatedId) === String(viewTask.id)) {
                console.log('[TasksPage] Rafraîchissement des photos...');
                loadAnnotatedPhotos(viewTask.id);
            }
        };
        
        window.addEventListener('annotated-photo-saved', handlePhotoSaved);
        return () => window.removeEventListener('annotated-photo-saved', handlePhotoSaved);
    }, [viewTask, loadAnnotatedPhotos]);
    
    // Colonnes redimensionnables
    const tasksColumns = useMemo(() => [
        { key: 'device_number', label: 'Appareil', width: 130 },
        { key: 'site_name', label: 'Lieu', width: 180 },
        { key: 'assigned_to', label: 'Technicien', width: 140 },
        { key: 'status', label: 'Statut', width: 130 },
        { key: 'priority', label: 'Priorité', width: 100 },
        { key: 'due_date', label: 'Date', width: 110 },
        { key: 'actions', label: 'Actions', width: 120 }
    ], []);
    
    const { columns: resizableCols, getColumnProps, resetColumns } = useResizableColumns('tasks-table', tasksColumns);
    
    // Templates de tâches v5.3
    const [showTemplateManager, setShowTemplateManager] = useState(false);
    const taskTemplates = typeof window.StockAppV53 !== 'undefined' 
        ? window.StockAppV53.useTaskTemplates()
        : { templates: [], addTemplate: () => {}, updateTemplate: () => {}, deleteTemplate: () => {}, applyTemplate: () => null, resetToDefaults: () => {} };
    
    const userPerms = getUserPermissions(user);
    const canEdit = userPerms.tasks_write === true;
    
    const filteredTasks = data.tasks.filter(t => {
        const matchSearch = !search || t.device_number?.toLowerCase().includes(search.toLowerCase()) || t.description?.toLowerCase().includes(search.toLowerCase());
        const matchStatus = statusFilter === 'all' || t.status === statusFilter;
        // Filtres de colonnes
        if (columnFilters.device_number && !t.device_number?.toLowerCase().includes(columnFilters.device_number.toLowerCase())) return false;
        if (columnFilters.site_name && !t.site_name?.toLowerCase().includes(columnFilters.site_name.toLowerCase())) return false;
        if (columnFilters.assigned_to) {
            const techName = getUserName(t.assigned_to, data.users)?.toLowerCase() || '';
            if (!techName.includes(columnFilters.assigned_to.toLowerCase())) return false;
        }
        if (columnFilters.status && t.status !== columnFilters.status) return false;
        if (columnFilters.priority && t.priority !== columnFilters.priority) return false;
        return matchSearch && matchStatus && !t.is_event;
    });
    
    // Multi-sélection v5.3 (après filteredTasks)
    const multiSelect = typeof window.StockAppV53 !== 'undefined' 
        ? window.StockAppV53.useMultiSelect(filteredTasks, 'id')
        : { selectedIds: new Set(), selectedItems: [], selectedCount: 0, toggleSelect: () => {}, selectAll: () => {}, clearSelection: () => {}, isSelected: () => false };
    
    const statusOptions = [
        { value: 'non-defini', label: 'Non défini', color: 'muted' },
        { value: 'en-commande', label: 'En commande', color: 'warning' },
        { value: 'en-stock', label: 'En stock', color: 'info' },
        { value: 'termine', label: 'Effectué', color: 'success' }
    ];
    const priorityColors = { urgente: 'danger', haute: 'warning', normal: 'info', basse: 'muted' };
    const priorityLabels = { urgente: 'Urgente', haute: 'Haute', normal: 'Normale', basse: 'Basse' };
    
    const handleSaveTask = async (formData) => {
        try {
            if (editTask) {
                await db.from('tasks').update(formData).eq('id', editTask.id);
                showToast('Travail modifié');
            } else {
                const { data: newTask } = await db.from('tasks').insert({ ...formData, created_by: user.id }).select().single();
                showToast('Travail créé');
                
                // Notification si assigné à quelqu'un
                if (formData.assigned_to && formData.assigned_to !== user.id) {
                    createNotification({
                        userId: formData.assigned_to,
                        type: 'task_assigned',
                        title: 'Nouveau travail assigné',
                        body: `${formData.device_number || 'Travail'} - ${formData.work_list?.substring(0, 50) || 'Sans description'}`,
                        actionUrl: '/travaux',
                    });
                }
            }
            setShowAdd(false); setEditTask(null); refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const handleStatusChange = async (task, newStatus) => {
        try { 
            const updateData = { status: newStatus };
            if (newStatus === 'termine') {
                updateData.completed_at = new Date().toISOString();
                
                // Notification de travail terminé aux admins
                const admins = data.users.filter(u => u.role === 'admin' && u.id !== user.id);
                admins.forEach(admin => {
                    createNotification({
                        userId: admin.id,
                        type: 'task_completed',
                        title: 'Travail terminé',
                        body: `${task.device_number || 'Travail'} terminé par ${user.first_name || user.email}`,
                        actionUrl: '/travaux',
                    });
                });
            }
            await db.from('tasks').update(updateData).eq('id', task.id); 
            showToast('Statut mis à jour'); 
            refresh(); 
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const handleAssignChange = async (task, technicianId) => {
        try { 
            await db.from('tasks').update({ assigned_to: technicianId || null }).eq('id', task.id);
            
            // Notification au technicien assigné
            if (technicianId && technicianId !== user.id) {
                createNotification({
                    userId: technicianId,
                    type: 'task_assigned',
                    title: 'Travail assigné',
                    body: `${task.device_number || 'Travail'} vous a été assigné`,
                    actionUrl: '/travaux',
                });
            }
            
            showToast('Technicien assigné'); 
            refresh(); 
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const handleDelete = async (task) => {
        try { await db.from('tasks').delete().eq('id', task.id); showToast('Travail supprimé'); setDeleteConfirm(null); refresh(); } catch (err) { showToast(err.message, 'error'); }
    };
    
    // Charger les archives
    useEffect(() => {
        if (showArchives) {
            db.from('archived_tasks').select('*').order('archived_at', { ascending: false }).then(({ data: archived }) => setArchivedTasks(archived || []));
        }
    }, [showArchives]);
    
    // Archiver un travail terminé
    const archiveTask = async (task) => {
        try {
            const techName = technicians.find(t => t.id === task.assigned_to);
            const techFullName = techName ? ((techName.first_name || '') + ' ' + (techName.last_name || '')).trim() : null;
            
            const archiveData = { 
                device_number: task.device_number, 
                tournee: task.tournee, 
                location: task.location, 
                site_name: task.site_name,
                work_list: task.work_list, 
                priority: task.priority, 
                status: task.status, 
                assigned_to: techFullName || task.assigned_to,
                date_added: task.date_added, 
                completed_at: task.completed_at || new Date().toISOString(), 
                created_at: task.created_at,
                archived_at: new Date().toISOString()
            };
            
            const { error: insertError } = await db.from('archived_tasks').insert(archiveData);
            
            if (insertError) {
                console.error('Erreur insertion archive:', insertError);
                showToast('Erreur archivage: ' + insertError.message, 'error');
                return;
            }
            
            const { error: deleteError } = await db.from('tasks').delete().eq('id', task.id);
            
            if (deleteError) {
                console.error('Erreur suppression tâche:', deleteError);
                showToast('Archivé mais erreur suppression: ' + deleteError.message, 'error');
                return;
            }
            
            showToast('Travail archivé'); 
            refresh(); 
            setViewTask(null);
            
            // Recharger les archives si on est dans le modal archives
            if (showArchives) {
                const { data: archived } = await db.from('archived_tasks').select('*').order('archived_at', { ascending: false });
                setArchivedTasks(archived || []);
            }
        } catch (err) { 
            console.error('Erreur archivage:', err);
            showToast('Erreur: ' + err.message, 'error'); 
        }
    };
    
    // Supprimer une archive
    const deleteArchivedTask = async (id) => {
        try {
            await db.from('archived_tasks').delete().eq('id', id);
            setArchivedTasks(prev => prev.filter(t => t.id !== id));
            showToast('Archive supprimée');
            setDeleteArchiveConfirm(null);
            setViewArchivedTask(null);
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    // Export PDF archive
    const exportArchivedTaskPdf = (task) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const items = parseWorkList(task.work_list);
        
        doc.setFillColor(100, 116, 139);
        doc.rect(0, 0, 210, 35, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.text('TRAVAIL ARCHIVÉ', 105, 15, { align: 'center' });
        doc.setFontSize(16);
        doc.text(task.device_number || '-', 105, 28, { align: 'center' });
        
        doc.setTextColor(0, 0, 0);
        let y = 50;
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('Informations', 20, y);
        y += 10;
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        
        const infos = [
            ['Tournée', task.tournee || '-'],
            ['Lieu', task.location || '-'],
            ['Technicien', task.assigned_to || '-'],
            ['Priorité', task.priority || '-'],
            ['Ajouté le', formatDate(task.date_added)],
            ['Archivé le', formatDate(task.archived_at)]
        ];
        
        infos.forEach(([label, value]) => {
            doc.setFont(undefined, 'bold');
            doc.text(label + ':', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(value, 60, y);
            y += 8;
        });
        
        y += 10;
        
        if (items.length > 0) {
            doc.setFont(undefined, 'bold');
            doc.text('Travaux effectués (' + items.length + ')', 20, y);
            y += 10;
            doc.setFont(undefined, 'normal');
            items.forEach((item, i) => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.text('[' + item.status + '] ' + item.text, 25, y);
                y += 7;
            });
        }
        
        doc.save('archive-' + task.device_number + '-' + new Date().toISOString().split('T')[0] + '.pdf');
    };
    
    // Export PDF liste archives filtrées
    const exportFilteredArchivesPdf = (filteredList, withDetails = false) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l');
        
        doc.setFillColor(100, 116, 139);
        doc.rect(0, 0, 297, 30, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('TRAVAUX ARCHIVÉS', 148.5, 12, { align: 'center' });
        doc.setFontSize(11);
        const dateRange = archiveExportAll ? 'Tous les travaux' : ('du ' + archiveDateFrom + ' au ' + archiveDateTo);
        doc.text(filteredList.length + ' travaux ' + dateRange, 148.5, 22, { align: 'center' });
        
        doc.setTextColor(0, 0, 0);
        let y = 45;
        
        if (withDetails) {
            // Export avec détails complets
            filteredList.forEach((t, idx) => {
                if (y > 170) { doc.addPage(); y = 20; }
                
                // Bandeau titre
                doc.setFillColor(241, 245, 249);
                doc.rect(10, y - 5, 277, 12, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text((idx + 1) + '. ' + (t.device_number || '-'), 15, y + 3);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.text(t.tournee || '-', 100, y + 3);
                doc.text(t.assigned_to || '-', 160, y + 3);
                doc.text('Archivé: ' + formatDate(t.archived_at), 220, y + 3);
                y += 15;
                
                // Infos
                doc.setFontSize(9);
                doc.text('Lieu: ' + (t.location || '-'), 15, y);
                y += 6;
                
                // Travaux effectués
                const items = parseWorkList(t.work_list);
                if (items.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Travaux (' + items.length + '):', 15, y);
                    doc.setFont(undefined, 'normal');
                    y += 5;
                    items.forEach(item => {
                        if (y > 190) { doc.addPage(); y = 20; }
                        const statusIcon = item.status === 'EFFECTUÉ' ? '✓' : item.status === 'NON CONFORME' ? '✗' : item.status === 'PARTIEL' ? '~' : '-';
                        doc.text('  ' + statusIcon + ' [' + item.status + '] ' + item.text.substring(0, 80), 15, y);
                        y += 5;
                    });
                }
                
                // Pièces
                if (t.required_parts) {
                    try {
                        const parts = JSON.parse(t.required_parts);
                        if (parts.length > 0) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Pièces (' + parts.length + '):', 15, y);
                            doc.setFont(undefined, 'normal');
                            y += 5;
                            parts.forEach(p => {
                                if (y > 190) { doc.addPage(); y = 20; }
                                doc.text('  • ' + (p.part_name || p.part_ref || '-') + ' x' + (p.quantity || 1), 15, y);
                                y += 5;
                            });
                        }
                    } catch (e) {}
                }
                
                y += 8;
            });
        } else {
            // Export tableau simple
            doc.setFillColor(241, 245, 249);
            doc.rect(10, y - 5, 277, 10, 'F');
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('N° Appareil', 15, y);
            doc.text('Tournée', 50, y);
            doc.text('Lieu', 80, y);
            doc.text('Technicien', 140, y);
            doc.text('Archivé le', 200, y);
            doc.text('Travaux', 250, y);
            y += 12;
            
            doc.setFont(undefined, 'normal');
            filteredList.forEach(t => {
                if (y > 190) { doc.addPage(); y = 20; }
                const items = parseWorkList(t.work_list);
                doc.text(t.device_number || '-', 15, y);
                doc.text(t.tournee || '-', 50, y);
                doc.text((t.location || '-').substring(0, 30), 80, y);
                doc.text((t.assigned_to || '-').substring(0, 25), 140, y);
                doc.text(formatDate(t.archived_at), 200, y);
                doc.text(items.length + ' tâches', 250, y);
                y += 8;
            });
        }
        
        doc.save('archives-travaux-' + (archiveExportAll ? 'tous' : archiveDateFrom + '-' + archiveDateTo) + '.pdf');
    };
    
    // Export PDF global des travaux actifs
    const exportTasksPdf = (tasksList, withDetails = false) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l');
        
        doc.setFillColor(79, 70, 229);
        doc.rect(0, 0, 297, 30, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text('LISTE DES TRAVAUX', 148.5, 12, { align: 'center' });
        doc.setFontSize(11);
        const dateInfo = (exportDateFrom && exportDateTo) ? ('du ' + exportDateFrom + ' au ' + exportDateTo) : 'Tous les travaux actifs';
        doc.text(tasksList.length + ' travaux - ' + dateInfo, 148.5, 22, { align: 'center' });
        
        doc.setTextColor(0, 0, 0);
        let y = 45;
        
        if (withDetails) {
            // Export avec détails complets
            tasksList.forEach((t, idx) => {
                if (y > 170) { doc.addPage(); y = 20; }
                
                // Bandeau titre avec couleur selon priorité
                const priorityColor = t.priority === 'urgente' ? [239, 68, 68] : t.priority === 'haute' ? [245, 158, 11] : [79, 70, 229];
                doc.setFillColor(...priorityColor);
                doc.rect(10, y - 5, 277, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text((idx + 1) + '. ' + (t.device_number || '-'), 15, y + 3);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.text(t.tournee || '-', 100, y + 3);
                doc.text(getUserName(t.assigned_to, data.users) || '-', 160, y + 3);
                doc.text('Statut: ' + (statusOptions.find(s => s.value === t.status)?.label || t.status), 220, y + 3);
                doc.setTextColor(0, 0, 0);
                y += 15;
                
                // Infos
                doc.setFontSize(9);
                doc.text('Lieu: ' + (t.location || t.site_name || '-'), 15, y);
                doc.text('Priorité: ' + (priorityLabels[t.priority] || 'Normale'), 150, y);
                y += 6;
                
                // Travaux
                const items = parseWorkList(t.work_list);
                if (items.length > 0) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Travaux (' + items.length + '):', 15, y);
                    doc.setFont(undefined, 'normal');
                    y += 5;
                    items.forEach(item => {
                        if (y > 190) { doc.addPage(); y = 20; }
                        const statusIcon = item.status === 'EFFECTUÉ' ? '✓' : item.status === 'EN COMMANDE' ? '⏳' : item.status === 'EN STOCK' ? '📦' : '-';
                        doc.text('  ' + statusIcon + ' [' + item.status + '] ' + item.text.substring(0, 80), 15, y);
                        y += 5;
                    });
                }
                
                // Pièces
                if (t.required_parts) {
                    try {
                        const parts = JSON.parse(t.required_parts);
                        if (parts.length > 0) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Pièces nécessaires (' + parts.length + '):', 15, y);
                            doc.setFont(undefined, 'normal');
                            y += 5;
                            parts.forEach(p => {
                                if (y > 190) { doc.addPage(); y = 20; }
                                const statusPiece = p.status === 'en-stock' ? '✓ Stock' : p.status === 'en-commande' ? '⏳ Commande' : '-';
                                doc.text('  • ' + (p.part_name || p.part_ref || '-') + ' x' + (p.quantity || 1) + ' (' + statusPiece + ')', 15, y);
                                y += 5;
                            });
                        }
                    } catch (e) {}
                }
                
                y += 8;
            });
        } else {
            // Export tableau simple
            doc.setFillColor(241, 245, 249);
            doc.rect(10, y - 5, 277, 10, 'F');
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('N° Appareil', 15, y);
            doc.text('Tournée', 50, y);
            doc.text('Lieu', 80, y);
            doc.text('Technicien', 140, y);
            doc.text('Statut', 195, y);
            doc.text('Priorité', 235, y);
            doc.text('Tâches', 265, y);
            y += 12;
            
            doc.setFont(undefined, 'normal');
            tasksList.forEach(t => {
                if (y > 190) { doc.addPage(); y = 20; }
                const items = parseWorkList(t.work_list);
                doc.text(t.device_number || '-', 15, y);
                doc.text(t.tournee || '-', 50, y);
                doc.text((t.location || '-').substring(0, 30), 80, y);
                doc.text((getUserName(t.assigned_to, data.users) || '-').substring(0, 25), 140, y);
                doc.text(statusOptions.find(s => s.value === t.status)?.label || '-', 195, y);
                doc.text(priorityLabels[t.priority] || 'Normale', 235, y);
                doc.text(items.length.toString(), 265, y);
                y += 8;
            });
        }
        
        doc.save('travaux-' + new Date().toISOString().split('T')[0] + '.pdf');
        setShowExportOptions(false);
    };
    
    const technicians = data.users?.filter(u => u.role === 'technicien' || u.role === 'admin') || [];
    
    // Fonctions de parsing identiques à l'ancienne version
    const parseWorkList = (wl) => {
        if (!wl) return [];
        return wl.split('\n').filter(l => l.trim()).map(l => {
            // Format: [STATUT] texte ou [STATUT|remarque|photos] texte
            const match = l.match(/^\[([^\]]+)\]\s*(.+)$/);
            if (match) {
                const statusPart = match[1];
                const text = match[2];
                // Vérifier si c'est un format étendu avec remarque/photos
                if (statusPart.includes('|')) {
                    const parts = statusPart.split('|');
                    // Les photos sont séparées par |||
                    const photosStr = parts[2] || '';
                    let photos = [];
                    if (photosStr) {
                        // Support ancien format (virgule) et nouveau format (|||)
                        if (photosStr.includes('|||')) {
                            photos = photosStr.split('|||').filter(p => p && p.length > 10);
                        } else if (photosStr.includes('data:')) {
                            // C'est probablement une seule photo data URL
                            photos = [photosStr];
                        } else {
                            photos = photosStr.split(',').filter(p => p && p.length > 10);
                        }
                    }
                    return { 
                        status: parts[0], 
                        text: text,
                        remark: parts[1] || '',
                        photos: photos
                    };
                }
                return { status: statusPart, text: text, remark: '', photos: [] };
            }
            return { status: 'NON DÉFINI', text: l, remark: '', photos: [] };
        });
    };
    
    const buildWorkListString = (items) => items.filter(i => i.text).map(i => {
        // Si c'est NON CONFORME avec remarque ou photos, utiliser le format étendu
        if (i.status === 'NON CONFORME' && (i.remark || (i.photos && i.photos.length > 0))) {
            // Utiliser ||| comme séparateur pour les photos (les data URLs contiennent des virgules)
            return `[${i.status}|${i.remark || ''}|${(i.photos || []).join('|||')}] ${i.text}`;
        }
        // Si c'est PARTIEL avec remarque, utiliser le format étendu
        if (i.status === 'PARTIEL' && i.remark) {
            return `[${i.status}|${i.remark}|] ${i.text}`;
        }
        return `[${i.status}] ${i.text}`;
    }).join('\n');
    
    // Calculer le statut des pièces (comme l'ancienne version)
    const getPartsStatus = (wl) => {
        const items = parseWorkList(wl);
        if (items.length === 0) return { label: '-', color: 'secondary' };
        const hasCommande = items.some(i => i.status === 'EN COMMANDE');
        const hasStock = items.some(i => i.status === 'EN STOCK');
        const hasPret = items.some(i => i.status === 'PRÊT');
        const hasEffectue = items.some(i => i.status === 'EFFECTUÉ');
        const hasNonDefini = items.some(i => i.status === 'NON DÉFINI');
        const hasNonConforme = items.some(i => i.status === 'NON CONFORME');
        const hasPartiel = items.some(i => i.status === 'PARTIEL');
        const allNonDefini = items.every(i => i.status === 'NON DÉFINI');
        const allEffectue = items.every(i => i.status === 'EFFECTUÉ');
        
        if (hasNonConforme) return { label: 'Non conforme', color: 'danger' };
        if (hasPartiel) return { label: 'Partiel', color: 'orange' };
        if (allEffectue) return { label: 'Effectué', color: 'success' };
        if (allNonDefini) return { label: 'Non défini', color: 'secondary' };
        if ((hasStock || hasPret || hasEffectue) && !hasCommande && !hasNonDefini) return { label: 'En stock', color: 'success' };
        if (hasCommande && !hasStock && !hasPret && !hasEffectue && !hasNonDefini) return { label: 'En commande', color: 'warning' };
        if ((hasStock || hasPret || hasEffectue) && (hasCommande || hasNonDefini)) return { label: 'Partiel', color: 'orange' };
        if (hasCommande && hasNonDefini) return { label: 'En commande', color: 'warning' };
        return { label: '-', color: 'secondary' };
    };
    
    // Calculer le statut automatique du travail basé sur work_list
    const calculateAutoStatus = (wl) => {
        const items = parseWorkList(wl);
        if (items.length === 0) return null;
        
        const hasCommande = items.some(i => i.status === 'EN COMMANDE');
        const hasNonDefini = items.some(i => i.status === 'NON DÉFINI');
        const allEffectue = items.every(i => i.status === 'EFFECTUÉ');
        const allStock = items.every(i => ['EN STOCK', 'PRÊT', 'EFFECTUÉ'].includes(i.status));
        
        if (allEffectue) return 'termine';
        if (allStock) return 'en-stock';
        if (hasCommande) return 'en-commande';
        if (hasNonDefini && !hasCommande) return 'non-defini';
        return null;
    };
    
    // Vérifier si l'utilisateur peut terminer ce travail
    const canTerminateTask = (task) => {
        // L'admin peut toujours terminer sauf si déjà terminé
        if (user.role === 'admin') {
            return task.status !== 'termine';
        }
        // Le technicien peut terminer uniquement si en stock et assigné à lui
        if (user.role === 'technicien') {
            return task.status === 'en-stock' && task.assigned_to === user.id;
        }
        return false;
    };
    
    const TaskFormModal = ({ task, onClose, onSave }) => {
        const workStatuses = ['NON DÉFINI', 'EN STOCK', 'EN COMMANDE', 'PRÊT', 'EFFECTUÉ', 'PARTIEL', 'NON CONFORME'];
        const statusColors = {
            'NON DÉFINI': { bg: '#F1F5F9', color: '#64748B' },
            'EN STOCK': { bg: '#D1FAE5', color: '#059669' },
            'EN COMMANDE': { bg: '#FEF3C7', color: '#D97706' },
            'PRÊT': { bg: '#DBEAFE', color: '#1D4ED8' },
            'EFFECTUÉ': { bg: '#E0E7FF', color: '#4338CA' },
            'PARTIEL': { bg: '#FED7AA', color: '#EA580C' },
            'NON CONFORME': { bg: '#FEE2E2', color: '#DC2626' }
        };
        
        // Parser les pièces nécessaires (format JSON)
        const parseRequiredParts = (rp) => {
            if (!rp) return [];
            try { return JSON.parse(rp); } catch (e) { return []; }
        };
        
        const [form, setForm] = useState(task || { 
            device_number: '', location: '', tournee: '', 
            status: 'non-defini', priority: 'normal', assigned_to: '',
            attachments: '', required_parts: '',
            latitude: null, longitude: null,
            progilift_id: null, site_name: '', city: ''
        });
        const [workItems, setWorkItems] = useState(task ? parseWorkList(task.work_list) : []);
        const [requiredParts, setRequiredParts] = useState(parseRequiredParts(task?.required_parts));
        const [pdfFile, setPdfFile] = useState(null);
        const [geocoding, setGeocoding] = useState(false);
        const [geocodeStatus, setGeocodeStatus] = useState(null); // null, 'success', 'error', 'not-found'
        
        // États pour autocomplétion Progilift
        const [progiliftAscenseurs, setProgiliftAscenseurs] = useState([]);
        const [ascenseurSearch, setAscenseurSearch] = useState(task?.device_number || '');
        const [showAscenseurDropdown, setShowAscenseurDropdown] = useState(false);
        const [loadingAscenseurs, setLoadingAscenseurs] = useState(false);
        
        // Charger les ascenseurs Progilift au montage (y compris hors contrat)
        useEffect(() => {
            const loadAscenseurs = async () => {
                setLoadingAscenseurs(true);
                let ascenseursData = [];
                let horsContratData = [];
                
                console.log('🔄 Chargement des ascenseurs Progilift...');
                
                // Utiliser les tables progilift_* dans le schéma public
                try {
                    const ascenseurs = await fetchAllRows(db, 'progilift_ascenseurs', 'id, code, marque, type_appareil, en_arret, latitude, longitude, contrat_id', 'code');
                    
                    if (ascenseurs && ascenseurs.length > 0) {
                        console.log('✅ Tables progilift_* accessibles:', ascenseurs.length, 'ascenseurs');
                        const contrats = await fetchAllRows(db, 'progilift_contrats', 'id, immeuble, adresse, ville, code_postal, secteur, client_id');
                        const clients = await fetchAllRows(db, 'progilift_clients', 'id, nom');
                        
                        ascenseursData = ascenseurs.map(a => {
                            const contrat = contrats?.find(c => c.id === a.contrat_id);
                            return {
                                ...a,
                                contrat: contrat ? {
                                    ...contrat,
                                    client: clients?.find(cl => cl.id === contrat.client_id)
                                } : null,
                                isHorsContrat: false
                            };
                        });
                        
                        // Charger les appareils hors contrat (table séparée si existe)
                        try {
                            const horsContrat = await fetchAllRows(db, 'progilift_hors_contrat', 'id, code, marque, type_appareil, adresse, ville, code_postal, client_nom, secteur', 'code');
                            if (horsContrat && horsContrat.length > 0) {
                                console.log('✅ Appareils hors contrat:', horsContrat.length);
                                horsContratData = horsContrat.map(hc => ({
                                    id: 'hc_' + hc.id,
                                    code: hc.code,
                                    marque: hc.marque,
                                    type_appareil: hc.type_appareil,
                                    en_arret: false,
                                    latitude: null,
                                    longitude: null,
                                    contrat: {
                                        immeuble: hc.client_nom || '',
                                        adresse: hc.adresse,
                                        ville: hc.ville,
                                        code_postal: hc.code_postal,
                                        secteur: hc.secteur,
                                        client: { nom: hc.client_nom }
                                    },
                                    isHorsContrat: true
                                }));
                            }
                        } catch (hcErr) {
                            console.log('⚠️ Table progilift_hors_contrat non accessible');
                        }
                    }
                } catch (err) {
                    console.log('🔄 Fallback sur les vues v_progilift_*');
                    // Fallback: utiliser les vues dans le schéma public
                    try {
                        const ascenseurs = await fetchAllRows(db, 'v_progilift_ascenseurs', 'id, code, marque, type_appareil, en_arret, latitude, longitude, contrat_id', 'code');
                        
                        if (ascenseurs && ascenseurs.length > 0) {
                            console.log('✅ Vues progilift accessibles:', ascenseurs.length, 'ascenseurs');
                            const contrats = await fetchAllRows(db, 'v_progilift_contrats', 'id, immeuble, adresse, ville, code_postal, secteur, client_id');
                            const clients = await fetchAllRows(db, 'v_progilift_clients', 'id, nom');
                            
                            ascenseursData = ascenseurs.map(a => {
                                const contrat = contrats?.find(c => c.id === a.contrat_id);
                                return {
                                    ...a,
                                    contrat: contrat ? {
                                        ...contrat,
                                        client: clients?.find(cl => cl.id === contrat.client_id)
                                    } : null,
                                    isHorsContrat: false
                                };
                            });
                            
                            // Charger les appareils hors contrat via vue
                            try {
                                const horsContrat = await fetchAllRows(db, 'v_progilift_appareil_hors_contrat', 'id, code, marque, type_appareil, adresse, ville, code_postal, client_nom, secteur', 'code');
                                if (horsContrat && horsContrat.length > 0) {
                                    console.log('✅ Appareils hors contrat (vue):', horsContrat.length);
                                    horsContratData = horsContrat.map(hc => ({
                                        id: 'hc_' + hc.id,
                                        code: hc.code,
                                        marque: hc.marque,
                                        type_appareil: hc.type_appareil,
                                        en_arret: false,
                                        latitude: null,
                                        longitude: null,
                                        contrat: {
                                            immeuble: hc.client_nom || '',
                                            adresse: hc.adresse,
                                            ville: hc.ville,
                                            code_postal: hc.code_postal,
                                            secteur: hc.secteur,
                                            client: { nom: hc.client_nom }
                                        },
                                        isHorsContrat: true
                                    }));
                                }
                            } catch (hcErr) {
                                console.log('⚠️ Vue v_progilift_appareil_hors_contrat non accessible');
                            }
                        }
                    } catch (viewErr) {
                        console.log('❌ Vues non accessibles:', viewErr.message);
                    }
                }
                
                // Combiner ascenseurs et hors contrat
                const allAppareils = [...ascenseursData, ...horsContratData];
                console.log('📊 Total appareils chargés:', allAppareils.length, '(dont', horsContratData.length, 'hors contrat)');
                setProgiliftAscenseurs(allAppareils);
                setLoadingAscenseurs(false);
            };
            loadAscenseurs();
        }, []);
        
        // Filtrer les ascenseurs selon la recherche
        const filteredAscenseurs = useMemo(() => {
            if (!ascenseurSearch || ascenseurSearch.length < 1) return progiliftAscenseurs.slice(0, 20);
            const search = ascenseurSearch.toLowerCase();
            return progiliftAscenseurs.filter(a => 
                a.code?.toLowerCase().includes(search) ||
                a.contrat?.immeuble?.toLowerCase().includes(search) ||
                a.contrat?.ville?.toLowerCase().includes(search) ||
                a.contrat?.client?.nom?.toLowerCase().includes(search)
            ).slice(0, 20);
        }, [progiliftAscenseurs, ascenseurSearch]);
        
        // Sélectionner un ascenseur et préremplir les champs
        const selectAscenseur = (asc) => {
            const fullAddress = [
                asc.contrat?.adresse,
                asc.contrat?.code_postal,
                asc.contrat?.ville
            ].filter(Boolean).join(', ');
            
            // Utiliser la forme fonctionnelle pour éviter le stale closure
            setForm(prevForm => ({
                ...prevForm,
                device_number: asc.code,
                progilift_id: asc.id,
                location: fullAddress,
                site_name: asc.contrat?.immeuble || '',
                city: asc.contrat?.ville || '',
                // Ne pas modifier tournée - elle est indépendante du secteur
                latitude: asc.latitude || null,
                longitude: asc.longitude || null
            }));
            setAscenseurSearch(asc.code);
            setShowAscenseurDropdown(false);
            console.log('✅ Appareil sélectionné:', asc.code, 'Adresse:', fullAddress, 'Site:', asc.contrat?.immeuble);
        };
        
        // Géocodage de l'adresse
        const geocodeAddress = async () => {
            if (!form.location) {
                setGeocodeStatus('error');
                return;
            }
            
            setGeocoding(true);
            setGeocodeStatus(null);
            
            try {
                // Nettoyer l'adresse pour Photon
                let cleanAddress = form.location
                    .replace(/\s+/g, ' ')  // Normaliser les espaces
                    .trim();
                
                // Ajouter France si pas de pays spécifié
                if (!cleanAddress.toLowerCase().includes('france')) {
                    cleanAddress += ', France';
                }
                
                console.log('🔍 Géocodage Photon:', cleanAddress);
                
                // Utiliser Photon (Komoot) - API gratuite et rapide basée sur OSM
                const response = await fetch(
                    `https://photon.komoot.io/api/?q=${encodeURIComponent(cleanAddress)}&limit=1&lang=fr`
                );
                const data = await response.json();
                
                if (data && data.features && data.features.length > 0) {
                    const feature = data.features[0];
                    const [lon, lat] = feature.geometry.coordinates;
                    const props = feature.properties;
                    const displayName = [props.name, props.street, props.city, props.country].filter(Boolean).join(', ');
                    console.log('✅ GPS trouvé:', lat, lon, displayName);
                    setForm(prevForm => ({ 
                        ...prevForm, 
                        latitude: parseFloat(lat), 
                        longitude: parseFloat(lon) 
                    }));
                    setGeocodeStatus('success');
                } else {
                    console.log('⚠️ Adresse non trouvée:', cleanAddress);
                    setGeocodeStatus('not-found');
                }
            } catch (err) {
                console.error('❌ Erreur géocodage:', err);
                setGeocodeStatus('error');
            }
            setGeocoding(false);
        };
        
        // Gestion des travaux
        const addWorkItem = () => setWorkItems([...workItems, { status: 'NON DÉFINI', text: '', remark: '', photos: [] }]);
        const updateWorkItem = (index, field, value) => { 
            const items = [...workItems]; 
            items[index] = { ...items[index], [field]: value }; 
            setWorkItems(items); 
        };
        const removeWorkItem = (index) => setWorkItems(workItems.filter((_, i) => i !== index));
        
        // Gestion des photos pour non-conformité
        const handlePhotoUpload = (index, e) => {
            const files = Array.from(e.target.files);
            const items = [...workItems];
            const existingPhotos = items[index].photos || [];
            // Convertir les fichiers en base64
            Promise.all(files.map(file => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            })).then(base64Photos => {
                items[index] = { ...items[index], photos: [...existingPhotos, ...base64Photos] };
                setWorkItems(items);
            });
        };
        
        const removePhoto = (itemIndex, photoIndex) => {
            const items = [...workItems];
            items[itemIndex].photos = items[itemIndex].photos.filter((_, i) => i !== photoIndex);
            setWorkItems(items);
        };
        
        const handlePdfUpload = async (e) => {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                setPdfFile(file);
                setForm(prevForm => ({...prevForm, attachments: file.name}));
            }
        };
        
        // Calculer le statut automatique basé sur les pièces
        const calculatePartsStatus = () => {
            if (requiredParts.length === 0) return null; // Pas de changement si pas de pièces
            
            const hasEnCommande = requiredParts.some(p => {
                if (p.is_manual) return p.status === 'en-commande';
                if (!p.part_id) return false;
                const stockPart = data.parts.find(sp => sp.id === p.part_id);
                return (stockPart?.quantity || 0) < p.quantity;
            });
            
            return hasEnCommande ? 'en-commande' : 'en-stock';
        };
        
        const handleSave = async () => {
            if (!form.assigned_to) {
                showToast('Veuillez assigner un technicien', 'error');
                return;
            }
            const workListString = buildWorkListString(workItems);
            const requiredPartsJson = requiredParts.length > 0 ? JSON.stringify(requiredParts) : '';
            
            // Calculer le statut automatiquement si des pièces sont définies
            const autoStatus = calculatePartsStatus();
            const finalStatus = autoStatus || form.status;
            
            // Sortie automatique des pièces du stock (seulement à la création)
            if (!task) {
                for (const reqPart of requiredParts) {
                    if (reqPart.part_id && reqPart.quantity > 0 && reqPart.in_stock) {
                        const part = data.parts.find(p => p.id === reqPart.part_id);
                        if (part && part.quantity >= reqPart.quantity) {
                            // Diminuer le stock
                            await db.from('parts').update({ quantity: part.quantity - reqPart.quantity }).eq('id', part.id);
                            // Enregistrer le mouvement
                            await db.from('stock_withdrawals').insert({
                                part_id: part.id,
                                part_ref: part.ref,
                                part_name: part.name,
                                quantity: reqPart.quantity,
                                reason: 'Sortie pour travail: ' + form.device_number,
                                withdrawn_by: ((user.first_name || '') + ' ' + (user.last_name || '')).trim() || user.email,
                                user_id: user.id,
                                withdrawn_at: new Date().toISOString(),
                                type: 'sortie'
                            });
                        }
                    }
                }
            }
            
            onSave({ ...form, status: finalStatus, work_list: workListString, required_parts: requiredPartsJson }); 
            if (requiredParts.some(p => p.part_id && p.in_stock) && !task) {
                showToast('Pièces sorties du stock');
            }
            if (autoStatus) {
                showToast(`Statut mis à jour: ${autoStatus === 'en-stock' ? 'En stock' : 'En commande'}`, 'info');
            }
        };
        
        return h(Modal, { isOpen: true, onClose, title: task ? 'Modifier le travail' : 'Nouveau travail', size: 'lg', footer: h(Fragment, null, h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Annuler'), h('button', { className: 'btn btn-primary', onClick: handleSave }, 'Enregistrer'))},
            // Ligne 1: N° Appareil (avec autocomplétion Progilift si disponible) et Site
            h('div', { className: 'form-row' }, 
                h('div', { className: 'form-group', style: { position: 'relative', flex: 1 } }, 
                    h('label', { className: 'form-label' }, 'N° Appareil *', 
                        progiliftAscenseurs.length > 0 && h('span', { style: { fontSize: 10, color: COLORS.success, marginLeft: 8 } }, `✓ ${progiliftAscenseurs.length} appareils`)
                    ),
                    h('div', { style: { position: 'relative' } },
                        h('input', { 
                            className: 'form-input', 
                            value: ascenseurSearch, 
                            onChange: e => { 
                                setAscenseurSearch(e.target.value); 
                                setForm(prevForm => ({...prevForm, device_number: e.target.value, progilift_id: null})); 
                                if (progiliftAscenseurs.length > 0) setShowAscenseurDropdown(true); 
                            },
                            onFocus: () => { if (progiliftAscenseurs.length > 0) setShowAscenseurDropdown(true); },
                            onBlur: () => setTimeout(() => setShowAscenseurDropdown(false), 300),
                            placeholder: 'Ex: 12345',
                            style: { fontFamily: 'monospace', fontSize: 18, fontWeight: 700 },
                            autoComplete: 'off'
                        }),
                        form.progilift_id && h('span', { 
                            style: { position: 'absolute', right: 10, top: '50%', transform: 'translateY(-50%)', fontSize: 12, color: COLORS.success } 
                        }, '✓ Lié')
                    ),
                    // Dropdown autocomplétion (seulement si données Progilift disponibles)
                    showAscenseurDropdown && progiliftAscenseurs.length > 0 && h('div', { 
                        style: { 
                            position: 'absolute', top: '100%', left: 0, right: 0, 
                            background: 'white', border: `1px solid ${COLORS.border}`, borderRadius: 8,
                            boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: 1000, maxHeight: 300, overflowY: 'auto'
                        } 
                    },
                        loadingAscenseurs ? h('div', { style: { padding: 16, textAlign: 'center', color: COLORS.muted } }, 'Chargement...') :
                        filteredAscenseurs.length > 0 ? filteredAscenseurs.map(asc => h('div', { 
                            key: asc.id,
                            onMouseDown: (e) => { e.preventDefault(); selectAscenseur(asc); },
                            style: { 
                                padding: '10px 12px', cursor: 'pointer', borderBottom: `1px solid ${COLORS.background}`,
                                background: asc.isHorsContrat ? '#FEF9C3' : (asc.en_arret ? '#FEF2F2' : 'white')
                            },
                            onMouseEnter: e => e.currentTarget.style.background = asc.isHorsContrat ? '#FEF08A' : (asc.en_arret ? '#FEE2E2' : COLORS.background),
                            onMouseLeave: e => e.currentTarget.style.background = asc.isHorsContrat ? '#FEF9C3' : (asc.en_arret ? '#FEF2F2' : 'white')
                        },
                            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 8 } },
                                h('span', { style: { fontFamily: 'monospace', fontWeight: 700, color: COLORS.primary } }, asc.code),
                                h('div', { style: { display: 'flex', gap: 4 } },
                                    asc.isHorsContrat && h('span', { className: 'badge badge-warning', style: { fontSize: 10 } }, '📋 HC'),
                                    asc.en_arret && h('span', { className: 'badge badge-danger', style: { fontSize: 10 } }, '🚨 Arrêt')
                                )
                            ),
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 2 } }, 
                                asc.contrat?.immeuble || '', ' • ', asc.contrat?.ville || ''
                            ),
                            asc.contrat?.client?.nom && h('div', { style: { fontSize: 11, color: COLORS.info } }, '👤 ', asc.contrat.client.nom)
                        )) :
                        h('div', { style: { padding: 12, color: COLORS.muted, fontSize: 13 } }, 
                            'Aucun résultat - saisie libre autorisée'
                        )
                    )
                ), 
                h('div', { className: 'form-group' }, 
                    h('label', { className: 'form-label' }, 'Site / Immeuble'), 
                    h('input', { className: 'form-input', value: form.site_name || '', onChange: e => setForm(prevForm => ({...prevForm, site_name: e.target.value})), placeholder: 'Nom du site' })
                )
            ),
            // Ligne 2: Lieu avec géocodage
            h('div', { className: 'form-group' }, 
                h('label', { className: 'form-label' }, 'Lieu / Adresse'),
                h('div', { style: { display: 'flex', gap: 8 } },
                    h('input', { 
                        className: 'form-input', 
                        value: form.location || '', 
                        onChange: e => setForm(prevForm => ({...prevForm, location: e.target.value})),
                        placeholder: 'Ex: 123 rue de la Paix, 75001 Paris',
                        style: { flex: 1 }
                    }),
                    h('button', { 
                        type: 'button',
                        className: 'btn btn-secondary',
                        onClick: (e) => { e.preventDefault(); e.stopPropagation(); geocodeAddress(); },
                        disabled: geocoding || !form.location,
                        title: 'Obtenir les coordonnées GPS'
                    }, geocoding ? '...' : '📍 GPS')
                ),
                // Affichage des coordonnées GPS si trouvées
                (form.latitude && form.longitude) && h('div', { 
                    style: { 
                        marginTop: 8, 
                        padding: '8px 12px', 
                        background: '#D1FAE5', 
                        borderRadius: 6, 
                        fontSize: 12,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'space-between'
                    } 
                },
                    h('span', { style: { color: '#059669' } }, 
                        `✓ GPS: ${form.latitude.toFixed(5)}, ${form.longitude.toFixed(5)}`
                    ),
                    h('button', {
                        type: 'button',
                        className: 'btn btn-ghost btn-xs',
                        onClick: () => setForm(prevForm => ({ ...prevForm, latitude: null, longitude: null })),
                        style: { padding: '2px 6px' }
                    }, '✕')
                ),
                // Message d'erreur géocodage
                geocodeStatus === 'not-found' && h('div', { 
                    style: { marginTop: 8, padding: '8px 12px', background: '#FEF3C7', borderRadius: 6, fontSize: 12, color: '#92400E' } 
                }, '⚠️ Adresse non trouvée. Format conseillé: "123 rue Example, 75001 Paris"'),
                geocodeStatus === 'error' && h('div', { 
                    style: { marginTop: 8, padding: '8px 12px', background: '#FEE2E2', borderRadius: 6, fontSize: 12, color: '#991B1B' } 
                }, '❌ Erreur lors du géocodage. Vérifiez votre connexion.')
            ),
            // Technicien
            h('div', { className: 'form-row' },
                h('div', { className: 'form-group' }, 
                    h('label', { className: 'form-label' }, 'Technicien *'), 
                    h('select', { className: 'form-select', value: form.assigned_to || '', onChange: e => setForm(prevForm => ({...prevForm, assigned_to: e.target.value})), style: { borderColor: !form.assigned_to ? COLORS.danger : undefined } }, 
                        h('option', { value: '' }, '-- Sélectionner --'),
                        technicians.map(t => h('option', { key: t.id, value: t.id }, (t.first_name || '') + ' ' + (t.last_name || '')))
                    )
                ),
                h('div', { className: 'form-group' }, 
                    h('label', { className: 'form-label' }, 'Tournée'), 
                    h('select', { className: 'form-select', value: form.tournee || '', onChange: e => setForm(prevForm => ({...prevForm, tournee: e.target.value})) },
                        h('option', { value: '' }, '-- Sélectionner --'),
                        h('option', { value: 'T1' }, 'T1'),
                        h('option', { value: 'T2' }, 'T2'),
                        h('option', { value: 'T3' }, 'T3'),
                        h('option', { value: 'T4' }, 'T4'),
                        h('option', { value: 'T5' }, 'T5'),
                        h('option', { value: 'T6' }, 'T6')
                    )
                )
            ),
            // Ligne 3: Priorité et Statut (statut seulement en modification)
            h('div', { className: 'form-row' }, 
                h('div', { className: 'form-group' }, 
                    h('label', { className: 'form-label' }, 'Priorité'), 
                    h('select', { className: 'form-select', value: form.priority || 'normal', onChange: e => setForm(prevForm => ({...prevForm, priority: e.target.value})) }, 
                        h('option', { value: 'basse' }, 'Basse'), 
                        h('option', { value: 'normal' }, 'Normale'), 
                        h('option', { value: 'haute' }, 'Haute'), 
                        h('option', { value: 'urgente' }, 'Urgente')
                    )
                ),
                task && h('div', { className: 'form-group' }, 
                    h('label', { className: 'form-label' }, 'Statut'), 
                    h('select', { className: 'form-select', value: form.status, onChange: e => setForm(prevForm => ({...prevForm, status: e.target.value})) }, 
                        statusOptions.map(s => h('option', { key: s.value, value: s.value }, s.label))
                    )
                )
            ),
            // Travaux à effectuer (WorkListEditor style)
            h('div', { className: 'form-group' }, 
                h('label', { className: 'form-label' }, 'Travaux à effectuer'),
                h('div', { className: 'work-list', style: { display: 'flex', flexDirection: 'column', gap: 8 } }, 
                    workItems.map((item, i) => h('div', { key: i, style: { background: item.status === 'NON CONFORME' ? '#FEF2F2' : item.status === 'PARTIEL' ? '#FFF7ED' : COLORS.background, borderRadius: 10, padding: 12, border: item.status === 'NON CONFORME' ? '2px solid #FCA5A5' : item.status === 'PARTIEL' ? '2px solid #FDBA74' : 'none' } },
                        h('div', { className: 'work-item', style: { display: 'flex', alignItems: 'center', gap: 10 } },
                            (() => {
                                // Options selon le rôle: technicien = seulement Effectué/Partiel/Non conforme, admin = tout
                                const availableStatuses = user.role === 'admin' ? workStatuses : ['EFFECTUÉ', 'PARTIEL', 'NON CONFORME'];
                                const displayStatuses = availableStatuses.includes(item.status) ? availableStatuses : [item.status, ...availableStatuses];
                                // Technicien ne peut pas modifier si EN COMMANDE
                                const canModifyStatus = !(user.role === 'technicien' && item.status === 'EN COMMANDE');
                                
                                if (!canModifyStatus) {
                                    return h('span', { 
                                        style: { 
                                            padding: '4px 10px', 
                                            borderRadius: 6, 
                                            fontWeight: 600, 
                                            fontSize: 10, 
                                            minWidth: 100,
                                            backgroundColor: statusColors[item.status]?.bg || '#F1F5F9',
                                            color: statusColors[item.status]?.color || '#64748B'
                                        } 
                                    }, item.status);
                                }
                                return h('select', { 
                                    value: item.status, 
                                    onChange: e => updateWorkItem(i, 'status', e.target.value),
                                    style: { 
                                        padding: '4px 6px', 
                                        borderRadius: 6, 
                                        border: 'none', 
                                        fontWeight: 600, 
                                        fontSize: 10, 
                                        minWidth: 100,
                                        maxWidth: 110,
                                        backgroundColor: statusColors[item.status]?.bg || '#F1F5F9',
                                        color: statusColors[item.status]?.color || '#64748B'
                                    } 
                                }, 
                                    displayStatuses.map(s => h('option', { key: s, value: s }, s))
                                );
                            })(),
                            h('input', { 
                                type: 'text',
                                value: item.text, 
                                onChange: e => updateWorkItem(i, 'text', e.target.value), 
                                placeholder: 'Description du travail...',
                                style: { flex: 1, padding: '8px 12px', border: `1px solid ${COLORS.border}`, borderRadius: 8, fontSize: 14 }
                            }), 
                            h('button', { type: 'button', className: 'btn btn-ghost btn-icon', onClick: () => removeWorkItem(i), style: { color: COLORS.danger, opacity: 0.6 } }, h(Icon, { name: 'x', size: 16 }))
                        ),
                        // Champ remarque pour PARTIEL
                        item.status === 'PARTIEL' && h('div', { style: { marginTop: 10, paddingTop: 10, borderTop: '1px dashed #EA580C' } },
                            h('label', { style: { fontSize: 12, color: '#EA580C', fontWeight: 600, display: 'block', marginBottom: 4 } }, '📝 Raison du travail partiel'),
                            h('textarea', {
                                value: item.remark || '',
                                onChange: e => updateWorkItem(i, 'remark', e.target.value),
                                placeholder: 'Expliquez pourquoi le travail est partiel...',
                                rows: 2,
                                style: { width: '100%', padding: '8px 12px', border: '1px solid #FDBA74', borderRadius: 8, fontSize: 13, resize: 'vertical' }
                            })
                        ),
                        // Champ remarque et photos pour NON CONFORME
                        item.status === 'NON CONFORME' && h('div', { style: { marginTop: 10, paddingTop: 10, borderTop: '1px dashed #DC2626' } },
                            h('div', { style: { marginBottom: 8 } },
                                h('label', { style: { fontSize: 12, color: '#DC2626', fontWeight: 600, display: 'block', marginBottom: 4 } }, '⚠️ Remarque non-conformité'),
                                h('textarea', {
                                    value: item.remark || '',
                                    onChange: e => updateWorkItem(i, 'remark', e.target.value),
                                    placeholder: 'Décrivez la non-conformité...',
                                    rows: 2,
                                    style: { width: '100%', padding: '8px 12px', border: '1px solid #FCA5A5', borderRadius: 8, fontSize: 13, resize: 'vertical' }
                                })
                            ),
                            h('div', null,
                                h('label', { style: { fontSize: 12, color: '#DC2626', fontWeight: 600, display: 'block', marginBottom: 4 } }, '📷 Photos'),
                                h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap', marginBottom: 8 } },
                                    (item.photos || []).map((photo, pi) => h('div', { key: pi, style: { position: 'relative', width: 80, height: 80 } },
                                        h('img', { src: photo, style: { width: '100%', height: '100%', objectFit: 'cover', borderRadius: 8, border: '2px solid #FCA5A5' } }),
                                        h('button', { 
                                            type: 'button',
                                            onClick: () => removePhoto(i, pi),
                                            style: { position: 'absolute', top: -6, right: -6, width: 20, height: 20, borderRadius: '50%', background: '#DC2626', color: 'white', border: 'none', cursor: 'pointer', fontSize: 12, display: 'flex', alignItems: 'center', justifyContent: 'center' }
                                        }, '×')
                                    )),
                                    h('label', { style: { width: 80, height: 80, border: '2px dashed #FCA5A5', borderRadius: 8, display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', background: '#FEF2F2' } },
                                        h('input', { type: 'file', accept: 'image/*', multiple: true, onChange: e => handlePhotoUpload(i, e), style: { display: 'none' } }),
                                        h('span', { style: { fontSize: 24, color: '#DC2626' } }, '+')
                                    )
                                )
                            )
                        )
                    )),
                    h('button', { type: 'button', className: 'btn btn-secondary btn-sm', onClick: addWorkItem, style: { alignSelf: 'flex-start', marginTop: 8 } }, h(Icon, { name: 'plus', size: 14 }), 'Ajouter un travail')
                )
            ),
            // Pièces nécessaires (sélection depuis le stock ou saisie manuelle)
            h('div', { className: 'form-group' },
                h('label', { style: { display: 'flex', alignItems: 'center', gap: 8 } }, 
                    '🔧 Pièces nécessaires',
                    h('span', { style: { fontSize: 11, color: COLORS.muted, fontWeight: 'normal' } }, '(optionnel)')
                ),
                h('div', { style: { background: COLORS.background, borderRadius: 10, padding: 12 } },
                    requiredParts.map((reqPart, idx) => {
                        const stockPart = data.parts.find(p => p.id === reqPart.part_id);
                        const stockQty = stockPart?.quantity || 0;
                        const hasEnough = stockQty >= reqPart.quantity;
                        const missingQty = reqPart.quantity - stockQty;
                        const isManual = reqPart.is_manual === true;
                        
                        return h('div', { key: idx, style: { display: 'flex', gap: 8, marginBottom: 8, alignItems: 'center', background: 'white', padding: 10, borderRadius: 8, border: '1px solid ' + COLORS.border, flexWrap: 'wrap' } },
                            // Toggle stock/manuel
                            h('button', {
                                type: 'button',
                                onClick: () => {
                                    const newParts = [...requiredParts];
                                    newParts[idx] = { ...newParts[idx], is_manual: !isManual, part_id: null, part_ref: '', part_name: '' };
                                    setRequiredParts(newParts);
                                },
                                style: { 
                                    padding: '4px 8px', borderRadius: 6, fontSize: 11, border: 'none', cursor: 'pointer',
                                    background: isManual ? COLORS.warningPastel : COLORS.infoPastel, 
                                    color: isManual ? COLORS.warning : COLORS.info
                                },
                                title: isManual ? 'Passer en sélection stock' : 'Passer en saisie manuelle'
                            }, isManual ? '✏️ Manuel' : '📦 Stock'),
                            
                            // Si mode manuel : champs de saisie
                            isManual ? h(Fragment, null,
                                h('input', { 
                                    type: 'text', 
                                    placeholder: 'Référence',
                                    value: reqPart.part_ref || '', 
                                    onChange: e => {
                                        const newParts = [...requiredParts];
                                        newParts[idx].part_ref = e.target.value;
                                        setRequiredParts(newParts);
                                    },
                                    style: { width: 100, padding: '8px', borderRadius: 6, border: '1px solid ' + COLORS.border }
                                }),
                                h('input', { 
                                    type: 'text', 
                                    placeholder: 'Nom de la pièce',
                                    value: reqPart.part_name || '', 
                                    onChange: e => {
                                        const newParts = [...requiredParts];
                                        newParts[idx].part_name = e.target.value;
                                        setRequiredParts(newParts);
                                    },
                                    style: { flex: 1, minWidth: 150, padding: '8px', borderRadius: 6, border: '1px solid ' + COLORS.border }
                                })
                            ) : 
                            // Si mode stock : sélecteur
                            h('select', { 
                                value: reqPart.part_id || '', 
                                onChange: e => {
                                    const part = data.parts.find(p => p.id === parseInt(e.target.value));
                                    const newParts = [...requiredParts];
                                    newParts[idx] = { ...newParts[idx], part_id: part?.id || null, part_ref: part?.ref || '', part_name: part?.name || '' };
                                    setRequiredParts(newParts);
                                },
                                style: { flex: 2, minWidth: 180, padding: '8px', borderRadius: 6, border: '1px solid ' + COLORS.border }
                            },
                                h('option', { value: '' }, '-- Sélectionner une pièce --'),
                                data.parts.map(p => h('option', { key: p.id, value: p.id }, `${p.ref} - ${p.name} (stock: ${p.quantity})`))
                            ),
                            
                            // Quantité
                            h('input', { 
                                type: 'number', 
                                value: reqPart.quantity, 
                                onChange: e => {
                                    const newParts = [...requiredParts];
                                    newParts[idx].quantity = parseInt(e.target.value) || 1;
                                    setRequiredParts(newParts);
                                },
                                min: 1, 
                                style: { width: 60, padding: '8px', borderRadius: 6, border: '1px solid ' + COLORS.border, textAlign: 'center' }
                            }),
                            
                            // Indicateur stock (seulement si pièce du stock sélectionnée)
                            !isManual && reqPart.part_id && h('div', { style: { display: 'flex', alignItems: 'center', gap: 6, flexWrap: 'wrap' } },
                                h('span', { style: { fontSize: 12, padding: '4px 8px', borderRadius: 6, background: hasEnough ? '#DCFCE7' : '#FEE2E2', color: hasEnough ? '#16A34A' : '#DC2626' } }, 
                                    hasEnough ? `✓ Stock: ${stockQty}` : `✗ Manque: ${missingQty}`
                                ),
                                hasEnough && h('label', { style: { display: 'flex', alignItems: 'center', gap: 4, fontSize: 11, cursor: 'pointer' } },
                                    h('input', { 
                                        type: 'checkbox', 
                                        checked: reqPart.in_stock !== false,
                                        onChange: e => {
                                            const newParts = [...requiredParts];
                                            newParts[idx].in_stock = e.target.checked;
                                            setRequiredParts(newParts);
                                        }
                                    }),
                                    'Sortir'
                                )
                            ),
                            
                            // Badge statut pour les pièces manuelles avec possibilité de toggle
                            isManual && (reqPart.status === 'en-stock' 
                                ? h('button', { 
                                    type: 'button',
                                    onClick: () => {
                                        const newParts = [...requiredParts];
                                        newParts[idx].status = 'en-commande';
                                        setRequiredParts(newParts);
                                    },
                                    style: { fontSize: 11, padding: '4px 8px', borderRadius: 6, background: '#DCFCE7', color: '#16A34A', border: 'none', cursor: 'pointer' },
                                    title: 'Cliquer pour remettre en commande'
                                }, '✓ En stock')
                                : h('button', { 
                                    type: 'button',
                                    onClick: () => {
                                        const newParts = [...requiredParts];
                                        newParts[idx].status = 'en-stock';
                                        setRequiredParts(newParts);
                                    },
                                    style: { fontSize: 11, padding: '4px 8px', borderRadius: 6, background: COLORS.warningPastel, color: COLORS.warning, border: 'none', cursor: 'pointer' },
                                    title: 'Cliquer pour marquer comme reçu'
                                }, '⏳ En commande')
                            ),
                            
                            // Bouton supprimer
                            h('button', { 
                                type: 'button', 
                                onClick: () => setRequiredParts(requiredParts.filter((_, i) => i !== idx)),
                                style: { background: 'none', border: 'none', color: COLORS.danger, cursor: 'pointer', padding: 4 }
                            }, h(Icon, { name: 'x', size: 16 }))
                        );
                    }),
                    h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap', marginTop: 8 } },
                        h('button', { 
                            type: 'button', 
                            className: 'btn btn-secondary btn-sm',
                            onClick: () => setRequiredParts([...requiredParts, { part_id: null, part_ref: '', part_name: '', quantity: 1, in_stock: true, is_manual: false, status: 'en-stock' }])
                        }, h(Icon, { name: 'plus', size: 14 }), ' Depuis le stock'),
                        h('button', { 
                            type: 'button', 
                            className: 'btn btn-sm',
                            style: { background: '#E0E7FF', color: '#4F46E5', border: 'none' },
                            onClick: () => setRequiredParts([...requiredParts, { part_id: null, part_ref: '', part_name: '', quantity: 1, in_stock: false, is_manual: true, status: 'en-commande' }])
                        }, h(Icon, { name: 'edit', size: 14 }), ' Saisie manuelle'),
                        // Affichage du statut global des pièces
                        (() => {
                            const allInStock = requiredParts.length > 0 && requiredParts.every(p => {
                                if (p.is_manual) return p.status === 'en-stock';
                                if (!p.part_id) return true;
                                const stockPart = data.parts.find(sp => sp.id === p.part_id);
                                return (stockPart?.quantity || 0) >= p.quantity;
                            });
                            const someInCommand = requiredParts.some(p => {
                                if (p.is_manual) return p.status === 'en-commande';
                                if (!p.part_id) return false;
                                const stockPart = data.parts.find(sp => sp.id === p.part_id);
                                return (stockPart?.quantity || 0) < p.quantity;
                            });
                            if (requiredParts.length === 0) return null;
                            return h('span', { 
                                style: { 
                                    marginLeft: 8, 
                                    padding: '4px 10px', 
                                    borderRadius: 6, 
                                    fontSize: 11, 
                                    fontWeight: 600,
                                    background: allInStock ? '#DCFCE7' : '#FEF3C7',
                                    color: allInStock ? '#16A34A' : '#D97706'
                                }
                            }, allInStock ? '✓ Toutes en stock → Statut: En stock' : '⏳ Pièces en commande → Statut: En commande');
                        })(),
                        // Bouton Commander les pièces manquantes
                        (() => {
                            const missingParts = requiredParts.filter(p => {
                                if (p.is_manual) return p.status === 'en-commande'; // Pièces manuelles seulement si à commander
                                if (!p.part_id) return false;
                                const stockPart = data.parts.find(sp => sp.id === p.part_id);
                                return (stockPart?.quantity || 0) < p.quantity;
                            });
                            if (missingParts.length === 0) return null;
                            
                            const openOrderPreview = () => {
                                const items = missingParts.map(p => {
                                    if (p.is_manual) {
                                        return { ref: p.part_ref || 'N/A', name: p.part_name || 'Pièce manuelle', quantity: p.quantity };
                                    }
                                    const stockPart = data.parts.find(sp => sp.id === p.part_id);
                                    const stockQty = stockPart?.quantity || 0;
                                    const missingQty = p.quantity - stockQty;
                                    return { part_id: p.part_id, part_ref: p.part_ref, part_name: p.part_name, quantity: missingQty > 0 ? missingQty : p.quantity };
                                });
                                setOrderPreview({
                                    name: `Pièces manquantes - ${form.device_number || 'Travail'}`,
                                    items: items,
                                    onConfirm: async (finalOrder) => {
                                        try {
                                            const orderData = {
                                                name: finalOrder.name,
                                                items: JSON.stringify(finalOrder.items),
                                                status: 'en-commande'
                                            };
                                            const { error } = await db.from('orders').insert(orderData);
                                            if (error) throw error;
                                            showToast(`Commande créée pour ${finalOrder.items.length} pièce(s)`);
                                            setOrderPreview(null);
                                            refresh();
                                        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
                                    }
                                });
                            };
                            
                            return h('button', {
                                type: 'button',
                                className: 'btn btn-warning btn-sm',
                                onClick: openOrderPreview
                            }, h(Icon, { name: 'cart', size: 14 }), ` Commander ${missingParts.length} pièce(s) manquante(s)`);
                        })()
                    ),
                    requiredParts.length > 0 && requiredParts.some(p => p.part_id && p.in_stock) && h('div', { style: { marginTop: 10, padding: 8, background: '#FEF3C7', borderRadius: 6, fontSize: 12, color: '#92400E' } },
                        '⚠️ Les pièces cochées "Sortir" seront automatiquement déduites du stock à la création du travail.'
                    )
                )
            ),
            // PDF
            h('div', { className: 'form-group' }, 
                h('label', { className: 'form-label' }, 'Document PDF (optionnel)'),
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('input', { 
                        type: 'file', 
                        accept: '.pdf',
                        onChange: handlePdfUpload,
                        id: 'task-pdf-input',
                        style: { display: 'none' }
                    }),
                    h('label', { htmlFor: 'task-pdf-input', className: 'btn btn-secondary btn-sm', style: { cursor: 'pointer', margin: 0 } }, h(Icon, { name: 'upload', size: 14 }), ' Choisir un PDF'),
                    form.attachments && h('span', { style: { fontSize: 13, color: COLORS.success } }, '📄 ', form.attachments),
                    form.attachments && h('button', { type: 'button', className: 'btn btn-ghost btn-sm', onClick: () => setForm(prevForm => ({...prevForm, attachments: ''})), style: { color: COLORS.danger } }, h(Icon, { name: 'x', size: 14 }))
                )
            )
        );
    };
    
    const TaskCard = ({ task }) => {
        const statusOpt = statusOptions.find(s => s.value === task.status) || statusOptions[0];
        const assignedTech = technicians.find(t => t.id === task.assigned_to);
        const workItems = parseWorkList(task.work_list);
        const ps = getPartsStatus(task.work_list);
        
        return h('div', { className: 'card' },
            h('div', { className: 'card-body' },
                // En-tête cliquable pour voir les détails
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12, cursor: 'pointer' }, onClick: () => setViewTask(task) },
                    h('div', null,
                        h('div', { style: { fontFamily: 'monospace', fontWeight: 700, fontSize: 18, color: COLORS.primary, marginBottom: 4 } }, task.device_number),
                        h('div', { style: { fontSize: 13, color: COLORS.muted } }, task.location || '-')
                    ),
                    h('span', { className: `badge badge-${statusOpt.color}` }, statusOpt.label)
                ),
                // Badges: tournée + planifié + statut pièces + priorité
                h('div', { style: { display: 'flex', gap: 6, marginBottom: 12, flexWrap: 'wrap' } },
                    task.tournee && h('span', { className: 'badge badge-info' }, task.tournee),
                    task.scheduled_date && h('span', { className: 'badge badge-purple', style: { display: 'flex', alignItems: 'center', gap: 4 } }, h(Icon, { name: 'planning', size: 12 }), formatDate(task.scheduled_date)),
                    h('span', { className: `badge badge-${ps.color}` }, ps.label),
                    task.priority && task.priority !== 'normal' && h('span', { className: `badge badge-${priorityColors[task.priority] || 'info'}` }, priorityLabels[task.priority] || task.priority)
                ),
                // Aperçu des travaux (comme l'ancienne version)
                workItems.length > 0 && h('div', { style: { marginBottom: 12, padding: 10, background: COLORS.background, borderRadius: 8, fontSize: 13, cursor: 'pointer' }, onClick: () => setViewTask(task) },
                    workItems.slice(0, 3).map((item, i) => h('div', { key: i, style: { display: 'flex', alignItems: 'center', gap: 6, marginBottom: i < Math.min(workItems.length, 3) - 1 ? 4 : 0 } },
                        h('span', { style: { 
                            width: 8, height: 8, borderRadius: '50%', flexShrink: 0,
                            background: item.status === 'EN STOCK' ? COLORS.success : 
                                        item.status === 'EN COMMANDE' ? COLORS.warning : 
                                        item.status === 'EFFECTUÉ' ? '#8B5CF6' : 
                                        item.status === 'PRÊT' ? COLORS.info :
                                        item.status === 'PARTIEL' ? '#EA580C' :
                                        item.status === 'NON CONFORME' ? '#DC2626' : '#94a3b8'
                        } }),
                        h('span', { style: { overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, item.text || '(sans description)')
                    )),
                    workItems.length > 3 && h('div', { style: { color: COLORS.muted, fontSize: 12, marginTop: 4 } }, '+', workItems.length - 3, ' autre(s)...')
                ),
                // Pied: technicien + actions
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: 13, color: COLORS.muted } },
                    h('span', null, assignedTech ? (assignedTech.first_name + ' ' + assignedTech.last_name).trim() : 'Non assigné'),
                    h('div', { style: { display: 'flex', gap: 6 }, onClick: e => e.stopPropagation() },
                        canTerminateTask(task) && h('button', { className: 'btn btn-success btn-sm', onClick: () => handleStatusChange(task, 'termine') }, 'Terminer'),
                        user.role === 'admin' && task.status === 'termine' && h('button', { className: 'btn btn-secondary btn-sm', onClick: () => archiveTask(task), title: 'Archiver' }, h(Icon, { name: 'archive', size: 14 })),
                        canEdit && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setEditTask(task), title: 'Modifier' }, h(Icon, { name: 'edit', size: 14 })),
                        user.role === 'admin' && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setDeleteConfirm(task), style: { color: COLORS.danger }, title: 'Supprimer' }, h(Icon, { name: 'trash', size: 14 }))
                    )
                )
            )
        );
    };
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' }, h('h1', { className: 'page-title' }, 'Travaux'), h('p', { className: 'page-subtitle' }, `${filteredTasks.length} travaux`)),
            h('div', { className: 'page-actions' },
                // v5.5 - Bouton vue sauvegardée
                h('button', { 
                    className: 'btn btn-ghost', 
                    onClick: () => {
                        SavedViewsSystem.saveView('tasks', { search, statusFilter, viewMode: currentViewMode });
                        showToast('Vue sauvegardée', 'success');
                    },
                    title: 'Sauvegarder la vue actuelle'
                }, '💾'),
                // v5.8 - ViewSwitcher
                h(ViewSwitcher, {
                    currentView: currentViewMode,
                    views: [
                        { id: 'table', icon: '📋', label: 'Tableau' },
                        { id: 'grid', icon: '🔲', label: 'Grille' }
                    ],
                    onChange: setCurrentViewMode
                }),
                h('button', { className: 'btn btn-secondary', onClick: () => setShowExportOptions(true) }, h(Icon, { name: 'pdf', size: 16 }), 'Export PDF'),
                user.role === 'admin' && h('button', { className: 'btn btn-secondary', onClick: () => setShowArchives(true) }, h(Icon, { name: 'archive', size: 16 }), 'Archives'),
                canEdit && h('button', { className: 'btn btn-primary', onClick: () => setShowAdd(true) }, h(Icon, { name: 'plus', size: 18 }), 'Nouveau')
            )
        ),
        // v5.8 - Menu contextuel
        contextMenu.show && h(QuickActionsMenu, {
            isOpen: contextMenu.show,
            position: { x: contextMenu.x, y: contextMenu.y },
            type: 'task',
            item: contextMenu.task,
            onAction: (actionId, item) => {
                if (actionId === 'view') setViewTask(item);
                else if (actionId === 'edit') setEditTask(item);
                else if (actionId === 'complete') handleStatusChange(item, 'termine');
                else if (actionId === 'delete') setDeleteConfirm(item);
            },
            onClose: () => setContextMenu({ show: false, x: 0, y: 0, task: null })
        }),
        // v5.8 - Barre actions groupées
        selectedTasks.length > 0 && h(BulkActionsBar, {
            selectedCount: selectedTasks.length,
            type: 'tasks',
            onAction: async (actionId) => {
                if (actionId === 'complete') {
                    for (const id of selectedTasks) {
                        const task = data.tasks.find(t => t.id === id);
                        if (task) await handleStatusChange(task, 'termine');
                    }
                    setSelectedTasks([]);
                } else if (actionId === 'export') {
                    showToast(`${selectedTasks.length} tâche(s) exportée(s)`, 'success');
                } else if (actionId === 'delete') {
                    if (confirm(`Supprimer ${selectedTasks.length} tâche(s) ?`)) {
                        for (const id of selectedTasks) {
                            await db.from('tasks').delete().eq('id', id);
                        }
                        showToast(`${selectedTasks.length} tâche(s) supprimée(s)`, 'success');
                        setSelectedTasks([]);
                        refresh();
                    }
                }
            },
            onClear: () => setSelectedTasks([])
        }),
        h('div', { className: 'card' },
            h('div', { className: 'card-header' },
                h('div', { className: 'header-search', style: { width: 300 } }, h(Icon, { name: 'search', size: 18, color: COLORS.muted }), h('input', { type: 'text', placeholder: 'Rechercher...', value: search, onChange: e => setSearch(e.target.value) })),
                h('div', { className: 'filters' }, h('button', { className: `filter-btn ${statusFilter === 'all' ? 'active' : ''}`, onClick: () => setStatusFilter('all') }, 'Tous'), statusOptions.map(s => h('button', { key: s.value, className: `filter-btn ${statusFilter === s.value ? 'active' : ''}`, onClick: () => setStatusFilter(s.value) }, s.label))),
                // v5.8 - Compteur sélection
                selectedTasks.length > 0 && h('span', { style: { background: COLORS.primary, color: 'white', padding: '4px 12px', borderRadius: 20, fontSize: 13, fontWeight: 600 } }, `${selectedTasks.length} sélectionné(s)`)
            ),
            currentViewMode === 'table' ? h('div', { className: 'table-container', style: { overflowX: 'auto' } },
                h('table', { style: { tableLayout: 'fixed', width: '100%' } },
                    h('thead', null, h('tr', null, 
                        // v5.8 - Checkbox sélection tout
                        h('th', { style: { width: 40, textAlign: 'center' } },
                            h('input', { 
                                type: 'checkbox',
                                checked: selectedTasks.length === filteredTasks.length && filteredTasks.length > 0,
                                onChange: (e) => {
                                    if (e.target.checked) {
                                        setSelectedTasks(filteredTasks.map(t => t.id));
                                    } else {
                                        setSelectedTasks([]);
                                    }
                                },
                                style: { cursor: 'pointer', width: 18, height: 18 }
                            })
                        ),
                        h('th', { style: { width: 40 } }, ''),
                        resizableCols.map(col => {
                            const colProps = getColumnProps(col.key);
                            if (col.key === 'device_number') {
                                return h(FilterableTh, { key: col.key, label: 'Appareil', filterKey: 'device_number', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                            }
                            if (col.key === 'site_name') {
                                return h(FilterableTh, { key: col.key, label: 'Lieu', filterKey: 'site_name', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                            }
                            if (col.key === 'assigned_to') {
                                return h(FilterableTh, { key: col.key, label: 'Technicien', filterKey: 'assigned_to', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                            }
                            if (col.key === 'status') {
                                return h(FilterableTh, { key: col.key, label: 'Statut', filterKey: 'status', filters: columnFilters, setFilters: setColumnFilters, type: 'select', options: statusOptions.map(s => ({ value: s.value, label: s.label })), ...colProps });
                            }
                            if (col.key === 'priority') {
                                return h(FilterableTh, { key: col.key, label: 'Priorité', filterKey: 'priority', filters: columnFilters, setFilters: setColumnFilters, type: 'select', options: [
                                    { value: 'urgente', label: 'Urgente' },
                                    { value: 'haute', label: 'Haute' },
                                    { value: 'normal', label: 'Normale' },
                                    { value: 'basse', label: 'Basse' }
                                ], ...colProps });
                            }
                            if (col.key === 'due_date') {
                                return h(FilterableTh, { key: col.key, label: 'Planifié', filterKey: null, filters: null, setFilters: null, ...colProps });
                            }
                            if (col.key === 'actions') {
                                return h(FilterableTh, { key: col.key, label: 'Actions', filterKey: null, filters: null, setFilters: null, ...colProps });
                            }
                            return null;
                        }).filter(Boolean)
                    )),
                    h('tbody', null,
                        filteredTasks.length === 0 ? h('tr', null, h('td', { colSpan: resizableCols.length + 1, style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun travail')) :
                        filteredTasks.map(task => {
                            const statusOpt = statusOptions.find(s => s.value === task.status) || statusOptions[0];
                            const assignedTech = technicians.find(t => t.id === task.assigned_to);
                            const workItems = parseWorkList(task.work_list);
                            const ps = getPartsStatus(task.work_list);
                            
                            const renderCell = (colKey) => {
                                const col = resizableCols.find(c => c.key === colKey);
                                const width = col?.width;
                                
                                switch(colKey) {
                                    case 'device_number':
                                        return h('td', { key: colKey, style: { width } }, h('strong', { style: { fontFamily: 'monospace', fontSize: 16 } }, task.device_number));
                                    case 'site_name':
                                        return h('td', { key: colKey, style: { width } }, task.location || task.tournee || '-');
                                    case 'assigned_to':
                                        return h('td', { key: colKey, style: { width } }, assignedTech ? h('span', { style: { fontSize: 13 } }, (assignedTech.first_name || '') + ' ' + (assignedTech.last_name || '')) : h('span', { style: { color: COLORS.muted, fontSize: 12 } }, 'Non assigné'));
                                    case 'status':
                                        return h('td', { key: colKey, style: { width } }, h('span', { className: `badge badge-${statusOpt.color}` }, statusOpt.label));
                                    case 'priority':
                                        return h('td', { key: colKey, style: { width } }, h('span', { className: `badge badge-${priorityColors[task.priority] || 'info'}` }, priorityLabels[task.priority] || 'Normale'));
                                    case 'due_date':
                                        return h('td', { key: colKey, style: { width } }, task.scheduled_date ? h('span', { className: 'badge badge-purple', style: { display: 'flex', alignItems: 'center', gap: 4 } }, h(Icon, { name: 'planning', size: 12 }), formatDate(task.scheduled_date)) : h('span', { style: { color: COLORS.muted, fontSize: 12 } }, '-'));
                                    case 'actions':
                                        return h('td', { key: colKey, style: { width } }, h('div', { className: 'table-actions' }, 
                                            canTerminateTask(task) && h('button', { className: 'btn btn-success btn-sm', onClick: () => handleStatusChange(task, 'termine'), title: 'Terminer' }, '✓'),
                                            user.role === 'admin' && task.status === 'termine' && h('button', { className: 'btn btn-secondary btn-sm', onClick: () => archiveTask(task), title: 'Archiver' }, h(Icon, { name: 'archive', size: 14 })),
                                            h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setViewTask(task) }, h(Icon, { name: 'eye', size: 16 })), 
                                            canEdit && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setEditTask(task) }, h(Icon, { name: 'edit', size: 16 })), 
                                            user.role === 'admin' && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setDeleteConfirm(task), style: { color: COLORS.danger } }, h(Icon, { name: 'trash', size: 16 }))));
                                    default:
                                        return h('td', { key: colKey }, '-');
                                }
                            };
                            
                            const isSelected = selectedTasks.includes(task.id);
                            
                            return h('tr', { 
                                key: task.id,
                                style: { 
                                    background: isSelected ? COLORS.primaryPastel : undefined,
                                    cursor: 'pointer'
                                },
                                onContextMenu: (e) => {
                                    e.preventDefault();
                                    setContextMenu({ show: true, x: e.clientX, y: e.clientY, task });
                                },
                                onClick: (e) => {
                                    if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                                        setViewTask(task);
                                    }
                                }
                            },
                                // Checkbox
                                h('td', { style: { width: 40, textAlign: 'center' }, onClick: e => e.stopPropagation() },
                                    h('input', { 
                                        type: 'checkbox',
                                        checked: isSelected,
                                        onChange: (e) => {
                                            if (e.target.checked) {
                                                setSelectedTasks([...selectedTasks, task.id]);
                                            } else {
                                                setSelectedTasks(selectedTasks.filter(id => id !== task.id));
                                            }
                                        },
                                        style: { cursor: 'pointer', width: 18, height: 18 }
                                    })
                                ),
                                h('td', null, h('div', { className: `status-dot ${statusOpt.color === 'success' ? 'completed' : statusOpt.color === 'info' ? 'in-progress' : 'pending'}` })),
                                resizableCols.map(col => renderCell(col.key))
                            );
                        })
                    )
                )
            ) : h('div', { style: { padding: 16 } },
                filteredTasks.length === 0 ? h('div', { className: 'empty-state' }, h('p', null, 'Aucun travail')) :
                h('div', { className: 'grid-view' }, filteredTasks.map(task => {
                    const isSelected = selectedTasks.includes(task.id);
                    const statusOpt = statusOptions.find(s => s.value === task.status) || statusOptions[0];
                    const assignedTech = technicians.find(t => t.id === task.assigned_to);
                    return h('div', { 
                        key: task.id, 
                        className: 'grid-card hover-lift',
                        style: { border: isSelected ? `2px solid ${COLORS.primary}` : undefined },
                        onClick: () => setViewTask(task),
                        onContextMenu: (e) => {
                            e.preventDefault();
                            setContextMenu({ show: true, x: e.clientX, y: e.clientY, task });
                        }
                    },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                            h('input', { 
                                type: 'checkbox',
                                checked: isSelected,
                                onChange: (e) => {
                                    e.stopPropagation();
                                    if (e.target.checked) {
                                        setSelectedTasks([...selectedTasks, task.id]);
                                    } else {
                                        setSelectedTasks(selectedTasks.filter(id => id !== task.id));
                                    }
                                },
                                onClick: e => e.stopPropagation(),
                                style: { cursor: 'pointer', width: 18, height: 18 }
                            }),
                            h('span', { className: `badge badge-${statusOpt.color}` }, statusOpt.label)
                        ),
                        h('div', { style: { fontWeight: 700, fontSize: 18, marginBottom: 4 } }, task.device_number),
                        h('div', { style: { color: COLORS.textSecondary, marginBottom: 8 } }, task.location || task.tournee || '-'),
                        assignedTech && h('div', { style: { fontSize: 13, color: COLORS.muted } }, '👤 ' + (assignedTech.first_name || '') + ' ' + (assignedTech.last_name || '')),
                        task.scheduled_date && h('div', { style: { fontSize: 12, color: COLORS.primary, marginTop: 8 } }, '📅 ' + formatDate(task.scheduled_date))
                    );
                }))
            )
        ),
        viewTask && h(Modal, { isOpen: true, onClose: () => setViewTask(null), title: viewTask.device_number, size: 'lg',
            footer: h(Fragment, null,
                canTerminateTask(viewTask) && h('button', { className: 'btn btn-success', onClick: () => { handleStatusChange(viewTask, 'termine'); setViewTask({ ...viewTask, status: 'termine' }); } }, '✓ Terminer'),
                viewTask.status === 'termine' && user.role === 'admin' && h('button', { className: 'btn btn-secondary', onClick: () => archiveTask(viewTask) }, h(Icon, { name: 'archive', size: 16 }), 'Archiver'),
                canEdit && h('button', { className: 'btn btn-secondary', onClick: () => { setEditTask(viewTask); setViewTask(null); } }, h(Icon, { name: 'edit', size: 16 }), 'Modifier'),
                user.role === 'admin' && h('button', { className: 'btn btn-danger', onClick: () => { setDeleteConfirm(viewTask); setViewTask(null); } }, h(Icon, { name: 'trash', size: 16 }), 'Supprimer')
            )
        }, 
            // Badges en haut
            h('div', { style: { display: 'flex', gap: 8, marginBottom: 20, flexWrap: 'wrap' } },
                h('span', { className: `badge badge-${statusOptions.find(s => s.value === viewTask.status)?.color || 'muted'}` }, statusOptions.find(s => s.value === viewTask.status)?.label || 'Non défini'),
                viewTask.tournee && h('span', { className: 'badge badge-info' }, viewTask.tournee),
                viewTask.scheduled_date && h('span', { className: 'badge badge-purple', style: { display: 'flex', alignItems: 'center', gap: 4 } }, h(Icon, { name: 'planning', size: 12 }), 'Planifié: ', formatDate(viewTask.scheduled_date)),
                h('span', { className: `badge badge-${getPartsStatus(viewTask.work_list).color}` }, getPartsStatus(viewTask.work_list).label),
                viewTask.priority && viewTask.priority !== 'normal' && h('span', { className: `badge badge-${priorityColors[viewTask.priority] || 'info'}` }, priorityLabels[viewTask.priority])
            ),
            // Infos
            h('div', { className: 'info-grid', style: { marginBottom: 20 } },
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Lieu'), h('div', { className: 'info-value' }, viewTask.location || '-')),
                h('div', { className: 'info-item' }, 
                    h('div', { className: 'info-label' }, 'Technicien'),
                    canEdit ? h('select', { 
                        value: viewTask.assigned_to || '', 
                        onChange: async (e) => {
                            const newTech = e.target.value || null;
                            try {
                                await db.from('tasks').update({ assigned_to: newTech }).eq('id', viewTask.id);
                                setViewTask({ ...viewTask, assigned_to: newTech });
                                showToast('Technicien modifié');
                                refresh();
                            } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
                        },
                        style: { padding: '6px 10px', borderRadius: 8, border: `1px solid ${COLORS.border}`, fontSize: 14 }
                    },
                        h('option', { value: '' }, '-- Non assigné --'),
                        technicians.map(t => h('option', { key: t.id, value: t.id }, (t.first_name + ' ' + t.last_name).trim()))
                    ) : h('div', { className: 'info-value' }, (() => { const tech = technicians.find(t => t.id === viewTask.assigned_to); return tech ? (tech.first_name + ' ' + tech.last_name).trim() : '-'; })())
                )
            ),
            // Travaux à effectuer (avec sélecteurs pour techniciens)
            viewTask.work_list && h('div', { style: { marginBottom: 20 } },
                h('div', { style: { fontWeight: 600, marginBottom: 12, display: 'flex', alignItems: 'center', justifyContent: 'space-between' } }, 
                    'Travaux à effectuer',
                    canEdit && h('span', { style: { fontSize: 11, color: COLORS.muted, fontWeight: 'normal' } }, '(cliquez sur le statut pour modifier)')
                ),
                h('div', { className: 'work-list' }, parseWorkList(viewTask.work_list).map((item, i) => {
                    const workStatuses = ['NON DÉFINI', 'EN STOCK', 'EN COMMANDE', 'PRÊT', 'EFFECTUÉ', 'PARTIEL', 'NON CONFORME'];
                    const statusColors = {
                        'NON DÉFINI': { bg: '#F1F5F9', color: '#64748B' },
                        'EN STOCK': { bg: '#D1FAE5', color: '#059669' },
                        'EN COMMANDE': { bg: '#FEF3C7', color: '#D97706' },
                        'PRÊT': { bg: '#DBEAFE', color: '#1D4ED8' },
                        'EFFECTUÉ': { bg: '#E0E7FF', color: '#4338CA' },
                        'PARTIEL': { bg: '#FED7AA', color: '#EA580C' },
                        'NON CONFORME': { bg: '#FEE2E2', color: '#DC2626' }
                    };
                    
                    const updateWorkItemStatus = async (newStatus) => {
                        const items = parseWorkList(viewTask.work_list);
                        items[i] = { ...items[i], status: newStatus };
                        const newWorkList = buildWorkListString(items);
                        const autoStatus = calculateAutoStatus(newWorkList);
                        
                        try {
                            const updateData = { work_list: newWorkList };
                            if (autoStatus) updateData.status = autoStatus;
                            await db.from('tasks').update(updateData).eq('id', viewTask.id);
                            setViewTask({ ...viewTask, work_list: newWorkList, status: autoStatus || viewTask.status });
                            showToast('Statut mis à jour');
                            refresh();
                        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
                    };
                    
                    // Options selon le rôle: technicien = seulement Effectué/Partiel/Non conforme, admin = tout
                    const availableStatuses = user.role === 'admin' ? workStatuses : ['EFFECTUÉ', 'PARTIEL', 'NON CONFORME'];
                    // Si le statut actuel n'est pas dans les options disponibles, l'ajouter pour l'affichage
                    const displayStatuses = availableStatuses.includes(item.status) ? availableStatuses : [item.status, ...availableStatuses];
                    // Technicien ne peut pas modifier si EN COMMANDE
                    const canModifyStatus = canEdit && !(user.role === 'technicien' && item.status === 'EN COMMANDE');
                    
                    return h('div', { key: i, style: { background: item.status === 'NON CONFORME' ? '#FEF2F2' : item.status === 'PARTIEL' ? '#FFF7ED' : COLORS.background, borderRadius: 10, marginBottom: 8, border: item.status === 'NON CONFORME' ? '2px solid #FCA5A5' : item.status === 'PARTIEL' ? '2px solid #FDBA74' : 'none' } },
                        h('div', { className: 'work-item', style: { display: 'flex', alignItems: 'center', gap: 10, padding: '10px 14px' } }, 
                            canModifyStatus ? h('select', { 
                                value: item.status, 
                                onChange: e => updateWorkItemStatus(e.target.value),
                                style: { 
                                    padding: '4px 6px', 
                                    borderRadius: 6, 
                                    border: 'none', 
                                    fontWeight: 600, 
                                    fontSize: 10, 
                                    minWidth: 100,
                                    cursor: 'pointer',
                                    backgroundColor: statusColors[item.status]?.bg || '#F1F5F9',
                                    color: statusColors[item.status]?.color || '#64748B'
                                } 
                            }, 
                                displayStatuses.map(s => h('option', { key: s, value: s }, s))
                            ) : h('span', { 
                                style: { 
                                    padding: '4px 10px', 
                                    borderRadius: 6, 
                                    fontSize: 11, 
                                    fontWeight: 600, 
                                    whiteSpace: 'nowrap',
                                    backgroundColor: statusColors[item.status]?.bg || '#F1F5F9',
                                    color: statusColors[item.status]?.color || '#64748B'
                                } 
                            }, item.status),
                            h('span', { style: { flex: 1 } }, item.text)
                        ),
                        // Afficher remarque si PARTIEL
                        item.status === 'PARTIEL' && item.remark && h('div', { style: { padding: '0 14px 14px 14px' } },
                            h('div', { style: { padding: 10, background: 'white', borderRadius: 8, border: '1px solid #FDBA74' } },
                                h('div', { style: { fontSize: 11, color: '#EA580C', fontWeight: 600, marginBottom: 4 } }, '📝 Raison:'),
                                h('p', { style: { fontSize: 13, margin: 0 } }, item.remark)
                            )
                        ),
                        // Afficher remarque et photos si NON CONFORME
                        item.status === 'NON CONFORME' && (item.remark || (item.photos && item.photos.length > 0)) && h('div', { style: { padding: '0 14px 14px 14px' } },
                            item.remark && h('div', { style: { marginBottom: 8, padding: 10, background: 'white', borderRadius: 8, border: '1px solid #FCA5A5' } },
                                h('div', { style: { fontSize: 11, color: '#DC2626', fontWeight: 600, marginBottom: 4 } }, '⚠️ Remarque:'),
                                h('p', { style: { fontSize: 13, margin: 0 } }, item.remark)
                            ),
                            item.photos && item.photos.length > 0 && h('div', null,
                                h('div', { style: { fontSize: 11, color: '#DC2626', fontWeight: 600, marginBottom: 4 } }, '📷 Photos:'),
                                h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                                    item.photos.map((photo, pi) => {
                                        // Valider que la photo est une chaîne non vide
                                        if (!photo || typeof photo !== 'string' || photo.length < 10) {
                                            return h('div', { 
                                                key: pi,
                                                style: { width: 100, height: 100, background: '#FEE2E2', borderRadius: 8, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, color: '#DC2626', textAlign: 'center', padding: 8 }
                                            }, '⚠️ Image invalide');
                                        }
                                        return h('div', { 
                                            key: pi,
                                            style: { position: 'relative' }
                                        },
                                            h('img', { 
                                                src: photo, 
                                                style: { width: 100, height: 100, objectFit: 'cover', borderRadius: 8, border: '2px solid #FCA5A5', cursor: 'pointer' },
                                                onClick: () => {
                                                    // Ouvrir dans une nouvelle fenêtre si c'est une data URL valide
                                                    if (photo.startsWith('data:') || photo.startsWith('http')) {
                                                        window.open(photo, '_blank');
                                                    }
                                                },
                                                onError: (e) => {
                                                    // Remplacer par un placeholder en cas d'erreur
                                                    e.target.style.display = 'none';
                                                    e.target.parentNode.style.background = '#FEE2E2';
                                                    e.target.parentNode.style.display = 'flex';
                                                    e.target.parentNode.style.alignItems = 'center';
                                                    e.target.parentNode.style.justifyContent = 'center';
                                                    const errorDiv = document.createElement('div');
                                                    errorDiv.innerHTML = '⚠️<br><span style="font-size:9px">Erreur</span>';
                                                    errorDiv.style.cssText = 'text-align:center;color:#DC2626;font-size:20px;';
                                                    e.target.parentNode.appendChild(errorDiv);
                                                }
                                            }),
                                            h('button', {
                                                style: { 
                                                    position: 'absolute', bottom: 4, right: 4, 
                                                    background: 'rgba(0,0,0,0.7)', color: 'white',
                                                    border: 'none', borderRadius: 4, padding: '2px 6px',
                                                    fontSize: 10, cursor: 'pointer'
                                                },
                                                onClick: (e) => {
                                                    e.stopPropagation();
                                                    window.dispatchEvent(new CustomEvent('open-photo-annotator', { 
                                                        detail: { url: photo, relatedType: 'task', relatedId: viewTask.id }
                                                    }));
                                                }
                                            }, '✏️')
                                        );
                                    })
                                )
                            )
                        )
                    );
                }))
            ),
            // Pièces utilisées (format JSON)
            viewTask.required_parts && (() => { 
                try {
                    const parts = JSON.parse(viewTask.required_parts); 
                    if (parts.length === 0) return null;
                    return h('div', { style: { marginBottom: 20 } },
                        h('div', { style: { fontWeight: 600, marginBottom: 12, color: '#16A34A', display: 'flex', alignItems: 'center', gap: 8 } }, '🔧 Pièces nécessaires'),
                        h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                            parts.map((p, i) => {
                                const isEnStock = p.status === 'en-stock' || (p.in_stock && !p.is_manual);
                                const isEnCommande = p.status === 'en-commande' || (p.is_manual && p.status !== 'en-stock');
                                return h('div', { key: i, style: { 
                                    display: 'flex', alignItems: 'center', gap: 10, padding: '10px 14px', 
                                    background: isEnStock ? '#DCFCE7' : isEnCommande ? '#FEF3C7' : COLORS.background, 
                                    borderRadius: 10, 
                                    border: '1px solid ' + (isEnStock ? '#86EFAC' : isEnCommande ? '#FDE68A' : COLORS.border) 
                                } },
                                    h('span', { style: { fontFamily: 'monospace', fontWeight: 600, color: COLORS.primary } }, p.part_ref || '-'),
                                    h('span', { style: { flex: 1 } }, p.part_name),
                                    h('span', { style: { padding: '4px 10px', borderRadius: 6, background: '#DBEAFE', color: '#1D4ED8', fontSize: 12, fontWeight: 600 } }, 'x', p.quantity),
                                    isEnStock && h('span', { style: { fontSize: 11, padding: '4px 8px', borderRadius: 6, background: '#16A34A', color: 'white' } }, '✓ En stock'),
                                    isEnCommande && h('span', { style: { fontSize: 11, padding: '4px 8px', borderRadius: 6, background: '#D97706', color: 'white' } }, '⏳ En commande')
                                );
                            })
                        )
                    );
                } catch(e) { return null; }
            })(),
            // Photos annotées
            h('div', { style: { marginBottom: 20 } },
                h('div', { style: { fontWeight: 600, marginBottom: 12, display: 'flex', alignItems: 'center', justifyContent: 'space-between' } }, 
                    h('span', { style: { display: 'flex', alignItems: 'center', gap: 8 } }, 
                        '🖼️ Photos annotées',
                        taskAnnotatedPhotos.length > 0 && h('span', { className: 'badge badge-info' }, taskAnnotatedPhotos.length)
                    ),
                    h('button', { 
                        className: 'btn btn-secondary btn-sm',
                        onClick: () => {
                            // Ouvrir l'annotateur avec une nouvelle photo vide
                            const input = document.createElement('input');
                            input.type = 'file';
                            input.accept = 'image/*';
                            input.onchange = (e) => {
                                const file = e.target.files[0];
                                if (file) {
                                    const url = URL.createObjectURL(file);
                                    window.dispatchEvent(new CustomEvent('open-photo-annotator', { 
                                        detail: { url, relatedType: 'task', relatedId: viewTask.id }
                                    }));
                                }
                            };
                            input.click();
                        }
                    }, h(Icon, { name: 'plus', size: 14 }), ' Annoter une photo')
                ),
                loadingPhotos ? 
                    h('div', { style: { textAlign: 'center', padding: 20, color: COLORS.muted } }, 'Chargement...') :
                taskAnnotatedPhotos.length === 0 ? 
                    h('div', { style: { textAlign: 'center', padding: 20, color: COLORS.muted, background: COLORS.background, borderRadius: 8 } }, 
                        'Aucune photo annotée pour ce travail'
                    ) :
                    h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(150px, 1fr))', gap: 12 } },
                        taskAnnotatedPhotos.map(photo => h('div', { 
                            key: photo.id, 
                            style: { 
                                position: 'relative', 
                                borderRadius: 8, 
                                overflow: 'hidden',
                                border: `2px solid ${COLORS.border}`,
                                background: COLORS.background
                            }
                        },
                            h('img', { 
                                src: photo.annotated_url || photo.annotated_data,
                                style: { width: '100%', height: 120, objectFit: 'cover', cursor: 'pointer' },
                                onClick: () => window.open(photo.annotated_url || photo.annotated_data, '_blank'),
                                onError: (e) => { e.target.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="120"><rect fill="%23f1f5f9" width="150" height="120"/><text x="50%" y="50%" text-anchor="middle" fill="%2394a3b8" font-size="12">Erreur</text></svg>'; }
                            }),
                            h('div', { style: { padding: '6px 8px', fontSize: 11, color: COLORS.muted, display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                                h('span', null, photo.created_at ? new Date(photo.created_at).toLocaleDateString('fr-FR') : 'Local'),
                                photo.source === 'local' && h('span', { className: 'badge badge-warning', style: { fontSize: 9 } }, 'Local')
                            )
                        ))
                    )
            ),
            // Changer le statut
            canEdit && h('div', null,
                h('div', { style: { fontWeight: 600, marginBottom: 12 } }, 'Changer le statut'),
                h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                    statusOptions.map(s => h('button', { 
                        key: s.value, 
                        className: `btn btn-sm ${viewTask.status === s.value ? 'btn-primary' : 'btn-secondary'}`, 
                        onClick: async () => {
                            try {
                                await db.from('tasks').update({ status: s.value }).eq('id', viewTask.id);
                                setViewTask({ ...viewTask, status: s.value });
                                showToast('Statut mis à jour');
                                refresh();
                            } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
                        }
                    }, s.label))
                )
            )
        ),
        (showAdd || editTask) && h(TaskFormModal, { task: editTask, onClose: () => { setShowAdd(false); setEditTask(null); }, onSave: handleSaveTask }),
        deleteConfirm && h(ConfirmDialog, { isOpen: true, onClose: () => setDeleteConfirm(null), onConfirm: () => handleDelete(deleteConfirm), title: 'Supprimer ce travail ?', message: `Appareil: ${deleteConfirm.device_number}`, confirmText: 'Supprimer', type: 'danger' }),
        // Modal de prévisualisation de commande
        orderPreview && h(Modal, { isOpen: true, onClose: () => setOrderPreview(null), title: '📦 Nouvelle commande', size: 'lg',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => setOrderPreview(null) }, 'Annuler'),
                h('button', { className: 'btn btn-primary', onClick: () => {
                    const name = document.getElementById('order-preview-name')?.value || orderPreview.name;
                    const itemInputs = document.querySelectorAll('.order-preview-qty');
                    const updatedItems = orderPreview.items.map((item, idx) => ({
                        ...item,
                        quantity: parseInt(itemInputs[idx]?.value) || item.quantity
                    })).filter(i => i.quantity > 0);
                    orderPreview.onConfirm({ name, items: updatedItems });
                } }, h(Icon, { name: 'cart', size: 16 }), 'Créer la commande')
            )
        },
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Nom de la commande'),
                h('input', { id: 'order-preview-name', className: 'form-input', defaultValue: orderPreview.name, placeholder: 'Ex: Commande pièces moteur' })
            ),
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, `Pièces à commander (${orderPreview.items.length})`),
                h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8, maxHeight: 300, overflowY: 'auto' } },
                    orderPreview.items.map((item, idx) => h('div', { key: idx, style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: COLORS.background, borderRadius: 8, border: '1px solid ' + COLORS.border } },
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { fontWeight: 600, fontFamily: 'monospace' } }, item.part_ref),
                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, item.part_name)
                        ),
                        h('input', { 
                            type: 'number', 
                            className: 'order-preview-qty',
                            defaultValue: item.quantity,
                            min: 0,
                            style: { width: 70, padding: '8px', borderRadius: 6, border: '1px solid ' + COLORS.border, textAlign: 'center', fontWeight: 600 }
                        })
                    ))
                )
            ),
            h('div', { style: { padding: 12, background: '#FEF3C7', borderRadius: 8, fontSize: 13, color: '#92400E' } },
                '📋 Statut par défaut: En commande'
            )
        ),
        // Modal Archives
        showArchives && h(Modal, { isOpen: true, onClose: () => { setShowArchives(false); setViewArchivedTask(null); }, title: '📦 Travaux archivés', size: 'xl' },
            h('div', null,
                // Filtres
                h('div', { style: { display: 'flex', gap: 12, marginBottom: 16, flexWrap: 'wrap', alignItems: 'flex-end' } },
                    h('div', { style: { flex: 1, minWidth: 150 } },
                        h('label', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4, display: 'block' } }, 'Recherche'),
                        h('input', { type: 'text', className: 'form-input', placeholder: 'N° appareil, lieu...', value: archiveSearch, onChange: e => setArchiveSearch(e.target.value) })
                    ),
                    h('div', { style: { minWidth: 130 } },
                        h('label', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4, display: 'block' } }, 'Technicien'),
                        h('select', { className: 'form-select', value: archiveTechFilter, onChange: e => setArchiveTechFilter(e.target.value) },
                            h('option', { value: '' }, 'Tous'),
                            [...new Set(archivedTasks.map(t => t.assigned_to).filter(Boolean))].map(t => h('option', { key: t, value: t }, t))
                        )
                    ),
                    h('div', { style: { minWidth: 100 } },
                        h('label', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4, display: 'block' } }, 'Tournée'),
                        h('select', { className: 'form-select', value: archiveTourneeFilter, onChange: e => setArchiveTourneeFilter(e.target.value) },
                            h('option', { value: '' }, 'Toutes'),
                            [...new Set(archivedTasks.map(t => t.tournee).filter(Boolean))].map(t => h('option', { key: t, value: t }, t))
                        )
                    )
                ),
                // Ligne plage de dates et options export
                h('div', { style: { display: 'flex', gap: 12, marginBottom: 16, flexWrap: 'wrap', alignItems: 'flex-end', padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                        h('input', { type: 'checkbox', id: 'archiveExportAll', checked: archiveExportAll, onChange: e => setArchiveExportAll(e.target.checked) }),
                        h('label', { htmlFor: 'archiveExportAll', style: { fontSize: 13, cursor: 'pointer' } }, 'Tous les travaux')
                    ),
                    !archiveExportAll && h('div', { style: { minWidth: 130 } },
                        h('label', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4, display: 'block' } }, 'Du'),
                        h('input', { type: 'date', className: 'form-input', value: archiveDateFrom, onChange: e => setArchiveDateFrom(e.target.value) })
                    ),
                    !archiveExportAll && h('div', { style: { minWidth: 130 } },
                        h('label', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4, display: 'block' } }, 'Au'),
                        h('input', { type: 'date', className: 'form-input', value: archiveDateTo, onChange: e => setArchiveDateTo(e.target.value) })
                    ),
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginLeft: 16 } },
                        h('input', { type: 'checkbox', id: 'archiveExportWithDetails', checked: archiveExportWithDetails, onChange: e => setArchiveExportWithDetails(e.target.checked) }),
                        h('label', { htmlFor: 'archiveExportWithDetails', style: { fontSize: 13, cursor: 'pointer' } }, 'Inclure détails')
                    ),
                    (() => {
                        const filtered = archivedTasks.filter(t => {
                            const ms = !archiveSearch || [t.device_number, t.location, t.tournee].some(f => f?.toLowerCase().includes(archiveSearch.toLowerCase()));
                            const mt = !archiveTechFilter || t.assigned_to === archiveTechFilter;
                            const mto = !archiveTourneeFilter || t.tournee === archiveTourneeFilter;
                            if (archiveExportAll) return ms && mt && mto;
                            const archDate = new Date(t.archived_at).toISOString().split('T')[0];
                            const md = (!archiveDateFrom || archDate >= archiveDateFrom) && (!archiveDateTo || archDate <= archiveDateTo);
                            return ms && mt && mto && md;
                        });
                        return h('button', { className: 'btn btn-primary btn-sm', onClick: () => exportFilteredArchivesPdf(filtered, archiveExportWithDetails) }, h(Icon, { name: 'pdf', size: 14 }), ' Export PDF (', filtered.length, ')');
                    })()
                ),
                // Stats
                (() => {
                    const filtered = archivedTasks.filter(t => {
                        const ms = !archiveSearch || [t.device_number, t.location, t.tournee].some(f => f?.toLowerCase().includes(archiveSearch.toLowerCase()));
                        const mt = !archiveTechFilter || t.assigned_to === archiveTechFilter;
                        const mto = !archiveTourneeFilter || t.tournee === archiveTourneeFilter;
                        if (archiveExportAll) return ms && mt && mto;
                        const archDate = new Date(t.archived_at).toISOString().split('T')[0];
                        const md = (!archiveDateFrom || archDate >= archiveDateFrom) && (!archiveDateTo || archDate <= archiveDateTo);
                        return ms && mt && mto && md;
                    });
                    return h('div', { style: { marginBottom: 16 } }, h('span', { className: 'badge badge-primary' }, filtered.length, ' travaux archivés'));
                })(),
                // Liste
                (() => {
                    const filtered = archivedTasks.filter(t => {
                        const ms = !archiveSearch || [t.device_number, t.location, t.tournee].some(f => f?.toLowerCase().includes(archiveSearch.toLowerCase()));
                        const mt = !archiveTechFilter || t.assigned_to === archiveTechFilter;
                        const mto = !archiveTourneeFilter || t.tournee === archiveTourneeFilter;
                        if (archiveExportAll) return ms && mt && mto;
                        const archDate = new Date(t.archived_at).toISOString().split('T')[0];
                        const md = (!archiveDateFrom || archDate >= archiveDateFrom) && (!archiveDateTo || archDate <= archiveDateTo);
                        return ms && mt && mto && md;
                    });
                    return filtered.length === 0 ? 
                        h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune archive sur cette période') :
                        h('div', { style: { maxHeight: 400, overflowY: 'auto' } }, filtered.map(t => h('div', { key: t.id, style: { padding: 12, marginBottom: 8, background: COLORS.background, borderRadius: 10, display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                            h('div', { style: { flex: 1, cursor: 'pointer' }, onClick: () => setViewArchivedTask(t) },
                                h('div', { style: { display: 'flex', gap: 12, alignItems: 'center' } },
                                    h('div', { style: { fontFamily: 'monospace', fontWeight: 700, color: COLORS.primary, fontSize: 16 } }, t.device_number),
                                    t.tournee && h('span', { className: 'badge badge-secondary' }, t.tournee)
                                ),
                                h('div', { style: { fontSize: 14, marginTop: 4 } }, t.location || '-'),
                                h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 2 } }, (t.assigned_to || '-') + ' • Archivé le ' + formatDate(t.archived_at))
                            ),
                            h('div', { style: { display: 'flex', gap: 4 } },
                                h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setViewArchivedTask(t), title: 'Voir' }, h(Icon, { name: 'eye', size: 16 })),
                                h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => exportArchivedTaskPdf(t), title: 'Export PDF' }, h(Icon, { name: 'pdf', size: 16 })),
                                user.role === 'admin' && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setDeleteArchiveConfirm(t), title: 'Supprimer', style: { color: COLORS.danger } }, h(Icon, { name: 'trash', size: 16 }))
                            )
                        )))
                })()
            )
        ),
        // View Archived Task Modal
        viewArchivedTask && h(Modal, { isOpen: true, onClose: () => setViewArchivedTask(null), title: viewArchivedTask.device_number,
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => exportArchivedTaskPdf(viewArchivedTask) }, h(Icon, { name: 'pdf', size: 16 }), ' Export PDF'),
                user.role === 'admin' && h('button', { className: 'btn btn-danger', onClick: () => setDeleteArchiveConfirm(viewArchivedTask) }, h(Icon, { name: 'trash', size: 16 }), ' Supprimer')
            )
        }, h('div', null,
            h('span', { className: 'badge badge-secondary', style: { marginBottom: 16 } }, 'Archivé'),
            h('div', { className: 'info-grid', style: { marginBottom: 20 } },
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Tournée'), h('div', { className: 'info-value' }, viewArchivedTask.tournee || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Lieu'), h('div', { className: 'info-value' }, viewArchivedTask.location || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Technicien'), h('div', { className: 'info-value' }, viewArchivedTask.assigned_to || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Priorité'), h('div', { className: 'info-value' }, viewArchivedTask.priority || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Date ajout'), h('div', { className: 'info-value' }, formatDate(viewArchivedTask.date_added))),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Archivé le'), h('div', { className: 'info-value' }, formatDate(viewArchivedTask.archived_at)))
            ),
            viewArchivedTask.work_list && h('div', { style: { marginBottom: 20 } },
                h('div', { style: { fontWeight: 600, marginBottom: 12 } }, 'Travaux effectués'),
                h('div', { className: 'work-list' }, parseWorkList(viewArchivedTask.work_list).map((item, i) => h('div', { key: i, style: { display: 'flex', alignItems: 'center', gap: 10, padding: '10px 14px', background: COLORS.background, borderRadius: 10, marginBottom: 8 } },
                    h('span', { style: { padding: '4px 10px', borderRadius: 6, fontSize: 11, fontWeight: 600, whiteSpace: 'nowrap',
                        backgroundColor: item.status === 'EN STOCK' ? '#D1FAE5' : item.status === 'EN COMMANDE' ? '#FEF3C7' : item.status === 'PRÊT' ? '#DBEAFE' : item.status === 'EFFECTUÉ' ? '#E0E7FF' : '#F1F5F9',
                        color: item.status === 'EN STOCK' ? '#059669' : item.status === 'EN COMMANDE' ? '#D97706' : item.status === 'PRÊT' ? '#1D4ED8' : item.status === 'EFFECTUÉ' ? '#4338CA' : '#64748B'
                    } }, item.status),
                    h('span', { style: { flex: 1 } }, item.text)
                )))
            )
        )),
        // Export Options Modal
        showExportOptions && h(Modal, { isOpen: true, onClose: () => setShowExportOptions(false), title: '📄 Export PDF des travaux', size: 'sm',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => setShowExportOptions(false) }, 'Annuler'),
                h('button', { className: 'btn btn-primary', onClick: () => {
                    let tasksToExport = filteredTasks;
                    if (exportDateFrom && exportDateTo) {
                        tasksToExport = tasksToExport.filter(t => {
                            const taskDate = (t.created_at || '').split('T')[0];
                            return taskDate >= exportDateFrom && taskDate <= exportDateTo;
                        });
                    }
                    exportTasksPdf(tasksToExport, exportWithDetails);
                }}, 'Exporter')
            )
        },
            h('div', { style: { display: 'flex', flexDirection: 'column', gap: 16 } },
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 } },
                        h('input', { type: 'checkbox', id: 'exportWithDetails', checked: exportWithDetails, onChange: e => setExportWithDetails(e.target.checked) }),
                        h('label', { htmlFor: 'exportWithDetails', style: { fontWeight: 500, cursor: 'pointer' } }, '📋 Inclure les détails des travaux')
                    ),
                    h('p', { style: { fontSize: 12, color: COLORS.muted, margin: 0 } }, 
                        exportWithDetails ? 'Export complet avec la liste des tâches et pièces pour chaque travail' : 'Export simple en tableau récapitulatif'
                    )
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontWeight: 500, marginBottom: 12 } }, '📅 Plage de dates (optionnel)'),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', { className: 'form-label' }, 'Du'),
                            h('input', { type: 'date', className: 'form-input', value: exportDateFrom, onChange: e => setExportDateFrom(e.target.value) })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', { className: 'form-label' }, 'Au'),
                            h('input', { type: 'date', className: 'form-input', value: exportDateTo, onChange: e => setExportDateTo(e.target.value) })
                        )
                    ),
                    h('button', { className: 'btn btn-ghost btn-sm', onClick: () => { setExportDateFrom(''); setExportDateTo(''); } }, '✕ Effacer les dates')
                ),
                h('div', { style: { padding: 12, background: COLORS.primaryPastel, borderRadius: 8, textAlign: 'center' } },
                    h('span', { style: { fontWeight: 600, color: COLORS.primary } }, 
                        (() => {
                            let count = filteredTasks.length;
                            if (exportDateFrom && exportDateTo) {
                                count = filteredTasks.filter(t => {
                                    const taskDate = (t.created_at || '').split('T')[0];
                                    return taskDate >= exportDateFrom && taskDate <= exportDateTo;
                                }).length;
                            }
                            return count + ' travaux seront exportés';
                        })()
                    )
                )
            )
        ),
        // Delete Archive Confirm
        deleteArchiveConfirm && h(ConfirmDialog, { isOpen: true, onClose: () => setDeleteArchiveConfirm(null), onConfirm: () => deleteArchivedTask(deleteArchiveConfirm.id), title: 'Supprimer l\'archive', message: `Êtes-vous sûr de vouloir supprimer l'archive "${deleteArchiveConfirm.device_number}" ?`, confirmText: 'Supprimer', type: 'danger' })
    );
};


// ==========================================
// ORDERS PAGE
// ==========================================
const OrdersPage = ({ data, user, refresh, showToast }) => {
    const [search, setSearch] = useState('');
    const [statusFilter, setStatusFilter] = useState(null);
    const [viewMode, setViewMode] = useState('grid');
    const [columnFilters, setColumnFilters] = useState({});
    const [showAdd, setShowAdd] = useState(false);
    const [editOrder, setEditOrder] = useState(null);
    const [viewOrder, setViewOrder] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    // Items multi-produits avec appareil et commentaire
    const [orderItems, setOrderItems] = useState([{ part_id: null, part_ref: '', part_name: '', quantity: 1, device_number: '', comment: '' }]);
    // Archives
    const [showArchivesModal, setShowArchivesModal] = useState(false);
    const [archivedOrders, setArchivedOrders] = useState([]);
    const [archiveSearch, setArchiveSearch] = useState('');
    const [archiveDateFrom, setArchiveDateFrom] = useState(() => { const d = new Date(); d.setDate(1); return d.toISOString().split('T')[0]; });
    const [archiveDateTo, setArchiveDateTo] = useState(() => new Date().toISOString().split('T')[0]);
    const [viewArchivedOrder, setViewArchivedOrder] = useState(null);
    const [deleteArchiveConfirm, setDeleteArchiveConfirm] = useState(null);
    // Quantités de réception (permet de modifier la qté reçue)
    const [receiveQty, setReceiveQty] = useState({});
    // Options export
    const [showExportOptions, setShowExportOptions] = useState(false);
    const [exportWithDetails, setExportWithDetails] = useState(false);
    const [exportDateFrom, setExportDateFrom] = useState('');
    const [exportDateTo, setExportDateTo] = useState('');
    
    // v5.8 - États sélection multiple
    const [selectedItems, setSelectedItems] = useState([]);
    const [contextMenu, setContextMenu] = useState({ show: false, x: 0, y: 0, item: null });
    
    // États autocomplétion Progilift pour champ Appareil
    const [progiliftAscenseurs, setProgiliftAscenseurs] = useState([]);
    const [loadingAscenseurs, setLoadingAscenseurs] = useState(false);
    const [activeDeviceDropdown, setActiveDeviceDropdown] = useState(null); // index de l'item actif
    const [deviceSearches, setDeviceSearches] = useState({}); // recherche par index
    
    // Colonnes redimensionnables
    const ordersColumns = useMemo(() => [
        { key: 'checkbox', label: '', width: 50 },
        { key: 'name', label: 'Nom', width: 180 },
        { key: 'supplier', label: 'Fournisseur', width: 150 },
        { key: 'items', label: 'Articles', width: 80 },
        { key: 'status', label: 'Statut', width: 130 },
        { key: 'created_at', label: 'Date', width: 110 },
        { key: 'actions', label: 'Actions', width: 150 }
    ], []);
    
    const { columns: resizableCols, getColumnProps, resetColumns } = useResizableColumns('orders-table', ordersColumns);
    
    const userPerms = getUserPermissions(user);
    const canEdit = userPerms.orders_write === true;
    const isAdmin = user?.role === 'admin';
    
    const statusOptions = [
        { value: 'en-commande', label: 'En commande', color: 'warning', bg: '#FEF3C7', headerBg: 'linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%)', headerColor: '#92400E' },
        { value: 'en-cours', label: 'En cours', color: 'info', bg: '#DBEAFE', headerBg: 'linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%)', headerColor: '#1E40AF' },
        { value: 'pret', label: 'Prêt', color: 'success', bg: '#D1FAE5', headerBg: 'linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%)', headerColor: '#065F46' }
    ];
    
    const statusCounts = useMemo(() => ({
        all: data.orders.length,
        'en-commande': data.orders.filter(o => o.status === 'en-commande').length,
        'en-cours': data.orders.filter(o => o.status === 'en-cours').length,
        'pret': data.orders.filter(o => o.status === 'pret').length
    }), [data.orders]);
    
    const filteredOrders = useMemo(() => data.orders.filter(o => {
        const matchSearch = !search || [o.name, o.part_ref, o.part_name].some(f => f?.toLowerCase().includes(search.toLowerCase()));
        const matchStatus = !statusFilter || o.status === statusFilter;
        if (columnFilters.name && !o.name?.toLowerCase().includes(columnFilters.name.toLowerCase())) return false;
        if (columnFilters.supplier && !o.supplier?.toLowerCase().includes(columnFilters.supplier.toLowerCase())) return false;
        if (columnFilters.status && o.status !== columnFilters.status) return false;
        return matchSearch && matchStatus;
    }), [data.orders, search, statusFilter, columnFilters]);
    
    useEffect(() => { if (showArchivesModal) { db.from('archived_orders').select('*').order('archived_at', { ascending: false }).then(({ data }) => setArchivedOrders(data || [])); } }, [showArchivesModal]);
    
    // Charger les ascenseurs Progilift pour autocomplétion appareil
    useEffect(() => {
        if (showAdd && progiliftAscenseurs.length === 0) {
            const loadAscenseurs = async () => {
                setLoadingAscenseurs(true);
                let ascenseursData = [];
                let horsContratData = [];
                
                try {
                    // Charger ascenseurs depuis les tables progilift_*
                    const ascenseurs = await fetchAllRows(db, 'progilift_ascenseurs', 'id, code, contrat_id', 'code');
                    const contrats = await fetchAllRows(db, 'progilift_contrats', 'id, numero, immeuble, adresse, code_postal, ville, secteur');
                    
                    ascenseursData = ascenseurs.map(a => {
                        const contrat = contrats?.find(c => c.id === a.contrat_id);
                        return {
                            ...a,
                            contrat: contrat,
                            adresse: contrat?.adresse,
                            code_postal: contrat?.code_postal,
                            ville: contrat?.ville,
                            secteur: contrat ? { nom: contrat.secteur } : null
                        };
                    });
                    console.log('📊 Commandes - Ascenseurs chargés:', ascenseursData.length);
                } catch (err) {
                    console.log('⚠️ Commandes - Fallback sur vue ascenseurs');
                    try {
                        ascenseursData = await fetchAllRows(db, 'v_progilift_ascenseurs', '*', 'code');
                    } catch (e) { console.error('Erreur vue ascenseurs:', e); }
                }
                
                try {
                    // Charger appareils hors contrat
                    horsContratData = await fetchAllRows(db, 'progilift_hors_contrat', '*', 'code');
                    horsContratData = horsContratData.map(a => ({ ...a, isHorsContrat: true }));
                    console.log('📊 Commandes - Hors contrat chargés:', horsContratData.length);
                } catch (err) {
                    try {
                        horsContratData = await fetchAllRows(db, 'v_progilift_hors_contrat', '*', 'code');
                        horsContratData = horsContratData.map(a => ({ ...a, isHorsContrat: true }));
                    } catch (e) { console.log('⚠️ Pas de hors contrat'); }
                }
                
                const allAscenseurs = [...ascenseursData, ...horsContratData];
                setProgiliftAscenseurs(allAscenseurs);
                console.log('✅ Commandes - Total appareils:', allAscenseurs.length);
                setLoadingAscenseurs(false);
            };
            loadAscenseurs();
        }
    }, [showAdd]);
    
    // Filtrer ascenseurs selon recherche
    const getFilteredAscenseurs = (idx) => {
        const searchTerm = deviceSearches[idx] || '';
        if (!searchTerm || searchTerm.length < 2) return [];
        const term = searchTerm.toLowerCase();
        return progiliftAscenseurs.filter(a => {
            const code = (a.code || '').toLowerCase();
            const immeuble = (a.contrat?.immeuble || a.immeuble || '').toLowerCase();
            const adresse = (a.adresse || '').toLowerCase();
            const ville = (a.ville || '').toLowerCase();
            return code.includes(term) || immeuble.includes(term) || adresse.includes(term) || ville.includes(term);
        }).slice(0, 15);
    };
    
    // Sélectionner un appareil
    const selectDevice = (idx, asc) => {
        updateItem(idx, 'device_number', asc.code);
        setDeviceSearches(prev => ({ ...prev, [idx]: asc.code }));
        setActiveDeviceDropdown(null);
    };
    
    const parseItems = (order) => {
        if (order?.items) { try { return JSON.parse(order.items); } catch (e) { return []; } }
        if (order?.part_ref) return [{ part_id: order.part_id, part_ref: order.part_ref, part_name: order.part_name, quantity: order.quantity }];
        return [];
    };
    
    const saveOrder = async (e) => {
        e.preventDefault();
        const form = e.target;
        const validItems = orderItems.filter(i => i.part_name || i.part_ref);
        const orderData = { 
            name: form.name.value || validItems.map(i => i.part_name).join(', '), 
            items: JSON.stringify(validItems), 
            link: form.link?.value || null, 
            supplier: form.supplier?.value || null,
            status: editOrder?.status || 'en-commande' 
        };
        try {
            if (editOrder) { 
                await db.from('orders').update(orderData).eq('id', editOrder.id); 
                showToast('Commande mise à jour'); 
            } else { 
                const { data: newOrder } = await db.from('orders').insert({ ...orderData, created_by: user.id }).select().single(); 
                showToast('Commande créée');
                
                // Notifier tous les admins d'une nouvelle commande
                const admins = data.users.filter(u => u.role === 'admin' && u.id !== user.id);
                admins.forEach(admin => {
                    createNotification({
                        userId: admin.id,
                        type: 'order_created',
                        title: 'Nouvelle commande',
                        body: `${orderData.name}${orderData.supplier ? ` (${orderData.supplier})` : ''}`,
                        actionUrl: '/commandes',
                    });
                });
            }
            setShowAdd(false); setEditOrder(null); setOrderItems([{ part_id: null, part_ref: '', part_name: '', quantity: 1, device_number: '', comment: '' }]); refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const updateOrderStatus = async (id, newStatus) => { 
        try { 
            await db.from('orders').update({ status: newStatus, completed_at: newStatus === 'pret' ? new Date().toISOString() : null }).eq('id', id); 
            showToast('Statut mis à jour'); refresh(); 
            if (viewOrder) setViewOrder({ ...viewOrder, status: newStatus }); 
        } catch (err) { showToast(err.message, 'error'); } 
    };
    
    // Mettre à jour les pièces dans les tâches et retourner la quantité utilisée
    const updateTaskPartsAndGetUsage = async (partRef, partName) => {
        let totalTaskQuantity = 0;
        const taskDetails = [];
        
        try {
            const { data: tasks } = await db.from('tasks').select('id, required_parts, device_number');
            if (!tasks) return { totalTaskQuantity: 0, taskDetails: [] };
            
            for (const task of tasks) {
                if (!task.required_parts) continue;
                try {
                    const parts = JSON.parse(task.required_parts);
                    let updated = false;
                    
                    for (const part of parts) {
                        const matchRef = partRef && part.part_ref && part.part_ref.toLowerCase() === partRef.toLowerCase();
                        const matchName = partName && part.part_name && part.part_name.toLowerCase() === partName.toLowerCase();
                        
                        if ((matchRef || matchName) && (part.status === 'en-commande' || (part.is_manual && !part.status))) {
                            totalTaskQuantity += part.quantity;
                            taskDetails.push({ taskId: task.id, deviceNumber: task.device_number, quantity: part.quantity });
                            part.status = 'en-stock';
                            part.received_at = new Date().toISOString();
                            updated = true;
                        }
                    }
                    
                    if (updated) {
                        await db.from('tasks').update({ required_parts: JSON.stringify(parts) }).eq('id', task.id);
                    }
                } catch (e) { /* ignore parse errors */ }
            }
        } catch (err) { console.error('Error updating task parts:', err); }
        
        return { totalTaskQuantity, taskDetails };
    };
    
    // Trouver ou créer une pièce dans le stock (avec quantité à jour depuis la DB)
    const findOrCreatePart = async (partRef, partName) => {
        let foundPart = null;
        
        // Chercher par référence exacte d'abord
        if (partRef) {
            const { data } = await db.from('parts').select('*').eq('ref', partRef).limit(1);
            if (data && data.length > 0) foundPart = data[0];
        }
        
        // Si pas trouvé par ref, chercher par nom
        if (!foundPart && partName) {
            const { data } = await db.from('parts').select('*').eq('name', partName).limit(1);
            if (data && data.length > 0) foundPart = data[0];
        }
        
        // Si toujours pas trouvé, créer la pièce
        if (!foundPart) {
            const newPartData = {
                ref: partRef || `AUTO-${Date.now()}`,
                name: partName || partRef || 'Pièce auto-créée',
                quantity: 0,
                min_stock: 0,
                category: 'Non classé'
            };
            const { data: createdPart, error } = await db.from('parts').insert(newPartData).select().single();
            if (error) throw error;
            foundPart = createdPart;
        }
        
        return foundPart;
    };
    
    // Réceptionner un seul item
    const receiveItem = async (order, itemIndex) => {
        try {
            const items = parseItems(order);
            const item = items[itemIndex];
            if (!item || item.received) return;
            
            // La quantité originale de la commande
            const originalQty = item.original_quantity || item.quantity;
            // La quantité à recevoir (peut être modifiée par l'utilisateur)
            const receivedQty = receiveQty[itemIndex] !== undefined ? receiveQty[itemIndex] : item.quantity;
            const userName = ((user.first_name || '') + ' ' + (user.last_name || '')).trim() || user.email;
            
            // Mettre à jour les tâches et obtenir la quantité utilisée
            const { totalTaskQuantity, taskDetails } = await updateTaskPartsAndGetUsage(item.part_ref, item.part_name);
            
            // Trouver ou créer la pièce dans le stock
            const stockPart = await findOrCreatePart(item.part_ref, item.part_name);
            
            // 1. La quantité REÇUE entre dans le stock
            await db.from('parts').update({ quantity: stockPart.quantity + receivedQty }).eq('id', stockPart.id);
            
            // Historique : entrée de la quantité reçue
            await db.from('stock_withdrawals').insert({
                part_id: stockPart.id, part_ref: stockPart.ref, part_name: stockPart.name,
                quantity: receivedQty, 
                reason: `Réception commande: ${order.name}${receivedQty !== originalQty ? ` (commandé: ${originalQty})` : ''}`,
                withdrawn_by: userName, user_id: user.id, 
                withdrawn_at: new Date().toISOString(), type: 'entree'
            });
            
            // 2. Sortie pour chaque tâche qui avait besoin de cette pièce
            let currentStock = stockPart.quantity + receivedQty;
            for (const taskInfo of taskDetails) {
                // Déduire du stock
                currentStock -= taskInfo.quantity;
                await db.from('parts').update({ quantity: currentStock }).eq('id', stockPart.id);
                
                // Historique : sortie pour la tâche
                await db.from('stock_withdrawals').insert({
                    part_id: stockPart.id, part_ref: stockPart.ref, part_name: stockPart.name,
                    quantity: taskInfo.quantity, 
                    reason: `Sortie pour tâche: ${taskInfo.deviceNumber || taskInfo.taskId}`,
                    withdrawn_by: userName, user_id: user.id, 
                    withdrawn_at: new Date().toISOString(), type: 'sortie'
                });
            }
            
            // Marquer l'item comme reçu avec les quantités
            items[itemIndex] = { 
                ...item, 
                received: true, 
                received_at: new Date().toISOString(),
                original_quantity: originalQty,
                received_quantity: receivedQty,
                quantity: receivedQty // Mettre à jour la quantité actuelle
            };
            const allReceived = items.every(i => i.received);
            
            await db.from('orders').update({ 
                items: JSON.stringify(items),
                status: allReceived ? 'pret' : order.status,
                completed_at: allReceived ? new Date().toISOString() : order.completed_at
            }).eq('id', order.id);
            
            // Réinitialiser la quantité de réception
            setReceiveQty(prev => { const n = {...prev}; delete n[itemIndex]; return n; });
            
            let message = `${item.part_name} réceptionné (${receivedQty})`;
            if (receivedQty !== originalQty) {
                message += ` - commandé: ${originalQty}`;
            }
            if (taskDetails.length > 0) {
                const netStock = receivedQty - totalTaskQuantity;
                message += ` | +${receivedQty} entrée, -${totalTaskQuantity} tâche${taskDetails.length > 1 ? 's' : ''}, net: ${netStock >= 0 ? '+' : ''}${netStock}`;
            }
            showToast(message);
            setViewOrder({ ...order, items: JSON.stringify(items), status: allReceived ? 'pret' : order.status });
            refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    // Réceptionner tous les items non reçus
    const receiveOrder = async (order) => {
        try {
            const items = parseItems(order);
            const unreceivedIndices = items.map((item, i) => ({ item, index: i })).filter(x => !x.item.received);
            
            if (unreceivedIndices.length === 0) {
                showToast('Tous les articles sont déjà réceptionnés', 'info');
                return;
            }
            
            const userName = ((user.first_name || '') + ' ' + (user.last_name || '')).trim() || user.email;
            let totalEntree = 0;
            let totalForTasks = 0;
            let hasQtyChanges = false;
            
            for (const { item, index } of unreceivedIndices) {
                const originalQty = item.original_quantity || item.quantity;
                // Utiliser la quantité modifiée si elle existe
                const receivedQty = receiveQty[index] !== undefined ? receiveQty[index] : item.quantity;
                if (receivedQty !== originalQty) hasQtyChanges = true;
                
                // Mettre à jour les tâches et obtenir la quantité utilisée
                const { totalTaskQuantity, taskDetails } = await updateTaskPartsAndGetUsage(item.part_ref, item.part_name);
                
                // Trouver ou créer la pièce dans le stock
                const stockPart = await findOrCreatePart(item.part_ref, item.part_name);
                
                // 1. La quantité REÇUE entre dans le stock
                await db.from('parts').update({ quantity: stockPart.quantity + receivedQty }).eq('id', stockPart.id);
                totalEntree += receivedQty;
                
                // Historique : entrée de la quantité reçue
                await db.from('stock_withdrawals').insert({
                    part_id: stockPart.id, part_ref: stockPart.ref, part_name: stockPart.name,
                    quantity: receivedQty, 
                    reason: `Réception commande: ${order.name}${receivedQty !== originalQty ? ` (commandé: ${originalQty})` : ''}`,
                    withdrawn_by: userName, user_id: user.id, 
                    withdrawn_at: new Date().toISOString(), type: 'entree'
                });
                
                // 2. Sortie pour chaque tâche
                let currentStock = stockPart.quantity + receivedQty;
                for (const taskInfo of taskDetails) {
                    currentStock -= taskInfo.quantity;
                    await db.from('parts').update({ quantity: currentStock }).eq('id', stockPart.id);
                    
                    await db.from('stock_withdrawals').insert({
                        part_id: stockPart.id, part_ref: stockPart.ref, part_name: stockPart.name,
                        quantity: taskInfo.quantity, 
                        reason: `Sortie pour tâche: ${taskInfo.deviceNumber || taskInfo.taskId}`,
                        withdrawn_by: userName, user_id: user.id, 
                        withdrawn_at: new Date().toISOString(), type: 'sortie'
                    });
                    totalForTasks += taskInfo.quantity;
                }
                
                // Mettre à jour l'item avec les quantités
                items[index] = {
                    ...item,
                    received: true,
                    received_at: new Date().toISOString(),
                    original_quantity: originalQty,
                    received_quantity: receivedQty,
                    quantity: receivedQty
                };
            }
            
            await db.from('orders').update({ 
                items: JSON.stringify(items),
                status: 'pret', 
                completed_at: new Date().toISOString() 
            }).eq('id', order.id);
            
            // Réinitialiser les quantités de réception
            setReceiveQty({});
            
            const netStock = totalEntree - totalForTasks;
            let message = `Commande réceptionnée (+${totalEntree} entrée`;
            if (totalForTasks > 0) {
                message += `, -${totalForTasks} pour tâches`;
            }
            message += `, net: ${netStock >= 0 ? '+' : ''}${netStock})`;
            showToast(message); 
            
            // Notifier tous les techniciens que la commande est reçue
            const techniciens = data.users.filter(u => (u.role === 'admin' || u.role === 'technicien') && u.id !== user.id);
            techniciens.forEach(tech => {
                createNotification({
                    userId: tech.id,
                    type: 'order_received',
                    title: 'Commande réceptionnée',
                    body: `${order.name} - ${totalEntree} pièce(s) en stock`,
                    actionUrl: '/commandes',
                });
            });
            
            refresh(); 
            setViewOrder(null);
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const archiveOrder = async (order) => {
        try {
            await db.from('archived_orders').insert({ original_id: order.id, name: order.name, items: order.items, link: order.link, status: order.status, ordered_at: order.created_at, completed_at: order.completed_at, created_at: order.created_at, supplier: order.supplier });
            await db.from('orders').delete().eq('id', order.id);
            showToast('Commande archivée'); refresh(); setViewOrder(null);
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const deleteOrder = async (id) => { try { await db.from('orders').delete().eq('id', id); showToast('Commande supprimée'); setDeleteConfirm(null); setViewOrder(null); refresh(); } catch (err) { showToast(err.message, 'error'); } };
    
    const deleteArchivedOrder = async (id) => { try { await db.from('archived_orders').delete().eq('id', id); setArchivedOrders(prev => prev.filter(o => o.id !== id)); showToast('Archive supprimée'); setDeleteArchiveConfirm(null); setViewArchivedOrder(null); } catch (err) { showToast(err.message, 'error'); } };
    
    // Export PDF
    const exportOrderPDF = (order) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const items = parseItems(order);
        
        // Calculer les quantités totales
        const totalCommande = items.reduce((sum, i) => sum + (i.quantity || 0), 0);
        const totalRecu = items.reduce((sum, i) => sum + (i.received_qty || 0), 0);
        const statusLabel = statusOptions.find(s => s.value === order.status)?.label || order.status;
        
        // En-tête avec logo
        let y = drawPDFHeader(doc, order.name || `Commande #${order.id}`, `${totalCommande} commandé(s) • ${totalRecu} reçu(s) • ${statusLabel}`);
        
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text(`Date création: ${formatDateTime(order.created_at)}`, 20, y); y += 6;
        if (order.completed_at) { doc.text(`Réceptionné le: ${formatDateTime(order.completed_at)}`, 20, y); y += 6; }
        if (order.supplier) { doc.text(`Fournisseur: ${order.supplier}`, 20, y); y += 6; }
        if (order.link) { doc.text(`Lien: ${order.link.substring(0, 60)}`, 20, y); y += 6; }
        y += 10;
        
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text(`Détail des produits (${items.length})`, 20, y); y += 10;
        
        doc.setFillColor(245, 158, 11);
        doc.rect(20, y - 5, 170, 8, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.text('Référence', 25, y);
        doc.text('Désignation', 60, y);
        doc.text('Commandé', 130, y);
        doc.text('Reçu', 155, y);
        doc.text('Reste', 175, y);
        y += 10;
        
        doc.setTextColor(0, 0, 0);
        doc.setFont(undefined, 'normal');
        items.forEach((item, i) => {
            const received = item.received_qty || 0;
            const reste = (item.quantity || 0) - received;
            if (i % 2 === 0) { doc.setFillColor(254, 243, 199); doc.rect(20, y - 5, 170, 8, 'F'); }
            doc.text((item.part_ref || '-').substring(0, 15), 25, y);
            doc.text((item.part_name || '-').substring(0, 35), 60, y);
            doc.text(String(item.quantity || 0), 135, y);
            doc.text(String(received), 160, y);
            doc.setTextColor(reste > 0 ? 239 : 0, reste > 0 ? 68 : 128, reste > 0 ? 68 : 0);
            doc.text(String(reste), 180, y);
            doc.setTextColor(0, 0, 0);
            y += 8;
        });
        
        // Résumé
        y += 10;
        doc.setFillColor(241, 245, 249);
        doc.rect(20, y - 5, 170, 12, 'F');
        doc.setFont(undefined, 'bold');
        doc.text('TOTAL:', 25, y + 2);
        doc.text(String(totalCommande), 135, y + 2);
        doc.text(String(totalRecu), 160, y + 2);
        doc.text(String(totalCommande - totalRecu), 180, y + 2);
        
        doc.setFontSize(8);
        doc.setTextColor(128, 128, 128);
        doc.text(`Exporté le ${new Date().toLocaleDateString('fr-FR')} - StockApp`, 105, 285, { align: 'center' });
        doc.save(`commande-${order.name || order.id}-${new Date().toISOString().split('T')[0]}.pdf`);
        showToast('PDF exporté');
    };
    
    const exportFilteredOrdersPDF = (ordersToExport, withDetails = false) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF(withDetails ? 'p' : 'p');
        
        // En-tête avec logo
        const dateInfo = (exportDateFrom && exportDateTo) ? `du ${exportDateFrom} au ${exportDateTo}` : 'Toutes les commandes';
        let y = drawPDFHeader(doc, 'LISTE DES COMMANDES', `${ordersToExport.length} commande(s) - ${dateInfo}`);
        
        if (withDetails) {
            // Export avec détails des pièces
            ordersToExport.forEach((order, idx) => {
                if (y > 250) { doc.addPage(); y = 20; }
                
                const items = parseItems(order);
                const totalQty = items.reduce((sum, i) => sum + (i.quantity || 0), 0);
                const totalReceived = items.reduce((sum, i) => sum + (i.received_qty || 0), 0);
                const st = statusOptions.find(s => s.value === order.status) || statusOptions[0];
                
                // Bandeau titre
                doc.setFillColor(254, 243, 199);
                doc.rect(10, y - 5, 190, 12, 'F');
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text((idx + 1) + '. ' + (order.name || 'Commande #' + order.id), 15, y + 2);
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.text(st.label, 150, y + 2);
                doc.text(formatDate(order.created_at), 175, y + 2);
                y += 15;
                
                // Infos commande
                doc.setFontSize(9);
                if (order.supplier) { doc.text('Fournisseur: ' + order.supplier, 15, y); y += 5; }
                doc.text(`Total: ${totalQty} commandé(s) / ${totalReceived} reçu(s)`, 15, y);
                y += 8;
                
                // Liste des pièces
                if (items.length > 0) {
                    doc.setFillColor(241, 245, 249);
                    doc.rect(15, y - 4, 180, 7, 'F');
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(8);
                    doc.text('Réf', 18, y);
                    doc.text('Désignation', 45, y);
                    doc.text('Cmd', 140, y);
                    doc.text('Reçu', 160, y);
                    doc.text('Statut', 180, y);
                    y += 8;
                    
                    doc.setFont(undefined, 'normal');
                    items.forEach(item => {
                        if (y > 280) { doc.addPage(); y = 20; }
                        doc.text((item.part_ref || '-').substring(0, 12), 18, y);
                        doc.text((item.part_name || '-').substring(0, 45), 45, y);
                        doc.text(String(item.quantity || 0), 143, y);
                        doc.text(String(item.received_qty || 0), 163, y);
                        doc.text(item.received ? '✓' : '-', 183, y);
                        y += 6;
                    });
                }
                
                y += 10;
            });
        } else {
            // Export tableau simple
            doc.setFillColor(245, 158, 11);
            doc.rect(10, y - 5, 190, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('Nom', 15, y);
            doc.text('Produits', 80, y);
            doc.text('Statut', 130, y);
            doc.text('Date', 165, y);
            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            ordersToExport.forEach((order, i) => {
                if (y > 275) { doc.addPage(); y = 20; }
                if (i % 2 === 0) { doc.setFillColor(254, 243, 199); doc.rect(10, y - 5, 190, 8, 'F'); }
                const items = parseItems(order);
                const statusLabel = statusOptions.find(s => s.value === order.status)?.label || order.status;
                doc.text((order.name || `#${order.id}`).substring(0, 30), 15, y);
                doc.text(`${items.length} produit(s)`, 80, y);
                doc.text(statusLabel, 130, y);
                doc.text(formatDate(order.created_at), 165, y);
                y += 8;
            });
        }
        
        doc.save(`commandes-${new Date().toISOString().split('T')[0]}.pdf`);
        showToast('PDF exporté');
        setShowExportOptions(false);
    };
    
    const exportArchivedOrderPdf = (order) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const items = order.items ? (typeof order.items === 'string' ? JSON.parse(order.items) : order.items) : [];
        doc.setFillColor(245, 158, 11);
        doc.rect(0, 0, 210, 35, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.text(order.name || `Commande #${order.id}`, 105, 18, { align: 'center' });
        doc.setFontSize(11);
        doc.setFont(undefined, 'normal');
        doc.text(`Archivée le ${formatDate(order.archived_at)}`, 105, 28, { align: 'center' });
        let y = 50;
        doc.setTextColor(0, 0, 0);
        const addField = (label, value) => { doc.setFont(undefined, 'bold'); doc.text(label + ':', 20, y); doc.setFont(undefined, 'normal'); doc.text(String(value || '-'), 70, y); y += 10; };
        addField('Commandée le', formatDate(order.ordered_at || order.created_at));
        if (order.completed_at) addField('Reçue le', formatDate(order.completed_at));
        if (order.supplier) addField('Fournisseur', order.supplier);
        y += 10;
        if (items.length > 0) {
            doc.setFont(undefined, 'bold');
            doc.text('Articles:', 20, y); y += 8;
            doc.setFont(undefined, 'normal');
            items.forEach(item => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.text(`• ${item.part_name || item.name} (x${item.quantity})`, 25, y);
                y += 7;
            });
        }
        doc.save(`archive-commande-${order.id}.pdf`);
        showToast('PDF exporté');
    };
    
    // Item management avec appareil et commentaire
    const addItem = () => setOrderItems([...orderItems, { part_id: null, part_ref: '', part_name: '', quantity: 1, device_number: '', comment: '' }]);
    const updateItem = (idx, field, value) => { const items = [...orderItems]; items[idx][field] = value; setOrderItems(items); };
    const removeItem = (idx) => setOrderItems(orderItems.filter((_, i) => i !== idx));
    const selectPart = (idx, partId) => { 
        const part = data.parts.find(p => p.id === parseInt(partId)); 
        if (part) { const items = [...orderItems]; items[idx] = { ...items[idx], part_id: part.id, part_ref: part.ref, part_name: part.name, quantity: 1 }; setOrderItems(items); } 
    };
    
    // Render order card
    const renderOrderCard = (order) => {
        const items = parseItems(order);
        const st = statusOptions.find(s => s.value === order.status) || statusOptions[0];
        const receivedCount = items.filter(i => i.received).length;
        const hasUnreceived = receivedCount < items.length && items.length > 0;
        const hasQtyChanges = items.some(i => i.received && i.received_quantity !== undefined && i.received_quantity !== (i.original_quantity || i.received_quantity));
        
        return h('div', { key: order.id, className: 'card', style: { cursor: 'pointer', border: hasQtyChanges ? '2px solid #F59E0B' : undefined }, onClick: () => setViewOrder(order) },
            h('div', { className: 'card-body' },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12 } },
                    h('div', null,
                        h('div', { style: { fontWeight: 600, marginBottom: 4, display: 'flex', alignItems: 'center', gap: 6 } }, 
                            order.name || `Commande #${order.id}`,
                            hasQtyChanges && h('span', { style: { fontSize: 10, padding: '2px 6px', borderRadius: 4, background: '#FEF3C7', color: '#92400E' }, title: 'Quantité(s) modifiée(s)' }, '⚠️')
                        ),
                        h('div', { style: { fontSize: 13, color: COLORS.muted, display: 'flex', alignItems: 'center', gap: 8 } }, 
                            items.length > 0 ? `${items.length} produit(s)` : '-',
                            items.length > 1 && receivedCount > 0 && h('span', { 
                                style: { 
                                    fontSize: 11, 
                                    padding: '2px 6px', 
                                    borderRadius: 10, 
                                    background: receivedCount === items.length ? '#DCFCE7' : '#FEF3C7',
                                    color: receivedCount === items.length ? '#16A34A' : '#92400E'
                                } 
                            }, `${receivedCount}/${items.length} reçu`)
                        )
                    ),
                    h('span', { className: `badge badge-${st.color}` }, st.label)
                ),
                items.length > 0 && h('div', { style: { fontSize: 13, marginBottom: 12 } }, 
                    items.slice(0, 2).map((item, i) => {
                        const stockPart = data.parts.find(p => p.id === item.part_id || p.ref === item.part_ref);
                        const stockQty = stockPart ? stockPart.quantity : null;
                        const isLow = stockQty !== null && stockQty <= (stockPart?.min_stock || 0);
                        const qtyChanged = item.received && item.received_quantity !== undefined && item.received_quantity !== (item.original_quantity || item.received_quantity);
                        const displayQty = item.received_quantity || item.quantity;
                        return h('div', { key: i, style: { padding: '2px 0', display: 'flex', alignItems: 'center', gap: 6 } }, 
                            item.received && h('span', { style: { color: '#16A34A', fontSize: 12 } }, '✓'),
                            h('span', { style: { textDecoration: item.received ? 'line-through' : 'none', opacity: item.received ? 0.6 : 1 } }, `• ${item.part_name} (x${displayQty})`),
                            qtyChanged && h('span', { style: { fontSize: 10, color: '#D97706' } }, `(cmd: ${item.original_quantity})`),
                            stockQty !== null && !item.received && h('span', { style: { fontSize: 11, padding: '1px 5px', borderRadius: 4, background: isLow ? '#FEE2E2' : '#E0E7FF', color: isLow ? '#DC2626' : '#4F46E5' } }, stockQty)
                        );
                    }), 
                    items.length > 2 && h('div', { style: { color: COLORS.muted } }, `+ ${items.length - 2} autre(s)`)
                ),
                h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: canEdit ? 12 : 0 } }, formatRelative(order.created_at)),
                canEdit && h('div', { style: { display: 'flex', gap: 8, alignItems: 'center' }, onClick: e => e.stopPropagation() },
                    h('select', { 
                        value: order.status, 
                        onChange: e => updateOrderStatus(order.id, e.target.value),
                        className: 'form-select',
                        style: { 
                            flex: 1, 
                            padding: '8px 12px', 
                            fontSize: 13, 
                            fontWeight: 500,
                            background: st.bg,
                            color: st.headerColor,
                            border: `1px solid ${st.headerColor}40`,
                            borderRadius: 8
                        }
                    }, statusOptions.map(s => h('option', { key: s.value, value: s.value }, s.label))),
                    hasUnreceived && h('button', { className: 'btn btn-success btn-sm', onClick: () => receiveOrder(order), title: 'Tout réceptionner' }, '✓')
                )
            )
        );
    };
    
    // Archives filtrées
    const filteredArchives = useMemo(() => archivedOrders.filter(o => {
        const items = o.items ? (typeof o.items === 'string' ? JSON.parse(o.items) : o.items) : [];
        const itemsText = items.map(i => `${i.part_name} ${i.part_ref}`).join(' ');
        const ms = !archiveSearch || [o.name, itemsText].some(f => f?.toLowerCase().includes(archiveSearch.toLowerCase()));
        const archDate = new Date(o.archived_at).toISOString().split('T')[0];
        const md = (!archiveDateFrom || archDate >= archiveDateFrom) && (!archiveDateTo || archDate <= archiveDateTo);
        return ms && md;
    }), [archivedOrders, archiveSearch, archiveDateFrom, archiveDateTo]);
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' }, 
                h('h1', { className: 'page-title' }, 'Commandes'), 
                h('p', { className: 'page-subtitle' }, `${data.orders.length} commandes`)
            ),
            h('div', { className: 'page-actions' },
                h('button', { className: 'btn btn-secondary', onClick: () => setShowExportOptions(true), title: 'Export PDF' }, h(Icon, { name: 'download', size: 18 }), 'Export PDF'),
                isAdmin && h('button', { className: 'btn btn-secondary', onClick: () => setShowArchivesModal(true) }, h(Icon, { name: 'archive', size: 18 }), 'Archives'),
                canEdit && h('button', { className: 'btn btn-primary', onClick: () => { setEditOrder(null); setOrderItems([{ part_id: null, part_ref: '', part_name: '', quantity: 1, device_number: '', comment: '' }]); setDeviceSearches({}); setShowAdd(true); } }, h(Icon, { name: 'plus', size: 18 }), 'Nouvelle')
            )
        ),
        h('div', { className: 'card' },
            h('div', { className: 'card-header' },
                h('div', { className: 'header-search', style: { width: 300 } }, 
                    h(Icon, { name: 'search', size: 18, color: COLORS.muted }), 
                    h('input', { type: 'text', placeholder: 'Rechercher...', value: search, onChange: e => setSearch(e.target.value) })
                ),
                h('div', { className: 'filters' },
                    h('button', { className: `filter-btn ${!statusFilter ? 'active' : ''}`, onClick: () => setStatusFilter(null) }, 'Toutes (', statusCounts.all, ')'),
                    statusOptions.map(s => h('button', { key: s.value, className: `filter-btn ${statusFilter === s.value ? 'active' : ''}`, onClick: () => setStatusFilter(s.value) }, s.label, ' (', statusCounts[s.value], ')'))
                ),
                h('div', { style: { marginLeft: 'auto', display: 'flex', gap: 4, background: COLORS.background, borderRadius: 8, padding: 4 } },
                    h('button', { onClick: () => setViewMode('grid'), style: { padding: '6px 10px', borderRadius: 6, border: 'none', cursor: 'pointer', background: viewMode === 'grid' ? 'white' : 'transparent', boxShadow: viewMode === 'grid' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none' } }, h(Icon, { name: 'dashboard', size: 16, color: viewMode === 'grid' ? COLORS.primary : COLORS.muted })),
                    h('button', { onClick: () => setViewMode('list'), style: { padding: '6px 10px', borderRadius: 6, border: 'none', cursor: 'pointer', background: viewMode === 'list' ? 'white' : 'transparent', boxShadow: viewMode === 'list' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none' } }, h(Icon, { name: 'tasks', size: 16, color: viewMode === 'list' ? COLORS.primary : COLORS.muted }))
                ),
                // v5.8 - Compteur sélection
                selectedItems.length > 0 && h('span', { 
                    style: { background: COLORS.primary, color: 'white', padding: '4px 12px', borderRadius: 20, fontSize: 13, fontWeight: 600, marginLeft: 8 } 
                }, `${selectedItems.length} sélectionné(s)`)
            ),
            // v5.8 - Menu contextuel
            contextMenu.show && h(QuickActionsMenu, {
                isOpen: contextMenu.show,
                position: { x: contextMenu.x, y: contextMenu.y },
                type: 'order',
                item: contextMenu.item,
                onAction: (actionId, item) => {
                    if (actionId === 'view') setViewOrder(item);
                    else if (actionId === 'edit') { 
                        setEditOrder(item); 
                        const items = parseItems(item);
                        setOrderItems(items); 
                        // Initialiser les recherches avec les device_number existants
                        const searches = {};
                        items.forEach((it, i) => { if (it.device_number) searches[i] = it.device_number; });
                        setDeviceSearches(searches);
                        setShowAdd(true); 
                    }
                    else if (actionId === 'delete') setDeleteConfirm(item);
                    else if (actionId === 'receive') receiveOrder(item);
                    setContextMenu({ show: false, x: 0, y: 0, item: null });
                },
                onClose: () => setContextMenu({ show: false, x: 0, y: 0, item: null }),
                actions: [
                    { id: 'view', label: 'Voir détails', icon: '👁️' },
                    canEdit && { id: 'edit', label: 'Modifier', icon: '✏️' },
                    canEdit && contextMenu.item?.status === 'pret' && { id: 'receive', label: 'Réceptionner', icon: '✓' },
                    isAdmin && { id: 'delete', label: 'Supprimer', icon: '🗑️', danger: true }
                ].filter(Boolean)
            }),
            // v5.8 - Barre actions groupées
            selectedItems.length > 0 && h('div', { 
                className: 'animate-fade-in-up',
                style: { padding: '12px 16px', background: COLORS.primaryPastel, borderRadius: 8, margin: '0 16px 16px', display: 'flex', alignItems: 'center', gap: 12 } 
            },
                h('span', { style: { fontWeight: 600, color: COLORS.primary } }, `${selectedItems.length} commande(s) sélectionnée(s)`),
                h('div', { style: { marginLeft: 'auto', display: 'flex', gap: 8 } },
                    canEdit && h('button', { className: 'btn btn-sm btn-success', onClick: async () => {
                        const toReceive = data.orders.filter(o => selectedItems.includes(o.id) && o.status === 'pret');
                        for (const order of toReceive) { await receiveOrder(order); }
                        setSelectedItems([]); ToastServiceV58.success(`${toReceive.length} commande(s) réceptionnée(s)`);
                    }}, '✓ Réceptionner'),
                    h('button', { className: 'btn btn-sm btn-secondary', onClick: () => {
                        const sel = data.orders.filter(o => selectedItems.includes(o.id));
                        const csv = ['Nom,Fournisseur,Statut,Articles,Date'].concat(sel.map(o => `"${o.name || ''}","${o.supplier || ''}","${o.status}","${parseItems(o).length}","${o.created_at}"`));
                        const blob = new Blob([csv.join('\n')], { type: 'text/csv' }); const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = 'commandes.csv'; a.click(); ToastServiceV58.success('Export CSV');
                    }}, '📥 Exporter'),
                    isAdmin && h('button', { className: 'btn btn-sm btn-danger', onClick: async () => {
                        if (!confirm(`Supprimer ${selectedItems.length} commande(s) ?`)) return;
                        for (const id of selectedItems) { await db.from('orders').delete().eq('id', id); }
                        refresh(); setSelectedItems([]); ToastServiceV58.success('Supprimé');
                    }}, '🗑️ Supprimer'),
                    h('button', { className: 'btn btn-sm btn-ghost', onClick: () => setSelectedItems([]) }, '✕')
                )
            ),
            h('div', { style: { padding: 16 } },
                filteredOrders.length === 0 ? 
                    h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune commande') :
                viewMode === 'list' ?
                    // Vue Liste avec colonnes redimensionnables
                    h('div', { className: 'table-container', style: { overflowX: 'auto' } },
                        h('table', { className: 'table', style: { tableLayout: 'fixed', width: '100%' } },
                            h('thead', null, h('tr', null,
                                resizableCols.map(col => {
                                    const colProps = getColumnProps(col.key);
                                    // v5.8 - Checkbox header
                                    if (col.key === 'checkbox') {
                                        return h('th', { key: 'checkbox', style: { width: 50, textAlign: 'center' } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: filteredOrders.length > 0 && selectedItems.length === filteredOrders.length,
                                                onChange: (e) => {
                                                    if (e.target.checked) setSelectedItems(filteredOrders.map(o => o.id));
                                                    else setSelectedItems([]);
                                                },
                                                style: { width: 18, height: 18 }
                                            })
                                        );
                                    }
                                    if (col.key === 'name') {
                                        return h(FilterableTh, { key: col.key, label: 'Commande', filterKey: 'name', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                                    }
                                    if (col.key === 'supplier') {
                                        return h(FilterableTh, { key: col.key, label: 'Fournisseur', filterKey: 'supplier', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                                    }
                                    if (col.key === 'items') {
                                        return h(FilterableTh, { key: col.key, label: 'Articles', filterKey: null, filters: null, setFilters: null, style: { textAlign: 'center' }, ...colProps });
                                    }
                                    if (col.key === 'status') {
                                        return h(FilterableTh, { key: col.key, label: 'Statut', filterKey: 'status', filters: columnFilters, setFilters: setColumnFilters, type: 'select', options: statusOptions.map(s => ({ value: s.value, label: s.label })), ...colProps });
                                    }
                                    if (col.key === 'created_at') {
                                        return h(FilterableTh, { key: col.key, label: 'Date', filterKey: null, filters: null, setFilters: null, ...colProps });
                                    }
                                    if (col.key === 'actions') {
                                        return h(FilterableTh, { key: col.key, label: 'Actions', filterKey: null, filters: null, setFilters: null, ...colProps });
                                    }
                                    return null;
                                }).filter(Boolean)
                            )),
                            h('tbody', null, filteredOrders.map(order => {
                                const st = statusOptions.find(s => s.value === order.status) || statusOptions[0];
                                const items = parseItems(order);
                                const totalQty = items.reduce((sum, i) => sum + (i.quantity || 0), 0);
                                const isSelected = selectedItems.includes(order.id);
                                
                                const renderCell = (colKey) => {
                                    const col = resizableCols.find(c => c.key === colKey);
                                    const width = col?.width;
                                    
                                    switch(colKey) {
                                        // v5.8 - Checkbox cell
                                        case 'checkbox':
                                            return h('td', { key: 'checkbox', style: { width: 50, textAlign: 'center' }, onClick: e => e.stopPropagation() },
                                                h('input', { 
                                                    type: 'checkbox', 
                                                    checked: isSelected,
                                                    onChange: (e) => {
                                                        if (e.target.checked) setSelectedItems([...selectedItems, order.id]);
                                                        else setSelectedItems(selectedItems.filter(id => id !== order.id));
                                                    },
                                                    style: { width: 18, height: 18 }
                                                })
                                            );
                                        case 'name':
                                            return h('td', { key: colKey, style: { width } }, h('strong', null, order.name || `#${order.id}`));
                                        case 'supplier':
                                            return h('td', { key: colKey, style: { width, fontSize: 13 } }, order.supplier || '-');
                                        case 'items':
                                            return h('td', { key: colKey, style: { width, textAlign: 'center' } }, 
                                                h('span', { style: { fontWeight: 600 } }, totalQty || order.quantity || 0),
                                                h('span', { style: { fontSize: 11, color: COLORS.muted, marginLeft: 4 } }, `(${items.length})`)
                                            );
                                        case 'status':
                                            return h('td', { key: colKey, style: { width }, onClick: e => e.stopPropagation() }, 
                                                canEdit ? h('select', { 
                                                    value: order.status, 
                                                    onChange: e => updateOrderStatus(order.id, e.target.value),
                                                    style: { padding: '6px 10px', fontSize: 12, fontWeight: 500, background: st.bg, color: st.headerColor, border: `1px solid ${st.headerColor}40`, borderRadius: 6, cursor: 'pointer' }
                                                }, statusOptions.map(s => h('option', { key: s.value, value: s.value }, s.label))) :
                                                h('span', { className: `badge badge-${st.color}` }, st.label)
                                            );
                                        case 'created_at':
                                            return h('td', { key: colKey, style: { width, fontSize: 12, color: COLORS.muted } }, formatDate(order.created_at));
                                        case 'actions':
                                            return h('td', { key: colKey, style: { width }, onClick: e => e.stopPropagation() }, h('div', { className: 'table-actions' },
                                                order.status === 'pret' && canEdit && h('button', { className: 'btn btn-success btn-sm', onClick: () => receiveOrder(order), title: 'Réceptionner stock' }, '✓'),
                                                (() => {
                                                    const allReceived = items.length > 0 && items.every(i => i.received);
                                                    return allReceived && isAdmin && h('button', { className: 'btn btn-secondary btn-sm', onClick: () => archiveOrder(order), title: 'Archiver' }, h(Icon, { name: 'archive', size: 14 }));
                                                })(),
                                                h('button', { className: 'btn btn-ghost btn-sm', onClick: () => setViewOrder(order) }, h(Icon, { name: 'eye', size: 16 })),
                                                canEdit && h('button', { className: 'btn btn-ghost btn-sm', onClick: () => { 
                                                    setEditOrder(order); 
                                                    const items = parseItems(order).length > 0 ? parseItems(order) : [{ part_id: null, part_ref: '', part_name: '', quantity: 1, device_number: '', comment: '' }];
                                                    setOrderItems(items); 
                                                    const searches = {};
                                                    items.forEach((it, i) => { if (it.device_number) searches[i] = it.device_number; });
                                                    setDeviceSearches(searches);
                                                    setShowAdd(true); 
                                                } }, h(Icon, { name: 'edit', size: 16 })),
                                                isAdmin && h('button', { className: 'btn btn-ghost btn-sm', style: { color: COLORS.danger }, onClick: () => setDeleteConfirm(order) }, h(Icon, { name: 'trash', size: 16 }))
                                            ));
                                        default:
                                            return h('td', { key: colKey }, '-');
                                    }
                                };
                                
                                return h('tr', { 
                                    key: order.id, 
                                    style: { cursor: 'pointer', background: isSelected ? COLORS.primaryPastel : undefined }, 
                                    onClick: (e) => { if (!e.target.closest('input, button, select')) setViewOrder(order); },
                                    onContextMenu: (e) => { e.preventDefault(); setContextMenu({ show: true, x: e.clientX, y: e.clientY, item: order }); }
                                },
                                    resizableCols.map(col => renderCell(col.key))
                                );
                            }))
                        )
                    ) :
                // Vue grille groupée par statut
                !statusFilter ? h('div', null,
                    statusOptions.map(st => {
                        const orders = filteredOrders.filter(o => o.status === st.value);
                        if (orders.length === 0) return null;
                        return h('div', { key: st.value, style: { marginBottom: 24 } },
                            h('div', { style: { padding: '12px 16px', background: st.headerBg, borderRadius: '12px 12px 0 0', fontWeight: 600, color: st.headerColor, display: 'flex', alignItems: 'center', gap: 8 } },
                                h(Icon, { name: st.value === 'en-commande' ? 'clock' : st.value === 'en-cours' ? 'refresh' : 'check', size: 18 }),
                                `${st.label} (${orders.length})`
                            ),
                            h('div', { style: { background: st.bg, padding: 12, borderRadius: '0 0 12px 12px' } },
                                h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 12 } },
                                    orders.map(order => renderOrderCard(order))
                                )
                            )
                        );
                    })
                ) : h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: 16 } },
                    filteredOrders.map(order => renderOrderCard(order))
                )
            )
        ),
        // View Order Modal
        viewOrder && (() => {
            const items = parseItems(viewOrder);
            const receivedCount = items.filter(i => i.received).length;
            const allReceived = receivedCount === items.length;
            const hasUnreceived = receivedCount < items.length;
            
            return h(Modal, { isOpen: true, onClose: () => { setViewOrder(null); setReceiveQty({}); }, title: viewOrder.name || `Commande #${viewOrder.id}`, size: 'lg',
                footer: h(Fragment, null,
                    h('button', { className: 'btn btn-secondary', onClick: () => exportOrderPDF(viewOrder) }, h(Icon, { name: 'download', size: 16 }), 'PDF'),
                    viewOrder.link && h('a', { href: viewOrder.link, target: '_blank', className: 'btn btn-secondary' }, h(Icon, { name: 'link', size: 16 }), 'Lien'),
                    canEdit && h('button', { className: 'btn btn-secondary', onClick: () => { setEditOrder(viewOrder); setOrderItems(items.length > 0 ? items : [{ part_id: null, part_ref: '', part_name: '', quantity: 1, device_number: '', comment: '' }]); setShowAdd(true); setViewOrder(null); setReceiveQty({}); } }, h(Icon, { name: 'edit', size: 16 }), 'Modifier'),
                    canEdit && hasUnreceived && h('button', { className: 'btn btn-success', onClick: () => receiveOrder(viewOrder) }, '✓ Tout réceptionner'),
                    allReceived && isAdmin && h('button', { className: 'btn btn-secondary', onClick: () => archiveOrder(viewOrder) }, h(Icon, { name: 'archive', size: 16 }), 'Archiver'),
                    isAdmin && h('button', { className: 'btn btn-danger', onClick: () => setDeleteConfirm(viewOrder) }, h(Icon, { name: 'trash', size: 16 }), 'Supprimer')
                )
            }, h('div', null,
                h('div', { style: { display: 'flex', gap: 8, marginBottom: 16, alignItems: 'center' } },
                    h('span', { className: `badge badge-${statusOptions.find(s => s.value === viewOrder.status)?.color || 'warning'}` }, statusOptions.find(s => s.value === viewOrder.status)?.label || viewOrder.status),
                    items.length > 1 && h('span', { className: `badge ${allReceived ? 'badge-success' : 'badge-secondary'}` }, `${receivedCount}/${items.length} réceptionné${receivedCount > 1 ? 's' : ''}`)
                ),
                h('div', { style: { marginBottom: 20 } },
                    h('div', { style: { fontWeight: 600, marginBottom: 12 } }, 'Produits commandés'),
                    items.map((item, i) => {
                        const stockPart = data.parts.find(p => p.id === item.part_id || p.ref === item.part_ref);
                        const stockQty = stockPart ? stockPart.quantity : null;
                        const isLow = stockQty !== null && stockQty <= (stockPart?.min_stock || 0);
                        const isReceived = item.received;
                        const originalQty = item.original_quantity || item.quantity;
                        const receivedQtyItem = item.received_quantity;
                        const qtyChanged = isReceived && receivedQtyItem !== undefined && receivedQtyItem !== originalQty;
                        const currentReceiveQty = receiveQty[i] !== undefined ? receiveQty[i] : item.quantity;
                        const willChange = !isReceived && currentReceiveQty !== item.quantity;
                        
                        return h('div', { key: i, style: { 
                            padding: 12, 
                            background: isReceived ? '#DCFCE7' : COLORS.background, 
                            borderRadius: 10, 
                            marginBottom: 8, 
                            border: isReceived ? (qtyChanged ? '2px solid #F59E0B' : '1px solid #86EFAC') : (willChange ? '2px dashed #F59E0B' : 'none')
                        } },
                            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                                h('div', { style: { flex: 1 } }, 
                                    h('div', { style: { fontWeight: 500, display: 'flex', alignItems: 'center', gap: 8 } }, 
                                        item.part_name,
                                        isReceived && h('span', { style: { fontSize: 11, color: '#16A34A' } }, '✓'),
                                        qtyChanged && h('span', { style: { fontSize: 10, padding: '2px 6px', borderRadius: 4, background: '#FEF3C7', color: '#92400E' } }, `commandé: ${originalQty}`)
                                    ), 
                                    h('div', { style: { fontSize: 12, color: COLORS.muted, fontFamily: 'monospace' } }, item.part_ref),
                                    isReceived && item.received_at && h('div', { style: { fontSize: 11, color: '#16A34A', marginTop: 2 } }, 
                                        `Reçu le ${formatDate(item.received_at)}`,
                                        qtyChanged && h('span', { style: { color: '#D97706' } }, ` (${receivedQtyItem} au lieu de ${originalQty})`)
                                    )
                                ),
                                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                    stockQty !== null && h('div', { style: { fontSize: 12, padding: '4px 8px', borderRadius: 6, background: isLow ? '#FEE2E2' : '#E0E7FF', color: isLow ? '#DC2626' : '#4F46E5' } }, `Stock: ${stockQty}`),
                                    isReceived ? 
                                        h('div', { style: { fontWeight: 600, minWidth: 40, textAlign: 'center', color: qtyChanged ? '#D97706' : 'inherit' } }, `x${receivedQtyItem || item.quantity}`) :
                                        canEdit ? h('div', { style: { display: 'flex', alignItems: 'center', gap: 4 } },
                                            h('input', {
                                                type: 'number',
                                                min: 0,
                                                value: currentReceiveQty,
                                                onChange: e => setReceiveQty(prev => ({ ...prev, [i]: parseInt(e.target.value) || 0 })),
                                                style: { 
                                                    width: 60, 
                                                    padding: '6px 8px', 
                                                    borderRadius: 6, 
                                                    border: willChange ? '2px solid #F59E0B' : `1px solid ${COLORS.border}`,
                                                    textAlign: 'center',
                                                    fontWeight: 600,
                                                    background: willChange ? '#FEF3C7' : 'white'
                                                },
                                                title: `Commandé: ${item.quantity}`
                                            }),
                                            willChange && h('span', { style: { fontSize: 10, color: '#92400E' } }, `(${item.quantity})`)
                                        ) :
                                        h('div', { style: { fontWeight: 600, minWidth: 40, textAlign: 'center' } }, `x${item.quantity}`),
                                    canEdit && !isReceived && h('button', { 
                                        className: 'btn btn-success btn-sm', 
                                        onClick: () => receiveItem(viewOrder, i),
                                        title: 'Réceptionner cet article'
                                    }, '✓')
                                )
                            ),
                            // Afficher appareil et commentaire si renseignés
                            (item.device_number || item.comment) && h('div', { 
                                style: { 
                                    marginTop: 8, paddingTop: 8, borderTop: `1px dashed ${COLORS.border}`,
                                    display: 'flex', gap: 16, flexWrap: 'wrap', fontSize: 12
                                } 
                            },
                                item.device_number && h('div', { style: { display: 'flex', alignItems: 'center', gap: 4 } },
                                    h('span', { style: { color: COLORS.muted } }, '🏢'),
                                    h('span', { style: { fontFamily: 'monospace', fontWeight: 600, color: COLORS.primary } }, item.device_number)
                                ),
                                item.comment && h('div', { style: { display: 'flex', alignItems: 'center', gap: 4, color: COLORS.muted, fontStyle: 'italic' } },
                                    h('span', null, '💬'),
                                    h('span', null, item.comment)
                                )
                            )
                        );
                    })
                ),
                h('div', { className: 'info-grid' },
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Créée le'), h('div', { className: 'info-value' }, formatDateTime(viewOrder.created_at))),
                    viewOrder.completed_at && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Réceptionnée'), h('div', { className: 'info-value' }, formatDateTime(viewOrder.completed_at))),
                    viewOrder.supplier && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Fournisseur'), h('div', { className: 'info-value' }, viewOrder.supplier))
                ),
                canEdit && h('div', { style: { marginTop: 20 } },
                    h('div', { style: { fontWeight: 600, marginBottom: 12 } }, 'Changer le statut'),
                    h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                        statusOptions.map(s => h('button', { key: s.value, className: `btn btn-sm ${viewOrder.status === s.value ? 'btn-primary' : 'btn-secondary'}`, onClick: () => updateOrderStatus(viewOrder.id, s.value), disabled: viewOrder.status === s.value }, s.label))
                    )
                )
            ));
        })(),
        // Add/Edit Modal
        showAdd && h(Modal, { isOpen: true, onClose: () => { setShowAdd(false); setEditOrder(null); }, title: editOrder ? 'Modifier la commande' : 'Nouvelle commande', size: 'xl' },
            h('form', { onSubmit: saveOrder },
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Nom de la commande'), h('input', { name: 'name', className: 'form-input', defaultValue: editOrder?.name, placeholder: 'Ex: Commande pièces T1' })),
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Produits'),
                    orderItems.map((item, idx) => h('div', { 
                        key: idx, 
                        style: { 
                            marginBottom: 16, padding: 16, background: COLORS.background, borderRadius: 10,
                            border: `1px solid ${COLORS.border}`
                        } 
                    },
                        // Ligne 1: Pièce (select ou manuel) + Qté
                        h('div', { style: { display: 'flex', gap: 8, marginBottom: 10, alignItems: 'center', flexWrap: 'wrap' } },
                            h('span', { style: { fontWeight: 700, color: COLORS.primary, minWidth: 30 } }, `#${idx + 1}`),
                            h('select', { value: item.part_id || '', onChange: e => selectPart(idx, e.target.value), style: { flex: 2, minWidth: 180 }, className: 'form-select' },
                                h('option', { value: '' }, '-- Sélectionner pièce --'),
                                data.parts.map(p => h('option', { key: p.id, value: p.id }, `${p.ref} - ${p.name}`))
                            ),
                            h('span', { style: { color: COLORS.muted, fontSize: 12 } }, 'ou'),
                            h('input', { type: 'text', value: item.part_name, onChange: e => updateItem(idx, 'part_name', e.target.value), placeholder: 'Nom manuel', style: { flex: 2, minWidth: 150 }, className: 'form-input' }),
                            h('input', { type: 'text', value: item.part_ref || '', onChange: e => updateItem(idx, 'part_ref', e.target.value), placeholder: 'Réf', style: { width: 80 }, className: 'form-input' }),
                            h('input', { type: 'number', value: item.quantity, onChange: e => updateItem(idx, 'quantity', parseInt(e.target.value) || 1), min: 1, style: { width: 70, textAlign: 'center' }, className: 'form-input', title: 'Quantité' }),
                            orderItems.length > 1 && h('button', { type: 'button', className: 'btn btn-ghost btn-sm', onClick: () => removeItem(idx), style: { color: COLORS.danger } }, h(Icon, { name: 'x', size: 16 }))
                        ),
                        // Ligne 2: Appareil avec autocomplétion + Commentaire
                        h('div', { style: { display: 'flex', gap: 12, marginLeft: 38 } },
                            h('div', { style: { flex: 1, position: 'relative' } },
                                h('label', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4, display: 'block' } }, 
                                    '🏢 Appareil (optionnel)',
                                    loadingAscenseurs && h('span', { style: { marginLeft: 8, fontSize: 10 } }, '⏳')
                                ),
                                h('input', { 
                                    type: 'text', 
                                    value: deviceSearches[idx] !== undefined ? deviceSearches[idx] : (item.device_number || ''), 
                                    onChange: e => {
                                        const val = e.target.value;
                                        setDeviceSearches(prev => ({ ...prev, [idx]: val }));
                                        updateItem(idx, 'device_number', val);
                                        if (val.length >= 2) setActiveDeviceDropdown(idx);
                                    },
                                    onFocus: () => {
                                        const val = deviceSearches[idx] || item.device_number || '';
                                        if (val.length >= 2) setActiveDeviceDropdown(idx);
                                    },
                                    onBlur: () => setTimeout(() => setActiveDeviceDropdown(null), 200),
                                    placeholder: progiliftAscenseurs.length > 0 ? `Rechercher parmi ${progiliftAscenseurs.length} appareils...` : 'N° appareil concerné', 
                                    className: 'form-input',
                                    style: { fontFamily: 'monospace' },
                                    autoComplete: 'off'
                                }),
                                // Dropdown autocomplétion
                                activeDeviceDropdown === idx && getFilteredAscenseurs(idx).length > 0 && h('div', {
                                    style: {
                                        position: 'absolute', top: '100%', left: 0, right: 0, zIndex: 1000,
                                        background: 'white', border: `1px solid ${COLORS.border}`, borderRadius: 8,
                                        maxHeight: 250, overflowY: 'auto', boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
                                    }
                                }, getFilteredAscenseurs(idx).map(asc => h('div', {
                                    key: asc.code,
                                    onMouseDown: (e) => { e.preventDefault(); selectDevice(idx, asc); },
                                    style: {
                                        padding: '10px 12px', cursor: 'pointer', borderBottom: `1px solid ${COLORS.border}`,
                                        background: asc.isHorsContrat ? '#FEF9C3' : 'white'
                                    },
                                    onMouseOver: e => e.currentTarget.style.background = asc.isHorsContrat ? '#FDE68A' : COLORS.background,
                                    onMouseOut: e => e.currentTarget.style.background = asc.isHorsContrat ? '#FEF9C3' : 'white'
                                },
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                        h('span', { style: { fontWeight: 700, fontFamily: 'monospace', color: COLORS.primary } }, asc.code),
                                        asc.isHorsContrat && h('span', { style: { fontSize: 10, background: '#F59E0B', color: 'white', padding: '2px 6px', borderRadius: 4 } }, 'HC'),
                                        asc.arret && h('span', { style: { fontSize: 10, background: COLORS.danger, color: 'white', padding: '2px 6px', borderRadius: 4 } }, '🚨 Arrêt')
                                    ),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 2 } },
                                        asc.contrat?.immeuble || asc.immeuble || '',
                                        asc.ville && ` • ${asc.ville}`
                                    )
                                )))
                            ),
                            h('div', { style: { flex: 2 } },
                                h('label', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4, display: 'block' } }, '💬 Commentaire (optionnel)'),
                                h('input', { 
                                    type: 'text', 
                                    value: item.comment || '', 
                                    onChange: e => updateItem(idx, 'comment', e.target.value), 
                                    placeholder: 'Remarques, urgence, détails...', 
                                    className: 'form-input'
                                })
                            )
                        )
                    )),
                    h('button', { type: 'button', className: 'btn btn-secondary btn-sm', onClick: addItem, style: { marginTop: 8 } }, h(Icon, { name: 'plus', size: 14 }), 'Ajouter un produit')
                ),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Fournisseur'), h('input', { name: 'supplier', className: 'form-input', defaultValue: editOrder?.supplier })),
                    h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Lien externe'), h('input', { name: 'link', type: 'url', className: 'form-input', defaultValue: editOrder?.link, placeholder: 'https://...' }))
                ),
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 10, marginTop: 20 } },
                    h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => { setShowAdd(false); setEditOrder(null); } }, 'Annuler'),
                    h('button', { type: 'submit', className: 'btn btn-primary' }, 'Enregistrer')
                )
            )
        ),
        // Archives Modal
        showArchivesModal && h(Modal, { isOpen: true, onClose: () => { setShowArchivesModal(false); setViewArchivedOrder(null); }, title: 'Commandes archivées', size: 'xl' },
            h('div', null,
                h('div', { style: { display: 'flex', gap: 12, marginBottom: 16, flexWrap: 'wrap', alignItems: 'center' } },
                    h('div', { className: 'header-search', style: { flex: 1, minWidth: 200 } }, h(Icon, { name: 'search', size: 16, color: COLORS.muted }), h('input', { type: 'text', placeholder: 'Rechercher...', value: archiveSearch, onChange: e => setArchiveSearch(e.target.value), style: { border: 'none', outline: 'none', width: '100%' } })),
                    h('input', { type: 'date', value: archiveDateFrom, onChange: e => setArchiveDateFrom(e.target.value), className: 'form-input', style: { width: 150 } }),
                    h('span', { style: { color: COLORS.muted } }, 'au'),
                    h('input', { type: 'date', value: archiveDateTo, onChange: e => setArchiveDateTo(e.target.value), className: 'form-input', style: { width: 150 } }),
                    h('button', { className: 'btn btn-secondary btn-sm', onClick: () => { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.setFillColor(245, 158, 11); doc.rect(0, 0, 210, 30, 'F'); doc.setTextColor(255, 255, 255); doc.setFontSize(18); doc.text('ARCHIVES COMMANDES', 105, 15, { align: 'center' }); doc.setFontSize(10); doc.text(`${filteredArchives.length} commande(s)`, 105, 24, { align: 'center' }); let y = 45; doc.setTextColor(0, 0, 0); filteredArchives.forEach((o, i) => { if (y > 275) { doc.addPage(); y = 20; } doc.setFontSize(10); doc.text((o.name || `#${o.id}`).substring(0, 40), 20, y); doc.text(formatDate(o.archived_at), 150, y); y += 8; }); doc.save(`archives-commandes.pdf`); showToast('PDF exporté'); } }, h(Icon, { name: 'download', size: 14 }), 'Export PDF')
                ),
                h('div', { style: { marginBottom: 12 } }, h('span', { className: 'badge badge-warning' }, `${filteredArchives.length} archive(s)`)),
                filteredArchives.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune archive') :
                h('div', { style: { maxHeight: 400, overflowY: 'auto' } }, filteredArchives.map(o => {
                    const items = o.items ? (typeof o.items === 'string' ? JSON.parse(o.items) : o.items) : [];
                    return h('div', { key: o.id, style: { padding: 12, marginBottom: 8, background: COLORS.background, borderRadius: 10, display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                        h('div', { style: { flex: 1, cursor: 'pointer' }, onClick: () => setViewArchivedOrder(o) },
                            h('div', { style: { fontWeight: 600 } }, o.name || `Commande #${o.id}`),
                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, `${items.length} article(s) • Archivée le ${formatDate(o.archived_at)}`)
                        ),
                        h('div', { style: { display: 'flex', gap: 4 } },
                            h('button', { className: 'btn btn-ghost btn-sm', onClick: () => setViewArchivedOrder(o) }, h(Icon, { name: 'eye', size: 16 })),
                            h('button', { className: 'btn btn-ghost btn-sm', onClick: () => exportArchivedOrderPdf(o) }, h(Icon, { name: 'download', size: 16 })),
                            isAdmin && h('button', { className: 'btn btn-ghost btn-sm', style: { color: COLORS.danger }, onClick: () => setDeleteArchiveConfirm(o) }, h(Icon, { name: 'trash', size: 16 }))
                        )
                    );
                }))
            )
        ),
        // View Archived Order Modal
        viewArchivedOrder && h(Modal, { isOpen: true, onClose: () => setViewArchivedOrder(null), title: viewArchivedOrder.name || `Commande #${viewArchivedOrder.id}`,
            footer: h(Fragment, null, h('button', { className: 'btn btn-secondary', onClick: () => exportArchivedOrderPdf(viewArchivedOrder) }, h(Icon, { name: 'download', size: 16 }), 'PDF'), isAdmin && h('button', { className: 'btn btn-danger', onClick: () => setDeleteArchiveConfirm(viewArchivedOrder) }, h(Icon, { name: 'trash', size: 16 }), 'Supprimer'))
        }, h('div', null,
            h('span', { className: 'badge badge-secondary', style: { marginBottom: 16 } }, 'Archivée'),
            h('div', { className: 'info-grid', style: { marginBottom: 20 } },
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Commandée'), h('div', { className: 'info-value' }, formatDate(viewArchivedOrder.ordered_at || viewArchivedOrder.created_at))),
                viewArchivedOrder.completed_at && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Reçue'), h('div', { className: 'info-value' }, formatDate(viewArchivedOrder.completed_at))),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Archivée'), h('div', { className: 'info-value' }, formatDate(viewArchivedOrder.archived_at))),
                viewArchivedOrder.supplier && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Fournisseur'), h('div', { className: 'info-value' }, viewArchivedOrder.supplier))
            ),
            h('div', { style: { fontWeight: 600, marginBottom: 12 } }, 'Articles'),
            (() => {
                const items = viewArchivedOrder.items ? (typeof viewArchivedOrder.items === 'string' ? JSON.parse(viewArchivedOrder.items) : viewArchivedOrder.items) : [];
                return items.length === 0 ? h('p', { style: { color: COLORS.muted } }, 'Aucun article') :
                    h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } }, items.map((item, i) => h('div', { key: i, style: { padding: '10px 12px', background: COLORS.background, borderRadius: 8, display: 'flex', justifyContent: 'space-between' } },
                        h('div', null, h('div', { style: { fontWeight: 500 } }, item.part_name || item.name), item.part_ref && h('div', { style: { fontSize: 12, color: COLORS.muted, fontFamily: 'monospace' } }, item.part_ref)),
                        h('span', { className: 'badge badge-info' }, `x${item.quantity}`)
                    )));
            })()
        )),
        // Export Options Modal
        showExportOptions && h(Modal, { isOpen: true, onClose: () => setShowExportOptions(false), title: '📄 Export PDF des commandes', size: 'sm',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => setShowExportOptions(false) }, 'Annuler'),
                h('button', { className: 'btn btn-primary', onClick: () => {
                    let ordersToExport = filteredOrders;
                    if (exportDateFrom && exportDateTo) {
                        ordersToExport = ordersToExport.filter(o => {
                            const orderDate = (o.created_at || '').split('T')[0];
                            return orderDate >= exportDateFrom && orderDate <= exportDateTo;
                        });
                    }
                    exportFilteredOrdersPDF(ordersToExport, exportWithDetails);
                }}, 'Exporter')
            )
        },
            h('div', { style: { display: 'flex', flexDirection: 'column', gap: 16 } },
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 } },
                        h('input', { type: 'checkbox', id: 'ordersExportWithDetails', checked: exportWithDetails, onChange: e => setExportWithDetails(e.target.checked) }),
                        h('label', { htmlFor: 'ordersExportWithDetails', style: { fontWeight: 500, cursor: 'pointer' } }, '📦 Inclure la liste des pièces')
                    ),
                    h('p', { style: { fontSize: 12, color: COLORS.muted, margin: 0 } }, 
                        exportWithDetails ? 'Export détaillé avec toutes les pièces de chaque commande' : 'Export simple en tableau récapitulatif'
                    )
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontWeight: 500, marginBottom: 12 } }, '📅 Plage de dates (optionnel)'),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', { className: 'form-label' }, 'Du'),
                            h('input', { type: 'date', className: 'form-input', value: exportDateFrom, onChange: e => setExportDateFrom(e.target.value) })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', { className: 'form-label' }, 'Au'),
                            h('input', { type: 'date', className: 'form-input', value: exportDateTo, onChange: e => setExportDateTo(e.target.value) })
                        )
                    ),
                    h('button', { className: 'btn btn-ghost btn-sm', onClick: () => { setExportDateFrom(''); setExportDateTo(''); } }, '✕ Effacer les dates')
                ),
                h('div', { style: { padding: 12, background: '#FEF3C7', borderRadius: 8, textAlign: 'center' } },
                    h('span', { style: { fontWeight: 600, color: '#92400E' } }, 
                        (() => {
                            let count = filteredOrders.length;
                            if (exportDateFrom && exportDateTo) {
                                count = filteredOrders.filter(o => {
                                    const orderDate = (o.created_at || '').split('T')[0];
                                    return orderDate >= exportDateFrom && orderDate <= exportDateTo;
                                }).length;
                            }
                            return count + ' commandes seront exportées';
                        })()
                    )
                )
            )
        ),
        // Confirms
        deleteConfirm && h(ConfirmDialog, { isOpen: true, onClose: () => setDeleteConfirm(null), onConfirm: () => deleteOrder(deleteConfirm.id), title: 'Supprimer la commande ?', message: deleteConfirm.name || `Commande #${deleteConfirm.id}`, confirmText: 'Supprimer', type: 'danger' }),
        deleteArchiveConfirm && h(ConfirmDialog, { isOpen: true, onClose: () => setDeleteArchiveConfirm(null), onConfirm: () => deleteArchivedOrder(deleteArchiveConfirm.id), title: 'Supprimer l\'archive ?', message: 'Cette action est irréversible', confirmText: 'Supprimer', type: 'danger' })
    );
};


// ==========================================
// PLANNING PAGE - VERSION COMPLÈTE
// ==========================================
const PlanningPage = ({ data, user, refresh, showToast }) => {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [viewMode, setViewMode] = useState('week'); // 'day' ou 'week'
    const [viewEvent, setViewEvent] = useState(null);
    const [showAddModal, setShowAddModal] = useState(false);
    const [editEvent, setEditEvent] = useState(null);
    const [taskTab, setTaskTab] = useState('classique');
    const [draggedTask, setDraggedTask] = useState(null);
    const [taskSearch, setTaskSearch] = useState('');
    const [showPlanningCategories, setShowPlanningCategories] = useState(false);
    const [editPlanningCategory, setEditPlanningCategory] = useState(null);
    const [newCategoryForm, setNewCategoryForm] = useState({ name: '', color: '#3B82F6', icon: '📌' });
    const [showHistoryModal, setShowHistoryModal] = useState(false);
    const [tasksCollapsed, setTasksCollapsed] = useState(() => {
        const saved = localStorage.getItem('stockapp-tasks-collapsed');
        return saved === 'true';
    });
    const [showGanttView, setShowGanttView] = useState(false);
    const [showReportsModal, setShowReportsModal] = useState(false);
    const { reports, addReport, deleteReport, toggleReport, runReport } = typeof window.StockAppV53 !== 'undefined' ? window.StockAppV53.useScheduledReports() : { reports: [], addReport: () => {}, deleteReport: () => {}, toggleReport: () => {}, runReport: () => {} };
    
    // Nouveaux états v5.6
    const [showRecurrenceModal, setShowRecurrenceModal] = useState(false);
    const [recurrenceForm, setRecurrenceForm] = useState({
        frequency: 'weekly', interval_value: 1, day_of_week: 1, day_of_month: 1,
        start_date: new Date().toISOString().split('T')[0], end_date: '',
        task_template: { device_number: '', location: '', description: '', assigned_to: '', event_category: 'Entretiens' }
    });
    const [recurrences, setRecurrences] = useState([]);
    const [showAvailabilityModal, setShowAvailabilityModal] = useState(false);
    const [availabilities, setAvailabilities] = useState([]);
    const [availabilityForm, setAvailabilityForm] = useState({
        user_id: '', type: 'vacation', start_date: '', end_date: '', reason: ''
    });
    const [showOptimizeModal, setShowOptimizeModal] = useState(false);
    const [optimizeDate, setOptimizeDate] = useState(new Date().toISOString().split('T')[0]);
    const [optimizeTechnician, setOptimizeTechnician] = useState('');
    
    // Charger récurrences et disponibilités
    useEffect(() => {
        const loadPlanningData = async () => {
            try {
                const [recRes, availRes] = await Promise.all([
                    db.from('task_recurrences').select('*').eq('is_active', true).order('created_at', { ascending: false }),
                    db.from('technician_availability').select('*').gte('end_date', new Date().toISOString().split('T')[0]).order('start_date')
                ]);
                if (recRes.data) setRecurrences(recRes.data);
                if (availRes.data) setAvailabilities(availRes.data);
            } catch (err) {
                console.log('Tables planning avancé non disponibles:', err);
            }
        };
        loadPlanningData();
    }, []);
    
    // Vérifier si un technicien est disponible à une date
    const isTechnicianAvailable = (techId, date) => {
        const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
        return !availabilities.some(a => 
            a.user_id === techId && 
            a.status === 'approved' &&
            dateStr >= a.start_date && 
            dateStr <= a.end_date
        );
    };
    
    // Obtenir les indisponibilités d'un jour
    const getDayAvailabilities = (date) => {
        const dateStr = typeof date === 'string' ? date : date.toISOString().split('T')[0];
        return availabilities.filter(a => 
            a.status === 'approved' &&
            dateStr >= a.start_date && 
            dateStr <= a.end_date
        );
    };
    
    // Sauvegarder une récurrence
    const saveRecurrence = async () => {
        try {
            const recData = {
                frequency: recurrenceForm.frequency,
                interval_value: recurrenceForm.interval_value,
                day_of_week: recurrenceForm.frequency === 'weekly' ? recurrenceForm.day_of_week : null,
                day_of_month: recurrenceForm.frequency === 'monthly' ? recurrenceForm.day_of_month : null,
                start_date: recurrenceForm.start_date,
                end_date: recurrenceForm.end_date || null,
                task_template: recurrenceForm.task_template,
                next_generation: recurrenceForm.start_date,
                is_active: true,
                created_by: user.id
            };
            await db.from('task_recurrences').insert(recData);
            showToast('Récurrence créée', 'success');
            setShowRecurrenceModal(false);
            setRecurrenceForm({ frequency: 'weekly', interval_value: 1, day_of_week: 1, day_of_month: 1, start_date: new Date().toISOString().split('T')[0], end_date: '', task_template: { device_number: '', location: '', description: '', assigned_to: '', event_category: 'Entretiens' } });
            const { data: newRecs } = await db.from('task_recurrences').select('*').eq('is_active', true);
            if (newRecs) setRecurrences(newRecs);
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    // Sauvegarder une disponibilité
    const saveAvailability = async () => {
        try {
            await db.from('technician_availability').insert({
                ...availabilityForm,
                status: user.role === 'admin' ? 'approved' : 'pending'
            });
            showToast('Indisponibilité enregistrée', 'success');
            setShowAvailabilityModal(false);
            setAvailabilityForm({ user_id: '', type: 'vacation', start_date: '', end_date: '', reason: '' });
            const { data: newAvails } = await db.from('technician_availability').select('*').gte('end_date', new Date().toISOString().split('T')[0]);
            if (newAvails) setAvailabilities(newAvails);
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    // Optimisation automatique des tournées
    const optimizeTasks = async () => {
        const tasksToOptimize = scheduledTasks.filter(t => 
            t.scheduled_date === optimizeDate && 
            (optimizeTechnician ? t.assigned_to === optimizeTechnician : true) &&
            t.latitude && t.longitude
        );
        
        if (tasksToOptimize.length < 2) {
            showToast('Pas assez de tâches géolocalisées à optimiser', 'warning');
            return;
        }
        
        // Algorithme du plus proche voisin pour optimiser l'ordre
        const optimized = [];
        const remaining = [...tasksToOptimize];
        let current = remaining.shift();
        optimized.push(current);
        
        while (remaining.length > 0) {
            let nearestIdx = 0;
            let nearestDist = Infinity;
            
            remaining.forEach((task, idx) => {
                const dist = Math.sqrt(
                    Math.pow(task.latitude - current.latitude, 2) + 
                    Math.pow(task.longitude - current.longitude, 2)
                );
                if (dist < nearestDist) {
                    nearestDist = dist;
                    nearestIdx = idx;
                }
            });
            
            current = remaining.splice(nearestIdx, 1)[0];
            optimized.push(current);
        }
        
        // Mettre à jour l'ordre (via scheduled_time)
        for (let i = 0; i < optimized.length; i++) {
            const hour = 8 + Math.floor(i * 1.5);
            const time = `${hour.toString().padStart(2, '0')}:00`;
            await db.from('tasks').update({ scheduled_time: time }).eq('id', optimized[i].id);
        }
        
        showToast(`${optimized.length} tâches optimisées!`, 'success');
        setShowOptimizeModal(false);
        refresh();
    };
    
    // Sauvegarder l'état du volet
    useEffect(() => {
        localStorage.setItem('stockapp-tasks-collapsed', tasksCollapsed);
    }, [tasksCollapsed]);
    
    const userPerms = getUserPermissions(user);
    const canEdit = userPerms.planning_write === true;
    const isAdmin = user.role === 'admin';
    
    const defaultCategories = [
        { id: 'controle', name: 'Contrôle', color: '#3B82F6', icon: '🔍' },
        { id: 'entretiens', name: 'Entretiens', color: '#10B981', icon: '🛠️' },
        { id: 'mise_en_service', name: 'Mise en service', color: '#8B5CF6', icon: '🚀' },
        { id: 'sav_travaux', name: 'SAV/Travaux', color: '#F97316', icon: '⚙️' },
        { id: 'reunion', name: 'Réunion', color: '#EC4899', icon: '👥' },
        { id: 'formation', name: 'Formation', color: '#06B6D4', icon: '📚' },
        { id: 'deplacement', name: 'Déplacement', color: '#14B8A6', icon: '🚗' },
        { id: 'conge', name: 'Congé', color: '#EF4444', icon: '🏖️' }
    ];
    const categories = data.categories?.length > 0 ? data.categories : defaultCategories;
    
    // Jours selon le mode
    const getWeekDays = () => {
        const start = new Date(currentDate);
        start.setDate(start.getDate() - (start.getDay() || 7) + 1);
        return Array.from({ length: 7 }, (_, i) => { const d = new Date(start); d.setDate(start.getDate() + i); return d; });
    };
    const weekDays = getWeekDays();
    const displayDays = viewMode === 'day' ? [new Date(currentDate)] : weekDays;
    const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
    
    // Navigation
    const navigate = (dir) => { 
        const d = new Date(currentDate); 
        d.setDate(d.getDate() + (viewMode === 'day' ? dir : dir * 7)); 
        setCurrentDate(d); 
    };
    const goToday = () => setCurrentDate(new Date());
    const isToday = (date) => date.toDateString() === new Date().toDateString();
    const isPastDay = (date) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const checkDate = new Date(date);
        checkDate.setHours(0, 0, 0, 0);
        return checkDate < today;
    };
    
    // Vérifier si un jour a des tâches en retard
    const hasOverdueTasksOnDay = (date) => {
        const dateStr = date.toISOString().split('T')[0];
        return overdueTasks.some(t => t.scheduled_date === dateStr);
    };
    
    const getTitle = () => {
        if (viewMode === 'day') return currentDate.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        return 'Semaine du ' + weekDays[0].toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) + ' au ' + weekDays[6].toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
    };
    
    // Événements et tâches
    const events = useMemo(() => data.tasks.filter(t => t.is_event), [data.tasks]);
    const scheduledTasks = useMemo(() => data.tasks.filter(t => t.scheduled_date && !t.is_event && t.status !== 'termine'), [data.tasks]);
    
    // Techniciens (déplacé ici car utilisé dans archivedEvents)
    const allTechnicians = useMemo(() => data.users.filter(u => u.role === 'admin' || u.role === 'technicien'), [data.users]);
    
    // Utilisateurs visibles dans le planning (depuis la BDD via data.settings)
    const [visibleUserIds, setVisibleUserIds] = useState(null); // null = tous
    
    // Charger les paramètres depuis data.settings
    useEffect(() => {
        if (data.settings) {
            const planningUsersRow = data.settings.find(s => s.key === 'planning_users');
            if (planningUsersRow?.value) {
                try {
                    const parsed = JSON.parse(planningUsersRow.value);
                    setVisibleUserIds(parsed.length === 0 ? null : parsed);
                } catch (e) { console.log('Error parsing planning users'); }
            }
        }
    }, [data.settings]);
    
    // Écouter les changements d'utilisateurs du planning (depuis settings)
    useEffect(() => {
        const handleUsersChange = (e) => {
            setVisibleUserIds(e.detail);
        };
        window.addEventListener('planning-users-changed', handleUsersChange);
        return () => window.removeEventListener('planning-users-changed', handleUsersChange);
    }, []);
    
    // Techniciens filtrés selon les paramètres
    const technicians = useMemo(() => {
        if (visibleUserIds === null) return allTechnicians; // tous
        return allTechnicians.filter(u => visibleUserIds.includes(u.id));
    }, [allTechnicians, visibleUserIds]);
    
    const avatarColors = ['#3B82F6', '#10B981', '#8B5CF6', '#F97316', '#EC4899', '#06B6D4', '#EF4444'];
    const getAvatarColor = (index) => avatarColors[index % avatarColors.length];
    const getInitials = (u) => ((u.first_name?.[0] || '') + (u.last_name?.[0] || '')).toUpperCase() || '?';
    
    // Catégories concernées par les retards (depuis la BDD via data.settings)
    const [overdueCategories, setOverdueCategories] = useState(['SAV/Travaux', 'Mise en service']);
    
    // Charger les catégories de retard depuis data.settings
    useEffect(() => {
        if (data.settings) {
            const overdueRow = data.settings.find(s => s.key === 'overdue_categories');
            if (overdueRow?.value) {
                try {
                    setOverdueCategories(JSON.parse(overdueRow.value));
                } catch (e) { console.log('Error parsing overdue categories'); }
            }
        }
    }, [data.settings]);
    
    // Écouter les changements de paramètres
    useEffect(() => {
        const handleSettingsChange = (e) => {
            setOverdueCategories(e.detail);
        };
        window.addEventListener('overdue-settings-changed', handleSettingsChange);
        return () => window.removeEventListener('overdue-settings-changed', handleSettingsChange);
    }, []);
    
    // Fonction pour vérifier si une tâche est concernée par les retards
    const isOverdueCategory = (task) => {
        const category = task.event_category || '';
        return overdueCategories.includes(category) || 
               (overdueCategories.includes('Mise en service') && task.task_type === 'mes') ||
               (overdueCategories.includes('SAV/Travaux') && task.task_type === 'aide');
    };
    
    // Tâches en retard (planifiées dans le dernier mois, non terminées, catégories configurées, non encore replanifiées)
    const overdueTasks = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const oneMonthAgo = new Date(today);
        oneMonthAgo.setDate(oneMonthAgo.getDate() - 30);
        
        return [...events, ...scheduledTasks].filter(t => {
            if (!t.scheduled_date || t.status === 'termine') return false;
            // Exclure les tâches déjà replanifiées
            if (t.rescheduled_to) return false;
            // Filtrer uniquement les catégories configurées
            if (!isOverdueCategory(t)) return false;
            const taskDate = new Date(t.scheduled_date);
            taskDate.setHours(0, 0, 0, 0);
            return taskDate < today && taskDate >= oneMonthAgo;
        }).sort((a, b) => new Date(a.scheduled_date) - new Date(b.scheduled_date));
    }, [events, scheduledTasks, overdueCategories]);
    
    // Tâches en retard de la semaine précédente spécifiquement
    const lastWeekOverdueTasks = useMemo(() => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const oneWeekAgo = new Date(today);
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        
        return overdueTasks.filter(t => {
            const taskDate = new Date(t.scheduled_date);
            taskDate.setHours(0, 0, 0, 0);
            return taskDate >= oneWeekAgo;
        });
    }, [overdueTasks]);
    
    // Historique des replanifications (tâches qui ont été replanifiées)
    const rescheduledTasks = useMemo(() => {
        return [...events, ...scheduledTasks, ...data.tasks.filter(t => t.rescheduled_to)]
            .filter(t => t.rescheduled_to)
            .sort((a, b) => new Date(b.rescheduled_at || b.rescheduled_to) - new Date(a.rescheduled_at || a.rescheduled_to));
    }, [events, scheduledTasks, data.tasks]);
    
    // État pour afficher/masquer le détail des retards
    const [showOverdueDetails, setShowOverdueDetails] = useState(false);
    
    // Tâches non planifiées + tâches en retard (pour replanification) - exclut MES et aides
    const classiqueTasks = useMemo(() => {
        // Tâches sans date planifiée
        let tasks = data.tasks.filter(t => !t.scheduled_date && !t.is_event && t.status !== 'termine');
        
        // Ajouter les tâches en retard (exclure MES et aides qui sont dans leurs onglets)
        const overdueForReplan = overdueTasks
            .filter(t => t.task_type !== 'mes' && t.task_type !== 'aide')
            .map(t => ({
                ...t,
                _isOverdue: true,
                _originalDate: t.scheduled_date
            }));
        
        tasks = [...tasks, ...overdueForReplan];
        
        if (taskSearch) {
            const s = taskSearch.toLowerCase();
            tasks = tasks.filter(t => t.device_number?.toLowerCase().includes(s) || t.location?.toLowerCase().includes(s));
        }
        return tasks;
    }, [data.tasks, taskSearch, overdueTasks]);
    
    const mesTasks = useMemo(() => {
        // Récupérer les device_number déjà planifiés
        const plannedDeviceNumbers = data.tasks
            .filter(t => t.is_event && t.task_type === 'mes' && t.scheduled_date)
            .map(t => t.device_number);
        
        let devices = data.devices?.filter(d => 
            d.status !== 'termine' && !plannedDeviceNumbers.includes(d.device_number)
        ) || [];
        
        // Ajouter les MES en retard (pour replanification)
        const overdueMes = overdueTasks
            .filter(t => t.task_type === 'mes')
            .map(t => ({
                ...t,
                _isOverdue: true,
                _originalDate: t.scheduled_date,
                _isTask: true // Pour distinguer des devices
            }));
        
        if (taskSearch) {
            const s = taskSearch.toLowerCase();
            devices = devices.filter(d => d.device_number?.toLowerCase().includes(s) || d.site_name?.toLowerCase().includes(s));
        }
        return [...devices, ...overdueMes];
    }, [data.devices, data.tasks, taskSearch, overdueTasks]);
    
    const aidesTasks = useMemo(() => {
        let requests = data.requests?.filter(r => r.type === 'aide' && !['cloture', 'resolu', 'planifie'].includes(r.status)) || [];
        
        // Ajouter les aides en retard (pour replanification)
        const overdueAides = overdueTasks
            .filter(t => t.task_type === 'aide')
            .map(t => ({
                ...t,
                _isOverdue: true,
                _originalDate: t.scheduled_date,
                _isTask: true // Pour distinguer des requests
            }));
        
        if (taskSearch) {
            const s = taskSearch.toLowerCase();
            requests = requests.filter(r => r.subject?.toLowerCase().includes(s) || r.description?.toLowerCase().includes(s));
        }
        return [...requests, ...overdueAides];
    }, [data.requests, taskSearch, overdueTasks]);
    
    // Événements par technicien et jour (seulement les assignés)
    const getEventsForTechAndDay = (techId, date) => {
        const dateStr = date.toISOString().split('T')[0];
        return [...events, ...scheduledTasks].filter(e => 
            e.scheduled_date === dateStr && e.assigned_to === techId
        ).sort((a, b) => (a.scheduled_time || '').localeCompare(b.scheduled_time || ''));
    };
    
    // Événements non assignés
    const getUnassignedEventsForDay = (date) => {
        const dateStr = date.toISOString().split('T')[0];
        return [...events, ...scheduledTasks].filter(e => 
            e.scheduled_date === dateStr && !e.assigned_to
        ).sort((a, b) => (a.scheduled_time || '').localeCompare(b.scheduled_time || ''));
    };
    
    // Vérifier s'il y a des événements non assignés
    const hasUnassignedEvents = useMemo(() => {
        return [...events, ...scheduledTasks].some(e => e.scheduled_date && !e.assigned_to);
    }, [events, scheduledTasks]);
    
    // Obtenir la couleur de la catégorie
    const getCategoryStyle = (evt) => {
        const cat = categories.find(c => c.name === evt.event_category);
        if (cat?.color) {
            // Convertir hex en RGB pour créer une version pastel
            const hex = cat.color.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            return {
                background: `rgba(${r}, ${g}, ${b}, 0.15)`,
                borderColor: cat.color,
                icon: cat.icon || '📌'
            };
        }
        // Fallback selon task_type
        if (evt.task_type === 'mes') return { background: COLORS.purplePastel, borderColor: COLORS.purple, icon: '🚀' };
        if (evt.task_type === 'aide') return { background: COLORS.warningPastel, borderColor: COLORS.warning, icon: '⚙️' };
        return { background: COLORS.infoPastel, borderColor: COLORS.info, icon: '📋' };
    };
    
    // Drag & Drop
    const handleDragStart = (e, task, type = 'classique') => { setDraggedTask({ item: task, type }); e.dataTransfer.effectAllowed = 'move'; };
    const handleDragOver = (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; };
    
    const handleDrop = async (e, techId, date) => {
        e.preventDefault();
        if (!draggedTask || !canEdit) return;
        const { item, type } = draggedTask;
        const dateStr = date.toISOString().split('T')[0];
        
        try {
            if (type === 'classique') {
                // Si c'est une tâche en retard, on crée une copie (l'originale reste dans le planning passé)
                if (item._isOverdue) {
                    // Déterminer si c'est un événement ou une tâche classique
                    const isEvent = item.is_event === true;
                    
                    // Créer la nouvelle tâche (sans rescheduled_from pour compatibilité)
                    const newTaskData = {
                        device_number: item.device_number,
                        location: item.location || '',
                        work_list: item.work_list || '',
                        site_name: item.site_name || null,
                        tournee: item.tournee || null,
                        priority: item.priority || null,
                        status: isEvent ? 'en-stock' : 'en-commande',
                        assigned_to: techId,
                        scheduled_date: dateStr,
                        scheduled_time: item.scheduled_time || null,
                        estimated_duration: item.estimated_duration || 60,
                        event_category: item.event_category || null,
                        is_event: isEvent,
                        task_type: item.task_type || null
                    };
                    
                    const { data: insertedTask, error: insertError } = await db.from('tasks').insert(newTaskData).select();
                    if (insertError) {
                        console.error('Erreur insertion:', insertError);
                        showToast('Erreur: ' + insertError.message, 'error');
                        setDraggedTask(null);
                        return;
                    }
                    
                    console.log('Tâche insérée:', insertedTask);
                    
                    // Mettre à jour la tâche originale avec la date de replanification
                    try {
                        await db.from('tasks').update({ 
                            rescheduled_to: dateStr,
                            rescheduled_at: new Date().toISOString()
                        }).eq('id', item.id);
                    } catch (updateErr) {
                        console.log('Colonnes rescheduled non disponibles:', updateErr);
                    }
                    
                    showToast('Tâche replanifiée (copie créée)', 'success');
                } else {
                    await db.from('tasks').update({ scheduled_date: dateStr, assigned_to: techId }).eq('id', item.id);
                    showToast('Tâche planifiée', 'success');
                }
            } else if (type === 'mes') {
                // Si c'est une MES en retard
                if (item._isOverdue && item._isTask) {
                    const newMesData = {
                        device_number: item.device_number,
                        location: item.location || '',
                        work_list: item.work_list || '',
                        status: 'en-stock',
                        assigned_to: techId,
                        scheduled_date: dateStr,
                        scheduled_time: item.scheduled_time || null,
                        estimated_duration: item.estimated_duration || 240,
                        event_category: item.event_category || 'Mise en service',
                        is_event: true,
                        task_type: 'mes'
                    };
                    
                    const { data: insertedMes, error: insertError } = await db.from('tasks').insert(newMesData).select();
                    if (insertError) {
                        console.error('Erreur insertion MES:', insertError);
                        showToast('Erreur: ' + insertError.message, 'error');
                        setDraggedTask(null);
                        return;
                    }
                    
                    console.log('MES insérée:', insertedMes);
                    
                    try {
                        await db.from('tasks').update({ 
                            rescheduled_to: dateStr,
                            rescheduled_at: new Date().toISOString()
                        }).eq('id', item.id);
                    } catch (updateErr) {
                        console.log('Colonnes rescheduled non disponibles:', updateErr);
                    }
                    showToast('MES replanifiée (copie créée)', 'success');
                } else {
                    await db.from('tasks').insert({
                        device_number: item.device_number,
                        location: item.address_city || item.site_name || '',
                        work_list: 'Mise en service - ' + (item.site_name || item.device_number),
                        status: 'en-stock', assigned_to: techId, is_event: true,
                        scheduled_date: dateStr, estimated_duration: 240,
                        event_category: 'Mise en service', task_type: 'mes'
                    });
                    showToast('MES planifiée', 'success');
                }
            } else if (type === 'aide') {
                // Si c'est une aide en retard
                if (item._isOverdue && item._isTask) {
                    const newAideData = {
                        device_number: item.device_number,
                        location: item.location || '',
                        work_list: item.work_list || '',
                        status: 'en-stock',
                        assigned_to: techId,
                        scheduled_date: dateStr,
                        scheduled_time: item.scheduled_time || null,
                        estimated_duration: item.estimated_duration || 60,
                        event_category: item.event_category || 'SAV/Travaux',
                        is_event: true,
                        task_type: 'aide'
                    };
                    
                    const { data: insertedAide, error: insertError } = await db.from('tasks').insert(newAideData).select();
                    if (insertError) {
                        console.error('Erreur insertion aide:', insertError);
                        showToast('Erreur: ' + insertError.message, 'error');
                        setDraggedTask(null);
                        return;
                    }
                    
                    console.log('Aide insérée:', insertedAide);
                    
                    try {
                        await db.from('tasks').update({ 
                            rescheduled_to: dateStr,
                            rescheduled_at: new Date().toISOString()
                        }).eq('id', item.id);
                    } catch (updateErr) {
                        console.log('Colonnes rescheduled non disponibles:', updateErr);
                    }
                    showToast('Aide replanifiée (copie créée)', 'success');
                } else {
                    await db.from('tasks').insert({
                        device_number: 'Aide #' + item.id,
                        location: item.device_number || '',
                        work_list: item.description || item.subject,
                        status: 'en-stock', assigned_to: techId, is_event: true,
                        scheduled_date: dateStr, estimated_duration: 60,
                        event_category: 'SAV/Travaux', task_type: 'aide'
                    });
                    await db.from('requests').update({ status: 'planifie', scheduled_date: dateStr }).eq('id', item.id);
                    showToast('Aide planifiée', 'success');
                }
            } else if (type === 'event') {
                // Si c'est un événement en retard, on crée une copie
                if (item._isOverdue) {
                    const newEventData = {
                        device_number: item.device_number,
                        location: item.location || '',
                        work_list: item.work_list || '',
                        status: 'en-stock',
                        assigned_to: techId,
                        scheduled_date: dateStr,
                        scheduled_time: item.scheduled_time || null,
                        estimated_duration: item.estimated_duration || 60,
                        event_category: item.event_category || null,
                        is_event: true,
                        task_type: item.task_type || null
                    };
                    
                    const { data: insertedEvent, error: insertError } = await db.from('tasks').insert(newEventData).select();
                    if (insertError) {
                        console.error('Erreur insertion événement:', insertError);
                        showToast('Erreur: ' + insertError.message, 'error');
                        setDraggedTask(null);
                        return;
                    }
                    
                    console.log('Événement inséré:', insertedEvent);
                    
                    // Mettre à jour la tâche originale avec la date de replanification
                    try {
                        await db.from('tasks').update({ 
                            rescheduled_to: dateStr,
                            rescheduled_at: new Date().toISOString()
                        }).eq('id', item.id);
                    } catch (updateErr) {
                        console.log('Colonnes rescheduled non disponibles:', updateErr);
                    }
                    showToast('Événement replanifié (copie créée)', 'success');
                } else {
                    await db.from('tasks').update({ scheduled_date: dateStr, assigned_to: techId }).eq('id', item.id);
                    showToast('Tâche déplacée', 'success');
                }
            }
            refresh();
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
        setDraggedTask(null);
    };
    
    const removeFromPlanning = async (e, evt) => {
        e.stopPropagation();
        if (!canEdit) return;
        try {
            if (evt.is_event) {
                await db.from('tasks').delete().eq('id', evt.id);
                if (evt.task_type === 'aide' && evt.device_number?.startsWith('Aide #')) {
                    const aideId = evt.device_number.replace('Aide #', '');
                    await db.from('requests').update({ status: 'en_cours', scheduled_date: null }).eq('id', parseInt(aideId));
                }
                showToast('Événement supprimé');
            } else {
                await db.from('tasks').update({ scheduled_date: null, scheduled_time: null, assigned_to: null }).eq('id', evt.id);
                showToast('Planification annulée');
            }
            refresh();
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const saveEvent = async (formData) => {
        try {
            const eventData = {
                device_number: formData.title, location: formData.description || '',
                scheduled_date: formData.date, scheduled_time: formData.time || null,
                estimated_duration: formData.duration || 60,
                event_category: formData.category || null,
                assigned_to: formData.assignee || null,
                is_event: true, status: 'en-stock'
            };
            if (editEvent) {
                await db.from('tasks').update(eventData).eq('id', editEvent.id);
                showToast('Événement modifié');
                
                // Notifier si l'assigné a changé
                if (eventData.assigned_to && eventData.assigned_to !== editEvent.assigned_to && eventData.assigned_to !== user.id) {
                    createNotification({
                        userId: eventData.assigned_to,
                        type: 'planning_event_assigned',
                        title: 'Événement assigné',
                        body: `${eventData.device_number} le ${new Date(eventData.scheduled_date).toLocaleDateString('fr-FR')}`,
                        actionUrl: '/planning',
                    });
                }
            } else {
                const { data: newEvent } = await db.from('tasks').insert(eventData).select().single();
                showToast('Événement créé');
                
                // Notifier le technicien assigné
                if (eventData.assigned_to && eventData.assigned_to !== user.id) {
                    createNotification({
                        userId: eventData.assigned_to,
                        type: 'planning_event_assigned',
                        title: 'Nouvel événement planifié',
                        body: `${eventData.device_number} - ${eventData.event_category || 'Événement'} le ${new Date(eventData.scheduled_date).toLocaleDateString('fr-FR')}`,
                        actionUrl: '/planning',
                    });
                }
            }
            refresh(); setShowAddModal(false); setEditEvent(null);
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const exportPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape');
        const pageWidth = 297;
        
        // Couleurs par catégorie (version pastel pour le PDF)
        const getCategoryColor = (cat) => {
            const catObj = categories.find(c => c.name === cat);
            if (catObj?.color) {
                // Convertir hex en RGB puis en version pastel (mélange avec blanc)
                const hex = catObj.color.replace('#', '');
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                // Mélanger avec blanc pour obtenir une version pastel (70% blanc, 30% couleur)
                return {
                    r: Math.round(255 * 0.7 + r * 0.3),
                    g: Math.round(255 * 0.7 + g * 0.3),
                    b: Math.round(255 * 0.7 + b * 0.3)
                };
            }
            return { r: 235, g: 243, b: 254 }; // Bleu pastel par défaut
        };
        
        // En-tête moderne (adapté pour paysage)
        const headerHeight = 32;
        const logoWidth = 42;
        const logoHeight = 20;
        
        // Dégradé rouge
        for (let i = 0; i < 6; i++) {
            const ratio = i / 6;
            doc.setFillColor(Math.round(127 + ratio * 112), Math.round(29 + ratio * 39), Math.round(29 + ratio * 39));
            doc.rect(0, (headerHeight / 6) * i, pageWidth, headerHeight / 6 + 1, 'F');
        }
        doc.setFillColor(55, 65, 81);
        doc.rect(0, headerHeight - 2, pageWidth, 2, 'F');
        
        // Logo avec fond blanc
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(8, 4, logoWidth + 4, logoHeight + 4, 2, 2, 'F');
        try {
            doc.addImage(COMPANY_LOGO, 'PNG', 10, 6, logoWidth, logoHeight);
        } catch (e) {
            doc.setFontSize(8);
            doc.setTextColor(225, 29, 72);
            doc.text('Auvergne Asc.', 12, 15);
        }
        
        // Titre
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('PLANNING ' + (viewMode === 'day' ? 'JOUR' : 'SEMAINE'), pageWidth / 2, 12, { align: 'center' });
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(226, 232, 240);
        doc.text(getTitle(), pageWidth / 2, 22, { align: 'center' });
        
        // Date
        doc.setFontSize(7);
        doc.setTextColor(200, 200, 220);
        doc.text(new Date().toLocaleDateString('fr-FR'), pageWidth - 10, headerHeight - 5, { align: 'right' });
        
        let y = headerHeight + 6;
        const techColWidth = 50;
        const dayColWidth = (pageWidth - techColWidth - 20) / displayDays.length;
        
        // En-tête des jours avec couleur rouge
        doc.setFillColor(225, 29, 72);
        doc.rect(10, y, techColWidth, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(8);
        doc.text('Technicien', 10 + techColWidth/2, y + 7, { align: 'center' });
        displayDays.forEach((day, i) => {
            const x = 10 + techColWidth + (i * dayColWidth);
            doc.setFillColor(isToday(day) ? 239 : 190, isToday(day) ? 68 : 18, isToday(day) ? 68 : 60);
            doc.rect(x, y, dayColWidth, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.text(dayNames[day.getDay() === 0 ? 6 : day.getDay() - 1] + ' ' + day.getDate(), x + dayColWidth/2, y + 7, { align: 'center' });
        });
        y += 12;
        
        // Légende des catégories
        doc.setFontSize(7);
        doc.setTextColor(100, 100, 100);
        let legendX = 10;
        categories.slice(0, 8).forEach(cat => {
            const color = getCategoryColor(cat.name);
            doc.setFillColor(color.r, color.g, color.b);
            doc.rect(legendX, y, 4, 4, 'F');
            doc.text(cat.name.substring(0, 12), legendX + 5, y + 3);
            legendX += 35;
        });
        y += 8;
        
        // Lignes des techniciens
        technicians.forEach(tech => {
            if (y > 185) { doc.addPage(); y = 20; }
            
            // Calculer la hauteur max pour ce technicien
            let maxEventsInRow = 1;
            displayDays.forEach(day => {
                const evts = getEventsForTechAndDay(tech.id, day);
                if (evts.length > maxEventsInRow) maxEventsInRow = evts.length;
            });
            const rowHeight = Math.max(16, maxEventsInRow * 12 + 4);
            
            doc.setFillColor(248, 250, 252);
            doc.rect(10, y, techColWidth, rowHeight, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(8);
            doc.text(((tech.first_name || '') + ' ' + (tech.last_name || '')).trim().substring(0, 18), 12, y + 10);
            
            displayDays.forEach((day, i) => {
                const x = 10 + techColWidth + (i * dayColWidth);
                const evts = getEventsForTechAndDay(tech.id, day);
                doc.setFillColor(255, 255, 255);
                doc.rect(x, y, dayColWidth, rowHeight, 'F');
                doc.setDrawColor(226, 232, 240);
                doc.rect(x, y, dayColWidth, rowHeight, 'S');
                
                evts.forEach((evt, j) => {
                    if (j >= 5) return; // Max 5 événements affichés
                    const evtY = y + 2 + j * 12;
                    const color = getCategoryColor(evt.event_category);
                    
                    // Fond coloré selon catégorie
                    doc.setFillColor(color.r, color.g, color.b);
                    doc.rect(x + 1, evtY, dayColWidth - 2, 11, 'F');
                    
                    // Titre avec heure
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(6);
                    doc.setFont(undefined, 'bold');
                    const title = (evt.scheduled_time ? evt.scheduled_time + ' ' : '') + (evt.device_number || '').substring(0, 18);
                    doc.text(title, x + 2, evtY + 4);
                    
                    // Catégorie
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(5);
                    doc.setTextColor(80, 80, 80);
                    if (evt.event_category) {
                        doc.text(evt.event_category.substring(0, 15), x + 2, evtY + 7);
                    }
                    
                    // Description (si existe)
                    if (evt.location) {
                        doc.setFontSize(5);
                        doc.setTextColor(100, 100, 100);
                        doc.text(evt.location.substring(0, 20), x + 2, evtY + 10);
                    }
                });
            });
            y += rowHeight;
        });
        
        doc.save('planning-' + currentDate.toISOString().split('T')[0] + '.pdf');
        showToast('PDF exporté');
    };
    
    // État pour le modal de duplication
    const [duplicateEventData, setDuplicateEventData] = useState(null);
    
    // Dupliquer un événement sur plusieurs jours consécutifs
    const duplicateEvent = async (evt, days) => {
        try {
            const inserts = [];
            const startDate = new Date(evt.scheduled_date);
            
            for (let i = 1; i <= days; i++) {
                const newDate = new Date(startDate);
                newDate.setDate(newDate.getDate() + i);
                
                // Pour "semaine", sauter les weekends
                if (days === 5) {
                    const dayOfWeek = newDate.getDay();
                    if (dayOfWeek === 0) newDate.setDate(newDate.getDate() + 1); // Dimanche → Lundi
                    if (dayOfWeek === 6) newDate.setDate(newDate.getDate() + 2); // Samedi → Lundi
                }
                
                inserts.push({
                    device_number: evt.device_number,
                    location: evt.location,
                    work_list: evt.work_list,
                    scheduled_date: newDate.toISOString().split('T')[0],
                    scheduled_time: evt.scheduled_time,
                    estimated_duration: evt.estimated_duration,
                    event_category: evt.event_category,
                    assigned_to: evt.assigned_to,
                    is_event: true,
                    status: 'en-stock',
                    task_type: evt.task_type
                });
            }
            
            await db.from('tasks').insert(inserts);
            showToast(`${days} événement(s) créé(s)`);
            refresh();
            setDuplicateEventData(null);
            setViewEvent(null);
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    // Modal de duplication simple
    const DuplicateEventModal = () => {
        if (!duplicateEventData) return null;
        
        const options = [
            { label: '1 jour', days: 1, desc: 'Demain' },
            { label: '2 jours', days: 2, desc: 'Demain + après-demain' },
            { label: '3 jours', days: 3, desc: '3 jours consécutifs' },
            { label: '4 jours', days: 4, desc: '4 jours consécutifs' },
            { label: 'Semaine', days: 5, desc: '5 jours (lun-ven)' }
        ];
        
        return h(Modal, { 
            isOpen: true, 
            onClose: () => setDuplicateEventData(null), 
            title: '📋 Dupliquer l\'événement', 
            size: 'sm'
        },
            // Résumé de l'événement
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, marginBottom: 16 } },
                h('div', { style: { fontWeight: 600, marginBottom: 4 } }, duplicateEventData.device_number),
                h('div', { style: { fontSize: 13, color: COLORS.muted } }, 
                    formatDate(duplicateEventData.scheduled_date),
                    duplicateEventData.scheduled_time && ` à ${duplicateEventData.scheduled_time}`
                )
            ),
            
            // Boutons de duplication
            h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                options.map(opt => h('button', {
                    key: opt.days,
                    className: 'btn btn-secondary',
                    style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 16px' },
                    onClick: () => duplicateEvent(duplicateEventData, opt.days)
                },
                    h('span', { style: { fontWeight: 600 } }, opt.label),
                    h('span', { style: { fontSize: 12, color: COLORS.muted } }, opt.desc)
                ))
            ),
            
            // Bouton Annuler
            h('div', { style: { marginTop: 16, textAlign: 'center' } },
                h('button', { className: 'btn btn-ghost', onClick: () => setDuplicateEventData(null) }, 'Annuler')
            )
        );
    };
    
    const EventFormModal = () => {
        const [form, setForm] = useState({
            title: editEvent?.device_number || '', description: editEvent?.location || '',
            date: editEvent?.scheduled_date || new Date().toISOString().split('T')[0],
            time: editEvent?.scheduled_time || '', duration: editEvent?.estimated_duration || 60,
            category: editEvent?.event_category || '', assignee: editEvent?.assigned_to || ''
        });
        return h(Modal, { isOpen: true, onClose: () => { setShowAddModal(false); setEditEvent(null); }, title: editEvent ? 'Modifier' : 'Nouvel événement', size: 'md',
            footer: h(Fragment, null, h('button', { className: 'btn btn-secondary', onClick: () => { setShowAddModal(false); setEditEvent(null); } }, 'Annuler'), h('button', { className: 'btn btn-primary', onClick: () => saveEvent(form) }, 'Enregistrer'))
        },
            h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Titre *'), h('input', { className: 'form-input', value: form.title, onChange: e => setForm({...form, title: e.target.value}) })),
            h('div', { className: 'form-row' },
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Date'), h('input', { type: 'date', className: 'form-input', value: form.date, onChange: e => setForm({...form, date: e.target.value}) })),
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Heure'), h('input', { type: 'time', className: 'form-input', value: form.time, onChange: e => setForm({...form, time: e.target.value}) }))
            ),
            h('div', { className: 'form-row' },
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Catégorie'), h('select', { className: 'form-select', value: form.category, onChange: e => setForm({...form, category: e.target.value}) }, h('option', { value: '' }, 'Sélectionner...'), categories.map(c => h('option', { key: c.id, value: c.name }, c.icon + ' ' + c.name)))),
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Assigné à'), h('select', { className: 'form-select', value: form.assignee, onChange: e => setForm({...form, assignee: e.target.value}) }, h('option', { value: '' }, 'Sélectionner...'), allTechnicians.map(t => h('option', { key: t.id, value: t.id }, (t.first_name || '') + ' ' + (t.last_name || '')))))
            ),
            h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Description'), h('textarea', { className: 'form-textarea', value: form.description, onChange: e => setForm({...form, description: e.target.value}), rows: 2 }))
        );
    };
    
    // Gestion des catégories du planning
    const addPlanningCategory = async () => {
        if (!newCategoryForm.name.trim()) return;
        try {
            const catId = newCategoryForm.name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
            await db.from('event_categories').insert({ 
                id: catId,
                name: newCategoryForm.name.trim(), 
                color: newCategoryForm.color,
                icon: newCategoryForm.icon
            });
            showToast('Catégorie ajoutée');
            setNewCategoryForm({ name: '', color: '#3B82F6', icon: '📌' });
            refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const updatePlanningCategory = async (cat) => {
        try {
            await db.from('event_categories').update({ 
                name: editPlanningCategory.name,
                color: editPlanningCategory.color,
                icon: editPlanningCategory.icon
            }).eq('id', cat.id);
            showToast('Catégorie modifiée');
            setEditPlanningCategory(null);
            refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const deletePlanningCategory = async (cat) => {
        try {
            await db.from('event_categories').delete().eq('id', cat.id);
            showToast('Catégorie supprimée');
            refresh();
        } catch (err) { showToast(err.message, 'error'); }
    };
    
    const iconOptions = ['📌', '🔍', '🛠️', '🚀', '⚙️', '👥', '📚', '🚗', '🏖️', '📋', '💼', '📞', '🎯', '⭐', '🔧', '📦', '🏠', '🔔', '✅', '❌'];
    const colorOptions = ['#3B82F6', '#10B981', '#8B5CF6', '#F97316', '#EC4899', '#06B6D4', '#14B8A6', '#EF4444', '#F59E0B', '#6366F1', '#84CC16', '#78716C'];
    
    const PlanningCategoriesModal = () => h(Modal, { isOpen: true, onClose: () => { setShowPlanningCategories(false); setEditPlanningCategory(null); setNewCategoryForm({ name: '', color: '#3B82F6', icon: '📌' }); }, title: 'Catégories du planning', size: 'md' },
        h('div', { style: { marginBottom: 20 } },
            h('div', { style: { fontWeight: 600, marginBottom: 12 } }, 'Nouvelle catégorie'),
            h('div', { style: { display: 'flex', gap: 8, marginBottom: 8 } },
                h('input', { className: 'form-input', placeholder: 'Nom de la catégorie...', value: newCategoryForm.name, onChange: e => setNewCategoryForm({...newCategoryForm, name: e.target.value}), style: { flex: 1 } }),
                h('button', { className: 'btn btn-primary', onClick: addPlanningCategory, disabled: !newCategoryForm.name.trim() }, h(Icon, { name: 'plus', size: 16 }))
            ),
            h('div', { style: { display: 'flex', gap: 12, alignItems: 'center' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                    h('span', { style: { fontSize: 13, color: COLORS.muted } }, 'Icône:'),
                    h('div', { style: { display: 'flex', gap: 4, flexWrap: 'wrap' } },
                        iconOptions.slice(0, 10).map(icon => h('button', { key: icon, type: 'button', onClick: () => setNewCategoryForm({...newCategoryForm, icon}), style: { padding: '4px 8px', border: newCategoryForm.icon === icon ? `2px solid ${COLORS.primary}` : `1px solid ${COLORS.border}`, borderRadius: 4, background: 'white', cursor: 'pointer' } }, icon))
                    )
                ),
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                    h('span', { style: { fontSize: 13, color: COLORS.muted } }, 'Couleur:'),
                    h('input', { type: 'color', value: newCategoryForm.color, onChange: e => setNewCategoryForm({...newCategoryForm, color: e.target.value}), style: { width: 32, height: 32, padding: 0, border: 'none', cursor: 'pointer' } })
                )
            )
        ),
        h('div', { style: { borderTop: `1px solid ${COLORS.border}`, paddingTop: 16 } },
            h('div', { style: { fontWeight: 600, marginBottom: 12 } }, 'Catégories existantes'),
            categories.length === 0 ? h('div', { style: { textAlign: 'center', padding: 30, color: COLORS.muted } }, 'Aucune catégorie') :
            h('div', null,
                categories.map(cat => {
                    const isEditing = editPlanningCategory?.id === cat.id;
                    return h('div', { key: cat.id, style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 12, borderBottom: `1px solid ${COLORS.border}`, background: isEditing ? COLORS.background : 'transparent' } },
                        isEditing ? h('div', { style: { flex: 1, display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap' } },
                            h('select', { className: 'form-select', value: editPlanningCategory.icon, onChange: e => setEditPlanningCategory({...editPlanningCategory, icon: e.target.value}), style: { width: 60 } },
                                iconOptions.map(icon => h('option', { key: icon, value: icon }, icon))
                            ),
                            h('input', { className: 'form-input', value: editPlanningCategory.name, onChange: e => setEditPlanningCategory({...editPlanningCategory, name: e.target.value}), style: { flex: 1, minWidth: 120 } }),
                            h('input', { type: 'color', value: editPlanningCategory.color, onChange: e => setEditPlanningCategory({...editPlanningCategory, color: e.target.value}), style: { width: 32, height: 32 } }),
                            h('button', { className: 'btn btn-success btn-sm', onClick: () => updatePlanningCategory(cat) }, h(Icon, { name: 'check', size: 14 })),
                            h('button', { className: 'btn btn-secondary btn-sm', onClick: () => setEditPlanningCategory(null) }, h(Icon, { name: 'x', size: 14 }))
                        ) : h(Fragment, null,
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                h('span', { style: { fontSize: 20 } }, cat.icon),
                                h('div', null,
                                    h('div', { style: { fontWeight: 500 } }, cat.name),
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginTop: 4 } },
                                        h('div', { style: { width: 16, height: 16, borderRadius: 4, background: cat.color } }),
                                        h('span', { style: { fontSize: 11, color: COLORS.muted, fontFamily: 'monospace' } }, cat.color)
                                    )
                                )
                            ),
                            h('div', { style: { display: 'flex', gap: 4 } },
                                h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setEditPlanningCategory({...cat}), title: 'Modifier' }, h(Icon, { name: 'edit', size: 14 })),
                                h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => deletePlanningCategory(cat), title: 'Supprimer', style: { color: COLORS.danger } }, h(Icon, { name: 'trash', size: 14 }))
                            )
                        )
                    );
                })
            )
        )
    );
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' },
                h('h1', { className: 'page-title' }, 'Planning'),
                h('p', { className: 'page-subtitle' }, getTitle())
            ),
            h('div', { className: 'page-actions' },
                h('div', { style: { display: 'flex', gap: 4, background: COLORS.background, borderRadius: 8, padding: 4, marginRight: 8 } },
                    h('button', { className: `btn btn-sm ${viewMode === 'day' ? 'btn-primary' : 'btn-ghost'}`, onClick: () => { setViewMode('day'); setShowGanttView(false); } }, 'Jour'),
                    h('button', { className: `btn btn-sm ${viewMode === 'week' && !showGanttView ? 'btn-primary' : 'btn-ghost'}`, onClick: () => { setViewMode('week'); setShowGanttView(false); } }, 'Semaine'),
                    h('button', { className: `btn btn-sm ${showGanttView ? 'btn-primary' : 'btn-ghost'}`, onClick: () => setShowGanttView(!showGanttView), title: 'Vue Gantt' }, '📊 Gantt')
                ),
                h('button', { className: 'btn btn-secondary', onClick: goToday }, "Aujourd'hui"),
                h('button', { className: 'btn btn-ghost btn-icon', onClick: () => navigate(-1) }, h(Icon, { name: 'chevronLeft', size: 18 })),
                h('button', { className: 'btn btn-ghost btn-icon', onClick: () => navigate(1) }, h(Icon, { name: 'chevronRight', size: 18 })),
                h('button', { className: 'btn btn-secondary', onClick: exportPDF, title: 'Exporter en PDF' }, h(Icon, { name: 'pdf', size: 16 }), 'PDF'),
                h('button', { className: 'btn btn-secondary', onClick: () => setShowReportsModal(true), title: 'Rapports automatiques' }, '📊 Rapports'),
                rescheduledTasks.length > 0 && h('button', { 
                    className: 'btn btn-secondary', 
                    onClick: () => setShowHistoryModal(true),
                    style: { position: 'relative' }
                }, 
                    h(Icon, { name: 'clock', size: 16 }), 
                    'Historique',
                    h('span', { style: { 
                        position: 'absolute', 
                        top: -6, 
                        right: -6, 
                        background: COLORS.info, 
                        color: 'white', 
                        fontSize: 10, 
                        padding: '2px 6px', 
                        borderRadius: 10, 
                        fontWeight: 600 
                    } }, rescheduledTasks.length)
                ),
                isAdmin && h('button', { className: 'btn btn-secondary', onClick: () => setShowPlanningCategories(true) }, h(Icon, { name: 'settings', size: 16 }), 'Catégories'),
                isAdmin && h('button', { className: 'btn btn-secondary', onClick: () => setShowRecurrenceModal(true), title: 'Tâches récurrentes' }, '🔄 Récurrence'),
                isAdmin && h('button', { className: 'btn btn-secondary', onClick: () => setShowAvailabilityModal(true), title: 'Gérer les indisponibilités' }, '📅 Dispo.'),
                h('button', { className: 'btn btn-secondary', onClick: () => setShowOptimizeModal(true), title: 'Optimiser les tournées' }, '🚀 Optimiser'),
                h('button', { 
                    className: 'btn btn-secondary', 
                    onClick: () => {
                        // Récupérer les tâches du jour avec GPS
                        const todayTasks = [...events, ...scheduledTasks].filter(t => 
                            t.scheduled_date === selectedDate && t.latitude && t.longitude
                        );
                        window.dispatchEvent(new CustomEvent('open-route-optimizer', { detail: { tasks: todayTasks } }));
                    }, 
                    title: 'Calculer l\'itinéraire optimal avec GPS' 
                }, '🗺️ Itinéraire'),
                canEdit && h('button', { className: 'btn btn-primary', onClick: () => setShowAddModal(true) }, h(Icon, { name: 'plus', size: 18 }), 'Événement')
            )
        ),
        
        // Bannière d'alerte pour les tâches en retard
        overdueTasks.length > 0 && h('div', { 
            style: { 
                marginBottom: 16, 
                padding: '12px 16px', 
                background: 'linear-gradient(135deg, #FEF2F2, #FEE2E2)', 
                borderRadius: 12, 
                border: '1px solid #FECACA',
                cursor: 'pointer'
            },
            onClick: () => setShowOverdueDetails(!showOverdueDetails)
        },
            h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('div', { style: { 
                        width: 40, height: 40, borderRadius: '50%', 
                        background: '#EF4444', color: 'white', 
                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                        fontSize: 18, fontWeight: 700
                    } }, overdueTasks.length),
                    h('div', null,
                        h('div', { style: { fontWeight: 600, color: '#DC2626' } }, 
                            `${overdueTasks.length} tâche${overdueTasks.length > 1 ? 's' : ''} en retard`
                        ),
                        h('div', { style: { fontSize: 13, color: '#991B1B' } }, 
                            lastWeekOverdueTasks.length > 0 
                                ? `dont ${lastWeekOverdueTasks.length} de la semaine dernière`
                                : 'Tâches planifiées non terminées'
                        )
                    )
                ),
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                    h(Icon, { name: showOverdueDetails ? 'chevronDown' : 'chevronRight', size: 20, color: '#DC2626' })
                )
            ),
            // Détails des tâches en retard
            showOverdueDetails && h('div', { style: { marginTop: 16, maxHeight: 300, overflow: 'auto' } },
                h('div', { style: { display: 'grid', gap: 8 } },
                    overdueTasks.map(task => {
                        const tech = technicians.find(t => t.id === task.assigned_to);
                        const daysLate = Math.floor((new Date() - new Date(task.scheduled_date)) / (1000 * 60 * 60 * 24));
                        return h('div', { 
                            key: task.id, 
                            style: { 
                                padding: '10px 12px', 
                                background: 'white', 
                                borderRadius: 8, 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                                border: '1px solid #FECACA'
                            }
                        },
                            h('div', { style: { flex: 1 } },
                                h('div', { style: { fontWeight: 600, color: COLORS.text } }, task.device_number || task.title || 'Sans titre'),
                                h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 2 } },
                                    formatDate(task.scheduled_date),
                                    ' • ',
                                    tech ? `${tech.first_name} ${tech.last_name}` : 'Non assigné',
                                    task.event_category && ` • ${task.event_category}`
                                )
                            ),
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                h('span', { style: { 
                                    fontSize: 11, 
                                    padding: '4px 8px', 
                                    borderRadius: 12, 
                                    background: daysLate > 7 ? '#FEE2E2' : '#FEF3C7',
                                    color: daysLate > 7 ? '#DC2626' : '#D97706',
                                    fontWeight: 600
                                } }, `${daysLate}j de retard`),
                                canEdit && h('button', { 
                                    className: 'btn btn-success btn-sm',
                                    onClick: (e) => { 
                                        e.stopPropagation(); 
                                        db.from('tasks').update({ status: 'termine', completed_at: new Date().toISOString() }).eq('id', task.id).then(() => { refresh(); showToast('Tâche terminée'); });
                                    },
                                    title: 'Marquer comme terminée'
                                }, '✓')
                            )
                        );
                    })
                )
            )
        ),
        
        // Grille planning
        h('div', { className: 'card', style: { marginBottom: 16 } },
            h('div', { className: 'card-body no-padding' },
                h('div', { style: { display: 'grid', gridTemplateColumns: `120px repeat(${displayDays.length}, 1fr)`, borderBottom: `1px solid ${COLORS.border}` } },
                    h('div', { style: { padding: 12, fontWeight: 600, fontSize: 12, color: COLORS.muted, background: COLORS.background } }, 'Technicien'),
                    displayDays.map((day, i) => {
                        const hasOverdue = hasOverdueTasksOnDay(day);
                        const past = isPastDay(day);
                        return h('div', { key: i, style: {
                            padding: 12, textAlign: 'center', fontWeight: 600, fontSize: 12,
                            background: isToday(day) ? COLORS.primaryPastel : hasOverdue ? '#FEE2E2' : COLORS.background,
                            color: isToday(day) ? COLORS.primary : hasOverdue ? '#DC2626' : COLORS.text,
                            position: 'relative'
                        }},
                            h('div', null, dayNames[day.getDay() === 0 ? 6 : day.getDay() - 1]),
                            h('div', { style: { fontSize: 18, marginTop: 2 } }, day.getDate()),
                            hasOverdue && h('div', { style: { 
                                position: 'absolute', 
                                top: 4, 
                                right: 4, 
                                width: 8, 
                                height: 8, 
                                borderRadius: '50%', 
                                background: '#EF4444',
                                animation: 'pulse 2s infinite'
                            } })
                        );
                    })
                ),
                h('div', { style: { maxHeight: 'calc(100vh - 380px)', overflow: 'auto' } },
                    technicians.length === 0 && !hasUnassignedEvents ? h('div', { style: { padding: 40, textAlign: 'center', color: COLORS.muted } }, 'Aucun technicien. Ajoutez des utilisateurs avec le rôle technicien ou admin.') :
                    h(Fragment, null,
                        // Ligne "Non assigné" si des événements existent sans technicien
                        hasUnassignedEvents && h('div', { style: { display: 'grid', gridTemplateColumns: `120px repeat(${displayDays.length}, 1fr)`, borderBottom: `1px solid ${COLORS.border}`, background: COLORS.warningPastel } },
                            h('div', { style: { padding: 12, display: 'flex', alignItems: 'center', gap: 8 } },
                                h('div', { style: { width: 32, height: 32, borderRadius: '50%', background: COLORS.warning, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 12, fontWeight: 600 } }, '?'),
                                h('span', { style: { fontSize: 13, fontWeight: 500, color: COLORS.warning } }, 'Non assigné')
                            ),
                            displayDays.map((day, di) => {
                                const dayEvents = getUnassignedEventsForDay(day);
                                const past = isPastDay(day);
                                return h('div', {
                                    key: di, onDragOver: handleDragOver,
                                    style: { padding: 4, minHeight: viewMode === 'day' ? 150 : 80, background: isToday(day) ? '#FEF3C7' : '#FFFBEB', borderLeft: `1px solid ${COLORS.border}` }
                                },
                                    dayEvents.map(evt => {
                                        const catStyle = getCategoryStyle(evt);
                                        const isOverdue = past && evt.status !== 'termine' && isOverdueCategory(evt);
                                        const isRescheduled = evt.rescheduled_to;
                                        return h('div', {
                                            key: evt.id, draggable: canEdit && !isRescheduled, onDragStart: (e) => handleDragStart(e, evt, 'event'), onClick: () => setViewEvent(evt),
                                            style: { 
                                                padding: '6px 8px', marginBottom: 4, borderRadius: 6, fontSize: 11, 
                                                background: isRescheduled ? '#D1FAE5' : (isOverdue ? '#FEE2E2' : catStyle.background), 
                                                borderLeft: `3px solid ${isRescheduled ? '#10B981' : (isOverdue ? '#EF4444' : catStyle.borderColor)}`, 
                                                cursor: 'pointer', position: 'relative', 
                                                border: isRescheduled ? '1px solid #A7F3D0' : '2px dashed #EF4444',
                                                opacity: isRescheduled ? 0.8 : 1
                                            }
                                        },
                                            canEdit && !isOverdue && !isRescheduled && h('button', { onClick: (e) => removeFromPlanning(e, evt), style: { position: 'absolute', top: 2, right: 2, background: 'none', border: 'none', cursor: 'pointer', padding: 2, opacity: 0.5 } }, '×'),
                                            isOverdue && !isRescheduled && h('div', { style: { position: 'absolute', top: -4, right: -4, width: 16, height: 16, borderRadius: '50%', background: '#EF4444', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700 } }, '!'),
                                            isRescheduled && h('div', { style: { position: 'absolute', top: -4, right: -4, width: 16, height: 16, borderRadius: '50%', background: '#10B981', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700 } }, '✓'),
                                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 4 } },
                                                evt.scheduled_time && h('span', { style: { fontWeight: 600 } }, evt.scheduled_time),
                                                h('span', { style: { fontWeight: 500, color: isRescheduled ? '#059669' : (isOverdue ? '#DC2626' : 'inherit'), textDecoration: isRescheduled ? 'line-through' : 'none' } }, (evt.device_number || '').substring(0, viewMode === 'day' ? 25 : 12))
                                            ),
                                            evt.event_category && h('div', { style: { fontSize: 9, color: isRescheduled ? '#059669' : (isOverdue ? '#DC2626' : catStyle.borderColor), marginTop: 2 } }, catStyle.icon, ' ', evt.event_category),
                                            isRescheduled && h('div', { style: { fontSize: 9, color: '#059669', marginTop: 2, fontWeight: 600 } }, '➔ Replanifié au ', formatDate(evt.rescheduled_to)),
                                            evt.location && viewMode === 'day' && !isRescheduled && h('div', { style: { fontSize: 9, color: COLORS.muted, marginTop: 2, fontStyle: 'italic' } }, evt.location.substring(0, 40))
                                        );
                                    })
                                );
                            })
                        ),
                        // Lignes des techniciens
                        technicians.map((tech, ti) => h('div', { key: tech.id, style: { display: 'grid', gridTemplateColumns: `120px repeat(${displayDays.length}, 1fr)`, borderBottom: `1px solid ${COLORS.border}` } },
                        h('div', { style: { padding: 12, display: 'flex', alignItems: 'center', gap: 8, background: COLORS.background } },
                            h('div', { style: { width: 32, height: 32, borderRadius: '50%', background: getAvatarColor(ti), color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 12, fontWeight: 600 } }, getInitials(tech)),
                            h('span', { style: { fontSize: 13, fontWeight: 500 } }, (tech.first_name || '').substring(0, 10))
                        ),
                        displayDays.map((day, di) => {
                            const dayEvents = getEventsForTechAndDay(tech.id, day);
                            const isWeekend = day.getDay() === 0 || day.getDay() === 6;
                            const past = isPastDay(day);
                            return h('div', {
                                key: di, onDragOver: handleDragOver, onDrop: (e) => handleDrop(e, tech.id, day),
                                onDoubleClick: canEdit ? () => {
                                    const dateStr = day.toISOString().split('T')[0];
                                    setEditEvent({ scheduled_date: dateStr, assigned_to: tech.id, start_time: '09:00', end_time: '10:00' });
                                    setShowAddModal(true);
                                } : undefined,
                                style: { padding: 4, minHeight: viewMode === 'day' ? 150 : 80, background: isToday(day) ? COLORS.primaryPastel : isWeekend ? COLORS.background : 'white', borderLeft: `1px solid ${COLORS.border}`, cursor: canEdit ? 'cell' : 'default' }
                            },
                                dayEvents.map(evt => {
                                    const catStyle = getCategoryStyle(evt);
                                    const isOverdue = past && evt.status !== 'termine' && isOverdueCategory(evt);
                                    const isRescheduled = evt.rescheduled_to;
                                    return h('div', {
                                        key: evt.id, draggable: canEdit && !isRescheduled, onDragStart: (e) => handleDragStart(e, evt, 'event'), onClick: () => setViewEvent(evt),
                                        style: { 
                                            padding: '6px 8px', marginBottom: 4, borderRadius: 6, fontSize: 11, 
                                            background: isRescheduled ? '#D1FAE5' : (isOverdue ? '#FEE2E2' : catStyle.background), 
                                            borderLeft: `3px solid ${isRescheduled ? '#10B981' : (isOverdue ? '#EF4444' : catStyle.borderColor)}`, 
                                            cursor: 'pointer', position: 'relative',
                                            border: isRescheduled ? '1px solid #A7F3D0' : (isOverdue ? '1px solid #FECACA' : 'none'),
                                            opacity: isRescheduled ? 0.8 : 1
                                        }
                                    },
                                        canEdit && !isOverdue && !isRescheduled && h('button', { onClick: (e) => removeFromPlanning(e, evt), style: { position: 'absolute', top: 2, right: 2, background: 'none', border: 'none', cursor: 'pointer', padding: 2, opacity: 0.5 } }, '×'),
                                        isOverdue && !isRescheduled && h('div', { style: { position: 'absolute', top: -4, right: -4, width: 16, height: 16, borderRadius: '50%', background: '#EF4444', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700 } }, '!'),
                                        isRescheduled && h('div', { style: { position: 'absolute', top: -4, right: -4, width: 16, height: 16, borderRadius: '50%', background: '#10B981', color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 700 } }, '✓'),
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 4 } },
                                            evt.scheduled_time && h('span', { style: { fontWeight: 600 } }, evt.scheduled_time),
                                            h('span', { style: { fontWeight: 500, color: isRescheduled ? '#059669' : (isOverdue ? '#DC2626' : 'inherit'), textDecoration: isRescheduled ? 'line-through' : 'none' } }, (evt.device_number || '').substring(0, viewMode === 'day' ? 25 : 12))
                                        ),
                                        evt.event_category && h('div', { style: { fontSize: 9, color: isRescheduled ? '#059669' : (isOverdue ? '#DC2626' : catStyle.borderColor), marginTop: 2 } }, catStyle.icon, ' ', evt.event_category),
                                        isRescheduled && h('div', { style: { fontSize: 9, color: '#059669', marginTop: 2, fontWeight: 600 } }, '➔ Replanifié au ', formatDate(evt.rescheduled_to)),
                                        evt.location && viewMode === 'day' && !isRescheduled && h('div', { style: { fontSize: 9, color: COLORS.muted, marginTop: 2, fontStyle: 'italic' } }, evt.location.substring(0, 40))
                                    );
                                })
                            );
                        })
                    )))
                )
            )
        ),
        
        // Tâches à planifier - EN BAS sur toute la largeur (REPLIABLE)
        h('div', { className: 'card', style: { transition: 'all 0.3s ease' } },
            h('div', { 
                className: 'card-header', 
                style: { cursor: 'pointer', userSelect: 'none' },
                onClick: () => setTasksCollapsed(!tasksCollapsed)
            },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('div', { 
                        style: { 
                            transition: 'transform 0.3s ease',
                            transform: tasksCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)'
                        }
                    }, h(Icon, { name: 'chevronDown', size: 20, color: COLORS.muted })),
                    h('h3', { className: 'card-title', style: { margin: 0 } }, 'Tâches à planifier'),
                    h('span', { 
                        style: { 
                            background: COLORS.primaryPastel, 
                            color: COLORS.primary, 
                            padding: '2px 10px', 
                            borderRadius: 12, 
                            fontSize: 12, 
                            fontWeight: 600 
                        } 
                    }, classiqueTasks.length + mesTasks.length + aidesTasks.length),
                    overdueTasks.length > 0 && h('span', { 
                        style: { 
                            background: '#FEE2E2', 
                            color: '#DC2626', 
                            padding: '2px 10px', 
                            borderRadius: 12, 
                            fontSize: 12, 
                            fontWeight: 600,
                            display: 'flex',
                            alignItems: 'center',
                            gap: 4
                        } 
                    }, '⚠️ ', overdueTasks.length, ' en retard')
                ),
                !tasksCollapsed && h('div', { 
                    style: { display: 'flex', gap: 8, alignItems: 'center' },
                    onClick: e => e.stopPropagation()
                },
                    h('div', { className: 'header-search', style: { width: 200 } },
                        h(Icon, { name: 'search', size: 16, color: COLORS.muted }),
                        h('input', { type: 'text', placeholder: 'Rechercher...', value: taskSearch, onChange: e => setTaskSearch(e.target.value), style: { fontSize: 13 } })
                    )
                )
            ),
            !tasksCollapsed && h('div', { className: 'tabs', style: { padding: '0 16px' } },
                h('div', { className: `tab ${taskTab === 'classique' ? 'active' : ''}`, onClick: () => setTaskTab('classique'), style: { display: 'flex', alignItems: 'center', gap: 6 } }, 
                    'Travaux (', classiqueTasks.length, ')',
                    overdueTasks.length > 0 && h('span', { style: { background: '#EF4444', color: 'white', fontSize: 10, padding: '2px 6px', borderRadius: 10, fontWeight: 600 } }, overdueTasks.length, ' en retard')
                ),
                h('div', { className: `tab ${taskTab === 'mes' ? 'active' : ''}`, onClick: () => setTaskTab('mes') }, 'MES (', mesTasks.length, ')'),
                h('div', { className: `tab ${taskTab === 'aides' ? 'active' : ''}`, onClick: () => setTaskTab('aides') }, 'Aides (', aidesTasks.length, ')')
            ),
            !tasksCollapsed && h('div', { style: { padding: 16, maxHeight: 200, overflow: 'auto' } },
                h('div', { style: { display: 'flex', flexWrap: 'wrap', gap: 12 } },
                    taskTab === 'classique' && classiqueTasks.map(task => h('div', {
                        key: task.id + (task._isOverdue ? '-overdue' : ''), 
                        draggable: canEdit, 
                        onDragStart: (e) => handleDragStart(e, task, 'classique'),
                        style: { 
                            padding: 10, 
                            minWidth: 200, 
                            background: task._isOverdue ? '#FEE2E2' : COLORS.infoPastel, 
                            borderRadius: 8, 
                            cursor: canEdit ? 'grab' : 'default', 
                            borderLeft: `3px solid ${task._isOverdue ? '#EF4444' : COLORS.info}`,
                            position: 'relative'
                        }
                    }, 
                        task._isOverdue && h('div', { 
                            style: { 
                                position: 'absolute', 
                                top: -6, 
                                right: -6, 
                                background: '#EF4444', 
                                color: 'white', 
                                fontSize: 9, 
                                padding: '2px 6px', 
                                borderRadius: 10,
                                fontWeight: 600
                            } 
                        }, '⚠️ EN RETARD'),
                        h('div', { style: { fontWeight: 600, fontSize: 13, color: task._isOverdue ? '#DC2626' : 'inherit' } }, task.device_number), 
                        h('div', { style: { fontSize: 11, color: COLORS.muted } }, task.location || task.tournee),
                        task._isOverdue && h('div', { style: { fontSize: 10, marginTop: 4, color: '#DC2626', display: 'flex', alignItems: 'center', gap: 4 } }, 
                            h(Icon, { name: 'planning', size: 12, color: '#DC2626' }),
                            'Prévu le ', formatDate(task._originalDate)
                        )
                    )),
                    taskTab === 'mes' && mesTasks.map(item => h('div', {
                        key: item.id + (item._isOverdue ? '-overdue' : ''), 
                        draggable: canEdit, 
                        onDragStart: (e) => handleDragStart(e, item, item._isTask ? 'classique' : 'mes'),
                        style: { 
                            padding: 10, 
                            minWidth: 200, 
                            background: item._isOverdue ? '#FEE2E2' : COLORS.purplePastel, 
                            borderRadius: 8, 
                            cursor: canEdit ? 'grab' : 'default', 
                            borderLeft: `3px solid ${item._isOverdue ? '#EF4444' : COLORS.purple}`,
                            position: 'relative'
                        }
                    }, 
                        item._isOverdue && h('div', { style: { position: 'absolute', top: -6, right: -6, background: '#EF4444', color: 'white', fontSize: 9, padding: '2px 6px', borderRadius: 10, fontWeight: 600 } }, '⚠️ EN RETARD'),
                        h('div', { style: { fontWeight: 600, fontSize: 13, color: item._isOverdue ? '#DC2626' : 'inherit' } }, item.device_number), 
                        h('div', { style: { fontSize: 11, color: COLORS.muted } }, item.site_name || item.address_city || item.location),
                        item._isOverdue && h('div', { style: { fontSize: 10, marginTop: 4, color: '#DC2626' } }, '📅 Prévu le ', formatDate(item._originalDate))
                    )),
                    taskTab === 'aides' && aidesTasks.map(item => h('div', {
                        key: item.id + (item._isOverdue ? '-overdue' : ''), 
                        draggable: canEdit, 
                        onDragStart: (e) => handleDragStart(e, item, item._isTask ? 'classique' : 'aide'),
                        style: { 
                            padding: 10, 
                            minWidth: 200, 
                            background: item._isOverdue ? '#FEE2E2' : COLORS.warningPastel, 
                            borderRadius: 8, 
                            cursor: canEdit ? 'grab' : 'default', 
                            borderLeft: `3px solid ${item._isOverdue ? '#EF4444' : COLORS.warning}`,
                            position: 'relative'
                        }
                    }, 
                        item._isOverdue && h('div', { style: { position: 'absolute', top: -6, right: -6, background: '#EF4444', color: 'white', fontSize: 9, padding: '2px 6px', borderRadius: 10, fontWeight: 600 } }, '⚠️ EN RETARD'),
                        h('div', { style: { fontWeight: 600, fontSize: 13, color: item._isOverdue ? '#DC2626' : 'inherit' } }, item.subject || item.device_number || 'Aide #' + item.id), 
                        h('div', { style: { fontSize: 11, color: COLORS.muted } }, item.device_number || item.description?.substring(0, 30) || item.location),
                        item._isOverdue && h('div', { style: { fontSize: 10, marginTop: 4, color: '#DC2626' } }, '📅 Prévu le ', formatDate(item._originalDate))
                    )),
                    ((taskTab === 'classique' && classiqueTasks.length === 0) || (taskTab === 'mes' && mesTasks.length === 0) || (taskTab === 'aides' && aidesTasks.length === 0)) && h('div', { style: { width: '100%', textAlign: 'center', padding: 20, color: COLORS.muted, fontSize: 13 } }, 'Aucune tâche à planifier. Glissez-déposez les tâches sur le planning ci-dessus.')
                )
            )
        ),
        
        (showAddModal || editEvent) && h(EventFormModal),
        duplicateEventData && h(DuplicateEventModal),
        viewEvent && (() => {
            // Vérifier si l'événement est en retard
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const eventDate = new Date(viewEvent.scheduled_date);
            eventDate.setHours(0, 0, 0, 0);
            const isViewEventOverdue = eventDate < today && viewEvent.status !== 'termine' && isOverdueCategory(viewEvent);
            
            return h(Modal, { isOpen: true, onClose: () => setViewEvent(null), title: viewEvent.device_number, size: 'sm',
                footer: canEdit && h(Fragment, null, 
                    h('button', { className: 'btn btn-secondary', onClick: () => { setDuplicateEventData(viewEvent); } }, h(Icon, { name: 'copy', size: 16 }), ' Dupliquer'),
                    !isViewEventOverdue && h('button', { className: 'btn btn-danger', onClick: () => { removeFromPlanning({ stopPropagation: () => {} }, viewEvent); setViewEvent(null); } }, 'Supprimer'),
                    isViewEventOverdue && h('button', { className: 'btn btn-success', onClick: async () => { 
                        await db.from('tasks').update({ status: 'termine', completed_at: new Date().toISOString() }).eq('id', viewEvent.id); 
                        refresh(); 
                        showToast('Tâche terminée'); 
                        setViewEvent(null); 
                    } }, h(Icon, { name: 'checkCircle', size: 16 }), ' Terminer'),
                    h('button', { className: 'btn btn-primary', onClick: () => { setEditEvent(viewEvent); setShowAddModal(true); setViewEvent(null); } }, 'Modifier')
                )
            },
                isViewEventOverdue && h('div', { style: { marginBottom: 16, padding: 12, background: '#FEE2E2', borderRadius: 8, border: '1px solid #FECACA' } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, color: '#DC2626', fontWeight: 600 } },
                        '⚠️ Tâche en retard',
                        h('span', { style: { fontWeight: 400, fontSize: 13 } }, '- Non supprimable (historique)')
                    )
                ),
                h('div', { className: 'info-grid' },
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Date'), h('div', { className: 'info-value' }, formatDate(viewEvent.scheduled_date))),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Heure'), h('div', { className: 'info-value' }, viewEvent.scheduled_time || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Catégorie'), h('div', { className: 'info-value' }, (() => {
                        const cat = categories.find(c => c.name === viewEvent.event_category);
                        return cat ? h('span', { style: { color: cat.color } }, cat.icon, ' ', cat.name) : (viewEvent.event_category || '-');
                    })())),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Type'), h('span', { className: `badge badge-${viewEvent.task_type === 'mes' ? 'purple' : viewEvent.task_type === 'aide' ? 'warning' : 'info'}` }, viewEvent.task_type || 'Travail'))
                ),
                // Bandeau replanification si la tâche a été replanifiée
                viewEvent.rescheduled_to && h('div', { style: { marginTop: 16, padding: 12, background: '#D1FAE5', borderRadius: 8, border: '1px solid #A7F3D0' } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, color: '#059669', fontWeight: 600 } },
                        '✓ Replanifiée',
                        h('span', { style: { fontWeight: 400 } }, '➔'),
                        h('span', null, formatDate(viewEvent.rescheduled_to))
                    ),
                    viewEvent.rescheduled_at && h('div', { style: { fontSize: 12, color: '#047857', marginTop: 4 } },
                        'Replanifiée le ', new Date(viewEvent.rescheduled_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                    )
                ),
                viewEvent.location && h('div', { style: { marginTop: 16, padding: 12, background: COLORS.background, borderRadius: 8 } }, 
                    h('div', { className: 'info-label', style: { marginBottom: 8 } }, '📝 Description'), 
                    h('p', { style: { margin: 0, whiteSpace: 'pre-wrap' } }, viewEvent.location)
                )
            );
        })(),
        // Modal Historique des replanifications
        showHistoryModal && h(Modal, { 
            isOpen: true, 
            onClose: () => setShowHistoryModal(false), 
            title: '📋 Historique des replanifications', 
            size: 'lg' 
        },
            h('div', { style: { marginBottom: 16 } },
                h('p', { style: { color: COLORS.muted, margin: 0 } }, 
                    `${rescheduledTasks.length} tâche(s) replanifiée(s)`
                )
            ),
            rescheduledTasks.length === 0 
                ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune replanification enregistrée')
                : h('div', { style: { maxHeight: 500, overflow: 'auto' } },
                    h('table', { className: 'data-table' },
                        h('thead', null,
                            h('tr', null,
                                h('th', null, 'Tâche'),
                                h('th', null, 'Date originale'),
                                h('th', null, 'Replanifiée au'),
                                h('th', null, 'Catégorie'),
                                h('th', null, 'Statut')
                            )
                        ),
                        h('tbody', null,
                            rescheduledTasks.map(task => {
                                const cat = categories.find(c => c.name === task.event_category);
                                return h('tr', { key: task.id },
                                    h('td', null, 
                                        h('div', { style: { fontWeight: 600 } }, task.device_number || 'Sans titre'),
                                        task.location && h('div', { style: { fontSize: 12, color: COLORS.muted } }, task.location.substring(0, 40))
                                    ),
                                    h('td', null, 
                                        h('div', { style: { color: '#DC2626', fontWeight: 500 } }, formatDate(task.scheduled_date))
                                    ),
                                    h('td', null, 
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 4, color: '#059669', fontWeight: 500 } },
                                            '➔',
                                            formatDate(task.rescheduled_to)
                                        ),
                                        task.rescheduled_at && h('div', { style: { fontSize: 11, color: COLORS.muted } }, 
                                            'Le ', new Date(task.rescheduled_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })
                                        )
                                    ),
                                    h('td', null, 
                                        cat ? h('span', { style: { color: cat.color } }, cat.icon, ' ', cat.name) : (task.event_category || '-')
                                    ),
                                    h('td', null, 
                                        h('span', { className: `badge badge-${task.status === 'termine' ? 'success' : 'info'}` }, 
                                            task.status === 'termine' ? 'Terminé' : 'En cours'
                                        )
                                    )
                                );
                            })
                        )
                    )
                ),
            h('div', { style: { marginTop: 20, padding: 16, background: COLORS.infoPastel, borderRadius: 8 } },
                h('div', { style: { fontWeight: 600, color: COLORS.info, marginBottom: 8 } }, '💡 Information'),
                h('p', { style: { fontSize: 13, color: COLORS.text, margin: 0 } }, 
                    'Les tâches replanifiées créent une copie pour la nouvelle date. L\'original reste visible dans le planning passé avec la mention "Replanifié au [date]" pour conserver l\'historique.'
                )
            )
        ),
        showPlanningCategories && h(PlanningCategoriesModal),
        
        // Modal Récurrence v5.6
        showRecurrenceModal && h(Modal, { isOpen: true, onClose: () => setShowRecurrenceModal(false), title: '🔄 Tâches récurrentes', size: 'lg' },
            h('div', null,
                h('div', { style: { marginBottom: 20 } },
                    h('h4', { style: { marginBottom: 12 } }, 'Créer une récurrence'),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Fréquence'),
                            h('select', { className: 'form-select', value: recurrenceForm.frequency, onChange: e => setRecurrenceForm({...recurrenceForm, frequency: e.target.value}) },
                                h('option', { value: 'daily' }, 'Quotidien'),
                                h('option', { value: 'weekly' }, 'Hebdomadaire'),
                                h('option', { value: 'biweekly' }, 'Bi-hebdomadaire'),
                                h('option', { value: 'monthly' }, 'Mensuel'),
                                h('option', { value: 'quarterly' }, 'Trimestriel'),
                                h('option', { value: 'yearly' }, 'Annuel')
                            )
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Intervalle'),
                            h('input', { type: 'number', className: 'form-input', min: 1, value: recurrenceForm.interval_value, onChange: e => setRecurrenceForm({...recurrenceForm, interval_value: parseInt(e.target.value) || 1}) })
                        ),
                        recurrenceForm.frequency === 'weekly' && h('div', { className: 'form-group' },
                            h('label', null, 'Jour'),
                            h('select', { className: 'form-select', value: recurrenceForm.day_of_week, onChange: e => setRecurrenceForm({...recurrenceForm, day_of_week: parseInt(e.target.value)}) },
                                h('option', { value: 1 }, 'Lundi'), h('option', { value: 2 }, 'Mardi'), h('option', { value: 3 }, 'Mercredi'),
                                h('option', { value: 4 }, 'Jeudi'), h('option', { value: 5 }, 'Vendredi'), h('option', { value: 6 }, 'Samedi'), h('option', { value: 0 }, 'Dimanche')
                            )
                        ),
                        recurrenceForm.frequency === 'monthly' && h('div', { className: 'form-group' },
                            h('label', null, 'Jour du mois'),
                            h('input', { type: 'number', className: 'form-input', min: 1, max: 31, value: recurrenceForm.day_of_month, onChange: e => setRecurrenceForm({...recurrenceForm, day_of_month: parseInt(e.target.value) || 1}) })
                        )
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Date de début'),
                            h('input', { type: 'date', className: 'form-input', value: recurrenceForm.start_date, onChange: e => setRecurrenceForm({...recurrenceForm, start_date: e.target.value}) })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Date de fin (optionnel)'),
                            h('input', { type: 'date', className: 'form-input', value: recurrenceForm.end_date, onChange: e => setRecurrenceForm({...recurrenceForm, end_date: e.target.value}) })
                        )
                    ),
                    h('hr', { style: { margin: '16px 0' } }),
                    h('h5', { style: { marginBottom: 12 } }, 'Modèle de tâche'),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'N° Appareil'),
                            h('input', { className: 'form-input', value: recurrenceForm.task_template.device_number || '', onChange: e => setRecurrenceForm({...recurrenceForm, task_template: {...recurrenceForm.task_template, device_number: e.target.value}}) })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Lieu'),
                            h('input', { className: 'form-input', value: recurrenceForm.task_template.location || '', onChange: e => setRecurrenceForm({...recurrenceForm, task_template: {...recurrenceForm.task_template, location: e.target.value}}) })
                        )
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Description'),
                        h('textarea', { className: 'form-input', rows: 2, value: recurrenceForm.task_template.description || '', onChange: e => setRecurrenceForm({...recurrenceForm, task_template: {...recurrenceForm.task_template, description: e.target.value}}) })
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Catégorie'),
                            h('select', { className: 'form-select', value: recurrenceForm.task_template.event_category || '', onChange: e => setRecurrenceForm({...recurrenceForm, task_template: {...recurrenceForm.task_template, event_category: e.target.value}}) },
                                h('option', { value: '' }, '-- Choisir --'),
                                categories.map(c => h('option', { key: c.id, value: c.name }, `${c.icon} ${c.name}`))
                            )
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Assigné à'),
                            h('select', { className: 'form-select', value: recurrenceForm.task_template.assigned_to || '', onChange: e => setRecurrenceForm({...recurrenceForm, task_template: {...recurrenceForm.task_template, assigned_to: e.target.value}}) },
                                h('option', { value: '' }, 'Non assigné'),
                                technicians.map(t => h('option', { key: t.id, value: t.id }, `${t.first_name || ''} ${t.last_name || ''}`.trim() || t.email))
                            )
                        )
                    ),
                    h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end', marginTop: 16 } },
                        h('button', { className: 'btn btn-secondary', onClick: () => setShowRecurrenceModal(false) }, 'Annuler'),
                        h('button', { className: 'btn btn-primary', onClick: saveRecurrence }, 'Créer la récurrence')
                    )
                ),
                recurrences.length > 0 && h('div', null,
                    h('hr', { style: { margin: '20px 0' } }),
                    h('h4', { style: { marginBottom: 12 } }, `Récurrences actives (${recurrences.length})`),
                    h('div', { style: { maxHeight: 200, overflowY: 'auto' } },
                        recurrences.map(rec => h('div', { key: rec.id, style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: 12, background: COLORS.background, borderRadius: 8, marginBottom: 8 } },
                            h('div', null,
                                h('div', { style: { fontWeight: 600 } }, rec.task_template?.device_number || rec.task_template?.description || 'Récurrence'),
                                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 
                                    rec.frequency === 'daily' ? 'Quotidien' : rec.frequency === 'weekly' ? 'Hebdomadaire' : rec.frequency === 'monthly' ? 'Mensuel' : rec.frequency,
                                    ' • Prochaine: ', rec.next_generation ? new Date(rec.next_generation).toLocaleDateString('fr-FR') : '-'
                                )
                            ),
                            h('button', { className: 'btn btn-sm btn-danger', onClick: async () => {
                                await db.from('task_recurrences').update({ is_active: false }).eq('id', rec.id);
                                setRecurrences(recurrences.filter(r => r.id !== rec.id));
                                showToast('Récurrence désactivée');
                            } }, '🗑️')
                        ))
                    )
                )
            )
        ),
        
        // Modal Disponibilités v5.6
        showAvailabilityModal && h(Modal, { isOpen: true, onClose: () => setShowAvailabilityModal(false), title: '📅 Disponibilités techniciens', size: 'lg' },
            h('div', null,
                h('div', { style: { marginBottom: 20 } },
                    h('h4', { style: { marginBottom: 12 } }, 'Déclarer une indisponibilité'),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Technicien'),
                            h('select', { className: 'form-select', value: availabilityForm.user_id, onChange: e => setAvailabilityForm({...availabilityForm, user_id: e.target.value}) },
                                h('option', { value: '' }, '-- Choisir --'),
                                technicians.map(t => h('option', { key: t.id, value: t.id }, `${t.first_name || ''} ${t.last_name || ''}`.trim() || t.email))
                            )
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Type'),
                            h('select', { className: 'form-select', value: availabilityForm.type, onChange: e => setAvailabilityForm({...availabilityForm, type: e.target.value}) },
                                h('option', { value: 'vacation' }, '🏖️ Congés'),
                                h('option', { value: 'sick' }, '🤒 Maladie'),
                                h('option', { value: 'training' }, '📚 Formation'),
                                h('option', { value: 'other' }, '📌 Autre')
                            )
                        )
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Date début'),
                            h('input', { type: 'date', className: 'form-input', value: availabilityForm.start_date, onChange: e => setAvailabilityForm({...availabilityForm, start_date: e.target.value}) })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Date fin'),
                            h('input', { type: 'date', className: 'form-input', value: availabilityForm.end_date, onChange: e => setAvailabilityForm({...availabilityForm, end_date: e.target.value}) })
                        )
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Motif (optionnel)'),
                        h('input', { className: 'form-input', value: availabilityForm.reason, onChange: e => setAvailabilityForm({...availabilityForm, reason: e.target.value}) })
                    ),
                    h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end', marginTop: 16 } },
                        h('button', { className: 'btn btn-secondary', onClick: () => setShowAvailabilityModal(false) }, 'Annuler'),
                        h('button', { className: 'btn btn-primary', onClick: saveAvailability, disabled: !availabilityForm.user_id || !availabilityForm.start_date || !availabilityForm.end_date }, 'Enregistrer')
                    )
                ),
                availabilities.length > 0 && h('div', null,
                    h('hr', { style: { margin: '20px 0' } }),
                    h('h4', { style: { marginBottom: 12 } }, `Indisponibilités à venir (${availabilities.length})`),
                    h('div', { style: { maxHeight: 250, overflowY: 'auto' } },
                        availabilities.map(avail => {
                            const tech = technicians.find(t => t.id === avail.user_id);
                            const typeLabels = { vacation: '🏖️ Congés', sick: '🤒 Maladie', training: '📚 Formation', other: '📌 Autre' };
                            return h('div', { key: avail.id, style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: 12, background: COLORS.background, borderRadius: 8, marginBottom: 8 } },
                                h('div', null,
                                    h('div', { style: { fontWeight: 600 } }, tech ? `${tech.first_name || ''} ${tech.last_name || ''}`.trim() : 'Inconnu'),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, 
                                        typeLabels[avail.type] || avail.type, ' • ',
                                        new Date(avail.start_date).toLocaleDateString('fr-FR'), ' → ', new Date(avail.end_date).toLocaleDateString('fr-FR')
                                    ),
                                    avail.reason && h('div', { style: { fontSize: 11, color: COLORS.muted, fontStyle: 'italic' } }, avail.reason)
                                ),
                                h('div', { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                                    h('span', { className: `badge badge-${avail.status === 'approved' ? 'success' : avail.status === 'rejected' ? 'danger' : 'warning'}` }, 
                                        avail.status === 'approved' ? '✓ Approuvé' : avail.status === 'rejected' ? '✗ Refusé' : '⏳ En attente'
                                    ),
                                    isAdmin && h('button', { className: 'btn btn-sm btn-danger', onClick: async () => {
                                        await db.from('technician_availability').delete().eq('id', avail.id);
                                        setAvailabilities(availabilities.filter(a => a.id !== avail.id));
                                        showToast('Indisponibilité supprimée');
                                    } }, '🗑️')
                                )
                            );
                        })
                    )
                )
            )
        ),
        
        // Modal Optimisation v5.6
        showOptimizeModal && h(Modal, { isOpen: true, onClose: () => setShowOptimizeModal(false), title: '🚀 Optimiser les tournées', size: 'md' },
            h('div', null,
                h('p', { style: { marginBottom: 16, color: COLORS.muted } }, 
                    'L\'optimisation réorganise les tâches géolocalisées pour minimiser les distances de déplacement.'
                ),
                h('div', { className: 'form-group' },
                    h('label', null, 'Date à optimiser'),
                    h('input', { type: 'date', className: 'form-input', value: optimizeDate, onChange: e => setOptimizeDate(e.target.value) })
                ),
                h('div', { className: 'form-group' },
                    h('label', null, 'Technicien (optionnel)'),
                    h('select', { className: 'form-select', value: optimizeTechnician, onChange: e => setOptimizeTechnician(e.target.value) },
                        h('option', { value: '' }, 'Tous les techniciens'),
                        technicians.map(t => h('option', { key: t.id, value: t.id }, `${t.first_name || ''} ${t.last_name || ''}`.trim() || t.email))
                    )
                ),
                h('div', { style: { padding: 16, background: COLORS.infoPastel, borderRadius: 8, marginBottom: 16 } },
                    h('div', { style: { fontWeight: 600, marginBottom: 8 } }, '📊 Aperçu'),
                    h('div', { style: { fontSize: 13 } }, 
                        `${scheduledTasks.filter(t => t.scheduled_date === optimizeDate && (optimizeTechnician ? t.assigned_to === optimizeTechnician : true)).length} tâches planifiées`,
                        h('br'),
                        `${scheduledTasks.filter(t => t.scheduled_date === optimizeDate && (optimizeTechnician ? t.assigned_to === optimizeTechnician : true) && t.latitude && t.longitude).length} avec coordonnées GPS`
                    )
                ),
                h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end' } },
                    h('button', { className: 'btn btn-secondary', onClick: () => setShowOptimizeModal(false) }, 'Annuler'),
                    h('button', { className: 'btn btn-primary', onClick: optimizeTasks }, '🚀 Optimiser')
                )
            )
        ),
        
        // Modal Rapports automatiques
        typeof window.StockAppV53 !== 'undefined' && showReportsModal && h(window.StockAppV53.ScheduledReportsModal, {
            isOpen: showReportsModal,
            onClose: () => setShowReportsModal(false),
            reports: reports,
            onAdd: addReport,
            onDelete: deleteReport,
            onToggle: toggleReport,
            onRun: runReport,
            data: data
        }),
        
        // Vue Gantt (alternative au planning classique)
        showGanttView && typeof window.StockAppV53 !== 'undefined' && h(window.StockAppV53.GanttView, {
            events: [...events, ...scheduledTasks],
            users: technicians,
            dateRange: { start: weekDays[0], end: weekDays[6] },
            onEventClick: setViewEvent,
            categories: categories
        })
    );
};


// ==========================================
// TOURNÉES TAB - Gestion des tournées d'entretien
// ==========================================
const TourneesTab = ({ equipements, user, showToast }) => {
    // États principaux
    const [activeView, setActiveView] = useState('aplanifier');
    const [selectedWeek, setSelectedWeek] = useState(0);
    const [tourneesPlanifiees, setTourneesPlanifiees] = useState([]);
    const [allTourneesPlanifiees, setAllTourneesPlanifiees] = useState([]);
    const [techniciens, setTechniciens] = useState([]);
    const [absences, setAbsences] = useState([]);
    const [joursFeries, setJoursFeries] = useState([]);
    const [lieuxDepart, setLieuxDepart] = useState([]);
    const [visitesEntretien, setVisitesEntretien] = useState({}); // Map code -> dernière visite
    const [selectedDef, setSelectedDef] = useState(null);
    const [selectedTournee, setSelectedTournee] = useState(null);
    const [showPlanifier, setShowPlanifier] = useState(false);
    const [showAutoPlan, setShowAutoPlan] = useState(false);
    const [showAbsences, setShowAbsences] = useState(false);
    const [showLieuxDepart, setShowLieuxDepart] = useState(false);
    const [showEditCoords, setShowEditCoords] = useState(null);
    const [planifierData, setPlanifierData] = useState({ date: '', technicien_id: '', heure_debut: '08:00', lieu_depart_id: '' });
    const [absenceForm, setAbsenceForm] = useState({ technicien_id: '', date_debut: '', date_fin: '', type: 'conge', motif: '' });
    const [lieuForm, setLieuForm] = useState({ nom: '', type: 'depot', adresse: '', ville: '', latitude: '', longitude: '', technicien_id: '' });
    const [filterSecteur, setFilterSecteur] = useState('');
    const [filterStatut, setFilterStatut] = useState('');
    const [filterFrequence, setFilterFrequence] = useState('');
    const [showMap, setShowMap] = useState(false);
    const [loading, setLoading] = useState(true);
    const [suggestions, setSuggestions] = useState([]);
    const [selectedSuggestions, setSelectedSuggestions] = useState([]);
    const [coordsEdit, setCoordsEdit] = useState({ latitude: '', longitude: '' });
    const [selectedLieuDepart, setSelectedLieuDepart] = useState(null);
    const [expandedSecteurs, setExpandedSecteurs] = useState({});
    const [expandedTournees, setExpandedTournees] = useState({});
    const mapContainerRef = useRef(null);
    const mapInstanceRef = useRef(null);
    
    const joursSemaine = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
    const joursComplets = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
    const DUREE_ENTRETIEN = 30;
    const VITESSE_MOYENNE = 40;
    const MAX_HEURES_JOUR = 7;
    
    const techColors = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EF4444', '#14B8A6', '#EC4899', '#6366F1'];
    const absenceTypes = { conge: { label: 'Congé', color: '#3B82F6', icon: '🏖️' }, rtt: { label: 'RTT', color: '#10B981', icon: '📅' }, maladie: { label: 'Maladie', color: '#EF4444', icon: '🏥' }, formation: { label: 'Formation', color: '#8B5CF6', icon: '📚' }, autre: { label: 'Autre', color: '#6B7280', icon: '📌' } };
    const lieuTypes = { entreprise: { label: 'Siège/Entreprise', icon: '🏢' }, domicile: { label: 'Domicile', icon: '🏠' }, hotel: { label: 'Hôtel', icon: '🏨' }, depot: { label: 'Dépôt', icon: '📦' }, autre: { label: 'Autre', icon: '📍' } };
    
    const SIEGE_COORDS = { latitude: 45.7772, longitude: 3.0870, nom: 'Siège Auvergne Ascenseurs' };
    
    // ========== SECTEURS AUTORISÉS ==========
    
    // Récupérer les secteurs autorisés depuis le profil utilisateur
    const secteursAutorises = useMemo(() => {
        // Utiliser la colonne "sectors" du profil pour TOUS les utilisateurs
        if (user?.sectors && Array.isArray(user.sectors) && user.sectors.length > 0) {
            return user.sectors;
        }
        
        // Par défaut, tous les secteurs (si aucun secteur défini)
        return null;
    }, [user]);
    
    // Filtrer les équipements par secteurs autorisés (basé sur contrat.secteur)
    const equipementsFiltres = useMemo(() => {
        if (!secteursAutorises) return equipements;
        return equipements.filter(eq => secteursAutorises.includes(eq.secteur));
    }, [equipements, secteursAutorises]);
    
    // ========== COORDONNÉES GPS ==========
    
    const villeCoords = {
        'CLERMONT-FERRAND': [45.7772, 3.0870], 'CLERMONT FERRAND': [45.7772, 3.0870], 'CLERMONT': [45.7772, 3.0870],
        'RIOM': [45.8930, 3.1140], 'ISSOIRE': [45.5450, 3.2500], 'THIERS': [45.8570, 3.5480],
        'AMBERT': [45.5490, 3.7420], 'VICHY': [46.1270, 3.4270], 'MONTLUCON': [46.3400, 2.6030],
        'MOULINS': [46.5640, 3.3320], 'AURILLAC': [44.9260, 2.4410], 'LE PUY': [45.0430, 3.8850],
        'SAINT-ETIENNE': [45.4340, 4.3900], 'LYON': [45.7640, 4.8357], 'CHAMALIÈRES': [45.7730, 3.0650],
        'CHAMALIERES': [45.7730, 3.0650], 'COURNON': [45.7410, 3.1950], 'AUBIERE': [45.7520, 3.1110],
        'BEAUMONT': [45.7530, 3.0820], 'ROYAT': [45.7680, 3.0490], 'CEYRAT': [45.7310, 3.0650],
        'ROMAGNAT': [45.7180, 3.0920], 'PONT DU CHATEAU': [45.7980, 3.2490], 'LEMPDES': [45.7710, 3.1930],
        'GERZAT': [45.8220, 3.1440], 'CEBAZAT': [45.8320, 3.0980], 'BLANZAT': [45.8280, 3.0720],
        'DURTOL': [45.7920, 3.0420], 'NOHANENT': [45.8050, 3.0380], 'SAYAT': [45.8180, 3.0560],
        'CHATEL-GUYON': [45.9220, 3.0650], 'VOLVIC': [45.8720, 3.0400], 'MOZAC': [45.8910, 3.0990]
    };
    
    const getEquipementCoords = useCallback((eq) => {
        if (!eq) return [45.7772, 3.0870];
        if (eq.latitude && eq.longitude) return [parseFloat(eq.latitude), parseFloat(eq.longitude)];
        const ville = (eq.ville || '').toUpperCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        for (const [key, coords] of Object.entries(villeCoords)) {
            if (ville.includes(key) || key.includes(ville)) {
                const hash = (eq.adresse || '').split('').reduce((a, c) => a + c.charCodeAt(0), 0);
                return [coords[0] + (hash % 100) / 10000, coords[1] + (hash % 100) / 10000];
            }
        }
        const hash = ((eq.adresse || '') + (eq.ville || '')).split('').reduce((a, c) => a + c.charCodeAt(0), 0);
        return [45.7772 + (hash % 50) / 10000, 3.0870 + (hash % 50) / 10000];
    }, []);
    
    const isWellGeolocated = useCallback((eq) => eq.coords_source === 'manual' || (eq.latitude && eq.longitude), []);
    
    const calculerDistance = useCallback((lat1, lon1, lat2, lon2) => {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }, []);
    
    const getLieuDepartTechnicien = useCallback((techId) => {
        if (!techId) return SIEGE_COORDS;
        const tech = techniciens.find(t => t.id === techId);
        if (tech?.lieu_depart_defaut) {
            const lieu = lieuxDepart.find(l => l.id === tech.lieu_depart_defaut);
            if (lieu) return { latitude: parseFloat(lieu.latitude), longitude: parseFloat(lieu.longitude), nom: lieu.nom, id: lieu.id };
        }
        const lieuPerso = lieuxDepart.find(l => l.technicien_id === techId);
        if (lieuPerso) return { latitude: parseFloat(lieuPerso.latitude), longitude: parseFloat(lieuPerso.longitude), nom: lieuPerso.nom, id: lieuPerso.id };
        if (tech?.domicile_latitude && tech?.domicile_longitude) return { latitude: parseFloat(tech.domicile_latitude), longitude: parseFloat(tech.domicile_longitude), nom: 'Domicile' };
        const siege = lieuxDepart.find(l => l.is_default && !l.technicien_id);
        if (siege) return { latitude: parseFloat(siege.latitude), longitude: parseFloat(siege.longitude), nom: siege.nom, id: siege.id };
        return SIEGE_COORDS;
    }, [techniciens, lieuxDepart]);
    
    const calculerTempsTrajet = useCallback((eqs, lieuDepart = null) => {
        if (!eqs || eqs.length === 0) return { trajetAller: 0, trajetInter: 0, trajetRetour: 0, total: 0, distanceKm: 0 };
        const depart = lieuDepart || SIEGE_COORDS;
        let trajetAller = 0, trajetInter = 0, trajetRetour = 0;
        const [lat1, lon1] = getEquipementCoords(eqs[0]);
        trajetAller = calculerDistance(depart.latitude, depart.longitude, lat1, lon1);
        for (let i = 0; i < eqs.length - 1; i++) {
            const [latA, lonA] = getEquipementCoords(eqs[i]);
            const [latB, lonB] = getEquipementCoords(eqs[i + 1]);
            trajetInter += calculerDistance(latA, lonA, latB, lonB);
        }
        const [latN, lonN] = getEquipementCoords(eqs[eqs.length - 1]);
        trajetRetour = calculerDistance(latN, lonN, depart.latitude, depart.longitude);
        const distanceTotale = trajetAller + trajetInter + trajetRetour;
        return {
            trajetAller: Math.round((trajetAller / VITESSE_MOYENNE) * 60 * 1.3),
            trajetInter: Math.round((trajetInter / VITESSE_MOYENNE) * 60 * 1.3),
            trajetRetour: Math.round((trajetRetour / VITESSE_MOYENNE) * 60 * 1.3),
            total: Math.round((distanceTotale / VITESSE_MOYENNE) * 60 * 1.3),
            distanceKm: Math.round(distanceTotale * 10) / 10
        };
    }, [getEquipementCoords, calculerDistance]);
    
    // ========== FRÉQUENCES ==========
    
    const getVisitesParAn = useCallback((eq) => (eq.nb_visites_an && eq.nb_visites_an >= 1 && eq.nb_visites_an <= 12) ? eq.nb_visites_an : 6, []);
    const getCycleJours = (v) => Math.round(365 / v);
    const formatCycle = (v) => ({ 1: '1x/an', 2: '2x/an', 3: '3x/an', 4: '4x/an', 6: '6x/an', 12: '12x/an' }[v] || `${v}x/an`);
    const getFrequenceColor = (v) => v <= 2 ? '#6366F1' : v <= 4 ? '#3B82F6' : v <= 6 ? '#10B981' : '#F59E0B';
    
    // Helper pour parser les dates de manière robuste
    const parseDate = useCallback((dateVal) => {
        if (!dateVal) return null;
        
        // Si c'est déjà une Date valide
        if (dateVal instanceof Date && !isNaN(dateVal.getTime())) return dateVal;
        
        // Si c'est un timestamp
        if (typeof dateVal === 'number') {
            const d = new Date(dateVal);
            return isNaN(d.getTime()) ? null : d;
        }
        
        // Si c'est une chaîne
        if (typeof dateVal === 'string') {
            // Nettoyer les espaces
            const cleaned = dateVal.trim();
            
            // Format YYYYMMDD (ex: "20260102")
            if (/^\d{8}$/.test(cleaned)) {
                const year = parseInt(cleaned.substring(0, 4));
                const month = parseInt(cleaned.substring(4, 6)) - 1;
                const day = parseInt(cleaned.substring(6, 8));
                const d = new Date(year, month, day);
                if (!isNaN(d.getTime())) return d;
            }
            
            // Format ISO (2024-01-15 ou 2024-01-15T10:30:00)
            let d = new Date(cleaned);
            if (!isNaN(d.getTime())) return d;
            
            // Format JJ/MM/AAAA
            const parts = cleaned.split('/');
            if (parts.length === 3) {
                d = new Date(parts[2], parts[1] - 1, parts[0]);
                if (!isNaN(d.getTime())) return d;
            }
            
            // Format JJ-MM-AAAA
            const parts2 = cleaned.split('-');
            if (parts2.length === 3 && parts2[0].length === 2) {
                d = new Date(parts2[2], parts2[1] - 1, parts2[0]);
                if (!isNaN(d.getTime())) return d;
            }
        }
        
        return null;
    }, []);
    
    // Helper pour formater une date de manière sûre
    const formatDate = useCallback((dateVal) => {
        const d = parseDate(dateVal);
        if (!d) return null;
        return d.toLocaleDateString('fr-FR');
    }, [parseDate]);
    
    // ========== DISPONIBILITÉS ==========
    
    const isJourFerie = useCallback((date) => {
        const dateStr = date.toISOString().split('T')[0];
        return joursFeries.find(jf => jf.date === dateStr);
    }, [joursFeries]);
    
    const isTechnicienAbsent = useCallback((techId, date) => {
        const dateStr = date.toISOString().split('T')[0];
        return absences.find(a => a.technicien_id === techId && dateStr >= a.date_debut && dateStr <= a.date_fin);
    }, [absences]);
    
    const isJourTravaille = useCallback((date) => {
        const day = date.getDay();
        if (day === 0 || day === 6) return false;
        if (isJourFerie(date)) return false;
        return true;
    }, [isJourFerie]);
    
    const getTechniciensDisponibles = useCallback((date) => {
        if (!isJourTravaille(date)) return [];
        return techniciens.filter(tech => !isTechnicienAbsent(tech.id, date));
    }, [techniciens, isJourTravaille, isTechnicienAbsent]);
    
    const getIndisponibiliteRaison = useCallback((date, techId = null) => {
        const day = date.getDay();
        if (day === 0) return { type: 'weekend', label: 'Dimanche' };
        if (day === 6) return { type: 'weekend', label: 'Samedi' };
        const ferie = isJourFerie(date);
        if (ferie) return { type: 'ferie', label: ferie.nom };
        if (techId) {
            const absence = isTechnicienAbsent(techId, date);
            if (absence) return { type: 'absence', label: absenceTypes[absence.type]?.label || 'Absent' };
        }
        return null;
    }, [isJourFerie, isTechnicienAbsent]);
    
    // ========== GROUPEMENT TOURNÉES ==========
    
    const tourneesDef = useMemo(() => {
        const grouped = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Utiliser equipementsFiltres au lieu de equipements
        equipementsFiltres.forEach(eq => {
            if (!eq.secteur || !eq.ordre2) return;
            const key = `${eq.secteur}|${eq.ordre2}`;
            if (!grouped[key]) {
                grouped[key] = { id: key, secteur: eq.secteur, ordre: eq.ordre2, nom: `${eq.secteur} - Tournée ${eq.ordre2}`, equipements: [], derniereVisite: null, nbVisitesParAn: {} };
            }
            grouped[key].equipements.push(eq);
            const visites = getVisitesParAn(eq);
            grouped[key].nbVisitesParAn[visites] = (grouped[key].nbVisitesParAn[visites] || 0) + 1;
            
            // Utiliser la dernière visite d'entretien depuis la table pannes
            const derniereVisiteEq = visitesEntretien[eq.id_wsoucont];
            if (derniereVisiteEq) {
                const datVisite = parseDate(derniereVisiteEq);
                if (datVisite && (!grouped[key].derniereVisite || datVisite > grouped[key].derniereVisite)) {
                    grouped[key].derniereVisite = datVisite;
                }
            }
        });
        
        return Object.values(grouped).map(def => {
            let maxVisites = Math.max(...Object.keys(def.nbVisitesParAn).map(Number), 6);
            if (!isFinite(maxVisites) || maxVisites < 1) maxVisites = 6;
            const cycleJours = getCycleJours(maxVisites);
            const trajets = calculerTempsTrajet(def.equipements, selectedLieuDepart || SIEGE_COORDS);
            const dureeEntretien = def.equipements.length * DUREE_ENTRETIEN;
            const dureeTotale = dureeEntretien + trajets.total;
            const eqMalGeoloc = def.equipements.filter(eq => !isWellGeolocated(eq));
            
            let prochaineVisite = null, joursRestants = null, statut = 'jamais';
            if (def.derniereVisite) {
                prochaineVisite = new Date(def.derniereVisite);
                prochaineVisite.setDate(prochaineVisite.getDate() + cycleJours);
                joursRestants = Math.ceil((prochaineVisite - today) / (1000 * 60 * 60 * 24));
                const seuilAlerte = Math.max(7, Math.round(cycleJours * 0.2));
                statut = joursRestants < 0 ? 'retard' : joursRestants <= seuilAlerte ? 'aplanifier' : 'ok';
            }
            
            return { ...def, visitesParAn: maxVisites, cycleJours, prochaineVisite, joursRestants, statut, trajets, dureeEntretien, dureeTotale, eqMalGeoloc };
        }).sort((a, b) => {
            // Trier par secteur puis par ordre
            const secteurCmp = (a.secteur || '').localeCompare(b.secteur || '');
            if (secteurCmp !== 0) return secteurCmp;
            return (a.ordre || 0) - (b.ordre || 0);
        });
    }, [equipementsFiltres, getVisitesParAn, calculerTempsTrajet, isWellGeolocated, selectedLieuDepart, visitesEntretien, parseDate]);
    
    // Grouper par secteur pour la vue liste
    const tourneesParSecteur = useMemo(() => {
        const grouped = {};
        tourneesDef.forEach(def => {
            if (!grouped[def.secteur]) {
                grouped[def.secteur] = { secteur: def.secteur, tournees: [], stats: { total: 0, retard: 0, aplanifier: 0, ok: 0, jamais: 0 } };
            }
            grouped[def.secteur].tournees.push(def);
            grouped[def.secteur].stats.total++;
            grouped[def.secteur].stats[def.statut]++;
        });
        return Object.values(grouped).sort((a, b) => a.secteur.localeCompare(b.secteur));
    }, [tourneesDef]);
    
    const stats = useMemo(() => ({
        total: tourneesDef.length,
        retard: tourneesDef.filter(t => t.statut === 'retard').length,
        aplanifier: tourneesDef.filter(t => t.statut === 'aplanifier').length,
        ok: tourneesDef.filter(t => t.statut === 'ok').length,
        jamais: tourneesDef.filter(t => t.statut === 'jamais').length,
        malGeoloc: tourneesDef.reduce((s, t) => s + t.eqMalGeoloc.length, 0),
        secteurs: tourneesParSecteur.length
    }), [tourneesDef, tourneesParSecteur]);
    
    const secteurs = useMemo(() => [...new Set(tourneesDef.map(t => t.secteur))].sort(), [tourneesDef]);
    const frequences = useMemo(() => [...new Set(tourneesDef.map(t => t.visitesParAn))].sort((a, b) => a - b), [tourneesDef]);
    
    const tourneesDefFiltered = useMemo(() => {
        let f = tourneesDef;
        if (filterSecteur) f = f.filter(t => t.secteur === filterSecteur);
        if (filterStatut) f = f.filter(t => t.statut === filterStatut);
        if (filterFrequence) f = f.filter(t => t.visitesParAn === parseInt(filterFrequence));
        return f;
    }, [tourneesDef, filterSecteur, filterStatut, filterFrequence]);
    
    const tourneesUrgentes = useMemo(() => {
        return tourneesDef.filter(t => ['retard', 'aplanifier', 'jamais'].includes(t.statut))
            .sort((a, b) => {
                const ordre = { retard: 0, aplanifier: 1, jamais: 2 };
                const diff = (ordre[a.statut] || 3) - (ordre[b.statut] || 3);
                if (diff !== 0) return diff;
                if (a.joursRestants !== null && b.joursRestants !== null) return a.joursRestants - b.joursRestants;
                return 0;
            });
    }, [tourneesDef]);
    
    // ========== PLANIFICATION ==========
    
    const getChargeParJour = useMemo(() => {
        const charge = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        for (let i = 0; i < 84; i++) {
            const d = new Date(today);
            d.setDate(d.getDate() + i);
            const key = d.toISOString().split('T')[0];
            const ferie = isJourFerie(d);
            const isWE = d.getDay() === 0 || d.getDay() === 6;
            
            if (!isWE && !ferie) {
                const techsDispo = getTechniciensDisponibles(d);
                charge[key] = { date: d, heures: 0, tournees: [], techniciens: {}, techsDisponibles: techsDispo, capaciteTotale: techsDispo.length * MAX_HEURES_JOUR * 60 };
            }
        }
        
        allTourneesPlanifiees.forEach(t => {
            if (charge[t.date]) {
                const duree = (t.duree_estimee || 120);
                charge[t.date].heures += duree / 60;
                charge[t.date].tournees.push(t);
                if (t.technicien_id) charge[t.date].techniciens[t.technicien_id] = (charge[t.date].techniciens[t.technicien_id] || 0) + duree;
            }
        });
        
        return charge;
    }, [allTourneesPlanifiees, isJourFerie, getTechniciensDisponibles]);
    
    const genererSuggestions = useCallback(() => {
        const suggs = [];
        const charge = {};
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        Object.entries(getChargeParJour).forEach(([k, v]) => {
            charge[k] = { ...v, techniciens: { ...v.techniciens }, techsDisponibles: [...v.techsDisponibles] };
        });
        
        const sorted = [...tourneesUrgentes];
        
        sorted.forEach(tournee => {
            const dateIdealeCible = tournee.prochaineVisite || today;
            const debutRecherche = new Date(Math.max(today.getTime(), dateIdealeCible.getTime() - 7 * 86400000));
            const finRecherche = new Date(dateIdealeCible.getTime() + 21 * 86400000);
            
            let meilleur = { date: null, score: -Infinity, technicien: null };
            
            Object.entries(charge).forEach(([dateStr, info]) => {
                const dateObj = new Date(dateStr);
                if (dateObj < debutRecherche || dateObj > finRecherche || info.techsDisponibles.length === 0) return;
                
                const joursDiff = Math.abs((dateObj - dateIdealeCible) / 86400000);
                const scoreProximite = 100 - joursDiff * 3;
                const scoreCharge = Math.max(0, 100 - (info.heures / (info.techsDisponibles.length * MAX_HEURES_JOUR)) * 100);
                
                let techOk = null, minCharge = Infinity;
                info.techsDisponibles.forEach(tech => {
                    const chargeTech = (info.techniciens[tech.id] || 0) / 60;
                    if (chargeTech + tournee.dureeTotale / 60 <= MAX_HEURES_JOUR && chargeTech < minCharge) {
                        minCharge = chargeTech;
                        techOk = tech;
                    }
                });
                
                if (!techOk) return;
                
                const scoreTech = 100 - (minCharge / MAX_HEURES_JOUR) * 100;
                const scoreTotal = scoreProximite * 0.4 + scoreCharge * 0.3 + scoreTech * 0.3;
                
                if (scoreTotal > meilleur.score) {
                    meilleur = { date: dateStr, score: scoreTotal, technicien: techOk };
                }
            });
            
            if (meilleur.date && meilleur.technicien) {
                charge[meilleur.date].heures += tournee.dureeTotale / 60;
                charge[meilleur.date].techniciens[meilleur.technicien.id] = (charge[meilleur.date].techniciens[meilleur.technicien.id] || 0) + tournee.dureeTotale;
                
                suggs.push({ tournee, date: meilleur.date, technicien: meilleur.technicien, score: meilleur.score });
            }
        });
        
        return suggs;
    }, [tourneesUrgentes, getChargeParJour]);
    
    const planifierEnLot = async (suggsAPlanifier) => {
        if (suggsAPlanifier.length === 0) return showToast('Aucune sélection', 'error');
        setLoading(true);
        let success = 0, errors = 0;
        
        for (const sugg of suggsAPlanifier) {
            try {
                const { error } = await db.from('tournees').insert({
                    nom: sugg.tournee.nom,
                    secteur: sugg.tournee.secteur,
                    date: sugg.date,
                    heure_debut: '08:00',
                    status: 'planifiee',
                    duree_estimee: sugg.tournee.dureeEntretien,
                    technicien_id: sugg.technicien?.id || null
                });
                if (error) throw error;
                success++;
            } catch (err) {
                console.error('Erreur planification:', err);
                errors++;
            }
        }
        
        showToast(`${success} planifiée(s)${errors ? `, ${errors} erreur(s)` : ''}`, success > 0 ? 'success' : 'error');
        setShowAutoPlan(false);
        setSelectedSuggestions([]);
        await loadAllTournees();
        await loadTourneesPlanifiees(selectedWeek);
        setLoading(false);
    };
    
    // ========== CHARGEMENT ==========
    
    useEffect(() => { loadData(); }, []);
    
    const safeQuery = async (query) => {
        try {
            const result = await query;
            return result;
        } catch (err) {
            console.log('Query error:', err);
            return { data: [] };
        }
    };
    
    const loadData = async () => {
        setLoading(true);
        try {
            const [techRes, absRes, jfRes, lieuxRes, visitesRes] = await Promise.all([
                safeQuery(db.from('profiles').select('*').in('role', ['technicien', 'admin'])),
                safeQuery(db.from('absences').select('*').gte('date_fin', new Date().toISOString().split('T')[0])),
                safeQuery(db.from('jours_feries').select('*')),
                safeQuery(db.from('lieux_depart').select('*')),
                // Charger les visites d'entretien depuis la table pannes
                safeQuery(db.from('pannes').select('id_wsoucont, jour').like('libelle', 'Visite d%entretien%').order('jour', { ascending: false }))
            ]);
            
            setTechniciens((techRes.data || []).map((t, idx) => ({
                ...t, name: [t.first_name, t.last_name].filter(Boolean).join(' ') || 'Technicien', couleur: techColors[idx % techColors.length]
            })));
            setAbsences(absRes.data || []);
            setJoursFeries(jfRes.data || []);
            setLieuxDepart(lieuxRes.data || []);
            
            // Créer un map id_wsoucont -> dernière visite d'entretien
            const visites = {};
            (visitesRes.data || []).forEach(v => {
                if (v.id_wsoucont && v.jour) {
                    // Garder uniquement la plus récente pour chaque id_wsoucont
                    if (!visites[v.id_wsoucont] || new Date(v.jour) > new Date(visites[v.id_wsoucont])) {
                        visites[v.id_wsoucont] = v.jour;
                    }
                }
            });
            setVisitesEntretien(visites);
            console.log('Visites entretien chargées:', Object.keys(visites).length);
            
            await loadAllTournees();
            await loadTourneesPlanifiees(0);
        } catch (err) { console.error(err); }
        setLoading(false);
    };
    
    const loadAllTournees = async () => {
        try {
            const today = new Date();
            const in3m = new Date(today);
            in3m.setMonth(in3m.getMonth() + 3);
            const { data } = await db.from('tournees').select('*').gte('date', today.toISOString().split('T')[0]).lte('date', in3m.toISOString().split('T')[0]);
            setAllTourneesPlanifiees(data || []);
        } catch (err) { setAllTourneesPlanifiees([]); }
    };
    
    const loadTourneesPlanifiees = async (weekOffset) => {
        const monday = getMonday(weekOffset);
        const sunday = new Date(monday);
        sunday.setDate(monday.getDate() + 6);
        try {
            const { data } = await db.from('tournees').select('*').gte('date', monday.toISOString().split('T')[0]).lte('date', sunday.toISOString().split('T')[0]).order('date');
            setTourneesPlanifiees((data || []).map(t => ({ ...t, technicien: techniciens.find(tech => tech.id === t.technicien_id), jour: new Date(t.date).getDay() })));
        } catch (err) { setTourneesPlanifiees([]); }
    };
    
    useEffect(() => { if (techniciens.length > 0) loadTourneesPlanifiees(selectedWeek); }, [selectedWeek, techniciens]);
    
    const getMonday = (off = 0) => {
        const d = new Date();
        const day = d.getDay();
        d.setDate(d.getDate() - day + (day === 0 ? -6 : 1) + off * 7);
        d.setHours(0, 0, 0, 0);
        return d;
    };
    
    const getWeekDates = () => Array.from({ length: 5 }, (_, i) => { const d = new Date(getMonday(selectedWeek)); d.setDate(d.getDate() + i); return d; });
    
    // ========== ACTIONS ==========
    
    const planifierTournee = async () => {
        if (!selectedDef || !planifierData.date) return showToast('Sélectionnez une date', 'error');
        
        try {
            const insertData = {
                nom: selectedDef.nom,
                secteur: selectedDef.secteur,
                date: planifierData.date,
                heure_debut: planifierData.heure_debut || '08:00',
                status: 'planifiee',
                duree_estimee: selectedDef.dureeEntretien
            };
            
            // Ajouter technicien seulement si sélectionné
            if (planifierData.technicien_id) {
                insertData.technicien_id = planifierData.technicien_id;
            }
            
            console.log('Insert tournée:', insertData);
            const { error } = await db.from('tournees').insert(insertData);
            
            if (error) {
                console.error('Erreur Supabase:', error);
                throw error;
            }
            
            showToast('Tournée planifiée', 'success');
            setShowPlanifier(false);
            setPlanifierData({ date: '', technicien_id: '', heure_debut: '08:00', lieu_depart_id: '' });
            setSelectedDef(null);
            await loadAllTournees();
            loadTourneesPlanifiees(selectedWeek);
        } catch (err) {
            console.error('Erreur complète:', err);
            showToast('Erreur: ' + (err.message || JSON.stringify(err)), 'error');
        }
    };
    
    const supprimerTournee = async (id) => {
        try {
            await db.from('tournees').delete().eq('id', id);
            showToast('Supprimée', 'info');
            await loadAllTournees();
            loadTourneesPlanifiees(selectedWeek);
            setSelectedTournee(null);
        } catch (err) { showToast('Erreur', 'error'); }
    };
    
    const ajouterAbsence = async () => {
        if (!absenceForm.technicien_id || !absenceForm.date_debut || !absenceForm.date_fin) return showToast('Champs requis', 'error');
        try {
            await db.from('absences').insert(absenceForm);
            showToast('Absence ajoutée', 'success');
            setAbsenceForm({ technicien_id: '', date_debut: '', date_fin: '', type: 'conge', motif: '' });
            loadData();
        } catch (err) { showToast('Erreur', 'error'); }
    };
    
    const supprimerAbsence = async (id) => {
        try { await db.from('absences').delete().eq('id', id); showToast('Supprimée', 'info'); loadData(); } catch (err) {}
    };
    
    const ajouterLieuDepart = async () => {
        if (!lieuForm.nom || !lieuForm.latitude || !lieuForm.longitude) return showToast('Champs requis', 'error');
        try {
            await db.from('lieux_depart').insert({ ...lieuForm, latitude: parseFloat(lieuForm.latitude), longitude: parseFloat(lieuForm.longitude), technicien_id: lieuForm.technicien_id || null });
            showToast('Lieu ajouté', 'success');
            setLieuForm({ nom: '', type: 'depot', adresse: '', ville: '', latitude: '', longitude: '', technicien_id: '' });
            loadData();
        } catch (err) { showToast('Erreur', 'error'); }
    };
    
    const supprimerLieu = async (id) => {
        try { await db.from('lieux_depart').delete().eq('id', id); showToast('Supprimé', 'info'); loadData(); } catch (err) {}
    };
    
    const sauvegarderCoords = async (eq) => {
        const lat = parseFloat(coordsEdit.latitude), lng = parseFloat(coordsEdit.longitude);
        if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) return showToast('Coordonnées invalides', 'error');
        try {
            await db.from('equipements').update({ latitude: lat, longitude: lng, coords_source: 'manual' }).eq('id', eq.id);
            showToast('Coordonnées mises à jour', 'success');
            setShowEditCoords(null);
            setCoordsEdit({ latitude: '', longitude: '' });
        } catch (err) { showToast('Erreur', 'error'); }
    };
    
    const toggleSecteur = (secteur) => {
        setExpandedSecteurs(prev => ({ ...prev, [secteur]: !prev[secteur] }));
    };
    
    // Carte
    useEffect(() => {
        if (showMap && selectedDef && mapContainerRef.current) {
            if (mapInstanceRef.current) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; }
            setTimeout(() => {
                if (!mapContainerRef.current) return;
                const map = L.map(mapContainerRef.current).setView([45.7772, 3.0870], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);
                
                const coords = [];
                const lieuDepart = selectedLieuDepart || SIEGE_COORDS;
                
                L.marker([lieuDepart.latitude, lieuDepart.longitude], {
                    icon: L.divIcon({ className: 'custom-marker', html: `<div style="background:#EF4444;color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3)">🏢</div>`, iconSize: [28, 28], iconAnchor: [14, 14] })
                }).addTo(map).bindPopup(`<strong>Départ:</strong> ${lieuDepart.nom}`);
                coords.push([lieuDepart.latitude, lieuDepart.longitude]);
                
                selectedDef.equipements.forEach((eq, idx) => {
                    const pos = getEquipementCoords(eq);
                    L.marker(pos, {
                        icon: L.divIcon({ className: 'custom-marker', html: `<div style="background:${COLORS.primary};color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:11px;border:2px solid white">${idx + 1}</div>`, iconSize: [24, 24], iconAnchor: [12, 12] })
                    }).addTo(map).bindPopup(`<strong>${idx + 1}. ${eq.ascenseur}</strong><br/>${eq.adresse}, ${eq.ville}`);
                    coords.push(pos);
                });
                
                coords.push([lieuDepart.latitude, lieuDepart.longitude]);
                if (coords.length > 1) L.polyline(coords, { color: COLORS.primary, weight: 3, dashArray: '8,8' }).addTo(map);
                map.fitBounds(coords, { padding: [30, 30] });
                mapInstanceRef.current = map;
            }, 100);
        }
        return () => { if (mapInstanceRef.current && !showMap) { mapInstanceRef.current.remove(); mapInstanceRef.current = null; } };
    }, [showMap, selectedDef, selectedLieuDepart, getEquipementCoords]);
    
    // ========== UI ==========
    
    const cardStyle = { background: COLORS.card, borderRadius: 12, padding: 16, border: `1px solid ${COLORS.border}` };
    const weekDates = getWeekDates();
    
    const getStatutBadge = (statut, joursRestants) => {
        const s = { retard: { bg: COLORS.danger + '20', color: COLORS.danger, icon: '🔴', text: `Retard${joursRestants !== null ? ` (${Math.abs(joursRestants)}j)` : ''}` }, aplanifier: { bg: COLORS.warning + '20', color: COLORS.warning, icon: '🟠', text: `À planifier (${joursRestants}j)` }, ok: { bg: COLORS.success + '20', color: COLORS.success, icon: '✅', text: `OK (${joursRestants}j)` }, jamais: { bg: COLORS.purple + '20', color: COLORS.purple, icon: '❓', text: 'Jamais' } }[statut] || { bg: COLORS.muted + '20', color: COLORS.muted, icon: '❓', text: 'Inconnu' };
        return { style: { padding: '4px 10px', background: s.bg, color: s.color, borderRadius: 20, fontSize: 11, fontWeight: 500 }, text: s.text, icon: s.icon };
    };
    
    const getSecteurColor = (s) => techColors[(s || '').split('').reduce((a, c) => a + c.charCodeAt(0), 0) % techColors.length];
    
    // ========== RENDER ==========
    
    const renderAPlanifier = () => h('div', null,
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(110px, 1fr))', gap: 12, marginBottom: 20 } },
            h('div', { style: { ...cardStyle, textAlign: 'center', borderLeft: `4px solid ${COLORS.danger}` } }, h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.danger } }, stats.retard), h('div', { style: { fontSize: 11, color: COLORS.muted } }, '🔴 Retard')),
            h('div', { style: { ...cardStyle, textAlign: 'center', borderLeft: `4px solid ${COLORS.warning}` } }, h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.warning } }, stats.aplanifier), h('div', { style: { fontSize: 11, color: COLORS.muted } }, '🟠 À planifier')),
            h('div', { style: { ...cardStyle, textAlign: 'center', borderLeft: `4px solid ${COLORS.purple}` } }, h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.purple } }, stats.jamais), h('div', { style: { fontSize: 11, color: COLORS.muted } }, '❓ Jamais')),
            h('div', { style: { ...cardStyle, textAlign: 'center', borderLeft: `4px solid ${COLORS.success}` } }, h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.success } }, stats.ok), h('div', { style: { fontSize: 11, color: COLORS.muted } }, '✅ OK'))
        ),
        
        h('div', { style: { display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap', alignItems: 'center' } },
            tourneesUrgentes.length > 0 && h('button', { className: 'btn btn-primary', onClick: () => { setSuggestions(genererSuggestions()); setSelectedSuggestions([]); setShowAutoPlan(true); } }, '🤖 Planif. auto (', tourneesUrgentes.length, ')'),
            h('button', { className: 'btn btn-ghost', onClick: () => setShowAbsences(true) }, '📅 Absences'),
            h('button', { className: 'btn btn-ghost', onClick: () => setShowLieuxDepart(true) }, '📍 Lieux'),
            secteursAutorises && h('span', { style: { marginLeft: 'auto', fontSize: 11, color: COLORS.muted, background: COLORS.infoPastel, padding: '4px 10px', borderRadius: 12 } }, '🔒 Secteurs: ', secteursAutorises.join(', '))
        ),
        
        h('div', { style: { ...cardStyle, padding: 0, overflow: 'hidden' } },
            h('div', { style: { padding: '12px 16px', background: COLORS.background, borderBottom: `1px solid ${COLORS.border}`, fontWeight: 600 } }, '⚠️ À planifier (', tourneesUrgentes.length, ')'),
            tourneesUrgentes.length === 0
                ? h('div', { style: { padding: 40, textAlign: 'center', color: COLORS.muted } }, '✅ Tout est à jour !')
                : h('div', { style: { maxHeight: 500, overflowY: 'auto' } },
                    tourneesUrgentes.map(def => {
                        const badge = getStatutBadge(def.statut, def.joursRestants);
                        return h('div', { key: def.id, style: { display: 'flex', alignItems: 'center', gap: 12, padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, cursor: 'pointer' }, onClick: () => setSelectedDef(def) },
                            h('span', { style: badge.style }, badge.icon),
                            h('div', { style: { flex: 1 } },
                                h('div', { style: { fontWeight: 500, marginBottom: 2 } }, def.nom),
                                h('div', { style: { fontSize: 12, color: COLORS.muted } }, def.equipements.length, ' éq. • ', Math.round(def.dureeTotale / 60 * 10) / 10, 'h')
                            ),
                            h('span', { style: { padding: '3px 8px', background: getFrequenceColor(def.visitesParAn) + '20', color: getFrequenceColor(def.visitesParAn), borderRadius: 12, fontSize: 10 } }, formatCycle(def.visitesParAn)),
                            h('button', { className: 'btn btn-sm btn-primary', onClick: e => { e.stopPropagation(); setSelectedDef(def); setShowPlanifier(true); } }, '📅')
                        );
                    })
                )
        ),
        selectedDef && !showPlanifier && renderDetailPanel()
    );
    
    const renderDetailPanel = () => h('div', { style: { position: 'fixed', right: 0, top: 0, bottom: 0, width: 480, background: COLORS.card, boxShadow: '-4px 0 20px rgba(0,0,0,0.15)', padding: 20, overflowY: 'auto', zIndex: 100 } },
        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 } },
            h('h3', { style: { fontSize: 16 } }, selectedDef.nom),
            h('button', { onClick: () => { setSelectedDef(null); setShowMap(false); }, style: { background: 'none', border: 'none', fontSize: 20, cursor: 'pointer' } }, '×')
        ),
        
        h('div', { style: { display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' } },
            (() => { const b = getStatutBadge(selectedDef.statut, selectedDef.joursRestants); return h('span', { style: b.style }, b.icon, ' ', b.text); })(),
            h('span', { style: { padding: '4px 10px', background: getFrequenceColor(selectedDef.visitesParAn) + '20', color: getFrequenceColor(selectedDef.visitesParAn), borderRadius: 20, fontSize: 11 } }, formatCycle(selectedDef.visitesParAn))
        ),
        
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 10, marginBottom: 12 } },
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } }, h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'Équipements'), h('div', { style: { fontSize: 18, fontWeight: 700 } }, selectedDef.equipements.length)),
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } }, h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'Entretien'), h('div', { style: { fontSize: 18, fontWeight: 700 } }, Math.round(selectedDef.dureeEntretien / 60 * 10) / 10, 'h')),
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } }, h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'Trajet'), h('div', { style: { fontSize: 18, fontWeight: 700 } }, selectedDef.trajets.total, 'min'))
        ),
        
        h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 10, marginBottom: 16 } },
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } }, h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'Dernière visite'), h('div', { style: { fontSize: 14, fontWeight: 600 } }, formatDate(selectedDef.derniereVisite) || '-')),
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } }, h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'Prochaine (', selectedDef.cycleJours, 'j)'), h('div', { style: { fontSize: 14, fontWeight: 600, color: selectedDef.statut === 'retard' ? COLORS.danger : COLORS.text } }, formatDate(selectedDef.prochaineVisite) || '-'))
        ),
        
        h('div', { style: { display: 'flex', gap: 8, marginBottom: 16 } },
            h('button', { className: 'btn btn-primary', style: { flex: 1 }, onClick: () => setShowPlanifier(true) }, '📅 Planifier'),
            h('button', { className: `btn ${showMap ? 'btn-primary' : 'btn-ghost'}`, onClick: () => setShowMap(!showMap) }, '🗺️')
        ),
        
        showMap && h('div', { ref: mapContainerRef, style: { height: 220, borderRadius: 8, marginBottom: 16, border: `1px solid ${COLORS.border}` } }),
        
        h('div', { style: { fontSize: 13, fontWeight: 500, marginBottom: 8 } }, '🏢 Équipements'),
        h('div', { style: { maxHeight: 280, overflowY: 'auto' } },
            selectedDef.equipements.map((eq, idx) => {
                const derniereVisiteEq = visitesEntretien[eq.id_wsoucont];
                const dateParsed = parseDate(derniereVisiteEq);
                const joursDepuis = dateParsed ? Math.floor((new Date() - dateParsed) / 86400000) : null;
                return h('div', { key: eq.id || idx, style: { display: 'flex', alignItems: 'center', gap: 10, padding: 10, background: COLORS.background, borderRadius: 8, marginBottom: 6 } },
                    h('span', { style: { width: 24, height: 24, borderRadius: '50%', background: COLORS.primary, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, fontWeight: 600, flexShrink: 0 } }, idx + 1),
                    h('div', { style: { flex: 1, minWidth: 0 } },
                        h('div', { style: { fontWeight: 500, fontSize: 12, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' } }, eq.ascenseur || eq.code),
                        h('div', { style: { fontSize: 11, color: COLORS.muted } }, eq.ville, ' • ', formatCycle(getVisitesParAn(eq)))
                    ),
                    joursDepuis !== null && h('span', { style: { fontSize: 10, padding: '2px 6px', borderRadius: 10, background: COLORS.muted + '20', color: COLORS.muted } }, joursDepuis, 'j')
                );
            })
        )
    );
    
    // Vue liste groupée par secteur
    const renderDefinitions = () => h('div', null,
        h('div', { style: { display: 'flex', gap: 12, marginBottom: 16, flexWrap: 'wrap', alignItems: 'center' } },
            h('select', { className: 'form-select', style: { maxWidth: 150 }, value: filterSecteur, onChange: e => setFilterSecteur(e.target.value) }, h('option', { value: '' }, 'Tous secteurs'), secteurs.map(s => h('option', { key: s, value: s }, s))),
            h('select', { className: 'form-select', style: { maxWidth: 140 }, value: filterStatut, onChange: e => setFilterStatut(e.target.value) }, h('option', { value: '' }, 'Tous statuts'), h('option', { value: 'retard' }, '🔴 Retard'), h('option', { value: 'aplanifier' }, '🟠 À planifier'), h('option', { value: 'ok' }, '✅ OK'), h('option', { value: 'jamais' }, '❓ Jamais')),
            h('select', { className: 'form-select', style: { maxWidth: 130 }, value: filterFrequence, onChange: e => setFilterFrequence(e.target.value) }, h('option', { value: '' }, 'Toutes fréq.'), frequences.map(f => h('option', { key: f, value: f }, formatCycle(f)))),
            h('span', { style: { marginLeft: 'auto', color: COLORS.muted, fontSize: 13 } }, stats.secteurs, ' secteur(s) • ', tourneesDefFiltered.length, ' tournée(s)'),
            h('button', { className: 'btn btn-sm btn-ghost', onClick: () => setExpandedSecteurs(tourneesParSecteur.reduce((acc, s) => ({ ...acc, [s.secteur]: true }), {})) }, '▼ Tout'),
            h('button', { className: 'btn btn-sm btn-ghost', onClick: () => setExpandedSecteurs({}) }, '▲ Rien')
        ),
        
        // Liste groupée par secteur
        h('div', { style: { display: 'flex', flexDirection: 'column', gap: 12 } },
            tourneesParSecteur.filter(g => !filterSecteur || g.secteur === filterSecteur).map(group => {
                const tourneesGroupe = group.tournees.filter(t => 
                    (!filterStatut || t.statut === filterStatut) && 
                    (!filterFrequence || t.visitesParAn === parseInt(filterFrequence))
                );
                if (tourneesGroupe.length === 0) return null;
                
                const isExpanded = expandedSecteurs[group.secteur];
                const secteurColor = getSecteurColor(group.secteur);
                
                return h('div', { key: group.secteur, style: { ...cardStyle, padding: 0, overflow: 'hidden' } },
                    // Header du secteur (cliquable)
                    h('div', { 
                        style: { 
                            padding: '14px 16px', 
                            background: secteurColor + '10', 
                            borderLeft: `4px solid ${secteurColor}`,
                            cursor: 'pointer',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'space-between'
                        },
                        onClick: () => toggleSecteur(group.secteur)
                    },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                            h('span', { style: { fontSize: 16 } }, isExpanded ? '▼' : '▶'),
                            h('div', null,
                                h('div', { style: { fontWeight: 600, color: secteurColor } }, '📍 ', group.secteur),
                                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 
                                    tourneesGroupe.length, ' tournée(s) • ',
                                    tourneesGroupe.reduce((s, t) => s + t.equipements.length, 0), ' équipements'
                                )
                            )
                        ),
                        h('div', { style: { display: 'flex', gap: 6 } },
                            group.stats.retard > 0 && h('span', { style: { padding: '2px 8px', background: COLORS.danger + '20', color: COLORS.danger, borderRadius: 10, fontSize: 11 } }, group.stats.retard, ' 🔴'),
                            group.stats.aplanifier > 0 && h('span', { style: { padding: '2px 8px', background: COLORS.warning + '20', color: COLORS.warning, borderRadius: 10, fontSize: 11 } }, group.stats.aplanifier, ' 🟠'),
                            group.stats.ok > 0 && h('span', { style: { padding: '2px 8px', background: COLORS.success + '20', color: COLORS.success, borderRadius: 10, fontSize: 11 } }, group.stats.ok, ' ✅')
                        )
                    ),
                    
                    // Liste des tournées (si expanded)
                    isExpanded && h('div', null,
                        tourneesGroupe.sort((a, b) => (a.ordre || 0) - (b.ordre || 0)).map(def => {
                            const badge = getStatutBadge(def.statut, def.joursRestants);
                            const isTourneeExpanded = expandedTournees[def.id];
                            return h('div', { key: def.id },
                                // Ligne de la tournée
                                h('div', { 
                                    style: { 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        gap: 12, 
                                        padding: '10px 16px', 
                                        borderBottom: `1px solid ${COLORS.border}`,
                                        cursor: 'pointer',
                                        background: isTourneeExpanded ? COLORS.primaryPastel : 'transparent'
                                    },
                                    onClick: () => setExpandedTournees(prev => ({ ...prev, [def.id]: !prev[def.id] }))
                                },
                                    h('span', { style: { fontSize: 12 } }, isTourneeExpanded ? '▼' : '▶'),
                                    h('span', { style: { width: 32, height: 32, borderRadius: 8, background: secteurColor + '20', color: secteurColor, display: 'flex', alignItems: 'center', justifyContent: 'center', fontWeight: 700, fontSize: 14 } }, def.ordre),
                                    h('div', { style: { flex: 1 } },
                                        h('div', { style: { fontWeight: 500, fontSize: 13 } }, 'Tournée ', def.ordre),
                                        h('div', { style: { fontSize: 11, color: COLORS.muted } }, 
                                            def.equipements.length, ' éq. • ',
                                            Math.round(def.dureeTotale / 60 * 10) / 10, 'h • ',
                                            def.derniereVisite ? `Dern: ${formatDate(def.derniereVisite) || '-'}` : 'Jamais'
                                        )
                                    ),
                                    h('span', { style: { padding: '3px 8px', background: getFrequenceColor(def.visitesParAn) + '20', color: getFrequenceColor(def.visitesParAn), borderRadius: 12, fontSize: 10 } }, formatCycle(def.visitesParAn)),
                                    h('span', { style: badge.style }, badge.icon),
                                    h('button', { className: 'btn btn-sm btn-ghost', onClick: e => { e.stopPropagation(); setSelectedDef(def); setShowPlanifier(true); } }, '📅')
                                ),
                                // Liste des équipements (si tournée dépliée)
                                isTourneeExpanded && h('div', { style: { background: COLORS.background, borderBottom: `1px solid ${COLORS.border}` } },
                                    def.equipements.map((eq, idx) => {
                                        const derniereVisiteEq = visitesEntretien[eq.id_wsoucont];
                                        const dateParsed = parseDate(derniereVisiteEq);
                                        const joursDepuis = dateParsed ? Math.floor((new Date() - dateParsed) / 86400000) : null;
                                        const cycleEq = getCycleJours(getVisitesParAn(eq));
                                        const enRetard = joursDepuis !== null && joursDepuis > cycleEq;
                                        
                                        return h('div', { 
                                            key: eq.id || eq.id_wsoucont || idx, 
                                            style: { 
                                                display: 'flex', 
                                                alignItems: 'center', 
                                                gap: 10, 
                                                padding: '8px 16px 8px 56px',
                                                borderBottom: idx < def.equipements.length - 1 ? `1px dashed ${COLORS.border}` : 'none',
                                                fontSize: 12
                                            } 
                                        },
                                            h('span', { style: { width: 20, height: 20, borderRadius: '50%', background: COLORS.primary, color: 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 10, fontWeight: 600, flexShrink: 0 } }, idx + 1),
                                            h('div', { style: { flex: 1, minWidth: 0 } },
                                                h('div', { style: { fontWeight: 500, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' } }, eq.ascenseur || eq.code || '-'),
                                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, eq.adresse || '', eq.adresse && eq.ville ? ', ' : '', eq.ville || '')
                                            ),
                                            h('span', { style: { fontSize: 10, color: COLORS.muted } }, formatCycle(getVisitesParAn(eq))),
                                            joursDepuis !== null 
                                                ? h('span', { style: { fontSize: 10, padding: '2px 6px', borderRadius: 10, background: enRetard ? COLORS.danger + '20' : COLORS.success + '20', color: enRetard ? COLORS.danger : COLORS.success } }, joursDepuis, 'j')
                                                : h('span', { style: { fontSize: 10, color: COLORS.muted } }, '-')
                                        );
                                    })
                                )
                            );
                        })
                    )
                );
            })
        )
    );
    
    const renderPlanning = () => h('div', null,
        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 } },
            h('button', { className: 'btn btn-ghost', onClick: () => setSelectedWeek(w => w - 1) }, '←'),
            h('div', { style: { textAlign: 'center' } }, h('div', { style: { fontWeight: 600 } }, 'Semaine du ', weekDates[0].toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' })), selectedWeek === 0 && h('span', { style: { fontSize: 11, color: COLORS.primary } }, '(actuelle)')),
            h('button', { className: 'btn btn-ghost', onClick: () => setSelectedWeek(w => w + 1) }, '→')
        ),
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 12 } },
            weekDates.map((date, idx) => {
                const dateStr = date.toISOString().split('T')[0];
                const tourneesJour = tourneesPlanifiees.filter(t => t.date === dateStr);
                const isToday = date.toDateString() === new Date().toDateString();
                const indispo = getIndisponibiliteRaison(date);
                const techsDispo = indispo ? [] : getTechniciensDisponibles(date);
                
                return h('div', { key: idx, style: { ...cardStyle, minHeight: 280, background: indispo ? (indispo.type === 'ferie' ? '#FEF3C7' : COLORS.background) : isToday ? COLORS.primaryPastel : COLORS.card, opacity: indispo ? 0.8 : 1 } },
                    h('div', { style: { textAlign: 'center', paddingBottom: 10, marginBottom: 10, borderBottom: `1px solid ${COLORS.border}` } },
                        h('div', { style: { fontWeight: 600, color: isToday ? COLORS.primary : COLORS.text } }, joursComplets[date.getDay()]),
                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })),
                        indispo ? h('div', { style: { fontSize: 10, color: indispo.type === 'ferie' ? '#D97706' : COLORS.danger, marginTop: 4 } }, indispo.type === 'ferie' ? '🎉 ' : '', indispo.label)
                            : h('div', { style: { fontSize: 10, color: COLORS.muted, marginTop: 4 } }, '👷 ', techsDispo.length, ' dispo')
                    ),
                    indispo
                        ? h('div', { style: { textAlign: 'center', color: COLORS.muted, fontSize: 12, padding: 20 } }, indispo.type === 'ferie' ? 'Jour férié' : 'Indisponible')
                        : tourneesJour.length === 0
                            ? h('div', { style: { textAlign: 'center', color: COLORS.muted, fontSize: 12, padding: 20 } }, 'Aucune')
                            : tourneesJour.map(t => {
                                const tech = techniciens.find(x => x.id === t.technicien_id);
                                return h('div', { key: t.id, onClick: () => setSelectedTournee(t), style: { padding: 10, background: (tech?.couleur || COLORS.primary) + '15', borderLeft: `4px solid ${tech?.couleur || COLORS.primary}`, borderRadius: 8, marginBottom: 8, cursor: 'pointer' } },
                                    h('div', { style: { fontWeight: 500, fontSize: 13, marginBottom: 4 } }, t.nom),
                                    h('div', { style: { fontSize: 11, color: COLORS.muted } }, '👤 ', tech?.name || 'Non assigné'),
                                    h('div', { style: { fontSize: 11, color: COLORS.muted } }, '🕐 ', t.heure_debut || '08:00', ' • ', Math.round((t.duree_estimee || 0) / 60 * 10) / 10, 'h')
                                );
                            })
                );
            })
        ),
        selectedTournee && h('div', { style: { position: 'fixed', right: 0, top: 0, bottom: 0, width: 400, background: COLORS.card, boxShadow: '-4px 0 20px rgba(0,0,0,0.15)', padding: 20, zIndex: 100 } },
            h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 16 } }, h('h3', null, selectedTournee.nom), h('button', { onClick: () => setSelectedTournee(null), style: { background: 'none', border: 'none', fontSize: 20, cursor: 'pointer' } }, '×')),
            h('div', { style: { ...cardStyle, background: COLORS.background, marginBottom: 16 } },
                h('p', null, '📅 ', new Date(selectedTournee.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })),
                h('p', null, '👤 ', techniciens.find(t => t.id === selectedTournee.technicien_id)?.name || 'Non assigné'),
                h('p', null, '⏱️ ', Math.round((selectedTournee.duree_estimee || 0) / 60 * 10) / 10, 'h')
            ),
            h('div', { style: { display: 'flex', gap: 8 } },
                h('button', { className: 'btn btn-danger', onClick: () => { if (confirm('Supprimer ?')) supprimerTournee(selectedTournee.id); } }, '🗑️ Supprimer')
            )
        )
    );
    
    const renderTechniciens = () => h('div', null,
        h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 20 } },
            h('h3', null, '👷 Techniciens'),
            h('div', { style: { display: 'flex', gap: 8 } }, h('button', { className: 'btn btn-ghost', onClick: () => setShowAbsences(true) }, '📅 Absences'), h('button', { className: 'btn btn-ghost', onClick: () => setShowLieuxDepart(true) }, '📍 Lieux'))
        ),
        techniciens.length === 0
            ? h('div', { style: { ...cardStyle, textAlign: 'center', padding: 40 } }, 'Aucun technicien')
            : h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(280px, 1fr))', gap: 16 } },
                techniciens.map(tech => {
                    const tourneesTech = tourneesPlanifiees.filter(t => t.technicien_id === tech.id);
                    const absencesTech = absences.filter(a => a.technicien_id === tech.id);
                    const heures = tourneesTech.reduce((s, t) => s + (t.duree_estimee || 0) / 60, 0);
                    const charge = Math.min(100, (heures / 35) * 100);
                    
                    return h('div', { key: tech.id, style: { ...cardStyle, borderTop: `4px solid ${tech.couleur}` } },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 } },
                            h('div', { style: { width: 40, height: 40, borderRadius: '50%', background: tech.couleur + '20', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 18 } }, '👷'),
                            h('div', null, h('div', { style: { fontWeight: 600 } }, tech.name), h('div', { style: { fontSize: 11, color: COLORS.muted } }, tourneesTech.length, ' tournée(s) cette sem.'))
                        ),
                        h('div', { style: { marginBottom: 12 } },
                            h('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: 12, marginBottom: 4 } }, h('span', null, 'Charge'), h('span', null, heures.toFixed(1), 'h / 35h')),
                            h('div', { style: { height: 6, background: COLORS.background, borderRadius: 3 } }, h('div', { style: { height: '100%', width: `${charge}%`, background: charge > 90 ? COLORS.danger : charge > 70 ? COLORS.warning : COLORS.success, borderRadius: 3 } }))
                        ),
                        absencesTech.length > 0 && h('div', { style: { fontSize: 11 } },
                            h('div', { style: { fontWeight: 500, marginBottom: 4 } }, '📅 Absences'),
                            absencesTech.slice(0, 2).map(a => h('div', { key: a.id, style: { padding: 4, background: absenceTypes[a.type]?.color + '15', borderRadius: 4, marginBottom: 2 } }, absenceTypes[a.type]?.icon, ' ', new Date(a.date_debut).toLocaleDateString('fr-FR'), ' → ', new Date(a.date_fin).toLocaleDateString('fr-FR')))
                        )
                    );
                })
            )
    );
    
    // MODALS
    const renderModalPlanifier = () => showPlanifier && selectedDef && h('div', { style: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 200 } },
        h('div', { style: { background: COLORS.card, borderRadius: 16, padding: 24, width: 460, maxWidth: '95%' } },
            h('h3', { style: { marginBottom: 16 } }, '📅 Planifier ', selectedDef.nom),
            h('div', { style: { marginBottom: 12 } },
                h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Date *'),
                h('input', { type: 'date', className: 'form-control', value: planifierData.date, onChange: e => setPlanifierData({ ...planifierData, date: e.target.value }) }),
                planifierData.date && (() => {
                    const d = new Date(planifierData.date);
                    const indispo = getIndisponibiliteRaison(d);
                    if (indispo) return h('div', { style: { fontSize: 11, color: COLORS.danger, marginTop: 4 } }, '⚠️ ', indispo.label);
                    return h('div', { style: { fontSize: 11, color: COLORS.success, marginTop: 4 } }, '✅ ', getTechniciensDisponibles(d).length, ' technicien(s) disponible(s)');
                })()
            ),
            h('div', { style: { marginBottom: 12 } },
                h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Technicien'),
                h('select', { className: 'form-select', value: planifierData.technicien_id, onChange: e => setPlanifierData({ ...planifierData, technicien_id: e.target.value }) },
                    h('option', { value: '' }, 'Non assigné'),
                    techniciens.map(t => {
                        const absent = planifierData.date && isTechnicienAbsent(t.id, new Date(planifierData.date));
                        return h('option', { key: t.id, value: t.id, disabled: !!absent }, t.name, absent ? ` (${absenceTypes[absent.type]?.label})` : '');
                    })
                )
            ),
            h('div', { style: { marginBottom: 16 } },
                h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Heure'),
                h('input', { type: 'time', className: 'form-control', value: planifierData.heure_debut, onChange: e => setPlanifierData({ ...planifierData, heure_debut: e.target.value }) })
            ),
            h('div', { style: { padding: 12, background: COLORS.infoPastel, borderRadius: 8, marginBottom: 16, fontSize: 12 } },
                h('div', null, '🏢 ', selectedDef.equipements.length, ' équipements'),
                h('div', null, '⏱️ Durée: ', Math.round(selectedDef.dureeTotale / 60 * 10) / 10, 'h'),
                h('div', null, '🔄 Fréquence: ', formatCycle(selectedDef.visitesParAn))
            ),
            h('div', { style: { display: 'flex', gap: 8 } },
                h('button', { className: 'btn btn-ghost', style: { flex: 1 }, onClick: () => { setShowPlanifier(false); setPlanifierData({ date: '', technicien_id: '', heure_debut: '08:00', lieu_depart_id: '' }); } }, 'Annuler'),
                h('button', { className: 'btn btn-primary', style: { flex: 1 }, onClick: planifierTournee }, 'Planifier')
            )
        )
    );
    
    const renderModalAutoPlan = () => showAutoPlan && h('div', { style: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 200 } },
        h('div', { style: { background: COLORS.card, borderRadius: 16, padding: 24, width: 700, maxWidth: '95%', maxHeight: '90vh', overflowY: 'auto' } },
            h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 16 } }, h('h3', null, '🤖 Planification Auto'), h('button', { onClick: () => setShowAutoPlan(false), style: { background: 'none', border: 'none', fontSize: 20, cursor: 'pointer' } }, '×')),
            suggestions.length === 0
                ? h('div', { style: { textAlign: 'center', padding: 40 } }, '✅ Aucune suggestion')
                : h('div', null,
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 12 } },
                        h('label', { style: { display: 'flex', alignItems: 'center', gap: 8, fontSize: 13 } }, h('input', { type: 'checkbox', checked: selectedSuggestions.length === suggestions.length, onChange: e => setSelectedSuggestions(e.target.checked ? suggestions.map((_, i) => i) : []) }), 'Tout (', selectedSuggestions.length, '/', suggestions.length, ')'),
                        h('span', { style: { fontSize: 12, color: COLORS.muted } }, Math.round(suggestions.filter((_, i) => selectedSuggestions.includes(i)).reduce((s, x) => s + x.tournee.dureeTotale, 0) / 60 * 10) / 10, 'h total')
                    ),
                    h('div', { style: { maxHeight: 400, overflowY: 'auto', marginBottom: 16 } },
                        suggestions.map((sugg, idx) => {
                            const sel = selectedSuggestions.includes(idx);
                            const dateObj = new Date(sugg.date);
                            const badge = getStatutBadge(sugg.tournee.statut, sugg.tournee.joursRestants);
                            return h('div', { key: idx, style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: sel ? COLORS.primaryPastel : COLORS.background, borderRadius: 8, marginBottom: 8, cursor: 'pointer', border: sel ? `2px solid ${COLORS.primary}` : '2px solid transparent' }, onClick: () => setSelectedSuggestions(s => s.includes(idx) ? s.filter(i => i !== idx) : [...s, idx]) },
                                h('input', { type: 'checkbox', checked: sel, onChange: () => {} }),
                                h('div', { style: { flex: 1 } },
                                    h('div', { style: { fontWeight: 500, marginBottom: 4 } }, sugg.tournee.nom),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, sugg.tournee.equipements.length, ' éq. • ', Math.round(sugg.tournee.dureeTotale / 60 * 10) / 10, 'h')
                                ),
                                h('div', { style: { textAlign: 'right' } },
                                    h('div', { style: { fontWeight: 600, color: COLORS.primary } }, joursComplets[dateObj.getDay()], ' ', dateObj.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })),
                                    h('div', { style: { fontSize: 11, color: COLORS.muted } }, '👤 ', sugg.technicien?.name || '-')
                                ),
                                h('span', { style: { ...badge.style, fontSize: 10 } }, badge.icon)
                            );
                        })
                    ),
                    h('div', { style: { display: 'flex', gap: 8 } },
                        h('button', { className: 'btn btn-ghost', style: { flex: 1 }, onClick: () => setShowAutoPlan(false) }, 'Annuler'),
                        h('button', { className: 'btn btn-primary', style: { flex: 1 }, disabled: selectedSuggestions.length === 0, onClick: () => planifierEnLot(suggestions.filter((_, i) => selectedSuggestions.includes(i))) }, '📅 Planifier ', selectedSuggestions.length)
                    )
                )
        )
    );
    
    const renderModalAbsences = () => showAbsences && h('div', { style: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 200 } },
        h('div', { style: { background: COLORS.card, borderRadius: 16, padding: 24, width: 600, maxWidth: '95%', maxHeight: '90vh', overflowY: 'auto' } },
            h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 16 } }, h('h3', null, '📅 Absences'), h('button', { onClick: () => setShowAbsences(false), style: { background: 'none', border: 'none', fontSize: 20, cursor: 'pointer' } }, '×')),
            h('div', { style: { ...cardStyle, marginBottom: 16 } },
                h('div', { style: { fontWeight: 500, marginBottom: 12 } }, '➕ Nouvelle'),
                h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 } },
                    h('div', null, h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Technicien'), h('select', { className: 'form-select', value: absenceForm.technicien_id, onChange: e => setAbsenceForm({ ...absenceForm, technicien_id: e.target.value }) }, h('option', { value: '' }, 'Choisir...'), techniciens.map(t => h('option', { key: t.id, value: t.id }, t.name)))),
                    h('div', null, h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Type'), h('select', { className: 'form-select', value: absenceForm.type, onChange: e => setAbsenceForm({ ...absenceForm, type: e.target.value }) }, Object.entries(absenceTypes).map(([k, v]) => h('option', { key: k, value: k }, v.icon, ' ', v.label)))),
                    h('div', null, h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Du'), h('input', { type: 'date', className: 'form-control', value: absenceForm.date_debut, onChange: e => setAbsenceForm({ ...absenceForm, date_debut: e.target.value }) })),
                    h('div', null, h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Au'), h('input', { type: 'date', className: 'form-control', value: absenceForm.date_fin, onChange: e => setAbsenceForm({ ...absenceForm, date_fin: e.target.value }) }))
                ),
                h('button', { className: 'btn btn-primary', style: { marginTop: 12 }, onClick: ajouterAbsence }, '➕ Ajouter')
            ),
            h('div', { style: { fontWeight: 500, marginBottom: 8 } }, '📋 Liste (', absences.length, ')'),
            absences.length === 0 ? h('div', { style: { textAlign: 'center', color: COLORS.muted, padding: 20 } }, 'Aucune')
                : h('div', { style: { maxHeight: 300, overflowY: 'auto' } },
                    absences.map(a => h('div', { key: a.id, style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: COLORS.background, borderRadius: 8, marginBottom: 8, borderLeft: `4px solid ${absenceTypes[a.type]?.color}` } },
                        h('span', { style: { fontSize: 20 } }, absenceTypes[a.type]?.icon),
                        h('div', { style: { flex: 1 } }, h('div', { style: { fontWeight: 500 } }, techniciens.find(t => t.id === a.technicien_id)?.name || '-'), h('div', { style: { fontSize: 12, color: COLORS.muted } }, new Date(a.date_debut).toLocaleDateString('fr-FR'), ' → ', new Date(a.date_fin).toLocaleDateString('fr-FR'))),
                        h('button', { className: 'btn btn-sm', style: { background: COLORS.danger + '20', color: COLORS.danger }, onClick: () => supprimerAbsence(a.id) }, '🗑️')
                    ))
                )
        )
    );
    
    const renderModalLieux = () => showLieuxDepart && h('div', { style: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 200 } },
        h('div', { style: { background: COLORS.card, borderRadius: 16, padding: 24, width: 600, maxWidth: '95%', maxHeight: '90vh', overflowY: 'auto' } },
            h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 16 } }, h('h3', null, '📍 Lieux de départ'), h('button', { onClick: () => setShowLieuxDepart(false), style: { background: 'none', border: 'none', fontSize: 20, cursor: 'pointer' } }, '×')),
            h('div', { style: { ...cardStyle, marginBottom: 16 } },
                h('div', { style: { fontWeight: 500, marginBottom: 12 } }, '➕ Nouveau'),
                h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 } },
                    h('div', null, h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Nom *'), h('input', { type: 'text', className: 'form-control', value: lieuForm.nom, onChange: e => setLieuForm({ ...lieuForm, nom: e.target.value }) })),
                    h('div', null, h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Type'), h('select', { className: 'form-select', value: lieuForm.type, onChange: e => setLieuForm({ ...lieuForm, type: e.target.value }) }, Object.entries(lieuTypes).map(([k, v]) => h('option', { key: k, value: k }, v.icon, ' ', v.label)))),
                    h('div', null, h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Latitude *'), h('input', { type: 'text', className: 'form-control', placeholder: '45.7772', value: lieuForm.latitude, onChange: e => setLieuForm({ ...lieuForm, latitude: e.target.value }) })),
                    h('div', null, h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Longitude *'), h('input', { type: 'text', className: 'form-control', placeholder: '3.0870', value: lieuForm.longitude, onChange: e => setLieuForm({ ...lieuForm, longitude: e.target.value }) })),
                    h('div', { style: { gridColumn: 'span 2' } }, h('label', { style: { fontSize: 12, color: COLORS.muted } }, 'Technicien'), h('select', { className: 'form-select', value: lieuForm.technicien_id, onChange: e => setLieuForm({ ...lieuForm, technicien_id: e.target.value }) }, h('option', { value: '' }, '🏢 Commun'), techniciens.map(t => h('option', { key: t.id, value: t.id }, '👤 ', t.name))))
                ),
                h('button', { className: 'btn btn-primary', style: { marginTop: 12 }, onClick: ajouterLieuDepart }, '➕ Ajouter')
            ),
            h('div', { style: { fontWeight: 500, marginBottom: 8 } }, '📋 Lieux (', lieuxDepart.length, ')'),
            lieuxDepart.length === 0 ? h('div', { style: { textAlign: 'center', color: COLORS.muted, padding: 20 } }, 'Aucun')
                : h('div', { style: { maxHeight: 300, overflowY: 'auto' } },
                    lieuxDepart.map(l => h('div', { key: l.id, style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: COLORS.background, borderRadius: 8, marginBottom: 8 } },
                        h('span', { style: { fontSize: 20 } }, lieuTypes[l.type]?.icon),
                        h('div', { style: { flex: 1 } }, h('div', { style: { fontWeight: 500 } }, l.nom), h('div', { style: { fontSize: 12, color: COLORS.muted } }, l.technicien_id ? '👤 ' + (techniciens.find(t => t.id === l.technicien_id)?.name || '-') : '🏢 Commun', ' • ', l.latitude?.toFixed(4), ', ', l.longitude?.toFixed(4))),
                        !l.is_default && h('button', { className: 'btn btn-sm', style: { background: COLORS.danger + '20', color: COLORS.danger }, onClick: () => supprimerLieu(l.id) }, '🗑️')
                    ))
                )
        )
    );
    
    // MAIN
    if (loading) return h('div', { style: { textAlign: 'center', padding: 60 } }, h('div', { className: 'loading-spinner', style: { marginBottom: 16 } }), h('p', { style: { color: COLORS.muted } }, 'Chargement...'));
    
    return h('div', null,
        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 } },
            h('div', null,
                h('h2', { style: { fontSize: 18, fontWeight: 600, marginBottom: 4 } }, '🚗 Gestion des Tournées'),
                h('p', { style: { fontSize: 12, color: COLORS.muted } }, 
                    stats.secteurs, ' secteur(s) • ', stats.total, ' tournées • ', stats.retard + stats.aplanifier, ' à planifier',
                    secteursAutorises && ` • 🔒 Accès limité`
                )
            )
        ),
        
        h('div', { style: { display: 'flex', gap: 4, marginBottom: 20, flexWrap: 'wrap' } },
            [
                { id: 'aplanifier', label: '⚠️ À planifier', count: stats.retard + stats.aplanifier + stats.jamais },
                { id: 'planning', label: '📅 Planning', count: tourneesPlanifiees.length },
                { id: 'definitions', label: '📋 Toutes', count: stats.total },
                { id: 'techniciens', label: '👷 Techniciens', count: techniciens.length }
            ].map(tab =>
                h('button', { key: tab.id, className: `btn ${activeView === tab.id ? 'btn-primary' : 'btn-ghost'}`, onClick: () => { setActiveView(tab.id); setSelectedDef(null); setSelectedTournee(null); } },
                    tab.label,
                    h('span', { style: { marginLeft: 6, background: activeView === tab.id ? 'rgba(255,255,255,0.2)' : tab.id === 'aplanifier' && tab.count > 0 ? COLORS.danger + '30' : COLORS.background, padding: '2px 8px', borderRadius: 10, fontSize: 11, color: tab.id === 'aplanifier' && tab.count > 0 && activeView !== tab.id ? COLORS.danger : 'inherit' } }, tab.count)
                )
            )
        ),
        
        activeView === 'aplanifier' && renderAPlanifier(),
        activeView === 'planning' && renderPlanning(),
        activeView === 'definitions' && renderDefinitions(),
        activeView === 'techniciens' && renderTechniciens(),
        
        renderModalPlanifier(),
        renderModalAutoPlan(),
        renderModalAbsences(),
        renderModalLieux()
    );
};

const ParcAscenseursPage = ({ data, user, refresh, showToast }) => {
    // Navigation par onglets
    const [activeTab, setActiveTab] = useState('dashboard');
    
    // États généraux
    const [viewMode, setViewMode] = useState('table');
    const [search, setSearch] = useState('');
    const [loading, setLoading] = useState(true);
    const [lastSync, setLastSync] = useState(null);
    
    // Panneau de détail
    const [detailPanel, setDetailPanel] = useState({ open: false, type: null, data: null });
    
    // États pour le détail équipement
    const [eqDetailTab, setEqDetailTab] = useState('pannes'); // 'pannes', 'controles', 'devis'
    const [eqControlesYear, setEqControlesYear] = useState('');
    const [eqItemDetail, setEqItemDetail] = useState(null); // { type: 'panne'|'devis', data: ... }
    
    // États pour le détail client
    const [clientDetailTab, setClientDetailTab] = useState('contrats'); // 'contrats', 'equipements'
    const [clientShowAllContrats, setClientShowAllContrats] = useState(false);
    const [clientShowAllEquipements, setClientShowAllEquipements] = useState(false);
    
    // Données brutes
    const [equipements, setEquipements] = useState([]);
    const [arrets, setArrets] = useState([]);
    const [pannes, setPannes] = useState([]);
    const [devis, setDevis] = useState([]);
    const [clients, setClients] = useState([]);
    const [contrats, setContrats] = useState([]);
    
    // Données enrichies
    const [arretsProcessed, setArretsProcessed] = useState([]);
    const [pannesProcessed, setPannesProcessed] = useState([]);
    const [devisProcessed, setDevisProcessed] = useState([]);
    
    // Filtres
    const [filters, setFilters] = useState({
        secteur: '', ville: '', marque: '', statut: '', client: '',
        technicien: '', statutDevis: '', dateFrom: '', dateTo: ''
    });
    
    // Pagination
    const [currentPage, setCurrentPage] = useState({ equipements: 1, arrets: 1, pannes: 1, devis: 1, clients: 1, contrats: 1 });
    const PAGE_SIZE = 25;
    
    // Tri
    const [sortConfig, setSortConfig] = useState({ column: 'ascenseur', direction: 'asc' });
    
    // Onglet Clients/Contrats
    const [clientsContratsTab, setClientsContratsTab] = useState('clients');
    
    // Stats dashboard
    const [stats, setStats] = useState({ 
        equipements: 0, arrets: 0, pannes: 0, devis: 0, clients: 0, contrats: 0,
        enService: 0, horsContrat: 0, secteurs: []
    });
    
    // Secteurs autorisés pour l'utilisateur (tous les rôles)
    const userSectors = useMemo(() => {
        try {
            const sectors = user?.sectors ? (typeof user.sectors === 'string' ? JSON.parse(user.sectors) : user.sectors) : [];
            return sectors.length > 0 ? sectors : null;
        } catch (e) { return null; }
    }, [user]);
    
    // Maps pour les jointures rapides
    const equipMap = useMemo(() => {
        const map = {};
        equipements.forEach(eq => { map[eq.id_wsoucont] = eq; });
        return map;
    }, [equipements]);
    
    const contratsMap = useMemo(() => {
        const map = {};
        contrats.forEach(c => { map[c.id_wcontrat] = c; });
        return map;
    }, [contrats]);
    
    const clientsMap = useMemo(() => {
        const map = {};
        clients.forEach(c => { map[c.id_wclient] = c; });
        return map;
    }, [clients]);
    
    // IDs des équipements à l'arrêt
    const arretIds = useMemo(() => new Set(arrets.map(a => a.id_wsoucont)), [arrets]);
    
    // Filtrer les équipements par secteurs utilisateur
    const filteredByUserSectors = useMemo(() => {
        if (!userSectors || userSectors.length === 0) return equipements;
        return equipements.filter(eq => !eq.secteur || userSectors.includes(eq.secteur));
    }, [equipements, userSectors]);
    
    // Charger toutes les données
    useEffect(() => { loadAllData(); }, []);
    
    const loadAllData = async () => {
        setLoading(true);
        try {
            // Charger équipements
            let eqData = [];
            try { eqData = await fetchAllRows(db, 'equipements', '*', 'ascenseur'); } catch { eqData = []; }
            
            // Charger arrêts
            let arrData = [];
            try { arrData = await fetchAllRows(db, 'appareils_arret', '*', 'date_appel'); } catch { arrData = []; }
            
            // Charger pannes
            let panData = [];
            try { panData = await fetchAllRows(db, 'pannes', '*'); } catch { panData = []; }
            
            // Charger devis
            let devData = [];
            try { devData = await fetchAllRows(db, 'devis', '*'); } catch { devData = []; }
            
            // Charger clients
            let cliData = [];
            try { cliData = await fetchAllRows(db, 'clients', '*'); } catch { cliData = []; }
            
            // Charger contrats
            let conData = [];
            try { conData = await fetchAllRows(db, 'contrats', '*'); } catch { conData = []; }
            
            setEquipements(eqData);
            setArrets(arrData);
            setPannes(panData);
            setDevis(devData);
            setClients(cliData);
            setContrats(conData);
            
            // Créer le map des équipements pour enrichissement
            const eqMap = {};
            eqData.forEach(eq => { eqMap[eq.id_wsoucont] = eq; });
            
            // Enrichir les arrêts avec les données équipement
            const enrichedArrets = arrData.map(a => {
                const equip = eqMap[a.id_wsoucont];
                return {
                    ...a,
                    _ascenseur: a.ascenseur || (equip ? equip.ascenseur : null) || `#${a.id_wsoucont}`,
                    _adresse: a.adresse || (equip ? equip.adresse : ''),
                    _ville: a.ville || (equip ? equip.ville : ''),
                    _secteur: a.secteur || (equip ? equip.secteur : ''),
                    _equip: equip
                };
            });
            setArretsProcessed(enrichedArrets);
            
            // Enrichir les pannes avec les données équipement
            const enrichedPannes = panData.map(p => {
                const equip = eqMap[p.id_wsoucont];
                return {
                    ...p,
                    _ascenseur: equip ? equip.ascenseur : `#${p.id_wsoucont}`,
                    _adresse: equip ? equip.adresse : '',
                    _ville: equip ? equip.ville : '',
                    _secteur: equip ? equip.secteur : '',
                    _equip: equip
                };
            });
            setPannesProcessed(enrichedPannes);
            
            // Enrichir les devis avec les données équipement et date acceptation
            // Créer les maps pour les jointures
            const conMap = {};
            conData.forEach(c => { conMap[c.id_wcontrat] = c; });
            const cliMap = {};
            cliData.forEach(c => { cliMap[c.id_wclient] = c; });
            
            const enrichedDevis = devData.map(d => {
                const equip = eqMap[d.id_wsoucont];
                let dateAcceptation = null;
                if (d.data) {
                    try {
                        const jsonData = typeof d.data === 'string' ? JSON.parse(d.data) : d.data;
                        if (jsonData.Date_Acceptation) dateAcceptation = String(jsonData.Date_Acceptation);
                    } catch (e) {}
                }
                // Récupérer le nom du client via équipement -> contrat -> client
                let clientNom = null;
                if (equip && equip.id_wcontrat) {
                    const contrat = conMap[equip.id_wcontrat];
                    if (contrat && contrat.id_wclient) {
                        const client = cliMap[contrat.id_wclient];
                        if (client) clientNom = client.nom;
                    }
                }
                return {
                    ...d,
                    _ascenseur: equip ? equip.ascenseur : (d.id_wsoucont ? `#${d.id_wsoucont}` : '-'),
                    _ville: equip ? equip.ville : '',
                    _secteur: equip ? equip.secteur : '',
                    _equip: equip,
                    _date_acceptation: dateAcceptation,
                    _clientNom: clientNom
                };
            });
            setDevisProcessed(enrichedDevis);
            
            // Calculer les stats
            const arretIdsSet = new Set(arrData.map(a => a.id_wsoucont));
            const secteurs = [...new Set(eqData.map(e => e.secteur).filter(Boolean))].sort();
            
            setStats({
                equipements: eqData.length,
                arrets: arrData.length,
                pannes: panData.length,
                devis: devData.length,
                clients: cliData.length,
                contrats: conData.length,
                enService: eqData.filter(e => !arretIdsSet.has(e.id_wsoucont)).length,
                horsContrat: eqData.filter(e => !e.id_wcontrat).length,
                secteurs
            });
            
            setLastSync(new Date().toLocaleString('fr-FR'));
            console.log('✅ [Parc] Données chargées:', eqData.length, 'équipements,', arrData.length, 'arrêts,', panData.length, 'pannes');
            
        } catch (err) {
            console.error('❌ [Parc] Erreur:', err);
            showToast('Erreur lors du chargement des données', 'error');
        }
        setLoading(false);
    };
    
    // Stats filtrées par secteurs utilisateur
    const filteredStats = useMemo(() => {
        const eqIds = new Set(filteredByUserSectors.map(e => e.id_wsoucont));
        const filteredArrets = arretsProcessed.filter(a => eqIds.has(a.id_wsoucont));
        const filteredPannes = pannesProcessed.filter(p => eqIds.has(p.id_wsoucont));
        const filteredDevis = devisProcessed.filter(d => eqIds.has(d.id_wsoucont));
        const arretIdsFiltered = new Set(filteredArrets.map(a => a.id_wsoucont));
        
        return {
            equipements: filteredByUserSectors.length,
            arrets: filteredArrets.length,
            pannes: filteredPannes.length,
            devis: filteredDevis.length,
            clients: stats.clients,
            contrats: stats.contrats,
            enService: filteredByUserSectors.filter(e => !arretIdsFiltered.has(e.id_wsoucont)).length,
            horsContrat: filteredByUserSectors.filter(e => !e.id_wcontrat).length,
            secteurs: [...new Set(filteredByUserSectors.map(e => e.secteur).filter(Boolean))].sort()
        };
    }, [filteredByUserSectors, arretsProcessed, pannesProcessed, devisProcessed, stats.clients, stats.contrats]);
    
    // Utilitaires
    const formatDateFR = (d) => {
        if (!d) return '-';
        const s = String(d);
        if (/^\d{8}$/.test(s)) return `${s.slice(6,8)}/${s.slice(4,6)}/${s.slice(0,4)}`;
        if (/^\d{4}-\d{2}-\d{2}/.test(s)) return s.slice(8,10) + '/' + s.slice(5,7) + '/' + s.slice(0,4);
        try { return new Date(d).toLocaleDateString('fr-FR'); } catch { return '-'; }
    };
    
    const formatHeureFR = (h) => {
        if (!h) return '';
        const s = String(h);
        if (s.includes(':')) return s.slice(0, 5);
        if (s.length >= 4) return s.slice(0, 2) + ':' + s.slice(2, 4);
        return s;
    };
    
    const formatMontant = (m) => {
        if (!m && m !== 0) return '-';
        return parseFloat(m).toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };
    
    const truncate = (str, len) => str && str.length > len ? str.slice(0, len) + '...' : str || '-';
    
    const getDevisStatut = (code) => {
        const c = String(code);
        if (c === '7') return { label: 'Facturé', color: COLORS.purple, bg: COLORS.purplePastel };
        if (c === '5') return { label: 'Commandé', color: COLORS.info, bg: COLORS.infoPastel };
        if (c === '2') return { label: 'Accepté', color: COLORS.success, bg: COLORS.successPastel };
        if (c === '3') return { label: 'Abandonné', color: COLORS.muted, bg: COLORS.background };
        if (c === '0') return { label: 'Refusé', color: COLORS.danger, bg: COLORS.dangerPastel };
        return { label: 'En attente', color: COLORS.warning, bg: COLORS.warningPastel };
    };
    
    const getSecteurColor = (s) => {
        const colors = { 'T1': '#3B82F6', 'T2': '#10B981', 'T3': '#F59E0B', 'T4': '#EF4444', 'T5': '#8B5CF6', 'T6': '#EC4899', 'T7': '#14B8A6', 'T8': '#6366F1' };
        return colors[s] || '#6B7280';
    };
    
    const openDetail = (type, item) => {
        setDetailPanel({ open: true, type, data: item });
        // Réinitialiser les états des onglets
        if (type === 'equipement') {
            setEqDetailTab('pannes');
            setEqControlesYear('');
            setEqItemDetail(null);
        } else if (type === 'client') {
            setClientDetailTab('contrats');
            setClientShowAllContrats(false);
            setClientShowAllEquipements(false);
        }
    };
    const closeDetail = () => setDetailPanel({ open: false, type: null, data: null });
    
    const getEquipementClient = (eq) => {
        if (!eq.id_wcontrat) return null;
        const contrat = contratsMap[eq.id_wcontrat];
        if (!contrat) return null;
        return clientsMap[contrat.id_wclient] || null;
    };
    
    const getEquipementContrat = (eq) => contratsMap[eq.id_wcontrat] || null;
    
    // Options filtres basées sur les données
    const filterOptions = useMemo(() => ({
        secteurs: userSectors || [...new Set(filteredByUserSectors.map(e => e.secteur).filter(Boolean))].sort(),
        villes: [...new Set(filteredByUserSectors.map(e => e.ville).filter(Boolean))].sort(),
        marques: [...new Set(filteredByUserSectors.map(e => e.div1).filter(Boolean))].sort(),
        techniciens: [...new Set(pannesProcessed.map(p => p.depanneur).filter(Boolean))].sort(),
        villesArrets: [...new Set(arretsProcessed.map(a => a._ville).filter(Boolean))].sort(),
        villesPannes: [...new Set(pannesProcessed.map(p => p._ville).filter(Boolean))].sort(),
        villesDevis: [...new Set(devisProcessed.map(d => d._ville).filter(Boolean))].sort(),
        secteursArrets: [...new Set(arretsProcessed.map(a => a._secteur).filter(Boolean))].sort(),
        secteursPannes: [...new Set(pannesProcessed.map(p => p._secteur).filter(Boolean))].sort(),
        secteursDevis: [...new Set(devisProcessed.map(d => d._secteur).filter(Boolean))].sort(),
        villesClients: [...new Set(clients.map(c => c.ville).filter(Boolean))].sort(),
        villesContrats: [...new Set(contrats.map(c => c.ville).filter(Boolean))].sort(),
        secteursContrats: [...new Set(contrats.map(c => c.secteur).filter(Boolean))].sort()
    }), [filteredByUserSectors, pannesProcessed, arretsProcessed, devisProcessed, clients, contrats, userSectors]);
    
    // Gestion du tri
    const handleSort = (column) => {
        setSortConfig(prev => ({
            column,
            direction: prev.column === column && prev.direction === 'asc' ? 'desc' : 'asc'
        }));
        setCurrentPage(p => ({ ...p, [activeTab]: 1 }));
    };
    
    const getSortedData = (data, tab) => {
        if (!sortConfig.column) return data;
        return [...data].sort((a, b) => {
            let valA, valB;
            const col = sortConfig.column;
            
            if (col === 'ascenseur') { valA = a.ascenseur || a._ascenseur || ''; valB = b.ascenseur || b._ascenseur || ''; }
            else if (col === 'contrat') { 
                const cA = getEquipementContrat(a); const cB = getEquipementContrat(b);
                valA = cA?.immeuble || ''; valB = cB?.immeuble || ''; 
            }
            else if (col === 'ville') { valA = a.ville || a._ville || ''; valB = b.ville || b._ville || ''; }
            else if (col === 'marque') { valA = a.div1 || ''; valB = b.div1 || ''; }
            else if (col === 'secteur') { valA = a.secteur || a._secteur || ''; valB = b.secteur || b._secteur || ''; }
            else if (col === 'statut') { valA = arretIds.has(a.id_wsoucont) ? 1 : 0; valB = arretIds.has(b.id_wsoucont) ? 1 : 0; }
            else if (col === 'date_panne' || col === 'date_appel') { valA = a.date_panne || a.date_appel || ''; valB = b.date_panne || b.date_appel || ''; }
            else if (col === 'date_devis') { valA = a.date_devis || ''; valB = b.date_devis || ''; }
            else if (col === 'date_acceptation') { valA = a._date_acceptation || ''; valB = b._date_acceptation || ''; }
            else if (col === 'numero') { valA = a.numero || ''; valB = b.numero || ''; }
            else if (col === 'client') { valA = a._clientNom || a.client || ''; valB = b._clientNom || b.client || ''; }
            else if (col === 'montant') { valA = parseFloat(a.montant_ht) || 0; valB = parseFloat(b.montant_ht) || 0; }
            else if (col === 'libelle') { valA = a.libelle || a.motif || ''; valB = b.libelle || b.motif || ''; }
            else if (col === 'depanneur') { valA = a.depanneur || ''; valB = b.depanneur || ''; }
            else if (col === 'duree') { valA = parseInt(a.duree) || 0; valB = parseInt(b.duree) || 0; }
            else if (col === 'motif') { valA = a.motif || ''; valB = b.motif || ''; }
            else if (col === 'demandeur') { valA = a.demandeur || ''; valB = b.demandeur || ''; }
            else if (col === 'nom') { valA = a.nom || ''; valB = b.nom || ''; }
            else if (col === 'cod') { valA = a.cod || ''; valB = b.cod || ''; }
            else if (col === 'telephone') { valA = a.telephone || ''; valB = b.telephone || ''; }
            else if (col === 'immeuble') { valA = a.immeuble || ''; valB = b.immeuble || ''; }
            else if (col === 'contrats') { 
                const countA = contrats.filter(ct => ct.id_wclient === a.id_wclient).length;
                const countB = contrats.filter(ct => ct.id_wclient === b.id_wclient).length;
                valA = countA; valB = countB;
            }
            else if (col === 'equipements') {
                if (tab === 'clients') {
                    valA = equipements.filter(e => { const c = getEquipementClient(e); return c && c.id_wclient === a.id_wclient; }).length;
                    valB = equipements.filter(e => { const c = getEquipementClient(e); return c && c.id_wclient === b.id_wclient; }).length;
                } else {
                    valA = equipements.filter(e => e.id_wcontrat === a.id_wcontrat).length;
                    valB = equipements.filter(e => e.id_wcontrat === b.id_wcontrat).length;
                }
            }
            else { valA = a[col] || ''; valB = b[col] || ''; }
            
            if (typeof valA === 'number') return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
            const cmp = String(valA).localeCompare(String(valB));
            return sortConfig.direction === 'asc' ? cmp : -cmp;
        });
    };
    
    const getPaginatedData = (data, type) => {
        const page = currentPage[type] || 1;
        const start = (page - 1) * PAGE_SIZE;
        return data.slice(start, start + PAGE_SIZE);
    };
    
    // Onglets
    const tabs = [
        { id: 'dashboard', label: 'Tableau de bord', icon: '📊', count: null },
        { id: 'equipements', label: 'Équipements', icon: '🛗', count: filteredStats.equipements },
        { id: 'arrets', label: 'Arrêts', icon: '⏸️', count: filteredStats.arrets },
        { id: 'pannes', label: 'Pannes', icon: '🔧', count: filteredStats.pannes },
        { id: 'devis', label: 'Devis', icon: '📄', count: filteredStats.devis },
        { id: 'clients', label: 'Clients & Contrats', icon: '👥', count: filteredStats.clients + filteredStats.contrats },
        { id: 'tournees', label: 'Tournées', icon: '🚗', count: null, highlight: true }
    ];
    
    const renderTabs = () => h('div', { 
        style: { display: 'flex', gap: 4, marginBottom: 20, overflowX: 'auto', paddingBottom: 4 }
    },
        tabs.map(t => h('button', { 
            key: t.id, className: `btn ${activeTab === t.id ? 'btn-primary' : 'btn-ghost'}`,
            onClick: () => { 
                setActiveTab(t.id); 
                setFilters({ secteur: '', ville: '', marque: '', statut: '', client: '', technicien: '', statutDevis: '', dateFrom: '', dateTo: '' }); 
                setSearch('');
                // Réinitialiser le tri par défaut selon l'onglet (date décroissante pour pannes/arrêts/devis)
                if (t.id === 'arrets') setSortConfig({ column: 'date_appel', direction: 'desc' });
                else if (t.id === 'pannes') setSortConfig({ column: 'date_panne', direction: 'desc' });
                else if (t.id === 'devis') setSortConfig({ column: 'date_devis', direction: 'desc' });
                else setSortConfig({ column: 'ascenseur', direction: 'asc' });
            },
            style: { whiteSpace: 'nowrap', display: 'flex', alignItems: 'center', gap: 6 }
        },
            h('span', null, t.icon),
            h('span', null, t.label),
            t.count !== null && h('span', { style: { background: activeTab === t.id ? 'rgba(255,255,255,0.2)' : COLORS.background, padding: '2px 8px', borderRadius: 12, fontSize: 11, fontWeight: 600 } }, t.count),
            t.highlight && h('span', { style: { background: COLORS.purple, color: 'white', padding: '2px 6px', borderRadius: 4, fontSize: 9, fontWeight: 600 } }, 'NEW')
        ))
    );
    
    // ========== RENDER DASHBOARD ==========
    const renderDashboard = () => h('div', null,
        userSectors && userSectors.length > 0 && h('div', { 
            style: { padding: '12px 16px', marginBottom: 16, borderRadius: 8, background: `${COLORS.info}15`, border: `1px solid ${COLORS.info}30`, display: 'flex', alignItems: 'center', gap: 10 } 
        },
            h('span', { style: { fontSize: 18 } }, '🔒'),
            h('div', null,
                h('div', { style: { fontWeight: 500, fontSize: 13 } }, 'Accès limité aux secteurs :'),
                h('div', { style: { display: 'flex', gap: 6, marginTop: 4 } },
                    userSectors.map(s => h('span', { key: s, className: 'badge', style: { background: getSecteurColor(s), color: 'white', fontSize: 11 } }, s))
                )
            )
        ),
        
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 16, marginBottom: 24 } },
            [
                { label: 'Équipements', value: filteredStats.equipements, icon: '🛗', bg: 'linear-gradient(135deg, #3B82F6, #1D4ED8)', tab: 'equipements' },
                { label: 'À l\'arrêt', value: filteredStats.arrets, icon: '⏸️', bg: 'linear-gradient(135deg, #EF4444, #DC2626)', tab: 'arrets' },
                { label: 'Pannes', value: filteredStats.pannes, icon: '🔧', bg: 'linear-gradient(135deg, #F59E0B, #D97706)', tab: 'pannes' },
                { label: 'Devis', value: filteredStats.devis, icon: '📄', bg: 'linear-gradient(135deg, #8B5CF6, #7C3AED)', tab: 'devis' },
                { label: 'Clients', value: filteredStats.clients, icon: '👥', bg: 'linear-gradient(135deg, #14B8A6, #0D9488)', tab: 'clients' },
                { label: 'Contrats', value: filteredStats.contrats, icon: '📋', bg: 'linear-gradient(135deg, #10B981, #059669)', tab: 'clients' }
            ].map(s => h('div', { 
                key: s.label, className: 'card', onClick: () => setActiveTab(s.tab),
                style: { padding: 20, background: s.bg, color: 'white', cursor: 'pointer' }
            },
                h('div', { style: { fontSize: 13, opacity: 0.9 } }, `${s.icon} ${s.label}`),
                h('div', { style: { fontSize: 32, fontWeight: 700, marginTop: 8 } }, s.value.toLocaleString())
            ))
        ),
        
        h('div', { className: 'card', style: { padding: 20, marginBottom: 20 } },
            h('h3', { style: { margin: '0 0 16px 0', fontSize: 16, fontWeight: 600 } }, '📊 Statut du parc'),
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 } },
                h('div', { style: { padding: 16, background: `${COLORS.success}15`, borderRadius: 10, textAlign: 'center' } },
                    h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.success } }, filteredStats.enService),
                    h('div', { style: { fontSize: 12, color: COLORS.textSecondary } }, 'En service')
                ),
                h('div', { style: { padding: 16, background: `${COLORS.danger}15`, borderRadius: 10, textAlign: 'center' } },
                    h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.danger } }, filteredStats.arrets),
                    h('div', { style: { fontSize: 12, color: COLORS.textSecondary } }, 'À l\'arrêt')
                ),
                h('div', { style: { padding: 16, background: `${COLORS.warning}15`, borderRadius: 10, textAlign: 'center' } },
                    h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.warning } }, filteredStats.horsContrat),
                    h('div', { style: { fontSize: 12, color: COLORS.textSecondary } }, 'Hors contrat')
                )
            )
        ),
        
        filteredStats.secteurs.length > 0 && h('div', { className: 'card', style: { padding: 20 } },
            h('h3', { style: { margin: '0 0 16px 0', fontSize: 16, fontWeight: 600 } }, '📍 Répartition par secteur'),
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', gap: 12 } },
                filteredStats.secteurs.map(s => {
                    const count = filteredByUserSectors.filter(e => e.secteur === s).length;
                    const arretCount = arretsProcessed.filter(a => a._secteur === s).length;
                    return h('div', { 
                        key: s, onClick: () => { setActiveTab('equipements'); setFilters(f => ({ ...f, secteur: s })); },
                        style: { padding: 12, borderRadius: 8, cursor: 'pointer', background: COLORS.background, border: `2px solid ${getSecteurColor(s)}` }
                    },
                        h('div', { style: { fontWeight: 600, fontSize: 14, color: getSecteurColor(s) } }, s),
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', marginTop: 8 } },
                            h('span', { style: { fontSize: 18, fontWeight: 700 } }, count),
                            arretCount > 0 && h('span', { style: { fontSize: 12, color: COLORS.danger } }, `🚨 ${arretCount}`)
                        )
                    );
                })
            )
        )
    );
    
    // ========== RENDER FILTRES ==========
    const renderFilters = (type, options = {}) => h('div', { className: 'card', style: { padding: 16, marginBottom: 16 } },
        h('div', { style: { display: 'flex', gap: 12, flexWrap: 'wrap', alignItems: 'center' } },
            h('div', { className: 'header-search', style: { flex: 1, minWidth: 200 } },
                h(Icon, { name: 'search', size: 16, color: COLORS.muted }),
                h('input', { 
                    type: 'text', placeholder: 'Rechercher...', value: search,
                    onChange: e => { setSearch(e.target.value); setCurrentPage(p => ({ ...p, [type]: 1 })); },
                    style: { border: 'none', outline: 'none', width: '100%', background: 'transparent' }
                })
            ),
            
            options.secteurs && h('select', {
                className: 'form-select', value: filters.secteur, 
                onChange: e => { setFilters(f => ({ ...f, secteur: e.target.value })); setCurrentPage(p => ({ ...p, [type]: 1 })); },
                style: { width: 140 }
            },
                h('option', { value: '' }, 'Tous secteurs'),
                options.secteurs.map(s => h('option', { key: s, value: s }, s))
            ),
            
            options.villes && h('select', {
                className: 'form-select', value: filters.ville, 
                onChange: e => { setFilters(f => ({ ...f, ville: e.target.value })); setCurrentPage(p => ({ ...p, [type]: 1 })); },
                style: { width: 140 }
            },
                h('option', { value: '' }, 'Toutes villes'),
                options.villes.map(v => h('option', { key: v, value: v }, v))
            ),
            
            options.marques && h('select', {
                className: 'form-select', value: filters.marque, 
                onChange: e => { setFilters(f => ({ ...f, marque: e.target.value })); setCurrentPage(p => ({ ...p, [type]: 1 })); },
                style: { width: 140 }
            },
                h('option', { value: '' }, 'Toutes marques'),
                options.marques.map(m => h('option', { key: m, value: m }, m))
            ),
            
            options.statuts && h('select', {
                className: 'form-select', value: filters.statut, 
                onChange: e => { setFilters(f => ({ ...f, statut: e.target.value })); setCurrentPage(p => ({ ...p, [type]: 1 })); },
                style: { width: 140 }
            },
                h('option', { value: '' }, 'Tous statuts'),
                h('option', { value: 'service' }, '✓ En service'),
                h('option', { value: 'arret' }, '🚨 À l\'arrêt')
            ),
            
            options.techniciens && h('select', {
                className: 'form-select', value: filters.technicien, 
                onChange: e => { setFilters(f => ({ ...f, technicien: e.target.value })); setCurrentPage(p => ({ ...p, [type]: 1 })); },
                style: { width: 160 }
            },
                h('option', { value: '' }, 'Tous techniciens'),
                options.techniciens.map(t => h('option', { key: t, value: t }, t))
            ),
            
            options.statutsDevis && h('select', {
                className: 'form-select', value: filters.statutDevis, 
                onChange: e => { setFilters(f => ({ ...f, statutDevis: e.target.value })); setCurrentPage(p => ({ ...p, [type]: 1 })); },
                style: { width: 140 }
            },
                h('option', { value: '' }, 'Tous statuts'),
                h('option', { value: '7' }, 'Facturé'),
                h('option', { value: '5' }, 'Commandé'),
                h('option', { value: '2' }, 'Accepté'),
                h('option', { value: '0' }, 'Refusé'),
                h('option', { value: '3' }, 'Abandonné')
            ),
            
            (filters.secteur || filters.ville || filters.marque || filters.statut || filters.technicien || filters.statutDevis || search) && 
                h('button', { className: 'btn btn-ghost btn-sm', onClick: () => { setFilters({ secteur: '', ville: '', marque: '', statut: '', client: '', technicien: '', statutDevis: '', dateFrom: '', dateTo: '' }); setSearch(''); } }, '✕ Effacer')
        )
    );
    
    // ========== RENDER PAGINATION ==========
    const renderPagination = (type, total) => {
        const page = currentPage[type] || 1;
        const totalPages = Math.ceil(total / PAGE_SIZE);
        if (totalPages <= 1) return null;
        
        return h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '12px 0' } },
            h('span', { style: { fontSize: 13, color: COLORS.muted } }, `${(page-1)*PAGE_SIZE + 1}-${Math.min(page*PAGE_SIZE, total)} sur ${total}`),
            h('div', { style: { display: 'flex', gap: 4 } },
                h('button', { className: 'btn btn-ghost btn-sm', disabled: page === 1, onClick: () => setCurrentPage(p => ({ ...p, [type]: page - 1 })) }, '←'),
                Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                    let p = i + 1;
                    if (totalPages > 5) {
                        if (page > 3) p = page - 2 + i;
                        if (page > totalPages - 2) p = totalPages - 4 + i;
                    }
                    return h('button', { key: p, className: `btn btn-${p === page ? 'primary' : 'ghost'} btn-sm`, onClick: () => setCurrentPage(prev => ({ ...prev, [type]: p })) }, p);
                }),
                h('button', { className: 'btn btn-ghost btn-sm', disabled: page === totalPages, onClick: () => setCurrentPage(p => ({ ...p, [type]: page + 1 })) }, '→')
            )
        );
    };
    
    // ========== RENDER ÉQUIPEMENTS ==========
    const renderEquipements = () => {
        let filtered = filteredByUserSectors.filter(eq => {
            if (search) {
                const term = search.toLowerCase();
                if (![eq.ascenseur, eq.immeuble, eq.adresse, eq.ville, eq.div1, eq.secteur, String(eq.id_wsoucont)].some(f => (f||'').toLowerCase().includes(term))) return false;
            }
            if (filters.secteur && eq.secteur !== filters.secteur) return false;
            if (filters.ville && eq.ville !== filters.ville) return false;
            if (filters.marque && eq.div1 !== filters.marque) return false;
            if (filters.statut === 'arret' && !arretIds.has(eq.id_wsoucont)) return false;
            if (filters.statut === 'service' && arretIds.has(eq.id_wsoucont)) return false;
            return true;
        });
        
        filtered = getSortedData(filtered, 'equipements');
        const paginated = getPaginatedData(filtered, 'equipements');
        
        const sortIcon = (col) => sortConfig.column === col ? (sortConfig.direction === 'asc' ? ' ↑' : ' ↓') : '';
        
        return h('div', null,
            renderFilters('equipements', { secteurs: filterOptions.secteurs, villes: filterOptions.villes, marques: filterOptions.marques, statuts: true }),
            
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                h('span', { style: { fontSize: 13, color: COLORS.muted } }, `${filtered.length} équipement${filtered.length > 1 ? 's' : ''}`),
                h('button', { className: 'btn btn-secondary btn-sm', onClick: () => setViewMode(v => v === 'table' ? 'cards' : 'table') },
                    viewMode === 'table' ? '🃏 Vue cartes' : '📋 Vue tableau'
                )
            ),
            
            viewMode === 'table' ? 
                h('div', { className: 'card' },
                    h('div', { style: { overflowX: 'auto' } },
                        h('table', { className: 'data-table' },
                            h('thead', null,
                                h('tr', null,
                                    h('th', { onClick: () => handleSort('ascenseur'), style: { cursor: 'pointer' } }, 'Équipement' + sortIcon('ascenseur')),
                                    h('th', { onClick: () => handleSort('contrat'), style: { cursor: 'pointer' } }, 'Contrat' + sortIcon('contrat')),
                                    h('th', { onClick: () => handleSort('ville'), style: { cursor: 'pointer' } }, 'Ville' + sortIcon('ville')),
                                    h('th', { onClick: () => handleSort('marque'), style: { cursor: 'pointer' } }, 'Marque' + sortIcon('marque')),
                                    h('th', { onClick: () => handleSort('secteur'), style: { cursor: 'pointer' } }, 'Secteur' + sortIcon('secteur')),
                                    h('th', { onClick: () => handleSort('statut'), style: { cursor: 'pointer' } }, 'Statut' + sortIcon('statut'))
                                )
                            ),
                            h('tbody', null,
                                paginated.length === 0 
                                    ? h('tr', null, h('td', { colSpan: 6, style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun équipement trouvé'))
                                    : paginated.map(eq => {
                                        const isArret = arretIds.has(eq.id_wsoucont);
                                        const contrat = getEquipementContrat(eq);
                                        const client = getEquipementClient(eq);
                                        return h('tr', { 
                                            key: eq.id_wsoucont, onClick: () => openDetail('equipement', eq),
                                            style: { cursor: 'pointer', background: isArret ? COLORS.dangerPastel : 'transparent' }
                                        },
                                            h('td', null, 
                                                h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                                    h('span', { style: { fontSize: 20 } }, isArret ? '⏸️' : '🛗'),
                                                    h('div', null,
                                                        h('div', { style: { fontWeight: 600, color: COLORS.primary } }, eq.ascenseur || `#${eq.id_wsoucont}`),
                                                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, truncate(eq.adresse, 30))
                                                    )
                                                )
                                            ),
                                            h('td', null, contrat ? 
                                                h('div', { onClick: e => { e.stopPropagation(); openDetail('contrat', contrat); }, style: { cursor: 'pointer' } },
                                                    h('div', { style: { color: COLORS.info, fontWeight: 500 } }, truncate(contrat.immeuble || `Contrat #${contrat.id_wcontrat}`, 25)),
                                                    client && h('div', { style: { fontSize: 11, color: COLORS.muted } }, truncate(client.nom, 20))
                                                ) : '-'
                                            ),
                                            h('td', null, eq.ville || '-'),
                                            h('td', null, eq.div1 || '-'),
                                            h('td', null, eq.secteur ? h('span', { className: 'badge', style: { background: getSecteurColor(eq.secteur), color: 'white' } }, eq.secteur) : '-'),
                                            h('td', null, isArret ? h('span', { className: 'badge badge-danger' }, '🚨 À l\'arrêt') : h('span', { className: 'badge badge-success' }, '✓ En service'))
                                        );
                                    })
                            )
                        )
                    ),
                    renderPagination('equipements', filtered.length)
                ) :
                h('div', null,
                    h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 16 } },
                        paginated.map(eq => {
                            const isArret = arretIds.has(eq.id_wsoucont);
                            const contrat = getEquipementContrat(eq);
                            const client = getEquipementClient(eq);
                            return h('div', { 
                                key: eq.id_wsoucont, className: 'card hover-lift', onClick: () => openDetail('equipement', eq),
                                style: { padding: 0, cursor: 'pointer', overflow: 'hidden' }
                            },
                                h('div', { style: { padding: 16, borderBottom: `1px solid ${COLORS.border}` } },
                                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
                                        h('div', null,
                                            h('div', { style: { fontWeight: 700, fontSize: 15, color: COLORS.primary } }, eq.ascenseur || `#${eq.id_wsoucont}`),
                                            h('div', { style: { fontSize: 13, color: COLORS.muted, marginTop: 4 } }, eq.adresse || '-')
                                        ),
                                        h('span', { className: `badge ${isArret ? 'badge-danger' : 'badge-success'}` }, isArret ? '⏸️ Arrêt' : '✅ Service')
                                    )
                                ),
                                contrat && h('div', { 
                                    onClick: e => { e.stopPropagation(); openDetail('contrat', contrat); },
                                    style: { padding: '10px 16px', background: COLORS.background, display: 'flex', alignItems: 'center', gap: 10, cursor: 'pointer' }
                                },
                                    h('span', null, '📋'),
                                    h('div', { style: { flex: 1 } },
                                        h('div', { style: { fontWeight: 500, fontSize: 13 } }, truncate(contrat.immeuble || `Contrat #${contrat.id_wcontrat}`, 30)),
                                        client && h('div', { style: { fontSize: 11, color: COLORS.muted } }, `👤 ${truncate(client.nom, 25)}`)
                                    ),
                                    h('span', { style: { color: COLORS.muted } }, '→')
                                ),
                                h('div', { style: { padding: 16, display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12 } },
                                    [
                                        { label: 'Ville', value: eq.ville },
                                        { label: 'Secteur', value: eq.secteur },
                                        { label: 'Marque', value: eq.div1 },
                                        { label: 'Config', value: eq.div2 },
                                        { label: 'Année', value: eq.div5 }
                                    ].filter(f => f.value).map(f => h('div', { key: f.label },
                                        h('div', { style: { fontSize: 10, color: COLORS.muted, textTransform: 'uppercase' } }, f.label),
                                        h('div', { style: { fontSize: 13, fontWeight: 500 } }, f.value)
                                    ))
                                )
                            );
                        })
                    ),
                    h('div', { className: 'card', style: { marginTop: 16 } }, renderPagination('equipements', filtered.length))
                )
        );
    };
    
    // ========== RENDER ARRÊTS ==========
    const renderArrets = () => {
        const eqIds = new Set(filteredByUserSectors.map(e => e.id_wsoucont));
        let filtered = arretsProcessed.filter(a => {
            if (!eqIds.has(a.id_wsoucont)) return false;
            if (search) {
                const term = search.toLowerCase();
                if (![a._ascenseur, a._adresse, a._ville, a.motif, a.demandeur].some(f => (f||'').toLowerCase().includes(term))) return false;
            }
            if (filters.secteur && a._secteur !== filters.secteur) return false;
            if (filters.ville && a._ville !== filters.ville) return false;
            return true;
        });
        
        filtered = getSortedData(filtered, 'arrets');
        const paginated = getPaginatedData(filtered, 'arrets');
        
        const sortIcon = (col) => sortConfig.column === col ? (sortConfig.direction === 'asc' ? ' ↑' : ' ↓') : '';
        
        return h('div', null,
            renderFilters('arrets', { secteurs: filterOptions.secteursArrets, villes: filterOptions.villesArrets }),
            
            h('div', { className: 'card' },
                h('div', { style: { overflowX: 'auto' } },
                    h('table', { className: 'data-table' },
                        h('thead', null,
                            h('tr', null,
                                h('th', { onClick: () => handleSort('date_appel'), style: { cursor: 'pointer' } }, 'Date' + sortIcon('date_appel')),
                                h('th', { onClick: () => handleSort('ascenseur'), style: { cursor: 'pointer' } }, 'Appareil' + sortIcon('ascenseur')),
                                h('th', null, 'Adresse'),
                                h('th', { onClick: () => handleSort('ville'), style: { cursor: 'pointer' } }, 'Ville' + sortIcon('ville')),
                                h('th', { onClick: () => handleSort('secteur'), style: { cursor: 'pointer' } }, 'Secteur' + sortIcon('secteur')),
                                h('th', { onClick: () => handleSort('motif'), style: { cursor: 'pointer' } }, 'Motif' + sortIcon('motif')),
                                h('th', { onClick: () => handleSort('demandeur'), style: { cursor: 'pointer' } }, 'Demandeur' + sortIcon('demandeur'))
                            )
                        ),
                        h('tbody', null,
                            paginated.length === 0 
                                ? h('tr', null, h('td', { colSpan: 7, style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, '✅ Aucun appareil à l\'arrêt'))
                                : paginated.map(a => h('tr', { 
                                    key: a.id || a.id_wsoucont, onClick: () => a._equip && openDetail('equipement', a._equip),
                                    style: { cursor: 'pointer', background: COLORS.dangerPastel }
                                },
                                    h('td', null, formatDateFR(a.date_appel)),
                                    h('td', null, h('span', { style: { color: COLORS.primary, fontWeight: 600 } }, a._ascenseur)),
                                    h('td', null, truncate(a._adresse, 30)),
                                    h('td', null, a._ville || '-'),
                                    h('td', null, a._secteur ? h('span', { className: 'badge', style: { background: getSecteurColor(a._secteur), color: 'white' } }, a._secteur) : '-'),
                                    h('td', null, truncate(a.motif, 25) || '-'),
                                    h('td', null, a.demandeur || '-')
                                ))
                        )
                    )
                ),
                renderPagination('arrets', filtered.length)
            )
        );
    };
    
    // ========== RENDER PANNES ==========
    const renderPannes = () => {
        const eqIds = new Set(filteredByUserSectors.map(e => e.id_wsoucont));
        let filtered = pannesProcessed.filter(p => {
            if (!eqIds.has(p.id_wsoucont)) return false;
            if (search) {
                const term = search.toLowerCase();
                if (![p._ascenseur, p.libelle, p.motif, p._ville, p.depanneur].some(f => (f||'').toLowerCase().includes(term))) return false;
            }
            if (filters.secteur && p._secteur !== filters.secteur) return false;
            if (filters.ville && p._ville !== filters.ville) return false;
            if (filters.technicien && p.depanneur !== filters.technicien) return false;
            return true;
        });
        
        filtered = getSortedData(filtered, 'pannes');
        const paginated = getPaginatedData(filtered, 'pannes');
        
        const sortIcon = (col) => sortConfig.column === col ? (sortConfig.direction === 'asc' ? ' ↑' : ' ↓') : '';
        
        return h('div', null,
            renderFilters('pannes', { secteurs: filterOptions.secteursPannes, villes: filterOptions.villesPannes, techniciens: filterOptions.techniciens }),
            
            h('div', { className: 'card' },
                h('div', { style: { overflowX: 'auto' } },
                    h('table', { className: 'data-table' },
                        h('thead', null,
                            h('tr', null,
                                h('th', { onClick: () => handleSort('date_panne'), style: { cursor: 'pointer' } }, 'Date' + sortIcon('date_panne')),
                                h('th', { onClick: () => handleSort('ascenseur'), style: { cursor: 'pointer' } }, 'Appareil' + sortIcon('ascenseur')),
                                h('th', { onClick: () => handleSort('libelle'), style: { cursor: 'pointer' } }, 'Libellé' + sortIcon('libelle')),
                                h('th', { onClick: () => handleSort('ville'), style: { cursor: 'pointer' } }, 'Ville' + sortIcon('ville')),
                                h('th', { onClick: () => handleSort('secteur'), style: { cursor: 'pointer' } }, 'Secteur' + sortIcon('secteur')),
                                h('th', { onClick: () => handleSort('depanneur'), style: { cursor: 'pointer' } }, 'Technicien' + sortIcon('depanneur')),
                                h('th', { onClick: () => handleSort('duree'), style: { cursor: 'pointer' } }, 'Durée' + sortIcon('duree'))
                            )
                        ),
                        h('tbody', null,
                            paginated.length === 0 
                                ? h('tr', null, h('td', { colSpan: 7, style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune panne'))
                                : paginated.map(p => h('tr', { 
                                    key: p.id_panne, onClick: () => openDetail('panne', p),
                                    style: { cursor: 'pointer' }
                                },
                                    h('td', null, 
                                        h('div', null, formatDateFR(p.date_panne)),
                                        p.heure_inter && h('div', { style: { fontSize: 11, color: COLORS.muted } }, formatHeureFR(p.heure_inter))
                                    ),
                                    h('td', null, 
                                        h('span', { 
                                            onClick: e => { e.stopPropagation(); p._equip && openDetail('equipement', p._equip); },
                                            style: { color: COLORS.primary, fontWeight: 600, cursor: 'pointer' } 
                                        }, p._ascenseur)
                                    ),
                                    h('td', null, truncate(p.libelle || p.motif, 30) || '-'),
                                    h('td', null, p._ville || '-'),
                                    h('td', null, p._secteur ? h('span', { className: 'badge', style: { background: getSecteurColor(p._secteur), color: 'white' } }, p._secteur) : '-'),
                                    h('td', null, truncate(p.depanneur, 15) || '-'),
                                    h('td', null, p.duree ? `${p.duree} min` : '-')
                                ))
                        )
                    )
                ),
                renderPagination('pannes', filtered.length)
            )
        );
    };
    
    // ========== RENDER DEVIS ==========
    const renderDevis = () => {
        const eqIds = new Set(filteredByUserSectors.map(e => e.id_wsoucont));
        let filtered = devisProcessed.filter(d => {
            // Exclure les devis sans appareil
            if (!d.id_wsoucont) return false;
            if (!eqIds.has(d.id_wsoucont)) return false;
            if (search) {
                const term = search.toLowerCase();
                if (![d.numero, d._ascenseur, d._clientNom, d.objet].some(f => (f||'').toLowerCase().includes(term))) return false;
            }
            if (filters.secteur && d._secteur !== filters.secteur) return false;
            if (filters.ville && d._ville !== filters.ville) return false;
            if (filters.statutDevis && String(d.statut) !== filters.statutDevis) return false;
            return true;
        });
        
        filtered = getSortedData(filtered, 'devis');
        const paginated = getPaginatedData(filtered, 'devis');
        
        const sortIcon = (col) => sortConfig.column === col ? (sortConfig.direction === 'asc' ? ' ↑' : ' ↓') : '';
        
        return h('div', null,
            renderFilters('devis', { secteurs: filterOptions.secteursDevis, villes: filterOptions.villesDevis, statutsDevis: true }),
            
            h('div', { style: { marginBottom: 12, padding: 12, background: COLORS.infoPastel, borderRadius: 8 } },
                h('span', { style: { fontSize: 13, color: COLORS.info } }, `${filtered.length} devis`)
            ),
            
            h('div', { className: 'card' },
                h('div', { style: { overflowX: 'auto' } },
                    h('table', { className: 'data-table' },
                        h('thead', null,
                            h('tr', null,
                                h('th', { onClick: () => handleSort('date_devis'), style: { cursor: 'pointer' } }, 'Date devis' + sortIcon('date_devis')),
                                h('th', { onClick: () => handleSort('date_acceptation'), style: { cursor: 'pointer' } }, 'Date accept.' + sortIcon('date_acceptation')),
                                h('th', { onClick: () => handleSort('numero'), style: { cursor: 'pointer' } }, 'Numéro' + sortIcon('numero')),
                                h('th', { onClick: () => handleSort('ascenseur'), style: { cursor: 'pointer' } }, 'Appareil' + sortIcon('ascenseur')),
                                h('th', { onClick: () => handleSort('client'), style: { cursor: 'pointer' } }, 'Client' + sortIcon('client')),
                                h('th', { onClick: () => handleSort('statut'), style: { cursor: 'pointer' } }, 'Statut' + sortIcon('statut'))
                            )
                        ),
                        h('tbody', null,
                            paginated.length === 0 
                                ? h('tr', null, h('td', { colSpan: 6, style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun devis'))
                                : paginated.map(d => {
                                    const statut = getDevisStatut(d.statut);
                                    return h('tr', { 
                                        key: d.id_devis, onClick: () => openDetail('devis', d),
                                        style: { cursor: 'pointer' }
                                    },
                                        h('td', null, formatDateFR(d.date_devis)),
                                        h('td', null, d._date_acceptation ? formatDateFR(d._date_acceptation) : '-'),
                                        h('td', null, h('code', { style: { fontFamily: 'monospace', fontWeight: 600 } }, d.numero || `#${d.id_devis}`)),
                                        h('td', null, 
                                            h('span', { 
                                                onClick: e => { e.stopPropagation(); d._equip && openDetail('equipement', d._equip); },
                                                style: { color: COLORS.primary, fontWeight: 500, cursor: 'pointer' } 
                                            }, d._ascenseur)
                                        ),
                                        h('td', null, truncate(d._clientNom, 25) || '-'),
                                        h('td', null, h('span', { className: 'badge', style: { background: statut.bg, color: statut.color } }, statut.label))
                                    );
                                })
                        )
                    )
                ),
                renderPagination('devis', filtered.length)
            )
        );
    };
    
    // ========== RENDER CLIENTS & CONTRATS ==========
    const renderClientsContrats = () => {
        // Compter les contrats et équipements par client
        const contratsParClient = {};
        const equipParClient = {};
        contrats.forEach(ct => {
            if (ct.id_wclient) contratsParClient[ct.id_wclient] = (contratsParClient[ct.id_wclient] || 0) + 1;
        });
        equipements.forEach(eq => {
            const client = getEquipementClient(eq);
            if (client) equipParClient[client.id_wclient] = (equipParClient[client.id_wclient] || 0) + 1;
        });
        
        // Compter les équipements par contrat
        const equipParContrat = {};
        equipements.forEach(eq => {
            if (eq.id_wcontrat) equipParContrat[eq.id_wcontrat] = (equipParContrat[eq.id_wcontrat] || 0) + 1;
        });
        
        return h('div', null,
            // Sous-onglets
            h('div', { style: { display: 'flex', gap: 8, marginBottom: 16 } },
                h('button', { 
                    className: `btn ${clientsContratsTab === 'clients' ? 'btn-primary' : 'btn-ghost'}`,
                    onClick: () => setClientsContratsTab('clients')
                }, '👤 Clients'),
                h('button', { 
                    className: `btn ${clientsContratsTab === 'contrats' ? 'btn-primary' : 'btn-ghost'}`,
                    onClick: () => setClientsContratsTab('contrats')
                }, '📋 Contrats')
            ),
            
            clientsContratsTab === 'clients' ? renderClients(contratsParClient, equipParClient) : renderContrats(equipParContrat)
        );
    };
    
    const renderClients = (contratsParClient, equipParClient) => {
        let filtered = clients.filter(c => {
            if (search) {
                const term = search.toLowerCase();
                if (![c.nom, c.ville, c.cod, c.telephone].some(f => (f||'').toLowerCase().includes(term))) return false;
            }
            if (filters.ville && c.ville !== filters.ville) return false;
            return true;
        });
        
        filtered = getSortedData(filtered, 'clients');
        const paginated = getPaginatedData(filtered, 'clients');
        
        const sortIcon = (col) => sortConfig.column === col ? (sortConfig.direction === 'asc' ? ' ↑' : ' ↓') : '';
        
        return h('div', null,
            renderFilters('clients', { villes: filterOptions.villesClients }),
            
            h('div', { className: 'card' },
                h('div', { style: { overflowX: 'auto' } },
                    h('table', { className: 'data-table' },
                        h('thead', null,
                            h('tr', null,
                                h('th', { onClick: () => handleSort('cod'), style: { cursor: 'pointer' } }, 'Code' + sortIcon('cod')),
                                h('th', { onClick: () => handleSort('nom'), style: { cursor: 'pointer' } }, 'Nom' + sortIcon('nom')),
                                h('th', { onClick: () => handleSort('ville'), style: { cursor: 'pointer' } }, 'Ville' + sortIcon('ville')),
                                h('th', { onClick: () => handleSort('contrats'), style: { cursor: 'pointer', textAlign: 'center' } }, 'Contrats' + sortIcon('contrats')),
                                h('th', { onClick: () => handleSort('equipements'), style: { cursor: 'pointer', textAlign: 'center' } }, 'Équipements' + sortIcon('equipements')),
                                h('th', { onClick: () => handleSort('telephone'), style: { cursor: 'pointer' } }, 'Téléphone' + sortIcon('telephone'))
                            )
                        ),
                        h('tbody', null,
                            paginated.length === 0 
                                ? h('tr', null, h('td', { colSpan: 6, style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun client'))
                                : paginated.map(c => h('tr', { 
                                    key: c.id_wclient, onClick: () => openDetail('client', c),
                                    style: { cursor: 'pointer' }
                                },
                                    h('td', null, h('code', { style: { fontFamily: 'monospace' } }, c.cod || '-')),
                                    h('td', null, h('strong', null, truncate(c.nom, 30) || '-')),
                                    h('td', null, c.ville || '-'),
                                    h('td', { style: { textAlign: 'center' } }, h('span', { className: 'badge badge-info' }, contratsParClient[c.id_wclient] || 0)),
                                    h('td', { style: { textAlign: 'center' } }, h('span', { className: 'badge badge-success' }, equipParClient[c.id_wclient] || 0)),
                                    h('td', null, c.telephone || '-')
                                ))
                        )
                    )
                ),
                renderPagination('clients', filtered.length)
            )
        );
    };
    
    const renderContrats = (equipParContrat) => {
        let filtered = contrats.filter(c => {
            if (search) {
                const term = search.toLowerCase();
                const client = clientsMap[c.id_wclient];
                if (![c.immeuble, c.ville, c.ascenseur, c.batiment, client?.nom].some(f => (f||'').toLowerCase().includes(term))) return false;
            }
            if (filters.secteur && c.secteur !== filters.secteur) return false;
            if (filters.ville && c.ville !== filters.ville) return false;
            return true;
        });
        
        filtered = getSortedData(filtered, 'contrats');
        const paginated = getPaginatedData(filtered, 'contrats');
        
        const sortIcon = (col) => sortConfig.column === col ? (sortConfig.direction === 'asc' ? ' ↑' : ' ↓') : '';
        
        return h('div', null,
            renderFilters('contrats', { secteurs: filterOptions.secteursContrats, villes: filterOptions.villesContrats }),
            
            h('div', { className: 'card' },
                h('div', { style: { overflowX: 'auto' } },
                    h('table', { className: 'data-table' },
                        h('thead', null,
                            h('tr', null,
                                h('th', null, 'ID'),
                                h('th', { onClick: () => handleSort('client'), style: { cursor: 'pointer' } }, 'Client' + sortIcon('client')),
                                h('th', { onClick: () => handleSort('immeuble'), style: { cursor: 'pointer' } }, 'Immeuble' + sortIcon('immeuble')),
                                h('th', { onClick: () => handleSort('ville'), style: { cursor: 'pointer' } }, 'Ville' + sortIcon('ville')),
                                h('th', { onClick: () => handleSort('secteur'), style: { cursor: 'pointer' } }, 'Secteur' + sortIcon('secteur')),
                                h('th', { onClick: () => handleSort('equipements'), style: { cursor: 'pointer', textAlign: 'center' } }, 'Équipements' + sortIcon('equipements'))
                            )
                        ),
                        h('tbody', null,
                            paginated.length === 0 
                                ? h('tr', null, h('td', { colSpan: 6, style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun contrat'))
                                : paginated.map(c => {
                                    const client = clientsMap[c.id_wclient];
                                    return h('tr', { 
                                        key: c.id_wcontrat, onClick: () => openDetail('contrat', c),
                                        style: { cursor: 'pointer' }
                                    },
                                        h('td', null, h('code', { style: { fontFamily: 'monospace' } }, `#${c.id_wcontrat}`)),
                                        h('td', null, h('strong', null, client ? truncate(client.nom, 25) : '-')),
                                        h('td', null, truncate(c.immeuble, 25) || '-'),
                                        h('td', null, c.ville || '-'),
                                        h('td', null, c.secteur ? h('span', { className: 'badge', style: { background: getSecteurColor(c.secteur), color: 'white' } }, c.secteur) : '-'),
                                        h('td', { style: { textAlign: 'center' } }, h('span', { className: 'badge badge-success' }, equipParContrat[c.id_wcontrat] || 0))
                                    );
                                })
                        )
                    )
                ),
                renderPagination('contrats', filtered.length)
            )
        );
    };
    
    // ========== RENDER DETAIL PANEL ==========
    const renderDetailPanel = () => {
        if (!detailPanel.open || !detailPanel.data) return null;
        
        const { type, data: item } = detailPanel;
        
        return h(Fragment, null,
            h('div', { onClick: closeDetail, style: { position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.5)', zIndex: 999 } }),
            h('div', { 
                style: { 
                    position: 'fixed', top: 0, right: 0, width: 500, maxWidth: '90vw', height: '100vh',
                    background: COLORS.card, boxShadow: '-4px 0 20px rgba(0,0,0,0.15)', zIndex: 1000, overflow: 'auto',
                    animation: 'slideIn 0.3s ease'
                }
            },
                h('style', null, `@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }`),
                
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: 20, borderBottom: `1px solid ${COLORS.border}`, position: 'sticky', top: 0, background: COLORS.card, zIndex: 10 } },
                    h('h3', { style: { margin: 0, fontSize: 18, fontWeight: 600 } }, 
                        type === 'equipement' ? `🛗 ${item.ascenseur || '#' + item.id_wsoucont}` :
                        type === 'panne' ? `🔧 Panne #${item.id_panne}` :
                        type === 'devis' ? `📄 Devis ${item.numero || '#' + item.id_devis}` :
                        type === 'client' ? `👤 ${truncate(item.nom, 25)}` :
                        type === 'contrat' ? `📋 ${truncate(item.immeuble, 25) || 'Contrat #' + item.id_wcontrat}` : 'Détails'
                    ),
                    h('button', { onClick: closeDetail, className: 'btn btn-ghost' }, '✕')
                ),
                
                h('div', { style: { padding: 20 } },
                    type === 'equipement' && renderEquipementDetail(item),
                    type === 'panne' && renderPanneDetail(item),
                    type === 'devis' && renderDevisDetail(item),
                    type === 'client' && renderClientDetail(item),
                    type === 'contrat' && renderContratDetail(item)
                )
            )
        );
    };
    
    const renderEquipementDetail = (eq) => {
        const isArret = arretIds.has(eq.id_wsoucont);
        const contrat = getEquipementContrat(eq);
        const client = getEquipementClient(eq);
        
        // Récupérer et trier les pannes (plus récentes en premier)
        const allEqPannes = pannesProcessed
            .filter(p => p.id_wsoucont === eq.id_wsoucont)
            .sort((a, b) => {
                const dateA = String(a.date_panne || '');
                const dateB = String(b.date_panne || '');
                return dateB.localeCompare(dateA);
            });
        
        // Classifier les pannes en contrôles vs pannes/entretiens
        const isControle = (p) => {
            const combined = ((p.libelle || '') + ' ' + (p.motif || '')).toLowerCase();
            return combined.includes('parachute') || combined.includes('câble') || combined.includes('cable') || 
                   combined.includes('contrôle') || combined.includes('controle') || combined.includes('vérification') || 
                   combined.includes('quinquennal') || combined.includes('réglementaire') || combined.includes('semestriel') || 
                   combined.includes('annuel') || combined.includes('porte pali') || combined.includes('limiteur') || 
                   combined.includes('etanchéité') || combined.includes('5 ans') || combined.includes('technique');
        };
        
        const isEntretien = (p) => {
            const combined = ((p.libelle || '') + ' ' + (p.motif || '')).toLowerCase();
            return combined.includes('entretien') || combined.includes('visite') || combined.includes('maintenance') || combined.includes('mensuel');
        };
        
        const getItemType = (p) => {
            if (isControle(p)) return { type: 'controle', label: 'Contrôle réglementaire', icon: '✅', color: COLORS.success };
            if (isEntretien(p)) return { type: 'entretien', label: 'Entretien', icon: '🔧', color: COLORS.info };
            return { type: 'panne', label: 'Panne', icon: '⚠️', color: COLORS.warning };
        };
        
        const eqPannesEntretiens = allEqPannes.filter(p => !isControle(p));
        const eqControles = allEqPannes.filter(p => isControle(p));
        
        // Années disponibles pour les contrôles
        const controlesYears = [...new Set(eqControles.map(c => {
            const d = String(c.date_panne || '');
            if (/^\d{8}$/.test(d)) return d.slice(0, 4);
            if (/^\d{4}-/.test(d)) return d.slice(0, 4);
            return null;
        }).filter(Boolean))].sort((a, b) => b.localeCompare(a));
        
        // Filtrer les contrôles par année
        const filteredControles = eqControlesYear 
            ? eqControles.filter(c => {
                const d = String(c.date_panne || '');
                if (/^\d{8}$/.test(d)) return d.slice(0, 4) === eqControlesYear;
                if (/^\d{4}-/.test(d)) return d.slice(0, 4) === eqControlesYear;
                return false;
            })
            : eqControles;
        
        // Récupérer et trier les devis (plus récents en premier)
        const eqDevis = devisProcessed
            .filter(d => d.id_wsoucont === eq.id_wsoucont)
            .sort((a, b) => {
                const dateA = String(a.date_devis || '');
                const dateB = String(b.date_devis || '');
                return dateB.localeCompare(dateA);
            });
        
        const tabStyle = (active) => ({
            padding: '8px 16px', border: 'none', background: active ? COLORS.primary : 'transparent',
            color: active ? 'white' : COLORS.text, borderRadius: 6, cursor: 'pointer', fontWeight: 500, fontSize: 13
        });
        
        // ========== AFFICHAGE DÉTAIL D'UN ITEM ==========
        if (eqItemDetail) {
            const item = eqItemDetail.data;
            const itemType = eqItemDetail.type;
            
            // Rendu du détail d'une panne/entretien/contrôle
            if (itemType === 'panne') {
                const typeInfo = getItemType(item);
                return h('div', null,
                    // Bouton retour
                    h('button', { 
                        className: 'btn btn-ghost btn-sm', 
                        onClick: () => setEqItemDetail(null),
                        style: { marginBottom: 16, display: 'flex', alignItems: 'center', gap: 6 }
                    }, '← Retour'),
                    
                    // Header coloré
                    h('div', { 
                        style: { 
                            padding: 16, borderRadius: 12, marginBottom: 20, 
                            background: `linear-gradient(135deg, ${typeInfo.color}20, ${typeInfo.color}10)`,
                            border: `1px solid ${typeInfo.color}40`
                        }
                    },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                            h('span', { style: { fontSize: 32 } }, typeInfo.icon),
                            h('div', null,
                                h('div', { style: { fontWeight: 600, fontSize: 16, color: typeInfo.color } }, typeInfo.label),
                                h('div', { style: { fontSize: 13, color: COLORS.muted } }, `${formatDateFR(item.date_panne)} ${item.jour ? '(' + item.jour + ')' : ''}`)
                            )
                        )
                    ),
                    
                    // Détails
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 16 } },
                        h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                            h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'ID INTERVENTION'),
                            h('div', { style: { fontWeight: 500, fontFamily: 'monospace' } }, `#${item.id_panne || '-'}`)
                        ),
                        h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                            h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'TECHNICIEN'),
                            h('div', { style: { fontWeight: 500 } }, item.depanneur || '-')
                        )
                    ),
                    
                    h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8, marginBottom: 12 } },
                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 6 } }, 'LIBELLÉ'),
                        h('div', { style: { fontWeight: 500, lineHeight: 1.5 } }, item.libelle || '-')
                    ),
                    
                    h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8, marginBottom: 12 } },
                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 6 } }, 'MOTIF / DÉTAIL'),
                        h('div', { style: { lineHeight: 1.5 } }, item.motif || '-')
                    ),
                    
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: 12, marginBottom: 16 } },
                        h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                            h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'HEURE DÉBUT'),
                            h('div', { style: { fontWeight: 500 } }, formatHeureFR(item.heure_inter) || '-')
                        ),
                        h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                            h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'HEURE FIN'),
                            h('div', { style: { fontWeight: 500 } }, formatHeureFR(item.heure_fin) || '-')
                        ),
                        h('div', { style: { padding: 12, background: typeInfo.color + '20', borderRadius: 8 } },
                            h('div', { style: { fontSize: 11, color: typeInfo.color, marginBottom: 4 } }, 'DURÉE'),
                            h('div', { style: { fontWeight: 700, color: typeInfo.color } }, item.duree ? `${item.duree} min` : '-')
                        )
                    ),
                    
                    item.note && h('div', { style: { padding: 16, background: COLORS.warningPastel, borderRadius: 8, marginBottom: 12 } },
                        h('div', { style: { fontSize: 11, color: COLORS.warning, marginBottom: 6 } }, '📝 NOTES / OBSERVATIONS'),
                        h('div', { style: { lineHeight: 1.5 } }, item.note)
                    ),
                    
                    item.cause && h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, marginBottom: 12 } },
                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'CAUSE'),
                        h('div', null, item.cause)
                    )
                );
            }
            
            // Rendu du détail d'un devis
            if (itemType === 'devis') {
                const statut = getDevisStatut(item.statut);
                return h('div', null,
                    // Bouton retour
                    h('button', { 
                        className: 'btn btn-ghost btn-sm', 
                        onClick: () => setEqItemDetail(null),
                        style: { marginBottom: 16, display: 'flex', alignItems: 'center', gap: 6 }
                    }, '← Retour'),
                    
                    // Header coloré
                    h('div', { 
                        style: { 
                            padding: 16, borderRadius: 12, marginBottom: 20, 
                            background: `linear-gradient(135deg, ${COLORS.purple}20, ${COLORS.purple}10)`,
                            border: `1px solid ${COLORS.purple}40`
                        }
                    },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                            h('span', { style: { fontSize: 32 } }, '📄'),
                            h('div', null,
                                h('div', { style: { fontWeight: 600, fontSize: 16, color: COLORS.purple } }, `Devis ${item.numero || '#' + item.id_devis}`),
                                h('div', { style: { fontSize: 13, color: COLORS.muted } }, formatDateFR(item.date_devis))
                            )
                        )
                    ),
                    
                    // Statut
                    h('div', { style: { display: 'flex', gap: 12, marginBottom: 16 } },
                        h('div', { style: { flex: 1, padding: 12, background: COLORS.background, borderRadius: 8 } },
                            h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'STATUT'),
                            h('span', { className: 'badge', style: { background: statut.bg, color: statut.color } }, statut.label)
                        ),
                        item._date_acceptation && h('div', { style: { flex: 1, padding: 12, background: COLORS.background, borderRadius: 8 } },
                            h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'DATE ACCEPTATION'),
                            h('div', { style: { fontWeight: 500 } }, formatDateFR(item._date_acceptation))
                        )
                    ),
                    
                    h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8, marginBottom: 12 } },
                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 6 } }, 'OBJET'),
                        h('div', { style: { lineHeight: 1.5 } }, item.objet || '-')
                    ),
                    
                    h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, marginBottom: 12 } },
                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'CLIENT'),
                        h('div', { style: { fontWeight: 500 } }, item._clientNom || item.client || '-')
                    ),
                    
                    item.commentaire && h('div', { style: { padding: 16, background: COLORS.infoPastel, borderRadius: 8, marginBottom: 12 } },
                        h('div', { style: { fontSize: 11, color: COLORS.info, marginBottom: 6 } }, '💬 COMMENTAIRE'),
                        h('div', { style: { lineHeight: 1.5 } }, item.commentaire)
                    )
                );
            }
        }
        
        // ========== AFFICHAGE NORMAL (LISTE) ==========
        const renderItem = (item, type, borderColor) => h('div', { 
            key: item.id_panne || item.id_devis, 
            onClick: () => setEqItemDetail({ type, data: item }),
            style: { padding: 12, background: COLORS.background, borderRadius: 8, marginBottom: 8, borderLeft: `4px solid ${borderColor}`, cursor: 'pointer', transition: 'transform 0.1s' },
            onMouseOver: e => e.currentTarget.style.transform = 'translateX(4px)',
            onMouseOut: e => e.currentTarget.style.transform = 'translateX(0)'
        },
            type === 'panne' ? h(Fragment, null,
                h('div', { style: { fontWeight: 500, marginBottom: 4 } }, truncate(item.libelle || item.motif, 45)),
                h('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: 12, color: COLORS.muted } },
                    h('span', null, formatDateFR(item.date_panne)),
                    h('span', null, item.depanneur || '-')
                )
            ) : h(Fragment, null,
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 4 } },
                    h('span', { style: { fontWeight: 500 } }, item.numero || `#${item.id_devis}`),
                    h('span', { className: 'badge', style: { background: getDevisStatut(item.statut).bg, color: getDevisStatut(item.statut).color, fontSize: 10 } }, getDevisStatut(item.statut).label)
                ),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, `${formatDateFR(item.date_devis)}${item._clientNom ? ' - ' + item._clientNom : ''}`)
            )
        );
        
        return h('div', null,
            h('div', { style: { display: 'flex', gap: 8, marginBottom: 16 } },
                isArret ? h('span', { className: 'badge badge-danger' }, '🚨 À l\'arrêt') : h('span', { className: 'badge badge-success' }, '✓ En service'),
                eq.secteur && h('span', { className: 'badge', style: { background: getSecteurColor(eq.secteur), color: 'white' } }, eq.secteur)
            ),
            
            h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 20 } },
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'IMMEUBLE'),
                    h('div', { style: { fontWeight: 500 } }, eq.immeuble || '-')
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'MARQUE'),
                    h('div', { style: { fontWeight: 500 } }, eq.div1 || '-')
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, gridColumn: 'span 2' } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'ADRESSE'),
                    h('div', null, eq.adresse || '-'),
                    h('div', { style: { color: COLORS.muted } }, [eq.code_postal, eq.ville].filter(Boolean).join(' '))
                ),
                eq.div2 && h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'CONFIG'),
                    h('div', { style: { fontWeight: 500 } }, eq.div2)
                ),
                eq.div5 && h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'ANNÉE'),
                    h('div', { style: { fontWeight: 500 } }, eq.div5)
                )
            ),
            
            contrat && h('div', { 
                onClick: () => openDetail('contrat', contrat),
                style: { padding: 12, background: COLORS.infoPastel, borderRadius: 8, marginBottom: 20, cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
            },
                h('div', null,
                    h('div', { style: { fontSize: 11, color: COLORS.info } }, '📋 CONTRAT'),
                    h('div', { style: { fontWeight: 500, color: COLORS.info } }, contrat.immeuble || `#${contrat.id_wcontrat}`),
                    client && h('div', { style: { fontSize: 12, color: COLORS.muted } }, `👤 ${client.nom}`)
                ),
                h('span', { style: { color: COLORS.info } }, '→')
            ),
            
            // Onglets
            h('div', { style: { display: 'flex', gap: 8, marginBottom: 16, background: COLORS.background, padding: 6, borderRadius: 10 } },
                h('button', { style: tabStyle(eqDetailTab === 'pannes'), onClick: () => setEqDetailTab('pannes') }, 
                    `🔧 Pannes (${eqPannesEntretiens.length})`
                ),
                h('button', { style: tabStyle(eqDetailTab === 'controles'), onClick: () => setEqDetailTab('controles') }, 
                    `📋 Contrôles (${eqControles.length})`
                ),
                h('button', { style: tabStyle(eqDetailTab === 'devis'), onClick: () => setEqDetailTab('devis') }, 
                    `📄 Devis (${eqDevis.length})`
                )
            ),
            
            // Contenu selon l'onglet
            eqDetailTab === 'pannes' && h('div', { style: { maxHeight: 350, overflowY: 'auto' } },
                eqPannesEntretiens.length === 0 
                    ? h('div', { style: { color: COLORS.muted, fontSize: 13, textAlign: 'center', padding: 30 } }, 'Aucune panne/entretien enregistré')
                    : eqPannesEntretiens.map(p => renderItem(p, 'panne', COLORS.warning))
            ),
            
            eqDetailTab === 'controles' && h('div', null,
                // Filtre par année
                controlesYears.length > 0 && h('div', { style: { marginBottom: 12 } },
                    h('select', {
                        className: 'form-select', value: eqControlesYear,
                        onChange: e => setEqControlesYear(e.target.value),
                        style: { width: '100%' }
                    },
                        h('option', { value: '' }, `Toutes les années (${eqControles.length})`),
                        controlesYears.map(y => h('option', { key: y, value: y }, 
                            `${y} (${eqControles.filter(c => String(c.date_panne || '').startsWith(y)).length})`
                        ))
                    )
                ),
                h('div', { style: { maxHeight: 300, overflowY: 'auto' } },
                    filteredControles.length === 0 
                        ? h('div', { style: { color: COLORS.muted, fontSize: 13, textAlign: 'center', padding: 30 } }, 'Aucun contrôle enregistré')
                        : filteredControles.map(p => renderItem(p, 'panne', COLORS.purple))
                )
            ),
            
            eqDetailTab === 'devis' && h('div', { style: { maxHeight: 350, overflowY: 'auto' } },
                eqDevis.length === 0 
                    ? h('div', { style: { color: COLORS.muted, fontSize: 13, textAlign: 'center', padding: 30 } }, 'Aucun devis')
                    : eqDevis.map(d => renderItem(d, 'devis', getDevisStatut(d.statut).color))
            )
        );
    };
    
    const renderPanneDetail = (p) => h('div', null,
        h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 20 } },
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'DATE'),
                h('div', { style: { fontWeight: 500 } }, formatDateFR(p.date_panne))
            ),
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'HEURE'),
                h('div', { style: { fontWeight: 500 } }, formatHeureFR(p.heure_inter) || '-')
            ),
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'TECHNICIEN'),
                h('div', { style: { fontWeight: 500 } }, p.depanneur || '-')
            ),
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'DURÉE'),
                h('div', { style: { fontWeight: 500 } }, p.duree ? `${p.duree} min` : '-')
            ),
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, gridColumn: 'span 2' } },
                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'LIBELLÉ'),
                h('div', { style: { fontWeight: 500 } }, p.libelle || '-')
            ),
            h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, gridColumn: 'span 2' } },
                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'MOTIF'),
                h('div', null, p.motif || '-')
            )
        ),
        p._equip && h('div', { 
            onClick: () => openDetail('equipement', p._equip),
            style: { padding: 12, background: COLORS.primaryPastel, borderRadius: 8, cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
        },
            h('div', null,
                h('div', { style: { fontSize: 11, color: COLORS.primary } }, '🛗 ÉQUIPEMENT'),
                h('div', { style: { fontWeight: 500, color: COLORS.primary } }, p._ascenseur)
            ),
            h('span', { style: { color: COLORS.primary } }, '→')
        )
    );
    
    const renderDevisDetail = (d) => {
        const statut = getDevisStatut(d.statut);
        return h('div', null,
            h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 20 } },
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'NUMÉRO'),
                    h('div', { style: { fontWeight: 500, fontFamily: 'monospace' } }, d.numero || `#${d.id_devis}`)
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'STATUT'),
                    h('span', { className: 'badge', style: { background: statut.bg, color: statut.color } }, statut.label)
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'DATE DEVIS'),
                    h('div', { style: { fontWeight: 500 } }, formatDateFR(d.date_devis))
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'DATE ACCEPTATION'),
                    h('div', { style: { fontWeight: 500 } }, d._date_acceptation ? formatDateFR(d._date_acceptation) : '-')
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, gridColumn: 'span 2' } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'CLIENT'),
                    h('div', { style: { fontWeight: 500 } }, d._clientNom || '-')
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, gridColumn: 'span 2' } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'OBJET'),
                    h('div', null, d.objet || '-')
                )
            ),
            
            d._equip && h('div', { 
                onClick: () => openDetail('equipement', d._equip),
                style: { padding: 12, background: COLORS.primaryPastel, borderRadius: 8, cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
            },
                h('div', null,
                    h('div', { style: { fontSize: 11, color: COLORS.primary } }, '🛗 ÉQUIPEMENT'),
                    h('div', { style: { fontWeight: 500, color: COLORS.primary } }, d._ascenseur)
                ),
                h('span', { style: { color: COLORS.primary } }, '→')
            )
        );
    };
    
    const renderClientDetail = (c) => {
        const clientContrats = contrats.filter(ct => ct.id_wclient === c.id_wclient);
        const clientEquipements = equipements.filter(eq => {
            const client = getEquipementClient(eq);
            return client && client.id_wclient === c.id_wclient;
        });
        
        const LIMIT = 5;
        const displayedContrats = clientShowAllContrats ? clientContrats : clientContrats.slice(0, LIMIT);
        const displayedEquipements = clientShowAllEquipements ? clientEquipements : clientEquipements.slice(0, LIMIT);
        
        const tabStyle = (active) => ({
            padding: '8px 16px', border: 'none', background: active ? COLORS.primary : 'transparent',
            color: active ? 'white' : COLORS.text, borderRadius: 6, cursor: 'pointer', fontWeight: 500, fontSize: 13
        });
        
        return h('div', null,
            h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 20 } },
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'CODE'),
                    h('div', { style: { fontWeight: 500, fontFamily: 'monospace' } }, c.cod || '-')
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'TÉLÉPHONE'),
                    h('div', { style: { fontWeight: 500 } }, c.telephone || '-')
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, gridColumn: 'span 2' } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'ADRESSE'),
                    h('div', null, c.adresse || '-'),
                    h('div', { style: { color: COLORS.muted } }, [c.code_postal, c.ville].filter(Boolean).join(' '))
                )
            ),
            
            // Compteurs
            h('div', { style: { display: 'flex', gap: 12, marginBottom: 20 } },
                h('div', { 
                    onClick: () => setClientDetailTab('contrats'),
                    style: { flex: 1, padding: 16, background: clientDetailTab === 'contrats' ? COLORS.info : COLORS.infoPastel, borderRadius: 8, textAlign: 'center', cursor: 'pointer', transition: 'all 0.2s' } 
                },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: clientDetailTab === 'contrats' ? 'white' : COLORS.info } }, clientContrats.length),
                    h('div', { style: { fontSize: 12, color: clientDetailTab === 'contrats' ? 'white' : COLORS.info } }, 'Contrats')
                ),
                h('div', { 
                    onClick: () => setClientDetailTab('equipements'),
                    style: { flex: 1, padding: 16, background: clientDetailTab === 'equipements' ? COLORS.success : COLORS.successPastel, borderRadius: 8, textAlign: 'center', cursor: 'pointer', transition: 'all 0.2s' } 
                },
                    h('div', { style: { fontSize: 24, fontWeight: 700, color: clientDetailTab === 'equipements' ? 'white' : COLORS.success } }, clientEquipements.length),
                    h('div', { style: { fontSize: 12, color: clientDetailTab === 'equipements' ? 'white' : COLORS.success } }, 'Équipements')
                )
            ),
            
            // Contenu selon l'onglet
            clientDetailTab === 'contrats' && h('div', null,
                clientContrats.length === 0 
                    ? h('div', { style: { color: COLORS.muted, fontSize: 13, textAlign: 'center', padding: 30 } }, 'Aucun contrat')
                    : h(Fragment, null,
                        h('div', { style: { maxHeight: clientShowAllContrats ? 350 : 'none', overflowY: clientShowAllContrats ? 'auto' : 'visible' } },
                            displayedContrats.map(ct => h('div', { 
                                key: ct.id_wcontrat, onClick: () => openDetail('contrat', ct),
                                style: { padding: 12, background: COLORS.background, borderRadius: 8, marginBottom: 8, cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center', transition: 'transform 0.1s' },
                                onMouseOver: e => e.currentTarget.style.transform = 'translateX(4px)',
                                onMouseOut: e => e.currentTarget.style.transform = 'translateX(0)'
                            },
                                h('div', null,
                                    h('div', { style: { fontWeight: 500 } }, ct.immeuble || `#${ct.id_wcontrat}`),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted, display: 'flex', gap: 8 } },
                                        h('span', null, ct.ville || '-'),
                                        ct.secteur && h('span', { className: 'badge', style: { background: getSecteurColor(ct.secteur), color: 'white', fontSize: 9, padding: '2px 6px' } }, ct.secteur)
                                    )
                                ),
                                h('span', { style: { color: COLORS.muted } }, '→')
                            ))
                        ),
                        clientContrats.length > LIMIT && h('button', {
                            className: 'btn btn-secondary btn-sm',
                            onClick: () => setClientShowAllContrats(!clientShowAllContrats),
                            style: { width: '100%', marginTop: 8 }
                        }, clientShowAllContrats ? '▲ Voir moins' : `▼ Voir plus (${clientContrats.length - LIMIT} autres)`)
                    )
            ),
            
            clientDetailTab === 'equipements' && h('div', null,
                clientEquipements.length === 0 
                    ? h('div', { style: { color: COLORS.muted, fontSize: 13, textAlign: 'center', padding: 30 } }, 'Aucun équipement')
                    : h(Fragment, null,
                        h('div', { style: { maxHeight: clientShowAllEquipements ? 350 : 'none', overflowY: clientShowAllEquipements ? 'auto' : 'visible' } },
                            displayedEquipements.map(eq => {
                                const isArret = arretIds.has(eq.id_wsoucont);
                                return h('div', { 
                                    key: eq.id_wsoucont, onClick: () => openDetail('equipement', eq),
                                    style: { padding: 12, background: isArret ? COLORS.dangerPastel : COLORS.background, borderRadius: 8, marginBottom: 8, cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center', transition: 'transform 0.1s' },
                                    onMouseOver: e => e.currentTarget.style.transform = 'translateX(4px)',
                                    onMouseOut: e => e.currentTarget.style.transform = 'translateX(0)'
                                },
                                    h('div', null,
                                        h('div', { style: { fontWeight: 500 } }, eq.ascenseur || `#${eq.id_wsoucont}`),
                                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, eq.adresse || '-')
                                    ),
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                        isArret ? h('span', { className: 'badge badge-danger', style: { fontSize: 10 } }, '🚨') : h('span', { className: 'badge badge-success', style: { fontSize: 10 } }, '✓'),
                                        h('span', { style: { color: COLORS.muted } }, '→')
                                    )
                                );
                            })
                        ),
                        clientEquipements.length > LIMIT && h('button', {
                            className: 'btn btn-secondary btn-sm',
                            onClick: () => setClientShowAllEquipements(!clientShowAllEquipements),
                            style: { width: '100%', marginTop: 8 }
                        }, clientShowAllEquipements ? '▲ Voir moins' : `▼ Voir plus (${clientEquipements.length - LIMIT} autres)`)
                    )
            )
        );
    };
    
    const renderContratDetail = (c) => {
        const client = clientsMap[c.id_wclient];
        const contratEquipements = equipements.filter(eq => eq.id_wcontrat === c.id_wcontrat);
        
        return h('div', null,
            h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 20 } },
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'ID CONTRAT'),
                    h('div', { style: { fontWeight: 500, fontFamily: 'monospace' } }, `#${c.id_wcontrat}`)
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'SECTEUR'),
                    c.secteur ? h('span', { className: 'badge', style: { background: getSecteurColor(c.secteur), color: 'white' } }, c.secteur) : h('div', null, '-')
                ),
                h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, gridColumn: 'span 2' } },
                    h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, 'ADRESSE'),
                    h('div', null, c.adresse || '-'),
                    h('div', { style: { color: COLORS.muted } }, [c.code_postal, c.ville].filter(Boolean).join(' '))
                )
            ),
            
            client && h('div', { 
                onClick: () => openDetail('client', client),
                style: { padding: 12, background: COLORS.tealPastel, borderRadius: 8, marginBottom: 20, cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
            },
                h('div', null,
                    h('div', { style: { fontSize: 11, color: COLORS.teal } }, '👤 CLIENT'),
                    h('div', { style: { fontWeight: 500, color: COLORS.teal } }, client.nom)
                ),
                h('span', { style: { color: COLORS.teal } }, '→')
            ),
            
            h('div', { style: { padding: 16, background: COLORS.successPastel, borderRadius: 8, textAlign: 'center', marginBottom: 20 } },
                h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.success } }, contratEquipements.length),
                h('div', { style: { fontSize: 12, color: COLORS.success } }, 'Équipements')
            ),
            
            contratEquipements.length > 0 && h('div', null,
                h('h4', { style: { margin: '0 0 12px 0', fontSize: 14, fontWeight: 600 } }, '🛗 Équipements'),
                h('div', { style: { maxHeight: 250, overflowY: 'auto' } },
                    contratEquipements.map(eq => {
                        const isArret = arretIds.has(eq.id_wsoucont);
                        return h('div', { 
                            key: eq.id_wsoucont, onClick: () => openDetail('equipement', eq),
                            style: { padding: 10, background: isArret ? COLORS.dangerPastel : COLORS.background, borderRadius: 6, marginBottom: 8, cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
                        },
                            h('div', null,
                                h('div', { style: { fontWeight: 500 } }, eq.ascenseur || `#${eq.id_wsoucont}`),
                                h('div', { style: { fontSize: 12, color: COLORS.muted } }, eq.adresse || '-')
                            ),
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                isArret ? h('span', { className: 'badge badge-danger', style: { fontSize: 10 } }, '🚨') : h('span', { className: 'badge badge-success', style: { fontSize: 10 } }, '✓'),
                                h('span', { style: { color: COLORS.muted } }, '→')
                            )
                        );
                    })
                )
            )
        );
    };
    
    // ========== RENDER PRINCIPAL ==========
    return h('div', { className: 'page-container' },
        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 } },
            h('h1', { className: 'page-title' }, '🛗 Parc ascenseurs'),
            h('div', { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                lastSync && h('span', { style: { fontSize: 12, color: COLORS.muted } }, `Sync: ${lastSync}`),
                h('button', { className: 'btn btn-secondary btn-sm', onClick: loadAllData, disabled: loading }, loading ? '⏳' : '🔄 Actualiser')
            )
        ),
        
        renderTabs(),
        
        loading ? 
            h('div', { className: 'card', style: { padding: 60, textAlign: 'center' } },
                h('div', { className: 'spinner', style: { margin: '0 auto 16px' } }),
                h('div', { style: { color: COLORS.muted } }, 'Chargement des données...')
            ) :
            activeTab === 'dashboard' ? renderDashboard() :
            activeTab === 'equipements' ? renderEquipements() :
            activeTab === 'arrets' ? renderArrets() :
            activeTab === 'pannes' ? renderPannes() :
            activeTab === 'devis' ? renderDevis() :
            activeTab === 'clients' ? renderClientsContrats() :
            activeTab === 'tournees' ? h(TourneesTab, { equipements: filteredByUserSectors, user, showToast }) : null,
        
        renderDetailPanel()
    );
};




// ==========================================
// MISE EN SERVICE PAGE
// ==========================================
const MiseEnServicePage = ({ data, user, refresh, showToast }) => {
    const [status, setStatus] = useState(null);
    const [viewMode, setViewMode] = useState('grid'); // 'grid' ou 'list'
    const [columnFilters, setColumnFilters] = useState({});
    const [viewDevice, setViewDevice] = useState(null);
    const [showAddModal, setShowAddModal] = useState(false);
    const [editDevice, setEditDevice] = useState(null);
    const [activeTab, setActiveTab] = useState('info');
    const [showArchivesModal, setShowArchivesModal] = useState(false);
    const [archivedDevices, setArchivedDevices] = useState([]);
    const [viewArchivedDevice, setViewArchivedDevice] = useState(null);
    const [archivedDeviceReports, setArchivedDeviceReports] = useState({ inspection: [], bc: [] });
    const [deleteArchivedConfirm, setDeleteArchivedConfirm] = useState(null);
    const [archiveSearch, setArchiveSearch] = useState('');
    const [archiveDateFrom, setArchiveDateFrom] = useState('');
    const [archiveDateTo, setArchiveDateTo] = useState('');
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [reports, setReports] = useState([]);
    const [controlReports, setControlReports] = useState([]);
    const [showAddReportModal, setShowAddReportModal] = useState(false);
    const [showAddBCModal, setShowAddBCModal] = useState(false);
    const [viewReport, setViewReport] = useState(null);
    const [viewBCReport, setViewBCReport] = useState(null);
    const [editBCReport, setEditBCReport] = useState(null);
    const [bcReserveItems, setBcReserveItems] = useState([]);
    const [deleteReportConfirm, setDeleteReportConfirm] = useState(null);
    const [devicePhotos, setDevicePhotos] = useState([]);
    const [checkpoints, setCheckpoints] = useState([]);
    const [showAddCheckpointModal, setShowAddCheckpointModal] = useState(false);
    const [editCheckpoint, setEditCheckpoint] = useState(null);
    const [checkpointSections] = useState(['machinerie', 'local_poulies', 'gaine', 'toit_cabine', 'portes_palieres', 'cuvette', 'cabine', 'suspension', 'jeux', 'securites', 'essais']);
    const [bcPdfFile, setBcPdfFile] = useState(null);
    const [bcPhotos, setBcPhotos] = useState([]);
    const [deviceInitialDocs, setDeviceInitialDocs] = useState([]);
    const [bcFormStatus, setBcFormStatus] = useState('en_attente');
    const [bcFormReserves, setBcFormReserves] = useState([]);
    
    // v5.8 - États sélection multiple
    const [selectedItems, setSelectedItems] = useState([]);
    const [contextMenu, setContextMenu] = useState({ show: false, x: 0, y: 0, item: null });
    
    // Colonnes redimensionnables pour la vue liste
    const devicesColumns = useMemo(() => [
        { key: 'checkbox', label: '', width: 50 },
        { key: 'device_number', label: 'N° Appareil', width: 130 },
        { key: 'site_name', label: 'Site', width: 180 },
        { key: 'address_city', label: 'Ville', width: 120 },
        { key: 'elevator_type', label: 'Type', width: 130 },
        { key: 'levels_count', label: 'Niveaux', width: 80 },
        { key: 'status', label: 'Statut', width: 120 },
        { key: 'planning', label: 'Planification', width: 150 }
    ], []);
    
    const { columns: resizableCols, getColumnProps, resetColumns } = useResizableColumns('devices-table', devicesColumns);
    
    // Checkpoints prédéfinis basés sur le rapport COPREC
    const defaultCheckpoints = [
        // ===== MACHINERIE =====
        { section: 'machinerie', checkpoint_code: 'MAC-01', checkpoint_label: 'Documentation machinerie', checkpoint_detail: 'Plan, schémas électriques, attestation des composants' },
        { section: 'machinerie', checkpoint_code: 'MAC-02', checkpoint_label: 'Porte local et serrure', checkpoint_detail: 'Fermeture, verrouillage' },
        { section: 'machinerie', checkpoint_code: 'MAC-03', checkpoint_label: 'Éclairage machinerie', checkpoint_detail: '200 lux minimum' },
        { section: 'machinerie', checkpoint_code: 'MAC-04', checkpoint_label: 'Éclairage de sécurité', checkpoint_detail: 'Fonctionnement' },
        { section: 'machinerie', checkpoint_code: 'MAC-05', checkpoint_label: 'Tableau d\'alimentation', checkpoint_detail: 'Interrupteur de force, disjoncteurs éclairage et PC' },
        { section: 'machinerie', checkpoint_code: 'MAC-06', checkpoint_label: 'Câblage', checkpoint_detail: 'Alimentation, téléphone, U36' },
        { section: 'machinerie', checkpoint_code: 'MAC-07', checkpoint_label: 'Ventilation', checkpoint_detail: 'Fonctionnement' },
        { section: 'machinerie', checkpoint_code: 'MAC-08', checkpoint_label: 'Thermostat', checkpoint_detail: 'Température ambiante en machinerie' },
        { section: 'machinerie', checkpoint_code: 'MAC-09', checkpoint_label: 'Signalisation de sécurité', checkpoint_detail: 'Pancarte porte, manœuvre de dépannage' },
        { section: 'machinerie', checkpoint_code: 'MAC-10', checkpoint_label: 'Accessoires de levage', checkpoint_detail: 'Estampillé' },
        { section: 'machinerie', checkpoint_code: 'MAC-11', checkpoint_label: 'Matériel étranger', checkpoint_detail: 'Absence de matériel, protection' },
        { section: 'machinerie', checkpoint_code: 'MAC-12', checkpoint_label: 'Machine de traction', checkpoint_detail: 'État général, fixation, niveau d\'huile' },
        { section: 'machinerie', checkpoint_code: 'MAC-13', checkpoint_label: 'Frein', checkpoint_detail: 'Fonctionnement, usure des garnitures' },
        { section: 'machinerie', checkpoint_code: 'MAC-14', checkpoint_label: 'Limiteur de vitesse', checkpoint_detail: 'Plombage, fonctionnement, type CE' },
        { section: 'machinerie', checkpoint_code: 'MAC-15', checkpoint_label: 'Poulie de traction', checkpoint_detail: 'Usure des gorges' },
        
        // ===== LOCAL POULIES =====
        { section: 'local_poulies', checkpoint_code: 'POU-01', checkpoint_label: 'Porte et serrure', checkpoint_detail: 'Fermeture, verrouillage' },
        { section: 'local_poulies', checkpoint_code: 'POU-02', checkpoint_label: 'Éclairage', checkpoint_detail: 'Fonctionnement' },
        { section: 'local_poulies', checkpoint_code: 'POU-03', checkpoint_label: 'Prise de courant', checkpoint_detail: 'Présente et fonctionnelle' },
        { section: 'local_poulies', checkpoint_code: 'POU-04', checkpoint_label: 'Stop', checkpoint_detail: 'Bouton d\'arrêt d\'urgence' },
        
        // ===== GAINE =====
        { section: 'gaine', checkpoint_code: 'GAI-01', checkpoint_label: 'Fermeture de la gaine', checkpoint_detail: 'Étanchéité, protection' },
        { section: 'gaine', checkpoint_code: 'GAI-02', checkpoint_label: 'Ventilation haute', checkpoint_detail: 'Fonctionnement' },
        { section: 'gaine', checkpoint_code: 'GAI-03', checkpoint_label: 'Vitrage gaine', checkpoint_detail: 'Type feuilleté' },
        { section: 'gaine', checkpoint_code: 'GAI-04', checkpoint_label: 'Réserves supérieures', checkpoint_detail: 'Norme EN81-21, toit-plafond, réserve amortisseur' },
        { section: 'gaine', checkpoint_code: 'GAI-05', checkpoint_label: 'Éclairage de la gaine', checkpoint_detail: 'Lampe selon plan, éclairement 50 lux sur toit' },
        { section: 'gaine', checkpoint_code: 'GAI-06', checkpoint_label: 'Guides cabine', checkpoint_detail: 'Attaches conformes au plan, coulisseaux' },
        { section: 'gaine', checkpoint_code: 'GAI-07', checkpoint_label: 'Guides contrepoids', checkpoint_detail: 'Alignement, fixation' },
        
        // ===== TOIT DE CABINE =====
        { section: 'toit_cabine', checkpoint_code: 'TOI-01', checkpoint_label: 'Manœuvre d\'inspection', checkpoint_detail: 'Fonctionnement' },
        { section: 'toit_cabine', checkpoint_code: 'TOI-02', checkpoint_label: 'Balustrade', checkpoint_detail: '0.7m si distance <0.5m, 1.1m si >0.5m' },
        { section: 'toit_cabine', checkpoint_code: 'TOI-03', checkpoint_label: 'Fin de course inspection', checkpoint_detail: 'Fonctionnement' },
        { section: 'toit_cabine', checkpoint_code: 'TOI-04', checkpoint_label: 'Stop sur toit', checkpoint_detail: 'Bouton d\'arrêt d\'urgence' },
        { section: 'toit_cabine', checkpoint_code: 'TOI-05', checkpoint_label: 'Contact mou de câble ou parachute', checkpoint_detail: 'Fonctionnement' },
        { section: 'toit_cabine', checkpoint_code: 'TOI-06', checkpoint_label: 'Prise de courant', checkpoint_detail: 'Présente et fonctionnelle' },
        { section: 'toit_cabine', checkpoint_code: 'TOI-07', checkpoint_label: 'Alarme sur toit', checkpoint_detail: 'Fonctionnement' },
        { section: 'toit_cabine', checkpoint_code: 'TOI-08', checkpoint_label: 'Éclairage secours', checkpoint_detail: '5 lux/h' },
        { section: 'toit_cabine', checkpoint_code: 'TOI-09', checkpoint_label: 'Signalisation de sécurité', checkpoint_detail: 'Réserve réduite' },
        
        // ===== PORTES PALIÈRES =====
        { section: 'portes_palieres', checkpoint_code: 'PAL-01', checkpoint_label: 'Portes palières', checkpoint_detail: 'État général, alignement' },
        { section: 'portes_palieres', checkpoint_code: 'PAL-02', checkpoint_label: 'Vitrage', checkpoint_detail: 'Type et état' },
        { section: 'portes_palieres', checkpoint_code: 'PAL-03', checkpoint_label: 'Boutons d\'appel', checkpoint_detail: 'Conforme EN81-70' },
        { section: 'portes_palieres', checkpoint_code: 'PAL-04', checkpoint_label: 'Serrures des portes', checkpoint_detail: 'Fonctionnement, engagement pênes' },
        { section: 'portes_palieres', checkpoint_code: 'PAL-05', checkpoint_label: 'Mise à la terre', checkpoint_detail: 'Continuité' },
        { section: 'portes_palieres', checkpoint_code: 'PAL-06', checkpoint_label: 'Fonctionnement réglage', checkpoint_detail: 'Vitesse, force de fermeture' },
        
        // ===== CUVETTE =====
        { section: 'cuvette', checkpoint_code: 'CUV-01', checkpoint_label: 'Profondeur', checkpoint_detail: 'Conforme au plan' },
        { section: 'cuvette', checkpoint_code: 'CUV-02', checkpoint_label: 'Éclairage', checkpoint_detail: 'Selon plan de gaine avec 50 lux' },
        { section: 'cuvette', checkpoint_code: 'CUV-03', checkpoint_label: 'Interrupteur stop', checkpoint_detail: 'Accessible' },
        { section: 'cuvette', checkpoint_code: 'CUV-04', checkpoint_label: 'Échelle d\'accès', checkpoint_detail: 'Présente et conforme' },
        { section: 'cuvette', checkpoint_code: 'CUV-05', checkpoint_label: 'Amortisseurs cabine', checkpoint_detail: 'Nombre et modèle conformes, type CE' },
        { section: 'cuvette', checkpoint_code: 'CUV-06', checkpoint_label: 'Amortisseurs contrepoids', checkpoint_detail: 'Nombre et modèle conformes, type CE' },
        { section: 'cuvette', checkpoint_code: 'CUV-07', checkpoint_label: 'Prise de courant', checkpoint_detail: 'À la terre' },
        { section: 'cuvette', checkpoint_code: 'CUV-08', checkpoint_label: 'Réserve sous cabine', checkpoint_detail: 'Mesure conforme' },
        { section: 'cuvette', checkpoint_code: 'CUV-09', checkpoint_label: 'Poulie tendeuse', checkpoint_detail: 'Correctement installée, contact de sécurité' },
        
        // ===== CABINE =====
        { section: 'cabine', checkpoint_code: 'CAB-01', checkpoint_label: 'Porte de cabine', checkpoint_detail: 'Contact de heurt' },
        { section: 'cabine', checkpoint_code: 'CAB-02', checkpoint_label: 'Éclairage normal', checkpoint_detail: '100 lux minimum' },
        { section: 'cabine', checkpoint_code: 'CAB-03', checkpoint_label: 'Éclairage de secours', checkpoint_detail: '5 lux/h' },
        { section: 'cabine', checkpoint_code: 'CAB-04', checkpoint_label: 'Verrouillage porte cabine', checkpoint_detail: 'Fonctionnement' },
        { section: 'cabine', checkpoint_code: 'CAB-05', checkpoint_label: 'Boîtes à boutons', checkpoint_detail: 'État et fonctionnement' },
        { section: 'cabine', checkpoint_code: 'CAB-06', checkpoint_label: 'Main courante', checkpoint_detail: 'Dessus à 90 cm ±25mm' },
        { section: 'cabine', checkpoint_code: 'CAB-07', checkpoint_label: 'Revêtement', checkpoint_detail: 'Parois, sol, vitrage marqué' },
        { section: 'cabine', checkpoint_code: 'CAB-08', checkpoint_label: 'Alarme en cabine', checkpoint_detail: 'Conformité EN81-28, fonctionnement' },
        { section: 'cabine', checkpoint_code: 'CAB-09', checkpoint_label: 'Pictogrammes alarme', checkpoint_detail: 'Jaune (émission), vert (réception)' },
        { section: 'cabine', checkpoint_code: 'CAB-10', checkpoint_label: 'Téléphone', checkpoint_detail: 'Fonctionnement, communication' },
        { section: 'cabine', checkpoint_code: 'CAB-11', checkpoint_label: 'Garde pieds cabine', checkpoint_detail: 'Type fixe/rétractable, essais si rétractable' },
        { section: 'cabine', checkpoint_code: 'CAB-12', checkpoint_label: 'Indicateur de position', checkpoint_detail: 'Affichage correct' },
        { section: 'cabine', checkpoint_code: 'CAB-13', checkpoint_label: 'Ventilation', checkpoint_detail: 'Fonctionnement' },
        
        // ===== SUSPENSION =====
        { section: 'suspension', checkpoint_code: 'SUS-01', checkpoint_label: 'Câbles', checkpoint_detail: 'Nombre, diamètre, état, usure' },
        { section: 'suspension', checkpoint_code: 'SUS-02', checkpoint_label: 'Attaches', checkpoint_detail: 'État et serrage' },
        { section: 'suspension', checkpoint_code: 'SUS-03', checkpoint_label: 'Garde câbles', checkpoint_detail: 'Présents et conformes' },
        { section: 'suspension', checkpoint_code: 'SUS-04', checkpoint_label: 'Protection points rentrants', checkpoint_detail: 'Présente' },
        
        // ===== JEUX =====
        { section: 'jeux', checkpoint_code: 'JEU-01', checkpoint_label: 'Jeu seuil-seuil', checkpoint_detail: '35 mm maxi' },
        { section: 'jeux', checkpoint_code: 'JEU-02', checkpoint_label: 'Parois gaine côté cabine', checkpoint_detail: '<150mm, CP>50' },
        
        // ===== SÉCURITÉS =====
        { section: 'securites', checkpoint_code: 'SEC-01', checkpoint_label: 'Parachute cabine', checkpoint_detail: 'Type CE, fonctionnement' },
        { section: 'securites', checkpoint_code: 'SEC-02', checkpoint_label: 'Parachute contrepoids', checkpoint_detail: 'Type CE si présent' },
        { section: 'securites', checkpoint_code: 'SEC-03', checkpoint_label: 'Limiteur cabine', checkpoint_detail: 'Type CE' },
        { section: 'securites', checkpoint_code: 'SEC-04', checkpoint_label: 'Limiteur contrepoids', checkpoint_detail: 'Type CE si présent' },
        
        // ===== ESSAIS =====
        { section: 'essais', checkpoint_code: 'ESS-01', checkpoint_label: 'Hors course haut', checkpoint_detail: 'Fonctionnement fin de course' },
        { section: 'essais', checkpoint_code: 'ESS-02', checkpoint_label: 'Hors course bas', checkpoint_detail: 'Fonctionnement fin de course' },
        { section: 'essais', checkpoint_code: 'ESS-03', checkpoint_label: 'Parachute en charge 125%', checkpoint_detail: 'Vitesse réduite, contact enclenché, cabine de niveau' },
        { section: 'essais', checkpoint_code: 'ESS-04', checkpoint_label: 'Masse d\'une serrure', checkpoint_detail: 'Déclenchement du fusible ou disjoncteur' },
        { section: 'essais', checkpoint_code: 'ESS-05', checkpoint_label: 'Freinage', checkpoint_detail: 'Essai de freinage' },
        { section: 'essais', checkpoint_code: 'ESS-06', checkpoint_label: 'Surcharge', checkpoint_detail: 'Fonctionnement dispositif' },
        { section: 'essais', checkpoint_code: 'ESS-07', checkpoint_label: 'A3', checkpoint_detail: 'Essai A3' },
        { section: 'essais', checkpoint_code: 'ESS-08', checkpoint_label: 'Désincarcération', checkpoint_detail: 'Auto et manuelle' },
        { section: 'essais', checkpoint_code: 'ESS-09', checkpoint_label: 'Nivelage', checkpoint_detail: 'Précision aux différents niveaux' },
        { section: 'essais', checkpoint_code: 'ESS-10', checkpoint_label: 'Vitesse nominale', checkpoint_detail: 'Mesure montée et descente' },
        { section: 'essais', checkpoint_code: 'ESS-11', checkpoint_label: 'Bruit et vibrations', checkpoint_detail: 'Niveau acceptable' },
        { section: 'essais', checkpoint_code: 'ESS-12', checkpoint_label: 'Rénivelage', checkpoint_detail: 'Fonctionnement si équipé' }
    ];
    
    // Fonction pour charger les checkpoints prédéfinis
    const loadDefaultCheckpoints = async () => {
        if (!viewReport) return;
        try {
            // Insérer tous les checkpoints prédéfinis
            for (const cp of defaultCheckpoints) {
                await db.from('inspection_checkpoints').insert({
                    report_id: viewReport.id,
                    section: cp.section,
                    checkpoint_code: cp.checkpoint_code,
                    checkpoint_label: cp.checkpoint_label,
                    checkpoint_detail: cp.checkpoint_detail,
                    status: null // Non évalué par défaut
                });
            }
            // Recharger les checkpoints
            const { data } = await db.from('inspection_checkpoints').select('*').eq('report_id', viewReport.id).order('section').order('checkpoint_code');
            setCheckpoints(data || []);
            showToast(`${defaultCheckpoints.length} points de contrôle ajoutés`, 'success');
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    // Helper pour parser les URLs de photos BC
    const getBcPhotoUrls = (report) => {
        if (!report?.photo_urls) return [];
        try {
            return JSON.parse(report.photo_urls);
        } catch (e) {
            return [];
        }
    };
    
    const isAdmin = user?.role === 'admin';
    const canEdit = isAdmin || user?.role === 'technicien';
    
    const devices = data.devices || [];
    const statuses = ['non_commence', 'monte', 'mes_ok_sans_reserves', 'mes_ok_avec_reserves', 'levee_reserves', 'termine'];
    const statusCounts = useMemo(() => {
        const counts = { all: devices.length };
        statuses.forEach(s => counts[s] = devices.filter(d => d.status === s).length);
        return counts;
    }, [devices]);
    
    const filtered = useMemo(() => devices.filter(d => {
        // Filtre par statut (boutons)
        if (status && d.status !== status) return false;
        // Filtres de colonnes
        if (columnFilters.device_number && !d.device_number?.toLowerCase().includes(columnFilters.device_number.toLowerCase())) return false;
        if (columnFilters.site_name && !d.site_name?.toLowerCase().includes(columnFilters.site_name.toLowerCase())) return false;
        if (columnFilters.address_city && !d.address_city?.toLowerCase().includes(columnFilters.address_city.toLowerCase())) return false;
        if (columnFilters.elevator_type && d.elevator_type !== columnFilters.elevator_type) return false;
        if (columnFilters.status && d.status !== columnFilters.status) return false;
        return true;
    }), [devices, status, columnFilters]);
    
    useEffect(() => {
        if (viewDevice) {
            db.from('inspection_reports').select('*').eq('device_id', viewDevice.id).order('created_at', { ascending: false }).then(({ data }) => setReports(data || []));
            db.from('control_reports').select('*').eq('device_id', viewDevice.id).order('created_at', { ascending: false }).then(({ data }) => setControlReports(data || []));
            db.from('device_photos').select('*').eq('device_id', viewDevice.id).order('created_at', { ascending: false }).then(({ data }) => setDevicePhotos(data || []));
        }
    }, [viewDevice]);
    
    useEffect(() => { if (showArchivesModal) { db.from('archived_commissioning_devices').select('*').order('archived_at', { ascending: false }).then(({ data }) => setArchivedDevices(data || [])); } }, [showArchivesModal]);
    
    // Charger les rapports quand on ouvre la vue d'un appareil archivé
    useEffect(() => {
        if (viewArchivedDevice?.original_device_id) {
            const deviceId = viewArchivedDevice.original_device_id;
            Promise.all([
                db.from('inspection_reports').select('*').eq('device_id', deviceId).order('created_at', { ascending: false }),
                db.from('bc_reports').select('*').eq('device_id', deviceId).order('created_at', { ascending: false })
            ]).then(([inspRes, bcRes]) => {
                setArchivedDeviceReports({
                    inspection: inspRes.data || [],
                    bc: bcRes.data || []
                });
            });
        } else {
            setArchivedDeviceReports({ inspection: [], bc: [] });
        }
    }, [viewArchivedDevice]);
    
    const saveDevice = async (e) => {
        e.preventDefault();
        const form = e.target;
        const deviceData = {
            device_number: form.device_number.value,
            site_name: form.site_name.value,
            address_street: form.address_street.value,
            address_city: form.address_city.value,
            address_zip: form.address_zip?.value || '',
            load_capacity: form.load_capacity.value,
            speed: form.speed.value,
            course: form.course.value,
            levels_count: parseInt(form.levels_count.value) || 0,
            levels_served: parseInt(form.levels_served.value) || 0,
            access_count: parseInt(form.access_count.value) || 1,
            elevator_type: form.elevator_type.value,
            building_type: form.building_type.value === 'autre' ? (form.building_type_other?.value || 'autre') : form.building_type.value,
            cabin_dimensions: form.cabin_dimensions.value,
            pit_depth: form.pit_depth.value,
            headroom: form.headroom?.value || '',
            manufacturer: form.manufacturer?.value || '',
            model: form.model?.value || '',
            installation_year: form.installation_year?.value || '',
            cables_count: parseInt(form.cables_count?.value) || null,
            cables_diameter: form.cables_diameter?.value || '',
            suspension_ratio: form.suspension_ratio?.value || '',
            buffer_cabin_count: parseInt(form.buffer_cabin_count?.value) || null,
            buffer_cabin_type: form.buffer_cabin_type?.value || '',
            buffer_counterweight_count: parseInt(form.buffer_counterweight_count?.value) || null,
            buffer_counterweight_type: form.buffer_counterweight_type?.value || '',
            lock_type: form.lock_type?.value || '',
            notes: form.notes?.value || '',
            status: editDevice?.status || 'non_commence'
        };
        try {
            showToast('Enregistrement en cours...', 'info');
            let deviceId;
            
            if (editDevice) { 
                await db.from('commissioning_devices').update(deviceData).eq('id', editDevice.id); 
                deviceId = editDevice.id;
                showToast('Appareil mis à jour', 'success'); 
            } else { 
                const { data: newDevice } = await db.from('commissioning_devices').insert({ ...deviceData, created_by: user?.id }).select().single(); 
                deviceId = newDevice.id;
                showToast('Appareil ajouté', 'success');
                
                // Notifier tous les techniciens d'un nouvel appareil MES
                const techniciens = data.users.filter(u => (u.role === 'admin' || u.role === 'technicien') && u.id !== user.id);
                techniciens.forEach(tech => {
                    createNotification({
                        userId: tech.id,
                        type: 'device_created',
                        title: 'Nouvel appareil MES',
                        body: `${deviceData.device_number} - ${deviceData.site_name || deviceData.address_city}`,
                        actionUrl: '/mes',
                    });
                });
            }
            
            // Upload documents PDF si présents
            if (deviceInitialDocs.length > 0 && deviceId) {
                for (let i = 0; i < deviceInitialDocs.length; i++) {
                    const doc = deviceInitialDocs[i];
                    const fileName = `device-doc-${deviceId}-${Date.now()}-${i}.pdf`;
                    const { error: uploadError } = await db.storage
                        .from('documents')
                        .upload(fileName, doc);
                    if (!uploadError) {
                        const { data: urlData } = db.storage.from('documents').getPublicUrl(fileName);
                        await db.from('device_documents').insert({
                            device_id: deviceId,
                            document_url: urlData.publicUrl,
                            document_name: doc.name,
                            uploaded_by: user?.id
                        });
                    }
                }
            }
            
            refresh(); 
            setShowAddModal(false); 
            setEditDevice(null);
            setDeviceInitialDocs([]);
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const updateDeviceStatus = async (id, newStatus) => { try { await db.from('commissioning_devices').update({ status: newStatus }).eq('id', id); showToast('Statut mis à jour', 'success'); refresh(); if (viewDevice) setViewDevice({ ...viewDevice, status: newStatus }); } catch (err) { showToast('Erreur: ' + err.message, 'error'); } };
    
    const deleteDevice = async (id) => { try { await db.from('commissioning_devices').delete().eq('id', id); showToast('Appareil supprimé', 'success'); refresh(); setViewDevice(null); setDeleteConfirm(null); } catch (err) { showToast('Erreur: ' + err.message, 'error'); } };
    
    const deleteArchivedDevice = async (id) => {
        try {
            await db.from('archived_commissioning_devices').delete().eq('id', id);
            showToast('Archive supprimée', 'success');
            setArchivedDevices(archivedDevices.filter(d => d.id !== id));
            setViewArchivedDevice(null);
            setDeleteArchivedConfirm(null);
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    // Filtrer les appareils archivés
    const filteredArchivedDevices = useMemo(() => {
        return archivedDevices.filter(d => {
            // Filtre recherche
            if (archiveSearch) {
                const search = archiveSearch.toLowerCase();
                const matchSearch = 
                    (d.device_number || '').toLowerCase().includes(search) ||
                    (d.site_name || '').toLowerCase().includes(search) ||
                    (d.address_city || '').toLowerCase().includes(search) ||
                    (d.address_street || '').toLowerCase().includes(search);
                if (!matchSearch) return false;
            }
            // Filtre date début
            if (archiveDateFrom) {
                const fromDate = new Date(archiveDateFrom);
                const archivedDate = new Date(d.archived_at);
                if (archivedDate < fromDate) return false;
            }
            // Filtre date fin
            if (archiveDateTo) {
                const toDate = new Date(archiveDateTo);
                toDate.setHours(23, 59, 59, 999);
                const archivedDate = new Date(d.archived_at);
                if (archivedDate > toDate) return false;
            }
            return true;
        });
    }, [archivedDevices, archiveSearch, archiveDateFrom, archiveDateTo]);
    
    // Export PDF des archives
    const exportArchivedDevicesPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Construire le sous-titre
        let subtitle = `${filteredArchivedDevices.length} appareil(s)`;
        if (archiveDateFrom || archiveDateTo) {
            subtitle += ' • ';
            if (archiveDateFrom) subtitle += `Du ${formatDate(archiveDateFrom)}`;
            if (archiveDateFrom && archiveDateTo) subtitle += ' ';
            if (archiveDateTo) subtitle += `Au ${formatDate(archiveDateTo)}`;
        }
        
        // En-tête avec logo
        let y = drawPDFHeader(doc, 'APPAREILS ARCHIVÉS', subtitle);
        
        doc.setTextColor(0, 0, 0);
        
        // En-tête du tableau
        doc.setFillColor(240, 240, 240);
        doc.rect(10, y - 5, 190, 10, 'F');
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.text('N° Appareil', 12, y);
        doc.text('Site', 50, y);
        doc.text('Ville', 110, y);
        doc.text('Date archivage', 155, y);
        y += 12;
        
        doc.setFont(undefined, 'normal');
        filteredArchivedDevices.forEach((d, i) => {
            if (y > 280) {
                doc.addPage();
                y = 20;
                // Réajouter l'en-tête du tableau
                doc.setFillColor(240, 240, 240);
                doc.rect(10, y - 5, 190, 10, 'F');
                doc.setFont(undefined, 'bold');
                doc.text('N° Appareil', 12, y);
                doc.text('Site', 50, y);
                doc.text('Ville', 110, y);
                doc.text('Date archivage', 155, y);
                y += 12;
                doc.setFont(undefined, 'normal');
            }
            
            if (i % 2 === 0) {
                doc.setFillColor(250, 250, 250);
                doc.rect(10, y - 4, 190, 8, 'F');
            }
            
            doc.setFontSize(8);
            doc.text((d.device_number || '-').substring(0, 20), 12, y);
            doc.text((d.site_name || '-').substring(0, 35), 50, y);
            doc.text((d.address_city || '-').substring(0, 25), 110, y);
            doc.text(formatDate(d.archived_at), 155, y);
            y += 8;
        });
        
        // Pied de page
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text(`Page ${i}/${pageCount}`, 105, 290, { align: 'center' });
        }
        
        doc.save(`appareils-archives-${new Date().toISOString().split('T')[0]}.pdf`);
        showToast('PDF exporté', 'success');
    };
    
    const archiveDevice = async (device) => {
        try {
            // Préparer les données d'archivage avec seulement les colonnes qui existent
            const archiveData = {
                original_device_id: device.id,
                device_number: device.device_number,
                site_name: device.site_name,
                address_street: device.address_street,
                address_city: device.address_city,
                address_postal: device.address_zip || device.address_postal,
                contact_name: device.contact_name,
                contact_phone: device.contact_phone,
                contact_email: device.contact_email,
                status: device.status,
                notes: device.notes,
                reserves: device.reserves,
                // Caractéristiques techniques
                manufacturer: device.manufacturer,
                mp_manufacturer: device.mp_manufacturer,
                model: device.model,
                elevator_type: device.elevator_type,
                building_type: device.building_type,
                building_type_other: device.building_type_other,
                load_capacity: device.load_capacity,
                speed: device.speed,
                course: device.course,
                levels_count: device.levels_count,
                pit_depth: device.pit_depth,
                headroom: device.headroom,
                cabin_dimensions: device.cabin_dimensions,
                cables_count: device.cables_count,
                cables_diameter: device.cables_diameter,
                suspension_ratio: device.suspension_ratio,
                dampers_free: device.dampers_free,
                locks_free: device.locks_free,
                ce_number: device.ce_number,
                ce_date: device.ce_date,
                installation_date: device.installation_date,
                created_at: device.created_at,
                updated_at: device.updated_at,
                archived_at: new Date().toISOString()
            };
            
            const { error: insertError } = await db.from('archived_commissioning_devices').insert(archiveData);
            
            if (insertError) {
                console.error('Erreur archivage MES:', insertError);
                showToast('Erreur archivage: ' + insertError.message, 'error');
                return;
            }
            
            await db.from('commissioning_devices').delete().eq('id', device.id);
            showToast('Appareil archivé', 'success'); 
            refresh(); 
            setViewDevice(null);
            
            // Recharger les archives si le modal est ouvert
            if (showArchivesModal) {
                const { data } = await db.from('archived_commissioning_devices').select('*').order('archived_at', { ascending: false });
                setArchivedDevices(data || []);
            }
        } catch (err) { 
            console.error('Erreur archivage MES:', err);
            showToast('Erreur: ' + err.message, 'error'); 
        }
    };
    
    const saveReport = async (e) => {
        e.preventDefault();
        const form = e.target;
        const reportData = {
            device_id: viewDevice.id,
            report_number: form.report_number.value || `RAP-${Date.now()}`,
            report_type: form.report_type.value,
            status: 'brouillon',
            inspector_name: form.inspector_name?.value || user?.full_name || '',
            inspector_id: user?.id,
            inspection_date: form.inspection_date.value || new Date().toISOString().split('T')[0],
            general_remarks: form.general_remarks.value || null,
            reserves: form.reserves?.value || null,
            // Mesures de vitesse
            speed_empty_up: form.speed_empty_up?.value || null,
            speed_empty_down: form.speed_empty_down?.value || null,
            speed_half_up: form.speed_half_up?.value || null,
            speed_half_down: form.speed_half_down?.value || null,
            speed_full_up: form.speed_full_up?.value || null,
            speed_full_down: form.speed_full_down?.value || null,
            // Mesures d'ampérage (montée/descente)
            amp_empty_up: form.amp_empty_up?.value || null,
            amp_empty_down: form.amp_empty_down?.value || null,
            amp_half_up: form.amp_half_up?.value || null,
            amp_half_down: form.amp_half_down?.value || null,
            amp_full_up: form.amp_full_up?.value || null,
            amp_full_down: form.amp_full_down?.value || null
        };
        try {
            const { data: newReport } = await db.from('inspection_reports').insert(reportData).select().single();
            showToast('Rapport créé', 'success');
            
            // Notifier les admins d'un nouveau rapport
            const admins = data.users.filter(u => u.role === 'admin' && u.id !== user.id);
            admins.forEach(admin => {
                createNotification({
                    userId: admin.id,
                    type: 'inspection_report_created',
                    title: 'Nouveau rapport d\'inspection',
                    body: `${viewDevice.device_number} - ${reportData.report_type}`,
                    actionUrl: '/mes',
                });
            });
            
            setShowAddReportModal(false);
            db.from('inspection_reports').select('*').eq('device_id', viewDevice.id).order('created_at', { ascending: false }).then(({ data }) => setReports(data || []));
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const updateReportStatus = async (reportId, newStatus) => {
        try {
            await db.from('inspection_reports').update({ status: newStatus }).eq('id', reportId);
            showToast('Statut du rapport mis à jour', 'success');
            
            // Notifier si conforme/non conforme
            if (newStatus === 'conforme' || newStatus === 'non_conforme') {
                const admins = data.users.filter(u => u.role === 'admin' && u.id !== user.id);
                admins.forEach(admin => {
                    createNotification({
                        userId: admin.id,
                        type: newStatus === 'conforme' ? 'inspection_report_validated' : 'inspection_report_created',
                        title: `Inspection ${newStatus === 'conforme' ? 'conforme' : 'non conforme'}`,
                        body: `${viewDevice?.device_number || 'Appareil'} - Rapport ${newStatus === 'conforme' ? '✅' : '❌'}`,
                        actionUrl: '/mes',
                    });
                });
            }
            
            db.from('inspection_reports').select('*').eq('device_id', viewDevice.id).then(({ data }) => setReports(data || []));
            setViewReport(null);
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const deleteReport = async (id) => {
        try {
            await db.from('inspection_reports').delete().eq('id', id);
            showToast('Rapport supprimé', 'success');
            db.from('inspection_reports').select('*').eq('device_id', viewDevice.id).then(({ data }) => setReports(data || []));
            setViewReport(null); setDeleteReportConfirm(null);
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    // Export PDF du rapport d'inspection - Version compacte
    const exportInspectionReportPDF = async (report, device, checkpointsList, reportPhotos = []) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Helper pour ajouter des images
        const addImageToPDF = async (url, x, y, maxWidth, maxHeight) => {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ratio = Math.min(maxWidth / img.width, maxHeight / img.height);
                        canvas.width = img.width * ratio;
                        canvas.height = img.height * ratio;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        doc.addImage(dataUrl, 'JPEG', x, y, canvas.width * 0.264583, canvas.height * 0.264583);
                        resolve(canvas.height * 0.264583);
                    } catch (e) {
                        console.error('Erreur image:', e);
                        resolve(0);
                    }
                };
                img.onerror = () => resolve(0);
                img.src = url;
            });
        };
        
        // En-tête avec logo
        const subtitle = `${report.report_number || 'Rapport #' + report.id} - Appareil: ${device?.device_number || '-'} - ${device?.site_name || ''}`;
        let y = drawPDFHeader(doc, 'RAPPORT D\'INSPECTION AVANT MES', subtitle);
        
        doc.setTextColor(0, 0, 0);
        
        // ===== ADRESSE + CARACTÉRISTIQUES (2 colonnes) =====
        doc.setFontSize(8);
        doc.setFont(undefined, 'bold');
        doc.setFillColor(240, 240, 240);
        doc.rect(10, y - 4, 95, 6, 'F');
        doc.text('ADRESSE', 12, y);
        doc.rect(105, y - 4, 95, 6, 'F');
        doc.text('CARACTÉRISTIQUES', 107, y);
        y += 8;
        
        doc.setFontSize(7);
        doc.setFont(undefined, 'normal');
        
        // Colonne gauche - Adresse
        const leftInfos = [
            `Site: ${device?.site_name || '-'}`,
            `Adresse: ${device?.address_street || ''} ${device?.address_zip || ''} ${device?.address_city || ''}`.substring(0, 50),
            `N° appareil: ${device?.device_number || '-'}`,
            `Type: ${device?.elevator_type === 'electrique_equilibre' ? 'Élec. équilibré' : device?.elevator_type === 'hydraulique' ? 'Hydraulique' : device?.elevator_type || '-'}`,
            `Bâtiment: ${device?.building_type === 'habitation' ? 'Habitation' : device?.building_type === 'erp' ? 'ERP' : device?.building_type || '-'}`
        ];
        
        // Colonne droite - Caractéristiques
        const rightInfos = [
            `Charge: ${device?.load_capacity || '-'} kg | Vitesse: ${device?.speed || '-'} m/s`,
            `Course: ${device?.course || '-'} m | Niveaux: ${device?.levels_count || '-'}`,
            `Cabine: ${device?.cabin_dimensions || '-'} | Cuvette: ${device?.pit_depth || '-'} m`,
            `Fabricant: ${device?.manufacturer || '-'} | Modèle: ${device?.model || '-'}`,
            `Câbles: ${device?.cables_count || '-'} x ${device?.cables_diameter || '-'} mm | Mouflage: ${device?.suspension_ratio || '-'}`
        ];
        
        for (let i = 0; i < Math.max(leftInfos.length, rightInfos.length); i++) {
            if (leftInfos[i]) doc.text(leftInfos[i], 12, y);
            if (rightInfos[i]) doc.text(rightInfos[i], 107, y);
            y += 5;
        }
        y += 3;
        
        // ===== INFORMATIONS DU RAPPORT (ligne compacte) =====
        doc.setFillColor(240, 240, 240);
        doc.rect(10, y - 4, 190, 6, 'F');
        doc.setFont(undefined, 'bold');
        doc.setFontSize(8);
        doc.text('RAPPORT', 12, y);
        y += 7;
        
        doc.setFontSize(7);
        doc.setFont(undefined, 'normal');
        doc.text(`Type: ${report.report_type === 'mise_en_service' ? 'Mise en service' : 'Levée réserves'} | Date: ${formatDate(report.inspection_date)} | Inspecteur: ${report.inspector_name || '-'} | Statut: ${getReportStatusInfo(report.status).label}`, 12, y);
        y += 6;
        
        // ===== REMARQUES GÉNÉRALES (si présentes) =====
        if (report.general_remarks) {
            doc.setFillColor(255, 251, 235);
            doc.rect(10, y - 3, 190, 5, 'F');
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            doc.setTextColor(180, 83, 9);
            doc.text('REMARQUES:', 12, y);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            const remarkLines = doc.splitTextToSize(report.general_remarks, 180);
            y += 5;
            doc.text(remarkLines.slice(0, 3), 12, y);
            y += Math.min(remarkLines.length, 3) * 4 + 2;
        }
        
        // ===== RÉSERVES (si présentes) =====
        if (report.reserves && report.reserves.trim() !== '') {
            doc.setFillColor(254, 226, 226);
            doc.rect(10, y - 3, 190, 5, 'F');
            doc.setFont(undefined, 'bold');
            doc.setFontSize(7);
            doc.setTextColor(185, 28, 28);
            doc.text('RÉSERVES:', 12, y);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            const reserveLines = doc.splitTextToSize(report.reserves, 180);
            y += 5;
            doc.text(reserveLines.slice(0, 3), 12, y);
            y += Math.min(reserveLines.length, 3) * 4 + 2;
        }
        
        // ===== CHECKLIST =====
        if (checkpointsList && checkpointsList.length > 0) {
            if (y > 220) { doc.addPage(); y = 15; }
            
            doc.setFillColor(240, 240, 240);
            doc.rect(10, y - 4, 190, 6, 'F');
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            
            // Stats inline
            const conformes = checkpointsList.filter(c => c.status === 'C').length;
            const nonConformes = checkpointsList.filter(c => c.status === 'NC').length;
            const sansObjet = checkpointsList.filter(c => c.status === 'SO').length;
            doc.text(`CHECKLIST (${checkpointsList.length} pts) - C: ${conformes} | NC: ${nonConformes} | SO: ${sansObjet}`, 12, y);
            y += 7;
            
            // Grouper par section
            const sections = {};
            const sectionLabels = {
                'machinerie': 'MACH', 'local_poulies': 'POUL', 'gaine': 'GAINE', 'toit_cabine': 'TOIT',
                'portes_palieres': 'PORTES', 'cuvette': 'CUV', 'cabine': 'CAB', 'suspension': 'SUSP',
                'jeux': 'JEUX', 'securites': 'SECU', 'essais': 'ESSAIS'
            };
            
            checkpointsList.forEach(cp => {
                const section = cp.section || 'autre';
                if (!sections[section]) sections[section] = [];
                sections[section].push(cp);
            });
            
            // En-tête tableau compact
            doc.setFillColor(20, 184, 166);
            doc.rect(10, y - 3, 190, 5, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(6);
            doc.setFont(undefined, 'bold');
            doc.text('Section', 12, y);
            doc.text('Point de contrôle', 30, y);
            doc.text('C', 140, y);
            doc.text('NC', 150, y);
            doc.text('SO', 160, y);
            doc.text('Remarques', 170, y);
            y += 5;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(5.5);
            
            Object.keys(sections).forEach(sectionKey => {
                sections[sectionKey].forEach((cp, i) => {
                    if (y > 285) { doc.addPage(); y = 15; }
                    
                    if (i % 2 === 0) {
                        doc.setFillColor(250, 250, 250);
                        doc.rect(10, y - 3, 190, 4.5, 'F');
                    }
                    
                    // Section (première ligne seulement)
                    if (i === 0) {
                        doc.setFont(undefined, 'bold');
                        doc.text(sectionLabels[sectionKey] || sectionKey.substring(0, 5).toUpperCase(), 12, y);
                        doc.setFont(undefined, 'normal');
                    }
                    
                    // Nom du point
                    const label = cp.checkpoint_label || cp.checkpoint_code || '-';
                    doc.text(label.substring(0, 55), 30, y);
                    
                    // Cases à cocher (petites)
                    doc.rect(139, y - 2.5, 3.5, 3.5);
                    if (cp.status === 'C') {
                        doc.setFillColor(16, 185, 129);
                        doc.rect(139, y - 2.5, 3.5, 3.5, 'F');
                    }
                    
                    doc.rect(149, y - 2.5, 3.5, 3.5);
                    if (cp.status === 'NC') {
                        doc.setFillColor(239, 68, 68);
                        doc.rect(149, y - 2.5, 3.5, 3.5, 'F');
                    }
                    
                    doc.rect(159, y - 2.5, 3.5, 3.5);
                    if (cp.status === 'SO') {
                        doc.setFillColor(156, 163, 175);
                        doc.rect(159, y - 2.5, 3.5, 3.5, 'F');
                    }
                    
                    // Remarques
                    let remarksText = '';
                    if (cp.measurement) remarksText += cp.measurement;
                    if (cp.remarks) remarksText += (remarksText ? '-' : '') + cp.remarks;
                    if (remarksText) {
                        doc.text(remarksText.substring(0, 20), 170, y);
                    }
                    
                    y += 4.5;
                });
            });
            y += 3;
        }
        
        // ===== MESURES DE VITESSE ET INTENSITÉ (côte à côte) =====
        const hasSpeed = report.speed_empty_up || report.speed_empty_down || report.speed_half_up || report.speed_half_down || report.speed_full_up || report.speed_full_down;
        const hasAmp = report.amp_empty_up || report.amp_empty_down || report.amp_half_up || report.amp_half_down || report.amp_full_up || report.amp_full_down;
        
        if (hasSpeed || hasAmp) {
            if (y > 250) { doc.addPage(); y = 15; }
            
            doc.setFontSize(6);
            
            // Tableau Vitesse (gauche)
            if (hasSpeed) {
                doc.setFillColor(59, 130, 246);
                doc.rect(10, y - 3, 90, 5, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.text('VITESSE (m/s)', 12, y);
                doc.text('Montée', 55, y);
                doc.text('Descente', 75, y);
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                let vy = y + 5;
                [['À vide', report.speed_empty_up, report.speed_empty_down],
                 ['Mi-charge', report.speed_half_up, report.speed_half_down],
                 ['Pl. charge', report.speed_full_up, report.speed_full_down]].forEach(([label, up, down], i) => {
                    if (i % 2 === 0) { doc.setFillColor(239, 246, 255); doc.rect(10, vy - 3, 90, 4, 'F'); }
                    doc.text(label, 12, vy);
                    doc.text(up || '-', 60, vy);
                    doc.text(down || '-', 80, vy);
                    vy += 4;
                });
            }
            
            // Tableau Intensité (droite)
            if (hasAmp) {
                const ampX = hasSpeed ? 105 : 10;
                doc.setFillColor(245, 158, 11);
                doc.rect(ampX, y - 3, 90, 5, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.text('INTENSITÉ (A)', ampX + 2, y);
                doc.text('Montée', ampX + 45, y);
                doc.text('Descente', ampX + 65, y);
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                let ay = y + 5;
                [['À vide', report.amp_empty_up, report.amp_empty_down],
                 ['Mi-charge', report.amp_half_up, report.amp_half_down],
                 ['Pl. charge', report.amp_full_up, report.amp_full_down]].forEach(([label, up, down], i) => {
                    if (i % 2 === 0) { doc.setFillColor(254, 243, 199); doc.rect(ampX, ay - 3, 90, 4, 'F'); }
                    doc.text(label, ampX + 2, ay);
                    doc.text(up || '-', ampX + 50, ay);
                    doc.text(down || '-', ampX + 70, ay);
                    ay += 4;
                });
            }
            y += 18;
        }
        
        // ===== PHOTOS (seulement si présentes, pas de nouvelle page systématique) =====
        if (reportPhotos && reportPhotos.length > 0) {
            if (y > 200) { doc.addPage(); y = 15; }
            
            doc.setFillColor(240, 240, 240);
            doc.rect(10, y - 4, 190, 5, 'F');
            doc.setFontSize(7);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text(`PHOTOS (${reportPhotos.length})`, 12, y);
            y += 8;
            
            let photoX = 12;
            for (let i = 0; i < reportPhotos.length && i < 4; i++) {
                const photo = reportPhotos[i];
                if (photo.photo_url) {
                    try {
                        const imgHeight = await addImageToPDF(photo.photo_url, photoX, y, 45, 35);
                        if (imgHeight > 0 && photo.caption) {
                            doc.setFontSize(5);
                            doc.setFont(undefined, 'normal');
                            doc.text(photo.caption.substring(0, 20), photoX, y + imgHeight + 3);
                        }
                    } catch (e) {}
                }
                photoX += 48;
            }
            y += 45;
        }
        
        // ===== SIGNATURE (sur la même page si possible) =====
        if (y > 240) { doc.addPage(); y = 15; }
        
        doc.setFillColor(240, 240, 240);
        doc.rect(10, y - 4, 190, 5, 'F');
        doc.setFontSize(7);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text('VALIDATION', 12, y);
        y += 7;
        
        doc.setFontSize(6);
        doc.setFont(undefined, 'normal');
        
        // 2 colonnes pour la validation
        doc.text(`Date essais: ${formatDate(report.inspection_date)}`, 12, y);
        doc.text(`Inspecteur: ${report.inspector_name || '-'}`, 105, y);
        y += 5;
        doc.text('Signature inspecteur: _______________', 12, y);
        doc.text('Signature responsable: _______________', 105, y);
        y += 8;
        
        doc.setFontSize(5);
        doc.text('Documentation remise: ☐  |  Attestation délivrée: ☐  |  Date MES: ___/___/______', 12, y);
        
        // Pied de page sur toutes les pages
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(6);
            doc.setTextColor(128, 128, 128);
            doc.text(`Page ${i}/${pageCount} - ${new Date().toLocaleDateString('fr-FR')} - StockApp`, 105, 292, { align: 'center' });
        }
        
        doc.save(`rapport-${device?.device_number || report.id}-${formatDate(report.inspection_date)}.pdf`);
        showToast('PDF exporté', 'success');
    };
    
    // Charger les checkpoints quand on ouvre un rapport
    useEffect(() => {
        if (viewReport) {
            db.from('inspection_checkpoints').select('*').eq('report_id', viewReport.id).order('section').order('checkpoint_code').then(({ data, error }) => {
                console.log('Checkpoints loaded:', data?.length || 0, error);
                setCheckpoints(data || []);
            });
        } else {
            setCheckpoints([]);
        }
    }, [viewReport]);
    
    // Charger les réserves BC quand on ouvre un rapport BC
    useEffect(() => {
        if (viewBCReport) {
            db.from('bc_reserve_items').select('*').eq('report_id', viewBCReport.id).order('created_at').then(({ data, error }) => {
                console.log('BC Reserves loaded:', data?.length || 0, error);
                setBcReserveItems(data || []);
            });
        } else {
            setBcReserveItems([]);
        }
    }, [viewBCReport]);
    
    // Fonction pour exporter le rapport BC en PDF
    const exportBCReportPDF = (report, device) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // En-tête avec logo
        const subtitle = `${report.control_office || ''} - N° ${report.report_number || '-'} - ${formatDate(report.report_date)}`;
        let y = drawPDFHeader(doc, 'RAPPORT BUREAU DE CONTRÔLE', subtitle);
        
        doc.setTextColor(0, 0, 0);
        
        // Informations de l'appareil
        doc.setFillColor(240, 240, 240);
        doc.rect(15, y - 5, 180, 8, 'F');
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('APPAREIL CONCERNÉ', 20, y);
        y += 12;
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        const deviceInfos = [
            ['N° Appareil', device?.device_number || '-'],
            ['Site', device?.site_name || '-'],
            ['Adresse', `${device?.address_street || ''} ${device?.address_zip || ''} ${device?.address_city || ''}`]
        ];
        deviceInfos.forEach(([label, value]) => {
            doc.setFont(undefined, 'bold');
            doc.text(`${label}:`, 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(String(value).substring(0, 80), 55, y);
            y += 6;
        });
        y += 8;
        
        // Statut du rapport
        doc.setFillColor(240, 240, 240);
        doc.rect(15, y - 5, 180, 8, 'F');
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('RÉSULTAT DU CONTRÔLE', 20, y);
        y += 12;
        
        doc.setFontSize(10);
        const statusLabels = { en_attente: 'En attente', conforme: 'Conforme', non_conforme: 'Non conforme' };
        const statusColors = { en_attente: [234, 179, 8], conforme: [16, 185, 129], non_conforme: [239, 68, 68] };
        doc.setFont(undefined, 'bold');
        doc.text('Statut:', 20, y);
        doc.setTextColor(...(statusColors[report.status] || [0, 0, 0]));
        doc.text(statusLabels[report.status] || report.status, 45, y);
        doc.setTextColor(0, 0, 0);
        y += 8;
        
        if (report.reserves_lifted) {
            doc.setTextColor(16, 185, 129);
            doc.text('✓ Réserves levées', 20, y);
            doc.setTextColor(0, 0, 0);
            y += 8;
        }
        y += 5;
        
        // Observations
        if (report.observations) {
            doc.setFillColor(248, 250, 252);
            doc.rect(15, y - 5, 180, 8, 'F');
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('OBSERVATIONS', 20, y);
            y += 10;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            const obsLines = doc.splitTextToSize(report.observations, 170);
            doc.text(obsLines, 20, y);
            y += obsLines.length * 5 + 8;
        }
        
        // Réserves
        if (report.remaining_reserves) {
            if (y > 230) { doc.addPage(); y = 20; }
            doc.setFillColor(254, 226, 226);
            doc.rect(15, y - 5, 180, 8, 'F');
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(185, 28, 28);
            doc.text('⚠️ RÉSERVES', 20, y);
            y += 10;
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            const resLines = doc.splitTextToSize(report.remaining_reserves, 170);
            doc.text(resLines, 20, y);
            y += resLines.length * 5 + 8;
        }
        
        // Liste des réserves individuelles
        if (bcReserveItems.length > 0) {
            if (y > 200) { doc.addPage(); y = 20; }
            doc.setFillColor(254, 243, 199);
            doc.rect(15, y - 5, 180, 8, 'F');
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(180, 83, 9);
            doc.text(`DÉTAIL DES RÉSERVES (${bcReserveItems.length})`, 20, y);
            y += 10;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(8);
            
            // En-tête tableau
            doc.setFillColor(245, 158, 11);
            doc.rect(15, y - 4, 180, 7, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('Description', 17, y);
            doc.text('Statut', 160, y);
            y += 8;
            
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'normal');
            bcReserveItems.forEach((item, i) => {
                if (y > 275) { doc.addPage(); y = 20; }
                if (i % 2 === 0) {
                    doc.setFillColor(254, 249, 195);
                    doc.rect(15, y - 4, 180, 7, 'F');
                }
                doc.text(item.description.substring(0, 70), 17, y);
                doc.text(item.is_resolved ? '✓ Levée' : '⚠️ En attente', 160, y);
                y += 7;
            });
            y += 5;
        }
        
        // Pied de page
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(128, 128, 128);
            doc.text(`Page ${i}/${pageCount} - Exporté le ${new Date().toLocaleDateString('fr-FR')} - StockApp`, 105, 290, { align: 'center' });
        }
        
        doc.save(`rapport-bc-${device?.device_number || report.id}-${formatDate(report.report_date)}.pdf`);
        showToast('PDF exporté', 'success');
    };
    
    // Ajouter une réserve BC
    const addBcReserveItem = async (description) => {
        if (!viewBCReport || !description.trim()) return;
        try {
            const { data, error } = await db.from('bc_reserve_items').insert({
                report_id: viewBCReport.id,
                description: description.trim(),
                is_resolved: false
            }).select();
            if (error) throw error;
            setBcReserveItems(prev => [...prev, data[0]]);
            showToast('Réserve ajoutée', 'success');
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    // Valider/Dévalider une réserve BC
    const toggleBcReserveItem = async (itemId, isResolved) => {
        try {
            await db.from('bc_reserve_items').update({ 
                is_resolved: isResolved,
                resolved_at: isResolved ? new Date().toISOString() : null
            }).eq('id', itemId);
            
            const updatedItems = bcReserveItems.map(item => 
                item.id === itemId ? { ...item, is_resolved: isResolved, resolved_at: isResolved ? new Date().toISOString() : null } : item
            );
            setBcReserveItems(updatedItems);
            
            // Vérifier si toutes les réserves sont levées
            const allResolved = updatedItems.every(item => item.is_resolved);
            if (allResolved && updatedItems.length > 0 && !viewBCReport.reserves_lifted) {
                await db.from('control_reports').update({ reserves_lifted: true }).eq('id', viewBCReport.id);
                setViewBCReport({ ...viewBCReport, reserves_lifted: true });
                db.from('control_reports').select('*').eq('device_id', viewDevice.id).then(({ data }) => setControlReports(data || []));
                showToast('Toutes les réserves sont levées !', 'success');
            } else {
                showToast(isResolved ? 'Réserve validée' : 'Réserve réouverte', 'success');
            }
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    // Supprimer une réserve BC
    const deleteBcReserveItem = async (itemId) => {
        try {
            await db.from('bc_reserve_items').delete().eq('id', itemId);
            setBcReserveItems(prev => prev.filter(item => item.id !== itemId));
            showToast('Réserve supprimée', 'success');
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    // Mettre à jour le rapport BC
    const updateBCReport = async (e) => {
        e.preventDefault();
        const form = e.target;
        try {
            const updateData = {
                control_office: form.control_office.value,
                report_number: form.report_number.value || null,
                report_date: form.report_date.value,
                observations: form.observations.value || null,
                remaining_reserves: form.remaining_reserves.value || null
            };
            await db.from('control_reports').update(updateData).eq('id', editBCReport.id);
            showToast('Rapport mis à jour', 'success');
            setEditBCReport(null);
            db.from('control_reports').select('*').eq('device_id', viewDevice.id).then(({ data }) => {
                setControlReports(data || []);
                const updated = data?.find(r => r.id === editBCReport.id);
                if (updated) setViewBCReport(updated);
            });
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    
    const saveCheckpoint = async (e) => {
        e.preventDefault();
        const form = e.target;
        try {
            await db.from('inspection_checkpoints').insert({
                report_id: viewReport.id,
                section: form.section.value,
                checkpoint_code: form.checkpoint_code.value,
                checkpoint_label: form.checkpoint_label.value,
                checkpoint_detail: form.checkpoint_detail.value || null,
                status: form.status.value,
                remarks: form.remarks.value || null,
                measurement: form.measurement.value || null
            });
            showToast('Point de contrôle ajouté', 'success');
            setShowAddCheckpointModal(false);
            db.from('inspection_checkpoints').select('*').eq('report_id', viewReport.id).order('section').order('checkpoint_code').then(({ data }) => setCheckpoints(data || []));
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const updateCheckpointStatus = async (checkpointId, newStatus, remarks = null) => {
        try {
            const updateData = { status: newStatus };
            if (remarks !== null) updateData.remarks = remarks;
            await db.from('inspection_checkpoints').update(updateData).eq('id', checkpointId);
            setCheckpoints(prev => prev.map(cp => cp.id === checkpointId ? { ...cp, ...updateData } : cp));
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const deleteCheckpoint = async (id) => {
        try {
            await db.from('inspection_checkpoints').delete().eq('id', id);
            setCheckpoints(prev => prev.filter(cp => cp.id !== id));
            showToast('Point supprimé', 'success');
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const getCheckpointStatusInfo = (status) => ({
        'C': { label: 'Conforme', color: 'success', icon: '✓' },
        'NC': { label: 'Non Conforme', color: 'danger', icon: '✗' },
        'NA': { label: 'Non Applicable', color: 'secondary', icon: '-' },
        'NV': { label: 'Non Vérifié', color: 'info', icon: '?' }
    }[status] || { label: status || 'N/A', color: 'secondary', icon: '?' });
    
    const groupedCheckpoints = useMemo(() => {
        const groups = {};
        checkpoints.forEach(cp => {
            if (!groups[cp.section]) groups[cp.section] = [];
            groups[cp.section].push(cp);
        });
        return groups;
    }, [checkpoints]);
    
    const saveBCReport = async (e) => {
        e.preventDefault();
        const form = e.target;
        try {
            showToast('Création du rapport en cours...', 'info');
            
            let documentUrl = null;
            let photoUrls = [];
            
            // Upload PDF si présent
            if (bcPdfFile) {
                const fileName = `bc-doc-${viewDevice.id}-${Date.now()}.pdf`;
                const { data: uploadData, error: uploadError } = await db.storage
                    .from('documents')
                    .upload(fileName, bcPdfFile);
                if (uploadError) throw uploadError;
                const { data: urlData } = db.storage.from('documents').getPublicUrl(fileName);
                documentUrl = urlData.publicUrl;
            }
            
            // Upload photos si présentes
            if (bcPhotos.length > 0) {
                for (let i = 0; i < bcPhotos.length; i++) {
                    const photo = bcPhotos[i];
                    const ext = photo.name.split('.').pop();
                    const fileName = `bc-photo-${viewDevice.id}-${Date.now()}-${i}.${ext}`;
                    const { data: uploadData, error: uploadError } = await db.storage
                        .from('control-photos')
                        .upload(fileName, photo);
                    if (uploadError) throw uploadError;
                    const { data: urlData } = db.storage.from('control-photos').getPublicUrl(fileName);
                    photoUrls.push(urlData.publicUrl);
                }
            }
            
            // Créer le rapport BC
            const { data: newReport, error: reportError } = await db.from('control_reports').insert({
                device_id: viewDevice.id,
                control_office: form.control_office.value,
                report_date: form.report_date.value,
                status: bcFormStatus,
                reserves_lifted: bcFormReserves.length === 0 || bcFormReserves.every(r => r.resolved),
                observations: form.observations?.value || '',
                document_url: documentUrl,
                photo_urls: photoUrls.length > 0 ? JSON.stringify(photoUrls) : null
            }).select();
            
            if (reportError) throw reportError;
            
            // Ajouter les réserves individuelles si présentes
            if (bcFormReserves.length > 0 && newReport && newReport[0]) {
                const reservesToInsert = bcFormReserves.map(r => ({
                    report_id: newReport[0].id,
                    description: r.description,
                    is_resolved: r.resolved || false,
                    resolved_at: r.resolved ? new Date().toISOString() : null
                }));
                await db.from('bc_reserve_items').insert(reservesToInsert);
            }
            
            showToast('Rapport BC créé avec succès', 'success');
            setShowAddBCModal(false);
            setBcPdfFile(null);
            setBcPhotos([]);
            setBcFormStatus('en_attente');
            setBcFormReserves([]);
            db.from('control_reports').select('*').eq('device_id', viewDevice.id).then(({ data }) => setControlReports(data || []));
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const addPhoto = async (file) => {
        showToast('Upload photo en cours...', 'info');
        // Simuler upload - en production utiliser Supabase Storage
        try {
            await db.from('device_photos').insert({ device_id: viewDevice.id, photo_url: URL.createObjectURL(file), caption: file.name, photo_type: 'general', created_by: user?.id });
            db.from('device_photos').select('*').eq('device_id', viewDevice.id).then(({ data }) => setDevicePhotos(data || []));
            showToast('Photo ajoutée', 'success');
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const deletePhoto = async (id) => { try { await db.from('device_photos').delete().eq('id', id); db.from('device_photos').select('*').eq('device_id', viewDevice.id).then(({ data }) => setDevicePhotos(data || [])); showToast('Photo supprimée', 'success'); } catch (err) { showToast('Erreur: ' + err.message, 'error'); } };
    
    const getReportStatusInfo = (s) => ({ 'brouillon': { label: 'Brouillon', color: 'secondary' }, 'en_cours': { label: 'En cours', color: 'info' }, 'termine': { label: 'Terminé', color: 'success' }, 'valide': { label: 'Validé', color: 'purple' } }[s] || { label: s, color: 'secondary' });
    const getBCStatusInfo = (s) => ({ 'en_attente': { label: 'En attente', color: 'warning' }, 'conforme': { label: 'Conforme', color: 'success' }, 'non_conforme': { label: 'Non conforme', color: 'danger' } }[s] || { label: s, color: 'secondary' });
    
    return h(Fragment, null,
        // Add/Edit Device Modal - Formulaire complet
        showAddModal && h(Modal, { isOpen: true, onClose: () => { setShowAddModal(false); setEditDevice(null); setDeviceInitialDocs([]); }, title: editDevice ? 'Modifier l\'appareil' : 'Nouvel appareil en mise en service', size: 'xl' },
            h('form', { onSubmit: saveDevice },
                // Section Identification
                h('div', { style: { marginBottom: 24, padding: 20, background: `linear-gradient(135deg, ${COLORS.primary}08, ${COLORS.primary}03)`, borderRadius: 12, border: `2px solid ${COLORS.primary}20` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 10, marginBottom: 16 } },
                        h('div', { style: { width: 40, height: 40, borderRadius: 10, background: COLORS.primary, display: 'flex', alignItems: 'center', justifyContent: 'center' } },
                            h(Icon, { name: 'inspection', size: 20, color: 'white' })
                        ),
                        h('div', null,
                            h('div', { style: { fontWeight: 700, fontSize: 16, color: COLORS.text } }, 'Identification'),
                            h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Informations principales de l\'appareil')
                        )
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'N° Appareil *'), 
                            h('input', { name: 'device_number', defaultValue: editDevice?.device_number, required: true, className: 'form-input', style: { fontFamily: 'monospace', fontSize: 20, fontWeight: 700, letterSpacing: 1 }, placeholder: 'Ex: ASC-001' })
                        ),
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Nom du site *'), 
                            h('input', { name: 'site_name', defaultValue: editDevice?.site_name, required: true, className: 'form-input', placeholder: 'Ex: Résidence Les Fleurs' })
                        )
                    ),
                    h('div', { className: 'form-row-3' },
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Fabricant'), 
                            h('select', { name: 'manufacturer', defaultValue: editDevice?.manufacturer || '', className: 'form-select' },
                                h('option', { value: '' }, '-- Sélectionner --'),
                                ['OTIS', 'SCHINDLER', 'KONE', 'THYSSENKRUPP', 'MITSUBISHI', 'ORONA', 'SOULIER', 'EIFFAGE', 'MP', 'Autre'].map(m => h('option', { key: m, value: m }, m))
                            )
                        ),
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Modèle'), 
                            h('input', { name: 'model', defaultValue: editDevice?.model, className: 'form-input', placeholder: 'Ex: Gen2 Comfort' })
                        ),
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Année installation'), 
                            h('input', { name: 'installation_year', defaultValue: editDevice?.installation_year, className: 'form-input', placeholder: 'Ex: 2024' })
                        )
                    ),
                    h('div', { className: 'form-row-3' },
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Type d\'ascenseur'), 
                            h('select', { name: 'elevator_type', defaultValue: editDevice?.elevator_type || '', className: 'form-select' },
                                h('option', { value: '' }, '-- Sélectionner --'),
                                h('option', { value: 'traction' }, 'Traction'),
                                h('option', { value: 'hydraulique' }, 'Hydraulique'),
                                h('option', { value: 'mrl' }, 'Sans local machine (MRL)'),
                                h('option', { value: 'monte_charge' }, 'Monte-charge'),
                                h('option', { value: 'escalier_mecanique' }, 'Escalier mécanique'),
                                h('option', { value: 'trottoir_roulant' }, 'Trottoir roulant')
                            )
                        ),
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Type de bâtiment'), 
                            h('select', { 
                                name: 'building_type', 
                                defaultValue: editDevice?.building_type || '', 
                                className: 'form-select',
                                onChange: (e) => {
                                    const otherInput = document.getElementById('building_type_other');
                                    if (otherInput) {
                                        otherInput.style.display = e.target.value === 'autre' ? 'block' : 'none';
                                        if (e.target.value !== 'autre') otherInput.value = '';
                                    }
                                }
                            },
                                h('option', { value: '' }, '-- Sélectionner --'),
                                h('option', { value: 'habitation' }, 'Habitation'),
                                h('option', { value: 'erp' }, 'ERP (Public)'),
                                h('option', { value: 'bureaux' }, 'Bureaux'),
                                h('option', { value: 'industriel' }, 'Industriel'),
                                h('option', { value: 'hopital' }, 'Hôpital'),
                                h('option', { value: 'parking' }, 'Parking'),
                                h('option', { value: 'autre' }, 'Autre...')
                            ),
                            h('input', { 
                                type: 'text',
                                id: 'building_type_other',
                                name: 'building_type_other', 
                                className: 'form-input', 
                                placeholder: 'Précisez le type de bâtiment...',
                                defaultValue: editDevice?.building_type && !['habitation', 'erp', 'bureaux', 'industriel', 'hopital', 'parking', 'autre'].includes(editDevice.building_type) ? editDevice.building_type : '',
                                style: { 
                                    marginTop: 8, 
                                    display: (editDevice?.building_type === 'autre' || (editDevice?.building_type && !['habitation', 'erp', 'bureaux', 'industriel', 'hopital', 'parking', ''].includes(editDevice.building_type))) ? 'block' : 'none' 
                                }
                            })
                        ),
                        h('div', { className: 'form-group' })
                    )
                ),
                
                // Section Adresse
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.text, fontWeight: 600 } },
                        h(Icon, { name: 'location', size: 18 }),
                        'Adresse du site'
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Adresse'),
                        h('input', { name: 'address_street', defaultValue: editDevice?.address_street, className: 'form-input', placeholder: '123 rue de la Paix' })
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Ville'),
                            h('input', { name: 'address_city', defaultValue: editDevice?.address_city, className: 'form-input', placeholder: 'Paris' })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Code postal'),
                            h('input', { name: 'address_zip', defaultValue: editDevice?.address_zip, className: 'form-input', placeholder: '75001' })
                        )
                    )
                ),
                
                // Section Caractéristiques techniques
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.text, fontWeight: 600 } },
                        h(Icon, { name: 'settings', size: 18 }),
                        'Caractéristiques techniques'
                    ),
                    h('div', { className: 'form-row-3' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Charge (kg)'),
                            h('input', { name: 'load_capacity', defaultValue: editDevice?.load_capacity, className: 'form-input', placeholder: '630' })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Vitesse (m/s)'),
                            h('input', { name: 'speed', defaultValue: editDevice?.speed, className: 'form-input', placeholder: '1.0' })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Course (m)'),
                            h('input', { name: 'course', defaultValue: editDevice?.course, className: 'form-input', placeholder: '25.5' })
                        )
                    ),
                    h('div', { className: 'form-row-3' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Nombre de niveaux'),
                            h('input', { type: 'number', name: 'levels_count', defaultValue: editDevice?.levels_count || 0, className: 'form-input', min: 0 })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Niveaux desservis'),
                            h('input', { type: 'number', name: 'levels_served', defaultValue: editDevice?.levels_served || 0, className: 'form-input', min: 0 })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Nombre d\'accès'),
                            h('input', { type: 'number', name: 'access_count', defaultValue: editDevice?.access_count || 1, className: 'form-input', min: 1 })
                        )
                    ),
                    h('div', { className: 'form-row-3' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Dimensions cabine (LxPxH)'),
                            h('input', { name: 'cabin_dimensions', defaultValue: editDevice?.cabin_dimensions, className: 'form-input', placeholder: '1100x1400x2200' })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Profondeur cuvette (m)'),
                            h('input', { name: 'pit_depth', defaultValue: editDevice?.pit_depth, className: 'form-input', placeholder: '1.50' })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Passage de tête (m)'),
                            h('input', { name: 'headroom', defaultValue: editDevice?.headroom, className: 'form-input', placeholder: '3.50' })
                        )
                    )
                ),
                
                // Section Suspension & Câbles
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.text, fontWeight: 600 } },
                        '🔗 Suspension & Câbles'
                    ),
                    h('div', { className: 'form-row-3' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Nombre de câbles'),
                            h('input', { type: 'number', name: 'cables_count', defaultValue: editDevice?.cables_count, className: 'form-input', min: 0 })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Diamètre câbles (mm)'),
                            h('input', { name: 'cables_diameter', defaultValue: editDevice?.cables_diameter, className: 'form-input', placeholder: '8' })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Rapport de mouflage'),
                            h('select', { name: 'suspension_ratio', defaultValue: editDevice?.suspension_ratio || '', className: 'form-select' },
                                h('option', { value: '' }, '-- Sélectionner --'),
                                h('option', { value: '1:1' }, '1:1'),
                                h('option', { value: '2:1' }, '2:1'),
                                h('option', { value: '3:1' }, '3:1')
                            )
                        )
                    )
                ),
                
                // Section Amortisseurs
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.text, fontWeight: 600 } },
                        '🛡️ Amortisseurs'
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { fontWeight: 500, fontSize: 13, marginBottom: 8, color: COLORS.muted } }, 'Cabine'),
                            h('div', { className: 'form-row' },
                                h('div', { className: 'form-group' },
                                    h('label', null, 'Nombre'),
                                    h('input', { type: 'number', name: 'buffer_cabin_count', defaultValue: editDevice?.buffer_cabin_count, className: 'form-input', min: 0 })
                                ),
                                h('div', { className: 'form-group' },
                                    h('label', null, 'Type'),
                                    h('input', { name: 'buffer_cabin_type', defaultValue: editDevice?.buffer_cabin_type || '', className: 'form-input', placeholder: 'Ex: Ressort, Huile, Polyuréthane...' })
                                )
                            )
                        ),
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { fontWeight: 500, fontSize: 13, marginBottom: 8, color: COLORS.muted } }, 'Contrepoids'),
                            h('div', { className: 'form-row' },
                                h('div', { className: 'form-group' },
                                    h('label', null, 'Nombre'),
                                    h('input', { type: 'number', name: 'buffer_counterweight_count', defaultValue: editDevice?.buffer_counterweight_count, className: 'form-input', min: 0 })
                                ),
                                h('div', { className: 'form-group' },
                                    h('label', null, 'Type'),
                                    h('input', { name: 'buffer_counterweight_type', defaultValue: editDevice?.buffer_counterweight_type || '', className: 'form-input', placeholder: 'Ex: Ressort, Huile, Polyuréthane...' })
                                )
                            )
                        )
                    )
                ),
                
                // Section Serrures
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.text, fontWeight: 600 } },
                        '🔒 Serrures'
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Type de serrures'),
                        h('input', { name: 'lock_type', defaultValue: editDevice?.lock_type || '', className: 'form-input', placeholder: 'Ex: Mécanique, Électrique, Électromécanique...' })
                    )
                ),
                
                // Section Notes et Documents
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.text, fontWeight: 600 } },
                        h(Icon, { name: 'file', size: 18 }),
                        'Notes et Documents'
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Notes'),
                        h('textarea', { name: 'notes', defaultValue: editDevice?.notes, className: 'form-textarea', rows: 3, placeholder: 'Notes supplémentaires...' })
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Documents PDF'),
                        h('div', { 
                            style: { border: `2px dashed ${deviceInitialDocs.length > 0 ? COLORS.success : COLORS.border}`, borderRadius: 8, padding: 20, textAlign: 'center', cursor: 'pointer', background: deviceInitialDocs.length > 0 ? COLORS.successPastel : 'white' },
                            onClick: () => document.getElementById('device-docs-input')?.click()
                        },
                            h('input', { type: 'file', id: 'device-docs-input', accept: '.pdf', multiple: true, style: { display: 'none' }, onChange: e => setDeviceInitialDocs(Array.from(e.target.files)) }),
                            deviceInitialDocs.length > 0 
                                ? h('div', null, h(Icon, { name: 'checkCircle', size: 24, color: COLORS.success }), h('div', { style: { marginTop: 8, fontWeight: 500, color: COLORS.success } }, `${deviceInitialDocs.length} document(s) sélectionné(s)`))
                                : h('div', null, h(Icon, { name: 'file', size: 24, color: COLORS.muted }), h('div', { style: { marginTop: 8, color: COLORS.muted } }, 'Cliquez pour ajouter des PDFs'))
                        )
                    )
                ),
                
                // Boutons
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingTop: 20, borderTop: `2px solid ${COLORS.border}` } }, 
                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, '* Champs obligatoires'),
                    h('div', { style: { display: 'flex', gap: 12 } },
                        h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => { setShowAddModal(false); setEditDevice(null); setDeviceInitialDocs([]); } }, 'Annuler'), 
                        h('button', { type: 'submit', className: 'btn btn-primary', style: { minWidth: 160 } }, 
                            h(Icon, { name: editDevice ? 'checkCircle' : 'plus', size: 18 }), 
                            editDevice ? 'Enregistrer' : 'Créer l\'appareil'
                        )
                    )
                )
            )
        ),
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' },
                h('h1', { className: 'page-title' }, 'Mise en service'),
                h('p', { className: 'page-subtitle' }, `${devices.length} appareils`)
            ),
            h('div', { className: 'page-actions' },
                isAdmin && h('button', { className: 'btn btn-secondary', onClick: () => setShowArchivesModal(true) }, h(Icon, { name: 'archive', size: 16 }), 'Archives'),
                canEdit && h('button', { className: 'btn btn-primary', onClick: () => { setShowAddModal(true); setEditDevice(null); } }, h(Icon, { name: 'plus', size: 18 }), 'Ajouter')
            )
        ),
        h('div', { className: 'card' },
            h('div', { style: { padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, display: 'flex', alignItems: 'center', gap: 8, flexWrap: 'wrap' } },
                h('span', { style: { fontSize: 13, color: COLORS.muted, marginRight: 8 } }, 'Filtrer:'),
                h('button', { 
                    style: { 
                        padding: '4px 12px', borderRadius: 20, fontSize: 12, fontWeight: 500, border: 'none', cursor: 'pointer',
                        background: !status ? COLORS.primary : COLORS.background, color: !status ? 'white' : COLORS.text
                    }, 
                    onClick: () => setStatus(null) 
                }, 'Tous (', statusCounts.all, ')'),
                statuses.map(s => {
                    const st = getDeviceStatus(s);
                    return h('button', { 
                        key: s, 
                        style: { 
                            padding: '4px 12px', borderRadius: 20, fontSize: 12, fontWeight: 500, border: 'none', cursor: 'pointer',
                            background: status === s ? st.bg : COLORS.background, color: status === s ? st.text : COLORS.text
                        }, 
                        onClick: () => setStatus(s) 
                    }, st.label, ' (', statusCounts[s], ')');
                }),
                // Toggle vue grille/liste
                h('div', { style: { marginLeft: 'auto', display: 'flex', gap: 4, background: COLORS.background, borderRadius: 8, padding: 4 } },
                    h('button', { 
                        onClick: () => setViewMode('grid'),
                        style: { padding: '6px 10px', borderRadius: 6, border: 'none', cursor: 'pointer', background: viewMode === 'grid' ? 'white' : 'transparent', boxShadow: viewMode === 'grid' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none' }
                    }, h(Icon, { name: 'dashboard', size: 16, color: viewMode === 'grid' ? COLORS.primary : COLORS.muted })),
                    h('button', { 
                        onClick: () => setViewMode('list'),
                        style: { padding: '6px 10px', borderRadius: 6, border: 'none', cursor: 'pointer', background: viewMode === 'list' ? 'white' : 'transparent', boxShadow: viewMode === 'list' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none' }
                    }, h(Icon, { name: 'tasks', size: 16, color: viewMode === 'list' ? COLORS.primary : COLORS.muted }))
                ),
                // v5.8 - Compteur sélection
                selectedItems.length > 0 && h('span', { 
                    style: { background: COLORS.primary, color: 'white', padding: '4px 12px', borderRadius: 20, fontSize: 13, fontWeight: 600, marginLeft: 8 } 
                }, `${selectedItems.length} sélectionné(s)`)
            ),
            // v5.8 - Menu contextuel
            contextMenu.show && h(QuickActionsMenu, {
                isOpen: contextMenu.show,
                position: { x: contextMenu.x, y: contextMenu.y },
                type: 'device',
                item: contextMenu.item,
                onAction: (actionId, item) => {
                    if (actionId === 'view') { setViewDevice(item); setActiveTab('info'); }
                    else if (actionId === 'edit') { setEditDevice(item); setShowAddModal(true); }
                    else if (actionId === 'delete') setDeleteConfirm(item);
                    setContextMenu({ show: false, x: 0, y: 0, item: null });
                },
                onClose: () => setContextMenu({ show: false, x: 0, y: 0, item: null }),
                actions: [
                    { id: 'view', label: 'Voir détails', icon: '👁️' },
                    canEdit && { id: 'edit', label: 'Modifier', icon: '✏️' },
                    isAdmin && { id: 'delete', label: 'Supprimer', icon: '🗑️', danger: true }
                ].filter(Boolean)
            }),
            // v5.8 - Barre actions groupées
            selectedItems.length > 0 && h('div', { 
                className: 'animate-fade-in-up',
                style: { padding: '12px 16px', background: COLORS.primaryPastel, borderRadius: 8, margin: '0 16px 16px', display: 'flex', alignItems: 'center', gap: 12 } 
            },
                h('span', { style: { fontWeight: 600, color: COLORS.primary } }, `${selectedItems.length} appareil(s) sélectionné(s)`),
                h('div', { style: { marginLeft: 'auto', display: 'flex', gap: 8 } },
                    h('button', { className: 'btn btn-sm btn-secondary', onClick: () => {
                        const sel = devices.filter(d => selectedItems.includes(d.id));
                        const csv = ['N° Appareil,Site,Ville,Type,Niveaux,Statut'].concat(sel.map(d => `"${d.device_number}","${d.site_name || ''}","${d.address_city || ''}","${d.elevator_type || ''}","${d.levels_count || ''}","${d.status}"`));
                        const blob = new Blob([csv.join('\n')], { type: 'text/csv' }); const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = 'appareils.csv'; a.click(); ToastServiceV58.success('Export CSV');
                    }}, '📥 Exporter'),
                    isAdmin && h('button', { className: 'btn btn-sm btn-danger', onClick: async () => {
                        if (!confirm(`Supprimer ${selectedItems.length} appareil(s) ?`)) return;
                        for (const id of selectedItems) { await db.from('mes_devices').delete().eq('id', id); }
                        refresh(); setSelectedItems([]); ToastServiceV58.success('Supprimé');
                    }}, '🗑️ Supprimer'),
                    h('button', { className: 'btn btn-sm btn-ghost', onClick: () => setSelectedItems([]) }, '✕')
                )
            ),
            h('div', { className: 'card-body' },
                filtered.length === 0 ? 
                    h('div', { className: 'empty-state' },
                        h('div', { className: 'empty-icon' }, h(Icon, { name: 'inspection', size: 28 })),
                        h('p', { className: 'empty-title' }, 'Aucun appareil'),
                        h('p', { className: 'empty-desc' }, 'Ajoutez un appareil en mise en service')
                    ) :
                    viewMode === 'grid' ?
                    // Vue Grille (tuiles) avec checkbox
                    h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 16 } },
                        filtered.map(device => {
                            const st = getDeviceStatus(device.status);
                            const planning = (data.tasks || []).find(t => t.is_event && t.task_type === 'mes' && t.device_number === device.device_number && t.scheduled_date);
                            const isSelected = selectedItems.includes(device.id);
                            return h('div', { 
                                key: device.id, 
                                className: 'card',
                                style: { cursor: 'pointer', borderLeft: `4px solid ${planning ? COLORS.success : st.bg}`, background: isSelected ? COLORS.primaryPastel : planning ? '#F0FDF4' : 'white', border: isSelected ? `2px solid ${COLORS.primary}` : undefined },
                                onClick: (e) => { if (!e.target.closest('input')) { setViewDevice(device); setActiveTab('info'); } },
                                onContextMenu: (e) => { e.preventDefault(); setContextMenu({ show: true, x: e.clientX, y: e.clientY, item: device }); }
                            },
                                h('div', { className: 'card-body' },
                                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 12 } },
                                        h('div', { style: { display: 'flex', alignItems: 'flex-start', gap: 10 } },
                                            h('input', { 
                                                type: 'checkbox', checked: isSelected, 
                                                style: { width: 18, height: 18, marginTop: 2 },
                                                onClick: e => e.stopPropagation(),
                                                onChange: (e) => {
                                                    if (e.target.checked) setSelectedItems([...selectedItems, device.id]);
                                                    else setSelectedItems(selectedItems.filter(id => id !== device.id));
                                                }
                                            }),
                                            h('div', null,
                                                h('div', { style: { fontFamily: 'monospace', fontWeight: 700, fontSize: 18, color: COLORS.primary } }, device.device_number),
                                                h('div', { style: { fontSize: 13, color: COLORS.muted } }, device.site_name)
                                            )
                                        ),
                                        h('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: 4 } },
                                            h('span', { className: `badge badge-${st.color}` }, st.label),
                                            planning && h('span', { style: { fontSize: 11, background: COLORS.success, color: 'white', padding: '2px 8px', borderRadius: 4 } }, 
                                                '📅 ', formatDate(planning.scheduled_date)
                                            )
                                        )
                                    ),
                                    h('div', { style: { display: 'flex', gap: 16, fontSize: 13, color: COLORS.muted } },
                                        h('span', null, h(Icon, { name: 'location', size: 14 }), ' ', device.address_city || '-'),
                                        h('span', null, `${device.levels_count || 0} niv.`),
                                        device.load_capacity && h('span', null, `${device.load_capacity} kg`)
                                    ),
                                    planning && planning.assigned_to && h('div', { style: { marginTop: 8 } }, 
                                        h('span', { className: 'badge badge-secondary' }, getUserName(planning.assigned_to, data.users) || 'Non assigné')
                                    )
                                )
                            );
                        })
                    ) :
                    // Vue Liste (tableau) avec colonnes redimensionnables
                    h('div', { className: 'table-container', style: { overflowX: 'auto' } },
                        h('table', { className: 'table', style: { tableLayout: 'fixed', width: '100%' } },
                            h('thead', null,
                                h('tr', null,
                                    resizableCols.map(col => {
                                        const colProps = getColumnProps(col.key);
                                        // v5.8 - Checkbox header
                                        if (col.key === 'checkbox') {
                                            return h('th', { key: 'checkbox', style: { width: 50, textAlign: 'center' } },
                                                h('input', { 
                                                    type: 'checkbox', 
                                                    checked: filtered.length > 0 && selectedItems.length === filtered.length,
                                                    onChange: (e) => {
                                                        if (e.target.checked) setSelectedItems(filtered.map(d => d.id));
                                                        else setSelectedItems([]);
                                                    },
                                                    style: { width: 18, height: 18 }
                                                })
                                            );
                                        }
                                        if (col.key === 'device_number') {
                                            return h(FilterableTh, { key: col.key, label: 'N° Appareil', filterKey: 'device_number', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                                        }
                                        if (col.key === 'site_name') {
                                            return h(FilterableTh, { key: col.key, label: 'Site', filterKey: 'site_name', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                                        }
                                        if (col.key === 'address_city') {
                                            return h(FilterableTh, { key: col.key, label: 'Ville', filterKey: 'address_city', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                                        }
                                        if (col.key === 'elevator_type') {
                                            return h(FilterableTh, { key: col.key, label: 'Type', filterKey: 'elevator_type', filters: columnFilters, setFilters: setColumnFilters, type: 'select', options: [
                                                { value: 'electrique_equilibre', label: '⚡ Électrique' },
                                                { value: 'hydraulique', label: '💧 Hydraulique' },
                                                { value: 'treuil_attele', label: '🔧 Treuil' },
                                                { value: 'monte_charge', label: '📦 Monte-charge' }
                                            ], ...colProps });
                                        }
                                        if (col.key === 'levels_count') {
                                            return h(FilterableTh, { key: col.key, label: 'Niveaux', filterKey: null, filters: null, setFilters: null, style: { textAlign: 'center' }, ...colProps });
                                        }
                                        if (col.key === 'status') {
                                            return h(FilterableTh, { key: col.key, label: 'Statut', filterKey: 'status', filters: columnFilters, setFilters: setColumnFilters, type: 'select', options: statuses.map(s => ({ value: s, label: getDeviceStatus(s).label })), ...colProps });
                                        }
                                        if (col.key === 'planning') {
                                            return h(FilterableTh, { key: col.key, label: 'Planification', filterKey: null, filters: null, setFilters: null, ...colProps });
                                        }
                                        return null;
                                    }).filter(Boolean)
                                )
                            ),
                            h('tbody', null,
                                filtered.map(device => {
                                    const st = getDeviceStatus(device.status);
                                    const planning = (data.tasks || []).find(t => t.is_event && t.task_type === 'mes' && t.device_number === device.device_number && t.scheduled_date);
                                    const elevatorTypes = { 'electrique_equilibre': '⚡ Électrique', 'hydraulique': '💧 Hydraulique', 'treuil_attele': '🔧 Treuil', 'monte_charge': '📦 Monte-charge' };
                                    const isSelected = selectedItems.includes(device.id);
                                    
                                    const renderCell = (colKey) => {
                                        const col = resizableCols.find(c => c.key === colKey);
                                        const width = col?.width;
                                        
                                        switch(colKey) {
                                            // v5.8 - Checkbox cell
                                            case 'checkbox':
                                                return h('td', { key: 'checkbox', style: { width: 50, textAlign: 'center' }, onClick: e => e.stopPropagation() },
                                                    h('input', { 
                                                        type: 'checkbox', 
                                                        checked: isSelected,
                                                        onChange: (e) => {
                                                            if (e.target.checked) setSelectedItems([...selectedItems, device.id]);
                                                            else setSelectedItems(selectedItems.filter(id => id !== device.id));
                                                        },
                                                        style: { width: 18, height: 18 }
                                                    })
                                                );
                                            case 'device_number':
                                                return h('td', { key: colKey, style: { width } }, h('span', { style: { fontFamily: 'monospace', fontWeight: 700, color: COLORS.primary } }, device.device_number));
                                            case 'site_name':
                                                return h('td', { key: colKey, style: { width } }, device.site_name || '-');
                                            case 'address_city':
                                                return h('td', { key: colKey, style: { width } }, device.address_city || '-');
                                            case 'elevator_type':
                                                return h('td', { key: colKey, style: { width } }, h('span', { style: { fontSize: 12 } }, elevatorTypes[device.elevator_type] || device.elevator_type || '-'));
                                            case 'levels_count':
                                                return h('td', { key: colKey, style: { width, textAlign: 'center' } }, device.levels_count || 0);
                                            case 'status':
                                                return h('td', { key: colKey, style: { width } }, h('span', { className: `badge badge-${st.color}` }, st.label));
                                            case 'planning':
                                                return h('td', { key: colKey, style: { width } }, planning ? 
                                                    h('span', { style: { display: 'flex', alignItems: 'center', gap: 6 } },
                                                        h('span', { style: { fontSize: 12, background: COLORS.successPastel, color: COLORS.success, padding: '2px 8px', borderRadius: 4 } }, '📅 ', formatDate(planning.scheduled_date)),
                                                        planning.assigned_to && h('span', { style: { fontSize: 11, color: COLORS.muted } }, getUserName(planning.assigned_to, data.users))
                                                    ) :
                                                    h('span', { style: { fontSize: 12, color: COLORS.muted } }, '-')
                                                );
                                            default:
                                                return h('td', { key: colKey }, '-');
                                        }
                                    };
                                    
                                    return h('tr', { 
                                        key: device.id, 
                                        style: { cursor: 'pointer', background: isSelected ? COLORS.primaryPastel : planning ? '#F0FDF4' : 'white' },
                                        onClick: (e) => { if (!e.target.closest('input')) { setViewDevice(device); setActiveTab('info'); } },
                                        onContextMenu: (e) => { e.preventDefault(); setContextMenu({ show: true, x: e.clientX, y: e.clientY, item: device }); }
                                    },
                                        resizableCols.map(col => renderCell(col.key))
                                    );
                                })
                            )
                        )
                    )
            )
        ),
        // View Device Modal
        h(Modal, { isOpen: !!viewDevice, onClose: () => setViewDevice(null), title: viewDevice?.device_number, size: 'xl',
            footer: h(Fragment, null,
                canEdit && h('button', { className: 'btn btn-secondary', onClick: () => { setEditDevice(viewDevice); setShowAddModal(true); setViewDevice(null); } }, h(Icon, { name: 'edit', size: 16 }), 'Modifier'),
                viewDevice?.status === 'termine' && isAdmin && h('button', { className: 'btn btn-secondary', onClick: () => archiveDevice(viewDevice) }, h(Icon, { name: 'archive', size: 16 }), 'Archiver'),
                isAdmin && h('button', { className: 'btn btn-danger', onClick: () => setDeleteConfirm(viewDevice) }, h(Icon, { name: 'trash', size: 16 }), 'Supprimer')
            )
        }, viewDevice && h('div', null,
            (() => {
                const planning = (data.tasks || []).find(t => t.is_event && t.task_type === 'mes' && t.device_number === viewDevice.device_number && t.scheduled_date);
                return h(Fragment, null,
                    h('div', { style: { display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap', alignItems: 'center' } }, 
                        h('span', { className: `badge badge-${getDeviceStatus(viewDevice.status).color}` }, getDeviceStatus(viewDevice.status).label),
                        planning && h('span', { style: { display: 'flex', alignItems: 'center', gap: 8, background: '#DCFCE7', padding: '6px 12px', borderRadius: 8, fontSize: 13 } },
                            h('span', { style: { color: COLORS.success, fontWeight: 600 } }, '📅 Planifié'),
                            h('span', null, new Date(planning.scheduled_date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })),
                            planning.scheduled_time && h('span', null, 'a ' + planning.scheduled_time),
                            planning.assigned_to && h('span', { className: 'badge badge-secondary' }, getUserName(planning.assigned_to, data.users) || planning.assigned_to),
                            canEdit && h('button', { 
                                className: 'btn btn-ghost btn-xs', 
                                style: { padding: '2px 6px', color: COLORS.danger },
                                onClick: async () => {
                                    try {
                                        await db.from('tasks').delete().eq('id', planning.id);
                                        showToast('Planification annulée', 'success');
                                        refresh();
                                    } catch (err) {
                                        showToast('Erreur: ' + err.message, 'error');
                                    }
                                }
                            }, h(Icon, { name: 'x', size: 12 }))
                        )
                    ),
                    h('div', { className: 'tabs' },
                h('button', { className: `tab ${activeTab === 'info' ? 'active' : ''}`, onClick: () => setActiveTab('info') }, 'Informations'),
                h('button', { className: `tab ${activeTab === 'reports' ? 'active' : ''}`, onClick: () => setActiveTab('reports') }, `Rapports (${reports.length})`),
                h('button', { className: `tab ${activeTab === 'bc' ? 'active' : ''}`, onClick: () => setActiveTab('bc') }, `BC (${controlReports.length})`),
                h('button', { className: `tab ${activeTab === 'photos' ? 'active' : ''}`, onClick: () => setActiveTab('photos') }, `Photos (${devicePhotos.length})`),
                viewDevice.status === 'mes_reserves' && h('button', { 
                    className: `tab ${activeTab === 'reserves' ? 'active' : ''}`, 
                    onClick: () => setActiveTab('reserves'),
                    style: { color: activeTab === 'reserves' ? '#DC2626' : '#EF4444', fontWeight: 600 }
                }, '⚠️ Réserves')
            ),
            activeTab === 'info' && h('div', null,
                h('div', { className: 'info-grid' },
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Site'), h('div', { className: 'info-value' }, viewDevice.site_name || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Adresse'), h('div', { className: 'info-value' }, `${viewDevice.address_street || ''} ${viewDevice.address_city || ''}`)),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Charge'), h('div', { className: 'info-value' }, viewDevice.load_capacity ? `${viewDevice.load_capacity} kg` : '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Vitesse'), h('div', { className: 'info-value' }, viewDevice.speed ? `${viewDevice.speed} m/s` : '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Course'), h('div', { className: 'info-value' }, viewDevice.course ? `${viewDevice.course} m` : '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Niveaux'), h('div', { className: 'info-value' }, `${viewDevice.levels_count || 0} (${viewDevice.levels_served || 0} desservis)`)),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Accès'), h('div', { className: 'info-value' }, viewDevice.access_count || 1)),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Type ascenseur'), h('div', { className: 'info-value' }, { electrique_equilibre: 'Électrique équilibré', hydraulique: 'Hydraulique', treuil_attele: 'Treuil attelé', monte_charge: 'Monte-charge' }[viewDevice.elevator_type] || viewDevice.elevator_type)),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Type bâtiment'), h('div', { className: 'info-value' }, { habitation: 'Habitation', bureau: 'Bureau', erp: 'ERP', industrie: 'Industrie', autre: 'Autre' }[viewDevice.building_type] || viewDevice.building_type)),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Dimensions cabine'), h('div', { className: 'info-value' }, viewDevice.cabin_dimensions || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Cuvette'), h('div', { className: 'info-value' }, viewDevice.pit_depth ? `${viewDevice.pit_depth} m` : '-'))
                ),
                canEdit && h('div', { style: { marginTop: 24 } },
                    h('div', { style: { fontWeight: 600, marginBottom: 12 } }, 'Changer le statut'),
                    h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                        statuses.map(s => h('button', { key: s, className: `btn btn-sm ${viewDevice.status === s ? 'btn-primary' : 'btn-secondary'}`, onClick: () => updateDeviceStatus(viewDevice.id, s) }, getDeviceStatus(s).label))
                    )
                )
            ),
            activeTab === 'reports' && h('div', null,
                canEdit && h('button', { className: 'btn btn-primary', style: { marginBottom: 16 }, onClick: () => setShowAddReportModal(true) }, h(Icon, { name: 'plus', size: 16 }), 'Nouveau rapport'),
                reports.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun rapport') :
                h('div', null, reports.map(r => h('div', { key: r.id, style: { padding: 16, marginBottom: 12, cursor: 'pointer', background: COLORS.background, borderRadius: 'var(--radius)', border: `1px solid ${COLORS.border}`, transition: 'all 0.2s' }, onClick: async () => {
                    // Recharger le rapport depuis la DB pour avoir toutes les colonnes (mesures vitesse/intensité)
                    const result = await db.from('inspection_reports').select('*').eq('id', r.id).single();
                    if (result.data) {
                        setViewReport(result.data);
                    } else {
                        setViewReport(r);
                    }
                }, onMouseEnter: e => e.currentTarget.style.borderColor = COLORS.primary, onMouseLeave: e => e.currentTarget.style.borderColor = COLORS.border },
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                        h('div', null,
                            h('div', { style: { fontWeight: 600, color: COLORS.text } }, r.report_number || `Rapport #${r.id}`),
                            h('div', { style: { fontSize: 13, color: COLORS.muted, marginTop: 4 } }, `${r.report_type === 'mise_en_service' ? 'Mise en service' : 'Levée réserves'} • ${formatDate(r.inspection_date)}`),
                            r.inspector_name && h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 2 } }, `Par ${r.inspector_name}`)
                        ),
                        h('span', { className: `badge badge-${getReportStatusInfo(r.status).color}` }, getReportStatusInfo(r.status).label)
                    )
                )))
            ),
            activeTab === 'bc' && h('div', null,
                canEdit && h('button', { className: 'btn btn-primary', style: { marginBottom: 16 }, onClick: () => setShowAddBCModal(true) }, h(Icon, { name: 'plus', size: 16 }), 'Nouveau rapport BC'),
                controlReports.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun rapport BC') :
                h('div', null, controlReports.map(r => h('div', { key: r.id, style: { padding: 16, marginBottom: 12, cursor: 'pointer', background: r.reserves_lifted ? '#F0FDF4' : COLORS.background, borderRadius: 'var(--radius)', border: `1px solid ${r.reserves_lifted ? COLORS.success : COLORS.border}`, transition: 'all 0.2s' }, onClick: () => setViewBCReport(r), onMouseEnter: e => e.currentTarget.style.borderColor = COLORS.primary, onMouseLeave: e => e.currentTarget.style.borderColor = r.reserves_lifted ? COLORS.success : COLORS.border },
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                        h('div', null,
                            h('div', { style: { fontWeight: 600, color: COLORS.text, display: 'flex', alignItems: 'center', gap: 8 } }, 
                                r.control_office,
                                r.reserves_lifted && h('span', { style: { fontSize: 11, background: COLORS.success, color: 'white', padding: '2px 8px', borderRadius: 10 } }, '✓ Réserves levées')
                            ),
                            h('div', { style: { fontSize: 13, color: COLORS.muted, marginTop: 4 } }, `N° ${r.report_number || '-'} • ${formatDate(r.report_date)}`),
                            r.observations && h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 4, maxWidth: 300, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, r.observations)
                        ),
                        h('div', { style: { display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: 4 } },
                            h('span', { className: `badge badge-${getBCStatusInfo(r.status).color}` }, getBCStatusInfo(r.status).label),
                            r.remaining_reserves && !r.reserves_lifted && h('span', { style: { fontSize: 10, color: COLORS.danger } }, '⚠️ Réserves en attente')
                        )
                    )
                )))
            ),
            activeTab === 'photos' && h('div', null,
                h(PhotoManager, { 
                    photos: devicePhotos, 
                    onAdd: canEdit ? addPhoto : null, 
                    onDelete: canEdit ? deletePhoto : null,
                    onUpdateCaption: canEdit ? async (photoId, caption) => {
                        try {
                            await db.from('device_photos').update({ caption }).eq('id', photoId);
                            db.from('device_photos').select('*').eq('device_id', viewDevice.id).then(({ data }) => setDevicePhotos(data || []));
                            showToast('Légende mise à jour', 'success');
                        } catch (err) {
                            showToast('Erreur: ' + err.message, 'error');
                        }
                    } : null
                })
            ),
            // Onglet Réserves (visible uniquement si statut MES avec réserves)
            activeTab === 'reserves' && viewDevice.status === 'mes_reserves' && h('div', null,
                h('div', { style: { marginBottom: 20, padding: 16, background: '#FEF2F2', borderRadius: 12, border: '2px solid #FECACA' } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12, color: '#DC2626', fontWeight: 600 } },
                        '⚠️ Réserves à lever'
                    ),
                    h('p', { style: { fontSize: 13, color: '#991B1B', margin: 0 } },
                        'Cet appareil a été mis en service avec des réserves. Listez ci-dessous les points à corriger.'
                    )
                ),
                h('div', { className: 'form-group' },
                    h('label', { style: { fontWeight: 600 } }, 'Liste des réserves'),
                    h('textarea', {
                        className: 'form-textarea',
                        rows: 10,
                        placeholder: 'Décrivez les réserves à lever...\n\n1. ...\n2. ...\n3. ...',
                        defaultValue: viewDevice.reserves || '',
                        style: { width: '100%', minHeight: 200 },
                        onBlur: async (e) => {
                            try {
                                await db.from('commissioning_devices').update({ reserves: e.target.value }).eq('id', viewDevice.id);
                                setViewDevice({ ...viewDevice, reserves: e.target.value });
                                showToast('Réserves enregistrées', 'success');
                            } catch (err) {
                                showToast('Erreur: ' + err.message, 'error');
                            }
                        }
                    })
                ),
                h('div', { className: 'form-group', style: { marginTop: 16 } },
                    h('label', { style: { fontWeight: 600 } }, 'Date prévue de levée des réserves'),
                    h('input', {
                        type: 'date',
                        className: 'form-input',
                        defaultValue: viewDevice.reserves_due_date || '',
                        style: { maxWidth: 200 },
                        onChange: async (e) => {
                            try {
                                await db.from('commissioning_devices').update({ reserves_due_date: e.target.value || null }).eq('id', viewDevice.id);
                                setViewDevice({ ...viewDevice, reserves_due_date: e.target.value });
                                showToast('Date mise à jour', 'success');
                            } catch (err) {
                                showToast('Erreur: ' + err.message, 'error');
                            }
                        }
                    })
                ),
                canEdit && h('div', { style: { marginTop: 24, padding: 16, background: COLORS.successPastel, borderRadius: 12, border: `1px solid ${COLORS.success}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
                        h('div', null,
                            h('div', { style: { fontWeight: 600, color: COLORS.success } }, '✅ Réserves levées ?'),
                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, 'Si toutes les réserves ont été corrigées, vous pouvez changer le statut.')
                        ),
                        h('button', { 
                            className: 'btn btn-success',
                            onClick: () => updateDeviceStatus(viewDevice.id, 'termine')
                        }, 'Marquer comme terminé')
                    )
                )
            )
        )})()),
        // Add Report Modal
        h(Modal, { isOpen: showAddReportModal, onClose: () => setShowAddReportModal(false), title: 'Nouveau rapport d\'inspection', size: 'lg' },
            h('form', { onSubmit: saveReport },
                // Section Informations générales
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.primary, fontWeight: 600 } },
                        h(Icon, { name: 'file', size: 18 }),
                        'Informations générales'
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'N° Rapport'), 
                            h('input', { name: 'report_number', placeholder: 'Auto-généré si vide', className: 'form-input' })
                        ),
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Type de rapport *'), 
                            h('select', { name: 'report_type', className: 'form-select', required: true }, 
                                h('option', { value: 'mise_en_service' }, '🔧 Mise en service'), 
                                h('option', { value: 'levee_reserves' }, '✅ Levée de réserves')
                            )
                        )
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Date d\'inspection *'), 
                            h('input', { name: 'inspection_date', type: 'date', defaultValue: new Date().toISOString().split('T')[0], className: 'form-input', required: true })
                        ),
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Inspecteur'), 
                            h('input', { name: 'inspector_name', placeholder: 'Nom de l\'inspecteur', className: 'form-input', defaultValue: user?.full_name || '' })
                        )
                    )
                ),
                // Section Remarques
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.primary, fontWeight: 600 } },
                        h(Icon, { name: 'clipboard', size: 18 }),
                        'Remarques'
                    ),
                    h('div', { className: 'form-group' }, 
                        h('label', null, 'Remarques générales'), 
                        h('textarea', { name: 'general_remarks', rows: 4, className: 'form-textarea', placeholder: 'Observations, remarques particulières...' })
                    ),
                    // Champ Réserves (visible toujours mais particulièrement pour MES avec réserves)
                    h('div', { className: 'form-group' }, 
                        h('label', { style: { color: '#DC2626' } }, '⚠️ Réserves (le cas échéant)'), 
                        h('textarea', { name: 'reserves', rows: 4, className: 'form-textarea', placeholder: 'Listez les réserves à lever si applicable...', style: { borderColor: '#FECACA' } })
                    )
                ),
                // Boutons
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 12, paddingTop: 16, borderTop: `1px solid ${COLORS.border}` } }, 
                    h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => setShowAddReportModal(false) }, 'Annuler'), 
                    h('button', { type: 'submit', className: 'btn btn-primary' }, h(Icon, { name: 'plus', size: 16 }), 'Créer le rapport')
                )
            )
        ),
        // View Report Modal
        h(Modal, { isOpen: !!viewReport, onClose: () => setViewReport(null), title: `Rapport ${viewReport?.report_number || ''}`, size: 'xl',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => exportInspectionReportPDF(viewReport, viewDevice, checkpoints, devicePhotos) }, h(Icon, { name: 'pdf', size: 16 }), 'Export PDF'),
                canEdit && h('button', { className: 'btn btn-danger', onClick: () => setDeleteReportConfirm(viewReport) }, h(Icon, { name: 'trash', size: 16 }), 'Supprimer')
            )
        }, viewReport && h('div', { key: viewReport.id },
            // Changement de statut EN HAUT
            canEdit && h('div', { style: { marginBottom: 20, padding: 16, background: COLORS.light, borderRadius: 12 } },
                h('div', { style: { fontWeight: 600, marginBottom: 12, display: 'flex', alignItems: 'center', gap: 8 } }, 
                    h(Icon, { name: 'settings', size: 18 }), 
                    'Statut du rapport'
                ),
                h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                    ['brouillon', 'en_cours', 'termine', 'valide'].map(s => h('button', { 
                        key: s, 
                        className: `btn ${viewReport.status === s ? 'btn-primary' : 'btn-secondary'}`, 
                        onClick: () => updateReportStatus(viewReport.id, s),
                        style: { flex: 1, minWidth: 100 }
                    }, getReportStatusInfo(s).label))
                )
            ),
            // Infos générales
            h('div', { className: 'info-grid', style: { marginBottom: 20 } },
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Type'), h('div', { className: 'info-value' }, viewReport.report_type === 'mise_en_service' ? 'Mise en service' : 'Levée réserves')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Date'), h('div', { className: 'info-value' }, formatDate(viewReport.inspection_date))),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Inspecteur'), h('div', { className: 'info-value' }, viewReport.inspector_name || '-'))
            ),
            // Remarques générales
            viewReport.general_remarks && h('div', { style: { marginBottom: 20 } },
                h('h4', { style: { marginBottom: 8 } }, 'Remarques générales'),
                h('p', { style: { color: COLORS.muted, whiteSpace: 'pre-wrap', padding: 12, background: COLORS.light, borderRadius: 8 } }, viewReport.general_remarks)
            ),
            // Réserves (si présentes)
            (viewReport.reserves || canEdit) && h('div', { style: { marginBottom: 20, padding: 16, background: '#FEF2F2', borderRadius: 12, border: '1px solid #FECACA' } },
                h('h4', { style: { marginBottom: 8, color: '#DC2626', display: 'flex', alignItems: 'center', gap: 8 } }, '⚠️ Réserves'),
                canEdit ? h('textarea', {
                    className: 'form-textarea',
                    rows: 4,
                    placeholder: 'Listez les réserves à lever...',
                    defaultValue: viewReport.reserves || '',
                    style: { width: '100%', borderColor: '#FECACA' },
                    onBlur: async (e) => {
                        if (e.target.value !== (viewReport.reserves || '')) {
                            await db.from('inspection_reports').update({ reserves: e.target.value || null }).eq('id', viewReport.id);
                            setViewReport({ ...viewReport, reserves: e.target.value });
                            showToast('Réserves enregistrées', 'success');
                        }
                    }
                }) : h('p', { style: { color: '#991B1B', whiteSpace: 'pre-wrap', margin: 0 } }, viewReport.reserves || 'Aucune réserve')
            ),
            // Section Checklist
            h('div', { style: { marginBottom: 20, padding: 16, background: '#f0f9ff', borderRadius: 12, border: '2px solid #3B82F6' } },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 } },
                    h('h4', { style: { margin: 0, color: '#3B82F6' } }, `📋 Checklist (${checkpoints.length} points)`),
                    canEdit && h('button', { className: 'btn btn-sm btn-primary', onClick: () => setShowAddCheckpointModal(true) }, h(Icon, { name: 'plus', size: 14 }), ' Ajouter')
                ),
                checkpoints.length === 0 ? 
                    h('div', { style: { padding: 24, textAlign: 'center', background: COLORS.light, borderRadius: 12, color: COLORS.muted } }, 
                        h(Icon, { name: 'clipboard', size: 32 }),
                        h('p', { style: { marginTop: 8 } }, 'Aucun point de contrôle'),
                        canEdit && h('div', { style: { display: 'flex', gap: 12, justifyContent: 'center', marginTop: 12 } },
                            h('button', { className: 'btn btn-sm btn-primary', onClick: loadDefaultCheckpoints }, 
                                h(Icon, { name: 'download', size: 14 }), ' Charger checklist standard (', defaultCheckpoints.length, ' points)'
                            ),
                            h('button', { className: 'btn btn-sm btn-secondary', onClick: () => setShowAddCheckpointModal(true) }, 
                                h(Icon, { name: 'plus', size: 14 }), ' Ajouter manuellement'
                            )
                        )
                    ) :
                    h('div', null,
                        // Stats
                        h('div', { style: { display: 'flex', gap: 12, marginBottom: 16, flexWrap: 'wrap' } },
                            h('span', { className: 'badge badge-success' }, `${checkpoints.filter(c => c.status === 'C').length} Conformes`),
                            h('span', { className: 'badge badge-danger' }, `${checkpoints.filter(c => c.status === 'NC').length} Non Conformes`),
                            h('span', { className: 'badge badge-secondary' }, `${checkpoints.filter(c => c.status === 'NA' || !c.status).length} N/A`)
                        ),
                        // Grouped by section
                        Object.entries(groupedCheckpoints).map(([section, items]) => h('div', { key: section, style: { marginBottom: 16 } },
                            h('div', { style: { fontWeight: 600, fontSize: 13, color: COLORS.primary, marginBottom: 8, padding: '8px 12px', background: `${COLORS.primary}10`, borderRadius: 8, textTransform: 'capitalize' } }, section),
                            h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                                items.map(cp => h('div', { 
                                    key: cp.id, 
                                    style: { 
                                        padding: '12px 16px', 
                                        background: cp.status === 'NC' ? '#FEF2F2' : COLORS.light, 
                                        borderRadius: 8, 
                                        borderLeft: `4px solid ${COLORS[getCheckpointStatusInfo(cp.status).color]}` 
                                    } 
                                },
                                    h('div', { style: { display: 'flex', alignItems: 'flex-start', gap: 12 } },
                                        h('div', { style: { flex: 1 } },
                                            h('div', { style: { fontWeight: 500, fontSize: 14 } }, cp.checkpoint_label || cp.checkpoint_code),
                                            cp.checkpoint_detail && h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 2 } }, cp.checkpoint_detail),
                                            cp.measurement && h('div', { style: { fontSize: 12, color: COLORS.info, marginTop: 4, display: 'flex', alignItems: 'center', gap: 4 } }, '📏 ', cp.measurement),
                                            // Champ info complémentaire
                                            canEdit && h('div', { style: { marginTop: 8 } },
                                                h('input', {
                                                    type: 'text',
                                                    placeholder: 'Info complémentaire (mesure, référence...)',
                                                    defaultValue: cp.additional_info || '',
                                                    className: 'form-input',
                                                    style: { fontSize: 12, padding: '4px 8px', width: '100%', maxWidth: 300 },
                                                    onBlur: async (e) => {
                                                        if (e.target.value !== (cp.additional_info || '')) {
                                                            await db.from('inspection_checkpoints').update({ additional_info: e.target.value || null }).eq('id', cp.id);
                                                            db.from('inspection_checkpoints').select('*').eq('report_id', viewReport.id).order('section').order('checkpoint_code').then(({ data }) => setCheckpoints(data || []));
                                                        }
                                                    }
                                                })
                                            ),
                                            !canEdit && cp.additional_info && h('div', { style: { fontSize: 12, color: COLORS.primary, marginTop: 4, fontStyle: 'italic' } }, '📝 ', cp.additional_info)
                                        ),
                                        canEdit && h('div', { style: { display: 'flex', gap: 4 } },
                                            h('button', { className: `btn btn-xs ${cp.status === 'C' ? 'btn-success' : 'btn-ghost'}`, onClick: () => updateCheckpointStatus(cp.id, 'C'), title: 'Conforme' }, '✓'),
                                            h('button', { className: `btn btn-xs ${cp.status === 'NC' ? 'btn-danger' : 'btn-ghost'}`, onClick: () => updateCheckpointStatus(cp.id, 'NC'), title: 'Non Conforme' }, '✗'),
                                            h('button', { className: `btn btn-xs ${cp.status === 'SO' ? 'btn-secondary' : 'btn-ghost'}`, onClick: () => updateCheckpointStatus(cp.id, 'SO'), title: 'Sans Objet' }, 'SO'),
                                            h('button', { className: 'btn btn-xs btn-ghost', onClick: () => setEditCheckpoint(cp), title: 'Modifier', style: { color: COLORS.primary } }, h(Icon, { name: 'edit', size: 12 })),
                                            h('button', { className: 'btn btn-xs btn-ghost', onClick: () => deleteCheckpoint(cp.id), title: 'Supprimer', style: { color: COLORS.danger } }, h(Icon, { name: 'trash', size: 12 }))
                                        ),
                                        !canEdit && h('span', { className: `badge badge-${getCheckpointStatusInfo(cp.status).color}` }, getCheckpointStatusInfo(cp.status).label)
                                    ),
                                    // Zone remarque et photos pour NC
                                    (cp.status === 'NC' || cp.remarks || cp.photo_url) && h('div', { style: { marginTop: 12, paddingTop: 12, borderTop: '1px solid rgba(0,0,0,0.1)' } },
                                        cp.remarks && h('div', { style: { fontSize: 13, color: COLORS.orange, marginBottom: 8, padding: '8px 12px', background: '#FEF3C7', borderRadius: 6 } }, 
                                            h('strong', null, '💬 Remarque: '), cp.remarks
                                        ),
                                        cp.photo_url && h('div', { style: { marginBottom: 8 } },
                                            h('img', { src: cp.photo_url, alt: 'Photo NC', style: { maxWidth: 200, borderRadius: 8, cursor: 'pointer' }, onClick: () => window.open(cp.photo_url, '_blank') })
                                        ),
                                        canEdit && cp.status === 'NC' && h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                                            h('button', { 
                                                className: 'btn btn-xs btn-ghost', 
                                                style: { color: COLORS.orange },
                                                onClick: () => {
                                                    const remark = prompt('Remarque pour cette non-conformité:', cp.remarks || '');
                                                    if (remark !== null) {
                                                        db.from('inspection_checkpoints').update({ remarks: remark }).eq('id', cp.id)
                                                            .then(() => {
                                                                showToast('Remarque enregistrée', 'success');
                                                                db.from('inspection_checkpoints').select('*').eq('report_id', viewReport.id).order('section').then(({ data }) => setCheckpoints(data || []));
                                                            });
                                                    }
                                                }
                                            }, h(Icon, { name: 'edit', size: 12 }), ' ', cp.remarks ? 'Modifier remarque' : 'Ajouter remarque'),
                                            h('label', { className: 'btn btn-xs btn-ghost', style: { color: COLORS.info, cursor: 'pointer' } },
                                                h(Icon, { name: 'camera', size: 12 }), ' ', cp.photo_url ? 'Changer photo' : 'Ajouter photo',
                                                h('input', { 
                                                    type: 'file', 
                                                    accept: 'image/*', 
                                                    style: { display: 'none' },
                                                    onChange: async (e) => {
                                                        const file = e.target.files?.[0];
                                                        if (file) {
                                                            try {
                                                                const fileName = `checkpoint-${cp.id}-${Date.now()}.${file.name.split('.').pop()}`;
                                                                const { data: uploadData, error: uploadError } = await db.storage.from('checkpoint-photos').upload(fileName, file);
                                                                if (uploadError) throw uploadError;
                                                                const { data: urlData } = db.storage.from('checkpoint-photos').getPublicUrl(fileName);
                                                                await db.from('inspection_checkpoints').update({ photo_url: urlData.publicUrl }).eq('id', cp.id);
                                                                showToast('Photo ajoutée', 'success');
                                                                db.from('inspection_checkpoints').select('*').eq('report_id', viewReport.id).order('section').then(({ data }) => setCheckpoints(data || []));
                                                            } catch (err) {
                                                                showToast('Erreur upload: ' + err.message, 'error');
                                                            }
                                                        }
                                                    }
                                                })
                                            )
                                        )
                                    )
                                ))
                            )
                        ))
                    )
            ),
            // Mesures de vitesse (m/s) - Tableau
            h('div', { style: { marginBottom: 20, padding: 16, background: '#EFF6FF', borderRadius: 12, border: '2px solid #3B82F6' } },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                    h('h4', { style: { margin: 0, color: '#3B82F6', display: 'flex', alignItems: 'center', gap: 8 } }, '📏 Mesures de vitesse (m/s)')
                ),
                // Tableau des mesures
                h('div', { style: { background: 'white', borderRadius: 8, overflow: 'hidden', border: '1px solid #E5E7EB' } },
                    // En-tête
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', background: '#F3F4F6', padding: '10px 12px', borderBottom: '1px solid #E5E7EB' } },
                        h('div', { style: { fontWeight: 600, fontSize: 13 } }, 'Charge'),
                        h('div', { style: { fontWeight: 600, fontSize: 13, color: '#10B981', textAlign: 'center' } }, '↑ Montée'),
                        h('div', { style: { fontWeight: 600, fontSize: 13, color: '#3B82F6', textAlign: 'center' } }, '↓ Descente')
                    ),
                    // Ligne À vide
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', padding: '8px 12px', borderBottom: '1px solid #E5E7EB', alignItems: 'center' } },
                        h('div', { style: { fontSize: 13 } }, 'À vide'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.speed_empty_up || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, speed_empty_up: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ speed_empty_up: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.speed_empty_up || '-'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.speed_empty_down || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, speed_empty_down: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ speed_empty_down: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.speed_empty_down || '-')
                    ),
                    // Ligne Mi-charge
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', padding: '8px 12px', borderBottom: '1px solid #E5E7EB', alignItems: 'center', background: '#F9FAFB' } },
                        h('div', { style: { fontSize: 13 } }, 'Mi-charge'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.speed_half_up || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, speed_half_up: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ speed_half_up: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.speed_half_up || '-'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.speed_half_down || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, speed_half_down: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ speed_half_down: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.speed_half_down || '-')
                    ),
                    // Ligne Pleine charge
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', padding: '8px 12px', alignItems: 'center' } },
                        h('div', { style: { fontSize: 13 } }, 'Pleine charge'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.speed_full_up || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, speed_full_up: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ speed_full_up: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.speed_full_up || '-'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.speed_full_down || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, speed_full_down: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ speed_full_down: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.speed_full_down || '-')
                    )
                ),
                h('div', { style: { marginTop: 8, fontSize: 11, color: '#1D4ED8', fontStyle: 'italic' } }, 
                    canEdit ? '💡 Les valeurs sont sauvegardées automatiquement' : ''
                )
            ),
            // Mesures d'intensité (A) - Tableau avec montée/descente
            h('div', { style: { marginBottom: 20, padding: 16, background: '#FEF3C7', borderRadius: 12, border: '2px solid #F59E0B' } },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                    h('h4', { style: { margin: 0, color: '#F59E0B', display: 'flex', alignItems: 'center', gap: 8 } }, '🔌 Mesures d\'intensité (A)')
                ),
                // Tableau des mesures d'ampérage
                h('div', { style: { background: 'white', borderRadius: 8, overflow: 'hidden', border: '1px solid #E5E7EB' } },
                    // En-tête
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', background: '#F3F4F6', padding: '10px 12px', borderBottom: '1px solid #E5E7EB' } },
                        h('div', { style: { fontWeight: 600, fontSize: 13 } }, 'Charge'),
                        h('div', { style: { fontWeight: 600, fontSize: 13, color: '#10B981', textAlign: 'center' } }, '↑ Montée'),
                        h('div', { style: { fontWeight: 600, fontSize: 13, color: '#3B82F6', textAlign: 'center' } }, '↓ Descente')
                    ),
                    // Ligne À vide
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', padding: '8px 12px', borderBottom: '1px solid #E5E7EB', alignItems: 'center' } },
                        h('div', { style: { fontSize: 13 } }, 'À vide'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.amp_empty_up || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, amp_empty_up: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ amp_empty_up: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.amp_empty_up || '-'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.amp_empty_down || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, amp_empty_down: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ amp_empty_down: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.amp_empty_down || '-')
                    ),
                    // Ligne Mi-charge
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', padding: '8px 12px', borderBottom: '1px solid #E5E7EB', alignItems: 'center', background: '#F9FAFB' } },
                        h('div', { style: { fontSize: 13 } }, 'Mi-charge'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.amp_half_up || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, amp_half_up: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ amp_half_up: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.amp_half_up || '-'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.amp_half_down || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, amp_half_down: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ amp_half_down: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.amp_half_down || '-')
                    ),
                    // Ligne Pleine charge
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', padding: '8px 12px', alignItems: 'center' } },
                        h('div', { style: { fontSize: 13 } }, 'Pleine charge'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.amp_full_up || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, amp_full_up: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ amp_full_up: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.amp_full_up || '-'),
                        canEdit ? h('input', { 
                            type: 'text', 
                            value: viewReport.amp_full_down || '', 
                            placeholder: '0.0',
                            style: { width: '100%', padding: '6px 10px', border: '1px solid #D1D5DB', borderRadius: 6, textAlign: 'center', fontSize: 14 },
                            onChange: (e) => setViewReport({ ...viewReport, amp_full_down: e.target.value }),
                            onBlur: async (e) => {
                                const val = e.target.value || null;
                                await db.from('inspection_reports').update({ amp_full_down: val }).eq('id', viewReport.id);
                            }
                        }) : h('div', { style: { textAlign: 'center', fontWeight: 500 } }, viewReport.amp_full_down || '-')
                    )
                ),
                // Note
                h('div', { style: { marginTop: 8, fontSize: 11, color: '#92400E', fontStyle: 'italic' } }, 
                    canEdit ? '💡 Les valeurs sont sauvegardées automatiquement' : ''
                )
            )
        )),
        // Add BC Report Modal
        h(Modal, { isOpen: showAddBCModal, onClose: () => { setShowAddBCModal(false); setBcPdfFile(null); setBcPhotos([]); setBcFormStatus('en_attente'); setBcFormReserves([]); }, title: 'Nouveau rapport Bureau de Contrôle', size: 'lg' },
            h('form', { onSubmit: saveBCReport },
                // Section Informations BC
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.primary, fontWeight: 600 } },
                        h(Icon, { name: 'checkCircle', size: 18 }),
                        'Informations du contrôle'
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Bureau de contrôle *'), 
                            h('select', { name: 'control_office', required: true, className: 'form-select' },
                                h('option', { value: '' }, '-- Sélectionner --'),
                                h('option', { value: 'APAVE' }, 'APAVE'),
                                h('option', { value: 'SOCOTEC' }, 'SOCOTEC'),
                                h('option', { value: 'BUREAU VERITAS' }, 'BUREAU VERITAS'),
                                h('option', { value: 'DEKRA' }, 'DEKRA'),
                                h('option', { value: 'QUALICONSULT' }, 'QUALICONSULT'),
                                h('option', { value: 'AUTRE' }, 'Autre...')
                            )
                        ),
                        h('div', { className: 'form-group' }, 
                            h('label', null, 'Date du rapport *'), 
                            h('input', { name: 'report_date', type: 'date', required: true, defaultValue: new Date().toISOString().split('T')[0], className: 'form-input' })
                        )
                    )
                ),
                // Section Résultat
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.primary, fontWeight: 600 } },
                        h(Icon, { name: 'clipboard', size: 18 }),
                        'Résultat du contrôle'
                    ),
                    h('div', { className: 'form-group', style: { marginBottom: 16 } }, 
                        h('label', null, 'Résultat *'), 
                        h('div', { style: { display: 'flex', gap: 12, marginTop: 8 } },
                            h('label', { 
                                style: { 
                                    flex: 1, display: 'flex', alignItems: 'center', gap: 8, padding: 12, 
                                    background: bcFormStatus === 'en_attente' ? '#FEF3C7' : 'white', 
                                    borderRadius: 8, border: `2px solid ${bcFormStatus === 'en_attente' ? COLORS.warning : COLORS.border}`, 
                                    cursor: 'pointer', transition: 'all 0.3s ease' 
                                },
                                onClick: () => setBcFormStatus('en_attente')
                            },
                                h('input', { type: 'radio', name: 'status', value: 'en_attente', checked: bcFormStatus === 'en_attente', onChange: () => setBcFormStatus('en_attente') }),
                                h('span', { style: { color: COLORS.warning, fontWeight: bcFormStatus === 'en_attente' ? 600 : 400 } }, '⏳ En attente')
                            ),
                            h('label', { 
                                style: { 
                                    flex: 1, display: 'flex', alignItems: 'center', gap: 8, padding: 12, 
                                    background: bcFormStatus === 'conforme' ? '#D1FAE5' : 'white', 
                                    borderRadius: 8, border: `2px solid ${bcFormStatus === 'conforme' ? COLORS.success : COLORS.border}`, 
                                    cursor: 'pointer', transition: 'all 0.3s ease' 
                                },
                                onClick: () => setBcFormStatus('conforme')
                            },
                                h('input', { type: 'radio', name: 'status', value: 'conforme', checked: bcFormStatus === 'conforme', onChange: () => setBcFormStatus('conforme') }),
                                h('span', { style: { color: COLORS.success, fontWeight: bcFormStatus === 'conforme' ? 600 : 400 } }, '✅ Conforme')
                            ),
                            h('label', { 
                                style: { 
                                    flex: 1, display: 'flex', alignItems: 'center', gap: 8, padding: 12, 
                                    background: bcFormStatus === 'non_conforme' ? '#FEE2E2' : 'white', 
                                    borderRadius: 8, border: `2px solid ${bcFormStatus === 'non_conforme' ? COLORS.danger : COLORS.border}`, 
                                    cursor: 'pointer', transition: 'all 0.3s ease' 
                                },
                                onClick: () => setBcFormStatus('non_conforme')
                            },
                                h('input', { type: 'radio', name: 'status', value: 'non_conforme', checked: bcFormStatus === 'non_conforme', onChange: () => setBcFormStatus('non_conforme') }),
                                h('span', { style: { color: COLORS.danger, fontWeight: bcFormStatus === 'non_conforme' ? 600 : 400 } }, '❌ Non conforme')
                            )
                        )
                    ),
                    // Section Suivi des réserves (visible uniquement si non conforme)
                    bcFormStatus === 'non_conforme' && h('div', { 
                        style: { 
                            marginTop: 16, padding: 16, background: '#FFFBEB', borderRadius: 12, 
                            border: '2px solid #FCD34D', animation: 'fadeInUp 0.3s ease-out' 
                        } 
                    },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                            h('h4', { style: { margin: 0, color: '#92400E', display: 'flex', alignItems: 'center', gap: 8 } }, 
                                '📋 Suivi des réserves',
                                bcFormReserves.length > 0 && h('span', { style: { fontSize: 12, background: '#FCD34D', color: '#92400E', padding: '2px 8px', borderRadius: 10 } }, 
                                    bcFormReserves.length
                                )
                            ),
                            h('button', { 
                                type: 'button',
                                className: 'btn btn-sm', 
                                style: { background: '#F59E0B', color: 'white' },
                                onClick: () => {
                                    const desc = prompt('Description de la réserve:');
                                    if (desc && desc.trim()) {
                                        setBcFormReserves(prev => [...prev, { id: Date.now(), description: desc.trim(), resolved: false }]);
                                    }
                                }
                            }, h(Icon, { name: 'plus', size: 14 }), ' Ajouter')
                        ),
                        bcFormReserves.length === 0 
                            ? h('div', { style: { textAlign: 'center', padding: 20, color: '#92400E', fontSize: 13 } }, 
                                h('div', { style: { fontSize: 24, marginBottom: 8 } }, '📝'),
                                'Ajoutez les réserves à lever'
                            )
                            : h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                                bcFormReserves.map((item, idx) => h('div', { 
                                    key: item.id, 
                                    style: { 
                                        display: 'flex', alignItems: 'center', gap: 12, padding: '12px 16px', 
                                        background: item.resolved ? '#D1FAE5' : 'white', borderRadius: 8,
                                        border: `1px solid ${item.resolved ? '#10B981' : '#E5E7EB'}`,
                                        transition: 'all 0.3s ease'
                                    } 
                                },
                                    h('input', { 
                                        type: 'checkbox', 
                                        className: 'checkbox-success',
                                        checked: item.resolved,
                                        onChange: () => {
                                            setBcFormReserves(prev => prev.map(r => 
                                                r.id === item.id ? { ...r, resolved: !r.resolved } : r
                                            ));
                                        }
                                    }),
                                    h('div', { style: { flex: 1, fontWeight: 500, textDecoration: item.resolved ? 'line-through' : 'none', color: item.resolved ? '#059669' : '#1F2937' } }, item.description),
                                    h('button', { 
                                        type: 'button',
                                        className: 'btn btn-ghost btn-sm',
                                        style: { color: COLORS.danger, padding: 4 },
                                        onClick: () => setBcFormReserves(prev => prev.filter(r => r.id !== item.id))
                                    }, h(Icon, { name: 'x', size: 16 }))
                                ))
                            )
                    )
                ),
                // Section Observations
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.primary, fontWeight: 600 } },
                        h(Icon, { name: 'file', size: 18 }),
                        'Observations'
                    ),
                    h('div', { className: 'form-group' }, 
                        h('label', null, 'Observations du bureau de contrôle'), 
                        h('textarea', { name: 'observations', rows: 4, className: 'form-textarea', placeholder: 'Observations, remarques, commentaires...' })
                    )
                ),
                // Section Documents et Photos
                h('div', { style: { marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16, color: COLORS.primary, fontWeight: 600 } },
                        h(Icon, { name: 'camera', size: 18 }),
                        'Documents et photos'
                    ),
                    // Upload PDF
                    h('div', { className: 'form-group', style: { marginBottom: 16 } },
                        h('label', null, 'Rapport PDF du bureau de contrôle'),
                        h('div', { 
                            style: { 
                                border: `2px dashed ${bcPdfFile ? COLORS.success : COLORS.border}`,
                                borderRadius: 12,
                                padding: 20,
                                textAlign: 'center',
                                background: bcPdfFile ? '#D1FAE5' : 'white',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            },
                            onClick: () => document.getElementById('bc-pdf-input').click()
                        },
                            h('input', { 
                                type: 'file', 
                                id: 'bc-pdf-input',
                                accept: '.pdf',
                                style: { display: 'none' },
                                onChange: (e) => {
                                    const file = e.target.files[0];
                                    if (file) setBcPdfFile(file);
                                }
                            }),
                            bcPdfFile ? 
                                h('div', null,
                                    h('div', { style: { fontSize: 32, marginBottom: 8 } }, '📄'),
                                    h('div', { style: { fontWeight: 600, color: COLORS.success } }, bcPdfFile.name),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 4 } }, `${(bcPdfFile.size / 1024).toFixed(1)} Ko`),
                                    h('button', { 
                                        type: 'button',
                                        className: 'btn btn-sm btn-danger',
                                        style: { marginTop: 8 },
                                        onClick: (e) => { e.stopPropagation(); setBcPdfFile(null); }
                                    }, 'Supprimer')
                                ) :
                                h('div', null,
                                    h('div', { style: { fontSize: 32, marginBottom: 8 } }, '📁'),
                                    h('div', { style: { fontWeight: 500, color: COLORS.text } }, 'Cliquez pour ajouter un PDF'),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 4 } }, 'Format PDF uniquement')
                                )
                        )
                    ),
                    // Upload Photos
                    h('div', { className: 'form-group' },
                        h('label', null, 'Photos du rapport'),
                        h('div', { 
                            style: { 
                                border: `2px dashed ${bcPhotos.length > 0 ? COLORS.info : COLORS.border}`,
                                borderRadius: 12,
                                padding: 20,
                                textAlign: 'center',
                                background: bcPhotos.length > 0 ? '#EFF6FF' : 'white',
                                cursor: 'pointer',
                                transition: 'all 0.2s'
                            },
                            onClick: () => document.getElementById('bc-photos-input').click()
                        },
                            h('input', { 
                                type: 'file', 
                                id: 'bc-photos-input',
                                accept: 'image/*',
                                multiple: true,
                                style: { display: 'none' },
                                onChange: (e) => {
                                    const files = Array.from(e.target.files);
                                    if (files.length > 0) setBcPhotos(prev => [...prev, ...files]);
                                }
                            }),
                            h('div', { style: { fontSize: 32, marginBottom: 8 } }, '📷'),
                            h('div', { style: { fontWeight: 500, color: COLORS.text } }, 'Cliquez pour ajouter des photos'),
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 4 } }, 'JPG, PNG, WEBP')
                        ),
                        bcPhotos.length > 0 && h('div', { style: { marginTop: 16 } },
                            h('div', { style: { fontSize: 13, fontWeight: 600, marginBottom: 8, color: COLORS.info } }, `${bcPhotos.length} photo(s) sélectionnée(s)`),
                            h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                                bcPhotos.map((photo, idx) => h('div', { 
                                    key: idx, 
                                    style: { 
                                        position: 'relative',
                                        width: 80, 
                                        height: 80, 
                                        borderRadius: 8, 
                                        overflow: 'hidden',
                                        border: `2px solid ${COLORS.border}`
                                    } 
                                },
                                    h('img', { 
                                        src: URL.createObjectURL(photo), 
                                        style: { width: '100%', height: '100%', objectFit: 'cover' } 
                                    }),
                                    h('button', { 
                                        type: 'button',
                                        style: { 
                                            position: 'absolute', 
                                            top: 2, 
                                            right: 2, 
                                            width: 20, 
                                            height: 20, 
                                            borderRadius: '50%', 
                                            background: COLORS.danger, 
                                            color: 'white', 
                                            border: 'none', 
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontSize: 12
                                        },
                                        onClick: (e) => { 
                                            e.stopPropagation(); 
                                            setBcPhotos(prev => prev.filter((_, i) => i !== idx)); 
                                        }
                                    }, '×')
                                ))
                            )
                        )
                    )
                ),
                // Boutons
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 12, paddingTop: 16, borderTop: `1px solid ${COLORS.border}` } }, 
                    h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => { setShowAddBCModal(false); setBcPdfFile(null); setBcPhotos([]); setBcFormStatus('en_attente'); setBcFormReserves([]); } }, 'Annuler'), 
                    h('button', { type: 'submit', className: 'btn btn-primary' }, h(Icon, { name: 'plus', size: 16 }), 'Créer le rapport BC')
                )
            )
        ),
        // View BC Report Modal
        h(Modal, { isOpen: !!viewBCReport, onClose: () => setViewBCReport(null), title: viewBCReport?.control_office || 'Rapport BC', size: 'lg',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => exportBCReportPDF(viewBCReport, viewDevice) }, h(Icon, { name: 'pdf', size: 16 }), 'Export PDF'),
                canEdit && h('button', { className: 'btn btn-primary', onClick: () => setEditBCReport(viewBCReport) }, h(Icon, { name: 'edit', size: 16 }), 'Modifier'),
                canEdit && h('button', { className: 'btn btn-danger', onClick: async () => {
                    if (confirm('Supprimer ce rapport ?')) {
                        await db.from('control_reports').delete().eq('id', viewBCReport.id);
                        showToast('Rapport supprimé', 'success');
                        db.from('control_reports').select('*').eq('device_id', viewDevice.id).then(({ data }) => setControlReports(data || []));
                        setViewBCReport(null);
                    }
                }}, h(Icon, { name: 'trash', size: 16 }), 'Supprimer')
            )
        }, viewBCReport && h('div', null,
            // Statut et réserves levées
            h('div', { style: { display: 'flex', gap: 12, marginBottom: 20, alignItems: 'center', flexWrap: 'wrap' } },
                h('span', { className: `badge badge-${getBCStatusInfo(viewBCReport.status).color}`, style: { fontSize: 14, padding: '8px 16px' } }, getBCStatusInfo(viewBCReport.status).label),
                viewBCReport.reserves_lifted && h('span', { className: 'badge badge-success', style: { fontSize: 12 } }, '✓ Réserves levées'),
                canEdit && h('label', { style: { display: 'flex', alignItems: 'center', gap: 10, cursor: 'pointer', padding: '8px 16px', background: viewBCReport.reserves_lifted ? '#D1FAE5' : '#F1F5F9', borderRadius: 10, transition: 'all 0.3s ease' } },
                    h('input', { 
                        type: 'checkbox', 
                        className: 'checkbox-success',
                        checked: viewBCReport.reserves_lifted || false,
                        onChange: async (e) => {
                            await db.from('control_reports').update({ reserves_lifted: e.target.checked }).eq('id', viewBCReport.id);
                            showToast('Mise à jour', 'success');
                            db.from('control_reports').select('*').eq('device_id', viewDevice.id).then(({ data }) => setControlReports(data || []));
                            setViewBCReport({ ...viewBCReport, reserves_lifted: e.target.checked });
                        }
                    }),
                    h('span', { style: { fontSize: 13, fontWeight: 600, color: viewBCReport.reserves_lifted ? COLORS.success : COLORS.text } }, 'Réserves levées')
                )
            ),
            // Informations principales
            h('div', { className: 'info-grid', style: { marginBottom: 20 } },
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Bureau de contrôle'), h('div', { className: 'info-value', style: { fontWeight: 600 } }, viewBCReport.control_office || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'N° Rapport'), h('div', { className: 'info-value' }, viewBCReport.report_number || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Date du rapport'), h('div', { className: 'info-value' }, formatDate(viewBCReport.report_date)))
            ),
            // Observations
            viewBCReport.observations && h('div', { style: { marginBottom: 16, padding: 16, background: '#f8fafc', borderRadius: 12 } }, 
                h('h4', { style: { marginBottom: 8, color: '#1e293b' } }, '📋 Observations'),
                h('p', { style: { whiteSpace: 'pre-wrap', color: '#64748b' } }, viewBCReport.observations)
            ),
            // Réserves restantes (texte général)
            viewBCReport.remaining_reserves && h('div', { style: { marginBottom: 16, padding: 16, background: '#FEF2F2', borderRadius: 12, border: '2px solid #EF4444' } }, 
                h('h4', { style: { marginBottom: 8, color: '#EF4444' } }, '⚠️ Réserves (description générale)'),
                h('p', { style: { whiteSpace: 'pre-wrap', color: '#991B1B' } }, viewBCReport.remaining_reserves)
            ),
            // Section Réserves individuelles
            h('div', { style: { marginBottom: 16, padding: 16, background: '#FFFBEB', borderRadius: 12, border: '1px solid #FCD34D' } },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 } },
                    h('h4', { style: { margin: 0, color: '#92400E', display: 'flex', alignItems: 'center', gap: 8 } }, 
                        '📋 Suivi des réserves',
                        bcReserveItems.length > 0 && h('span', { style: { fontSize: 12, background: '#FCD34D', color: '#92400E', padding: '2px 8px', borderRadius: 10 } }, 
                            `${bcReserveItems.filter(i => i.is_resolved).length}/${bcReserveItems.length} levées`
                        )
                    ),
                    canEdit && h('button', { 
                        className: 'btn btn-sm', 
                        style: { background: '#F59E0B', color: 'white' },
                        onClick: () => {
                            const desc = prompt('Description de la réserve à ajouter:');
                            if (desc) addBcReserveItem(desc);
                        }
                    }, h(Icon, { name: 'plus', size: 14 }), ' Ajouter')
                ),
                bcReserveItems.length === 0 
                    ? h('div', { style: { textAlign: 'center', padding: 20, color: '#92400E' } }, 'Aucune réserve individuelle')
                    : h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                        bcReserveItems.map(item => h('div', { 
                            key: item.id, 
                            style: { 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: 12, 
                                padding: '12px 16px', 
                                background: item.is_resolved ? '#D1FAE5' : 'white', 
                                borderRadius: 8,
                                border: `1px solid ${item.is_resolved ? '#10B981' : '#E5E7EB'}`,
                                transition: 'all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)'
                            } 
                        },
                            canEdit && h('input', { 
                                type: 'checkbox', 
                                className: 'checkbox-success checkbox-lg',
                                checked: item.is_resolved,
                                onChange: () => toggleBcReserveItem(item.id, !item.is_resolved)
                            }),
                            h('div', { style: { flex: 1 } },
                                h('div', { style: { fontWeight: 500, textDecoration: item.is_resolved ? 'line-through' : 'none', color: item.is_resolved ? '#059669' : '#1F2937' } }, item.description),
                                item.is_resolved && item.resolved_at && h('div', { style: { fontSize: 11, color: '#059669', marginTop: 2 } }, '✓ Levée le ', formatDate(item.resolved_at))
                            ),
                            !canEdit && h('span', { 
                                className: `badge badge-${item.is_resolved ? 'success' : 'warning'}`,
                                style: { fontSize: 11 }
                            }, item.is_resolved ? '✓ Levée' : '⏳ En attente'),
                            canEdit && h('button', { 
                                className: 'btn btn-ghost btn-xs',
                                style: { color: COLORS.danger },
                                onClick: () => {
                                    if (confirm('Supprimer cette réserve ?')) deleteBcReserveItem(item.id);
                                }
                            }, h(Icon, { name: 'trash', size: 14 }))
                        ))
                    ),
                // Message si toutes les réserves sont levées
                bcReserveItems.length > 0 && bcReserveItems.every(i => i.is_resolved) && !viewBCReport.reserves_lifted && 
                    h('div', { style: { marginTop: 12, padding: 12, background: '#D1FAE5', borderRadius: 8, textAlign: 'center' } },
                        h('span', { style: { color: '#059669', fontWeight: 600 } }, '✅ Toutes les réserves sont levées ! La case "Réserves levées" a été cochée automatiquement.')
                    )
            ),
            // Document PDF
            h('div', { style: { marginBottom: 16 } },
                h('h4', { style: { marginBottom: 12 } }, '📎 Document PDF'),
                viewBCReport.document_url ? 
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                        h('a', { href: viewBCReport.document_url, target: '_blank', className: 'btn btn-secondary btn-sm' }, h(Icon, { name: 'folder', size: 14 }), ' Voir le document'),
                        canEdit && h('button', { className: 'btn btn-ghost btn-sm', style: { color: '#EF4444' }, onClick: async () => {
                            await db.from('control_reports').update({ document_url: null }).eq('id', viewBCReport.id);
                            setViewBCReport({ ...viewBCReport, document_url: null });
                            showToast('Document supprimé', 'success');
                        }}, h(Icon, { name: 'x', size: 14 }))
                    ) :
                    canEdit && h('label', { className: 'btn btn-secondary btn-sm', style: { cursor: 'pointer' } },
                        h(Icon, { name: 'upload', size: 14 }), ' Ajouter un PDF',
                        h('input', { 
                            type: 'file', 
                            accept: 'application/pdf', 
                            style: { display: 'none' },
                            onChange: async (e) => {
                                const file = e.target.files?.[0];
                                if (file) {
                                    try {
                                        const fileName = 'bc-doc-' + viewBCReport.id + '-' + Date.now() + '.pdf';
                                        const { error: uploadError } = await db.storage.from('documents').upload(fileName, file);
                                        if (uploadError) throw uploadError;
                                        const { data: urlData } = db.storage.from('documents').getPublicUrl(fileName);
                                        await db.from('control_reports').update({ document_url: urlData.publicUrl }).eq('id', viewBCReport.id);
                                        setViewBCReport({ ...viewBCReport, document_url: urlData.publicUrl });
                                        showToast('Document ajouté', 'success');
                                    } catch (err) {
                                        showToast('Erreur upload: ' + err.message, 'error');
                                    }
                                }
                            }
                        })
                    )
                )
            ),
            // Photos
            h('div', { style: { marginBottom: 16 } },
                h('h4', { style: { marginBottom: 12 } }, '📷 Photos'),
                h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(100px, 1fr))', gap: 12 } },
                    getBcPhotoUrls(viewBCReport).map((url, idx) => h('div', { key: idx, style: { position: 'relative' } },
                        h('img', { src: url, alt: '', style: { width: '100%', height: 100, objectFit: 'cover', borderRadius: 8, cursor: 'pointer' }, onClick: () => window.open(url, '_blank') }),
                        canEdit && h('button', { 
                            style: { position: 'absolute', top: 4, right: 4, width: 24, height: 24, borderRadius: '50%', background: 'rgba(239,68,68,0.9)', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' },
                            onClick: async () => {
                                const urls = getBcPhotoUrls(viewBCReport).filter((_, i) => i !== idx);
                                await db.from('control_reports').update({ photo_urls: JSON.stringify(urls) }).eq('id', viewBCReport.id);
                                setViewBCReport({ ...viewBCReport, photo_urls: JSON.stringify(urls) });
                                db.from('control_reports').select('*').eq('device_id', viewDevice.id).then(({ data }) => setControlReports(data || []));
                                showToast('Photo supprimée', 'success');
                            }
                        }, h(Icon, { name: 'x', size: 12, color: 'white' }))
                    )),
                    canEdit && h('label', { style: { display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: 100, background: '#f8fafc', borderRadius: 8, border: '2px dashed #e5e7eb', cursor: 'pointer' } },
                        h(Icon, { name: 'camera', size: 24, color: '#94a3b8' }),
                        h('span', { style: { fontSize: 11, color: '#94a3b8', marginTop: 4 } }, 'Ajouter'),
                        h('input', { 
                            type: 'file', 
                            accept: 'image/*', 
                            style: { display: 'none' },
                            onChange: async (e) => {
                                const file = e.target.files?.[0];
                                if (file) {
                                    try {
                                        const fileName = 'bc-photo-' + viewBCReport.id + '-' + Date.now() + '.' + file.name.split('.').pop();
                                        const { error: uploadError } = await db.storage.from('control-photos').upload(fileName, file);
                                        if (uploadError) throw uploadError;
                                        const { data: urlData } = db.storage.from('control-photos').getPublicUrl(fileName);
                                        const currentUrls = getBcPhotoUrls(viewBCReport);
                                        const newUrls = [...currentUrls, urlData.publicUrl];
                                        await db.from('control_reports').update({ photo_urls: JSON.stringify(newUrls) }).eq('id', viewBCReport.id);
                                        setViewBCReport({ ...viewBCReport, photo_urls: JSON.stringify(newUrls) });
                                        db.from('control_reports').select('*').eq('device_id', viewDevice.id).then(({ data }) => setControlReports(data || []));
                                        showToast('Photo ajoutée', 'success');
                                    } catch (err) {
                                        showToast('Erreur upload: ' + err.message, 'error');
                                    }
                                }
                            }
                        })
                    )
                )
            ),
            // Historique
            h('div', { style: { fontSize: 12, color: '#94a3b8', marginTop: 16, paddingTop: 16, borderTop: '1px solid #e5e7eb' } },
                'Créé le ' + formatDate(viewBCReport?.created_at)
            )
        )),
        // Edit BC Report Modal
        h(Modal, { isOpen: !!editBCReport, onClose: () => setEditBCReport(null), title: 'Modifier le rapport BC', size: 'lg' },
            editBCReport && h('form', { onSubmit: updateBCReport },
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' },
                        h('label', null, 'Bureau de contrôle *'),
                        h('input', { name: 'control_office', className: 'form-input', required: true, defaultValue: editBCReport.control_office })
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'N° Rapport'),
                        h('input', { name: 'report_number', className: 'form-input', defaultValue: editBCReport.report_number || '' })
                    )
                ),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' },
                        h('label', null, 'Date du rapport *'),
                        h('input', { name: 'report_date', type: 'date', className: 'form-input', required: true, defaultValue: editBCReport.report_date })
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Statut'),
                        h('div', { style: { padding: '10px 0' } },
                            h('span', { className: `badge badge-${getBCStatusInfo(editBCReport.status).color}`, style: { fontSize: 14, padding: '8px 16px' } }, getBCStatusInfo(editBCReport.status).label)
                        )
                    )
                ),
                h('div', { className: 'form-group' },
                    h('label', null, 'Observations'),
                    h('textarea', { name: 'observations', className: 'form-textarea', rows: 4, defaultValue: editBCReport.observations || '' })
                ),
                h('div', { className: 'form-group' },
                    h('label', { style: { color: '#DC2626' } }, '⚠️ Réserves'),
                    h('textarea', { name: 'remaining_reserves', className: 'form-textarea', rows: 4, defaultValue: editBCReport.remaining_reserves || '', style: { borderColor: '#FECACA' } })
                ),
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 12, paddingTop: 16, borderTop: `1px solid ${COLORS.border}` } },
                    h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => setEditBCReport(null) }, 'Annuler'),
                    h('button', { type: 'submit', className: 'btn btn-primary' }, h(Icon, { name: 'check', size: 16 }), 'Enregistrer')
                )
            )
        ),
        // Add Checkpoint Modal
        h(Modal, { isOpen: showAddCheckpointModal, onClose: () => setShowAddCheckpointModal(false), title: 'Ajouter un point de contrôle' },
            h('form', { onSubmit: saveCheckpoint },
                h('div', { className: 'form-group' }, h('label', null, 'Section *'), 
                    h('select', { name: 'section', required: true },
                        h('option', { value: '' }, '-- Sélectionner --'),
                        checkpointSections.map(s => h('option', { key: s, value: s }, s.charAt(0).toUpperCase() + s.slice(1)))
                    )
                ),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Code'), h('input', { name: 'checkpoint_code', placeholder: 'Ex: M1.1' })),
                    h('div', { className: 'form-group' }, h('label', null, 'Libellé *'), h('input', { name: 'checkpoint_label', required: true, placeholder: 'Ex: Limiteur de vitesse' }))
                ),
                h('div', { className: 'form-group' }, h('label', null, 'Détails'), h('input', { name: 'checkpoint_detail', placeholder: 'Précisions supplémentaires' })),
                h('div', { className: 'form-group' }, h('label', null, 'Statut'), 
                    h('select', { name: 'status', defaultValue: 'C' },
                        h('option', { value: 'C' }, 'Conforme'),
                        h('option', { value: 'NC' }, 'Non Conforme'),
                        h('option', { value: 'NA' }, 'Non Applicable')
                    )
                ),
                h('div', { className: 'form-group' }, h('label', null, 'Mesure'), h('input', { name: 'measurement', placeholder: 'Ex: 1.2 m/s' })),
                h('div', { className: 'form-group' }, h('label', null, 'Remarques'), h('textarea', { name: 'remarks', rows: 2 })),
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 10, marginTop: 20 } },
                    h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => setShowAddCheckpointModal(false) }, 'Annuler'),
                    h('button', { type: 'submit', className: 'btn btn-primary' }, 'Ajouter')
                )
            )
        ),
        // Archives Modal
        h(Modal, { isOpen: showArchivesModal && !viewArchivedDevice, onClose: () => { setShowArchivesModal(false); setArchiveSearch(''); setArchiveDateFrom(''); setArchiveDateTo(''); }, title: `📦 Appareils archivés`, size: 'xl' },
            // Barre de recherche et filtres
            h('div', { style: { marginBottom: 20, padding: 16, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                // Recherche
                h('div', { style: { marginBottom: 12 } },
                    h('div', { style: { position: 'relative' } },
                        h('input', {
                            type: 'text',
                            placeholder: 'Rechercher par n° appareil, site, ville...',
                            value: archiveSearch,
                            onChange: (e) => setArchiveSearch(e.target.value),
                            className: 'form-input',
                            style: { paddingLeft: 40 }
                        }),
                        h('div', { style: { position: 'absolute', left: 12, top: '50%', transform: 'translateY(-50%)', color: COLORS.muted } },
                            h(Icon, { name: 'search', size: 18 })
                        )
                    )
                ),
                // Filtres de dates et export
                h('div', { style: { display: 'flex', gap: 12, flexWrap: 'wrap', alignItems: 'flex-end' } },
                    h('div', { className: 'form-group', style: { margin: 0, flex: '1 1 150px' } },
                        h('label', { style: { fontSize: 12, marginBottom: 4 } }, 'Date début'),
                        h('input', {
                            type: 'date',
                            value: archiveDateFrom,
                            onChange: (e) => setArchiveDateFrom(e.target.value),
                            className: 'form-input'
                        })
                    ),
                    h('div', { className: 'form-group', style: { margin: 0, flex: '1 1 150px' } },
                        h('label', { style: { fontSize: 12, marginBottom: 4 } }, 'Date fin'),
                        h('input', {
                            type: 'date',
                            value: archiveDateTo,
                            onChange: (e) => setArchiveDateTo(e.target.value),
                            className: 'form-input'
                        })
                    ),
                    h('button', { 
                        className: 'btn btn-secondary btn-sm',
                        onClick: () => { setArchiveSearch(''); setArchiveDateFrom(''); setArchiveDateTo(''); },
                        style: { height: 38 }
                    }, h(Icon, { name: 'x', size: 14 }), 'Réinitialiser'),
                    h('button', { 
                        className: 'btn btn-primary btn-sm',
                        onClick: exportArchivedDevicesPDF,
                        disabled: filteredArchivedDevices.length === 0,
                        style: { height: 38 }
                    }, h(Icon, { name: 'pdf', size: 14 }), `Export PDF (${filteredArchivedDevices.length})`)
                )
            ),
            // Résultat
            h('div', { style: { marginBottom: 12, display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                h('span', { className: 'badge badge-secondary' }, `${filteredArchivedDevices.length} appareil(s)`),
                (archiveSearch || archiveDateFrom || archiveDateTo) && h('span', { style: { fontSize: 12, color: COLORS.muted } }, 'Filtres actifs')
            ),
            // Liste
            filteredArchivedDevices.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 
                h(Icon, { name: 'archive', size: 48 }),
                h('p', null, archivedDevices.length === 0 ? 'Aucun appareil archivé' : 'Aucun résultat pour cette recherche')
            ) :
            h('div', { style: { maxHeight: 400, overflowY: 'auto' } }, filteredArchivedDevices.map(d => h('div', { 
                key: d.id, 
                style: { padding: 16, marginBottom: 12, background: COLORS.background, borderRadius: 'var(--radius)', border: `1px solid ${COLORS.border}`, cursor: 'pointer', transition: 'all 0.2s' },
                onClick: () => setViewArchivedDevice(d),
                onMouseEnter: e => e.currentTarget.style.borderColor = COLORS.primary,
                onMouseLeave: e => e.currentTarget.style.borderColor = COLORS.border
            },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                    h('div', null,
                        h('div', { style: { fontFamily: 'monospace', fontWeight: 700, fontSize: 16, color: COLORS.primary } }, d.device_number),
                        h('div', { style: { fontSize: 14, color: COLORS.text, marginTop: 4 } }, d.site_name || '-'),
                        h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 4 } }, 
                            d.address_street && `${d.address_street}, `,
                            d.address_postal && `${d.address_postal} `,
                            d.address_city
                        ),
                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginTop: 4 } }, `Archivé le ${formatDate(d.archived_at)}`)
                    ),
                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                        h('span', { className: 'badge badge-secondary' }, 'Archivé'),
                        h(Icon, { name: 'chevronRight', size: 16, color: COLORS.muted })
                    )
                )
            )))
        ),
        // Modal détail appareil archivé
        h(Modal, { isOpen: !!viewArchivedDevice, onClose: () => setViewArchivedDevice(null), title: viewArchivedDevice?.device_number || 'Appareil archivé', size: 'xl',
            footer: h('div', { style: { display: 'flex', justifyContent: 'space-between', width: '100%' } },
                h('button', { className: 'btn btn-danger', onClick: () => setDeleteArchivedConfirm(viewArchivedDevice) }, h(Icon, { name: 'trash', size: 16 }), 'Supprimer'),
                h('button', { className: 'btn btn-secondary', onClick: () => setViewArchivedDevice(null) }, 'Fermer')
            )
        }, viewArchivedDevice && h('div', null,
            // En-tête avec badge
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20, padding: 16, background: '#F1F5F9', borderRadius: 12 } },
                h('div', null,
                    h('div', { style: { fontFamily: 'monospace', fontWeight: 700, fontSize: 24, color: COLORS.primary } }, viewArchivedDevice.device_number),
                    h('div', { style: { fontSize: 16, color: COLORS.text, marginTop: 4 } }, viewArchivedDevice.site_name || '-'),
                    viewArchivedDevice.building_type && h('span', { className: 'badge badge-info', style: { marginTop: 8 } }, 
                        viewArchivedDevice.building_type === 'autre' ? viewArchivedDevice.building_type_other : viewArchivedDevice.building_type
                    )
                ),
                h('div', { style: { textAlign: 'right' } },
                    h('span', { className: 'badge badge-secondary', style: { fontSize: 14, padding: '8px 16px' } }, '📦 Archivé'),
                    h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 8 } }, `Archivé le ${formatDate(viewArchivedDevice.archived_at)}`)
                )
            ),
            
            // Adresse
            h('div', { style: { marginBottom: 20, padding: 16, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                h('h4', { style: { margin: '0 0 12px 0', color: COLORS.primary, display: 'flex', alignItems: 'center', gap: 8 } }, h(Icon, { name: 'mapPin', size: 18 }), 'Adresse'),
                h('div', { className: 'info-grid' },
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Rue'), h('div', { className: 'info-value' }, viewArchivedDevice.address_street || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Code postal'), h('div', { className: 'info-value' }, viewArchivedDevice.address_postal || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Ville'), h('div', { className: 'info-value' }, viewArchivedDevice.address_city || '-'))
                )
            ),
            
            // Contact
            (viewArchivedDevice.contact_name || viewArchivedDevice.contact_phone || viewArchivedDevice.contact_email) && h('div', { style: { marginBottom: 20, padding: 16, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                h('h4', { style: { margin: '0 0 12px 0', color: COLORS.primary, display: 'flex', alignItems: 'center', gap: 8 } }, h(Icon, { name: 'user', size: 18 }), 'Contact'),
                h('div', { className: 'info-grid' },
                    viewArchivedDevice.contact_name && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Nom'), h('div', { className: 'info-value' }, viewArchivedDevice.contact_name)),
                    viewArchivedDevice.contact_phone && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Téléphone'), h('div', { className: 'info-value' }, viewArchivedDevice.contact_phone)),
                    viewArchivedDevice.contact_email && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Email'), h('div', { className: 'info-value' }, viewArchivedDevice.contact_email))
                )
            ),
            
            // Informations CE & Installation
            (viewArchivedDevice.ce_number || viewArchivedDevice.ce_date || viewArchivedDevice.installation_date) && h('div', { style: { marginBottom: 20, padding: 16, background: '#EFF6FF', borderRadius: 12, border: '1px solid #3B82F6' } },
                h('h4', { style: { margin: '0 0 12px 0', color: '#1D4ED8', display: 'flex', alignItems: 'center', gap: 8 } }, '📋 Informations CE & Installation'),
                h('div', { className: 'info-grid' },
                    viewArchivedDevice.ce_number && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'N° CE'), h('div', { className: 'info-value', style: { fontFamily: 'monospace', fontWeight: 600 } }, viewArchivedDevice.ce_number)),
                    viewArchivedDevice.ce_date && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Date CE'), h('div', { className: 'info-value' }, formatDate(viewArchivedDevice.ce_date))),
                    viewArchivedDevice.installation_date && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Date installation'), h('div', { className: 'info-value' }, formatDate(viewArchivedDevice.installation_date)))
                )
            ),
            
            // Caractéristiques techniques
            h('div', { style: { marginBottom: 20, padding: 16, background: COLORS.background, borderRadius: 12, border: `1px solid ${COLORS.border}` } },
                h('h4', { style: { margin: '0 0 12px 0', color: COLORS.primary, display: 'flex', alignItems: 'center', gap: 8 } }, h(Icon, { name: 'settings', size: 18 }), 'Caractéristiques techniques'),
                h('div', { className: 'info-grid' },
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Fabricant'), h('div', { className: 'info-value' }, viewArchivedDevice.manufacturer || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Fabricant MP'), h('div', { className: 'info-value' }, viewArchivedDevice.mp_manufacturer || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Modèle'), h('div', { className: 'info-value' }, viewArchivedDevice.model || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Type'), h('div', { className: 'info-value' }, viewArchivedDevice.elevator_type || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Charge'), h('div', { className: 'info-value' }, viewArchivedDevice.load_capacity ? `${viewArchivedDevice.load_capacity} kg` : '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Vitesse'), h('div', { className: 'info-value' }, viewArchivedDevice.speed ? `${viewArchivedDevice.speed} m/s` : '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Course'), h('div', { className: 'info-value' }, viewArchivedDevice.course ? `${viewArchivedDevice.course} m` : '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Niveaux'), h('div', { className: 'info-value' }, viewArchivedDevice.levels_count || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Cuvette'), h('div', { className: 'info-value' }, viewArchivedDevice.pit_depth ? `${viewArchivedDevice.pit_depth} m` : '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Hauteur sous dalle'), h('div', { className: 'info-value' }, viewArchivedDevice.headroom ? `${viewArchivedDevice.headroom} m` : '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Dimensions cabine'), h('div', { className: 'info-value' }, viewArchivedDevice.cabin_dimensions || '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Câbles'), h('div', { className: 'info-value' }, viewArchivedDevice.cables_count ? `${viewArchivedDevice.cables_count} x ${viewArchivedDevice.cables_diameter || '-'} mm` : '-')),
                    h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Mouflage'), h('div', { className: 'info-value' }, viewArchivedDevice.suspension_ratio || '-')),
                    viewArchivedDevice.dampers_free && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Amortisseurs'), h('div', { className: 'info-value' }, viewArchivedDevice.dampers_free)),
                    viewArchivedDevice.locks_free && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Serrures'), h('div', { className: 'info-value' }, viewArchivedDevice.locks_free))
                )
            ),
            
            // RAPPORTS D'INSPECTION
            h('div', { style: { marginBottom: 20, padding: 16, background: '#F0FDF4', borderRadius: 12, border: '1px solid #22C55E' } },
                h('h4', { style: { margin: '0 0 12px 0', color: '#15803D', display: 'flex', alignItems: 'center', gap: 8 } }, 
                    h(Icon, { name: 'check', size: 18 }), 
                    'Rapports d\'inspection',
                    h('span', { className: 'badge badge-success', style: { marginLeft: 8 } }, archivedDeviceReports.inspection.length)
                ),
                archivedDeviceReports.inspection.length === 0 
                    ? h('p', { style: { color: COLORS.muted, fontStyle: 'italic', margin: 0 } }, 'Aucun rapport d\'inspection')
                    : h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                        archivedDeviceReports.inspection.map(r => h('div', { 
                            key: r.id,
                            style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 12px', background: 'white', borderRadius: 8, border: '1px solid #E5E7EB', cursor: 'pointer' },
                            onClick: () => { setViewReport(r); setViewArchivedDevice(null); }
                        },
                            h('div', null,
                                h('div', { style: { fontWeight: 600, fontSize: 14 } }, `Inspection du ${formatDate(r.created_at)}`),
                                h('div', { style: { fontSize: 12, color: COLORS.muted } }, `Technicien: ${r.technician_name || '-'}`)
                            ),
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                h('span', { className: `badge badge-${r.status === 'conforme' ? 'success' : r.status === 'non_conforme' ? 'danger' : 'warning'}` }, 
                                    r.status === 'conforme' ? 'Conforme' : r.status === 'non_conforme' ? 'Non conforme' : 'En attente'
                                ),
                                h(Icon, { name: 'eye', size: 16, color: COLORS.primary })
                            )
                        ))
                    )
            ),
            
            // RAPPORTS BUREAU DE CONTRÔLE
            h('div', { style: { marginBottom: 20, padding: 16, background: '#FEF3C7', borderRadius: 12, border: '1px solid #F59E0B' } },
                h('h4', { style: { margin: '0 0 12px 0', color: '#92400E', display: 'flex', alignItems: 'center', gap: 8 } }, 
                    '🏛️ Rapports Bureau de Contrôle',
                    h('span', { className: 'badge badge-warning', style: { marginLeft: 8 } }, archivedDeviceReports.bc.length)
                ),
                archivedDeviceReports.bc.length === 0 
                    ? h('p', { style: { color: COLORS.muted, fontStyle: 'italic', margin: 0 } }, 'Aucun rapport BC')
                    : h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                        archivedDeviceReports.bc.map(r => h('div', { 
                            key: r.id,
                            style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 12px', background: 'white', borderRadius: 8, border: '1px solid #E5E7EB', cursor: 'pointer' },
                            onClick: () => { setViewBCReport(r); setViewArchivedDevice(null); }
                        },
                            h('div', null,
                                h('div', { style: { fontWeight: 600, fontSize: 14 } }, `Rapport BC du ${formatDate(r.created_at)}`),
                                h('div', { style: { fontSize: 12, color: COLORS.muted } }, `Organisme: ${r.organization || '-'}`)
                            ),
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                h('span', { className: `badge badge-${r.status === 'favorable' ? 'success' : r.status === 'defavorable' ? 'danger' : 'warning'}` }, 
                                    r.status === 'favorable' ? 'Favorable' : r.status === 'defavorable' ? 'Défavorable' : 'En attente'
                                ),
                                h(Icon, { name: 'eye', size: 16, color: COLORS.primary })
                            )
                        ))
                    )
            ),
            
            // Notes
            viewArchivedDevice.notes && h('div', { style: { marginBottom: 20, padding: 16, background: '#F3F4F6', borderRadius: 12, border: '1px solid #9CA3AF' } },
                h('h4', { style: { margin: '0 0 12px 0', color: '#374151', display: 'flex', alignItems: 'center', gap: 8 } }, h(Icon, { name: 'notes', size: 18 }), 'Notes'),
                h('p', { style: { margin: 0, whiteSpace: 'pre-wrap' } }, viewArchivedDevice.notes)
            ),
            
            // Réserves
            viewArchivedDevice.reserves && h('div', { style: { marginBottom: 20, padding: 16, background: '#FEE2E2', borderRadius: 12, border: '1px solid #EF4444' } },
                h('h4', { style: { margin: '0 0 12px 0', color: '#DC2626', display: 'flex', alignItems: 'center', gap: 8 } }, '⚠️ Réserves'),
                h('p', { style: { margin: 0, whiteSpace: 'pre-wrap' } }, viewArchivedDevice.reserves)
            ),
            
            // Dates
            h('div', { style: { padding: 16, background: '#F1F5F9', borderRadius: 12 } },
                h('div', { style: { display: 'flex', gap: 24, flexWrap: 'wrap', fontSize: 13, color: COLORS.muted } },
                    h('span', null, `Créé le: ${formatDate(viewArchivedDevice.created_at)}`),
                    viewArchivedDevice.updated_at && h('span', null, `Modifié le: ${formatDate(viewArchivedDevice.updated_at)}`),
                    h('span', null, `Archivé le: ${formatDate(viewArchivedDevice.archived_at)}`)
                )
            )
        )),
        // Confirmation suppression archive
        h(ConfirmDialog, { 
            isOpen: !!deleteArchivedConfirm, 
            onClose: () => setDeleteArchivedConfirm(null), 
            onConfirm: () => deleteArchivedDevice(deleteArchivedConfirm?.id), 
            title: 'Supprimer l\'archive', 
            message: `Êtes-vous sûr de vouloir supprimer définitivement l'archive "${deleteArchivedConfirm?.device_number}" ? Cette action est irréversible.`, 
            confirmText: 'Supprimer définitivement' 
        }),
        h(ConfirmDialog, { isOpen: !!deleteConfirm, onClose: () => setDeleteConfirm(null), onConfirm: () => deleteDevice(deleteConfirm?.id), title: 'Supprimer l\'appareil', message: `Êtes-vous sûr de vouloir supprimer "${deleteConfirm?.device_number}" ?`, confirmText: 'Supprimer' }),
        h(ConfirmDialog, { isOpen: !!deleteReportConfirm, onClose: () => setDeleteReportConfirm(null), onConfirm: () => deleteReport(deleteReportConfirm?.id), title: 'Supprimer le rapport', message: 'Êtes-vous sûr de vouloir supprimer ce rapport ?', confirmText: 'Supprimer' })
    );
};

// ==========================================
// USERS PAGE - Gestion des utilisateurs
// ==========================================
const UsersPage = ({ data, user, refresh, showToast }) => {
    const [search, setSearch] = useState('');
    const [showAdd, setShowAdd] = useState(false);
    const [editUser, setEditUser] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [showPermissions, setShowPermissions] = useState(null);
    
    const isAdmin = user.role === 'admin';
    const users = data.users || [];
    
    const filteredUsers = users.filter(u => 
        !search || 
        u.email?.toLowerCase().includes(search.toLowerCase()) ||
        u.first_name?.toLowerCase().includes(search.toLowerCase()) ||
        u.last_name?.toLowerCase().includes(search.toLowerCase())
    );
    
    const roleLabels = {
        admin: { label: 'Administrateur', color: 'danger' },
        technicien: { label: 'Technicien', color: 'info' },
        lecteur: { label: 'Lecteur', color: 'muted' }
    };
    
    // Permissions par défaut selon le rôle
    const defaultPermissions = DEFAULT_PERMISSIONS;
    
    const permissionLabels = {
        stock_read: { label: 'Stock - Lecture', icon: 'eye', group: 'Stock' },
        stock_write: { label: 'Stock - Modification', icon: 'edit', group: 'Stock' },
        tasks_read: { label: 'Travaux - Lecture', icon: 'eye', group: 'Travaux' },
        tasks_write: { label: 'Travaux - Modification', icon: 'edit', group: 'Travaux' },
        orders_read: { label: 'Commandes - Lecture', icon: 'eye', group: 'Commandes' },
        orders_write: { label: 'Commandes - Modification', icon: 'edit', group: 'Commandes' },
        planning_read: { label: 'Planning - Lecture', icon: 'eye', group: 'Planning' },
        planning_write: { label: 'Planning - Modification', icon: 'edit', group: 'Planning' },
        timesheets_view_all: { label: 'Feuilles d\'heures - Voir toutes', icon: 'clock', group: 'Feuilles d\'heures' },
        users_manage: { label: 'Gestion utilisateurs', icon: 'users', group: 'Système' },
        settings_manage: { label: 'Gestion paramètres', icon: 'settings', group: 'Système' }
    };
    
    const handleSaveUser = async (formData) => {
        try {
            if (editUser) {
                // Si le rôle change, mettre à jour les permissions par défaut
                const updateData = {
                    first_name: formData.first_name,
                    last_name: formData.last_name,
                    role: formData.role,
                    sectors: formData.sectors || '[]'
                };
                // Si le rôle a changé, appliquer les permissions par défaut du nouveau rôle
                if (editUser.role !== formData.role) {
                    updateData.permissions = defaultPermissions[formData.role] || defaultPermissions.lecteur;
                }
                await db.from('profiles').update(updateData).eq('id', editUser.id);
                showToast('Utilisateur modifié');
            } else {
                // Créer le profil directement (l'utilisateur doit déjà exister dans Auth)
                const permissions = defaultPermissions[formData.role] || defaultPermissions.lecteur;
                await db.from('profiles').insert({
                    email: formData.email,
                    first_name: formData.first_name,
                    last_name: formData.last_name,
                    role: formData.role,
                    permissions: permissions,
                    sectors: formData.sectors || '[]'
                });
                showToast('Utilisateur créé');
            }
            setShowAdd(false);
            setEditUser(null);
            refresh();
        } catch (err) {
            showToast(err.message, 'error');
        }
    };
    
    const handleSavePermissions = async (userId, permissions) => {
        try {
            // S'assurer que les permissions sont un objet propre
            const cleanPerms = {};
            Object.keys(permissions).forEach(key => {
                cleanPerms[key] = permissions[key] === true;
            });
            console.log('Saving permissions:', cleanPerms);
            const { error } = await db.from('profiles').update({ permissions: cleanPerms }).eq('id', userId);
            if (error) throw error;
            showToast('Permissions mises à jour', 'success');
            setShowPermissions(null);
            refresh();
        } catch (err) {
            console.error('Error saving permissions:', err);
            showToast('Erreur: ' + err.message, 'error');
        }
    };
    
    const handleDelete = async (u) => {
        try {
            await db.from('profiles').delete().eq('id', u.id);
            showToast('Utilisateur supprimé');
            setDeleteConfirm(null);
            refresh();
        } catch (err) {
            showToast(err.message, 'error');
        }
    };
    
    // User Form Modal
    const UserFormModal = ({ userToEdit, onClose, onSave }) => {
        const [form, setForm] = useState(userToEdit || { email: '', first_name: '', last_name: '', role: 'technicien', sectors: [] });
        
        // Secteurs par défaut
        const defaultSectors = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10'];
        
        // Charger les secteurs disponibles depuis Progilift ou utiliser les défauts
        const [availableSectors, setAvailableSectors] = useState(defaultSectors);
        const [sectorsLoaded, setSectorsLoaded] = useState(false);
        
        useEffect(() => {
            const loadSectors = async () => {
                let foundSectors = [];
                
                console.log('🔄 Chargement des secteurs...');
                
                // Charger depuis la table equipements (source principale des secteurs)
                try {
                    const equipements = await fetchAllRows(db, 'equipements', 'secteur');
                    
                    if (equipements && equipements.length > 0) {
                        foundSectors = [...new Set(equipements.map(e => e.secteur).filter(Boolean))].sort();
                        console.log('✅ Secteurs depuis equipements:', foundSectors);
                    }
                } catch (err) {
                    console.log('🔄 Fallback sur table contrats');
                    // Fallback: utiliser la table contrats
                    try {
                        const contrats = await fetchAllRows(db, 'contrats', 'secteur');
                        
                        if (contrats && contrats.length > 0) {
                            foundSectors = [...new Set(contrats.map(c => c.secteur).filter(Boolean))].sort();
                            console.log('✅ Secteurs via contrats:', foundSectors);
                        }
                    } catch (viewErr) {
                        console.log('❌ Tables non accessibles:', viewErr.message);
                    }
                }
                
                // Utiliser les secteurs trouvés ou les défauts
                if (foundSectors.length > 0) {
                    setAvailableSectors(foundSectors);
                } else {
                    console.log('⚠️ Utilisation des secteurs par défaut:', defaultSectors);
                    setAvailableSectors(defaultSectors);
                }
                setSectorsLoaded(true);
            };
            
            loadSectors();
            
            // Initialiser les secteurs depuis userToEdit
            if (userToEdit?.sectors) {
                try {
                    const parsed = typeof userToEdit.sectors === 'string' ? JSON.parse(userToEdit.sectors) : userToEdit.sectors;
                    if (Array.isArray(parsed)) {
                        setForm(f => ({ ...f, sectors: parsed }));
                    }
                } catch (e) { 
                    console.log('Erreur parsing sectors:', e);
                }
            }
        }, [userToEdit]);
        
        const toggleSector = (sector) => {
            const current = form.sectors || [];
            if (current.includes(sector)) {
                setForm({ ...form, sectors: current.filter(s => s !== sector) });
            } else {
                setForm({ ...form, sectors: [...current, sector] });
            }
        };
        
        const selectAllSectors = () => setForm({ ...form, sectors: [...availableSectors] });
        const clearAllSectors = () => setForm({ ...form, sectors: [] });
        
        return h(Modal, { isOpen: true, onClose, title: userToEdit ? 'Modifier l\'utilisateur' : 'Nouvel utilisateur', size: 'md',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Annuler'),
                h('button', { className: 'btn btn-primary', onClick: () => onSave({ ...form, sectors: JSON.stringify(form.sectors || []) }) }, 'Enregistrer')
            )
        },
            !userToEdit && h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Email *'),
                h('input', { type: 'email', className: 'form-input', value: form.email, onChange: e => setForm({...form, email: e.target.value}), required: true })
            ),
            h('div', { className: 'form-row' },
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Prénom'),
                    h('input', { className: 'form-input', value: form.first_name || '', onChange: e => setForm({...form, first_name: e.target.value}) })
                ),
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Nom'),
                    h('input', { className: 'form-input', value: form.last_name || '', onChange: e => setForm({...form, last_name: e.target.value}) })
                )
            ),
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Rôle'),
                h('select', { className: 'form-select', value: form.role, onChange: e => setForm({...form, role: e.target.value}) },
                    h('option', { value: 'admin' }, '👑 Administrateur - Accès complet'),
                    h('option', { value: 'technicien' }, '🔧 Technicien - Gestion stock et travaux'),
                    h('option', { value: 'lecteur' }, '👁️ Lecteur - Consultation uniquement')
                )
            ),
            // Secteurs d'accès
            h('div', { className: 'form-group' },
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 } },
                    h('label', { className: 'form-label', style: { marginBottom: 0 } }, '🗺️ Secteurs d\'accès'),
                    h('div', { style: { display: 'flex', gap: 8 } },
                        h('button', { type: 'button', className: 'btn btn-ghost btn-xs', onClick: selectAllSectors }, 'Tout'),
                        h('button', { type: 'button', className: 'btn btn-ghost btn-xs', onClick: clearAllSectors }, 'Aucun')
                    )
                ),
                availableSectors.length === 0 ? 
                    h('div', { style: { padding: 12, background: COLORS.background, borderRadius: 8, color: COLORS.muted, fontSize: 13 } }, 'Chargement des secteurs...') :
                    h('div', { style: { display: 'flex', flexWrap: 'wrap', gap: 8 } },
                        availableSectors.map(sector => h('label', { 
                            key: sector,
                            style: { 
                                display: 'flex', alignItems: 'center', gap: 6, 
                                padding: '6px 12px', borderRadius: 20, cursor: 'pointer',
                                background: (form.sectors || []).includes(sector) ? COLORS.primaryPastel : COLORS.background,
                                border: `2px solid ${(form.sectors || []).includes(sector) ? COLORS.primary : 'transparent'}`,
                                transition: 'all 0.2s'
                            }
                        },
                            h('input', { 
                                type: 'checkbox', 
                                checked: (form.sectors || []).includes(sector),
                                onChange: () => toggleSector(sector),
                                style: { display: 'none' }
                            }),
                            h('span', { style: { fontWeight: (form.sectors || []).includes(sector) ? 600 : 400, fontSize: 13 } }, sector)
                        ))
                    ),
                (form.sectors || []).length > 0 && h('div', { style: { marginTop: 8, fontSize: 12, color: COLORS.success } }, 
                    `✓ ${form.sectors.length} secteur(s) sélectionné(s)`
                ),
                (form.sectors || []).length === 0 && h('div', { style: { marginTop: 8, fontSize: 12, color: COLORS.warning } }, 
                    '⚠️ Aucun secteur = accès à tous les appareils'
                )
            ),
            h('div', { style: { background: COLORS.background, padding: 12, borderRadius: 8, marginTop: 12 } },
                h('div', { style: { fontSize: 12, fontWeight: 600, marginBottom: 8 } }, 'Permissions par défaut:'),
                h('div', { style: { fontSize: 11, color: COLORS.muted } },
                    h('div', null, '• Admin: Tout gérer (limité aux secteurs sélectionnés)'),
                    h('div', null, '• Technicien: Gérer stock, travaux, commandes, planning'),
                    h('div', null, '• Lecteur: Consulter uniquement')
                )
            )
        );
    };
    
    // Permissions Modal
    const PermissionsModal = ({ userToEdit, onClose }) => {
        const userPerms = parsePermissions(userToEdit.permissions) || defaultPermissions[userToEdit.role] || defaultPermissions.lecteur;
        const [perms, setPerms] = useState(userPerms);
        
        const togglePerm = (key) => setPerms({...perms, [key]: !perms[key]});
        
        const groups = {};
        Object.entries(permissionLabels).forEach(([key, val]) => {
            if (!groups[val.group]) groups[val.group] = [];
            groups[val.group].push({ key, ...val });
        });
        
        return h(Modal, { isOpen: true, onClose, title: `Permissions: ${userToEdit.first_name || userToEdit.email}`, size: 'md',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Annuler'),
                h('button', { className: 'btn btn-primary', onClick: () => handleSavePermissions(userToEdit.id, perms) }, 'Enregistrer')
            )
        },
            h('div', { style: { marginBottom: 16 } },
                h('span', { className: `badge badge-${roleLabels[userToEdit.role]?.color || 'muted'}` }, roleLabels[userToEdit.role]?.label || userToEdit.role)
            ),
            Object.entries(groups).map(([groupName, groupPerms]) => h('div', { key: groupName, style: { marginBottom: 20 } },
                h('div', { style: { fontSize: 13, fontWeight: 600, color: COLORS.muted, marginBottom: 8, textTransform: 'uppercase', letterSpacing: 0.5 } }, groupName),
                h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 8 } },
                    groupPerms.map(perm => h('label', { 
                        key: perm.key, 
                        style: { 
                            display: 'flex', alignItems: 'center', gap: 10, padding: 12, 
                            background: perms[perm.key] ? COLORS.successPastel : COLORS.background, 
                            borderRadius: 8, cursor: 'pointer', border: `1px solid ${perms[perm.key] ? COLORS.success : COLORS.border}`,
                            transition: 'all 0.2s'
                        }
                    },
                        h('input', { type: 'checkbox', checked: perms[perm.key] || false, onChange: () => togglePerm(perm.key), style: { width: 18, height: 18, accentColor: COLORS.success } }),
                        h('div', null,
                            h('div', { style: { fontWeight: 500, fontSize: 13 } }, perm.label),
                            h('div', { style: { fontSize: 11, color: COLORS.muted } }, perms[perm.key] ? 'Autorisé' : 'Non autorisé')
                        )
                    ))
                )
            ))
        );
    };
    
    if (!isAdmin) {
        return h('div', null,
            h('div', { className: 'page-header' }, h('h1', { className: 'page-title' }, 'Utilisateurs')),
            h('div', { className: 'card' },
                h('div', { className: 'empty-state' },
                    h('div', { className: 'empty-icon' }, h(Icon, { name: 'users', size: 28 })),
                    h('p', { className: 'empty-title' }, 'Accès restreint'),
                    h('p', { className: 'empty-desc' }, 'Seuls les administrateurs peuvent gérer les utilisateurs')
                )
            )
        );
    }
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' },
                h('h1', { className: 'page-title' }, 'Utilisateurs'),
                h('p', { className: 'page-subtitle' }, `${users.length} utilisateur${users.length > 1 ? 's' : ''}`)
            ),
            h('div', { className: 'page-actions' },
                h('button', { className: 'btn btn-primary', onClick: () => setShowAdd(true) }, h(Icon, { name: 'plus', size: 18 }), 'Ajouter')
            )
        ),
        
        h('div', { className: 'card' },
            h('div', { className: 'card-header' },
                h('div', { className: 'header-search', style: { width: 300 } },
                    h(Icon, { name: 'search', size: 18, color: COLORS.muted }),
                    h('input', { type: 'text', placeholder: 'Rechercher...', value: search, onChange: e => setSearch(e.target.value) })
                )
            ),
            h('div', { className: 'table-container' },
                h('table', null,
                    h('thead', null,
                        h('tr', null,
                            h('th', null, 'Utilisateur'),
                            h('th', null, 'Email'),
                            h('th', null, 'Rôle'),
                            h('th', null, 'Permissions'),
                            h('th', null, 'Actions')
                        )
                    ),
                    h('tbody', null,
                        filteredUsers.length === 0 ? h('tr', null, h('td', { colSpan: 5, style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun utilisateur')) :
                        filteredUsers.map(u => {
                            const roleInfo = roleLabels[u.role] || roleLabels.lecteur;
                            const userPerms = parsePermissions(u.permissions) || defaultPermissions[u.role] || {};
                            const permCount = Object.values(userPerms).filter(v => v === true).length;
                            return h('tr', { key: u.id },
                                h('td', null,
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                        h('div', { style: { width: 36, height: 36, borderRadius: '50%', background: `linear-gradient(135deg, ${COLORS.primary}, ${COLORS.secondary})`, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontWeight: 600, fontSize: 14 } },
                                            ((u.first_name?.[0] || '') + (u.last_name?.[0] || '')).toUpperCase() || u.email?.[0]?.toUpperCase()
                                        ),
                                        h('div', null,
                                            h('div', { style: { fontWeight: 600 } }, (u.first_name || '') + ' ' + (u.last_name || '') || 'Sans nom'),
                                            u.id === user.id && h('span', { className: 'badge badge-primary', style: { fontSize: 10 } }, 'Vous')
                                        )
                                    )
                                ),
                                h('td', { style: { color: COLORS.muted } }, u.email),
                                h('td', null, h('span', { className: `badge badge-${roleInfo.color}` }, roleInfo.label)),
                                h('td', null, 
                                    h('button', { className: 'btn btn-secondary btn-sm', onClick: () => setShowPermissions(u) },
                                        h(Icon, { name: 'settings', size: 14 }), ` ${permCount}/10`
                                    )
                                ),
                                h('td', null,
                                    h('div', { className: 'table-actions' },
                                        h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setEditUser(u), title: 'Modifier' }, h(Icon, { name: 'edit', size: 16 })),
                                        u.id !== user.id && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setDeleteConfirm(u), style: { color: COLORS.danger }, title: 'Supprimer' }, h(Icon, { name: 'trash', size: 16 }))
                                    )
                                )
                            );
                        })
                    )
                )
            )
        ),
        
        (showAdd || editUser) && h(UserFormModal, { userToEdit: editUser, onClose: () => { setShowAdd(false); setEditUser(null); }, onSave: handleSaveUser }),
        showPermissions && h(PermissionsModal, { userToEdit: showPermissions, onClose: () => setShowPermissions(null) }),
        deleteConfirm && h(ConfirmDialog, { isOpen: true, onClose: () => setDeleteConfirm(null), onConfirm: () => handleDelete(deleteConfirm), title: 'Supprimer cet utilisateur ?', message: `${deleteConfirm.first_name || ''} ${deleteConfirm.last_name || ''} (${deleteConfirm.email})`, confirmText: 'Supprimer', type: 'danger' })
    );
};

// ==========================================
// TOURNEES ENTRETIEN PAGE - Planification des tournées d'entretien
// ==========================================
const TourneesEntretienPage = ({ data, user, refresh, showToast }) => {
    // États principaux
    const [viewMode, setViewMode] = useState('planifier'); // 'planifier', 'historique', 'stats'
    const [selectedSecteur, setSelectedSecteur] = useState('all');
    const [selectedAscenseurs, setSelectedAscenseurs] = useState([]);
    const [searchTerm, setSearchTerm] = useState('');
    const [tourneeDate, setTourneeDate] = useState(new Date().toISOString().split('T')[0]);
    const [tourneeTechnicien, setTourneeTechnicien] = useState('');
    const [tourneeNom, setTourneeNom] = useState('');
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showDetailModal, setShowDetailModal] = useState(null);
    const [creating, setCreating] = useState(false);
    const [filterType, setFilterType] = useState('all'); // 'all', 'contrat', 'hors-contrat'
    const [filterUrgent, setFilterUrgent] = useState(false);
    const [sortBy, setSortBy] = useState('secteur'); // 'secteur', 'numero', 'derniere_visite'
    
    // Générer des données de simulation (défini avant utilisation)
    const generateSimulatedAscenseurs = useCallback(() => {
        const secteursList = ['Lyon Centre', 'Lyon Est', 'Lyon Ouest', 'Villeurbanne', 'Vénissieux', 'Caluire', 'Bron', 'Saint-Priest'];
        const types = ['Ascenseur', 'Monte-charge', 'Escalier mécanique', 'Plateforme PMR'];
        const clients = ['Résidence Les Iris', 'Immeuble Haussmann', 'Centre Commercial Grand Ouest', 'Hôpital Nord', 'Mairie Annexe', 'Tour Oxygène', 'Résidence du Parc', 'Clinique St-Joseph'];
        
        const simulated = [];
        for (let i = 1; i <= 120; i++) {
            const secteur = secteursList[Math.floor(Math.random() * secteursList.length)];
            const dernVisite = new Date();
            dernVisite.setDate(dernVisite.getDate() - Math.floor(Math.random() * 60));
            
            simulated.push({
                id: `ASC-${String(i).padStart(4, '0')}`,
                numero: `${String(69000 + Math.floor(Math.random() * 1000)).padStart(5, '0')}-${String(i).padStart(3, '0')}`,
                adresse: `${Math.floor(Math.random() * 200) + 1} ${['rue', 'avenue', 'boulevard', 'place'][Math.floor(Math.random() * 4)]} ${['Gambetta', 'République', 'Pasteur', 'Victor Hugo', 'Jean Jaurès', 'de la Liberté'][Math.floor(Math.random() * 6)]}`,
                ville: secteur.includes('Lyon') ? 'Lyon' : secteur,
                code_postal: `69${String(Math.floor(Math.random() * 10)).padStart(3, '0')}`,
                secteur: secteur,
                client: clients[Math.floor(Math.random() * clients.length)],
                type_appareil: types[Math.floor(Math.random() * types.length)],
                statut: Math.random() > 0.1 ? 'actif' : 'inactif',
                en_arret: Math.random() < 0.05,
                hors_contrat: Math.random() < 0.15,
                derniere_visite: dernVisite.toISOString().split('T')[0],
                prochaine_visite: null,
                latitude: 45.75 + (Math.random() - 0.5) * 0.15,
                longitude: 4.85 + (Math.random() - 0.5) * 0.2,
                contrat_numero: `CTR-${2024}-${String(Math.floor(Math.random() * 500)).padStart(4, '0')}`,
                frequence_entretien: ['mensuel', 'bimestriel', 'trimestriel'][Math.floor(Math.random() * 3)]
            });
        }
        return simulated;
    }, []);
    
    // Charger les ascenseurs depuis les données Progilift ou simulation
    const ascenseurs = useMemo(() => {
        // Priorité aux données Progilift
        const progiliftData = data.progilift_ascenseurs || data.ascenseurs || [];
        
        console.log('Données Progilift chargées:', progiliftData.length, 'ascenseurs');
        if (progiliftData.length > 0) {
            console.log('Exemple de données:', progiliftData[0]);
        }
        
        if (progiliftData.length > 0) {
            // Récupérer les contrats et clients pour enrichir les données
            const contrats = data.progilift_contrats || [];
            const clients = data.progilift_clients || [];
            
            return progiliftData.map(a => {
                // Chercher le contrat associé
                const contrat = contrats.find(c => c.id === a.contrat_id);
                // Chercher le client associé
                const client = clients.find(c => c.id === (contrat?.client_id || a.client_id));
                
                return {
                    id: a.id || a.code,
                    // Le numéro peut être dans 'code', 'numero_appareil', 'numero' ou 'device_number'
                    numero: a.code || a.numero_appareil || a.numero || a.device_number || a.id,
                    // Adresse depuis la vue jointe, le contrat ou l'ascenseur directement
                    adresse: a.adresse || a.adresse_installation || contrat?.adresse || '',
                    ville: a.ville || a.ville_installation || contrat?.ville || '',
                    code_postal: a.code_postal || a.cp_installation || contrat?.code_postal || '',
                    // Secteur depuis la vue, le contrat ou génération basée sur la ville
                    secteur: a.secteur || a.zone || contrat?.secteur || a.ville || 'Non défini',
                    // Client depuis la vue jointe ou la relation
                    client: a.client_nom || a.nom_client || client?.nom || client?.raison_sociale || '',
                    type_appareil: a.type_appareil || a.marque || a.type || 'Ascenseur',
                    marque: a.marque || '',
                    statut: a.statut || a.status || (a.en_arret ? 'arret' : 'actif'),
                    en_arret: a.en_arret === true || a.en_arret === 1 || a.en_arret === 't',
                    hors_contrat: a.hors_contrat === true || a.hors_contrat === 1 || !a.contrat_id,
                    derniere_visite: a.derniere_visite || a.date_derniere_visite || a.last_visit || null,
                    prochaine_visite: a.prochaine_visite || a.date_prochaine_visite || a.next_visit || null,
                    latitude: parseFloat(a.latitude) || parseFloat(a.lat) || null,
                    longitude: parseFloat(a.longitude) || parseFloat(a.lng) || null,
                    contrat_id: a.contrat_id,
                    contrat_numero: a.contrat_numero || contrat?.numero || '',
                    frequence_entretien: a.frequence_entretien || contrat?.frequence || 'mensuel'
                };
            });
        }
        
        // Données de simulation si pas de données Progilift
        return generateSimulatedAscenseurs();
    }, [data.progilift_ascenseurs, data.ascenseurs, data.progilift_contrats, data.progilift_clients, generateSimulatedAscenseurs]);
    
    // Grouper par secteur
    const secteurs = useMemo(() => {
        const groups = {};
        ascenseurs.forEach(a => {
            const s = a.secteur || 'Non défini';
            if (!groups[s]) groups[s] = [];
            groups[s].push(a);
        });
        return Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));
    }, [ascenseurs]);
    
    // Filtrer les ascenseurs
    const filteredAscenseurs = useMemo(() => {
        let filtered = [...ascenseurs];
        
        // Filtre secteur
        if (selectedSecteur !== 'all') {
            filtered = filtered.filter(a => a.secteur === selectedSecteur);
        }
        
        // Filtre recherche
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(a => 
                (a.numero || '').toLowerCase().includes(term) ||
                (a.adresse || '').toLowerCase().includes(term) ||
                (a.client || '').toLowerCase().includes(term) ||
                (a.ville || '').toLowerCase().includes(term)
            );
        }
        
        // Filtre type contrat
        if (filterType === 'contrat') {
            filtered = filtered.filter(a => !a.hors_contrat);
        } else if (filterType === 'hors-contrat') {
            filtered = filtered.filter(a => a.hors_contrat);
        }
        
        // Filtre urgent (pas de visite depuis > 45 jours)
        if (filterUrgent) {
            const now = new Date();
            filtered = filtered.filter(a => {
                if (!a.derniere_visite) return true;
                const lastVisit = new Date(a.derniere_visite);
                const daysSince = Math.floor((now - lastVisit) / (1000 * 60 * 60 * 24));
                return daysSince > 45;
            });
        }
        
        // Tri
        if (sortBy === 'numero') {
            filtered.sort((a, b) => (a.numero || '').localeCompare(b.numero || ''));
        } else if (sortBy === 'derniere_visite') {
            filtered.sort((a, b) => {
                if (!a.derniere_visite) return -1;
                if (!b.derniere_visite) return 1;
                return a.derniere_visite.localeCompare(b.derniere_visite);
            });
        } else {
            filtered.sort((a, b) => (a.secteur || '').localeCompare(b.secteur || ''));
        }
        
        return filtered;
    }, [ascenseurs, selectedSecteur, searchTerm, filterType, filterUrgent, sortBy]);
    
    // Grouper les ascenseurs filtrés par secteur
    const filteredBySecteur = useMemo(() => {
        const groups = {};
        filteredAscenseurs.forEach(a => {
            const s = a.secteur || 'Non défini';
            if (!groups[s]) groups[s] = [];
            groups[s].push(a);
        });
        return Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));
    }, [filteredAscenseurs]);
    
    // Techniciens disponibles
    const technicians = (data.users || []).filter(u => u.role === 'technicien' || u.role === 'admin');
    
    // Tournées existantes (depuis les tâches avec tournee)
    const tourneesExistantes = useMemo(() => {
        const tasks = data.tasks || [];
        const grouped = {};
        
        tasks.filter(t => t.tournee).forEach(t => {
            if (!grouped[t.tournee]) {
                grouped[t.tournee] = {
                    nom: t.tournee,
                    date: t.scheduled_date,
                    technicien: t.assigned_to,
                    tasks: [],
                    status: 'planifie'
                };
            }
            grouped[t.tournee].tasks.push(t);
            
            // Déterminer le statut global
            const allTermine = grouped[t.tournee].tasks.every(task => task.status === 'termine');
            const someEnCours = grouped[t.tournee].tasks.some(task => task.status === 'en-cours');
            if (allTermine) grouped[t.tournee].status = 'termine';
            else if (someEnCours) grouped[t.tournee].status = 'en-cours';
        });
        
        return Object.values(grouped).sort((a, b) => (b.date || '').localeCompare(a.date || ''));
    }, [data.tasks]);
    
    // Sélectionner/désélectionner un ascenseur
    const toggleAscenseur = (asc) => {
        setSelectedAscenseurs(prev => {
            const exists = prev.find(a => a.id === asc.id);
            if (exists) {
                return prev.filter(a => a.id !== asc.id);
            } else {
                return [...prev, asc];
            }
        });
    };
    
    // Sélectionner tout un secteur
    const selectSecteur = (secteurName, ascenseursInSecteur) => {
        const allSelected = ascenseursInSecteur.every(a => selectedAscenseurs.find(s => s.id === a.id));
        
        if (allSelected) {
            // Désélectionner tous
            setSelectedAscenseurs(prev => prev.filter(a => a.secteur !== secteurName));
        } else {
            // Sélectionner tous
            setSelectedAscenseurs(prev => {
                const others = prev.filter(a => a.secteur !== secteurName);
                return [...others, ...ascenseursInSecteur];
            });
        }
    };
    
    // Créer la tournée
    const createTournee = async () => {
        if (selectedAscenseurs.length === 0) {
            showToast('Sélectionnez au moins un ascenseur', 'warning');
            return;
        }
        if (!tourneeDate) {
            showToast('Sélectionnez une date', 'warning');
            return;
        }
        if (!tourneeTechnicien) {
            showToast('Sélectionnez un technicien', 'warning');
            return;
        }
        
        setCreating(true);
        
        try {
            const nomTournee = tourneeNom || `Tournée ${selectedSecteur !== 'all' ? selectedSecteur : 'Multi-secteurs'} - ${new Date(tourneeDate).toLocaleDateString('fr-FR')}`;
            
            // Créer les tâches d'entretien
            const tasks = selectedAscenseurs.map((asc, index) => ({
                id: `task-${Date.now()}-${index}`,
                title: `Entretien ${asc.type_appareil || 'Ascenseur'}`,
                description: `Visite d'entretien périodique - ${asc.client || 'Client'}`,
                device_number: asc.numero,
                location: `${asc.adresse}, ${asc.code_postal} ${asc.ville}`,
                latitude: asc.latitude,
                longitude: asc.longitude,
                scheduled_date: tourneeDate,
                scheduled_time: `${8 + Math.floor(index / 2)}:${(index % 2) * 30 === 0 ? '00' : '30'}`,
                assigned_to: tourneeTechnicien,
                status: 'planifie',
                priority: 'normal',
                task_type: 'maintenance',
                tournee: nomTournee,
                created_at: new Date().toISOString(),
                client_name: asc.client,
                secteur: asc.secteur
            }));
            
            // Sauvegarder via Supabase si disponible
            if (window.supabaseClient) {
                const { error } = await window.supabaseClient
                    .from('tasks')
                    .insert(tasks.map(t => ({
                        ...t,
                        user_id: user?.id
                    })));
                    
                if (error) throw error;
            } else {
                // Simulation locale
                console.log('Tournée créée (simulation):', { nom: nomTournee, tasks });
            }
            
            showToast(`Tournée "${nomTournee}" créée avec ${tasks.length} interventions`, 'success');
            setSelectedAscenseurs([]);
            setTourneeNom('');
            setShowCreateModal(false);
            refresh && refresh();
            
        } catch (err) {
            console.error('Erreur création tournée:', err);
            showToast('Erreur lors de la création de la tournée', 'error');
        }
        
        setCreating(false);
    };
    
    // Stats
    const stats = useMemo(() => {
        const now = new Date();
        let retard = 0;
        let aSuivre = 0;
        
        ascenseurs.forEach(a => {
            if (!a.derniere_visite) {
                retard++;
            } else {
                const lastVisit = new Date(a.derniere_visite);
                const daysSince = Math.floor((now - lastVisit) / (1000 * 60 * 60 * 24));
                if (daysSince > 45) retard++;
                else if (daysSince > 30) aSuivre++;
            }
        });
        
        return {
            total: ascenseurs.length,
            secteurs: secteurs.length,
            retard,
            aSuivre,
            enArret: ascenseurs.filter(a => a.en_arret).length,
            horsContrat: ascenseurs.filter(a => a.hors_contrat).length,
            selected: selectedAscenseurs.length
        };
    }, [ascenseurs, secteurs, selectedAscenseurs]);
    
    // Couleur du secteur
    const getSecteurColor = (secteurName) => {
        const colors = ['#E11D48', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16'];
        const index = secteurs.findIndex(([name]) => name === secteurName);
        return colors[index % colors.length];
    };
    
    // Jours depuis dernière visite
    const getDaysSinceVisit = (dateStr) => {
        if (!dateStr) return null;
        const now = new Date();
        const lastVisit = new Date(dateStr);
        return Math.floor((now - lastVisit) / (1000 * 60 * 60 * 24));
    };
    
    return h('div', null,
        // Header
        h('div', { className: 'page-header', style: { marginBottom: 16 } },
            h('div', { className: 'page-header-left' },
                h('h1', { className: 'page-title' }, '🛣️ Tournées d\'entretien'),
                h('p', { className: 'page-subtitle' }, `${stats.total} ascenseurs • ${stats.secteurs} secteurs`)
            ),
            h('div', { className: 'page-actions' },
                selectedAscenseurs.length > 0 && h('button', { 
                    className: 'btn btn-primary',
                    onClick: () => setShowCreateModal(true)
                }, h(Icon, { name: 'plus', size: 16 }), `Créer tournée (${selectedAscenseurs.length})`)
            )
        ),
        
        // Stats cards
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: 12, marginBottom: 20 } },
            h('div', { style: { background: COLORS.card, borderRadius: 12, padding: '14px 18px', border: `1px solid ${COLORS.border}` } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.primary } }, stats.total),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Ascenseurs')
            ),
            h('div', { style: { background: COLORS.card, borderRadius: 12, padding: '14px 18px', border: `1px solid ${COLORS.border}` } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: '#8B5CF6' } }, stats.secteurs),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Secteurs')
            ),
            stats.retard > 0 && h('div', { style: { background: '#FEE2E2', borderRadius: 12, padding: '14px 18px', border: '1px solid #FECACA' } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: '#DC2626' } }, stats.retard),
                h('div', { style: { fontSize: 12, color: '#B91C1C' } }, 'En retard (>45j)')
            ),
            stats.aSuivre > 0 && h('div', { style: { background: '#FEF3C7', borderRadius: 12, padding: '14px 18px', border: '1px solid #FDE68A' } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: '#D97706' } }, stats.aSuivre),
                h('div', { style: { fontSize: 12, color: '#92400E' } }, 'À suivre (30-45j)')
            ),
            stats.selected > 0 && h('div', { style: { background: '#DBEAFE', borderRadius: 12, padding: '14px 18px', border: '1px solid #BFDBFE' } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: '#2563EB' } }, stats.selected),
                h('div', { style: { fontSize: 12, color: '#1D4ED8' } }, 'Sélectionnés')
            )
        ),
        
        // Tabs
        h('div', { style: { display: 'flex', gap: 8, marginBottom: 16 } },
            h('button', { 
                className: `btn ${viewMode === 'planifier' ? 'btn-primary' : 'btn-ghost'}`,
                onClick: () => setViewMode('planifier')
            }, '📋 Planifier'),
            h('button', { 
                className: `btn ${viewMode === 'historique' ? 'btn-primary' : 'btn-ghost'}`,
                onClick: () => setViewMode('historique')
            }, '📜 Historique (', tourneesExistantes.length, ')'),
            h('button', { 
                className: `btn ${viewMode === 'stats' ? 'btn-primary' : 'btn-ghost'}`,
                onClick: () => setViewMode('stats')
            }, '📊 Statistiques')
        ),
        
        // Vue Planifier
        viewMode === 'planifier' && h(Fragment, null,
            // Filtres
            h('div', { className: 'card', style: { marginBottom: 16, padding: 16 } },
                h('div', { style: { display: 'flex', gap: 12, flexWrap: 'wrap', alignItems: 'center' } },
                    h('div', { style: { flex: '1 1 200px', position: 'relative' } },
                        h(Icon, { name: 'search', size: 18, color: COLORS.muted, style: { position: 'absolute', left: 12, top: '50%', transform: 'translateY(-50%)' } }),
                        h('input', { 
                            type: 'text', 
                            className: 'form-input', 
                            placeholder: 'Rechercher n°, adresse, client...', 
                            value: searchTerm, 
                            onChange: e => setSearchTerm(e.target.value),
                            style: { paddingLeft: 40 }
                        })
                    ),
                    h('select', { 
                        className: 'form-select', 
                        value: selectedSecteur, 
                        onChange: e => setSelectedSecteur(e.target.value),
                        style: { minWidth: 160 }
                    },
                        h('option', { value: 'all' }, '📍 Tous les secteurs'),
                        secteurs.map(([name, items]) => h('option', { key: name, value: name }, `${name} (${items.length})`))
                    ),
                    h('select', { 
                        className: 'form-select', 
                        value: filterType, 
                        onChange: e => setFilterType(e.target.value),
                        style: { minWidth: 140 }
                    },
                        h('option', { value: 'all' }, '📄 Tous'),
                        h('option', { value: 'contrat' }, '✅ Sous contrat'),
                        h('option', { value: 'hors-contrat' }, '⚠️ Hors contrat')
                    ),
                    h('button', { 
                        className: `btn btn-sm ${filterUrgent ? 'btn-danger' : 'btn-ghost'}`,
                        onClick: () => setFilterUrgent(!filterUrgent)
                    }, '🚨 Urgents'),
                    h('select', { 
                        className: 'form-select', 
                        value: sortBy, 
                        onChange: e => setSortBy(e.target.value),
                        style: { minWidth: 140 }
                    },
                        h('option', { value: 'secteur' }, '🗂️ Par secteur'),
                        h('option', { value: 'numero' }, '🔢 Par numéro'),
                        h('option', { value: 'derniere_visite' }, '📅 Par dernière visite')
                    )
                ),
                selectedAscenseurs.length > 0 && h('div', { style: { marginTop: 12, display: 'flex', gap: 8, alignItems: 'center' } },
                    h('span', { style: { fontSize: 13, color: COLORS.textSecondary } }, 
                        `${selectedAscenseurs.length} ascenseur(s) sélectionné(s)`
                    ),
                    h('button', { 
                        className: 'btn btn-ghost btn-sm',
                        onClick: () => setSelectedAscenseurs([])
                    }, '✕ Tout désélectionner')
                )
            ),
            
            // Liste des ascenseurs par secteur
            h('div', { style: { display: 'flex', flexDirection: 'column', gap: 16 } },
                filteredBySecteur.map(([secteurName, items]) => {
                    const secteurColor = getSecteurColor(secteurName);
                    const allSelected = items.every(a => selectedAscenseurs.find(s => s.id === a.id));
                    const someSelected = items.some(a => selectedAscenseurs.find(s => s.id === a.id));
                    
                    return h('div', { key: secteurName, className: 'card', style: { overflow: 'hidden' } },
                        // Header secteur
                        h('div', { 
                            style: { 
                                padding: '12px 16px', 
                                background: `linear-gradient(135deg, ${secteurColor}15 0%, ${secteurColor}08 100%)`,
                                borderBottom: `1px solid ${COLORS.border}`,
                                display: 'flex',
                                alignItems: 'center',
                                gap: 12
                            }
                        },
                            h('input', { 
                                type: 'checkbox',
                                checked: allSelected,
                                ref: el => { if (el) el.indeterminate = someSelected && !allSelected; },
                                onChange: () => selectSecteur(secteurName, items),
                                style: { width: 18, height: 18, cursor: 'pointer' }
                            }),
                            h('div', { style: { 
                                width: 12, height: 12, borderRadius: '50%', 
                                background: secteurColor, flexShrink: 0
                            } }),
                            h('div', { style: { flex: 1 } },
                                h('span', { style: { fontWeight: 600, fontSize: 15 } }, secteurName),
                                h('span', { style: { marginLeft: 8, fontSize: 13, color: COLORS.muted } }, `(${items.length} ascenseurs)`)
                            ),
                            h('span', { style: { 
                                padding: '4px 10px', 
                                background: secteurColor, 
                                color: 'white', 
                                borderRadius: 20, 
                                fontSize: 12,
                                fontWeight: 600
                            } }, items.filter(a => {
                                const days = getDaysSinceVisit(a.derniere_visite);
                                return days === null || days > 45;
                            }).length, ' en retard')
                        ),
                        
                        // Liste des ascenseurs
                        h('div', { style: { maxHeight: 400, overflowY: 'auto' } },
                            items.map(asc => {
                                const isSelected = selectedAscenseurs.find(s => s.id === asc.id);
                                const daysSince = getDaysSinceVisit(asc.derniere_visite);
                                const isLate = daysSince === null || daysSince > 45;
                                const isWarning = daysSince !== null && daysSince > 30 && daysSince <= 45;
                                
                                return h('div', { 
                                    key: asc.id,
                                    onClick: () => toggleAscenseur(asc),
                                    style: { 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        gap: 12,
                                        padding: '10px 16px',
                                        background: isSelected ? `${secteurColor}10` : 'transparent',
                                        borderBottom: `1px solid ${COLORS.border}`,
                                        cursor: 'pointer',
                                        transition: 'background 0.15s'
                                    }
                                },
                                    h('input', { 
                                        type: 'checkbox',
                                        checked: !!isSelected,
                                        onChange: () => {},
                                        onClick: e => e.stopPropagation(),
                                        style: { width: 16, height: 16 }
                                    }),
                                    h('div', { style: { flex: 1, minWidth: 0 } },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 2 } },
                                            h('span', { style: { fontWeight: 600, fontSize: 13 } }, asc.numero),
                                            asc.en_arret && h('span', { className: 'badge badge-danger', style: { fontSize: 10 } }, '⛔ Arrêt'),
                                            asc.hors_contrat && h('span', { className: 'badge badge-warning', style: { fontSize: 10 } }, 'HC')
                                        ),
                                        h('div', { style: { fontSize: 12, color: COLORS.muted, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } },
                                            asc.adresse, ', ', asc.ville
                                        ),
                                        h('div', { style: { fontSize: 11, color: COLORS.muted, marginTop: 2 } },
                                            '🏢 ', asc.client || 'Client inconnu'
                                        )
                                    ),
                                    h('div', { style: { textAlign: 'right', flexShrink: 0 } },
                                        h('div', { style: { 
                                            fontSize: 11, 
                                            padding: '3px 8px', 
                                            borderRadius: 4,
                                            background: isLate ? '#FEE2E2' : isWarning ? '#FEF3C7' : '#D1FAE5',
                                            color: isLate ? '#DC2626' : isWarning ? '#D97706' : '#059669',
                                            fontWeight: 500
                                        } },
                                            daysSince !== null ? `${daysSince}j` : 'Jamais'
                                        ),
                                        asc.derniere_visite && h('div', { style: { fontSize: 10, color: COLORS.muted, marginTop: 2 } },
                                            new Date(asc.derniere_visite).toLocaleDateString('fr-FR')
                                        )
                                    ),
                                    h('button', {
                                        className: 'btn btn-ghost btn-sm',
                                        onClick: e => { e.stopPropagation(); setShowDetailModal(asc); },
                                        title: 'Voir détails'
                                    }, '👁️')
                                );
                            })
                        )
                    );
                })
            ),
            
            filteredAscenseurs.length === 0 && h('div', { className: 'card', style: { padding: 40, textAlign: 'center' } },
                h('div', { style: { fontSize: 48, marginBottom: 16 } }, '🔍'),
                h('p', { style: { color: COLORS.muted } }, 'Aucun ascenseur trouvé avec ces filtres')
            )
        ),
        
        // Vue Historique
        viewMode === 'historique' && h('div', null,
            tourneesExistantes.length === 0 ?
                h('div', { className: 'card', style: { padding: 40, textAlign: 'center' } },
                    h('div', { style: { fontSize: 48, marginBottom: 16 } }, '📜'),
                    h('p', { style: { color: COLORS.muted } }, 'Aucune tournée enregistrée')
                ) :
                h('div', { style: { display: 'flex', flexDirection: 'column', gap: 12 } },
                    tourneesExistantes.map(tournee => {
                        const tech = technicians.find(t => t.id === tournee.technicien);
                        const statusColors = {
                            'termine': { bg: '#D1FAE5', text: '#059669', label: '✅ Terminée' },
                            'en-cours': { bg: '#DBEAFE', text: '#2563EB', label: '🔄 En cours' },
                            'planifie': { bg: '#FEF3C7', text: '#D97706', label: '📅 Planifiée' }
                        };
                        const statusStyle = statusColors[tournee.status] || statusColors.planifie;
                        
                        return h('div', { key: tournee.nom, className: 'card', style: { padding: 16 } },
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 12, marginBottom: 12 } },
                                h('div', { style: { flex: 1 } },
                                    h('div', { style: { fontWeight: 600, fontSize: 15 } }, tournee.nom),
                                    h('div', { style: { fontSize: 13, color: COLORS.muted, marginTop: 4 } },
                                        '📅 ', tournee.date ? new Date(tournee.date).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }) : 'Date non définie',
                                        ' • 👤 ', tech ? `${tech.first_name || ''} ${tech.last_name || ''}`.trim() : 'Non assigné'
                                    )
                                ),
                                h('span', { style: { 
                                    padding: '6px 12px', 
                                    background: statusStyle.bg, 
                                    color: statusStyle.text,
                                    borderRadius: 20,
                                    fontSize: 12,
                                    fontWeight: 600
                                } }, statusStyle.label)
                            ),
                            h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                                h('span', { style: { fontSize: 12, color: COLORS.muted } }, 
                                    `${tournee.tasks.length} intervention(s)`
                                ),
                                h('span', { style: { fontSize: 12, color: COLORS.success } }, 
                                    `${tournee.tasks.filter(t => t.status === 'termine').length} terminée(s)`
                                )
                            )
                        );
                    })
                )
        ),
        
        // Vue Stats
        viewMode === 'stats' && h('div', { className: 'card', style: { padding: 24 } },
            h('h3', { style: { marginBottom: 20 } }, '📊 Statistiques par secteur'),
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: 16 } },
                secteurs.map(([name, items]) => {
                    const color = getSecteurColor(name);
                    const retard = items.filter(a => {
                        const days = getDaysSinceVisit(a.derniere_visite);
                        return days === null || days > 45;
                    }).length;
                    const horsContrat = items.filter(a => a.hors_contrat).length;
                    const enArret = items.filter(a => a.en_arret).length;
                    
                    return h('div', { 
                        key: name, 
                        style: { 
                            padding: 16, 
                            borderRadius: 12, 
                            border: `2px solid ${color}30`,
                            background: `${color}05`
                        }
                    },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10, marginBottom: 12 } },
                            h('div', { style: { width: 14, height: 14, borderRadius: '50%', background: color } }),
                            h('span', { style: { fontWeight: 600, fontSize: 15 } }, name)
                        ),
                        h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 8 } },
                            h('div', null,
                                h('div', { style: { fontSize: 22, fontWeight: 700, color } }, items.length),
                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'Ascenseurs')
                            ),
                            h('div', null,
                                h('div', { style: { fontSize: 22, fontWeight: 700, color: retard > 0 ? '#DC2626' : '#10B981' } }, retard),
                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'En retard')
                            ),
                            h('div', null,
                                h('div', { style: { fontSize: 22, fontWeight: 700, color: '#F59E0B' } }, horsContrat),
                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'Hors contrat')
                            ),
                            h('div', null,
                                h('div', { style: { fontSize: 22, fontWeight: 700, color: enArret > 0 ? '#DC2626' : '#64748B' } }, enArret),
                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'En arrêt')
                            )
                        ),
                        h('button', { 
                            className: 'btn btn-sm btn-ghost',
                            style: { marginTop: 12, width: '100%' },
                            onClick: () => { setSelectedSecteur(name); setViewMode('planifier'); }
                        }, '➡️ Planifier ce secteur')
                    );
                })
            )
        ),
        
        // Modal création tournée
        showCreateModal && h(Modal, {
            isOpen: true,
            onClose: () => setShowCreateModal(false),
            title: '🛣️ Créer une tournée d\'entretien',
            size: 'lg'
        },
            h('div', null,
                h('div', { style: { marginBottom: 20 } },
                    h('div', { style: { 
                        padding: 16, 
                        background: COLORS.primaryPastel, 
                        borderRadius: 10, 
                        marginBottom: 16 
                    } },
                        h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.primary } }, 
                            selectedAscenseurs.length
                        ),
                        h('div', { style: { fontSize: 13, color: COLORS.textSecondary } }, 
                            'ascenseur(s) sélectionné(s)'
                        )
                    ),
                    
                    // Résumé par secteur
                    h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap', marginBottom: 16 } },
                        Object.entries(selectedAscenseurs.reduce((acc, a) => {
                            acc[a.secteur] = (acc[a.secteur] || 0) + 1;
                            return acc;
                        }, {})).map(([secteur, count]) => 
                            h('span', { 
                                key: secteur,
                                style: { 
                                    padding: '4px 10px', 
                                    background: `${getSecteurColor(secteur)}20`,
                                    color: getSecteurColor(secteur),
                                    borderRadius: 6,
                                    fontSize: 12,
                                    fontWeight: 500
                                }
                            }, `${secteur}: ${count}`)
                        )
                    )
                ),
                
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Nom de la tournée (optionnel)'),
                    h('input', { 
                        type: 'text', 
                        className: 'form-input', 
                        value: tourneeNom,
                        onChange: e => setTourneeNom(e.target.value),
                        placeholder: 'Ex: Tournée Lyon Centre - Janvier 2026'
                    })
                ),
                
                h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16 } },
                    h('div', { className: 'form-group' },
                        h('label', { className: 'form-label' }, '📅 Date de la tournée *'),
                        h('input', { 
                            type: 'date', 
                            className: 'form-input', 
                            value: tourneeDate,
                            onChange: e => setTourneeDate(e.target.value)
                        })
                    ),
                    h('div', { className: 'form-group' },
                        h('label', { className: 'form-label' }, '👤 Technicien *'),
                        h('select', { 
                            className: 'form-select', 
                            value: tourneeTechnicien,
                            onChange: e => setTourneeTechnicien(e.target.value)
                        },
                            h('option', { value: '' }, 'Sélectionner...'),
                            technicians.map(t => h('option', { key: t.id, value: t.id }, 
                                `${t.first_name || ''} ${t.last_name || ''}`.trim() || t.email
                            ))
                        )
                    )
                ),
                
                // Liste des ascenseurs sélectionnés
                h('div', { style: { marginTop: 16 } },
                    h('label', { className: 'form-label' }, 'Ascenseurs inclus'),
                    h('div', { style: { maxHeight: 200, overflowY: 'auto', border: `1px solid ${COLORS.border}`, borderRadius: 8 } },
                        selectedAscenseurs.map((asc, idx) => h('div', { 
                            key: asc.id,
                            style: { 
                                display: 'flex', 
                                alignItems: 'center', 
                                gap: 10,
                                padding: '8px 12px',
                                borderBottom: idx < selectedAscenseurs.length - 1 ? `1px solid ${COLORS.border}` : 'none'
                            }
                        },
                            h('span', { style: { 
                                width: 24, height: 24, borderRadius: '50%',
                                background: COLORS.primary, color: 'white',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                fontSize: 11, fontWeight: 600, flexShrink: 0
                            } }, idx + 1),
                            h('div', { style: { flex: 1 } },
                                h('span', { style: { fontWeight: 500, fontSize: 13 } }, asc.numero),
                                h('span', { style: { marginLeft: 8, fontSize: 12, color: COLORS.muted } }, asc.adresse)
                            ),
                            h('span', { style: { 
                                fontSize: 10, 
                                padding: '2px 6px', 
                                background: `${getSecteurColor(asc.secteur)}20`,
                                color: getSecteurColor(asc.secteur),
                                borderRadius: 4
                            } }, asc.secteur),
                            h('button', {
                                className: 'btn btn-ghost btn-sm',
                                onClick: () => toggleAscenseur(asc),
                                style: { padding: 4 }
                            }, '✕')
                        ))
                    )
                ),
                
                h('div', { style: { display: 'flex', gap: 12, marginTop: 24, justifyContent: 'flex-end' } },
                    h('button', { 
                        className: 'btn btn-ghost',
                        onClick: () => setShowCreateModal(false)
                    }, 'Annuler'),
                    h('button', { 
                        className: 'btn btn-primary',
                        onClick: createTournee,
                        disabled: creating || selectedAscenseurs.length === 0 || !tourneeDate || !tourneeTechnicien
                    }, creating ? '⏳ Création...' : '✅ Créer la tournée')
                )
            )
        ),
        
        // Modal détail ascenseur
        showDetailModal && h(Modal, {
            isOpen: true,
            onClose: () => setShowDetailModal(null),
            title: `🛗 ${showDetailModal.numero}`,
            size: 'md'
        },
            h('div', null,
                h('div', { style: { display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' } },
                    h('span', { style: { 
                        padding: '4px 10px', 
                        background: `${getSecteurColor(showDetailModal.secteur)}20`,
                        color: getSecteurColor(showDetailModal.secteur),
                        borderRadius: 6, fontSize: 12, fontWeight: 500
                    } }, showDetailModal.secteur),
                    showDetailModal.hors_contrat && h('span', { className: 'badge badge-warning' }, 'Hors contrat'),
                    showDetailModal.en_arret && h('span', { className: 'badge badge-danger' }, '⛔ En arrêt')
                ),
                
                h('div', { style: { display: 'grid', gap: 12 } },
                    h('div', null,
                        h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, '📍 Adresse'),
                        h('div', { style: { fontWeight: 500 } }, 
                            showDetailModal.adresse, ', ', showDetailModal.code_postal, ' ', showDetailModal.ville
                        )
                    ),
                    h('div', null,
                        h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, '🏢 Client'),
                        h('div', { style: { fontWeight: 500 } }, showDetailModal.client || 'Non renseigné')
                    ),
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 } },
                        h('div', null,
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, '🛗 Type'),
                            h('div', { style: { fontWeight: 500 } }, showDetailModal.type_appareil || 'Ascenseur')
                        ),
                        h('div', null,
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, '📄 Contrat'),
                            h('div', { style: { fontWeight: 500 } }, showDetailModal.contrat_numero || 'N/A')
                        )
                    ),
                    h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12 } },
                        h('div', null,
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, '📅 Dernière visite'),
                            h('div', { style: { fontWeight: 500 } }, 
                                showDetailModal.derniere_visite 
                                    ? new Date(showDetailModal.derniere_visite).toLocaleDateString('fr-FR')
                                    : 'Jamais'
                            )
                        ),
                        h('div', null,
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, '🔄 Fréquence'),
                            h('div', { style: { fontWeight: 500 } }, showDetailModal.frequence_entretien || 'Mensuel')
                        )
                    )
                ),
                
                showDetailModal.latitude && showDetailModal.longitude && h('div', { style: { marginTop: 16, display: 'flex', gap: 8 } },
                    h('a', { 
                        href: `https://www.google.com/maps?q=${showDetailModal.latitude},${showDetailModal.longitude}`,
                        target: '_blank',
                        className: 'btn btn-secondary btn-sm'
                    }, '🗺️ Voir sur Google Maps')
                ),
                
                h('div', { style: { marginTop: 20, display: 'flex', gap: 12, justifyContent: 'flex-end' } },
                    h('button', { 
                        className: 'btn btn-ghost',
                        onClick: () => setShowDetailModal(null)
                    }, 'Fermer'),
                    !selectedAscenseurs.find(a => a.id === showDetailModal.id) ?
                        h('button', { 
                            className: 'btn btn-primary',
                            onClick: () => { toggleAscenseur(showDetailModal); setShowDetailModal(null); }
                        }, '➕ Ajouter à la sélection') :
                        h('button', { 
                            className: 'btn btn-secondary',
                            onClick: () => { toggleAscenseur(showDetailModal); setShowDetailModal(null); }
                        }, '➖ Retirer de la sélection')
                )
            )
        )
    );
};

// ==========================================
// MAP PAGE - Carte des interventions v5.9 Améliorée
// ==========================================
const MapPage = ({ data, user, refresh, showToast, InterventionMap }) => {
    // États des filtres
    const [search, setSearch] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [priorityFilter, setPriorityFilter] = useState('all');
    const [dateFilter, setDateFilter] = useState('today');
    const [typeFilter, setTypeFilter] = useState('all');
    const [technicianFilter, setTechnicianFilter] = useState('all');
    const [showTimeline, setShowTimeline] = useState(true);
    const [selectedEvent, setSelectedEvent] = useState(null);
    const [showGeocodeModal, setShowGeocodeModal] = useState(false);
    const [geocodingProgress, setGeocodingProgress] = useState({ running: false, current: 0, total: 0, results: [] });
    
    // v5.9 - Nouveaux états
    const [viewMode, setViewMode] = useState('interventions'); // 'interventions', 'tournees', 'search'
    const [geoSearch, setGeoSearch] = useState('');
    const [geoSearchResults, setGeoSearchResults] = useState(null);
    const [geoSearchRadius, setGeoSearchRadius] = useState(2); // km
    const [geoSearching, setGeoSearching] = useState(false);
    const [selectedTournee, setSelectedTournee] = useState(null);
    const [mapCenter, setMapCenter] = useState(null);
    
    // Options de filtres
    const statusOptions = [
        { value: 'all', label: 'Tous les statuts' },
        { value: 'planifie', label: '📅 Planifié' },
        { value: 'en-cours', label: '🔄 En cours' },
        { value: 'termine', label: '✅ Terminé' },
        { value: 'annule', label: '❌ Annulé' }
    ];
    
    const priorityOptions = [
        { value: 'all', label: 'Toutes priorités' },
        { value: 'urgente', label: '🔴 Urgente' },
        { value: 'haute', label: '🟠 Haute' },
        { value: 'normal', label: '🔵 Normale' },
        { value: 'basse', label: '⚪ Basse' }
    ];
    
    const dateOptions = [
        { value: 'all', label: 'Toutes les dates' },
        { value: 'today', label: "📅 Aujourd'hui" },
        { value: 'tomorrow', label: '📅 Demain' },
        { value: 'week', label: '📆 Cette semaine' },
        { value: 'month', label: '🗓️ Ce mois' }
    ];
    
    const typeOptions = [
        { value: 'all', label: 'Tous les types' },
        { value: 'sav', label: '🔧 SAV' },
        { value: 'mes', label: '🚀 Mise en service' },
        { value: 'maintenance', label: '⚙️ Maintenance' },
        { value: 'inspection', label: '🔍 Inspection' }
    ];
    
    // Technicians
    const technicians = (data.users || []).filter(u => u.role === 'technicien' || u.role === 'admin');
    
    // Filtrer les événements
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const events = useMemo(() => {
        return (data.tasks || [])
            .filter(t => t.scheduled_date)
            .map(t => ({
                ...t,
                lat: t.latitude || null,
                lng: t.longitude || null
            }))
            .filter(t => {
                // Recherche
                if (search) {
                    const s = search.toLowerCase();
                    const match = (t.device_number || '').toLowerCase().includes(s) ||
                        (t.location || '').toLowerCase().includes(s) ||
                        (t.description || '').toLowerCase().includes(s) ||
                        (t.tournee || '').toLowerCase().includes(s);
                    if (!match) return false;
                }
                
                // Statut
                if (statusFilter !== 'all' && t.status !== statusFilter) return false;
                
                // Priorité
                if (priorityFilter !== 'all' && t.priority !== priorityFilter) return false;
                
                // Technicien
                if (technicianFilter !== 'all' && t.assigned_to !== technicianFilter) return false;
                
                // Type
                if (typeFilter !== 'all') {
                    if (typeFilter === 'mes' && t.task_type !== 'mes') return false;
                    if (typeFilter === 'sav' && t.task_type === 'mes') return false;
                }
                
                // Date
                if (dateFilter !== 'all') {
                    const eventDate = new Date(t.scheduled_date);
                    eventDate.setHours(0, 0, 0, 0);
                    
                    if (dateFilter === 'today') {
                        if (eventDate.getTime() !== today.getTime()) return false;
                    } else if (dateFilter === 'tomorrow') {
                        const tomorrow = new Date(today);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        if (eventDate.getTime() !== tomorrow.getTime()) return false;
                    } else if (dateFilter === 'week') {
                        const weekEnd = new Date(today);
                        weekEnd.setDate(weekEnd.getDate() + 7);
                        if (eventDate < today || eventDate > weekEnd) return false;
                    } else if (dateFilter === 'month') {
                        if (eventDate.getMonth() !== today.getMonth() || eventDate.getFullYear() !== today.getFullYear()) return false;
                    }
                }
                
                return true;
            });
    }, [data.tasks, search, statusFilter, priorityFilter, dateFilter, typeFilter, technicianFilter]);
    
    // v5.9 - Grouper par tournée/technicien
    const tournees = useMemo(() => {
        const groups = {};
        events.forEach(e => {
            const techId = e.assigned_to || 'non-assigne';
            const tech = technicians.find(t => t.id === techId);
            const key = techId;
            
            if (!groups[key]) {
                groups[key] = {
                    techId,
                    techName: tech ? `${tech.first_name || ''} ${tech.last_name || ''}`.trim() || tech.email?.split('@')[0] : 'Non assigné',
                    techColor: tech ? `hsl(${(techId.charCodeAt(0) * 137) % 360}, 70%, 50%)` : '#94A3B8',
                    events: [],
                    totalDistance: 0
                };
            }
            groups[key].events.push(e);
        });
        
        // Trier les événements par heure
        Object.values(groups).forEach(g => {
            g.events.sort((a, b) => (a.scheduled_time || '').localeCompare(b.scheduled_time || ''));
        });
        
        return Object.values(groups).sort((a, b) => b.events.length - a.events.length);
    }, [events, technicians]);
    
    // Grouper par jour pour la timeline
    const eventsByDay = useMemo(() => {
        const groups = {};
        events.forEach(e => {
            const day = e.scheduled_date?.split('T')[0];
            if (day) {
                if (!groups[day]) groups[day] = [];
                groups[day].push(e);
            }
        });
        return Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));
    }, [events]);
    
    // v5.9 - Recherche géographique avec Photon
    const searchGeoLocation = async () => {
        if (!geoSearch.trim()) return;
        
        setGeoSearching(true);
        try {
            const response = await fetch(
                `https://photon.komoot.io/api/?q=${encodeURIComponent(geoSearch + ', France')}&limit=1&lang=fr`
            );
            const data = await response.json();
            
            if (data.features && data.features.length > 0) {
                const feature = data.features[0];
                const [lng, lat] = feature.geometry.coordinates;
                const props = feature.properties;
                const displayName = [props.name, props.street, props.city].filter(Boolean).join(', ');
                
                // Trouver les interventions dans le rayon
                const nearbyEvents = events.filter(e => {
                    if (!e.lat || !e.lng) return false;
                    const dist = calculateDistance(lat, lng, e.lat, e.lng);
                    return dist <= geoSearchRadius;
                }).map(e => ({
                    ...e,
                    distance: calculateDistance(lat, lng, e.lat, e.lng)
                })).sort((a, b) => a.distance - b.distance);
                
                setGeoSearchResults({
                    location: { lat, lng, name: displayName },
                    events: nearbyEvents,
                    radius: geoSearchRadius
                });
                
                setMapCenter({ lat, lng, zoom: geoSearchRadius <= 1 ? 15 : geoSearchRadius <= 5 ? 13 : 11 });
                
                showToast(`${nearbyEvents.length} intervention(s) dans un rayon de ${geoSearchRadius} km`, nearbyEvents.length > 0 ? 'success' : 'warning');
            } else {
                showToast('Adresse non trouvée', 'error');
            }
        } catch (err) {
            console.error('Erreur recherche:', err);
            showToast('Erreur lors de la recherche', 'error');
        }
        setGeoSearching(false);
    };
    
    // Calcul distance (formule Haversine)
    const calculateDistance = (lat1, lng1, lat2, lng2) => {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    };
    
    // Export feuille de route PDF
    const exportRoutePDF = () => {
        if (!window.jspdf) {
            showToast('jsPDF non disponible', 'error');
            return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // En-tête
        doc.setFillColor(225, 29, 72);
        doc.rect(0, 0, 210, 35, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.text('Feuille de Route', 14, 20);
        doc.setFontSize(10);
        doc.text(`Générée le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, 14, 28);
        
        // Résumé
        doc.setTextColor(0, 0, 0);
        let y = 45;
        doc.setFontSize(12);
        doc.text(`Total: ${events.length} intervention(s)`, 14, y);
        
        y += 15;
        
        // Liste des interventions par jour
        eventsByDay.forEach(([day, dayEvents]) => {
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
            
            // Date
            doc.setFillColor(241, 245, 249);
            doc.rect(14, y - 5, 182, 8, 'F');
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            const dateStr = new Date(day).toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            doc.text(`📅 ${dateStr} (${dayEvents.length})`, 16, y);
            y += 12;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            
            dayEvents.forEach((event, idx) => {
                if (y > 275) {
                    doc.addPage();
                    y = 20;
                }
                
                const tech = technicians.find(t => t.id === event.assigned_to);
                const techName = tech ? `${tech.first_name || ''} ${tech.last_name || ''}`.trim() : 'Non assigné';
                
                // Numéro d'ordre
                doc.setFillColor(225, 29, 72);
                doc.circle(20, y - 2, 4, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(8);
                doc.text(String(idx + 1), 18.5, y);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                
                // Infos
                doc.text(`${event.device_number || 'N/A'} - ${event.location || 'Lieu non défini'}`, 28, y);
                y += 5;
                doc.setTextColor(100, 100, 100);
                doc.text(`👤 ${techName} | ${event.scheduled_time || 'Heure non définie'}`, 28, y);
                doc.setTextColor(0, 0, 0);
                y += 10;
            });
            
            y += 5;
        });
        
        doc.save(`feuille-route-${new Date().toISOString().split('T')[0]}.pdf`);
        showToast('Feuille de route exportée!', 'success');
    };
    
    // Export Excel
    const exportExcel = () => {
        const headers = ['Date', 'Heure', 'N° Appareil', 'Lieu', 'Technicien', 'Statut', 'Priorité', 'Latitude', 'Longitude'];
        const rows = events.map(e => {
            const tech = technicians.find(t => t.id === e.assigned_to);
            return [
                e.scheduled_date || '',
                e.scheduled_time || '',
                e.device_number || '',
                e.location || '',
                tech ? `${tech.first_name || ''} ${tech.last_name || ''}`.trim() : '',
                e.status || '',
                e.priority || 'normal',
                e.lat || '',
                e.lng || ''
            ];
        });
        
        let csv = headers.join(';') + '\n';
        rows.forEach(row => {
            csv += row.join(';') + '\n';
        });
        
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `interventions-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        showToast('Export CSV téléchargé!', 'success');
    };
    
    // Réinitialiser les filtres
    const resetFilters = () => {
        setSearch('');
        setStatusFilter('all');
        setPriorityFilter('all');
        setDateFilter('today');
        setTypeFilter('all');
        setTechnicianFilter('all');
        setGeoSearchResults(null);
        setSelectedTournee(null);
    };
    
    const hasActiveFilters = search || statusFilter !== 'all' || priorityFilter !== 'all' || 
        dateFilter !== 'today' || typeFilter !== 'all' || technicianFilter !== 'all';
    
    // Stats rapides
    const stats = useMemo(() => {
        const withCoords = events.filter(e => e.lat && e.lng).length;
        const urgent = events.filter(e => e.priority === 'urgente').length;
        const enCours = events.filter(e => e.status === 'en-cours').length;
        return { total: events.length, withCoords, urgent, enCours };
    }, [events]);
    
    return h('div', null,
        // Header amélioré
        h('div', { className: 'page-header', style: { marginBottom: 16 } },
            h('div', { className: 'page-header-left' },
                h('h1', { className: 'page-title' }, '🗺️ Carte des interventions'),
                h('p', { className: 'page-subtitle' }, `${stats.total} intervention(s) • ${stats.withCoords} géolocalisée(s)`)
            ),
            h('div', { className: 'page-actions' },
                h('button', { 
                    className: 'btn btn-secondary', 
                    onClick: () => setShowGeocodeModal(true),
                    title: 'Géolocaliser les adresses manquantes'
                }, h(Icon, { name: 'map', size: 16 }), 'Géocoder'),
                h('button', { className: 'btn btn-secondary', onClick: exportRoutePDF }, 
                    h(Icon, { name: 'pdf', size: 16 }), 'PDF'),
                h('button', { className: 'btn btn-secondary', onClick: exportExcel }, 
                    h(Icon, { name: 'file', size: 16 }), 'CSV')
            )
        ),
        
        // Stats cards
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(140px, 1fr))', gap: 12, marginBottom: 16 } },
            h('div', { style: { background: COLORS.card, borderRadius: 12, padding: '12px 16px', border: `1px solid ${COLORS.border}` } },
                h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.primary } }, stats.total),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Interventions')
            ),
            h('div', { style: { background: COLORS.card, borderRadius: 12, padding: '12px 16px', border: `1px solid ${COLORS.border}` } },
                h('div', { style: { fontSize: 24, fontWeight: 700, color: '#10B981' } }, stats.withCoords),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Géolocalisées')
            ),
            stats.urgent > 0 && h('div', { style: { background: '#FEE2E2', borderRadius: 12, padding: '12px 16px', border: '1px solid #FECACA' } },
                h('div', { style: { fontSize: 24, fontWeight: 700, color: '#EF4444' } }, stats.urgent),
                h('div', { style: { fontSize: 12, color: '#B91C1C' } }, 'Urgentes')
            ),
            stats.enCours > 0 && h('div', { style: { background: '#DBEAFE', borderRadius: 12, padding: '12px 16px', border: '1px solid #BFDBFE' } },
                h('div', { style: { fontSize: 24, fontWeight: 700, color: '#3B82F6' } }, stats.enCours),
                h('div', { style: { fontSize: 12, color: '#1D4ED8' } }, 'En cours')
            )
        ),
        
        // Tabs de vue
        h('div', { style: { display: 'flex', gap: 8, marginBottom: 16 } },
            h('button', { 
                className: `btn ${viewMode === 'interventions' ? 'btn-primary' : 'btn-ghost'}`,
                onClick: () => setViewMode('interventions')
            }, '📍 Interventions'),
            h('button', { 
                className: `btn ${viewMode === 'tournees' ? 'btn-primary' : 'btn-ghost'}`,
                onClick: () => setViewMode('tournees')
            }, '🚗 Tournées (', tournees.length, ')'),
            h('button', { 
                className: `btn ${viewMode === 'search' ? 'btn-primary' : 'btn-ghost'}`,
                onClick: () => setViewMode('search')
            }, '🔍 Recherche zone')
        ),
        
        // Barre de filtres selon le mode
        viewMode === 'interventions' && h('div', { className: 'card', style: { marginBottom: 16 } },
            h('div', { style: { padding: 16 } },
                h('div', { style: { display: 'flex', gap: 12, flexWrap: 'wrap', marginBottom: 12 } },
                    h('div', { style: { flex: '1 1 250px', position: 'relative' } },
                        h(Icon, { name: 'search', size: 18, color: COLORS.muted, style: { position: 'absolute', left: 12, top: '50%', transform: 'translateY(-50%)' } }),
                        h('input', { 
                            type: 'text', 
                            className: 'form-input', 
                            placeholder: 'Rechercher n° appareil, lieu, tournée...', 
                            value: search, 
                            onChange: e => setSearch(e.target.value),
                            style: { paddingLeft: 40 }
                        })
                    ),
                    h('select', { className: 'form-select', value: dateFilter, onChange: e => setDateFilter(e.target.value), style: { minWidth: 150 } },
                        dateOptions.map(o => h('option', { key: o.value, value: o.value }, o.label))
                    ),
                    h('select', { className: 'form-select', value: statusFilter, onChange: e => setStatusFilter(e.target.value), style: { minWidth: 140 } },
                        statusOptions.map(o => h('option', { key: o.value, value: o.value }, o.label))
                    ),
                    h('select', { className: 'form-select', value: priorityFilter, onChange: e => setPriorityFilter(e.target.value), style: { minWidth: 140 } },
                        priorityOptions.map(o => h('option', { key: o.value, value: o.value }, o.label))
                    )
                ),
                h('div', { style: { display: 'flex', gap: 12, flexWrap: 'wrap', alignItems: 'center' } },
                    h('select', { className: 'form-select', value: technicianFilter, onChange: e => setTechnicianFilter(e.target.value), style: { minWidth: 160 } },
                        h('option', { value: 'all' }, '👥 Tous les techniciens'),
                        technicians.map(t => h('option', { key: t.id, value: t.id }, `👤 ${t.first_name || ''} ${t.last_name || ''}`.trim() || t.email))
                    ),
                    h('select', { className: 'form-select', value: typeFilter, onChange: e => setTypeFilter(e.target.value), style: { minWidth: 150 } },
                        typeOptions.map(o => h('option', { key: o.value, value: o.value }, o.label))
                    ),
                    hasActiveFilters && h('button', { 
                        className: 'btn btn-ghost btn-sm', 
                        onClick: resetFilters,
                        style: { color: COLORS.danger }
                    }, h(Icon, { name: 'x', size: 14 }), 'Réinitialiser')
                )
            )
        ),
        
        // Mode Recherche zone
        viewMode === 'search' && h('div', { className: 'card', style: { marginBottom: 16, padding: 16 } },
            h('div', { style: { display: 'flex', gap: 12, flexWrap: 'wrap', alignItems: 'flex-end' } },
                h('div', { style: { flex: '1 1 300px' } },
                    h('label', { style: { display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6, color: COLORS.textSecondary } }, '📍 Adresse ou lieu'),
                    h('input', { 
                        type: 'text', 
                        className: 'form-input', 
                        placeholder: 'Ex: 15 rue de la Paix, Lyon', 
                        value: geoSearch, 
                        onChange: e => setGeoSearch(e.target.value),
                        onKeyDown: e => e.key === 'Enter' && searchGeoLocation()
                    })
                ),
                h('div', { style: { width: 120 } },
                    h('label', { style: { display: 'block', fontSize: 12, fontWeight: 600, marginBottom: 6, color: COLORS.textSecondary } }, '📏 Rayon'),
                    h('select', { 
                        className: 'form-select', 
                        value: geoSearchRadius, 
                        onChange: e => setGeoSearchRadius(Number(e.target.value))
                    },
                        h('option', { value: 0.5 }, '500 m'),
                        h('option', { value: 1 }, '1 km'),
                        h('option', { value: 2 }, '2 km'),
                        h('option', { value: 5 }, '5 km'),
                        h('option', { value: 10 }, '10 km'),
                        h('option', { value: 20 }, '20 km')
                    )
                ),
                h('button', { 
                    className: 'btn btn-primary', 
                    onClick: searchGeoLocation,
                    disabled: geoSearching || !geoSearch.trim()
                }, geoSearching ? '⏳ Recherche...' : '🔍 Rechercher'),
                geoSearchResults && h('button', { 
                    className: 'btn btn-ghost', 
                    onClick: () => { setGeoSearchResults(null); setGeoSearch(''); }
                }, '✕ Effacer')
            ),
            geoSearchResults && h('div', { style: { marginTop: 16, padding: 12, background: COLORS.background, borderRadius: 8 } },
                h('div', { style: { fontWeight: 600, marginBottom: 8 } }, 
                    '📍 ', geoSearchResults.location.name
                ),
                h('div', { style: { fontSize: 13, color: COLORS.textSecondary } }, 
                    `${geoSearchResults.events.length} intervention(s) dans un rayon de ${geoSearchResults.radius} km`
                ),
                geoSearchResults.events.length > 0 && h('div', { style: { marginTop: 12, maxHeight: 150, overflowY: 'auto' } },
                    geoSearchResults.events.slice(0, 10).map(e => h('div', { 
                        key: e.id,
                        style: { padding: '8px 12px', background: COLORS.card, borderRadius: 6, marginBottom: 6, cursor: 'pointer', border: `1px solid ${COLORS.border}` },
                        onClick: () => setSelectedEvent(e)
                    },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                            h('span', { style: { fontWeight: 500 } }, e.device_number || 'N/A'),
                            h('span', { style: { fontSize: 11, color: COLORS.muted, background: COLORS.background, padding: '2px 6px', borderRadius: 4 } }, 
                                `${e.distance.toFixed(1)} km`
                            )
                        ),
                        h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 2 } }, e.location || 'Lieu non défini')
                    ))
                )
            )
        ),
        
        // Contenu principal
        h('div', { style: { display: 'flex', gap: 16, alignItems: 'flex-start' } },
            // Carte
            h('div', { style: { flex: showTimeline || viewMode === 'tournees' ? '1 1 70%' : '1 1 100%', minWidth: 0 } },
                InterventionMap 
                    ? h(InterventionMap, {
                        events: viewMode === 'search' && geoSearchResults ? geoSearchResults.events : 
                                viewMode === 'tournees' && selectedTournee ? selectedTournee.events : events,
                        users: data.users || [],
                        onEventClick: (event) => setSelectedEvent(event),
                        onOptimizeRoute: (route) => console.log('Route optimisée:', route),
                        showToast: showToast,
                        geoSearchCenter: viewMode === 'search' && geoSearchResults ? { ...geoSearchResults.location, radius: geoSearchResults.radius } : null,
                        mapCenter: mapCenter,
                        selectedTournee: viewMode === 'tournees' ? selectedTournee : null
                    })
                    : h('div', { className: 'card', style: { padding: 40, textAlign: 'center' } },
                        h('p', null, 'Composant carte non disponible')
                    )
            ),
            
            // Panel latéral
            (showTimeline || viewMode === 'tournees') && h('div', { 
                className: 'card', 
                style: { flex: '0 0 320px', maxHeight: 'calc(100vh - 280px)', overflowY: 'auto' }
            },
                // Mode Tournées
                viewMode === 'tournees' ? h(Fragment, null,
                    h('div', { style: { padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, position: 'sticky', top: 0, background: COLORS.card, zIndex: 1 } },
                        h('div', { style: { fontWeight: 600, display: 'flex', alignItems: 'center', gap: 8 } },
                            '🚗 Tournées du jour'
                        ),
                        h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 4 } }, 
                            `${tournees.length} technicien(s) • ${events.length} intervention(s)`
                        )
                    ),
                    tournees.length === 0 ?
                        h('div', { style: { padding: 30, textAlign: 'center', color: COLORS.muted } },
                            h('div', { style: { fontSize: 32 } }, '🚗'),
                            h('p', { style: { marginTop: 12 } }, 'Aucune tournée')
                        ) :
                        h('div', { style: { padding: 12 } },
                            tournees.map(tournee => {
                                const isSelected = selectedTournee?.techId === tournee.techId;
                                const eventsWithCoords = tournee.events.filter(e => e.lat && e.lng).length;
                                
                                return h('div', { 
                                    key: tournee.techId,
                                    style: { marginBottom: 12 }
                                },
                                    // Header tournée
                                    h('div', { 
                                        onClick: () => setSelectedTournee(isSelected ? null : tournee),
                                        style: { 
                                            padding: '12px 14px',
                                            background: isSelected ? `${tournee.techColor}15` : COLORS.background,
                                            borderRadius: 10,
                                            cursor: 'pointer',
                                            border: `2px solid ${isSelected ? tournee.techColor : 'transparent'}`,
                                            transition: 'all 0.2s'
                                        }
                                    },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            h('div', { style: { 
                                                width: 36, height: 36, borderRadius: '50%', 
                                                background: tournee.techColor, 
                                                color: 'white',
                                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                fontWeight: 700, fontSize: 14
                                            } }, tournee.techName.charAt(0).toUpperCase()),
                                            h('div', { style: { flex: 1 } },
                                                h('div', { style: { fontWeight: 600, fontSize: 14 } }, tournee.techName),
                                                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 
                                                    `${tournee.events.length} intervention(s) • ${eventsWithCoords} GPS`
                                                )
                                            ),
                                            h('div', { style: { fontSize: 18 } }, isSelected ? '▼' : '▶')
                                        )
                                    ),
                                    
                                    // Liste des interventions
                                    isSelected && h('div', { style: { marginTop: 8, marginLeft: 20, borderLeft: `2px dashed ${tournee.techColor}`, paddingLeft: 12 } },
                                        tournee.events.map((event, idx) => {
                                            const statusColors = {
                                                'termine': '#10B981',
                                                'en-cours': '#3B82F6',
                                                'planifie': '#F59E0B'
                                            };
                                            const color = statusColors[event.status] || '#94A3B8';
                                            
                                            return h('div', { 
                                                key: event.id,
                                                onClick: () => setSelectedEvent(event),
                                                style: { 
                                                    display: 'flex', gap: 10, padding: '8px 10px',
                                                    background: COLORS.card, borderRadius: 8, marginBottom: 6,
                                                    cursor: 'pointer', border: `1px solid ${COLORS.border}`
                                                }
                                            },
                                                h('div', { style: { 
                                                    width: 22, height: 22, borderRadius: '50%',
                                                    background: color, color: 'white',
                                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                    fontSize: 11, fontWeight: 600, flexShrink: 0
                                                } }, idx + 1),
                                                h('div', { style: { flex: 1, minWidth: 0 } },
                                                    h('div', { style: { fontWeight: 600, fontSize: 12 } }, event.device_number || 'N/A'),
                                                    h('div', { style: { fontSize: 11, color: COLORS.muted, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } },
                                                        event.location || 'Lieu non défini'
                                                    ),
                                                    event.scheduled_time && h('div', { style: { fontSize: 10, color: COLORS.muted, marginTop: 2 } }, '🕐 ', event.scheduled_time)
                                                ),
                                                !event.lat && h('span', { style: { fontSize: 10, color: COLORS.warning } }, '⚠️')
                                            );
                                        }),
                                        
                                        // Boutons d'action
                                        eventsWithCoords > 0 && h('div', { style: { display: 'flex', gap: 8, marginTop: 8 } },
                                            h('button', { 
                                                className: 'btn btn-sm btn-primary',
                                                onClick: (e) => {
                                                    e.stopPropagation();
                                                    const waypoints = tournee.events.filter(ev => ev.lat && ev.lng).slice(0, 10);
                                                    if (waypoints.length === 0) return;
                                                    const origin = `${waypoints[0].lat},${waypoints[0].lng}`;
                                                    const dest = `${waypoints[waypoints.length - 1].lat},${waypoints[waypoints.length - 1].lng}`;
                                                    const waypointsStr = waypoints.slice(1, -1).map(w => `${w.lat},${w.lng}`).join('|');
                                                    window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}${waypointsStr ? `&waypoints=${waypointsStr}` : ''}&travelmode=driving`, '_blank');
                                                }
                                            }, '🗺️ Google Maps'),
                                            h('button', { 
                                                className: 'btn btn-sm btn-ghost',
                                                onClick: (e) => {
                                                    e.stopPropagation();
                                                    const first = tournee.events.find(ev => ev.lat && ev.lng);
                                                    if (first) window.open(`https://waze.com/ul?ll=${first.lat},${first.lng}&navigate=yes`, '_blank');
                                                }
                                            }, '🚙 Waze')
                                        )
                                    )
                                );
                            })
                        )
                ) :
                // Mode Timeline classique
                h(Fragment, null,
                    h('div', { style: { padding: '12px 16px', borderBottom: `1px solid ${COLORS.border}`, position: 'sticky', top: 0, background: COLORS.card, zIndex: 1, display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                        h('div', { style: { fontWeight: 600, display: 'flex', alignItems: 'center', gap: 8 } },
                            h(Icon, { name: 'planning', size: 18 }),
                            'Planning'
                        ),
                        h('button', { 
                            className: 'btn btn-ghost btn-sm',
                            onClick: () => setShowTimeline(false)
                        }, '✕')
                    ),
                    eventsByDay.length === 0 ?
                        h('div', { style: { padding: 30, textAlign: 'center', color: COLORS.muted } },
                            h(Icon, { name: 'map', size: 32, color: COLORS.muted }),
                            h('p', { style: { marginTop: 12 } }, 'Aucune intervention')
                        ) :
                        h('div', { style: { padding: 12 } },
                            eventsByDay.map(([day, dayEvents]) => h('div', { key: day, style: { marginBottom: 16 } },
                                h('div', { style: { 
                                    fontSize: 12, fontWeight: 600, color: COLORS.primary, marginBottom: 8,
                                    padding: '4px 8px', background: COLORS.primaryPastel, borderRadius: 6
                                } },
                                    new Date(day).toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' }),
                                    ` (${dayEvents.length})`
                                ),
                                dayEvents.map((event, idx) => {
                                    const tech = technicians.find(t => t.id === event.assigned_to);
                                    const isSelected = selectedEvent?.id === event.id;
                                    const statusColors = {
                                        'termine': { bg: '#D1FAE5', border: '#10B981' },
                                        'en-cours': { bg: '#DBEAFE', border: '#3B82F6' },
                                        'planifie': { bg: '#FEF3C7', border: '#F59E0B' }
                                    };
                                    const colors = statusColors[event.status] || { bg: '#F1F5F9', border: '#94A3B8' };
                                    
                                    return h('div', { 
                                        key: event.id,
                                        onClick: () => setSelectedEvent(event),
                                        style: { 
                                            display: 'flex', gap: 10, padding: '10px 12px',
                                            background: isSelected ? colors.bg : COLORS.card,
                                            borderRadius: 8, marginBottom: 6, cursor: 'pointer',
                                            border: `2px solid ${isSelected ? colors.border : 'transparent'}`,
                                            transition: 'all 0.15s'
                                        }
                                    },
                                        h('div', { style: { 
                                            width: 24, height: 24, borderRadius: '50%',
                                            background: colors.border, color: 'white',
                                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                                            fontSize: 11, fontWeight: 600, flexShrink: 0
                                        } }, idx + 1),
                                        h('div', { style: { flex: 1, minWidth: 0 } },
                                            h('div', { style: { fontWeight: 600, fontSize: 13, marginBottom: 2 } }, 
                                                event.device_number || 'N/A'
                                            ),
                                            h('div', { style: { fontSize: 11, color: COLORS.muted, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } },
                                                event.location || 'Lieu non défini'
                                            ),
                                            h('div', { style: { fontSize: 10, color: COLORS.muted, marginTop: 4, display: 'flex', gap: 8 } },
                                                event.scheduled_time && h('span', null, '🕐 ', event.scheduled_time),
                                                tech && h('span', null, '👤 ', tech.first_name || tech.email?.split('@')[0])
                                            )
                                        )
                                    );
                                })
                            ))
                        )
                )
            )
        ),
        
        // Modal détail intervention
        selectedEvent && h(Modal, {
            isOpen: true,
            onClose: () => setSelectedEvent(null),
            title: `📍 ${selectedEvent.device_number || 'Intervention'}`,
            size: 'md'
        },
            h('div', null,
                // Badges
                h('div', { style: { display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' } },
                    h('span', { className: `badge badge-${selectedEvent.status === 'termine' ? 'success' : selectedEvent.status === 'en-cours' ? 'info' : 'warning'}` },
                        selectedEvent.status || 'planifié'
                    ),
                    selectedEvent.priority && selectedEvent.priority !== 'normal' && 
                        h('span', { className: `badge badge-${selectedEvent.priority === 'urgente' ? 'danger' : 'warning'}` }, selectedEvent.priority)
                ),
                
                // Infos
                h('div', { className: 'info-grid', style: { marginBottom: 20 } },
                    h('div', { className: 'info-item' },
                        h('div', { className: 'info-label' }, '📍 Lieu'),
                        h('div', { className: 'info-value' }, selectedEvent.location || '-')
                    ),
                    h('div', { className: 'info-item' },
                        h('div', { className: 'info-label' }, '📅 Date'),
                        h('div', { className: 'info-value' }, selectedEvent.scheduled_date ? formatDate(selectedEvent.scheduled_date) : '-')
                    ),
                    h('div', { className: 'info-item' },
                        h('div', { className: 'info-label' }, '🕐 Heure'),
                        h('div', { className: 'info-value' }, selectedEvent.scheduled_time || '-')
                    ),
                    h('div', { className: 'info-item' },
                        h('div', { className: 'info-label' }, '👤 Technicien'),
                        h('div', { className: 'info-value' }, (() => {
                            const tech = technicians.find(t => t.id === selectedEvent.assigned_to);
                            return tech ? `${tech.first_name || ''} ${tech.last_name || ''}`.trim() : 'Non assigné';
                        })())
                    )
                ),
                
                // Boutons navigation GPS
                (selectedEvent.lat && selectedEvent.lng) && h('div', { style: { marginBottom: 20 } },
                    h('div', { style: { fontSize: 12, fontWeight: 600, marginBottom: 8, color: COLORS.muted } }, '🧭 Navigation GPS'),
                    h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap' } },
                        h('a', {
                            href: `https://www.google.com/maps/dir/?api=1&destination=${selectedEvent.lat},${selectedEvent.lng}`,
                            target: '_blank',
                            rel: 'noopener noreferrer',
                            className: 'btn btn-primary'
                        }, '🗺️ Google Maps'),
                        h('a', {
                            href: `https://waze.com/ul?ll=${selectedEvent.lat},${selectedEvent.lng}&navigate=yes`,
                            target: '_blank',
                            rel: 'noopener noreferrer',
                            className: 'btn btn-secondary',
                            style: { background: '#33CCFF', borderColor: '#33CCFF', color: 'white' }
                        }, '🚗 Waze'),
                        h('a', {
                            href: `https://maps.apple.com/?daddr=${selectedEvent.lat},${selectedEvent.lng}`,
                            target: '_blank',
                            rel: 'noopener noreferrer',
                            className: 'btn btn-secondary'
                        }, '🍎 Apple Maps')
                    )
                ),
                
                // Description
                selectedEvent.description && h('div', { style: { marginBottom: 20 } },
                    h('div', { style: { fontSize: 12, fontWeight: 600, marginBottom: 8, color: COLORS.muted } }, '📝 Description'),
                    h('p', { style: { margin: 0, padding: 12, background: COLORS.background, borderRadius: 8 } }, selectedEvent.description)
                )
            )
        ),
        
        // Modal Géocodage en masse
        showGeocodeModal && h(Modal, {
            isOpen: true,
            onClose: () => { if (!geocodingProgress.running) setShowGeocodeModal(false); },
            title: '📍 Géocodage des adresses',
            size: 'lg'
        },
            h('div', null,
                // Stats
                (() => {
                    const allTasks = data.tasks || [];
                    const withLocation = allTasks.filter(t => t.location);
                    const withGPS = allTasks.filter(t => t.latitude && t.longitude);
                    const needsGeocode = withLocation.filter(t => !t.latitude || !t.longitude);
                    
                    return h(Fragment, null,
                        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12, marginBottom: 20 } },
                            h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 24, fontWeight: 700, color: COLORS.primary } }, allTasks.length),
                                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Total travaux')
                            ),
                            h('div', { style: { padding: 16, background: '#D1FAE5', borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 24, fontWeight: 700, color: '#059669' } }, withGPS.length),
                                h('div', { style: { fontSize: 12, color: '#059669' } }, 'Avec GPS ✓')
                            ),
                            h('div', { style: { padding: 16, background: '#FEF3C7', borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 24, fontWeight: 700, color: '#D97706' } }, needsGeocode.length),
                                h('div', { style: { fontSize: 12, color: '#D97706' } }, 'À géocoder')
                            )
                        ),
                        
                        // Progression
                        geocodingProgress.running && h('div', { style: { marginBottom: 20 } },
                            h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 8 } },
                                h('span', null, 'Géocodage en cours...'),
                                h('span', null, `${geocodingProgress.current} / ${geocodingProgress.total}`)
                            ),
                            h('div', { style: { height: 8, background: COLORS.background, borderRadius: 4, overflow: 'hidden' } },
                                h('div', { style: { 
                                    height: '100%', 
                                    width: `${(geocodingProgress.current / geocodingProgress.total) * 100}%`,
                                    background: COLORS.primary,
                                    transition: 'width 0.3s'
                                } })
                            )
                        ),
                        
                        // Résultats
                        geocodingProgress.results.length > 0 && h('div', { style: { marginBottom: 20, maxHeight: 200, overflowY: 'auto' } },
                            h('div', { style: { fontSize: 12, fontWeight: 600, marginBottom: 8 } }, 'Résultats:'),
                            geocodingProgress.results.map((r, i) => h('div', { 
                                key: i, 
                                style: { 
                                    padding: '6px 10px', 
                                    fontSize: 12, 
                                    borderRadius: 4, 
                                    marginBottom: 4,
                                    background: r.success ? '#D1FAE5' : '#FEE2E2',
                                    color: r.success ? '#059669' : '#DC2626'
                                } 
                            },
                                r.success ? `✓ ${r.location}` : `✗ ${r.location}: ${r.error}`
                            ))
                        ),
                        
                        // Boutons
                        h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end' } },
                            !geocodingProgress.running && h('button', { 
                                className: 'btn btn-secondary', 
                                onClick: () => setShowGeocodeModal(false) 
                            }, 'Fermer'),
                            !geocodingProgress.running && needsGeocode.length > 0 && h('button', { 
                                className: 'btn btn-primary',
                                onClick: async () => {
                                    setGeocodingProgress({ running: true, current: 0, total: needsGeocode.length, results: [] });
                                    
                                    const results = [];
                                    for (let i = 0; i < needsGeocode.length; i++) {
                                        const task = needsGeocode[i];
                                        setGeocodingProgress(prev => ({ ...prev, current: i + 1 }));
                                        
                                        try {
                                            // Pause entre les requêtes (Photon est plus rapide que Nominatim)
                                            if (i > 0) await new Promise(r => setTimeout(r, 300));
                                            
                                            const response = await fetch(
                                                `https://photon.komoot.io/api/?q=${encodeURIComponent(task.location + ', France')}&limit=1&lang=fr`
                                            );
                                            const data = await response.json();
                                            
                                            if (data && data.features && data.features.length > 0) {
                                                const [lon, lat] = data.features[0].geometry.coordinates;
                                                // Mettre à jour dans Supabase
                                                await db.from('tasks').update({ 
                                                    latitude: parseFloat(lat), 
                                                    longitude: parseFloat(lon) 
                                                }).eq('id', task.id);
                                                
                                                results.push({ location: task.location, success: true });
                                            } else {
                                                results.push({ location: task.location, success: false, error: 'Adresse non trouvée' });
                                            }
                                        } catch (err) {
                                            results.push({ location: task.location, success: false, error: err.message });
                                        }
                                        
                                        setGeocodingProgress(prev => ({ ...prev, results: [...results] }));
                                    }
                                    
                                    setGeocodingProgress(prev => ({ ...prev, running: false }));
                                    const successCount = results.filter(r => r.success).length;
                                    showToast(`Géocodage terminé: ${successCount}/${needsGeocode.length} adresses trouvées`, successCount > 0 ? 'success' : 'warning');
                                    refresh();
                                }
                            }, `🚀 Géocoder ${needsGeocode.length} adresse(s)`)
                        ),
                        
                        // Info
                        h('div', { style: { marginTop: 16, padding: 12, background: '#EFF6FF', borderRadius: 8, fontSize: 12, color: '#1E40AF' } },
                            h('strong', null, '💡 Conseil: '),
                            'Pour de meilleurs résultats, utilisez des adresses complètes avec code postal et ville. ',
                            'Exemple: "123 rue de la République, 69001 Lyon"'
                        )
                    );
                })()
            )
        )
    );
};

// ==========================================
// AI PAGE - IA Prédictive v5.4
// ==========================================
const AIPage = ({ data, user, refresh, showToast, PredictiveAIDashboard }) => {
    const handleCreateTask = (taskData) => {
        showToast(`Tâche créée: ${taskData.device_number}`, 'success');
        // Ici on pourrait ouvrir le formulaire de création de tâche
    };
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' },
                h('h1', { className: 'page-title' }, '🤖 IA Prédictive'),
                h('p', { className: 'page-subtitle' }, 'Anticipation des pannes et maintenance préventive')
            ),
            h('div', { className: 'page-actions' },
                h('button', { className: 'btn btn-secondary', onClick: refresh }, 
                    h(Icon, { name: 'refresh', size: 16 }), 'Actualiser l\'analyse'
                )
            )
        ),
        h('div', { className: 'page-content' },
            PredictiveAIDashboard 
                ? h(PredictiveAIDashboard, {
                    data: data,
                    onCreateTask: handleCreateTask
                })
                : h('div', { className: 'card', style: { padding: 40, textAlign: 'center' } },
                    h('p', null, 'Module IA non disponible'),
                    h('p', { style: { color: 'var(--muted)' } }, 'Vérifiez que le module v5.4 est chargé')
                )
        )
    );
};

// ==========================================
// SETTINGS PAGE - Paramètres
// ==========================================
const SettingsPage = ({ data, user, refresh, showToast }) => {
    const [activeTab, setActiveTab] = useState('profile');
    const [profileForm, setProfileForm] = useState({ first_name: user.first_name || '', last_name: user.last_name || '', email: user.email || '' });
    const [notifPrefs, setNotifPrefs] = useState(null);
    const [loadingPrefs, setLoadingPrefs] = useState(false);
    
    // Catégories de retard configurables (depuis la BDD)
    const [overdueSettings, setOverdueSettings] = useState(['SAV/Travaux', 'Mise en service']);
    
    // Utilisateurs visibles dans le planning (depuis la BDD)
    const [planningUsers, setPlanningUsers] = useState(null); // null = tous les utilisateurs
    const [loadingSettings, setLoadingSettings] = useState(true);
    
    const isAdmin = user.role === 'admin';
    
    // Tous les utilisateurs (admins et techniciens)
    const allUsers = (data.users || []).filter(u => u.role === 'admin' || u.role === 'technicien');
    
    // Charger les paramètres depuis la base de données
    useEffect(() => {
        const loadSettings = async () => {
            try {
                const { data: settings } = await db.from('settings').select('*');
                if (settings) {
                    const overdueSettingRow = settings.find(s => s.key === 'overdue_categories');
                    const planningUsersRow = settings.find(s => s.key === 'planning_users');
                    
                    if (overdueSettingRow?.value) {
                        try {
                            setOverdueSettings(JSON.parse(overdueSettingRow.value));
                        } catch (e) { console.log('Error parsing overdue settings'); }
                    }
                    
                    if (planningUsersRow?.value) {
                        try {
                            const parsed = JSON.parse(planningUsersRow.value);
                            setPlanningUsers(parsed.length === 0 ? null : parsed);
                        } catch (e) { console.log('Error parsing planning users'); }
                    }
                }
            } catch (err) {
                console.log('Settings table not found, using defaults');
            } finally {
                setLoadingSettings(false);
            }
        };
        loadSettings();
    }, []);
    
    // Sauvegarder les utilisateurs du planning en base de données
    const savePlanningUsers = async () => {
        try {
            const valueToSave = planningUsers === null ? [] : planningUsers;
            await db.from('settings').upsert({ 
                key: 'planning_users', 
                value: JSON.stringify(valueToSave),
                updated_at: new Date().toISOString()
            }, { onConflict: 'key' });
            
            showToast('Utilisateurs du planning mis à jour');
            // Dispatch event pour notifier le planning
            window.dispatchEvent(new CustomEvent('planning-users-changed', { detail: planningUsers }));
            refresh();
        } catch (err) { 
            showToast('Erreur: ' + err.message, 'error'); 
        }
    };
    
    const togglePlanningUser = (userId) => {
        if (planningUsers === null) {
            // Premier clic : on passe de "tous" à "juste celui-ci décoché"
            const allIds = allUsers.map(u => u.id);
            setPlanningUsers(allIds.filter(id => id !== userId));
        } else if (planningUsers.includes(userId)) {
            setPlanningUsers(planningUsers.filter(id => id !== userId));
        } else {
            setPlanningUsers([...planningUsers, userId]);
        }
    };
    
    const selectAllPlanningUsers = () => {
        setPlanningUsers(null); // null = tous
    };
    
    const deselectAllPlanningUsers = () => {
        setPlanningUsers([]);
    };
    
    // Catégories disponibles pour les retards
    const defaultCategories = [
        { id: 'controle', name: 'Contrôle', icon: '🔍' },
        { id: 'entretiens', name: 'Entretiens', icon: '🛠️' },
        { id: 'mise_en_service', name: 'Mise en service', icon: '🚀' },
        { id: 'sav_travaux', name: 'SAV/Travaux', icon: '⚙️' },
        { id: 'reunion', name: 'Réunion', icon: '👥' },
        { id: 'formation', name: 'Formation', icon: '📚' },
        { id: 'deplacement', name: 'Déplacement', icon: '🚗' },
        { id: 'conge', name: 'Congé', icon: '🏖️' }
    ];
    const allCategories = data.categories?.length > 0 ? data.categories : defaultCategories;
    
    // Sauvegarder les catégories de retard en base de données
    const saveOverdueSettings = async () => {
        try {
            await db.from('settings').upsert({ 
                key: 'overdue_categories', 
                value: JSON.stringify(overdueSettings),
                updated_at: new Date().toISOString()
            }, { onConflict: 'key' });
            
            showToast('Catégories de retard mises à jour');
            // Dispatch event pour notifier les autres composants
            window.dispatchEvent(new CustomEvent('overdue-settings-changed', { detail: overdueSettings }));
            refresh();
        } catch (err) { 
            showToast('Erreur: ' + err.message, 'error'); 
        }
    };
    
    const toggleOverdueCategory = (catName) => {
        if (overdueSettings.includes(catName)) {
            setOverdueSettings(overdueSettings.filter(c => c !== catName));
        } else {
            setOverdueSettings([...overdueSettings, catName]);
        }
    };
    
    // Charger les préférences de notification
    useEffect(() => {
        const loadNotifPrefs = async () => {
            setLoadingPrefs(true);
            try {
                const { data: prefs } = await db.from('notification_preferences')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (prefs) {
                    setNotifPrefs(prefs);
                } else {
                    // Préférences par défaut
                    const defaultPrefs = {
                        user_id: user.id,
                        push_enabled: true,
                        in_app_enabled: true,
                        sound_enabled: true,
                        type_preferences: {
                            stock_alert: true,
                            task_assigned: true,
                            task_completed: true,
                            order_received: true,
                            timesheet_validated: true,
                            timesheet_rejected: true,
                            system_message: true
                        },
                        quiet_hours_enabled: false,
                        quiet_hours_start: '22:00',
                        quiet_hours_end: '07:00'
                    };
                    setNotifPrefs(defaultPrefs);
                }
            } catch (err) {
                console.error('Erreur chargement préférences:', err);
            } finally {
                setLoadingPrefs(false);
            }
        };
        loadNotifPrefs();
    }, [user.id]);
    
    // Sauvegarder les préférences de notification
    const saveNotifPrefs = async () => {
        try {
            await db.from('notification_preferences').upsert({
                ...notifPrefs,
                user_id: user.id,
                updated_at: new Date().toISOString()
            });
            showToast('Préférences de notification mises à jour');
        } catch (err) {
            showToast(err.message, 'error');
        }
    };
    
    // Sauvegarder profil
    const saveProfile = async () => {
        try {
            await db.from('profiles').upsert({
                id: user.id,
                email: user.email,
                first_name: profileForm.first_name,
                last_name: profileForm.last_name,
                role: user.role
            });
            showToast('Profil mis à jour');
            refresh();
        } catch (err) {
            showToast(err.message, 'error');
        }
    };
    
    // Export CSV
    const exportCSV = (type) => {
        let csvContent = '';
        let filename = '';
        
        if (type === 'parts') {
            csvContent = 'Référence;Désignation;Catégorie;Quantité;Stock Min;Fournisseur;Emplacement\n';
            data.parts.forEach(p => {
                csvContent += `${p.ref || ''};${p.name || ''};${p.category || ''};${p.quantity || 0};${p.min_stock || 0};${p.supplier || ''};${p.location || ''}\n`;
            });
            filename = 'stock-export.csv';
        } else if (type === 'tasks') {
            csvContent = 'Appareil;Emplacement;Tournée;Statut;Priorité;Date création\n';
            data.tasks.forEach(t => {
                csvContent += `${t.device_number || ''};${t.location || ''};${t.tournee || ''};${t.status || ''};${t.priority || ''};${t.created_at || ''}\n`;
            });
            filename = 'travaux-export.csv';
        } else if (type === 'orders') {
            csvContent = 'Nom;Référence;Quantité;Fournisseur;Statut;Date\n';
            data.orders.forEach(o => {
                csvContent += `${o.name || ''};${o.part_ref || ''};${o.quantity || 0};${o.supplier || ''};${o.status || ''};${o.created_at || ''}\n`;
            });
            filename = 'commandes-export.csv';
        }
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
        showToast('Export terminé');
    };
    
    const tabs = [
        { id: 'profile', label: 'Mon Profil', icon: 'user' },
        { id: 'notifications', label: 'Notifications', icon: 'bell' },
        ...(isAdmin ? [{ id: 'planning', label: 'Planning', icon: 'planning' }] : []),
        { id: 'export', label: 'Export Données', icon: 'download' },
        // v5.1 - Nouveaux onglets admin
        ...(isAdmin ? [
            { id: 'import', label: 'Import en masse', icon: 'upload' },
            { id: 'alerts', label: 'Alertes', icon: 'bell' },
            { id: 'audit', label: 'Audit & Historique', icon: 'history' },
            { id: 'api', label: 'API & Intégrations', icon: 'code' },
            { id: 'progilift', label: 'Progilift Sync', icon: 'refresh' },
        ] : []),
        // v5.5 - Personnalisation
        { id: 'customization', label: 'Personnalisation', icon: 'palette' },
        ...(isAdmin ? [{ id: 'roles', label: 'Rôles & Permissions', icon: 'users' }] : []),
        { id: 'shortcuts', label: 'Raccourcis clavier', icon: 'keyboard' },
        { id: 'about', label: 'À propos', icon: 'alert' }
    ];
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('h1', { className: 'page-title' }, 'Paramètres')
        ),
        
        h('div', { style: { display: 'grid', gridTemplateColumns: '220px 1fr', gap: 20 } },
            // Sidebar Tabs
            h('div', { className: 'card', style: { height: 'fit-content' } },
                h('div', { className: 'card-body', style: { padding: 8 } },
                    tabs.map(tab => h('div', {
                        key: tab.id,
                        onClick: () => setActiveTab(tab.id),
                        style: {
                            display: 'flex', alignItems: 'center', gap: 10,
                            padding: '12px 14px', borderRadius: 8, cursor: 'pointer',
                            background: activeTab === tab.id ? COLORS.primaryPastel : 'transparent',
                            color: activeTab === tab.id ? COLORS.primary : COLORS.textSecondary,
                            fontWeight: activeTab === tab.id ? 600 : 500, fontSize: 14,
                            transition: 'all 0.2s'
                        }
                    },
                        h(Icon, { name: tab.icon, size: 18 }),
                        tab.label
                    ))
                )
            ),
            
            // Content
            h('div', { className: 'card' },
                h('div', { className: 'card-body' },
                    // Profile Tab
                    activeTab === 'profile' && h('div', null,
                        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, 'Mon Profil'),
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 20, marginBottom: 24, padding: 20, background: COLORS.background, borderRadius: 12 } },
                            h('div', { style: { width: 64, height: 64, borderRadius: '50%', background: `linear-gradient(135deg, ${COLORS.primary}, ${COLORS.secondary})`, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontWeight: 700, fontSize: 24 } },
                                ((user.first_name?.[0] || '') + (user.last_name?.[0] || '')).toUpperCase() || user.email?.[0]?.toUpperCase()
                            ),
                            h('div', null,
                                h('div', { style: { fontSize: 18, fontWeight: 600 } }, (user.first_name || '') + ' ' + (user.last_name || '') || 'Sans nom'),
                                h('div', { style: { color: COLORS.muted } }, user.email),
                                h('span', { className: `badge badge-${user.role === 'admin' ? 'danger' : user.role === 'technicien' ? 'info' : 'muted'}`, style: { marginTop: 4 } }, user.role)
                            )
                        ),
                        h('div', { className: 'form-row' },
                            h('div', { className: 'form-group' },
                                h('label', { className: 'form-label' }, 'Prénom'),
                                h('input', { className: 'form-input', value: profileForm.first_name, onChange: e => setProfileForm({...profileForm, first_name: e.target.value}) })
                            ),
                            h('div', { className: 'form-group' },
                                h('label', { className: 'form-label' }, 'Nom'),
                                h('input', { className: 'form-input', value: profileForm.last_name, onChange: e => setProfileForm({...profileForm, last_name: e.target.value}) })
                            )
                        ),
                        h('div', { className: 'form-group' },
                            h('label', { className: 'form-label' }, 'Email'),
                            h('input', { className: 'form-input', value: user.email, disabled: true, style: { background: COLORS.background } })
                        ),
                        h('button', { className: 'btn btn-primary', onClick: saveProfile }, 'Enregistrer les modifications'),
                        
                        // Section Mot de passe
                        h('div', { style: { marginTop: 32, paddingTop: 24, borderTop: '1px solid var(--border)' } },
                            h('h3', { style: { marginBottom: 16, fontSize: 16, fontWeight: 600 } }, '🔐 Modifier mon mot de passe'),
                            h('div', { className: 'form-group' },
                                h('label', { className: 'form-label' }, 'Nouveau mot de passe'),
                                h('input', { type: 'password', className: 'form-input', id: 'newPassword', placeholder: 'Entrez votre nouveau mot de passe' })
                            ),
                            h('div', { className: 'form-group' },
                                h('label', { className: 'form-label' }, 'Confirmer le mot de passe'),
                                h('input', { type: 'password', className: 'form-input', id: 'confirmPassword', placeholder: 'Confirmez votre nouveau mot de passe' })
                            ),
                            h('button', { className: 'btn btn-warning', onClick: async () => {
                                const newPwd = document.getElementById('newPassword').value;
                                const confirmPwd = document.getElementById('confirmPassword').value;
                                if (!newPwd || newPwd.length < 6) {
                                    showToast('Le mot de passe doit contenir au moins 6 caractères', 'error');
                                    return;
                                }
                                if (newPwd !== confirmPwd) {
                                    showToast('Les mots de passe ne correspondent pas', 'error');
                                    return;
                                }
                                try {
                                    const { error } = await db.auth.updateUser({ password: newPwd });
                                    if (error) throw error;
                                    showToast('Mot de passe modifié avec succès', 'success');
                                    document.getElementById('newPassword').value = '';
                                    document.getElementById('confirmPassword').value = '';
                                } catch (err) {
                                    showToast(err.message, 'error');
                                }
                            }}, '🔒 Changer le mot de passe')
                        )
                    ),
                    
                    // Notifications Tab
                    activeTab === 'notifications' && h('div', null,
                        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '🔔 Préférences de Notifications'),
                        
                        loadingPrefs ? h('div', { style: { textAlign: 'center', padding: 40 } }, 'Chargement...') :
                        notifPrefs && h(Fragment, null,
                            // Paramètres globaux
                            h('div', { style: { marginBottom: 24 } },
                                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.muted, textTransform: 'uppercase' } }, 'Paramètres généraux'),
                                h('div', { style: { display: 'grid', gap: 12 } },
                                    h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 16, background: COLORS.background, borderRadius: 8 } },
                                        h('div', null,
                                            h('div', { style: { fontWeight: 600 } }, 'Notifications dans l\'application'),
                                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, 'Afficher les notifications dans l\'interface')
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 48, height: 26 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.in_app_enabled,
                                                onChange: e => setNotifPrefs({...notifPrefs, in_app_enabled: e.target.checked}),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.in_app_enabled ? COLORS.primary : COLORS.border,
                                                borderRadius: 26, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 20, width: 20, left: notifPrefs.in_app_enabled ? 24 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    ),
                                    h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 16, background: COLORS.background, borderRadius: 8 } },
                                        h('div', null,
                                            h('div', { style: { fontWeight: 600 } }, 'Notifications push'),
                                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, 'Recevoir sur mobile (nécessite l\'app)')
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 48, height: 26 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.push_enabled,
                                                onChange: e => setNotifPrefs({...notifPrefs, push_enabled: e.target.checked}),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.push_enabled ? COLORS.primary : COLORS.border,
                                                borderRadius: 26, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 20, width: 20, left: notifPrefs.push_enabled ? 24 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    ),
                                    h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 16, background: COLORS.background, borderRadius: 8 } },
                                        h('div', null,
                                            h('div', { style: { fontWeight: 600 } }, 'Son de notification'),
                                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, 'Jouer un son lors de la réception')
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 48, height: 26 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.sound_enabled,
                                                onChange: e => setNotifPrefs({...notifPrefs, sound_enabled: e.target.checked}),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.sound_enabled ? COLORS.primary : COLORS.border,
                                                borderRadius: 26, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 20, width: 20, left: notifPrefs.sound_enabled ? 24 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    )
                                )
                            ),
                            
                            // Types de notifications
                            h('div', { style: { marginBottom: 24 } },
                                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.muted, textTransform: 'uppercase' } }, 'Stock & Commandes'),
                                h('div', { style: { display: 'grid', gap: 6, marginBottom: 16 } },
                                    [
                                        { key: 'stock_alert', icon: '⚠️', label: 'Alertes stock', desc: 'Stock passant sous le minimum' },
                                        { key: 'order_created', icon: '🛍️', label: 'Commande créée', desc: 'Nouvelle commande passée' },
                                        { key: 'order_received', icon: '📬', label: 'Commande reçue', desc: 'Réception de commande' },
                                        { key: 'part_request', icon: '🛒', label: 'Demande de pièce', desc: 'Nouvelle demande de pièce' }
                                    ].map(type => h('div', { 
                                        key: type.key,
                                        style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 14px', background: COLORS.background, borderRadius: 8 } 
                                    },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            h('span', { style: { fontSize: 18 } }, type.icon),
                                            h('div', null,
                                                h('div', { style: { fontWeight: 500, fontSize: 13 } }, type.label),
                                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, type.desc)
                                            )
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 40, height: 22 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.type_preferences?.[type.key] !== false,
                                                onChange: e => setNotifPrefs({
                                                    ...notifPrefs, 
                                                    type_preferences: { ...notifPrefs.type_preferences, [type.key]: e.target.checked }
                                                }),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.type_preferences?.[type.key] !== false ? COLORS.success : COLORS.border,
                                                borderRadius: 22, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 16, width: 16, 
                                                    left: notifPrefs.type_preferences?.[type.key] !== false ? 20 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    ))
                                ),
                                
                                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.muted, textTransform: 'uppercase' } }, 'Travaux'),
                                h('div', { style: { display: 'grid', gap: 6, marginBottom: 16 } },
                                    [
                                        { key: 'task_assigned', icon: '📋', label: 'Travail assigné', desc: 'Quand un travail vous est assigné' },
                                        { key: 'task_completed', icon: '✅', label: 'Travail terminé', desc: 'Quand un travail est terminé' },
                                        { key: 'task_overdue', icon: '⏰', label: 'Travail en retard', desc: 'Rappel de travaux en retard' }
                                    ].map(type => h('div', { 
                                        key: type.key,
                                        style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 14px', background: COLORS.background, borderRadius: 8 } 
                                    },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            h('span', { style: { fontSize: 18 } }, type.icon),
                                            h('div', null,
                                                h('div', { style: { fontWeight: 500, fontSize: 13 } }, type.label),
                                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, type.desc)
                                            )
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 40, height: 22 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.type_preferences?.[type.key] !== false,
                                                onChange: e => setNotifPrefs({
                                                    ...notifPrefs, 
                                                    type_preferences: { ...notifPrefs.type_preferences, [type.key]: e.target.checked }
                                                }),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.type_preferences?.[type.key] !== false ? COLORS.success : COLORS.border,
                                                borderRadius: 22, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 16, width: 16, 
                                                    left: notifPrefs.type_preferences?.[type.key] !== false ? 20 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    ))
                                ),
                                
                                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.muted, textTransform: 'uppercase' } }, 'Planning'),
                                h('div', { style: { display: 'grid', gap: 6, marginBottom: 16 } },
                                    [
                                        { key: 'planning_event_assigned', icon: '📅', label: 'Événement assigné', desc: 'Événement planifié pour vous' },
                                        { key: 'planning_event_modified', icon: '✏️', label: 'Événement modifié', desc: 'Modification d\'un événement' },
                                        { key: 'planning_event_deleted', icon: '🗑️', label: 'Événement supprimé', desc: 'Suppression d\'un événement' }
                                    ].map(type => h('div', { 
                                        key: type.key,
                                        style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 14px', background: COLORS.background, borderRadius: 8 } 
                                    },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            h('span', { style: { fontSize: 18 } }, type.icon),
                                            h('div', null,
                                                h('div', { style: { fontWeight: 500, fontSize: 13 } }, type.label),
                                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, type.desc)
                                            )
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 40, height: 22 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.type_preferences?.[type.key] !== false,
                                                onChange: e => setNotifPrefs({
                                                    ...notifPrefs, 
                                                    type_preferences: { ...notifPrefs.type_preferences, [type.key]: e.target.checked }
                                                }),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.type_preferences?.[type.key] !== false ? COLORS.success : COLORS.border,
                                                borderRadius: 22, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 16, width: 16, 
                                                    left: notifPrefs.type_preferences?.[type.key] !== false ? 20 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    ))
                                ),
                                
                                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.muted, textTransform: 'uppercase' } }, 'Feuilles d\'heures'),
                                h('div', { style: { display: 'grid', gap: 6, marginBottom: 16 } },
                                    [
                                        { key: 'timesheet_submitted', icon: '📝', label: 'Feuille soumise', desc: 'Feuille d\'heures validée par un technicien' },
                                        { key: 'timesheet_validated', icon: '✅', label: 'Feuille approuvée', desc: 'Validation admin de votre feuille' },
                                        { key: 'timesheet_rejected', icon: '🔓', label: 'Feuille déverrouillée', desc: 'Déverrouillage pour modification' }
                                    ].map(type => h('div', { 
                                        key: type.key,
                                        style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 14px', background: COLORS.background, borderRadius: 8 } 
                                    },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            h('span', { style: { fontSize: 18 } }, type.icon),
                                            h('div', null,
                                                h('div', { style: { fontWeight: 500, fontSize: 13 } }, type.label),
                                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, type.desc)
                                            )
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 40, height: 22 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.type_preferences?.[type.key] !== false,
                                                onChange: e => setNotifPrefs({
                                                    ...notifPrefs, 
                                                    type_preferences: { ...notifPrefs.type_preferences, [type.key]: e.target.checked }
                                                }),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.type_preferences?.[type.key] !== false ? COLORS.success : COLORS.border,
                                                borderRadius: 22, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 16, width: 16, 
                                                    left: notifPrefs.type_preferences?.[type.key] !== false ? 20 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    ))
                                ),
                                
                                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.muted, textTransform: 'uppercase' } }, 'Mise en service'),
                                h('div', { style: { display: 'grid', gap: 6, marginBottom: 16 } },
                                    [
                                        { key: 'device_created', icon: '🏗️', label: 'Nouvel appareil MES', desc: 'Création d\'un appareil' },
                                        { key: 'inspection_report_created', icon: '📋', label: 'Rapport d\'inspection', desc: 'Nouveau rapport créé' },
                                        { key: 'bc_report_favorable', icon: '🏛️', label: 'Rapport BC', desc: 'Résultat bureau de contrôle' }
                                    ].map(type => h('div', { 
                                        key: type.key,
                                        style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 14px', background: COLORS.background, borderRadius: 8 } 
                                    },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            h('span', { style: { fontSize: 18 } }, type.icon),
                                            h('div', null,
                                                h('div', { style: { fontWeight: 500, fontSize: 13 } }, type.label),
                                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, type.desc)
                                            )
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 40, height: 22 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.type_preferences?.[type.key] !== false,
                                                onChange: e => setNotifPrefs({
                                                    ...notifPrefs, 
                                                    type_preferences: { ...notifPrefs.type_preferences, [type.key]: e.target.checked }
                                                }),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.type_preferences?.[type.key] !== false ? COLORS.success : COLORS.border,
                                                borderRadius: 22, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 16, width: 16, 
                                                    left: notifPrefs.type_preferences?.[type.key] !== false ? 20 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    ))
                                ),
                                
                                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.muted, textTransform: 'uppercase' } }, 'Système'),
                                h('div', { style: { display: 'grid', gap: 6 } },
                                    [
                                        { key: 'system_message', icon: '📢', label: 'Messages système', desc: 'Annonces et informations' }
                                    ].map(type => h('div', { 
                                        key: type.key,
                                        style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '10px 14px', background: COLORS.background, borderRadius: 8 } 
                                    },
                                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } },
                                            h('span', { style: { fontSize: 18 } }, type.icon),
                                            h('div', null,
                                                h('div', { style: { fontWeight: 500, fontSize: 13 } }, type.label),
                                                h('div', { style: { fontSize: 11, color: COLORS.muted } }, type.desc)
                                            )
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 40, height: 22 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.type_preferences?.[type.key] !== false,
                                                onChange: e => setNotifPrefs({
                                                    ...notifPrefs, 
                                                    type_preferences: { ...notifPrefs.type_preferences, [type.key]: e.target.checked }
                                                }),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.type_preferences?.[type.key] !== false ? COLORS.success : COLORS.border,
                                                borderRadius: 22, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 16, width: 16, 
                                                    left: notifPrefs.type_preferences?.[type.key] !== false ? 20 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    ))
                                )
                            ),
                            
                            // Heures silencieuses
                            h('div', { style: { marginBottom: 24 } },
                                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.muted, textTransform: 'uppercase' } }, 'Heures silencieuses'),
                                h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8 } },
                                    h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: notifPrefs.quiet_hours_enabled ? 16 : 0 } },
                                        h('div', null,
                                            h('div', { style: { fontWeight: 600 } }, 'Activer les heures silencieuses'),
                                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, 'Pas de notifications push pendant cette période')
                                        ),
                                        h('label', { style: { position: 'relative', display: 'inline-block', width: 48, height: 26 } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: notifPrefs.quiet_hours_enabled,
                                                onChange: e => setNotifPrefs({...notifPrefs, quiet_hours_enabled: e.target.checked}),
                                                style: { opacity: 0, width: 0, height: 0 }
                                            }),
                                            h('span', { style: { 
                                                position: 'absolute', cursor: 'pointer', inset: 0, 
                                                backgroundColor: notifPrefs.quiet_hours_enabled ? COLORS.primary : COLORS.border,
                                                borderRadius: 26, transition: '0.3s'
                                            }},
                                                h('span', { style: {
                                                    position: 'absolute', height: 20, width: 20, left: notifPrefs.quiet_hours_enabled ? 24 : 3, bottom: 3,
                                                    backgroundColor: 'white', borderRadius: '50%', transition: '0.3s'
                                                }})
                                            )
                                        )
                                    ),
                                    notifPrefs.quiet_hours_enabled && h('div', { className: 'form-row' },
                                        h('div', { className: 'form-group' },
                                            h('label', { className: 'form-label' }, 'De'),
                                            h('input', { 
                                                type: 'time', 
                                                className: 'form-input',
                                                value: notifPrefs.quiet_hours_start || '22:00',
                                                onChange: e => setNotifPrefs({...notifPrefs, quiet_hours_start: e.target.value})
                                            })
                                        ),
                                        h('div', { className: 'form-group' },
                                            h('label', { className: 'form-label' }, 'À'),
                                            h('input', { 
                                                type: 'time', 
                                                className: 'form-input',
                                                value: notifPrefs.quiet_hours_end || '07:00',
                                                onChange: e => setNotifPrefs({...notifPrefs, quiet_hours_end: e.target.value})
                                            })
                                        )
                                    )
                                )
                            ),
                            
                            h('button', { className: 'btn btn-primary', onClick: saveNotifPrefs }, 'Enregistrer les préférences')
                        )
                    ),
                    
                    // Planning Tab (Admin only)
                    activeTab === 'planning' && isAdmin && h('div', null,
                        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '📅 Paramètres du Planning'),
                        
                        // Section Catégories de retard
                        h('div', { style: { marginBottom: 24 } },
                            h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.muted, textTransform: 'uppercase' } }, 'Catégories suivies pour les retards'),
                            h('p', { style: { fontSize: 13, color: COLORS.muted, marginBottom: 16 } }, 
                                'Sélectionnez les catégories d\'événements qui doivent être suivies pour les retards. Les tâches en retard de ces catégories apparaîtront dans la bannière d\'alerte et dans les tâches à replanifier.'
                            ),
                            h('div', { style: { display: 'grid', gap: 8 } },
                                allCategories.map(cat => h('div', { 
                                    key: cat.id || cat.name,
                                    onClick: () => toggleOverdueCategory(cat.name),
                                    style: { 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        justifyContent: 'space-between', 
                                        padding: '12px 16px', 
                                        background: overdueSettings.includes(cat.name) ? COLORS.dangerPastel : COLORS.background, 
                                        borderRadius: 8,
                                        border: overdueSettings.includes(cat.name) ? `2px solid ${COLORS.danger}` : '2px solid transparent',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    } 
                                },
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                        h('span', { style: { fontSize: 24 } }, cat.icon),
                                        h('div', null,
                                            h('div', { style: { fontWeight: 600, fontSize: 14 } }, cat.name),
                                            h('div', { style: { fontSize: 12, color: COLORS.muted } }, 
                                                overdueSettings.includes(cat.name) ? '⚠️ Suivi des retards activé' : 'Retards non suivis'
                                            )
                                        )
                                    ),
                                    h('div', { style: { 
                                        width: 24, 
                                        height: 24, 
                                        borderRadius: 6, 
                                        background: overdueSettings.includes(cat.name) ? COLORS.danger : COLORS.border,
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontWeight: 700
                                    } }, overdueSettings.includes(cat.name) ? '✓' : '')
                                ))
                            )
                        ),
                        
                        // Résumé
                        h('div', { style: { padding: 16, background: COLORS.infoPastel, borderRadius: 8, marginBottom: 24 } },
                            h('div', { style: { fontWeight: 600, color: COLORS.info, marginBottom: 8 } }, '📊 Résumé'),
                            h('div', { style: { fontSize: 14, color: COLORS.text } }, 
                                overdueSettings.length === 0 
                                    ? 'Aucune catégorie suivie. Les alertes de retard sont désactivées.'
                                    : `${overdueSettings.length} catégorie(s) suivie(s) : ${overdueSettings.join(', ')}`
                            )
                        ),
                        
                        // Informations
                        h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8, marginBottom: 24 } },
                            h('div', { style: { fontWeight: 600, marginBottom: 8 } }, '💡 Comment ça fonctionne'),
                            h('ul', { style: { fontSize: 13, color: COLORS.muted, paddingLeft: 20, margin: 0 } },
                                h('li', { style: { marginBottom: 4 } }, 'Les tâches en retard (date passée, non terminées) des catégories sélectionnées apparaissent dans la bannière d\'alerte'),
                                h('li', { style: { marginBottom: 4 } }, 'Ces tâches apparaissent également dans "Tâches à planifier" pour être replanifiées'),
                                h('li', { style: { marginBottom: 4 } }, 'Les tâches replanifiées créent une copie, l\'originale reste visible dans le planning passé'),
                                h('li', null, 'Expiration : 30 jours après la date prévue')
                            )
                        ),
                        
                        h('button', { className: 'btn btn-primary', onClick: saveOverdueSettings }, 
                            h(Icon, { name: 'checkCircle', size: 18 }), 
                            'Enregistrer les paramètres'
                        ),
                        
                        // Séparateur
                        h('hr', { style: { margin: '32px 0', border: 'none', borderTop: '1px solid ' + COLORS.border } }),
                        
                        // Section Utilisateurs visibles dans le planning
                        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '👥 Utilisateurs du Planning'),
                        
                        h('p', { style: { fontSize: 13, color: COLORS.muted, marginBottom: 16 } }, 
                            'Sélectionnez les utilisateurs qui doivent apparaître dans le planning. Les utilisateurs non sélectionnés ne seront pas visibles dans les colonnes du planning.'
                        ),
                        
                        // Boutons tout sélectionner / tout désélectionner
                        h('div', { style: { display: 'flex', gap: 8, marginBottom: 16 } },
                            h('button', { 
                                className: 'btn btn-sm ' + (planningUsers === null ? 'btn-primary' : 'btn-secondary'),
                                onClick: selectAllPlanningUsers 
                            }, 'Tous'),
                            h('button', { 
                                className: 'btn btn-sm ' + (planningUsers && planningUsers.length === 0 ? 'btn-primary' : 'btn-secondary'),
                                onClick: deselectAllPlanningUsers 
                            }, 'Aucun')
                        ),
                        
                        h('div', { style: { display: 'grid', gap: 8, marginBottom: 24 } },
                            allUsers.map(u => {
                                const isSelected = planningUsers === null || planningUsers.includes(u.id);
                                const userName = ((u.first_name || '') + ' ' + (u.last_name || '')).trim() || u.email;
                                return h('div', { 
                                    key: u.id,
                                    onClick: () => togglePlanningUser(u.id),
                                    style: { 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        justifyContent: 'space-between', 
                                        padding: '12px 16px', 
                                        background: isSelected ? COLORS.successPastel : COLORS.background, 
                                        borderRadius: 8,
                                        border: isSelected ? `2px solid ${COLORS.success}` : '2px solid transparent',
                                        cursor: 'pointer',
                                        transition: 'all 0.2s'
                                    } 
                                },
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                        h('div', { 
                                            style: { 
                                                width: 36, height: 36, borderRadius: '50%', 
                                                background: `linear-gradient(135deg, ${COLORS.primary}, ${COLORS.secondary})`, 
                                                display: 'flex', alignItems: 'center', justifyContent: 'center', 
                                                color: 'white', fontWeight: 600, fontSize: 14 
                                            } 
                                        }, ((u.first_name?.[0] || '') + (u.last_name?.[0] || '')).toUpperCase() || u.email?.[0]?.toUpperCase()),
                                        h('div', null,
                                            h('div', { style: { fontWeight: 600, fontSize: 14 } }, userName),
                                            h('div', { style: { fontSize: 12, color: COLORS.muted } }, 
                                                u.role === 'admin' ? '👑 Admin' : '🔧 Technicien'
                                            )
                                        )
                                    ),
                                    h('div', { style: { 
                                        width: 24, 
                                        height: 24, 
                                        borderRadius: 6, 
                                        background: isSelected ? COLORS.success : COLORS.border,
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontWeight: 700
                                    } }, isSelected ? '✓' : '')
                                );
                            })
                        ),
                        
                        // Résumé
                        h('div', { style: { padding: 16, background: COLORS.infoPastel, borderRadius: 8, marginBottom: 24 } },
                            h('div', { style: { fontWeight: 600, color: COLORS.info, marginBottom: 8 } }, '📊 Résumé'),
                            h('div', { style: { fontSize: 14, color: COLORS.text } }, 
                                planningUsers === null 
                                    ? `Tous les utilisateurs (${allUsers.length}) sont visibles dans le planning.`
                                    : planningUsers.length === 0
                                        ? 'Aucun utilisateur sélectionné. Le planning sera vide.'
                                        : `${planningUsers.length} utilisateur(s) visible(s) : ${allUsers.filter(u => planningUsers.includes(u.id)).map(u => ((u.first_name || '') + ' ' + (u.last_name || '')).trim() || u.email).join(', ')}`
                            )
                        ),
                        
                        h('button', { className: 'btn btn-primary', onClick: savePlanningUsers }, 
                            h(Icon, { name: 'checkCircle', size: 18 }), 
                            'Enregistrer les utilisateurs'
                        )
                    ),
                    
                    // Export Tab
                    activeTab === 'export' && h('div', null,
                        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, 'Export des Données'),
                        h('p', { style: { color: COLORS.muted, marginBottom: 24, fontSize: 14 } }, 'Exportez vos données au format CSV pour les utiliser dans Excel ou un autre logiciel.'),
                        h('div', { style: { display: 'grid', gap: 12 } },
                            h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 16, background: COLORS.background, borderRadius: 8 } },
                                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                    h('div', { style: { width: 40, height: 40, borderRadius: 8, background: COLORS.primaryPastel, display: 'flex', alignItems: 'center', justifyContent: 'center', color: COLORS.primary } }, h(Icon, { name: 'stock', size: 20 })),
                                    h('div', null,
                                        h('div', { style: { fontWeight: 600 } }, 'Stock'),
                                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, `${data.parts.length} pièces`)
                                    )
                                ),
                                h('button', { className: 'btn btn-secondary btn-sm', onClick: () => exportCSV('parts') }, h(Icon, { name: 'download', size: 16 }), 'Exporter')
                            ),
                            h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 16, background: COLORS.background, borderRadius: 8 } },
                                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                    h('div', { style: { width: 40, height: 40, borderRadius: 8, background: COLORS.successPastel, display: 'flex', alignItems: 'center', justifyContent: 'center', color: COLORS.success } }, h(Icon, { name: 'tasks', size: 20 })),
                                    h('div', null,
                                        h('div', { style: { fontWeight: 600 } }, 'Travaux'),
                                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, `${data.tasks.length} travaux`)
                                    )
                                ),
                                h('button', { className: 'btn btn-secondary btn-sm', onClick: () => exportCSV('tasks') }, h(Icon, { name: 'download', size: 16 }), 'Exporter')
                            ),
                            h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 16, background: COLORS.background, borderRadius: 8 } },
                                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                    h('div', { style: { width: 40, height: 40, borderRadius: 8, background: COLORS.warningPastel, display: 'flex', alignItems: 'center', justifyContent: 'center', color: COLORS.warning } }, h(Icon, { name: 'orders', size: 20 })),
                                    h('div', null,
                                        h('div', { style: { fontWeight: 600 } }, 'Commandes'),
                                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, `${data.orders.length} commandes`)
                                    )
                                ),
                                h('button', { className: 'btn btn-secondary btn-sm', onClick: () => exportCSV('orders') }, h(Icon, { name: 'download', size: 16 }), 'Exporter')
                            )
                        )
                    ),
                    
                    // v5.1 - Import Tab (Admin only)
                    activeTab === 'import' && isAdmin && h(ImportPageInline, { data, user, refresh, showToast }),
                    
                    // v5.1 - Alerts Tab (Admin only)
                    activeTab === 'alerts' && isAdmin && h(AlertsPageInline, { data, user, refresh, showToast }),
                    
                    // v5.1 - Audit Tab (Admin only)
                    activeTab === 'audit' && isAdmin && h(AuditPageInline, { data, user, refresh, showToast }),
                    
                    // v5.1 - API Tab (Admin only)
                    activeTab === 'api' && isAdmin && h(ApiDocsPageInline, { data, user, refresh, showToast }),
                    
                    // Progilift Sync Tab (Admin only)
                    activeTab === 'progilift' && isAdmin && h(ProgiliftSyncTab, { data, user, refresh, showToast }),
                    
                    // v5.5 - Customization Tab
                    activeTab === 'customization' && h('div', null,
                        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '🎨 Personnalisation'),
                        
                        // Thèmes
                        h('div', { style: { marginBottom: 24 } },
                            h('h4', { style: { marginBottom: 12, fontSize: 15, fontWeight: 600 } }, 'Thème de l\'application'),
                            h('p', { style: { color: COLORS.muted, fontSize: 13, marginBottom: 16 } }, 
                                'Choisissez un thème prédéfini ou créez le vôtre aux couleurs de votre entreprise.'
                            ),
                            h('div', { style: { display: 'flex', gap: 12, flexWrap: 'wrap' } },
                                ThemeCustomizer.getAllThemes().map(theme => h('div', {
                                    key: theme.id,
                                    onClick: () => { ThemeCustomizer.setActiveTheme(theme.id); refresh(); },
                                    style: {
                                        padding: 16, borderRadius: 12, cursor: 'pointer', minWidth: 120,
                                        border: `2px solid ${ThemeCustomizer.getActiveThemeId() === theme.id ? COLORS.primary : COLORS.border}`,
                                        background: theme.colors.background
                                    }
                                },
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 } },
                                        h('span', { style: { fontSize: 20 } }, theme.icon),
                                        h('span', { style: { fontWeight: 600, color: theme.colors.text } }, theme.name)
                                    ),
                                    h('div', { style: { display: 'flex', gap: 4 } },
                                        h('div', { style: { width: 20, height: 20, borderRadius: 4, background: theme.colors.primary } }),
                                        h('div', { style: { width: 20, height: 20, borderRadius: 4, background: theme.colors.card, border: `1px solid ${theme.colors.border}` } }),
                                        h('div', { style: { width: 20, height: 20, borderRadius: 4, background: theme.colors.success } })
                                    ),
                                    ThemeCustomizer.getActiveThemeId() === theme.id && 
                                        h('div', { style: { marginTop: 8, color: COLORS.primary, fontSize: 12, fontWeight: 600 } }, '✓ Actif')
                                ))
                            )
                        ),
                        
                        // Widgets Dashboard
                        h('div', { style: { marginBottom: 24, paddingTop: 20, borderTop: `1px solid ${COLORS.border}` } },
                            h('h4', { style: { marginBottom: 12, fontSize: 15, fontWeight: 600 } }, 'Widgets du tableau de bord'),
                            h('p', { style: { color: COLORS.muted, fontSize: 13, marginBottom: 16 } }, 
                                'Personnalisez les widgets affichés sur votre tableau de bord.'
                            ),
                            h('div', { style: { padding: 20, background: COLORS.background, borderRadius: 12, textAlign: 'center' } },
                                h('p', { style: { color: COLORS.muted, marginBottom: 12 } }, 
                                    '19 widgets disponibles : KPIs, graphiques, listes, utilitaires...'
                                ),
                                h('button', { 
                                    className: 'btn btn-secondary',
                                    onClick: () => showToast('Configuration des widgets disponible dans le Dashboard', 'info')
                                }, '⚙️ Configurer les widgets')
                            )
                        ),
                        
                        // Vues sauvegardées
                        h('div', { style: { paddingTop: 20, borderTop: `1px solid ${COLORS.border}` } },
                            h('h4', { style: { marginBottom: 12, fontSize: 15, fontWeight: 600 } }, 'Vues sauvegardées'),
                            h('p', { style: { color: COLORS.muted, fontSize: 13, marginBottom: 16 } }, 
                                'Sauvegardez vos filtres et configurations de colonnes pour chaque page.'
                            ),
                            h('div', { style: { padding: 20, background: COLORS.background, borderRadius: 12 } },
                                h('p', { style: { color: COLORS.muted, fontSize: 13 } }, 
                                    'Les vues sont sauvegardées automatiquement par page. Utilisez le bouton "💾 Sauvegarder la vue" dans chaque page pour créer une vue personnalisée.'
                                )
                            )
                        )
                    ),
                    
                    // v5.5 - Roles Tab (Admin only)
                    activeTab === 'roles' && isAdmin && h('div', null,
                        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '🔐 Rôles & Permissions'),
                        h('p', { style: { color: COLORS.muted, fontSize: 13, marginBottom: 20 } }, 
                            'Gérez les rôles et permissions des utilisateurs. Les rôles système ne peuvent pas être modifiés.'
                        ),
                        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16 } },
                            RolesSystem.getAllRoles().map(role => h('div', {
                                key: role.id,
                                style: {
                                    padding: 16, borderRadius: 12, border: `1px solid ${COLORS.border}`,
                                    background: role.isSystem ? COLORS.background : COLORS.card
                                }
                            },
                                h('div', { style: { display: 'flex', alignItems: 'center', gap: 10, marginBottom: 8 } },
                                    h('span', { style: { fontSize: 24 } }, role.icon),
                                    h('div', null,
                                        h('div', { style: { fontWeight: 600 } }, role.name),
                                        role.isSystem && h('span', { 
                                            style: { fontSize: 10, background: COLORS.muted, color: 'white', padding: '2px 6px', borderRadius: 4 } 
                                        }, 'Système')
                                    )
                                ),
                                h('div', { style: { fontSize: 12, color: COLORS.muted } },
                                    Object.values(role.permissions).filter(Boolean).length, ' permissions actives'
                                )
                            ))
                        ),
                        h('div', { style: { marginTop: 20, textAlign: 'center' } },
                            h('button', { 
                                className: 'btn btn-primary',
                                onClick: () => window.dispatchEvent(new CustomEvent('open-roles-manager'))
                            }, '+ Créer un nouveau rôle')
                        )
                    ),
                    
                    // v5.5 - Shortcuts Tab
                    activeTab === 'shortcuts' && h('div', null,
                        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '⌨️ Raccourcis clavier'),
                        h('p', { style: { color: COLORS.muted, fontSize: 13, marginBottom: 20 } }, 
                            'Personnalisez les raccourcis clavier pour accélérer votre travail.'
                        ),
                        h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                            ShortcutsSystem.getAllShortcuts().map(shortcut => h('div', {
                                key: shortcut.id,
                                style: {
                                    display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                                    padding: '12px 16px', borderRadius: 8, background: COLORS.background
                                }
                            },
                                h('div', null,
                                    h('div', { style: { fontWeight: 500 } }, shortcut.label),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, shortcut.action)
                                ),
                                h('kbd', { 
                                    style: { 
                                        padding: '6px 12px', background: COLORS.card, borderRadius: 6,
                                        fontFamily: 'monospace', fontSize: 13, border: `1px solid ${COLORS.border}`
                                    } 
                                }, ShortcutsSystem.formatKeys(shortcut.keys))
                            ))
                        ),
                        h('div', { style: { marginTop: 20, display: 'flex', gap: 12 } },
                            h('button', { 
                                className: 'btn btn-secondary',
                                onClick: () => window.dispatchEvent(new CustomEvent('open-shortcuts-manager'))
                            }, '+ Ajouter un raccourci'),
                            h('button', { 
                                className: 'btn btn-ghost',
                                onClick: () => {
                                    ShortcutsSystem.resetToDefaults();
                                    refresh();
                                    showToast('Raccourcis réinitialisés');
                                }
                            }, '↺ Réinitialiser')
                        )
                    ),
                    
                    // About Tab
                    activeTab === 'about' && h('div', null,
                        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, 'À propos de StockApp'),
                        h('div', { style: { textAlign: 'center', padding: 40 } },
                            h('div', { style: { width: 80, height: 80, margin: '0 auto 20px', background: `linear-gradient(135deg, ${COLORS.primary}, ${COLORS.primaryDark})`, borderRadius: 20, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'white', fontSize: 32, fontWeight: 800 } }, 'S'),
                            h('h2', { style: { fontSize: 24, fontWeight: 700, marginBottom: 4 } }, 'StockApp'),
                            h('p', { style: { color: COLORS.muted, marginBottom: 24 } }, 'Version 5.5')
                        ),
                        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 16 } },
                            h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8 } },
                                h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, 'Pièces en stock'),
                                h('div', { style: { fontSize: 24, fontWeight: 700 } }, data.parts.length)
                            ),
                            h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8 } },
                                h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, 'Travaux'),
                                h('div', { style: { fontSize: 24, fontWeight: 700 } }, data.tasks.length)
                            ),
                            h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8 } },
                                h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, 'Commandes'),
                                h('div', { style: { fontSize: 24, fontWeight: 700 } }, data.orders.length)
                            ),
                            h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8 } },
                                h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, 'Utilisateurs'),
                                h('div', { style: { fontSize: 24, fontWeight: 700 } }, data.users.length)
                            )
                        ),
                        h('div', { style: { marginTop: 24, padding: 16, background: COLORS.background, borderRadius: 8, fontSize: 12, color: COLORS.muted } },
                            h('div', null, '© 2024-2025 StockApp'),
                            h('div', null, 'Base de données: Supabase'),
                            h('div', null, 'Interface: React + Plus Jakarta Sans')
                        )
                    )
                )
            )
        )
    );
};

// ============================================================================
// v5.1 - COMPOSANTS INLINE POUR SETTINGS
// ============================================================================

// Import Page Inline pour Settings
const ImportPageInline = ({ data, user, refresh, showToast }) => {
    const [importType, setImportType] = useState('parts');
    const [file, setFile] = useState(null);
    const [preview, setPreview] = useState([]);
    const [mapping, setMapping] = useState({});
    const [importing, setImporting] = useState(false);
    const [importResults, setImportResults] = useState(null);
    const [dragOver, setDragOver] = useState(false);

    const expectedFields = {
        parts: ['reference', 'name', 'category', 'quantity', 'min_stock', 'price', 'location', 'supplier'],
        tasks: ['device_number', 'address', 'intervention_type', 'description', 'assigned_to', 'status'],
        orders: ['supplier', 'part_reference', 'quantity', 'unit_price', 'status']
    };

    const handleFileDrop = (e) => {
        e.preventDefault();
        setDragOver(false);
        const droppedFile = e.dataTransfer?.files?.[0] || e.target.files?.[0];
        if (droppedFile) processFile(droppedFile);
    };

    const processFile = async (selectedFile) => {
        setFile(selectedFile);
        const ext = selectedFile.name.split('.').pop().toLowerCase();
        try {
            if (ext === 'csv') {
                const text = await selectedFile.text();
                const lines = text.split('\n').filter(l => l.trim());
                if (lines.length < 2) { showToast('Fichier vide', 'error'); return; }
                const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
                const rows = lines.slice(1).map(line => {
                    const values = line.split(';').map(v => v.trim().replace(/"/g, ''));
                    const row = {};
                    headers.forEach((h, i) => row[h] = values[i] || '');
                    return row;
                });
                setPreview(rows.slice(0, 10));
                autoMap(headers);
            } else if (['xlsx', 'xls'].includes(ext)) {
                if (typeof XLSX !== 'undefined') {
                    const arrayBuffer = await selectedFile.arrayBuffer();
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    setPreview(jsonData.slice(0, 10));
                    if (jsonData.length > 0) autoMap(Object.keys(jsonData[0]));
                } else {
                    showToast('Librairie Excel non chargée', 'error');
                }
            }
        } catch (error) {
            showToast('Erreur lecture fichier', 'error');
        }
    };

    const autoMap = (headers) => {
        const newMapping = {};
        const fields = expectedFields[importType];
        headers.forEach(header => {
            const headerLower = header.toLowerCase();
            const matchedField = fields.find(f => headerLower.includes(f) || f.includes(headerLower));
            if (matchedField) newMapping[header] = matchedField;
        });
        setMapping(newMapping);
    };

    const handleImport = async () => {
        if (preview.length === 0) { showToast('Aucune donnée', 'error'); return; }
        setImporting(true);
        let success = 0, errors = 0;
        try {
            for (const row of preview) {
                const mappedData = {};
                Object.entries(mapping).forEach(([source, target]) => {
                    if (target && row[source]) mappedData[target] = row[source];
                });
                if (Object.keys(mappedData).length > 0) {
                    const { error } = await db.from(importType).insert(mappedData);
                    if (error) errors++; else success++;
                }
            }
            setImportResults({ success, errors, total: preview.length });
            if (success > 0) { showToast(`${success} importés`, 'success'); refresh(); }
            if (errors > 0) showToast(`${errors} erreurs`, 'warning');
        } catch (error) {
            showToast('Erreur import', 'error');
        }
        setImporting(false);
    };

    const resetImport = () => { setFile(null); setPreview([]); setMapping({}); setImportResults(null); };

    return h('div', null,
        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '📥 Import en masse'),
        h('p', { style: { color: COLORS.muted, marginBottom: 20 } }, 'Importez des données depuis CSV ou Excel'),
        h('div', { style: { display: 'flex', gap: 12, marginBottom: 20 } },
            ['parts', 'tasks', 'orders'].map(type =>
                h('button', {
                    key: type,
                    className: `btn ${importType === type ? 'btn-primary' : 'btn-secondary'} btn-sm`,
                    onClick: () => { setImportType(type); resetImport(); }
                }, type === 'parts' ? '📦 Pièces' : type === 'tasks' ? '🔧 Tâches' : '🛒 Commandes')
            )
        ),
        !file ?
            h('div', {
                style: { border: '3px dashed var(--border)', borderRadius: 16, padding: 40, textAlign: 'center', background: dragOver ? 'var(--primary-pastel)' : 'var(--background)' },
                onDragOver: e => { e.preventDefault(); setDragOver(true); },
                onDragLeave: () => setDragOver(false),
                onDrop: handleFileDrop
            },
                h('div', { style: { fontSize: 48, marginBottom: 16 } }, '📁'),
                h('p', { style: { fontWeight: 600, marginBottom: 8 } }, 'Glissez-déposez votre fichier'),
                h('label', { className: 'btn btn-primary', style: { cursor: 'pointer' } },
                    'Parcourir...',
                    h('input', { type: 'file', accept: '.csv,.xlsx,.xls', style: { display: 'none' }, onChange: handleFileDrop })
                ),
                h('p', { style: { fontSize: 12, color: COLORS.muted, marginTop: 12 } }, 'Formats: CSV, XLSX, XLS')
            ) :
            h('div', null,
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 } },
                    h('span', { style: { fontWeight: 600 } }, '📄 ' + file.name),
                    h('button', { className: 'btn btn-ghost btn-sm', onClick: resetImport }, '✕ Annuler')
                ),
                h('div', { style: { marginBottom: 16 } },
                    h('div', { style: { fontWeight: 500, marginBottom: 8 } }, 'Correspondance des colonnes:'),
                    Object.keys(preview[0] || {}).map(header =>
                        h('div', { key: header, style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 8 } },
                            h('span', { style: { flex: 1, fontSize: 13, fontFamily: 'monospace', padding: '4px 8px', background: 'var(--background)', borderRadius: 4 } }, header),
                            h('span', null, '→'),
                            h('select', { className: 'form-select', style: { flex: 1 }, value: mapping[header] || '', onChange: e => setMapping({ ...mapping, [header]: e.target.value }) },
                                h('option', { value: '' }, '-- Ignorer --'),
                                expectedFields[importType].map(f => h('option', { key: f, value: f }, f))
                            )
                        )
                    )
                ),
                h('div', { style: { display: 'flex', gap: 12 } },
                    h('button', { className: 'btn btn-primary', onClick: handleImport, disabled: importing }, importing ? '⏳ Import...' : '✅ Importer'),
                    h('button', { className: 'btn btn-secondary', onClick: resetImport }, 'Annuler')
                ),
                importResults && h('div', { style: { marginTop: 16, display: 'flex', gap: 12 } },
                    h('span', { style: { padding: '8px 16px', background: 'var(--success-pastel)', color: 'var(--success)', borderRadius: 8 } }, '✅ ' + importResults.success),
                    h('span', { style: { padding: '8px 16px', background: 'var(--danger-pastel)', color: 'var(--danger)', borderRadius: 8 } }, '❌ ' + importResults.errors)
                )
            )
    );
};

// Alerts Page Inline pour Settings
const AlertsPageInline = ({ data, user, refresh, showToast }) => {
    const [alerts, setAlerts] = useState([
        { id: 1, name: 'Stock critique', type: 'stock', condition: 'quantity < min_stock', enabled: true, notify: ['app'] },
        { id: 2, name: 'Tâche urgente', type: 'task', condition: 'priority = urgent', enabled: true, notify: ['app'] },
        { id: 3, name: 'Commande en retard', type: 'order', condition: 'days > 7', enabled: false, notify: ['email'] },
        { id: 4, name: 'Nouvelle demande', type: 'request', condition: 'status = nouveau', enabled: true, notify: ['app'] }
    ]);

    const toggleAlert = (id) => {
        setAlerts(alerts.map(a => a.id === id ? { ...a, enabled: !a.enabled } : a));
        showToast('Alerte mise à jour', 'success');
    };

    const triggeredAlerts = [
        { alert: alerts[0], count: data.parts.filter(p => p.quantity <= (p.min_stock || 0)).length },
        { alert: alerts[1], count: data.tasks.filter(t => t.priority === 'urgent' && t.status !== 'termine').length },
        { alert: alerts[3], count: (data.requests || []).filter(r => r.status === 'nouveau').length }
    ].filter(a => a.count > 0 && a.alert.enabled);

    return h('div', null,
        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '🔔 Alertes & Notifications'),
        triggeredAlerts.length > 0 && h('div', { style: { padding: 16, background: 'var(--warning-pastel)', borderRadius: 12, marginBottom: 20 } },
            h('div', { style: { fontWeight: 600, color: 'var(--warning)', marginBottom: 12 } }, '⚠️ Alertes actives'),
            triggeredAlerts.map((ta, idx) =>
                h('div', { key: idx, style: { display: 'flex', justifyContent: 'space-between', padding: '8px 12px', background: 'var(--card)', borderRadius: 8, marginBottom: 8 } },
                    h('span', null, ta.alert.name),
                    h('span', { style: { fontWeight: 600, color: 'var(--warning)' } }, ta.count + ' éléments')
                )
            )
        ),
        h('div', { style: { fontWeight: 500, marginBottom: 12 } }, '📋 Règles configurées'),
        alerts.map(alert =>
            h('div', { key: alert.id, style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: 16, background: 'var(--background)', borderRadius: 12, marginBottom: 12, opacity: alert.enabled ? 1 : 0.6 } },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('span', { style: { fontSize: 20 } }, alert.type === 'stock' ? '📦' : alert.type === 'task' ? '🔧' : alert.type === 'order' ? '🛒' : '📬'),
                    h('div', null,
                        h('div', { style: { fontWeight: 600 } }, alert.name),
                        h('div', { style: { fontSize: 12, color: 'var(--muted)', fontFamily: 'monospace' } }, alert.condition)
                    )
                ),
                h('label', { style: { position: 'relative', display: 'inline-block', width: 48, height: 26, cursor: 'pointer' } },
                    h('input', { type: 'checkbox', checked: alert.enabled, onChange: () => toggleAlert(alert.id), style: { opacity: 0, width: 0, height: 0 } }),
                    h('span', { style: { position: 'absolute', cursor: 'pointer', inset: 0, background: alert.enabled ? 'var(--success)' : 'var(--border)', borderRadius: 26, transition: '0.3s' } },
                        h('span', { style: { position: 'absolute', height: 20, width: 20, left: alert.enabled ? 25 : 3, bottom: 3, background: 'white', borderRadius: '50%', transition: '0.3s' } })
                    )
                )
            )
        )
    );
};

// Progilift Sync Tab pour Settings - Version 3.0 avec 6 étapes et exécution individuelle
const ProgiliftSyncTab = ({ data, user, refresh, showToast }) => {
    const [apiUrl, setApiUrl] = useState(localStorage.getItem('progilift_api_url') || '');
    const [isRunning, setIsRunning] = useState(false);
    const [shouldStop, setShouldStop] = useState(false);
    const [progress, setProgress] = useState({ percent: 0, step: 'En attente...', stats: '0 / 0', visible: false });
    const [logs, setLogs] = useState([]);
    const [stepStatus, setStepStatus] = useState({ '0': 'pending', '1': 'pending', '2': 'pending', '2b': 'pending', '3': 'pending', '4': 'pending' });
    const shouldStopRef = useRef(false);
    const logsEndRef = useRef(null);
    
    // Générer les options pour les selects
    const sectorOptions = Array.from({ length: 22 }, (_, i) => i);
    const periodOptions = Array.from({ length: 7 }, (_, i) => i);
    
    useEffect(() => {
        const savedUrl = localStorage.getItem('progilift_api_url');
        if (savedUrl) setApiUrl(savedUrl);
        addLog('Dashboard Progilift Sync initialisé', 'info');
    }, []);
    
    useEffect(() => {
        if (logsEndRef.current) logsEndRef.current.scrollTop = logsEndRef.current.scrollHeight;
    }, [logs]);
    
    const addLog = (msg, type = 'info') => {
        const time = new Date().toLocaleTimeString('fr-FR');
        setLogs(prev => [{ time, msg, type }, ...prev.slice(0, 99)]);
    };
    
    const clearLogs = () => setLogs([]);
    
    const saveConfig = () => {
        localStorage.setItem('progilift_api_url', apiUrl);
        addLog('Configuration sauvegardée', 'success');
        showToast('Configuration sauvegardée', 'success');
    };
    
    const getApiUrl = (params = '') => {
        let baseUrl = apiUrl.trim().replace(/\/$/, '');
        if (!baseUrl.includes('/api/sync')) baseUrl = baseUrl + '/api/sync';
        return params ? `${baseUrl}?${params}` : baseUrl;
    };
    
    const testConnection = async () => {
        if (!apiUrl) { addLog('URL API non configurée', 'error'); return; }
        const url = getApiUrl();
        addLog(`Test de connexion vers ${url}...`, 'info');
        try {
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.status === 'ready') {
                addLog(`✅ Connexion OK - ${data.message}`, 'success');
                showToast('Connexion API réussie', 'success');
            } else {
                addLog(`⚠️ Réponse: ${JSON.stringify(data)}`, 'warning');
            }
        } catch (e) { addLog(`❌ Erreur: ${e.message}`, 'error'); }
    };
    
    const runStep = async (params) => {
        if (!apiUrl) { addLog('URL API non configurée', 'error'); return null; }
        const url = getApiUrl(params);
        addLog(`🔄 ${params}`, 'info');
        try {
            const resp = await fetch(url);
            const data = await resp.json();
            if (data.status === 'success') {
                const details = Object.entries(data).filter(([k]) => !['status', 'next', 'step'].includes(k)).map(([k, v]) => `${k}: ${v}`).join(', ');
                addLog(`✅ ${params} - ${details}`, 'success');
            } else if (data.status === 'done') { addLog(`✅ ${params} - Terminé`, 'success'); }
            else if (data.status === 'error') { addLog(`❌ ${params} - ${data.message}`, 'error'); }
            return data;
        } catch (e) { addLog(`❌ ${params} - ${e.message}`, 'error'); return null; }
    };
    
    const runSequence = async (baseStep, param, count) => {
        if (isRunning) { addLog('Une synchronisation est déjà en cours', 'warning'); return; }
        setIsRunning(true); shouldStopRef.current = false; setShouldStop(false);
        for (let i = 0; i < count && !shouldStopRef.current; i++) {
            setProgress({ percent: (i / count) * 100, step: `${baseStep} - ${param}=${i}`, stats: `${i} / ${count}`, visible: true });
            await runStep(`${baseStep}&${param}=${i}`);
            await new Promise(r => setTimeout(r, 500));
        }
        setProgress({ percent: 100, step: 'Terminé', stats: `${count} / ${count}`, visible: true });
        setIsRunning(false);
    };
    
    const startFullSync = async () => {
        if (isRunning) { addLog('Une synchronisation est déjà en cours', 'warning'); return; }
        if (!apiUrl) { addLog('URL API non configurée', 'error'); return; }
        setIsRunning(true); shouldStopRef.current = false; setShouldStop(false);
        setStepStatus({ '0': 'pending', '1': 'pending', '2': 'pending', '2b': 'pending', '3': 'pending', '4': 'pending' });
        setProgress({ percent: 0, step: 'Démarrage...', stats: '0 / 54', visible: true });
        const totalSteps = 54; let currentStep = 0;
        try {
            setStepStatus(s => ({ ...s, '0': 'current' }));
            setProgress({ percent: (currentStep / totalSteps) * 100, step: 'Step 0: Types Planning', stats: `${currentStep} / ${totalSteps}`, visible: true });
            await runStep('step=0'); setStepStatus(s => ({ ...s, '0': 'completed' })); currentStep++;
            if (shouldStopRef.current) throw new Error('Arrêté');
            
            setStepStatus(s => ({ ...s, '1': 'current' }));
            setProgress({ percent: (currentStep / totalSteps) * 100, step: 'Step 1: Arrêts', stats: `${currentStep} / ${totalSteps}`, visible: true });
            await runStep('step=1'); setStepStatus(s => ({ ...s, '1': 'completed' })); currentStep++;
            if (shouldStopRef.current) throw new Error('Arrêté');
            
            setStepStatus(s => ({ ...s, '2': 'current' }));
            for (let i = 0; i < 22 && !shouldStopRef.current; i++) {
                setProgress({ percent: (currentStep / totalSteps) * 100, step: `Step 2: Équipements - Secteur ${i}/21`, stats: `${currentStep} / ${totalSteps}`, visible: true });
                await runStep(`step=2&sector=${i}`); currentStep++; await new Promise(r => setTimeout(r, 300));
            }
            setStepStatus(s => ({ ...s, '2': 'completed' }));
            if (shouldStopRef.current) throw new Error('Arrêté');
            
            setStepStatus(s => ({ ...s, '2b': 'current' }));
            for (let i = 0; i < 22 && !shouldStopRef.current; i++) {
                setProgress({ percent: (currentStep / totalSteps) * 100, step: `Step 2b: Passages - Secteur ${i}/21`, stats: `${currentStep} / ${totalSteps}`, visible: true });
                await runStep(`step=2b&sector=${i}`); currentStep++; await new Promise(r => setTimeout(r, 300));
            }
            setStepStatus(s => ({ ...s, '2b': 'completed' }));
            if (shouldStopRef.current) throw new Error('Arrêté');
            
            setStepStatus(s => ({ ...s, '3': 'current' }));
            for (let i = 0; i < 7 && !shouldStopRef.current; i++) {
                setProgress({ percent: (currentStep / totalSteps) * 100, step: `Step 3: Pannes - Période ${i}/6`, stats: `${currentStep} / ${totalSteps}`, visible: true });
                await runStep(`step=3&period=${i}`); currentStep++; await new Promise(r => setTimeout(r, 300));
            }
            setStepStatus(s => ({ ...s, '3': 'completed' }));
            if (shouldStopRef.current) throw new Error('Arrêté');
            
            setStepStatus(s => ({ ...s, '4': 'current' }));
            setProgress({ percent: (currentStep / totalSteps) * 100, step: 'Step 4: Nb Visites', stats: `${currentStep} / ${totalSteps}`, visible: true });
            await runStep('step=4'); setStepStatus(s => ({ ...s, '4': 'completed' })); currentStep++;
            
            setProgress({ percent: 100, step: '🎉 Synchronisation terminée!', stats: `${totalSteps} / ${totalSteps}`, visible: true });
            addLog('🎉 SYNC COMPLÈTE TERMINÉE!', 'success');
            showToast('Synchronisation terminée!', 'success');
        } catch (e) { addLog(`⚠️ ${e.message}`, 'warning'); }
        setIsRunning(false);
    };
    
    const stopSync = () => { shouldStopRef.current = true; setShouldStop(true); addLog('⏹️ Arrêt demandé...', 'warning'); };
    
    // Styles adaptés au thème
    const cardStyle = { background: COLORS.card, borderRadius: 12, padding: 20, border: `1px solid ${COLORS.border}`, marginBottom: 16 };
    const statStyle = { background: COLORS.background, padding: '6px 12px', borderRadius: 6, fontSize: 12 };
    
    const getStepBadgeStyle = (status) => {
        const base = { padding: '6px 14px', borderRadius: 20, fontSize: 12, fontWeight: 500, display: 'inline-flex', alignItems: 'center', gap: 6 };
        if (status === 'completed') return { ...base, background: COLORS.successPastel, color: COLORS.success };
        if (status === 'current') return { ...base, background: COLORS.infoPastel, color: COLORS.info, animation: 'pulse 1s infinite' };
        return { ...base, background: COLORS.background, color: COLORS.muted };
    };
    
    const logBg = { info: COLORS.infoPastel, success: COLORS.successPastel, error: COLORS.dangerPastel, warning: COLORS.warningPastel };
    const logColor = { info: COLORS.info, success: COLORS.success, error: COLORS.danger, warning: COLORS.warning };
    
    return h('div', null,
        // Header
        h('div', { style: { marginBottom: 24 } },
            h('h2', { style: { fontSize: 20, fontWeight: 600, marginBottom: 4, color: COLORS.text } }, '🔄 Progilift Sync'),
            h('p', { style: { color: COLORS.muted, fontSize: 13 } }, 'Synchronisation des données Progilift vers Supabase')
        ),
        
        // Configuration
        h('div', { style: cardStyle },
            h('h3', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.text } }, '⚙️ Configuration API'),
            h('div', { style: { display: 'flex', gap: 10, flexWrap: 'wrap' } },
                h('input', { 
                    type: 'text', className: 'form-control', value: apiUrl, 
                    onChange: e => setApiUrl(e.target.value), 
                    placeholder: 'URL de base (ex: https://auv-asc-app.vercel.app)',
                    style: { flex: 1, minWidth: 280 }
                }),
                h('button', { className: 'btn btn-primary', onClick: saveConfig }, '💾 Sauvegarder'),
                h('button', { className: 'btn btn-ghost', onClick: testConnection }, '🔌 Tester')
            )
        ),
        
        // Full Sync Panel
        h('div', { style: { ...cardStyle, background: COLORS.primaryPastel, border: `1px solid ${COLORS.primary}30` } },
            h('h3', { style: { fontSize: 14, fontWeight: 600, marginBottom: 12, color: COLORS.primary } }, '🚀 Synchronisation Complète'),
            h('div', { style: { display: 'flex', gap: 8, flexWrap: 'wrap', marginBottom: 16 } },
                h('span', { style: getStepBadgeStyle(stepStatus['0']) }, '0. Types'),
                h('span', { style: getStepBadgeStyle(stepStatus['1']) }, '1. Arrêts'),
                h('span', { style: getStepBadgeStyle(stepStatus['2']) }, '2. Équipements'),
                h('span', { style: getStepBadgeStyle(stepStatus['2b']) }, '2b. Passages'),
                h('span', { style: getStepBadgeStyle(stepStatus['3']) }, '3. Pannes'),
                h('span', { style: getStepBadgeStyle(stepStatus['4']) }, '4. Nb Visites')
            ),
            h('div', { style: { display: 'flex', gap: 10 } },
                h('button', { className: `btn btn-primary ${isRunning ? 'btn-loading' : ''}`, onClick: startFullSync, disabled: isRunning }, '▶️ Lancer Sync Complète'),
                h('button', { className: 'btn btn-warning', onClick: stopSync, disabled: !isRunning }, '⏹️ Arrêter')
            )
        ),
        
        // Progress
        progress.visible && h('div', { style: cardStyle },
            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 } },
                h('span', { style: { width: 10, height: 10, borderRadius: '50%', background: COLORS.warning, animation: 'pulse 1s infinite' } }),
                h('span', { style: { fontWeight: 500 } }, 'Progression')
            ),
            h('div', { style: { background: COLORS.background, borderRadius: 10, height: 24, overflow: 'hidden', marginBottom: 8 } },
                h('div', { style: { height: '100%', width: `${progress.percent}%`, background: `linear-gradient(90deg, ${COLORS.info}, ${COLORS.success})`, borderRadius: 10, transition: 'width 0.3s', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: 11, fontWeight: 600, color: 'white' } }, `${Math.round(progress.percent)}%`)
            ),
            h('div', { style: { display: 'flex', justifyContent: 'space-between', fontSize: 12, color: COLORS.muted } },
                h('span', null, progress.step),
                h('span', null, progress.stats)
            )
        ),
        
        // Quick Actions
        h('div', { style: { display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' } },
            h('button', { className: 'btn btn-ghost btn-sm', onClick: () => runStep('mode=cron') }, '⚡ Sync Rapide'),
            h('button', { className: 'btn btn-ghost btn-sm', onClick: () => runStep('step=0') }, '📋 Types'),
            h('button', { className: 'btn btn-ghost btn-sm', onClick: () => runStep('step=1') }, '🛑 Arrêts'),
            h('button', { className: 'btn btn-ghost btn-sm', onClick: () => runStep('step=4') }, '🔢 Nb Visites')
        ),
        
        // Sync Cards Grid
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: 16, marginBottom: 20 } },
            // Step 2: Équipements
            h('div', { style: cardStyle },
                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 8, display: 'flex', alignItems: 'center', gap: 8 } }, '🏗️ Équipements'),
                h('p', { style: { color: COLORS.muted, fontSize: 12, marginBottom: 12 } }, 'Wsoucont - 22 secteurs'),
                h('div', { style: { display: 'flex', gap: 8, marginBottom: 12 } },
                    h('span', { style: statStyle }, 'Step: ', h('strong', { style: { color: COLORS.primary } }, '2')),
                    h('span', { style: statStyle }, 'Table: ', h('strong', { style: { color: COLORS.primary } }, 'equipements'))
                ),
                h('div', { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                    h('button', { className: 'btn btn-primary btn-sm', onClick: () => runSequence('step=2', 'sector', 22) }, '▶️ Sync All'),
                    h('select', { 
                        className: 'form-select', 
                        style: { width: 120 },
                        onChange: e => { if (e.target.value) runStep(`step=2&sector=${e.target.value}`); e.target.value = ''; }
                    },
                        h('option', { value: '' }, 'Secteur...'),
                        sectorOptions.map(i => h('option', { key: i, value: i }, `Secteur ${i}`))
                    )
                )
            ),
            
            // Step 2b: Passages
            h('div', { style: cardStyle },
                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 8, display: 'flex', alignItems: 'center', gap: 8 } }, '📅 Passages'),
                h('p', { style: { color: COLORS.muted, fontSize: 12, marginBottom: 12 } }, 'Wsoucont2 - Historique, DAT, TXT'),
                h('div', { style: { display: 'flex', gap: 8, marginBottom: 12 } },
                    h('span', { style: statStyle }, 'Step: ', h('strong', { style: { color: COLORS.primary } }, '2b')),
                    h('span', { style: statStyle }, 'Secteurs: ', h('strong', { style: { color: COLORS.primary } }, '22'))
                ),
                h('div', { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                    h('button', { className: 'btn btn-primary btn-sm', onClick: () => runSequence('step=2b', 'sector', 22) }, '▶️ Sync All'),
                    h('select', { 
                        className: 'form-select', 
                        style: { width: 120 },
                        onChange: e => { if (e.target.value) runStep(`step=2b&sector=${e.target.value}`); e.target.value = ''; }
                    },
                        h('option', { value: '' }, 'Secteur...'),
                        sectorOptions.map(i => h('option', { key: i, value: i }, `Secteur ${i}`))
                    )
                )
            ),
            
            // Step 3: Pannes
            h('div', { style: cardStyle },
                h('h4', { style: { fontSize: 14, fontWeight: 600, marginBottom: 8, display: 'flex', alignItems: 'center', gap: 8 } }, '🔧 Pannes'),
                h('p', { style: { color: COLORS.muted, fontSize: 12, marginBottom: 12 } }, 'Historique des pannes - 7 périodes'),
                h('div', { style: { display: 'flex', gap: 8, marginBottom: 12 } },
                    h('span', { style: statStyle }, 'Step: ', h('strong', { style: { color: COLORS.primary } }, '3')),
                    h('span', { style: statStyle }, 'Table: ', h('strong', { style: { color: COLORS.primary } }, 'pannes'))
                ),
                h('div', { style: { display: 'flex', gap: 8, alignItems: 'center' } },
                    h('button', { className: 'btn btn-primary btn-sm', onClick: () => runSequence('step=3', 'period', 7) }, '▶️ Sync All'),
                    h('select', { 
                        className: 'form-select', 
                        style: { width: 120 },
                        onChange: e => { if (e.target.value) runStep(`step=3&period=${e.target.value}`); e.target.value = ''; }
                    },
                        h('option', { value: '' }, 'Période...'),
                        periodOptions.map(i => h('option', { key: i, value: i }, `Période ${i}`))
                    )
                )
            )
        ),
        
        // Logs
        h('div', { style: { ...cardStyle, maxHeight: 350, display: 'flex', flexDirection: 'column' } },
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                h('h3', { style: { fontSize: 14, fontWeight: 600 } }, '📜 Journal'),
                h('button', { className: 'btn btn-ghost btn-sm', onClick: clearLogs }, '🗑️ Effacer')
            ),
            h('div', { style: { flex: 1, overflowY: 'auto' }, ref: logsEndRef },
                logs.length === 0 
                    ? h('div', { style: { color: COLORS.muted, fontSize: 13, textAlign: 'center', padding: 20 } }, 'Aucun log')
                    : logs.map((log, i) => h('div', { 
                        key: i, 
                        style: { padding: '8px 12px', marginBottom: 4, borderRadius: 6, fontSize: 12, fontFamily: 'monospace', display: 'flex', gap: 10, background: logBg[log.type], color: logColor[log.type] }
                    },
                        h('span', { style: { color: COLORS.muted, minWidth: 70 } }, log.time),
                        h('span', null, log.msg)
                    ))
            )
        ),
        
        h('style', null, `@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }`)
    );
};
// Audit Page Inline pour Settings
const AuditPageInline = ({ data, user, refresh, showToast }) => {
    const [auditLogs, setAuditLogs] = useState([]);

    useEffect(() => {
        const logs = [];
        data.parts.slice(0, 10).forEach(part => {
            logs.push({ id: 'p-' + part.id, type: 'stock', entity: 'Pièce: ' + part.name, time: part.updated_at || part.created_at, action: '✏️' });
        });
        data.tasks.slice(0, 10).forEach(task => {
            logs.push({ id: 't-' + task.id, type: 'task', entity: 'Tâche: ' + task.device_number, time: task.updated_at || task.created_at, action: task.status === 'termine' ? '✅' : '🔧' });
        });
        data.orders.slice(0, 5).forEach(order => {
            logs.push({ id: 'o-' + order.id, type: 'order', entity: 'Commande #' + order.id, time: order.created_at, action: '🛒' });
        });
        logs.sort((a, b) => new Date(b.time) - new Date(a.time));
        setAuditLogs(logs.slice(0, 20));
    }, [data]);

    return h('div', null,
        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '📜 Historique & Audit'),
        h('p', { style: { color: 'var(--muted)', marginBottom: 20 } }, 'Dernières modifications dans le système'),
        h('div', { style: { display: 'flex', gap: 16, marginBottom: 20 } },
            h('div', { style: { flex: 1, padding: 16, background: 'var(--background)', borderRadius: 12, textAlign: 'center' } },
                h('div', { style: { fontSize: 24, fontWeight: 700, color: 'var(--primary)' } }, auditLogs.length),
                h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Événements')
            ),
            h('div', { style: { flex: 1, padding: 16, background: 'var(--background)', borderRadius: 12, textAlign: 'center' } },
                h('div', { style: { fontSize: 24, fontWeight: 700, color: 'var(--info)' } }, auditLogs.filter(l => l.type === 'stock').length),
                h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Stock')
            ),
            h('div', { style: { flex: 1, padding: 16, background: 'var(--background)', borderRadius: 12, textAlign: 'center' } },
                h('div', { style: { fontSize: 24, fontWeight: 700, color: 'var(--warning)' } }, auditLogs.filter(l => l.type === 'task').length),
                h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Tâches')
            )
        ),
        h('div', { style: { maxHeight: 400, overflow: 'auto' } },
            auditLogs.map((log, idx) =>
                h('div', { key: log.id, style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, borderBottom: '1px solid var(--border)' } },
                    h('span', { style: { fontSize: 20 } }, log.action),
                    h('div', { style: { flex: 1 } },
                        h('div', { style: { fontWeight: 500 } }, log.entity),
                        h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, log.time ? new Date(log.time).toLocaleString('fr-FR') : '-')
                    ),
                    h('span', { style: { padding: '4px 10px', background: log.type === 'stock' ? 'var(--info-pastel)' : log.type === 'task' ? 'var(--warning-pastel)' : 'var(--purple-pastel)', color: log.type === 'stock' ? 'var(--info)' : log.type === 'task' ? 'var(--warning)' : 'var(--purple)', borderRadius: 20, fontSize: 11, fontWeight: 600 } }, log.type)
                )
            )
        )
    );
};

// API Docs Page Inline pour Settings
const ApiDocsPageInline = ({ data, user, refresh, showToast }) => {
    const [apiKey, setApiKey] = useState('sk_live_' + Math.random().toString(36).substr(2, 24));
    const [showKey, setShowKey] = useState(false);

    const copyKey = () => {
        navigator.clipboard.writeText(apiKey);
        showToast('Clé copiée', 'success');
    };

    const regenerateKey = () => {
        setApiKey('sk_live_' + Math.random().toString(36).substr(2, 24));
        showToast('Nouvelle clé générée', 'success');
    };

    const endpoints = [
        { method: 'GET', path: '/api/parts', desc: 'Liste des pièces' },
        { method: 'POST', path: '/api/parts', desc: 'Créer une pièce' },
        { method: 'GET', path: '/api/tasks', desc: 'Liste des tâches' },
        { method: 'PATCH', path: '/api/tasks/:id', desc: 'Modifier une tâche' },
        { method: 'GET', path: '/api/orders', desc: 'Liste des commandes' },
        { method: 'POST', path: '/api/stock/in', desc: 'Entrée de stock' },
        { method: 'POST', path: '/api/stock/out', desc: 'Sortie de stock' },
    ];

    return h('div', null,
        h('h3', { style: { marginBottom: 20, fontSize: 18, fontWeight: 600 } }, '🔌 API & Intégrations'),
        h('div', { style: { padding: 16, background: 'var(--background)', borderRadius: 12, marginBottom: 20 } },
            h('div', { style: { fontWeight: 600, marginBottom: 8 } }, '🔑 Clé API'),
            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 } },
                h('code', { style: { flex: 1, padding: '8px 12px', background: 'var(--card)', borderRadius: 8, fontFamily: 'monospace', fontSize: 13 } }, showKey ? apiKey : '••••••••••••••••••••'),
                h('button', { className: 'btn btn-ghost btn-sm', onClick: () => setShowKey(!showKey) }, showKey ? '👁️' : '👁️‍🗨️'),
                h('button', { className: 'btn btn-ghost btn-sm', onClick: copyKey }, '📋'),
                h('button', { className: 'btn btn-ghost btn-sm', onClick: regenerateKey }, '🔄')
            ),
            h('div', { style: { fontSize: 12, color: 'var(--warning)' } }, '⚠️ Ne partagez jamais votre clé API')
        ),
        h('div', { style: { fontWeight: 500, marginBottom: 12 } }, '📡 Endpoints disponibles'),
        endpoints.map((ep, idx) =>
            h('div', { key: idx, style: { display: 'flex', alignItems: 'center', gap: 12, padding: 12, background: 'var(--background)', borderRadius: 8, marginBottom: 8 } },
                h('span', { style: { padding: '4px 10px', borderRadius: 6, fontSize: 11, fontWeight: 700, background: ep.method === 'GET' ? '#10B98120' : ep.method === 'POST' ? '#3B82F620' : '#F59E0B20', color: ep.method === 'GET' ? '#10B981' : ep.method === 'POST' ? '#3B82F6' : '#F59E0B' } }, ep.method),
                h('code', { style: { flex: 1, fontFamily: 'monospace', fontSize: 13 } }, ep.path),
                h('span', { style: { fontSize: 13, color: 'var(--muted)' } }, ep.desc)
            )
        ),
        h('div', { style: { marginTop: 20, padding: 16, background: 'var(--info-pastel)', borderRadius: 12 } },
            h('div', { style: { fontWeight: 600, color: 'var(--info)', marginBottom: 8 } }, '⚡ Limites'),
            h('div', { style: { fontSize: 13, color: 'var(--text)' } }, '• 1000 requêtes/minute (lecture)'),
            h('div', { style: { fontSize: 13, color: 'var(--text)' } }, '• 100 requêtes/minute (écriture)')
        )
    );
};


// ==========================================
// MAIN APP
// ==========================================
// ==========================================
// REQUESTS PAGE
// ==========================================
const RequestsPage = ({ data, user, refresh, showToast }) => {
    const [search, setSearch] = useState('');
    const [typeFilter, setTypeFilter] = useState('');
    const [statusFilter, setStatusFilter] = useState('open');
    const [viewMode, setViewMode] = useState('grid'); // 'grid' ou 'list'
    const [columnFilters, setColumnFilters] = useState({});
    const [showAddModal, setShowAddModal] = useState(false);
    const [editRequest, setEditRequest] = useState(null);
    const [viewRequest, setViewRequest] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [comments, setComments] = useState([]);
    const [newComment, setNewComment] = useState('');
    
    // v5.8 - États sélection multiple
    const [selectedItems, setSelectedItems] = useState([]);
    const [contextMenu, setContextMenu] = useState({ show: false, x: 0, y: 0, item: null });
    
    // États pour autocomplétion Progilift
    const [progiliftAscenseurs, setProgiliftAscenseurs] = useState([]);
    const [deviceSearch, setDeviceSearch] = useState('');
    const [showDeviceDropdown, setShowDeviceDropdown] = useState(false);
    const [selectedDevice, setSelectedDevice] = useState(null);
    const [isManualDevice, setIsManualDevice] = useState(false);
    
    // Récupérer les secteurs de l'utilisateur (tous les rôles, y compris admin)
    const userSectors = useMemo(() => {
        try {
            const sectors = user?.sectors ? (typeof user.sectors === 'string' ? JSON.parse(user.sectors) : user.sectors) : [];
            return sectors.length > 0 ? sectors : null; // null = pas de restriction
        } catch (e) { return null; }
    }, [user]);
    
    // Charger les ascenseurs Progilift filtrés par secteurs (y compris hors contrat)
    useEffect(() => {
        const loadAscenseurs = async () => {
            let ascenseursData = [];
            let horsContratData = [];
            
            console.log('🔄 [Demandes] Chargement des ascenseurs...');
            
            // Charger depuis les tables progilift_*
            try {
                const ascenseurs = await fetchAllRows(db, 'progilift_ascenseurs', 'id, code, marque, type_appareil, en_arret, contrat_id', 'code');
                
                if (ascenseurs && ascenseurs.length > 0) {
                    console.log('✅ [Demandes] Tables progilift_*:', ascenseurs.length);
                    const contrats = await fetchAllRows(db, 'progilift_contrats', 'id, immeuble, adresse, ville, code_postal, secteur, client_id');
                    const clients = await fetchAllRows(db, 'progilift_clients', 'id, nom');
                    
                    ascenseursData = ascenseurs.map(a => {
                        const contrat = contrats?.find(c => c.id === a.contrat_id);
                        return {
                            ...a,
                            contrat: contrat ? {
                                ...contrat,
                                client: clients?.find(cl => cl.id === contrat.client_id)
                            } : null,
                            isHorsContrat: false
                        };
                    });
                    
                    // Charger les appareils hors contrat
                    try {
                        const horsContrat = await fetchAllRows(db, 'progilift_hors_contrat', 'id, code, marque, type_appareil, adresse, ville, code_postal, client_nom, secteur', 'code');
                        if (horsContrat && horsContrat.length > 0) {
                            console.log('✅ [Demandes] Hors contrat:', horsContrat.length);
                            horsContratData = horsContrat.map(hc => ({
                                id: 'hc_' + hc.id,
                                code: hc.code,
                                marque: hc.marque,
                                type_appareil: hc.type_appareil,
                                en_arret: false,
                                contrat: {
                                    immeuble: hc.client_nom || '',
                                    adresse: hc.adresse,
                                    ville: hc.ville,
                                    code_postal: hc.code_postal,
                                    secteur: hc.secteur,
                                    client: { nom: hc.client_nom }
                                },
                                isHorsContrat: true
                            }));
                        }
                    } catch (hcErr) {
                        console.log('⚠️ [Demandes] Table progilift_hors_contrat non accessible');
                    }
                }
            } catch (err) {
                console.log('🔄 [Demandes] Fallback sur les vues...');
                // Fallback: utiliser les vues
                try {
                    const ascenseurs = await fetchAllRows(db, 'v_progilift_ascenseurs', 'id, code, marque, type_appareil, en_arret, contrat_id', 'code');
                    
                    if (ascenseurs && ascenseurs.length > 0) {
                        console.log('✅ [Demandes] Vues:', ascenseurs.length);
                        const contrats = await fetchAllRows(db, 'v_progilift_contrats', 'id, immeuble, adresse, ville, code_postal, secteur, client_id');
                        const clients = await fetchAllRows(db, 'v_progilift_clients', 'id, nom');
                        
                        ascenseursData = ascenseurs.map(a => {
                            const contrat = contrats?.find(c => c.id === a.contrat_id);
                            return {
                                ...a,
                                contrat: contrat ? {
                                    ...contrat,
                                    client: clients?.find(cl => cl.id === contrat.client_id)
                                } : null,
                                isHorsContrat: false
                            };
                        });
                        
                        // Charger les appareils hors contrat via vue
                        try {
                            const horsContrat = await fetchAllRows(db, 'v_progilift_appareil_hors_contrat', 'id, code, marque, type_appareil, adresse, ville, code_postal, client_nom, secteur', 'code');
                            if (horsContrat && horsContrat.length > 0) {
                                console.log('✅ [Demandes] Hors contrat (vue):', horsContrat.length);
                                horsContratData = horsContrat.map(hc => ({
                                    id: 'hc_' + hc.id,
                                    code: hc.code,
                                    marque: hc.marque,
                                    type_appareil: hc.type_appareil,
                                    en_arret: false,
                                    contrat: {
                                        immeuble: hc.client_nom || '',
                                        adresse: hc.adresse,
                                        ville: hc.ville,
                                        code_postal: hc.code_postal,
                                        secteur: hc.secteur,
                                        client: { nom: hc.client_nom }
                                    },
                                    isHorsContrat: true
                                }));
                            }
                        } catch (hcErr) {
                            console.log('⚠️ [Demandes] Vue v_progilift_appareil_hors_contrat non accessible');
                        }
                    }
                } catch (viewErr) {
                    console.log('❌ [Demandes] Vues non accessibles');
                }
            }
            
            // Combiner ascenseurs et hors contrat
            let allAppareils = [...ascenseursData, ...horsContratData];
            
            // Filtrer par secteurs si l'utilisateur a des restrictions
            if (userSectors && userSectors.length > 0) {
                allAppareils = allAppareils.filter(a => 
                    a.contrat?.secteur && userSectors.includes(a.contrat.secteur)
                );
                console.log('🔒 [Demandes] Filtré:', allAppareils.length);
            }
            
            console.log('📊 [Demandes] Total:', allAppareils.length, '(dont', horsContratData.length, 'hors contrat)');
            setProgiliftAscenseurs(allAppareils);
        };
        loadAscenseurs();
    }, [userSectors]);
    
    // Réinitialiser le formulaire device quand on ouvre le modal
    useEffect(() => {
        if (showAddModal) {
            setDeviceSearch(editRequest?.device_number || '');
            setSelectedDevice(null);
            setIsManualDevice(!!editRequest?.device_number && !progiliftAscenseurs.some(a => a.code === editRequest?.device_number));
        }
    }, [showAddModal, editRequest, progiliftAscenseurs]);
    
    // Filtrer les ascenseurs selon la recherche
    const filteredDevices = useMemo(() => {
        if (!deviceSearch || deviceSearch.length < 1) return progiliftAscenseurs.slice(0, 15);
        const search = deviceSearch.toLowerCase();
        return progiliftAscenseurs.filter(a => 
            a.code?.toLowerCase().includes(search) ||
            a.contrat?.immeuble?.toLowerCase().includes(search) ||
            a.contrat?.ville?.toLowerCase().includes(search) ||
            a.contrat?.client?.nom?.toLowerCase().includes(search)
        ).slice(0, 15);
    }, [progiliftAscenseurs, deviceSearch]);
    
    // Sélectionner un appareil Progilift
    const selectDevice = (asc) => {
        setDeviceSearch(asc.code);
        setSelectedDevice(asc);
        setIsManualDevice(false);
        setShowDeviceDropdown(false);
    };
    
    // Basculer en mode manuel
    const switchToManual = () => {
        setIsManualDevice(true);
        setSelectedDevice(null);
        setShowDeviceDropdown(false);
    };
    
    // Colonnes redimensionnables
    const requestsColumns = useMemo(() => [
        { key: 'checkbox', label: '', width: 50 },
        { key: 'subject', label: 'Sujet', width: 200 },
        { key: 'type', label: 'Type', width: 120 },
        { key: 'priority', label: 'Priorité', width: 100 },
        { key: 'status', label: 'Statut', width: 120 },
        { key: 'requested_by', label: 'Demandeur', width: 140 },
        { key: 'created_at', label: 'Date', width: 110 },
        { key: 'actions', label: 'Actions', width: 120 }
    ], []);
    
    const { columns: resizableCols, getColumnProps, resetColumns } = useResizableColumns('requests-table', requestsColumns);
    
    const isAdmin = user?.role === 'admin';
    const canEdit = isAdmin || user?.role === 'technicien';
    
    const requests = data.requests || [];
    const openRequests = requests.filter(r => ['nouveau', 'en_cours', 'en_attente'].includes(r.status));
    const urgentRequests = requests.filter(r => r.priority === 'high' && ['nouveau', 'en_cours', 'en_attente'].includes(r.status));
    
    const filtered = useMemo(() => requests.filter(r => {
        const ms = !search || [r.subject, r.description, r.device_number].some(f => f?.toLowerCase().includes(search.toLowerCase()));
        const mt = !typeFilter || r.type === typeFilter;
        const mst = statusFilter === 'all' || (statusFilter === 'open' ? ['nouveau', 'en_cours', 'en_attente'].includes(r.status) : ['resolu', 'cloture'].includes(r.status));
        // Filtres de colonnes
        if (columnFilters.subject && !r.subject?.toLowerCase().includes(columnFilters.subject.toLowerCase())) return false;
        if (columnFilters.type && r.type !== columnFilters.type) return false;
        if (columnFilters.priority && r.priority !== columnFilters.priority) return false;
        if (columnFilters.status && r.status !== columnFilters.status) return false;
        if (columnFilters.requested_by_name && !r.requested_by_name?.toLowerCase().includes(columnFilters.requested_by_name.toLowerCase())) return false;
        if (columnFilters.assigned_to_name && !r.assigned_to_name?.toLowerCase().includes(columnFilters.assigned_to_name.toLowerCase())) return false;
        return ms && mt && mst;
    }), [requests, search, typeFilter, statusFilter, columnFilters]);
    
    useEffect(() => {
        if (viewRequest) {
            db.from('request_comments').select('*').eq('request_id', viewRequest.id).order('created_at', { ascending: true }).then(({ data }) => setComments(data || []));
        }
    }, [viewRequest]);
    
    // Temps réel pour les commentaires
    useEffect(() => {
        if (!viewRequest) return;
        
        const channelComments = db.channel('comments-realtime-' + viewRequest.id)
            .on('postgres_changes', { 
                event: '*', 
                schema: 'public', 
                table: 'request_comments',
                filter: `request_id=eq.${viewRequest.id}`
            }, (payload) => {
                console.log('🔄 RT comment:', payload.eventType);
                if (payload.eventType === 'INSERT') {
                    setComments(prev => [...prev, payload.new]);
                } else if (payload.eventType === 'DELETE') {
                    setComments(prev => prev.filter(c => c.id !== payload.old.id));
                } else if (payload.eventType === 'UPDATE') {
                    setComments(prev => prev.map(c => c.id === payload.new.id ? payload.new : c));
                }
            })
            .subscribe((status) => {
                console.log('📡 Comments Realtime:', status);
            });
        
        return () => { db.removeChannel(channelComments); };
    }, [viewRequest?.id]);
    
    const saveRequest = async (e) => {
        e.preventDefault();
        const form = e.target;
        const requestData = {
            type: form.type.value,
            subject: form.subject.value,
            description: form.description.value,
            priority: form.priority.value,
            device_number: form.device_number.value || null,
            status: editRequest?.status || 'nouveau',
            requested_by: user?.id,
            requested_by_name: ((user?.first_name || '') + ' ' + (user?.last_name || '')).trim() || user?.email
        };
        try {
            if (editRequest) { await db.from('requests').update(requestData).eq('id', editRequest.id); showToast('Demande mise à jour'); }
            else { await db.from('requests').insert(requestData); showToast('Demande créée'); }
            refresh(); setShowAddModal(false); setEditRequest(null);
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const updateRequestStatus = async (id, newStatus) => {
        try {
            await db.from('requests').update({ status: newStatus, resolved_at: ['resolu', 'cloture'].includes(newStatus) ? new Date().toISOString() : null }).eq('id', id);
            showToast('Statut mis à jour');
            refresh();
            if (viewRequest) setViewRequest({ ...viewRequest, status: newStatus });
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const assignRequest = async (id, assigneeId, assigneeName) => {
        try {
            await db.from('requests').update({ assigned_to: assigneeId, assigned_to_name: assigneeName }).eq('id', id);
            showToast('Assignation mise à jour');
            refresh();
            if (viewRequest) setViewRequest({ ...viewRequest, assigned_to: assigneeId, assigned_to_name: assigneeName });
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const deleteRequest = async (id) => {
        try {
            await db.from('request_comments').delete().eq('request_id', id);
            await db.from('requests').delete().eq('id', id);
            showToast('Demande supprimée');
            refresh(); setViewRequest(null); setDeleteConfirm(null);
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const postComment = async () => {
        if (!newComment.trim()) return;
        try {
            await db.from('request_comments').insert({ 
                request_id: viewRequest.id, 
                author_id: user?.id, 
                author_name: ((user?.first_name || '') + ' ' + (user?.last_name || '')).trim() || 'Utilisateur', 
                content: newComment.trim() 
            });
            setNewComment('');
            db.from('request_comments').select('*').eq('request_id', viewRequest.id).order('created_at', { ascending: true }).then(({ data }) => setComments(data || []));
            showToast('Commentaire ajouté');
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' }, 
                h('h1', { className: 'page-title' }, 'Demandes'), 
                h('p', { className: 'page-subtitle' }, `${openRequests.length} ouvertes`)
            ),
            h('div', { className: 'page-actions' },
                urgentRequests.length > 0 && h('span', { className: 'badge badge-danger', style: { padding: '8px 14px' } }, `${urgentRequests.length} urgente(s)`),
                h('button', { className: 'btn btn-primary', onClick: () => { setEditRequest(null); setShowAddModal(true); } }, h(Icon, { name: 'plus', size: 18 }), 'Nouvelle demande')
            )
        ),
        h('div', { className: 'card' },
            h('div', { className: 'card-header' },
                h('div', { className: 'header-search', style: { width: 300 } }, h(Icon, { name: 'search', size: 18, color: COLORS.muted }), h('input', { type: 'text', placeholder: 'Rechercher...', value: search, onChange: e => setSearch(e.target.value) })),
                h('div', { className: 'filters' },
                    h('button', { className: `filter-btn ${statusFilter === 'open' ? 'active' : ''}`, onClick: () => setStatusFilter('open') }, 'Ouvertes'),
                    h('button', { className: `filter-btn ${statusFilter === 'closed' ? 'active' : ''}`, onClick: () => setStatusFilter('closed') }, 'Clôturées'),
                    h('button', { className: `filter-btn ${statusFilter === 'all' ? 'active' : ''}`, onClick: () => setStatusFilter('all') }, 'Toutes')
                ),
                // Toggle vue grille/liste
                h('div', { style: { marginLeft: 'auto', display: 'flex', gap: 4, background: COLORS.background, borderRadius: 8, padding: 4 } },
                    h('button', { 
                        onClick: () => setViewMode('grid'),
                        style: { padding: '6px 10px', borderRadius: 6, border: 'none', cursor: 'pointer', background: viewMode === 'grid' ? 'white' : 'transparent', boxShadow: viewMode === 'grid' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none' }
                    }, h(Icon, { name: 'dashboard', size: 16, color: viewMode === 'grid' ? COLORS.primary : COLORS.muted })),
                    h('button', { 
                        onClick: () => setViewMode('list'),
                        style: { padding: '6px 10px', borderRadius: 6, border: 'none', cursor: 'pointer', background: viewMode === 'list' ? 'white' : 'transparent', boxShadow: viewMode === 'list' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none' }
                    }, h(Icon, { name: 'tasks', size: 16, color: viewMode === 'list' ? COLORS.primary : COLORS.muted }))
                ),
                // v5.8 - Compteur sélection
                selectedItems.length > 0 && h('span', { 
                    style: { background: COLORS.primary, color: 'white', padding: '4px 12px', borderRadius: 20, fontSize: 13, fontWeight: 600, marginLeft: 8 } 
                }, `${selectedItems.length} sélectionné(s)`)
            ),
            // v5.8 - Menu contextuel
            contextMenu.show && h(QuickActionsMenu, {
                isOpen: contextMenu.show,
                position: { x: contextMenu.x, y: contextMenu.y },
                type: 'request',
                item: contextMenu.item,
                onAction: (actionId, item) => {
                    if (actionId === 'view') setViewRequest(item);
                    else if (actionId === 'edit') { setEditRequest(item); setShowAddModal(true); }
                    else if (actionId === 'delete') setDeleteConfirm(item);
                    setContextMenu({ show: false, x: 0, y: 0, item: null });
                },
                onClose: () => setContextMenu({ show: false, x: 0, y: 0, item: null }),
                actions: [
                    { id: 'view', label: 'Voir détails', icon: '👁️' },
                    canEdit && { id: 'edit', label: 'Modifier', icon: '✏️' },
                    isAdmin && { id: 'delete', label: 'Supprimer', icon: '🗑️', danger: true }
                ].filter(Boolean)
            }),
            // v5.8 - Barre actions groupées
            selectedItems.length > 0 && h('div', { 
                className: 'animate-fade-in-up',
                style: { padding: '12px 16px', background: COLORS.primaryPastel, borderRadius: 8, margin: '0 16px 16px', display: 'flex', alignItems: 'center', gap: 12 } 
            },
                h('span', { style: { fontWeight: 600, color: COLORS.primary } }, `${selectedItems.length} demande(s) sélectionnée(s)`),
                h('div', { style: { marginLeft: 'auto', display: 'flex', gap: 8 } },
                    canEdit && h('button', { className: 'btn btn-sm btn-primary', onClick: async () => {
                        for (const id of selectedItems) { await db.from('requests').update({ status: 'resolu' }).eq('id', id); }
                        refresh(); setSelectedItems([]); ToastServiceV58.success(`${selectedItems.length} demande(s) résolue(s)`);
                    }}, '✓ Résoudre'),
                    h('button', { className: 'btn btn-sm btn-secondary', onClick: () => {
                        const sel = requests.filter(r => selectedItems.includes(r.id));
                        const csv = ['Sujet,Type,Priorité,Statut,Demandeur,Date'].concat(sel.map(r => `"${r.subject}","${r.type}","${r.priority}","${r.status}","${r.requested_by_name || ''}","${r.created_at}"`));
                        const blob = new Blob([csv.join('\n')], { type: 'text/csv' }); const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = 'demandes.csv'; a.click(); ToastServiceV58.success('Export CSV');
                    }}, '📥 Exporter'),
                    isAdmin && h('button', { className: 'btn btn-sm btn-danger', onClick: async () => {
                        if (!confirm(`Supprimer ${selectedItems.length} demande(s) ?`)) return;
                        for (const id of selectedItems) { await db.from('requests').delete().eq('id', id); }
                        refresh(); setSelectedItems([]); ToastServiceV58.success('Supprimé');
                    }}, '🗑️ Supprimer'),
                    h('button', { className: 'btn btn-sm btn-ghost', onClick: () => setSelectedItems([]) }, '✕')
                )
            ),
            h('div', { style: { padding: 16 } },
                filtered.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune demande') :
                viewMode === 'grid' ?
                // Vue Grille (tuiles) avec checkbox
                h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: 16 } },
                    filtered.map(req => {
                        const st = getRequestStatus(req.status);
                        const tp = getRequestType(req.type);
                        const isSelected = selectedItems.includes(req.id);
                        return h('div', { 
                            key: req.id, 
                            className: 'card', 
                            style: { cursor: 'pointer', borderLeft: `4px solid ${tp.color}`, border: isSelected ? `2px solid ${COLORS.primary}` : undefined, background: isSelected ? COLORS.primaryPastel : undefined }, 
                            onClick: (e) => { if (!e.target.closest('input')) setViewRequest(req); },
                            onContextMenu: (e) => { e.preventDefault(); setContextMenu({ show: true, x: e.clientX, y: e.clientY, item: req }); }
                        },
                            h('div', { className: 'card-body' },
                                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: 8 } },
                                    h('input', { 
                                        type: 'checkbox', checked: isSelected, 
                                        style: { width: 18, height: 18, marginRight: 8 },
                                        onClick: e => e.stopPropagation(),
                                        onChange: (e) => {
                                            if (e.target.checked) setSelectedItems([...selectedItems, req.id]);
                                            else setSelectedItems(selectedItems.filter(id => id !== req.id));
                                        }
                                    }),
                                    h('div', { style: { fontWeight: 600, fontSize: 15, flex: 1 } }, req.subject),
                                    h('span', { className: `badge badge-${st.color}` }, st.label)
                                ),
                                h('p', { style: { fontSize: 13, color: COLORS.muted, marginBottom: 12, display: '-webkit-box', WebkitLineClamp: 2, WebkitBoxOrient: 'vertical', overflow: 'hidden' } }, req.description),
                                h('div', { style: { display: 'flex', gap: 8, marginBottom: 12, flexWrap: 'wrap' } },
                                    h('span', { style: { padding: '3px 8px', borderRadius: 6, fontSize: 11, background: `${tp.color}20`, color: tp.color } }, tp.label),
                                    req.priority === 'high' && h('span', { className: 'badge badge-danger' }, '↑ Haute'),
                                    req.device_number && h('span', { className: 'badge badge-info' }, '#', req.device_number)
                                ),
                                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', fontSize: 12, color: COLORS.muted } },
                                    h('span', null, `Par ${req.requested_by_name || 'Inconnu'}`),
                                    h('span', null, formatRelative(req.created_at))
                                )
                            )
                        );
                    })
                ) :
                // Vue Liste (tableau) avec colonnes redimensionnables
                h('div', { className: 'table-container', style: { overflowX: 'auto' } },
                    h('table', { className: 'table', style: { tableLayout: 'fixed', width: '100%' } },
                        h('thead', null,
                            h('tr', null,
                                resizableCols.map(col => {
                                    const colProps = getColumnProps(col.key);
                                    // v5.8 - Checkbox header
                                    if (col.key === 'checkbox') {
                                        return h('th', { key: 'checkbox', style: { width: 50, textAlign: 'center' } },
                                            h('input', { 
                                                type: 'checkbox', 
                                                checked: filtered.length > 0 && selectedItems.length === filtered.length,
                                                onChange: (e) => {
                                                    if (e.target.checked) setSelectedItems(filtered.map(r => r.id));
                                                    else setSelectedItems([]);
                                                },
                                                style: { width: 18, height: 18 }
                                            })
                                        );
                                    }
                                    if (col.key === 'subject') {
                                        return h(FilterableTh, { key: col.key, label: 'Sujet', filterKey: 'subject', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                                    }
                                    if (col.key === 'type') {
                                        return h(FilterableTh, { key: col.key, label: 'Type', filterKey: 'type', filters: columnFilters, setFilters: setColumnFilters, type: 'select', options: [
                                            { value: 'intervention', label: 'Intervention' },
                                            { value: 'information', label: 'Information' },
                                            { value: 'piece', label: 'Pièce' },
                                            { value: 'autre', label: 'Autre' }
                                        ], ...colProps });
                                    }
                                    if (col.key === 'priority') {
                                        return h(FilterableTh, { key: col.key, label: 'Priorité', filterKey: 'priority', filters: columnFilters, setFilters: setColumnFilters, type: 'select', options: [
                                            { value: 'high', label: 'Haute' },
                                            { value: 'normal', label: 'Normale' }
                                        ], ...colProps });
                                    }
                                    if (col.key === 'status') {
                                        return h(FilterableTh, { key: col.key, label: 'Statut', filterKey: 'status', filters: columnFilters, setFilters: setColumnFilters, type: 'select', options: [
                                            { value: 'nouveau', label: 'Nouveau' },
                                            { value: 'en_cours', label: 'En cours' },
                                            { value: 'en_attente', label: 'En attente' },
                                            { value: 'resolu', label: 'Résolu' },
                                            { value: 'cloture', label: 'Clôturé' }
                                        ], ...colProps });
                                    }
                                    if (col.key === 'requested_by') {
                                        return h(FilterableTh, { key: col.key, label: 'Demandeur', filterKey: 'requested_by_name', filters: columnFilters, setFilters: setColumnFilters, ...colProps });
                                    }
                                    if (col.key === 'created_at') {
                                        return h(FilterableTh, { key: col.key, label: 'Date', filterKey: null, filters: null, setFilters: null, ...colProps });
                                    }
                                    if (col.key === 'actions') {
                                        return h(FilterableTh, { key: col.key, label: 'Actions', filterKey: null, filters: null, setFilters: null, ...colProps });
                                    }
                                    return null;
                                }).filter(Boolean)
                            )
                        ),
                        h('tbody', null,
                            filtered.map(req => {
                                const st = getRequestStatus(req.status);
                                const tp = getRequestType(req.type);
                                
                                const renderCell = (colKey) => {
                                    const col = resizableCols.find(c => c.key === colKey);
                                    const width = col?.width;
                                    const isSelected = selectedItems.includes(req.id);
                                    
                                    switch(colKey) {
                                        // v5.8 - Checkbox cell
                                        case 'checkbox':
                                            return h('td', { key: 'checkbox', style: { width: 50, textAlign: 'center' }, onClick: e => e.stopPropagation() },
                                                h('input', { 
                                                    type: 'checkbox', 
                                                    checked: isSelected,
                                                    onChange: (e) => {
                                                        if (e.target.checked) setSelectedItems([...selectedItems, req.id]);
                                                        else setSelectedItems(selectedItems.filter(id => id !== req.id));
                                                    },
                                                    style: { width: 18, height: 18 }
                                                })
                                            );
                                        case 'subject':
                                            return h('td', { key: colKey, style: { width } }, 
                                                h('div', null,
                                                    h('div', { style: { fontWeight: 600 } }, req.subject),
                                                    h('div', { style: { fontSize: 12, color: COLORS.muted, maxWidth: 200, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, req.description)
                                                )
                                            );
                                        case 'type':
                                            return h('td', { key: colKey, style: { width } }, h('span', { style: { padding: '3px 8px', borderRadius: 6, fontSize: 11, background: `${tp.color}20`, color: tp.color } }, tp.label));
                                        case 'priority':
                                            return h('td', { key: colKey, style: { width } }, req.priority === 'high' ? h('span', { className: 'badge badge-danger' }, '↑ Haute') : h('span', { style: { fontSize: 12, color: COLORS.muted } }, 'Normale'));
                                        case 'status':
                                            return h('td', { key: colKey, style: { width } }, h('span', { className: `badge badge-${st.color}` }, st.label));
                                        case 'requested_by':
                                            return h('td', { key: colKey, style: { width, fontSize: 13 } }, req.requested_by_name || '-');
                                        case 'created_at':
                                            return h('td', { key: colKey, style: { width, fontSize: 12, color: COLORS.muted } }, formatRelative(req.created_at));
                                        case 'actions':
                                            return h('td', { key: colKey, style: { width }, onClick: e => e.stopPropagation() }, 
                                                h('div', { className: 'table-actions' },
                                                    h('button', { className: 'btn btn-ghost btn-sm', onClick: () => setViewRequest(req) }, h(Icon, { name: 'eye', size: 16 })),
                                                    canEdit && h('button', { className: 'btn btn-ghost btn-sm', onClick: () => setEditRequest(req) }, h(Icon, { name: 'edit', size: 16 })),
                                                    isAdmin && h('button', { className: 'btn btn-ghost btn-sm', style: { color: COLORS.danger }, onClick: () => setDeleteConfirm(req) }, h(Icon, { name: 'trash', size: 16 }))
                                                )
                                            );
                                        default:
                                            return h('td', { key: colKey }, '-');
                                    }
                                };
                                
                                const isSelected = selectedItems.includes(req.id);
                                return h('tr', { 
                                    key: req.id, 
                                    style: { cursor: 'pointer', background: isSelected ? COLORS.primaryPastel : undefined },
                                    onClick: (e) => { if (!e.target.closest('input, button')) setViewRequest(req); },
                                    onContextMenu: (e) => { e.preventDefault(); setContextMenu({ show: true, x: e.clientX, y: e.clientY, item: req }); }
                                },
                                    resizableCols.map(col => renderCell(col.key))
                                );
                            })
                        )
                    )
                )
            )
        ),
        // View Request Modal
        viewRequest && h(Modal, { isOpen: true, onClose: () => { setViewRequest(null); setComments([]); }, title: viewRequest.subject, size: 'lg',
            footer: h(Fragment, null,
                canEdit && h('button', { className: 'btn btn-secondary', onClick: () => { setEditRequest(viewRequest); setShowAddModal(true); setViewRequest(null); } }, h(Icon, { name: 'edit', size: 16 }), 'Modifier'),
                isAdmin && h('button', { className: 'btn btn-danger', onClick: () => setDeleteConfirm(viewRequest) }, h(Icon, { name: 'trash', size: 16 }), 'Supprimer')
            )
        }, h('div', null,
            h('div', { style: { display: 'flex', gap: 8, marginBottom: 16, flexWrap: 'wrap' } },
                h('span', { className: `badge badge-${getRequestStatus(viewRequest.status).color}` }, getRequestStatus(viewRequest.status).label),
                h('span', { style: { padding: '4px 10px', borderRadius: 6, background: `${getRequestType(viewRequest.type).color}20`, color: getRequestType(viewRequest.type).color } }, getRequestType(viewRequest.type).label),
                viewRequest.priority === 'high' && h('span', { className: 'badge badge-danger' }, 'Haute priorité')
            ),
            h('div', { style: { marginBottom: 20 } },
                h('p', { style: { whiteSpace: 'pre-wrap' } }, viewRequest.description)
            ),
            h('div', { className: 'info-grid', style: { marginBottom: 20 } },
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Demandeur'), h('div', { className: 'info-value' }, viewRequest.requested_by_name || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Créé le'), h('div', { className: 'info-value' }, formatDateTime(viewRequest.created_at))),
                viewRequest.device_number && h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Appareil'), h('div', { className: 'info-value', style: { fontFamily: 'monospace' } }, viewRequest.device_number)),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Assigné à'), h('div', { className: 'info-value' }, viewRequest.assigned_to_name || 'Non assigné'))
            ),
            canEdit && h('div', { style: { marginBottom: 20, padding: 16, background: COLORS.background, borderRadius: 12 } },
                h('div', { style: { display: 'flex', gap: 16, flexWrap: 'wrap' } },
                    h('div', null,
                        h('div', { style: { fontSize: 12, fontWeight: 600, marginBottom: 8, color: COLORS.muted } }, 'STATUT'),
                        h('div', { style: { display: 'flex', gap: 6, flexWrap: 'wrap' } },
                            ['nouveau', 'en_cours', 'en_attente', 'resolu', 'cloture'].map(s => h('button', { key: s, className: `btn btn-sm ${viewRequest.status === s ? 'btn-primary' : 'btn-secondary'}`, onClick: () => updateRequestStatus(viewRequest.id, s) }, getRequestStatus(s).label))
                        )
                    ),
                    h('div', null,
                        h('div', { style: { fontSize: 12, fontWeight: 600, marginBottom: 8, color: COLORS.muted } }, 'ASSIGNER'),
                        h('select', { className: 'form-select', value: viewRequest.assigned_to || '', onChange: e => { const u = data.users.find(u => u.id === e.target.value); assignRequest(viewRequest.id, u?.id || null, u ? `${u.first_name} ${u.last_name}` : null); } },
                            h('option', { value: '' }, '-- Non assigné --'),
                            data.users.map(u => h('option', { key: u.id, value: u.id }, `${u.first_name || ''} ${u.last_name || ''}`))
                        )
                    )
                )
            ),
            h('div', { style: { borderTop: '1px solid ' + COLORS.border, paddingTop: 20 } },
                h('h4', { style: { marginBottom: 16 } }, `Commentaires (${comments.length})`),
                h('div', { style: { maxHeight: 300, overflowY: 'auto', marginBottom: 16 } },
                    comments.length === 0 ? h('p', { style: { color: COLORS.muted, textAlign: 'center', padding: 20 } }, 'Aucun commentaire') :
                    comments.map(c => h('div', { key: c.id, style: { padding: 12, background: c.is_status_change ? '#FEF3C7' : COLORS.background, borderRadius: 10, marginBottom: 8 } },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 6 } },
                            h('span', { style: { fontWeight: 600, fontSize: 13 } }, c.author_name),
                            h('span', { style: { fontSize: 11, color: COLORS.muted } }, formatRelative(c.created_at))
                        ),
                        h('p', { style: { fontSize: 14, fontStyle: c.is_status_change ? 'italic' : 'normal' } }, c.content)
                    ))
                ),
                h('div', { style: { display: 'flex', gap: 8 } },
                    h('input', { type: 'text', className: 'form-input', value: newComment, onChange: e => setNewComment(e.target.value), placeholder: 'Ajouter un commentaire...', style: { flex: 1 }, onKeyPress: e => e.key === 'Enter' && postComment() }),
                    h('button', { className: 'btn btn-primary', onClick: postComment, disabled: !newComment.trim() }, h(Icon, { name: 'send', size: 18 }))
                )
            )
        )),
        // Add/Edit Request Modal
        showAddModal && h(Modal, { isOpen: true, onClose: () => { setShowAddModal(false); setEditRequest(null); setDeviceSearch(''); setSelectedDevice(null); setIsManualDevice(false); }, title: editRequest ? 'Modifier la demande' : 'Nouvelle demande', size: 'md' },
            h('form', { onSubmit: saveRequest },
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Type *'), h('select', { name: 'type', className: 'form-select', defaultValue: editRequest?.type || 'aide', required: true }, h('option', { value: 'aide' }, '🔧 Aide technique'), h('option', { value: 'devis' }, '💰 Devis'), h('option', { value: 'documentation' }, '📄 Documentation'), h('option', { value: 'amelioration' }, '💡 Amélioration'))),
                    h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Priorité'), h('select', { name: 'priority', className: 'form-select', defaultValue: editRequest?.priority || 'medium' }, h('option', { value: 'low' }, 'Basse'), h('option', { value: 'medium' }, 'Normale'), h('option', { value: 'high' }, 'Haute')))
                ),
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Sujet *'), h('input', { name: 'subject', className: 'form-input', defaultValue: editRequest?.subject, required: true })),
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Description *'), h('textarea', { name: 'description', className: 'form-textarea', defaultValue: editRequest?.description, required: true, rows: 4 })),
                // N° Appareil avec autocomplétion ou saisie libre
                h('div', { className: 'form-group', style: { position: 'relative' } }, 
                    h('label', { className: 'form-label' }, 'N° Appareil (optionnel)', 
                        progiliftAscenseurs.length > 0 && h('span', { style: { fontSize: 10, color: COLORS.success, marginLeft: 8 } }, `✓ ${progiliftAscenseurs.length} appareils`)
                    ),
                    h('div', { style: { position: 'relative' } },
                        h('input', { 
                            name: 'device_number',
                            className: 'form-input', 
                            value: deviceSearch, 
                            onChange: e => { 
                                setDeviceSearch(e.target.value); 
                                setSelectedDevice(null); 
                                if (progiliftAscenseurs.length > 0) setShowDeviceDropdown(true); 
                            },
                            onFocus: () => { if (progiliftAscenseurs.length > 0) setShowDeviceDropdown(true); },
                            onBlur: () => setTimeout(() => setShowDeviceDropdown(false), 200),
                            placeholder: 'Ex: 12345',
                            style: { fontFamily: 'monospace' },
                            autoComplete: 'off'
                        }),
                        selectedDevice && h('span', { 
                            style: { position: 'absolute', right: 10, top: '50%', transform: 'translateY(-50)', fontSize: 11, color: COLORS.success } 
                        }, '✓ Lié')
                    ),
                    // Dropdown autocomplétion (seulement si données Progilift)
                    showDeviceDropdown && progiliftAscenseurs.length > 0 && h('div', { 
                        style: { 
                            position: 'absolute', top: '100%', left: 0, right: 0, 
                            background: 'white', border: `1px solid ${COLORS.border}`, borderRadius: 8,
                            boxShadow: '0 4px 12px rgba(0,0,0,0.15)', zIndex: 1000, maxHeight: 250, overflowY: 'auto'
                        } 
                    },
                        filteredDevices.length > 0 ? filteredDevices.map(asc => h('div', { 
                            key: asc.id,
                            onMouseDown: (e) => { e.preventDefault(); selectDevice(asc); },
                            style: { 
                                padding: '10px 12px', cursor: 'pointer', borderBottom: `1px solid ${COLORS.background}`,
                                background: asc.isHorsContrat ? '#FEF9C3' : (asc.en_arret ? '#FEF2F2' : 'white')
                            },
                            onMouseEnter: e => e.currentTarget.style.background = asc.isHorsContrat ? '#FEF08A' : (asc.en_arret ? '#FEE2E2' : COLORS.background),
                            onMouseLeave: e => e.currentTarget.style.background = asc.isHorsContrat ? '#FEF9C3' : (asc.en_arret ? '#FEF2F2' : 'white')
                        },
                            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                                h('span', { style: { fontFamily: 'monospace', fontWeight: 700, color: COLORS.primary } }, asc.code),
                                h('div', { style: { display: 'flex', gap: 4 } },
                                    asc.isHorsContrat && h('span', { style: { fontSize: 10, padding: '2px 6px', background: '#FEF3C7', color: '#D97706', borderRadius: 4 } }, 'HC'),
                                    asc.contrat?.secteur && h('span', { style: { fontSize: 10, padding: '2px 6px', background: COLORS.infoPastel, color: COLORS.info, borderRadius: 4 } }, asc.contrat.secteur),
                                    asc.en_arret && h('span', { style: { fontSize: 10, padding: '2px 6px', background: '#FEE2E2', color: '#DC2626', borderRadius: 4 } }, '🚨')
                                )
                            ),
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginTop: 2 } }, 
                                asc.contrat?.immeuble || '', asc.contrat?.ville ? ` • ${asc.contrat.ville}` : ''
                            )
                        )) :
                        h('div', { style: { padding: 12, color: COLORS.muted, fontSize: 13 } }, 
                            'Aucun résultat - saisie libre autorisée'
                        )
                    ),
                    // Info appareil sélectionné
                    selectedDevice && h('div', { 
                        style: { marginTop: 6, fontSize: 11, color: COLORS.success } 
                    }, `✓ ${selectedDevice.contrat?.immeuble || ''} ${selectedDevice.contrat?.ville ? `(${selectedDevice.contrat.ville})` : ''}`)
                ),
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 10, marginTop: 20 } }, 
                    h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => { setShowAddModal(false); setEditRequest(null); } }, 'Annuler'), 
                    h('button', { type: 'submit', className: 'btn btn-primary' }, 'Enregistrer')
                )
            )
        ),
        deleteConfirm && h(ConfirmDialog, { isOpen: true, onClose: () => setDeleteConfirm(null), onConfirm: () => deleteRequest(deleteConfirm.id), title: 'Supprimer la demande', message: 'Êtes-vous sûr de vouloir supprimer cette demande et tous ses commentaires ?', confirmText: 'Supprimer', type: 'danger' })
    );
};


// ==========================================
// GED PAGE
// ==========================================
const GedPage = ({ data, user, refresh, showToast }) => {
    const [search, setSearch] = useState('');
    const [selectedCategory, setSelectedCategory] = useState(null);
    const [documents, setDocuments] = useState([]);
    const [folders, setFolders] = useState([]);
    const [currentFolder, setCurrentFolder] = useState(null);
    const [showUploadModal, setShowUploadModal] = useState(false);
    const [viewDocument, setViewDocument] = useState(null);
    const [deleteConfirm, setDeleteConfirm] = useState(null);
    const [showAddFolderModal, setShowAddFolderModal] = useState(false);
    const [editFolder, setEditFolder] = useState(null);
    const [deleteFolderConfirm, setDeleteFolderConfirm] = useState(null);
    
    const isAdmin = user?.role === 'admin';
    const canEdit = isAdmin || user?.role === 'technicien';
    
    const categories = [
        { id: 'reglementaire', label: 'Réglementaire', icon: 'file', color: COLORS.danger },
        { id: 'technique', label: 'Technique', icon: 'settings', color: COLORS.primary },
        { id: 'controle', label: 'Contrôles', icon: 'checkCircle', color: COLORS.success },
        { id: 'maintenance', label: 'Maintenance', icon: 'clipboard', color: '#F97316' },
        { id: 'photo', label: 'Photos', icon: 'camera', color: '#8B5CF6' }
    ];
    
    useEffect(() => { loadDocuments(); loadFolders(); }, [selectedCategory, currentFolder]);
    
    // Temps réel pour les documents et dossiers
    useEffect(() => {
        const channelDocs = db.channel('ged-realtime')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'documents' }, (payload) => {
                console.log('🔄 RT GED documents:', payload.eventType);
                loadDocuments();
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'document_folders' }, (payload) => {
                console.log('🔄 RT GED folders:', payload.eventType);
                loadFolders();
            })
            .subscribe((status) => {
                console.log('📡 GED Realtime:', status);
            });
        
        return () => { db.removeChannel(channelDocs); };
    }, [selectedCategory, currentFolder]);
    
    const loadDocuments = async () => {
        try {
            let query = db.from('documents').select('*').order('created_at', { ascending: false });
            if (selectedCategory) query = query.eq('category', selectedCategory);
            if (currentFolder) query = query.eq('folder_id', currentFolder.id);
            const { data } = await query;
            setDocuments(data || []);
        } catch (e) { console.log('Documents table not found'); setDocuments([]); }
    };
    
    const loadFolders = async () => {
        try {
            let query = db.from('document_folders').select('*').order('name');
            if (currentFolder) query = query.eq('parent_folder_id', currentFolder.id);
            else query = query.is('parent_folder_id', null);
            const { data } = await query;
            setFolders(data || []);
        } catch (e) { console.log('Document folders table not found'); setFolders([]); }
    };
    
    const uploadDocument = async (e) => {
        e.preventDefault();
        const form = e.target;
        const file = form.file.files[0];
        if (!file) { showToast('Sélectionnez un fichier', 'error'); return; }
        
        const docData = {
            name: form.name.value || file.name,
            description: form.description.value,
            category: form.category.value,
            file_url: URL.createObjectURL(file),
            file_type: file.type,
            file_size: file.size,
            folder_id: currentFolder?.id || null,
            created_by: user?.id
        };
        
        try {
            await db.from('documents').insert(docData);
            showToast('Document ajouté');
            setShowUploadModal(false);
            loadDocuments();
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const deleteDocument = async (id) => {
        try {
            await db.from('documents').delete().eq('id', id);
            showToast('Document supprimé');
            loadDocuments();
            setViewDocument(null);
            setDeleteConfirm(null);
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const createFolder = async (e) => {
        e.preventDefault();
        const form = e.target;
        try {
            await db.from('document_folders').insert({
                name: form.name.value,
                parent_folder_id: currentFolder?.id || null,
                color: form.color.value,
                created_by: user?.id
            });
            showToast('Dossier créé');
            setShowAddFolderModal(false);
            loadFolders();
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const updateFolder = async (e) => {
        e.preventDefault();
        const form = e.target;
        try {
            await db.from('document_folders').update({
                name: form.name.value,
                color: form.color.value
            }).eq('id', editFolder.id);
            showToast('Dossier modifié');
            setEditFolder(null);
            loadFolders();
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const deleteFolder = async (folder) => {
        try {
            // Supprimer les documents du dossier
            await db.from('documents').delete().eq('folder_id', folder.id);
            // Supprimer les sous-dossiers
            await db.from('document_folders').delete().eq('parent_folder_id', folder.id);
            // Supprimer le dossier
            await db.from('document_folders').delete().eq('id', folder.id);
            showToast('Dossier supprimé');
            setDeleteFolderConfirm(null);
            loadFolders();
            loadDocuments();
        } catch (err) { showToast('Erreur: ' + err.message, 'error'); }
    };
    
    const formatFileSize = (bytes) => {
        if (!bytes) return '-';
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${Math.round(bytes / 1024)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
    };
    
    const getFileIcon = (type) => {
        if (type?.includes('pdf')) return '📄';
        if (type?.includes('image')) return '🖼️';
        if (type?.includes('word') || type?.includes('document')) return '📝';
        if (type?.includes('excel') || type?.includes('sheet')) return '📊';
        return '📁';
    };
    
    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' }, 
                h('h1', { className: 'page-title' }, 'GED'), 
                h('p', { className: 'page-subtitle' }, 'Gestion Électronique des Documents')
            ),
            h('div', { className: 'page-actions' },
                canEdit && h('button', { className: 'btn btn-secondary', onClick: () => setShowAddFolderModal(true) }, h(Icon, { name: 'folder', size: 16 }), 'Nouveau dossier'),
                canEdit && h('button', { className: 'btn btn-primary', onClick: () => setShowUploadModal(true) }, h(Icon, { name: 'upload', size: 18 }), 'Ajouter')
            )
        ),
        h('div', { style: { display: 'flex', gap: 24 } },
            // Sidebar categories
            h('div', { style: { width: 220, flexShrink: 0 } },
                h('div', { className: 'card', style: { padding: 12 } },
                    h('div', { style: { fontSize: 12, fontWeight: 600, color: COLORS.muted, marginBottom: 12, padding: '0 8px' } }, 'CATÉGORIES'),
                    h('div', { style: { marginBottom: 16 } },
                        h('div', { style: { padding: '10px 12px', borderRadius: 8, cursor: 'pointer', background: !selectedCategory ? COLORS.primary : 'transparent', color: !selectedCategory ? 'white' : COLORS.text }, onClick: () => setSelectedCategory(null) }, 'Tous les documents'),
                        categories.map(cat => h('div', { key: cat.id, style: { padding: '10px 12px', borderRadius: 8, cursor: 'pointer', display: 'flex', alignItems: 'center', gap: 10, background: selectedCategory === cat.id ? `${cat.color}20` : 'transparent', color: selectedCategory === cat.id ? cat.color : COLORS.text }, onClick: () => setSelectedCategory(cat.id) },
                            h(Icon, { name: cat.icon, size: 16 }),
                            cat.label
                        ))
                    )
                )
            ),
            // Main content
            h('div', { style: { flex: 1 } },
                currentFolder && h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 16 } },
                    h('button', { className: 'btn btn-ghost btn-sm', onClick: () => setCurrentFolder(null) }, h(Icon, { name: 'chevronLeft', size: 16 }), 'Retour'),
                    h('span', { style: { fontWeight: 600 } }, currentFolder.name)
                ),
                // Folders
                folders.length > 0 && h('div', { style: { marginBottom: 24 } },
                    h('h4', { style: { marginBottom: 12, color: COLORS.muted } }, 'Dossiers'),
                    h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(180px, 1fr))', gap: 12 } },
                        folders.map(folder => h('div', { key: folder.id, className: 'card', style: { padding: 16, textAlign: 'center', cursor: 'pointer', position: 'relative' } },
                            canEdit && h('div', { style: { position: 'absolute', top: 8, right: 8, display: 'flex', gap: 4 }, onClick: e => e.stopPropagation() },
                                h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setEditFolder(folder), title: 'Modifier' }, h(Icon, { name: 'edit', size: 14 })),
                                h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setDeleteFolderConfirm(folder), title: 'Supprimer', style: { color: COLORS.danger } }, h(Icon, { name: 'trash', size: 14 }))
                            ),
                            h('div', { onClick: () => setCurrentFolder(folder) },
                                h(Icon, { name: 'folder', size: 40, color: folder.color || '#F59E0B' }),
                                h('div', { style: { marginTop: 8, fontWeight: 500 } }, folder.name)
                            )
                        ))
                    )
                ),
                // Documents
                h('div', { className: 'card' },
                    h('div', { className: 'card-header' },
                        h('div', { className: 'header-search', style: { width: 300 } }, h(Icon, { name: 'search', size: 18, color: COLORS.muted }), h('input', { type: 'text', placeholder: 'Rechercher...', value: search, onChange: e => setSearch(e.target.value) })),
                        h('span', { style: { color: COLORS.muted } }, documents.length, ' documents')
                    ),
                    documents.length === 0 ? h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucun document') :
                    h('div', { className: 'table-container' },
                        h('table', null,
                            h('thead', null, h('tr', null, h('th', null, 'Nom'), h('th', null, 'Catégorie'), h('th', null, 'Taille'), h('th', null, 'Date'), h('th', { style: { textAlign: 'right' } }, 'Actions'))),
                            h('tbody', null, documents.filter(d => !search || d.name.toLowerCase().includes(search.toLowerCase())).map(doc => h('tr', { key: doc.id },
                                h('td', null, h('div', { style: { display: 'flex', alignItems: 'center', gap: 10 } }, h('span', { style: { fontSize: 20 } }, getFileIcon(doc.file_type)), h('div', null, h('div', { style: { fontWeight: 500 } }, doc.name), doc.description && h('div', { style: { fontSize: 12, color: COLORS.muted } }, doc.description)))),
                                h('td', null, h('span', { className: 'badge badge-secondary' }, categories.find(c => c.id === doc.category)?.label || doc.category)),
                                h('td', { style: { color: COLORS.muted } }, formatFileSize(doc.file_size)),
                                h('td', { style: { color: COLORS.muted } }, formatRelative(doc.created_at)),
                                h('td', null, h('div', { className: 'table-actions' },
                                    doc.file_url && h('a', { href: doc.file_url, target: '_blank', className: 'btn btn-ghost btn-icon btn-sm', title: 'Télécharger' }, h(Icon, { name: 'download', size: 16 })),
                                    h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setViewDocument(doc), title: 'Voir' }, h(Icon, { name: 'eye', size: 16 })),
                                    canEdit && h('button', { className: 'btn btn-ghost btn-icon btn-sm', onClick: () => setDeleteConfirm(doc), title: 'Supprimer', style: { color: COLORS.danger } }, h(Icon, { name: 'trash', size: 16 }))
                                ))
                            )))
                        )
                    )
                )
            )
        ),
        // Upload Modal
        showUploadModal && h(Modal, { isOpen: true, onClose: () => setShowUploadModal(false), title: 'Ajouter un document' },
            h('form', { onSubmit: uploadDocument },
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Fichier *'),
                    h('input', { name: 'file', type: 'file', className: 'form-input', required: true })
                ),
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Nom'), h('input', { name: 'name', className: 'form-input', placeholder: 'Nom du document (optionnel)' })),
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Description'), h('textarea', { name: 'description', className: 'form-textarea', rows: 2 })),
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Catégorie'), h('select', { name: 'category', className: 'form-select', defaultValue: selectedCategory || 'technique' }, categories.map(c => h('option', { key: c.id, value: c.id }, c.label)))),
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 10 } }, 
                    h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => setShowUploadModal(false) }, 'Annuler'), 
                    h('button', { type: 'submit', className: 'btn btn-primary' }, 'Ajouter')
                )
            )
        ),
        // Add Folder Modal
        showAddFolderModal && h(Modal, { isOpen: true, onClose: () => setShowAddFolderModal(false), title: 'Nouveau dossier', size: 'sm' },
            h('form', { onSubmit: createFolder },
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Nom *'), h('input', { name: 'name', className: 'form-input', required: true })),
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Couleur'), h('input', { name: 'color', type: 'color', className: 'form-input', defaultValue: '#F59E0B' })),
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 10 } }, 
                    h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => setShowAddFolderModal(false) }, 'Annuler'), 
                    h('button', { type: 'submit', className: 'btn btn-primary' }, 'Créer')
                )
            )
        ),
        // Edit Folder Modal
        editFolder && h(Modal, { isOpen: true, onClose: () => setEditFolder(null), title: 'Modifier le dossier', size: 'sm' },
            h('form', { onSubmit: updateFolder },
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Nom *'), h('input', { name: 'name', className: 'form-input', defaultValue: editFolder.name, required: true })),
                h('div', { className: 'form-group' }, h('label', { className: 'form-label' }, 'Couleur'), h('input', { name: 'color', type: 'color', className: 'form-input', defaultValue: editFolder.color || '#F59E0B' })),
                h('div', { style: { display: 'flex', justifyContent: 'flex-end', gap: 10 } }, 
                    h('button', { type: 'button', className: 'btn btn-secondary', onClick: () => setEditFolder(null) }, 'Annuler'), 
                    h('button', { type: 'submit', className: 'btn btn-primary' }, 'Enregistrer')
                )
            )
        ),
        // Delete Folder Confirm
        deleteFolderConfirm && h(ConfirmDialog, { isOpen: true, onClose: () => setDeleteFolderConfirm(null), onConfirm: () => deleteFolder(deleteFolderConfirm), title: 'Supprimer le dossier', message: `Êtes-vous sûr de vouloir supprimer le dossier "${deleteFolderConfirm.name}" ? Tous les documents et sous-dossiers seront également supprimés.`, confirmText: 'Supprimer', type: 'danger' }),
        // View Document Modal
        viewDocument && h(Modal, { isOpen: true, onClose: () => setViewDocument(null), title: viewDocument.name,
            footer: h(Fragment, null,
                viewDocument.file_url && h('a', { href: viewDocument.file_url, target: '_blank', className: 'btn btn-primary' }, h(Icon, { name: 'download', size: 16 }), 'Télécharger'),
                canEdit && h('button', { className: 'btn btn-danger', onClick: () => setDeleteConfirm(viewDocument) }, h(Icon, { name: 'trash', size: 16 }), 'Supprimer')
            )
        }, h('div', null,
            viewDocument.file_type?.includes('image') && h('div', { style: { textAlign: 'center', marginBottom: 16 } }, h('img', { src: viewDocument.file_url, alt: viewDocument.name, style: { maxWidth: '100%', maxHeight: 400, borderRadius: 12 } })),
            h('div', { className: 'info-grid' },
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Type'), h('div', { className: 'info-value' }, viewDocument.file_type || '-')),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Taille'), h('div', { className: 'info-value' }, formatFileSize(viewDocument.file_size))),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Catégorie'), h('div', { className: 'info-value' }, categories.find(c => c.id === viewDocument.category)?.label || viewDocument.category)),
                h('div', { className: 'info-item' }, h('div', { className: 'info-label' }, 'Ajouté le'), h('div', { className: 'info-value' }, formatDateTime(viewDocument.created_at)))
            ),
            viewDocument.description && h('div', { style: { marginTop: 16 } }, h('div', { className: 'info-label' }, 'Description'), h('p', { style: { marginTop: 4 } }, viewDocument.description))
        )),
        deleteConfirm && h(ConfirmDialog, { isOpen: true, onClose: () => setDeleteConfirm(null), onConfirm: () => deleteDocument(deleteConfirm.id), title: 'Supprimer le document', message: `Êtes-vous sûr de vouloir supprimer "${deleteConfirm.name}" ?`, confirmText: 'Supprimer', type: 'danger' })
    );
};


// ==========================================

// ==========================================
// TIMESHEET PAGE - Feuilles d'heures
// Base: Lun-Jeu = 8h, Ven = 7h (39h/semaine)
// Récup = heures samedi astreinte uniquement
// ==========================================
const TimesheetPage = ({ data, user, refresh, showToast }) => {
    // États
    const [selectedWeek, setSelectedWeek] = useState(() => {
        const now = new Date();
        return { week: getWeekNumber(now), year: now.getFullYear() };
    });
    const [timesheet, setTimesheet] = useState(null);
    const [days, setDays] = useState([]);
    const [oncalls, setOncalls] = useState({ semaine: false, weekend: false, ferie: false, soutien: false });
    const [interventions, setInterventions] = useState([]);
    const [loading, setLoading] = useState(false);
    const [viewMode, setViewMode] = useState('edit'); // edit, history, admin
    const [allTimesheets, setAllTimesheets] = useState([]);
    const [showValidateConfirm, setShowValidateConfirm] = useState(false);
    const [leaveBalances, setLeaveBalances] = useState({ 
        conges_initial: 0, conges_report: 0, conges_acquis: 0, conges_pris: 0, conges_solde: 0,
        recup_initial: 0, recup_report: 0, recup_acquis: 0, recup_pris: 0, recup_ajustements: 0, recup_solde: 0,
        initial_locked: false, initial_locked_at: null, initial_locked_by: null
    });
    const [adjustments, setAdjustments] = useState([]);
    const [showAdjustmentModal, setShowAdjustmentModal] = useState(false);
    const [showLockConfirm, setShowLockConfirm] = useState(false);
    const [selectedUser, setSelectedUser] = useState(null);
    const [allUsers, setAllUsers] = useState([]);

    const isAdmin = user?.role === 'admin';
    const userPerms = getUserPermissions(user);
    const canViewAllTimesheets = userPerms.timesheets_view_all === true;
    const canEdit = timesheet?.status !== 'valide' || isAdmin;
    const canEditInitial = !leaveBalances.initial_locked || isAdmin; // Peut modifier les compteurs initiaux
    
    // Heures de base par jour
    const BASE_HOURS = { 0: 8, 1: 8, 2: 8, 3: 8, 4: 7 }; // Lun-Jeu: 8h, Ven: 7h
    const BASE_WEEK_HOURS = 39;

    // Fonction pour obtenir le nombre de semaines ISO dans une année
    function getWeeksInYear(year) {
        const dec31 = new Date(year, 11, 31);
        const weekNum = getWeekNumber(dec31);
        // Si le 31 décembre est dans la semaine 1 de l'année suivante, prendre le 24 décembre
        return weekNum === 1 ? getWeekNumber(new Date(year, 11, 24)) : weekNum;
    }

    // Fonction pour obtenir le numéro de semaine ISO
    function getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }
    
    // Navigation semaines avec gestion du changement d'année
    const goToPreviousWeek = () => {
        setSelectedWeek(p => {
            if (p.week <= 1) {
                const prevYear = p.year - 1;
                const weeksInPrevYear = getWeeksInYear(prevYear);
                return { week: weeksInPrevYear, year: prevYear };
            }
            return { ...p, week: p.week - 1 };
        });
    };
    
    const goToNextWeek = () => {
        setSelectedWeek(p => {
            const weeksInYear = getWeeksInYear(p.year);
            if (p.week >= weeksInYear) {
                return { week: 1, year: p.year + 1 };
            }
            return { ...p, week: p.week + 1 };
        });
    };

    // Obtenir les dates d'une semaine
    const getWeekDates = (weekNum, year) => {
        const simple = new Date(year, 0, 1 + (weekNum - 1) * 7);
        const dow = simple.getDay();
        const startDate = new Date(simple);
        if (dow <= 4) startDate.setDate(simple.getDate() - simple.getDay() + 1);
        else startDate.setDate(simple.getDate() + 8 - simple.getDay());
        const dates = [];
        for (let i = 0; i < 7; i++) {
            const d = new Date(startDate);
            d.setDate(startDate.getDate() + i);
            dates.push(d);
        }
        return dates;
    };

    const weekDates = useMemo(() => getWeekDates(selectedWeek.week, selectedWeek.year), [selectedWeek]);
    const dayNames = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];

    // Année de congés : du 1er juin N-1 au 31 mai N
    // Ex: janvier 2025 -> année congés 2025 (période 1 juin 2024 - 31 mai 2025)
    // Ex: juillet 2024 -> année congés 2025 (période 1 juin 2024 - 31 mai 2025)
    const getLeaveYear = (date) => {
        const month = date.getMonth(); // 0-11
        const year = date.getFullYear();
        // Si mois >= 5 (juin-décembre), année congés = année + 1
        // Si mois < 5 (janvier-mai), année congés = année courante
        return month >= 5 ? year + 1 : year;
    };
    
    // Année de congés pour la semaine sélectionnée
    const leaveYear = useMemo(() => getLeaveYear(weekDates[0]), [weekDates]);

    // Charger les utilisateurs (admin)
    useEffect(() => {
        if (isAdmin) {
            setAllUsers(data.users || []);
        }
    }, [data.users, isAdmin]);

    // Temps réel pour les feuilles d'heures
    useEffect(() => {
        const channel = db.channel('timesheets-realtime-' + user.id)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'timesheets' }, (payload) => {
                console.log('🔄 Realtime timesheet change:', payload.eventType);
                loadTimesheet();
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'timesheet_days' }, (payload) => {
                console.log('🔄 Realtime timesheet_days change:', payload.eventType);
                // Recharger seulement si c'est pour notre feuille
                if (timesheet && payload.new?.timesheet_id === timesheet.id) {
                    loadTimesheet();
                }
            })
            .subscribe();
        
        return () => { db.removeChannel(channel); };
    }, [user.id, timesheet?.id]);

    // Initialiser/charger la feuille d'heures
    useEffect(() => {
        loadTimesheet();
    }, [selectedWeek, selectedUser]);

    const loadTimesheet = async () => {
        setLoading(true);
        // Si pas de permission pour voir toutes les feuilles, forcer l'utilisateur courant
        const targetUserId = canViewAllTimesheets ? (selectedUser?.id || user.id) : user.id;
        
        try {
            // Charger la feuille existante
            const { data: existing } = await db.from('timesheets')
                .select('*')
                .eq('user_id', targetUserId)
                .eq('week_number', selectedWeek.week)
                .eq('year', selectedWeek.year)
                .single();

            if (existing) {
                setTimesheet(existing);
                setOncalls({
                    semaine: existing.oncall_semaine || false,
                    weekend: existing.oncall_weekend || false,
                    ferie: existing.oncall_ferie || false,
                    soutien: existing.oncall_soutien || false
                });
                
                // Charger les jours
                const { data: daysData } = await db.from('timesheet_days')
                    .select('*')
                    .eq('timesheet_id', existing.id)
                    .order('day_index');
                
                if (daysData && daysData.length > 0) {
                    setDays(daysData.map(d => {
                        // Parser les tâches (colonnes séparées ou ancien format)
                        let morningTasks = [{ site: '', start_time: '', end_time: '' }];
                        let afternoonTasks = [{ site: '', start_time: '', end_time: '' }];
                        
                        // Nouveau format : colonnes séparées
                        if (d.morning_tasks && Array.isArray(d.morning_tasks) && d.morning_tasks.length > 0) {
                            morningTasks = d.morning_tasks;
                        }
                        if (d.afternoon_tasks && Array.isArray(d.afternoon_tasks) && d.afternoon_tasks.length > 0) {
                            afternoonTasks = d.afternoon_tasks;
                        }
                        
                        // Ancien format (colonne tasks unique) - compatibilité
                        if (d.tasks) {
                            if (d.tasks.morning && d.tasks.afternoon) {
                                morningTasks = d.tasks.morning.length > 0 ? d.tasks.morning : morningTasks;
                                afternoonTasks = d.tasks.afternoon.length > 0 ? d.tasks.afternoon : afternoonTasks;
                            } else if (Array.isArray(d.tasks)) {
                                morningTasks = d.tasks.length > 0 ? d.tasks : morningTasks;
                            }
                        }
                        
                        return {
                            ...d,
                            date: new Date(d.day_date),
                            morning_tasks: morningTasks,
                            afternoon_tasks: afternoonTasks
                        };
                    }));
                } else {
                    initializeDays();
                }

                // Charger les interventions
                const { data: interData } = await db.from('timesheet_interventions')
                    .select('*')
                    .eq('timesheet_id', existing.id);
                setInterventions(interData || []);
            } else {
                setTimesheet(null);
                initializeDays();
                setInterventions([]);
            }

            // Charger toutes les feuilles pour l'historique
            let tsQuery = db.from('timesheets').select('*');
            if (!isAdmin) {
                tsQuery = tsQuery.eq('user_id', user.id);
            } else if (selectedUser) {
                tsQuery = tsQuery.eq('user_id', selectedUser.id);
            }
            const { data: allTs } = await tsQuery
                .order('year', { ascending: false })
                .order('week_number', { ascending: false })
                .limit(52);
            setAllTimesheets(allTs || []);

            // Charger les soldes congés/récup
            await loadLeaveBalances(targetUserId);

        } catch (err) {
            console.error('Error loading timesheet:', err);
            initializeDays();
        }
        setLoading(false);
    };

    const loadLeaveBalances = async (userId) => {
        try {
            // Année de congés basée sur la date de la semaine (juin-mai)
            const currentLeaveYear = getLeaveYear(weekDates[0]);
            
            const { data: balances, error } = await db.from('user_leave_balances')
                .select('*')
                .eq('user_id', userId)
                .eq('year', currentLeaveYear)
                .maybeSingle();
            
            if (error) {
                console.error('Erreur chargement balances:', error);
                // Table n'existe peut-être pas, utiliser valeurs par défaut
                setLeaveBalances({
                    conges_initial: 0, conges_report: 0, conges_acquis: 25, conges_pris: 0, conges_solde: 25,
                    recup_initial: 0, recup_report: 0, recup_acquis: 0, recup_pris: 0, recup_ajustements: 0, recup_solde: 0
                });
                return;
            }
            
            if (balances) {
                setLeaveBalances(balances);
            } else {
                // Chercher le report de l'année précédente
                const { data: prevYear } = await db.from('user_leave_balances')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('year', currentLeaveYear - 1)
                    .maybeSingle();
                
                setLeaveBalances({
                    conges_initial: 0,
                    conges_report: prevYear?.conges_solde || 0,
                    conges_acquis: 25,
                    conges_pris: 0,
                    conges_solde: 25 + (prevYear?.conges_solde || 0),
                    recup_initial: 0,
                    recup_report: prevYear?.recup_solde || 0,
                    recup_acquis: 0,
                    recup_pris: 0,
                    recup_ajustements: 0,
                    recup_solde: prevYear?.recup_solde || 0
                });
            }

            // Charger les ajustements
            const { data: adj } = await db.from('leave_adjustments')
                .select('*')
                .eq('user_id', userId)
                .eq('year', currentLeaveYear)
                .order('created_at', { ascending: false });
            setAdjustments(adj || []);
        } catch (err) {
            console.error('Error loading balances:', err);
            // Valeurs par défaut en cas d'erreur
            setLeaveBalances({
                conges_initial: 0, conges_report: 0, conges_acquis: 25, conges_pris: 0, conges_solde: 25,
                recup_initial: 0, recup_report: 0, recup_acquis: 0, recup_pris: 0, recup_ajustements: 0, recup_solde: 0
            });
        }
    };

    const initializeDays = () => {
        const initialDays = weekDates.slice(0, 5).map((date, i) => ({
            id: null,
            timesheet_id: null,
            day_date: date.toISOString().split('T')[0],
            day_index: i,
            date: date,
            dayName: dayNames[i],
            morning_departure_type: 'domicile',
            morning_departure_time: '',
            morning_site_location: '',
            morning_arrival_time: '',
            morning_tasks: [{ site: '', start_time: '', end_time: '' }], // Tâches matin
            lunch_type: 'panier',
            lunch_location: '',
            lunch_start_time: '12:00',
            lunch_end_time: '12:30',
            lunch_duration_minutes: 30,
            afternoon_tasks: [{ site: '', start_time: '', end_time: '' }], // Tâches après-midi
            afternoon_departure_site: '',
            afternoon_departure_time: '',
            afternoon_arrival_type: 'domicile',
            afternoon_arrival_time: '',
            is_conges: false,
            is_recuperation: false,
            is_maladie: false,
            is_paternite_maternite: false,
            absence_type: null,
            work_minutes: 0,
            travel_minutes: 0,
            total_minutes: 0,
            notes: ''
        }));
        setDays(initialDays);
    };

    // Convertir temps en minutes
    const timeToMinutes = (timeStr) => {
        if (!timeStr) return 0;
        const [h, m] = timeStr.split(':').map(Number);
        return h * 60 + (m || 0);
    };

    // Convertir minutes en format hh:mm
    const minutesToHM = (minutes) => {
        if (!minutes || minutes < 0) return '0h00';
        const h = Math.floor(Math.abs(minutes) / 60);
        const m = Math.abs(minutes) % 60;
        return `${minutes < 0 ? '-' : ''}${h}h${m.toString().padStart(2, '0')}`;
    };

    // Calculer le temps pour un jour
    // Heures de base par jour pour congé paternité/maternité
    const getBaseHoursForDay = (dayIndex) => {
        // Lun-Jeu (index 0-3): 8h, Ven (index 4): 7h
        return dayIndex === 4 ? 7 * 60 : 8 * 60; // En minutes
    };
    
    // Calculer les heures de nuit (22h-6h) - payées, ne comptent pas dans RTT
    const calculateNightMinutes = (startTime, endTime) => {
        if (!startTime || !endTime) return 0;
        
        const start = timeToMinutes(startTime);
        const end = timeToMinutes(endTime);
        
        // Heures de nuit : 22h (1320 min) à minuit (1440) + minuit (0) à 6h (360)
        const nightStart = 22 * 60; // 22h = 1320 min
        const nightEnd = 6 * 60;    // 6h = 360 min
        
        let nightMinutes = 0;
        
        // Si fin après 22h
        if (end > nightStart) {
            nightMinutes += end - Math.max(start, nightStart);
        }
        
        // Si début avant 6h (travail très tôt le matin)
        if (start < nightEnd) {
            nightMinutes += Math.min(end, nightEnd) - start;
        }
        
        return Math.max(0, nightMinutes);
    };

    const calculateDayTime = (day, dayIndex) => {
        // Congé paternité/maternité = heures normales (pas de déduction congés/RTT)
        if (day.is_paternite_maternite) {
            const baseMinutes = getBaseHoursForDay(dayIndex);
            return { work: baseMinutes, travel: 0, total: baseMinutes, nightWork: 0, absence: false, paterniteMaternite: true };
        }
        
        if (day.is_conges || day.is_recuperation || day.is_maladie) {
            return { work: 0, travel: 0, total: 0, nightWork: 0, absence: true };
        }

        let workMinutes = 0;
        let travelMinutes = 0;
        let nightWorkMinutes = 0;

        // Temps de travail = Heure départ du site - Heure arrivée sur site - Pause
        if (day.morning_arrival_time && day.afternoon_departure_time) {
            const arrivalOnSite = timeToMinutes(day.morning_arrival_time);
            const departureFromSite = timeToMinutes(day.afternoon_departure_time);
            const pauseMinutes = day.lunch_duration_minutes || 0;
            
            if (departureFromSite > arrivalOnSite) {
                workMinutes = departureFromSite - arrivalOnSite - pauseMinutes;
                if (workMinutes < 0) workMinutes = 0;
                
                // Calculer les heures de nuit dans le travail
                nightWorkMinutes = calculateNightMinutes(day.morning_arrival_time, day.afternoon_departure_time);
            }
        }

        // Temps de trajet matin
        if (day.morning_departure_time && day.morning_arrival_time) {
            const dep = timeToMinutes(day.morning_departure_time);
            const arr = timeToMinutes(day.morning_arrival_time);
            if (arr > dep) {
                travelMinutes += (arr - dep);
                // Heures de nuit trajet matin
                nightWorkMinutes += calculateNightMinutes(day.morning_departure_time, day.morning_arrival_time);
            }
        }

        // Temps de trajet soir
        if (day.afternoon_departure_time && day.afternoon_arrival_time) {
            const dep = timeToMinutes(day.afternoon_departure_time);
            const arr = timeToMinutes(day.afternoon_arrival_time);
            if (arr > dep) {
                travelMinutes += (arr - dep);
                // Heures de nuit trajet soir
                nightWorkMinutes += calculateNightMinutes(day.afternoon_departure_time, day.afternoon_arrival_time);
            }
        }

        return { 
            work: workMinutes, 
            travel: travelMinutes, 
            total: workMinutes + travelMinutes, 
            nightWork: nightWorkMinutes, // Heures de nuit payées (ne comptent pas RTT)
            absence: false 
        };
    };

    // Calculer les totaux de la semaine
    const weekTotals = useMemo(() => {
        let work = 0, travel = 0, conges = 0, recup = 0, maladie = 0, nightWork = 0, paterniteMaternite = 0;
        
        days.forEach((day, i) => {
            if (day.is_paternite_maternite) {
                // Congé paternité/maternité compte comme heures normales
                const baseMinutes = getBaseHoursForDay(i);
                work += baseMinutes;
                paterniteMaternite++;
            }
            else if (day.is_conges) conges++;
            else if (day.is_recuperation) {
                // Récup pris en heures selon le jour (Lun-Jeu: 8h, Ven: 7h)
                recup += BASE_HOURS[i] * 60; // En minutes
            }
            else if (day.is_maladie) maladie++;
            else {
                const t = calculateDayTime(day, i);
                work += t.work;
                travel += t.travel;
                // Heures de nuit payées (22h-6h) - tous les jours sauf dimanche (index 6)
                if (i !== 6) {
                    nightWork += t.nightWork || 0;
                }
            }
        });

        // Calculer les heures samedi astreinte (génèrent des récup en minutes)
        let saturdayMinutes = 0;
        interventions.forEach(inter => {
            if (inter.is_saturday) {
                saturdayMinutes += (parseInt(inter.time_on_site_minutes) || 0) + (parseInt(inter.travel_time_minutes) || 0);
            }
        });

        // Heures pour RTT = Total - Heures de nuit (car heures de nuit sont payées)
        const totalForRTT = work + travel - nightWork;

        return { 
            work, 
            travel, 
            total: work + travel, 
            conges, 
            recupMinutes: recup, // Récup pris en minutes
            maladie,
            paterniteMaternite, // Jours congé paternité/maternité
            saturdayMinutes, // Heures samedi acquises en minutes
            nightWork, // Heures de nuit payées (ne comptent pas RTT)
            totalForRTT: Math.max(0, totalForRTT) // Total pour calcul RTT
        };
    }, [days, interventions]);

    // Mettre à jour un jour
    const updateDay = (index, field, value, additionalUpdates = {}) => {
        if (!canEdit) return;
        const newDays = [...days];
        newDays[index] = { ...newDays[index], [field]: value, ...additionalUpdates };
        
        // Recalculer le temps de pause
        if (field === 'lunch_start_time' || field === 'lunch_end_time') {
            const start = timeToMinutes(field === 'lunch_start_time' ? value : newDays[index].lunch_start_time);
            const end = timeToMinutes(field === 'lunch_end_time' ? value : newDays[index].lunch_end_time);
            newDays[index].lunch_duration_minutes = Math.max(0, end - start);
        }
        
        setDays(newDays);
    };

    // Gérer les tâches d'un jour
    // Gérer les tâches d'un jour (period = 'morning' ou 'afternoon')
    const addTask = (dayIndex, period) => {
        if (!canEdit) return;
        const newDays = [...days];
        const key = period === 'morning' ? 'morning_tasks' : 'afternoon_tasks';
        newDays[dayIndex][key] = [...(newDays[dayIndex][key] || []), { site: '', start_time: '', end_time: '' }];
        setDays(newDays);
    };

    const updateTask = (dayIndex, period, taskIndex, field, value) => {
        if (!canEdit) return;
        const newDays = [...days];
        const key = period === 'morning' ? 'morning_tasks' : 'afternoon_tasks';
        newDays[dayIndex][key][taskIndex] = { ...newDays[dayIndex][key][taskIndex], [field]: value };
        setDays(newDays);
    };

    const removeTask = (dayIndex, period, taskIndex) => {
        if (!canEdit) return;
        const newDays = [...days];
        const key = period === 'morning' ? 'morning_tasks' : 'afternoon_tasks';
        newDays[dayIndex][key] = newDays[dayIndex][key].filter((_, i) => i !== taskIndex);
        if (newDays[dayIndex][key].length === 0) {
            newDays[dayIndex][key] = [{ site: '', start_time: '', end_time: '' }];
        }
        setDays(newDays);
    };

    // Sauvegarder la feuille
    const saveTimesheet = async () => {
        const targetUserId = canViewAllTimesheets ? (selectedUser?.id || user.id) : user.id;
        try {
            let tsId = timesheet?.id;

            const tsData = {
                user_id: targetUserId,
                week_number: selectedWeek.week,
                year: selectedWeek.year,
                week_start: weekDates[0].toISOString().split('T')[0],
                week_end: weekDates[6].toISOString().split('T')[0],
                status: timesheet?.status || 'brouillon',
                total_work_minutes: weekTotals.work,
                total_travel_minutes: weekTotals.travel,
                total_minutes: weekTotals.total,
                oncall_semaine: oncalls.semaine,
                oncall_weekend: oncalls.weekend,
                oncall_ferie: oncalls.ferie,
                oncall_soutien: oncalls.soutien,
                updated_at: new Date().toISOString()
            };

            if (tsId) {
                const { error: updateError } = await db.from('timesheets').update(tsData).eq('id', tsId);
                if (updateError) throw updateError;
            } else {
                const { data: newTs, error: insertError } = await db.from('timesheets').insert(tsData).select().single();
                if (insertError) throw insertError;
                if (!newTs) throw new Error('Erreur création feuille');
                tsId = newTs.id;
                setTimesheet(newTs);
            }

            // Sauvegarder les jours
            const updatedDays = [];
            for (const day of days) {
                const dayData = {
                    timesheet_id: tsId,
                    day_date: day.day_date || weekDates[day.day_index]?.toISOString().split('T')[0],
                    day_index: day.day_index,
                    morning_departure_type: day.morning_departure_type,
                    morning_departure_time: day.morning_departure_time || null,
                    morning_site_location: day.morning_site_location,
                    morning_arrival_time: day.morning_arrival_time || null,
                    morning_tasks: day.morning_tasks || [],
                    lunch_type: day.lunch_type,
                    lunch_location: day.lunch_location,
                    lunch_start_time: day.lunch_start_time || null,
                    lunch_end_time: day.lunch_end_time || null,
                    lunch_duration_minutes: day.lunch_duration_minutes,
                    afternoon_tasks: day.afternoon_tasks || [],
                    afternoon_departure_site: day.afternoon_departure_site,
                    afternoon_departure_time: day.afternoon_departure_time || null,
                    afternoon_arrival_type: day.afternoon_arrival_type,
                    afternoon_arrival_time: day.afternoon_arrival_time || null,
                    is_conges: day.is_conges || false,
                    is_recuperation: day.is_recuperation || false,
                    is_maladie: day.is_maladie || false,
                    is_paternite_maternite: day.is_paternite_maternite || false,
                    absence_type: day.absence_type,
                    work_minutes: calculateDayTime(day, i).work,
                    travel_minutes: calculateDayTime(day, i).travel,
                    total_minutes: calculateDayTime(day, i).total,
                    notes: day.notes
                };

                if (day.id) {
                    const { error: dayUpdateError } = await db.from('timesheet_days').update(dayData).eq('id', day.id);
                    if (dayUpdateError) console.error('Erreur update jour:', dayUpdateError);
                    updatedDays.push({ ...day, ...dayData, morning_tasks: day.morning_tasks, afternoon_tasks: day.afternoon_tasks });
                } else {
                    const { data: newDay, error: dayInsertError } = await db.from('timesheet_days').insert(dayData).select().single();
                    if (dayInsertError) console.error('Erreur insert jour:', dayInsertError);
                    if (newDay) {
                        updatedDays.push({ ...day, ...newDay, morning_tasks: day.morning_tasks, afternoon_tasks: day.afternoon_tasks });
                    } else {
                        updatedDays.push({ ...day, ...dayData, morning_tasks: day.morning_tasks, afternoon_tasks: day.afternoon_tasks });
                    }
                }
            }
            
            // Mettre à jour les jours avec leurs IDs
            setDays(updatedDays);

            // Sauvegarder les interventions
            try {
                await db.from('timesheet_interventions').delete().eq('timesheet_id', tsId);
                for (const inter of interventions) {
                    if (inter.intervention_date) {
                        const interDate = new Date(inter.intervention_date);
                        const isSaturday = interDate.getDay() === 6;
                        const { error: interError } = await db.from('timesheet_interventions').insert({
                            timesheet_id: tsId,
                            intervention_date: inter.intervention_date,
                            intervention_time: inter.intervention_time || null,
                            ac_number: inter.ac_number || null,
                            location: inter.location || null,
                            reason: inter.reason || null,
                            time_on_site_minutes: parseInt(inter.time_on_site_minutes) || 0,
                            travel_time_minutes: parseInt(inter.travel_time_minutes) || 0,
                            is_saturday: isSaturday
                        });
                        if (interError) console.error('Erreur intervention:', interError);
                    }
                }
            } catch (interErr) {
                console.error('Erreur sauvegarde interventions:', interErr);
            }

            // Historique (optionnel, ne bloque pas la sauvegarde)
            try {
                await db.from('timesheet_history').insert({
                    timesheet_id: tsId,
                    action: timesheet?.id ? 'modified' : 'created',
                    action_by: user.id,
                    details: 'Sauvegarde',
                    old_status: timesheet?.status,
                    new_status: timesheet?.status || 'brouillon'
                });
            } catch (histErr) {
                console.error('Erreur historique (ignorée):', histErr);
            }

            showToast('Feuille d\'heures sauvegardée');
        } catch (err) {
            console.error('Erreur sauvegarde:', err);
            showToast('Erreur: ' + err.message, 'error');
        }
    };

    // Valider la feuille
    const validateTimesheet = async () => {
        try {
            await saveTimesheet();
            
            await db.from('timesheets').update({
                status: 'valide',
                validated_at: new Date().toISOString()
            }).eq('id', timesheet.id);

            await db.from('timesheet_history').insert({
                timesheet_id: timesheet.id,
                action: 'validated',
                action_by: user.id,
                details: 'Validation par le technicien',
                old_status: 'brouillon',
                new_status: 'valide'
            });

            // Mettre à jour les compteurs
            await updateLeaveBalances();

            // Notifier les admins de la validation
            const admins = data.users.filter(u => u.role === 'admin' && u.id !== user.id);
            const weekStr = `S${selectedWeek.week}/${selectedWeek.year}`;
            const userName = `${user.first_name || ''} ${user.last_name || user.email}`.trim();
            admins.forEach(admin => {
                createNotification({
                    userId: admin.id,
                    type: 'timesheet_submitted',
                    title: 'Feuille d\'heures validée',
                    body: `${userName} a validé sa feuille ${weekStr}`,
                    actionUrl: '/feuilles-heures',
                });
            });

            showToast('Feuille d\'heures validée');
            setShowValidateConfirm(false);
            loadTimesheet();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };

    // Déverrouiller (admin)
    const unlockTimesheet = async () => {
        if (!isAdmin) return;
        try {
            await db.from('timesheets').update({
                status: 'deverrouille',
                unlocked_by: user.id,
                unlocked_at: new Date().toISOString()
            }).eq('id', timesheet.id);

            await db.from('timesheet_history').insert({
                timesheet_id: timesheet.id,
                action: 'unlocked',
                action_by: user.id,
                details: 'Déverrouillage admin',
                old_status: 'valide',
                new_status: 'deverrouille'
            });

            // Notifier le technicien que sa feuille a été déverrouillée
            const targetUserId = canViewAllTimesheets ? (selectedUser?.id || user.id) : user.id;
            if (targetUserId !== user.id) {
                const weekStr = `S${selectedWeek.week}/${selectedWeek.year}`;
                createNotification({
                    userId: targetUserId,
                    type: 'timesheet_rejected',
                    title: 'Feuille d\'heures déverrouillée',
                    body: `Votre feuille ${weekStr} a été déverrouillée par un admin pour modification`,
                    actionUrl: '/feuilles-heures',
                });
            }

            showToast('Feuille déverrouillée');
            loadTimesheet();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };

    // Mettre à jour les compteurs
    const updateLeaveBalances = async () => {
        const targetUserId = canViewAllTimesheets ? (selectedUser?.id || user.id) : user.id;
        const currentLeaveYear = getLeaveYear(weekDates[0]); // Année de congés (juin-mai)
        const congesPris = days.filter(d => d.is_conges).length;
        // Récup pris en heures (Lun-Jeu: 8h, Ven: 7h)
        const recupPrisHeures = weekTotals.recupMinutes / 60;
        // Récup acquis en heures (samedi astreinte)
        const recupAcquisHeures = weekTotals.saturdayMinutes / 60;
        
        try {
            const { data: existing, error } = await db.from('user_leave_balances')
                .select('*')
                .eq('user_id', targetUserId)
                .eq('year', currentLeaveYear)
                .maybeSingle();

            if (error) {
                console.error('Erreur lecture balances:', error);
                return;
            }

            // Chercher report année précédente si pas existant
            let congesReport = 0, recupReport = 0;
            if (!existing) {
                const { data: prevYear } = await db.from('user_leave_balances')
                    .select('conges_solde, recup_solde')
                    .eq('user_id', targetUserId)
                    .eq('year', currentLeaveYear - 1)
                    .maybeSingle();
                congesReport = prevYear?.conges_solde || 0;
                recupReport = prevYear?.recup_solde || 0;
            }

            const balanceData = {
                user_id: targetUserId,
                year: currentLeaveYear,
                conges_initial: existing?.conges_initial || 0,
                conges_report: existing?.conges_report || congesReport,
                conges_acquis: existing?.conges_acquis || 25,
                conges_pris: (existing?.conges_pris || 0) + congesPris,
                recup_initial: existing?.recup_initial || 0,
                recup_report: existing?.recup_report || recupReport,
                recup_acquis: (existing?.recup_acquis || 0) + recupAcquisHeures,
                recup_pris: (existing?.recup_pris || 0) + recupPrisHeures,
                recup_ajustements: existing?.recup_ajustements || 0,
                updated_at: new Date().toISOString()
            };

            // Calculer les soldes (congés en jours, récup en heures)
            balanceData.conges_solde = balanceData.conges_initial + balanceData.conges_report + balanceData.conges_acquis - balanceData.conges_pris;
            balanceData.recup_solde = balanceData.recup_initial + balanceData.recup_report + balanceData.recup_acquis - balanceData.recup_pris + balanceData.recup_ajustements;

            if (existing) {
                await db.from('user_leave_balances').update(balanceData).eq('id', existing.id);
            } else {
                await db.from('user_leave_balances').insert(balanceData);
            }
        } catch (err) {
            console.error('Error updating leave balances:', err);
        }
    };

    // Ajouter un ajustement
    const addAdjustment = async (type, amount, reason, description) => {
        const targetUserId = canViewAllTimesheets ? (selectedUser?.id || user.id) : user.id;
        const currentLeaveYear = getLeaveYear(weekDates[0]);
        // Seul admin peut modifier les compteurs d'autres utilisateurs
        if (selectedUser && selectedUser.id !== user.id && !isAdmin) {
            showToast('Vous ne pouvez modifier que vos propres compteurs', 'error');
            return;
        }
        
        try {
            await db.from('leave_adjustments').insert({
                user_id: targetUserId,
                year: currentLeaveYear,
                adjustment_type: type,
                amount: amount,
                reason: reason,
                description: description,
                created_by: user.id
            });

            // Mettre à jour le solde
            const { data: balance } = await db.from('user_leave_balances')
                .select('*')
                .eq('user_id', targetUserId)
                .eq('year', currentLeaveYear)
                .maybeSingle();

            if (balance) {
                if (type === 'recup') {
                    const newAjustements = (balance.recup_ajustements || 0) + amount;
                    const newSolde = balance.recup_initial + balance.recup_report + balance.recup_acquis - balance.recup_pris + newAjustements;
                    await db.from('user_leave_balances').update({ 
                        recup_ajustements: newAjustements,
                        recup_solde: newSolde
                    }).eq('id', balance.id);
                } else if (type === 'conges') {
                    const newSolde = balance.conges_initial + balance.conges_report + balance.conges_acquis - balance.conges_pris + amount;
                    await db.from('user_leave_balances').update({ 
                        conges_solde: newSolde
                    }).eq('id', balance.id);
                }
            }

            showToast('Ajustement enregistré');
            setShowAdjustmentModal(false);
            loadLeaveBalances(targetUserId);
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };

    // Définir les compteurs initiaux
    const setInitialBalances = async (congesInitial, recupInitial, congesAcquis) => {
        const targetUserId = canViewAllTimesheets ? (selectedUser?.id || user.id) : user.id;
        const currentLeaveYear = getLeaveYear(weekDates[0]);
        
        // Vérifier si verrouillé
        if (leaveBalances.initial_locked && !isAdmin) {
            showToast('Les compteurs initiaux sont verrouillés. Contactez un administrateur.', 'error');
            return;
        }
        
        // Seul admin peut modifier les compteurs d'autres utilisateurs
        if (selectedUser && selectedUser.id !== user.id && !isAdmin) {
            showToast('Vous ne pouvez modifier que vos propres compteurs', 'error');
            return;
        }
        
        try {
            const { data: existing, error } = await db.from('user_leave_balances')
                .select('*')
                .eq('user_id', targetUserId)
                .eq('year', currentLeaveYear)
                .maybeSingle();

            if (error) {
                console.error('Erreur lecture balances:', error);
                showToast('Erreur: Table non trouvée. Veuillez exécuter le SQL de configuration.', 'error');
                return;
            }

            const balanceData = {
                user_id: targetUserId,
                year: currentLeaveYear,
                conges_initial: congesInitial,
                recup_initial: recupInitial,
                conges_report: existing?.conges_report || 0,
                recup_report: existing?.recup_report || 0,
                conges_acquis: congesAcquis, // 2.08j × nombre de mois
                recup_acquis: existing?.recup_acquis || 0,
                conges_pris: existing?.conges_pris || 0,
                recup_pris: existing?.recup_pris || 0,
                recup_ajustements: existing?.recup_ajustements || 0,
                initial_locked: existing?.initial_locked || false,
                initial_locked_at: existing?.initial_locked_at || null,
                initial_locked_by: existing?.initial_locked_by || null,
                updated_at: new Date().toISOString()
            };
            balanceData.conges_solde = balanceData.conges_initial + balanceData.conges_report + balanceData.conges_acquis - balanceData.conges_pris;
            balanceData.recup_solde = balanceData.recup_initial + balanceData.recup_report + balanceData.recup_acquis - balanceData.recup_pris + balanceData.recup_ajustements;

            if (existing) {
                await db.from('user_leave_balances').update(balanceData).eq('id', existing.id);
            } else {
                await db.from('user_leave_balances').insert(balanceData);
            }

            // Ajouter dans l'historique des ajustements (optionnel)
            try {
                if (congesInitial !== (existing?.conges_initial || 0)) {
                    await db.from('leave_adjustments').insert({
                        user_id: targetUserId, year: currentLeaveYear, adjustment_type: 'conges',
                        amount: congesInitial, reason: 'initial', description: 'Compteur de départ congés',
                        created_by: user.id
                    });
                }
                if (recupInitial !== (existing?.recup_initial || 0)) {
                    await db.from('leave_adjustments').insert({
                        user_id: targetUserId, year: currentLeaveYear, adjustment_type: 'recup',
                        amount: recupInitial, reason: 'initial', description: 'Compteur de départ récup',
                        created_by: user.id
                    });
                }
            } catch (adjErr) {
                console.error('Erreur historique (ignorée):', adjErr);
            }

            showToast('Compteurs mis à jour');
            loadLeaveBalances(targetUserId);
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };

    // Verrouiller les compteurs initiaux
    const lockInitialBalances = async () => {
        const targetUserId = canViewAllTimesheets ? (selectedUser?.id || user.id) : user.id;
        const currentLeaveYear = getLeaveYear(weekDates[0]);
        
        try {
            const { data: existing } = await db.from('user_leave_balances')
                .select('*')
                .eq('user_id', targetUserId)
                .eq('year', currentLeaveYear)
                .maybeSingle();

            if (!existing) {
                showToast('Veuillez d\'abord enregistrer les compteurs', 'error');
                return;
            }

            await db.from('user_leave_balances').update({
                initial_locked: true,
                initial_locked_at: new Date().toISOString(),
                initial_locked_by: user.id
            }).eq('id', existing.id);

            // Historique (optionnel)
            try {
                await db.from('leave_adjustments').insert({
                    user_id: targetUserId, 
                    year: currentLeaveYear, 
                    adjustment_type: 'conges',
                    amount: 0, 
                    reason: 'verrouillage', 
                    description: 'Verrouillage des compteurs initiaux',
                    created_by: user.id
                });
            } catch (adjErr) {
                console.error('Erreur historique (ignorée):', adjErr);
            }

            showToast('Compteurs initiaux verrouillés');
            setShowLockConfirm(false);
            loadLeaveBalances(targetUserId);
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };

    // Déverrouiller les compteurs initiaux (admin uniquement)
    const unlockInitialBalances = async () => {
        if (!isAdmin) return;
        const targetUserId = canViewAllTimesheets ? (selectedUser?.id || user.id) : user.id;
        const currentLeaveYear = getLeaveYear(weekDates[0]);
        
        try {
            const { data: existing } = await db.from('user_leave_balances')
                .select('*')
                .eq('user_id', targetUserId)
                .eq('year', currentLeaveYear)
                .maybeSingle();

            if (!existing) return;

            await db.from('user_leave_balances').update({
                initial_locked: false,
                initial_locked_at: null,
                initial_locked_by: null
            }).eq('id', existing.id);

            // Historique (optionnel)
            try {
                await db.from('leave_adjustments').insert({
                    user_id: targetUserId, 
                    year: currentLeaveYear, 
                    adjustment_type: 'conges',
                    amount: 0, 
                    reason: 'deverrouillage', 
                    description: 'Déverrouillage des compteurs initiaux par admin',
                    created_by: user.id
                });
            } catch (adjErr) {
                console.error('Erreur historique (ignorée):', adjErr);
            }

            showToast('Compteurs initiaux déverrouillés');
            loadLeaveBalances(targetUserId);
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };

    // Export PDF - Format Tableau Détaillé Portrait
    const exportPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('landscape', 'mm', 'a4');
        const pageWidth = 297;
        const pageHeight = 210;
        const margin = 10;
        const targetUser = canViewAllTimesheets ? (selectedUser || user) : user;
        
        // Couleurs
        const primaryColor = [225, 29, 72]; // Rouge primaire
        const successColor = [16, 185, 129];
        const warningColor = [245, 158, 11];
        const dangerColor = [239, 68, 68];
        const blueColor = [59, 130, 246];
        const grayLight = [248, 250, 252];
        const grayDark = [71, 85, 105];
        const travelColor = [147, 51, 234];
        const morningColor = [219, 234, 254];
        const afternoonColor = [254, 226, 226];
        
        // ==================== EN-TÊTE MODERNE ====================
        const headerHeight = 32;
        const logoWidth = 42;
        const logoHeight = 20;
        
        // Dégradé rouge
        for (let i = 0; i < 6; i++) {
            const ratio = i / 6;
            doc.setFillColor(Math.round(127 + ratio * 112), Math.round(29 + ratio * 39), Math.round(29 + ratio * 39));
            doc.rect(0, (headerHeight / 6) * i, pageWidth, headerHeight / 6 + 1, 'F');
        }
        doc.setFillColor(55, 65, 81);
        doc.rect(0, headerHeight - 2, pageWidth, 2, 'F');
        
        // Logo
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(8, 4, logoWidth + 4, logoHeight + 4, 2, 2, 'F');
        try {
            doc.addImage(COMPANY_LOGO, 'PNG', 10, 6, logoWidth, logoHeight);
        } catch (e) {}
        
        // Titre
        const techName = `${targetUser.first_name || ''} ${targetUser.last_name || targetUser.email}`;
        const dateRange = `Du ${weekDates[0].toLocaleDateString('fr-FR')} au ${weekDates[4].toLocaleDateString('fr-FR')}`;
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(16);
        doc.setFont('helvetica', 'bold');
        doc.text('FEUILLE D\'HEURES', pageWidth / 2, 12, { align: 'center' });
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(226, 232, 240);
        doc.text(`Semaine ${selectedWeek.week} - ${selectedWeek.year}`, pageWidth / 2, 20, { align: 'center' });
        
        // Technicien et dates à droite
        doc.setFontSize(11);
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.text(techName, pageWidth - margin, 12, { align: 'right' });
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(200, 200, 220);
        doc.text(dateRange, pageWidth - margin, 20, { align: 'right' });
        
        // Badge validée
        if (timesheet?.status === 'valide') {
            doc.setFillColor(...successColor);
            doc.roundedRect(pageWidth - margin - 45, 24, 45, 6, 2, 2, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(7);
            doc.setFont('helvetica', 'bold');
            doc.text('VALIDÉE', pageWidth - margin - 22.5, 28, { align: 'center' });
        }
        
        let y = headerHeight + 6;
        
        // ==================== TABLEAU DÉTAILLÉ DES JOURS ====================
        const tableWidth = pageWidth - 2 * margin;
        const col1 = 22; // Jour
        const col2 = 55; // Trajets (augmenté)
        const col3 = 65; // Matin (réduit)
        const col4 = 22; // Pause (réduit)
        const col5 = 65; // Après-midi (réduit)
        const col6 = tableWidth - col1 - col2 - col3 - col4 - col5; // Total (~48mm)
        
        // En-tête du tableau
        doc.setFillColor(...primaryColor);
        doc.rect(margin, y, tableWidth, 10, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        
        let x = margin;
        doc.text('JOUR', x + 2, y + 7);
        x += col1;
        doc.text('TRAJETS', x + 2, y + 7);
        x += col2;
        doc.text('MATIN', x + 2, y + 7);
        x += col3;
        doc.text('PAUSE', x + 2, y + 7);
        x += col4;
        doc.text('APRÈS-MIDI', x + 2, y + 7);
        x += col5;
        doc.text('TOTAL', x + 2, y + 7);
        
        y += 10;
        
        // Contenu pour chaque jour
        days.forEach((day, i) => {
            const t = calculateDayTime(day, i);
            const isAbsent = day.is_conges || day.is_recuperation || day.is_maladie;
            const isPaterniteMaternite = day.is_paternite_maternite;
            const morningTasks = (day.morning_tasks || []).filter(t => t.site || t.start_time);
            const afternoonTasks = (day.afternoon_tasks || []).filter(t => t.site || t.start_time);
            const maxTasks = Math.max(morningTasks.length, afternoonTasks.length, 1);
            const rowHeight = (isAbsent || isPaterniteMaternite) ? 14 : Math.max(28, 8 + maxTasks * 7);
            
            // Vérifier si on dépasse la page
            if (y + rowHeight > pageHeight - 50) {
                doc.addPage();
                y = 15;
            }
            
            // Fond alterné
            doc.setFillColor(i % 2 === 0 ? 255 : 248, i % 2 === 0 ? 255 : 250, i % 2 === 0 ? 255 : 252);
            if (isAbsent) {
                if (day.is_conges) doc.setFillColor(254, 243, 199);
                else if (day.is_recuperation) doc.setFillColor(219, 234, 254);
                else doc.setFillColor(254, 226, 226);
            } else if (isPaterniteMaternite) {
                doc.setFillColor(224, 231, 255);
            }
            doc.rect(margin, y, tableWidth, rowHeight, 'F');
            
            // Bordures
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.rect(margin, y, tableWidth, rowHeight, 'S');
            
            // Lignes verticales
            x = margin + col1;
            doc.line(x, y, x, y + rowHeight);
            x += col2;
            doc.line(x, y, x, y + rowHeight);
            x += col3;
            doc.line(x, y, x, y + rowHeight);
            x += col4;
            doc.line(x, y, x, y + rowHeight);
            x += col5;
            doc.line(x, y, x, y + rowHeight);
            
            doc.setTextColor(0, 0, 0);
            
            // COL 1 : Jour
            x = margin;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text(dayNames[i].substring(0, 3).toUpperCase(), x + 2, y + 7);
            doc.setFont(undefined, 'normal');
            doc.setFontSize(8);
            doc.text(weekDates[i].toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }), x + 2, y + 12);
            
            if (isPaterniteMaternite) {
                // Affichage centré du congé paternité/maternité
                x = margin + col1;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                doc.setTextColor(79, 70, 229);
                doc.text('PATERNITE/MATERNITE', x + (tableWidth - col1 - col6) / 2, y + rowHeight / 2 + 1);
                
                // Total = heures normales
                x = margin + tableWidth - col6;
                doc.setTextColor(...successColor);
                doc.text(minutesToHM(t.total), x + col6 / 2, y + rowHeight / 2 + 1, { align: 'center' });
            } else if (isAbsent) {
                // Affichage centré de l'absence
                x = margin + col1;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                const absText = day.is_conges ? 'CONGES' : day.is_recuperation ? 'RECUPERATION' : 'MALADIE';
                const absColor = day.is_conges ? warningColor : day.is_recuperation ? blueColor : dangerColor;
                doc.setTextColor(...absColor);
                doc.text(absText, x + (tableWidth - col1 - col6) / 2, y + rowHeight / 2 + 1);
                
                // Total
                x = margin + col1 + col2 + col3 + col4 + col5;
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(9);
                doc.text('1 jour', x + 2, y + rowHeight / 2 + 1);
            } else {
                // COL 2 : Trajets (simplifié)
                x = margin + col1;
                doc.setFontSize(7);
                
                // Aller - format compact
                doc.setFillColor(...travelColor);
                doc.roundedRect(x + 1, y + 2, 18, 5, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('ALLER', x + 2, y + 5.5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                const depType = day.morning_departure_type === 'domicile' ? 'Dom' : day.morning_departure_type === 'hotel' ? 'Hôtel' : 'Dépôt';
                doc.text(`Dép: ${day.morning_departure_time || '--:--'} (${depType})`, x + 21, y + 5.5);
                doc.text(`Arr: ${day.morning_arrival_time || '--:--'}`, x + 2, y + 11);
                
                // Retour - format compact
                doc.setFillColor(...travelColor);
                doc.roundedRect(x + 1, y + 14, 22, 5, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.text('RETOUR', x + 2, y + 17.5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                const retType = day.afternoon_arrival_type === 'domicile' ? 'Dom' : day.afternoon_arrival_type === 'hotel' ? 'Hôtel' : 'Dépôt';
                doc.text(`Dép: ${day.afternoon_departure_time || '--:--'}`, x + 25, y + 17.5);
                doc.text(`Arr: ${day.afternoon_arrival_time || '--:--'} (${retType})`, x + 2, y + 23);
                
                // COL 3 : Matin
                x = margin + col1 + col2;
                doc.setFillColor(...morningColor);
                doc.roundedRect(x + 1, y + 1, col3 - 2, 5, 1, 1, 'F');
                doc.setTextColor(30, 64, 175);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('MATIN', x + 2, y + 4.5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                if (morningTasks.length > 0) {
                    morningTasks.forEach((task, ti) => {
                        const ty = y + 8 + ti * 7;
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text((task.site || '-').substring(0, 22), x + 2, ty);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(6);
                        if (task.start_time || task.end_time) {
                            doc.text(`${task.start_time || '--:--'} - ${task.end_time || '--:--'}`, x + 2, ty + 3.5);
                        }
                    });
                } else {
                    doc.setFontSize(8);
                    doc.text('-', x + 2, y + 12);
                }
                
                // COL 4 : Pause
                x = margin + col1 + col2 + col3;
                doc.setFillColor(254, 243, 199);
                doc.roundedRect(x + 1, y + 4, col4 - 2, 14, 2, 2, 'F');
                doc.setTextColor(146, 64, 14);
                doc.setFontSize(6);
                doc.setFont('helvetica', 'bold');
                const pauseLabel = day.lunch_type === 'restaurant' ? 'Rest.' : 'Panier';
                doc.text(pauseLabel, x + col4 / 2, y + 9, { align: 'center' });
                doc.setFont('helvetica', 'normal');
                doc.text(`${day.lunch_duration_minutes || 30}min`, x + col4 / 2, y + 14, { align: 'center' });
                
                // COL 5 : Après-midi
                x = margin + col1 + col2 + col3 + col4;
                doc.setFillColor(...afternoonColor);
                doc.roundedRect(x + 1, y + 1, col5 - 2, 5, 1, 1, 'F');
                doc.setTextColor(185, 28, 28);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'bold');
                doc.text('APRES-MIDI', x + 2, y + 4.5);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(0, 0, 0);
                
                if (afternoonTasks.length > 0) {
                    afternoonTasks.forEach((task, ti) => {
                        const ty = y + 8 + ti * 7;
                        doc.setFontSize(7);
                        doc.setFont('helvetica', 'bold');
                        doc.text((task.site || '-').substring(0, 22), x + 2, ty);
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(6);
                        if (task.start_time || task.end_time) {
                            doc.text(`${task.start_time || '--:--'} - ${task.end_time || '--:--'}`, x + 2, ty + 3.5);
                        }
                    });
                } else {
                    doc.setFontSize(8);
                    doc.text('-', x + 2, y + 12);
                }
                
                // COL 6 : Total (amélioré)
                x = margin + col1 + col2 + col3 + col4 + col5;
                
                // Badge total principal
                doc.setFillColor(...(t.total > 0 ? successColor : [180, 180, 180]));
                doc.roundedRect(x + 2, y + 2, col6 - 4, 10, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.text(minutesToHM(t.total), x + col6 / 2, y + 9, { align: 'center' });
                
                // Détails en dessous
                doc.setTextColor(60, 60, 60);
                doc.setFontSize(7);
                doc.setFont('helvetica', 'normal');
                doc.text(`Travail: ${minutesToHM(t.work)}`, x + 3, y + 17);
                doc.text(`Trajet: ${minutesToHM(t.travel)}`, x + 3, y + 22);
                
                if (t.nightWork > 0) {
                    doc.setTextColor(49, 46, 129);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Nuit: ${minutesToHM(t.nightWork)}`, x + 3, y + 27);
                }
            }
            
            y += rowHeight;
        });
        
        // ==================== RÉCAPITULATIF SEMAINE ====================
        y += 5;
        if (y > pageHeight - 70) {
            doc.addPage();
            y = 15;
        }
        
        doc.setFillColor(...grayLight);
        doc.roundedRect(margin, y, tableWidth, 25, 3, 3, 'F');
        doc.setDrawColor(...primaryColor);
        doc.setLineWidth(0.8);
        doc.roundedRect(margin, y, tableWidth, 25, 3, 3, 'S');
        
        doc.setTextColor(...primaryColor);
        doc.setFontSize(11);
        doc.setFont(undefined, 'bold');
        doc.text('RECAPITULATIF SEMAINE', margin + 5, y + 7);
        
        // Totaux en badges
        const badges = [
            { label: 'Travail', value: minutesToHM(weekTotals.work), bg: [219, 234, 254], color: blueColor },
            { label: 'Trajet', value: minutesToHM(weekTotals.travel), bg: [243, 232, 255], color: travelColor },
            { label: 'TOTAL', value: minutesToHM(weekTotals.total), bg: [209, 250, 229], color: successColor },
            { label: 'Conges', value: `${weekTotals.conges}j`, bg: [254, 243, 199], color: warningColor },
            { label: 'Recup pris', value: minutesToHM(weekTotals.recupMinutes), bg: [219, 234, 254], color: blueColor },
            { label: 'Maladie', value: `${weekTotals.maladie}j`, bg: [254, 226, 226], color: dangerColor },
            { label: 'Pat/Mat', value: `${weekTotals.paterniteMaternite || 0}j`, bg: [224, 231, 255], color: [79, 70, 229] },
            { label: 'Sam. acquis', value: minutesToHM(weekTotals.saturdayMinutes), bg: [209, 250, 229], color: successColor }
        ];
        
        if (weekTotals.nightWork > 0) {
            badges.push({ label: 'Nuit 22h-6h', value: minutesToHM(weekTotals.nightWork), bg: [199, 210, 254], color: [49, 46, 129] });
        }
        
        const badgeWidth = (tableWidth - 10) / badges.length;
        badges.forEach((b, i) => {
            const bx = margin + 5 + i * badgeWidth;
            doc.setFillColor(...b.bg);
            doc.roundedRect(bx, y + 10, badgeWidth - 3, 12, 2, 2, 'F');
            doc.setTextColor(...b.color);
            doc.setFontSize(6);
            doc.setFont(undefined, 'bold');
            doc.text(b.label.toUpperCase(), bx + (badgeWidth - 3) / 2, y + 14, { align: 'center' });
            doc.setFontSize(9);
            doc.text(b.value, bx + (badgeWidth - 3) / 2, y + 20, { align: 'center' });
        });
        
        y += 30;
        
        // ==================== ASTREINTES & INTERVENTIONS ====================
        const hasInterventions = interventions.filter(i => i.intervention_date).length > 0;
        const astreinteHeight = 20 + (hasInterventions ? Math.min(interventions.filter(i => i.intervention_date).length, 5) * 8 : 0);
        const astreinteWidth = tableWidth * 0.65;
        
        if (y + astreinteHeight > pageHeight - 20) {
            doc.addPage();
            y = 15;
        }
        
        doc.setFillColor(254, 243, 199);
        doc.roundedRect(margin, y, astreinteWidth, astreinteHeight, 3, 3, 'F');
        doc.setDrawColor(245, 158, 11);
        doc.setLineWidth(0.5);
        doc.roundedRect(margin, y, astreinteWidth, astreinteHeight, 3, 3, 'S');
        
        doc.setTextColor(146, 64, 14);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('ASTREINTES & INTERVENTIONS', margin + 5, y + 7);
        
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        const astrList = [];
        if (oncalls.semaine) astrList.push('[X] Semaine');
        if (oncalls.weekend) astrList.push('[X] Weekend');
        if (oncalls.ferie) astrList.push('[X] Ferie');
        if (oncalls.soutien) astrList.push('[X] Soutien');
        if (astrList.length === 0) astrList.push('Aucune astreinte');
        doc.text(astrList.join('    '), margin + 5, y + 14);
        
        // Interventions
        if (hasInterventions) {
            const inters = interventions.filter(i => i.intervention_date).slice(0, 5);
            doc.setFontSize(7);
            doc.setFont(undefined, 'bold');
            doc.text('Date', margin + 5, y + 21);
            doc.text('Heure', margin + 28, y + 21);
            doc.text('Appareil', margin + 48, y + 21);
            doc.text('Motif', margin + 75, y + 21);
            doc.text('Sur place', margin + 115, y + 21);
            
            doc.setFont(undefined, 'normal');
            inters.forEach((inter, idx) => {
                const iy = y + 27 + idx * 8;
                doc.setTextColor(0, 0, 0);
                doc.text(inter.intervention_date || '-', margin + 5, iy);
                doc.text(inter.intervention_time || '-', margin + 28, iy);
                doc.text((inter.ac_number || '-').substring(0, 12), margin + 48, iy);
                doc.text((inter.reason || '-').substring(0, 20), margin + 75, iy);
                doc.text(`${inter.time_on_site_minutes || 0}min + ${inter.travel_time_minutes || 0}min traj`, margin + 115, iy);
                if (inter.is_saturday) {
                    doc.setTextColor(239, 68, 68);
                    doc.setFont(undefined, 'bold');
                    doc.text('SAM', margin + astreinteWidth - 15, iy);
                    doc.setFont(undefined, 'normal');
                }
            });
        }
        
        // ==================== SIGNATURES ====================
        const sigX = margin + astreinteWidth + 5;
        const sigWidth = tableWidth - astreinteWidth - 5;
        
        doc.setFillColor(255, 255, 255);
        doc.roundedRect(sigX, y, sigWidth, astreinteHeight, 3, 3, 'F');
        doc.setDrawColor(...primaryColor);
        doc.setLineWidth(0.5);
        doc.roundedRect(sigX, y, sigWidth, astreinteHeight, 3, 3, 'S');
        
        doc.setTextColor(...primaryColor);
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('SIGNATURES', sigX + sigWidth / 2, y + 7, { align: 'center' });
        
        // Zones signatures
        const sigBoxHeight = (astreinteHeight - 25) / 2;
        doc.setDrawColor(180, 180, 180);
        doc.setLineWidth(0.3);
        doc.rect(sigX + 5, y + 12, sigWidth - 10, sigBoxHeight, 'S');
        doc.rect(sigX + 5, y + 14 + sigBoxHeight, sigWidth - 10, sigBoxHeight, 'S');
        
        doc.setTextColor(100, 116, 139);
        doc.setFontSize(7);
        doc.setFont(undefined, 'normal');
        doc.text('Technicien', sigX + 7, y + 16);
        doc.text('Responsable', sigX + 7, y + 18 + sigBoxHeight);
        
        if (timesheet?.status === 'valide') {
            doc.setTextColor(...successColor);
            doc.setFontSize(7);
            doc.setFont(undefined, 'bold');
            doc.text(`Validee le ${new Date(timesheet.validated_at).toLocaleDateString('fr-FR')}`, sigX + sigWidth / 2, y + astreinteHeight - 3, { align: 'center' });
        }
        
        // ==================== PIED DE PAGE ====================
        const footerY = pageHeight - 8;
        doc.setFontSize(7);
        doc.setTextColor(100, 116, 139);
        doc.setFont(undefined, 'normal');
        doc.text(`Genere le ${new Date().toLocaleDateString('fr-FR')} a ${new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}`, margin, footerY);
        doc.text('Lieux: Dom.=Domicile, Hot.=Hotel, Dep.=Depot', pageWidth / 2, footerY, { align: 'center' });
        doc.text(`Page 1/${doc.internal.getNumberOfPages()}`, pageWidth - margin, footerY, { align: 'right' });

        doc.save(`feuille-heures-S${selectedWeek.week}-${selectedWeek.year}.pdf`);
        showToast('PDF exporte');
    };

    // Ajouter une intervention
    const addIntervention = () => {
        setInterventions([...interventions, {
            intervention_date: '',
            intervention_time: '',
            ac_number: '',
            location: '',
            reason: '',
            time_on_site_minutes: '',
            travel_time_minutes: '',
            is_saturday: false
        }]);
    };

    // Rendu d'un jour
    const renderDayRow = (day, index) => {
        const dayTime = calculateDayTime(day, index);
        const isAbsent = day.is_conges || day.is_recuperation || day.is_maladie;
        const isPaterniteMaternite = day.is_paternite_maternite;
        const isLocked = timesheet?.status === 'valide' && !isAdmin;
        const baseHours = BASE_HOURS[index];
        
        // Style selon le type de journée
        let cardBorder = '1px solid var(--border)';
        let cardBg = 'white';
        let headerBg = 'var(--background)';
        if (isAbsent) {
            cardBorder = '2px solid #FDE68A';
            cardBg = '#FFFBEB';
            headerBg = '#FEF3C7';
        } else if (isPaterniteMaternite) {
            cardBorder = '2px solid #A5B4FC';
            cardBg = '#EEF2FF';
            headerBg = '#E0E7FF';
        }
        
        return h('div', { 
            key: index, 
            className: 'card',
            style: { 
                marginBottom: 16,
                border: cardBorder,
                background: cardBg,
                opacity: isLocked ? 0.85 : 1
            }
        },
            // En-tête du jour
            h('div', { 
                className: 'card-header', 
                style: { 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center', 
                    flexWrap: 'wrap', 
                    gap: 12,
                    background: headerBg,
                    borderBottom: '1px solid var(--border)'
                } 
            },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12, flexWrap: 'wrap' } },
                    h('h3', { style: { margin: 0, fontSize: 16, fontWeight: 700, color: 'var(--text)' } }, day.dayName || dayNames[index]),
                    h('span', { className: 'badge badge-secondary' }, weekDates[index].toLocaleDateString('fr-FR')),
                    h('span', { className: 'badge badge-primary' }, `Base: ${baseHours}h`)
                ),
                h('div', { style: { display: 'flex', gap: 8, alignItems: 'center', flexWrap: 'wrap' } },
                    h('span', { className: 'badge badge-info' }, `Travail: ${minutesToHM(dayTime.work)}`),
                    h('span', { className: 'badge badge-warning' }, `Trajet: ${minutesToHM(dayTime.travel)}`),
                    h('span', { className: 'badge badge-success', style: { fontWeight: 700 } }, `Total: ${minutesToHM(dayTime.total)}`)
                )
            ),
            
            h('div', { className: 'card-body' },
                // Absences
                h('div', { className: 'form-group', style: { marginBottom: 16, paddingBottom: 16, borderBottom: '1px solid var(--border)' } },
                    h('label', { className: 'form-label' }, 'Type de journée'),
                    h('div', { style: { display: 'flex', gap: 20, flexWrap: 'wrap' } },
                        h('label', { className: 'checkbox-label', style: { display: 'flex', alignItems: 'center', gap: 8, cursor: canEdit ? 'pointer' : 'default', padding: '8px 16px', borderRadius: 8, background: day.is_conges ? '#FEF3C7' : 'var(--background)', border: day.is_conges ? '2px solid #F59E0B' : '1px solid var(--border)' } },
                            h('input', { type: 'checkbox', checked: day.is_conges, disabled: !canEdit, onChange: e => { 
                                if (e.target.checked) {
                                    updateDay(index, 'is_conges', true, { is_recuperation: false, is_maladie: false, is_paternite_maternite: false });
                                } else {
                                    updateDay(index, 'is_conges', false);
                                }
                            } }),
                            h('span', null, '🏖️ Congés')
                        ),
                        h('label', { className: 'checkbox-label', style: { display: 'flex', alignItems: 'center', gap: 8, cursor: canEdit ? 'pointer' : 'default', padding: '8px 16px', borderRadius: 8, background: day.is_recuperation ? '#DBEAFE' : 'var(--background)', border: day.is_recuperation ? '2px solid #3B82F6' : '1px solid var(--border)' } },
                            h('input', { type: 'checkbox', checked: day.is_recuperation, disabled: !canEdit, onChange: e => { 
                                if (e.target.checked) {
                                    updateDay(index, 'is_recuperation', true, { is_conges: false, is_maladie: false, is_paternite_maternite: false });
                                } else {
                                    updateDay(index, 'is_recuperation', false);
                                }
                            } }),
                            h('span', null, '🔄 Récup')
                        ),
                        h('label', { className: 'checkbox-label', style: { display: 'flex', alignItems: 'center', gap: 8, cursor: canEdit ? 'pointer' : 'default', padding: '8px 16px', borderRadius: 8, background: day.is_maladie ? '#FEE2E2' : 'var(--background)', border: day.is_maladie ? '2px solid #EF4444' : '1px solid var(--border)' } },
                            h('input', { type: 'checkbox', checked: day.is_maladie, disabled: !canEdit, onChange: e => { 
                                if (e.target.checked) {
                                    updateDay(index, 'is_maladie', true, { is_conges: false, is_recuperation: false, is_paternite_maternite: false });
                                } else {
                                    updateDay(index, 'is_maladie', false);
                                }
                            } }),
                            h('span', null, '🏥 Maladie')
                        ),
                        h('label', { className: 'checkbox-label', style: { display: 'flex', alignItems: 'center', gap: 8, cursor: canEdit ? 'pointer' : 'default', padding: '8px 16px', borderRadius: 8, background: day.is_paternite_maternite ? '#E0E7FF' : 'var(--background)', border: day.is_paternite_maternite ? '2px solid #6366F1' : '1px solid var(--border)' } },
                            h('input', { type: 'checkbox', checked: day.is_paternite_maternite, disabled: !canEdit, onChange: e => { 
                                if (e.target.checked) {
                                    updateDay(index, 'is_paternite_maternite', true, { is_conges: false, is_recuperation: false, is_maladie: false });
                                } else {
                                    updateDay(index, 'is_paternite_maternite', false);
                                }
                            } }),
                            h('span', null, '👶 Pat./Mat.')
                        )
                    )
                ),

                !isAbsent && !isPaterniteMaternite && h(Fragment, null,
                    // TRAJET MATIN
                    h('div', { style: { background: '#EFF6FF', padding: 16, borderRadius: 10, marginBottom: 16 } },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 } },
                            h('span', { style: { fontSize: 18 } }, '🚗'),
                            h('h4', { style: { margin: 0, color: '#1E40AF', fontSize: 14, fontWeight: 600 } }, 'TRAJET ALLER')
                        ),
                        h('div', { className: 'form-row', style: { marginBottom: 0 } },
                            h('div', { className: 'form-group', style: { marginBottom: 12 } },
                                h('label', { className: 'form-label' }, 'Départ de'),
                                h('div', { style: { display: 'flex', gap: 8 } },
                                    h('select', { className: 'form-select', value: day.morning_departure_type, disabled: !canEdit, onChange: e => updateDay(index, 'morning_departure_type', e.target.value), style: { flex: 1 } },
                                        h('option', { value: 'domicile' }, 'Domicile'),
                                        h('option', { value: 'depot' }, 'Dépôt'),
                                        h('option', { value: 'hotel' }, 'Hôtel'),
                                        h('option', { value: 'hotel' }, 'Hôtel')
                                    ),
                                    h('input', { type: 'time', className: 'form-input', value: day.morning_departure_time || '', disabled: !canEdit, onChange: e => updateDay(index, 'morning_departure_time', e.target.value), style: { width: 120 } })
                                )
                            ),
                            h('div', { className: 'form-group', style: { marginBottom: 12 } },
                                h('label', { className: 'form-label' }, 'Arrivée sur site'),
                                h('div', { style: { display: 'flex', gap: 8 } },
                                    h('input', { type: 'text', className: 'form-input', placeholder: 'Lieu / Chantier', value: day.morning_site_location || '', disabled: !canEdit, onChange: e => updateDay(index, 'morning_site_location', e.target.value), style: { flex: 1 } }),
                                    h('input', { type: 'time', className: 'form-input', value: day.morning_arrival_time || '', disabled: !canEdit, onChange: e => updateDay(index, 'morning_arrival_time', e.target.value), style: { width: 120 } })
                                )
                            )
                        )
                    ),

                    // TÂCHES MATIN
                    h('div', { style: { background: '#F0FDF4', padding: 16, borderRadius: 10, marginBottom: 16 } },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                h('span', { style: { fontSize: 18 } }, '🌅'),
                                h('h4', { style: { margin: 0, color: '#166534', fontSize: 14, fontWeight: 600 } }, 'TÂCHES MATIN')
                            ),
                            canEdit && h('button', { type: 'button', className: 'btn btn-success btn-sm', onClick: () => addTask(index, 'morning') }, h(Icon, { name: 'plus', size: 14 }), ' Ajouter')
                        ),
                        h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                            (day.morning_tasks || []).map((task, ti) => 
                                h('div', { key: ti, style: { display: 'flex', gap: 8, alignItems: 'center', background: 'white', padding: 10, borderRadius: 8, border: '1px solid #D1FAE5' } },
                                    h('input', { type: 'text', className: 'form-input', placeholder: 'Chantier / Description de la tâche', value: task.site || '', disabled: !canEdit, onChange: e => updateTask(index, 'morning', ti, 'site', e.target.value), style: { flex: 1 } }),
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 4, flexShrink: 0 } },
                                        h('input', { type: 'time', className: 'form-input', value: task.start_time || '', disabled: !canEdit, onChange: e => updateTask(index, 'morning', ti, 'start_time', e.target.value), style: { width: 100 }, title: 'Heure début' }),
                                        h('span', { style: { color: '#16A34A', fontWeight: 600 } }, '→'),
                                        h('input', { type: 'time', className: 'form-input', value: task.end_time || '', disabled: !canEdit, onChange: e => updateTask(index, 'morning', ti, 'end_time', e.target.value), style: { width: 100 }, title: 'Heure fin' })
                                    ),
                                    canEdit && (day.morning_tasks || []).length > 1 && h('button', { type: 'button', className: 'btn btn-danger btn-sm btn-icon', onClick: () => removeTask(index, 'morning', ti), title: 'Supprimer' }, h(Icon, { name: 'x', size: 14 }))
                                )
                            )
                        )
                    ),

                    // PAUSE
                    h('div', { style: { background: '#FFFBEB', padding: 16, borderRadius: 10, marginBottom: 16 } },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 } },
                            h('span', { style: { fontSize: 18 } }, '🍽️'),
                            h('h4', { style: { margin: 0, color: '#92400E', fontSize: 14, fontWeight: 600 } }, 'PAUSE DÉJEUNER')
                        ),
                        h('div', { className: 'form-row' },
                            h('div', { className: 'form-group', style: { marginBottom: 0 } },
                                h('label', { className: 'form-label' }, 'Type de repas'),
                                h('div', { style: { display: 'flex', gap: 12 } },
                                    h('label', { style: { display: 'flex', alignItems: 'center', gap: 6, cursor: canEdit ? 'pointer' : 'default', padding: '8px 12px', borderRadius: 6, background: day.lunch_type === 'panier' ? '#FEF3C7' : 'white', border: day.lunch_type === 'panier' ? '2px solid #F59E0B' : '1px solid var(--border)' } },
                                        h('input', { type: 'radio', name: `lunch-${index}`, checked: day.lunch_type === 'panier', disabled: !canEdit, onChange: () => updateDay(index, 'lunch_type', 'panier') }),
                                        '🧺 Panier'
                                    ),
                                    h('label', { style: { display: 'flex', alignItems: 'center', gap: 6, cursor: canEdit ? 'pointer' : 'default', padding: '8px 12px', borderRadius: 6, background: day.lunch_type === 'restaurant' ? '#FEF3C7' : 'white', border: day.lunch_type === 'restaurant' ? '2px solid #F59E0B' : '1px solid var(--border)' } },
                                        h('input', { type: 'radio', name: `lunch-${index}`, checked: day.lunch_type === 'restaurant', disabled: !canEdit, onChange: () => updateDay(index, 'lunch_type', 'restaurant') }),
                                        '🍽️ Restaurant'
                                    )
                                )
                            ),
                            h('div', { className: 'form-group', style: { marginBottom: 0 } },
                                h('label', { className: 'form-label' }, 'Horaires'),
                                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                    h('input', { type: 'time', className: 'form-input', value: day.lunch_start_time || '', disabled: !canEdit, onChange: e => updateDay(index, 'lunch_start_time', e.target.value), style: { width: 110 } }),
                                    h('span', { style: { color: '#92400E', fontWeight: 600 } }, '→'),
                                    h('input', { type: 'time', className: 'form-input', value: day.lunch_end_time || '', disabled: !canEdit, onChange: e => updateDay(index, 'lunch_end_time', e.target.value), style: { width: 110 } }),
                                    h('span', { className: 'badge badge-warning' }, `${day.lunch_duration_minutes || 30} min`)
                                )
                            )
                        ),
                        day.lunch_type === 'restaurant' && h('div', { className: 'form-group', style: { marginTop: 12, marginBottom: 0 } },
                            h('label', { className: 'form-label' }, 'Lieu du restaurant'),
                            h('input', { type: 'text', className: 'form-input', placeholder: 'Nom ou adresse du restaurant', value: day.lunch_location || '', disabled: !canEdit, onChange: e => updateDay(index, 'lunch_location', e.target.value) })
                        )
                    ),

                    // TÂCHES APRÈS-MIDI
                    h('div', { style: { background: '#FEF3C7', padding: 16, borderRadius: 10, marginBottom: 16 } },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                h('span', { style: { fontSize: 18 } }, '🌆'),
                                h('h4', { style: { margin: 0, color: '#92400E', fontSize: 14, fontWeight: 600 } }, 'TÂCHES APRÈS-MIDI')
                            ),
                            canEdit && h('button', { type: 'button', className: 'btn btn-warning btn-sm', onClick: () => addTask(index, 'afternoon') }, h(Icon, { name: 'plus', size: 14 }), ' Ajouter')
                        ),
                        h('div', { style: { display: 'flex', flexDirection: 'column', gap: 8 } },
                            (day.afternoon_tasks || []).map((task, ti) => 
                                h('div', { key: ti, style: { display: 'flex', gap: 8, alignItems: 'center', background: 'white', padding: 10, borderRadius: 8, border: '1px solid #FDE68A' } },
                                    h('input', { type: 'text', className: 'form-input', placeholder: 'Chantier / Description de la tâche', value: task.site || '', disabled: !canEdit, onChange: e => updateTask(index, 'afternoon', ti, 'site', e.target.value), style: { flex: 1 } }),
                                    h('div', { style: { display: 'flex', alignItems: 'center', gap: 4, flexShrink: 0 } },
                                        h('input', { type: 'time', className: 'form-input', value: task.start_time || '', disabled: !canEdit, onChange: e => updateTask(index, 'afternoon', ti, 'start_time', e.target.value), style: { width: 100 }, title: 'Heure début' }),
                                        h('span', { style: { color: '#D97706', fontWeight: 600 } }, '→'),
                                        h('input', { type: 'time', className: 'form-input', value: task.end_time || '', disabled: !canEdit, onChange: e => updateTask(index, 'afternoon', ti, 'end_time', e.target.value), style: { width: 100 }, title: 'Heure fin' })
                                    ),
                                    canEdit && (day.afternoon_tasks || []).length > 1 && h('button', { type: 'button', className: 'btn btn-danger btn-sm btn-icon', onClick: () => removeTask(index, 'afternoon', ti), title: 'Supprimer' }, h(Icon, { name: 'x', size: 14 }))
                                )
                            )
                        )
                    ),

                    // TRAJET RETOUR
                    h('div', { style: { background: '#FDF4FF', padding: 16, borderRadius: 10 } },
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, marginBottom: 12 } },
                            h('span', { style: { fontSize: 18 } }, '🚗'),
                            h('h4', { style: { margin: 0, color: '#86198F', fontSize: 14, fontWeight: 600 } }, 'TRAJET RETOUR')
                        ),
                        h('div', { className: 'form-row', style: { marginBottom: 0 } },
                            h('div', { className: 'form-group', style: { marginBottom: 12 } },
                                h('label', { className: 'form-label' }, 'Départ du site'),
                                h('div', { style: { display: 'flex', gap: 8 } },
                                    h('input', { type: 'text', className: 'form-input', placeholder: 'Lieu / Chantier', value: day.afternoon_departure_site || '', disabled: !canEdit, onChange: e => updateDay(index, 'afternoon_departure_site', e.target.value), style: { flex: 1 } }),
                                    h('input', { type: 'time', className: 'form-input', value: day.afternoon_departure_time || '', disabled: !canEdit, onChange: e => updateDay(index, 'afternoon_departure_time', e.target.value), style: { width: 120 } })
                                )
                            ),
                            h('div', { className: 'form-group', style: { marginBottom: 12 } },
                                h('label', { className: 'form-label' }, 'Arrivée à'),
                                h('div', { style: { display: 'flex', gap: 8 } },
                                    h('select', { className: 'form-select', value: day.afternoon_arrival_type, disabled: !canEdit, onChange: e => updateDay(index, 'afternoon_arrival_type', e.target.value), style: { flex: 1 } },
                                        h('option', { value: 'domicile' }, 'Domicile'),
                                        h('option', { value: 'depot' }, 'Dépôt'),
                                        h('option', { value: 'hotel' }, 'Hôtel'),
                                        h('option', { value: 'hotel' }, 'Hôtel')
                                    ),
                                    h('input', { type: 'time', className: 'form-input', value: day.afternoon_arrival_time || '', disabled: !canEdit, onChange: e => updateDay(index, 'afternoon_arrival_time', e.target.value), style: { width: 120 } })
                                )
                            )
                        )
                    )
                ),

                // Message si absent
                isAbsent && h('div', { style: { textAlign: 'center', padding: 20 } },
                    h('div', { style: { fontSize: 48, marginBottom: 8 } }, day.is_conges ? '🏖️' : day.is_recuperation ? '🔄' : '🏥'),
                    h('div', { style: { fontSize: 16, fontWeight: 600, color: '#92400E' } }, 
                        day.is_conges ? 'Journée de congés' : day.is_recuperation ? 'Journée de récupération' : 'Arrêt maladie'
                    )
                ),
                
                isPaterniteMaternite && h('div', { style: { textAlign: 'center', padding: 20 } },
                    h('div', { style: { fontSize: 48, marginBottom: 8 } }, '👶'),
                    h('div', { style: { fontSize: 16, fontWeight: 600, color: '#4F46E5' } }, 'Congé paternité / maternité'),
                    h('div', { style: { fontSize: 14, color: '#6366F1', marginTop: 8 } }, 
                        `${baseHours}h comptabilisées (pas de déduction congés/RTT)`
                    )
                )
            )
        );
    };

    // Modal ajustement
    const AdjustmentModal = () => {
        const [adjType, setAdjType] = useState('recup');
        const [adjAmount, setAdjAmount] = useState('');
        const [adjReason, setAdjReason] = useState('paiement');
        const [adjDesc, setAdjDesc] = useState('');

        return h(Modal, { isOpen: true, onClose: () => setShowAdjustmentModal(false), title: '💰 Ajustement compteur', size: 'md',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => setShowAdjustmentModal(false) }, 'Annuler'),
                h('button', { className: 'btn btn-primary', onClick: () => addAdjustment(adjType, parseFloat(adjAmount), adjReason, adjDesc) }, 'Enregistrer')
            )
        },
            h('div', null,
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Type'),
                    h('select', { className: 'form-select', value: adjType, onChange: e => setAdjType(e.target.value) },
                        h('option', { value: 'recup' }, 'Récup (heures)'),
                        h('option', { value: 'conges' }, 'Congés (jours)')
                    )
                ),
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, adjType === 'recup' ? 'Montant (heures) - Négatif pour retirer' : 'Montant (jours) - Négatif pour retirer'),
                    h('input', { type: 'number', step: '0.5', className: 'form-input', value: adjAmount, onChange: e => setAdjAmount(e.target.value), placeholder: adjType === 'recup' ? 'Ex: -8 pour retirer 8h' : 'Ex: -2 pour retirer 2 jours' })
                ),
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Motif'),
                    h('select', { className: 'form-select', value: adjReason, onChange: e => setAdjReason(e.target.value) },
                        h('option', { value: 'paiement' }, 'Paiement (récup payées)'),
                        h('option', { value: 'correction' }, 'Correction'),
                        h('option', { value: 'report' }, 'Report manuel'),
                        h('option', { value: 'autre' }, 'Autre')
                    )
                ),
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Description'),
                    h('input', { type: 'text', className: 'form-input', value: adjDesc, onChange: e => setAdjDesc(e.target.value), placeholder: 'Ex: Paiement décembre 2024' })
                ),
                h('div', { style: { background: '#FEF3C7', padding: 12, borderRadius: 8, marginTop: 16 } },
                    h('div', { style: { fontSize: 12 } }, '⚠️ Un montant négatif retire des jours (ex: récup payées). Un montant positif ajoute des jours.')
                )
            )
        );
    };

    // Rendu principal
    return h('div', null,
        // En-tête
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' },
                h('h1', { className: 'page-title' }, '📋 Feuilles d\'heures'),
                h('p', { className: 'page-subtitle' }, `Semaine ${selectedWeek.week} - ${selectedWeek.year}`)
            ),
            h('div', { className: 'page-actions' },
                h('button', { className: `btn ${viewMode === 'edit' ? 'btn-primary' : 'btn-secondary'}`, onClick: () => setViewMode('edit') }, 'Saisie'),
                h('button', { className: `btn ${viewMode === 'list' ? 'btn-primary' : 'btn-secondary'}`, onClick: () => setViewMode('list') }, '📋 Liste'),
                h('button', { className: `btn ${viewMode === 'history' ? 'btn-primary' : 'btn-secondary'}`, onClick: () => setViewMode('history') }, 'Historique'),
                h('button', { className: `btn ${viewMode === 'admin' ? 'btn-primary' : 'btn-secondary'}`, onClick: () => setViewMode('admin') }, '📊 Compteurs'),
                h('button', { className: 'btn btn-secondary', onClick: exportPDF }, h(Icon, { name: 'download', size: 18 }), 'PDF'),
                canEdit && h('button', { className: 'btn btn-secondary', onClick: saveTimesheet }, h(Icon, { name: 'check', size: 18 }), 'Sauvegarder'),
                canEdit && timesheet?.status !== 'valide' && h('button', { className: 'btn btn-success', onClick: () => setShowValidateConfirm(true) }, '✓ Valider'),
                isAdmin && timesheet?.status === 'valide' && h('button', { className: 'btn btn-warning', onClick: unlockTimesheet }, h(Icon, { name: 'edit', size: 18 }), 'Déverrouiller')
            )
        ),

        // Sélecteur utilisateur (si permission)
        canViewAllTimesheets && h('div', { className: 'card', style: { marginBottom: 16 } },
            h('div', { className: 'card-body', style: { display: 'flex', gap: 16, alignItems: 'center' } },
                h('span', { style: { fontWeight: 500 } }, '👤 Technicien:'),
                h('select', { className: 'form-select', style: { maxWidth: 300 }, value: selectedUser?.id || '', onChange: e => {
                    const u = allUsers.find(u => u.id === e.target.value);
                    setSelectedUser(u || null);
                }},
                    h('option', { value: '' }, `${user.first_name || ''} ${user.last_name || user.email} (moi)`),
                    allUsers.filter(u => u.id !== user.id).map(u => h('option', { key: u.id, value: u.id }, `${u.first_name || ''} ${u.last_name || u.email}`))
                )
            )
        ),

        // Badge statut
        timesheet && h('div', { style: { marginBottom: 16 } },
            h('span', { className: `badge badge-${timesheet.status === 'valide' ? 'success' : timesheet.status === 'deverrouille' ? 'warning' : 'secondary'}`, style: { fontSize: 13, padding: '6px 12px' } },
                timesheet.status === 'valide' ? '✓ Validée' : timesheet.status === 'deverrouille' ? '🔓 Déverrouillée' : '📝 Brouillon'
            ),
            timesheet.validated_at && h('span', { style: { marginLeft: 10, fontSize: 12, color: COLORS.muted } }, `Validée le ${new Date(timesheet.validated_at).toLocaleDateString('fr-FR')}`)
        ),

        viewMode === 'edit' ? h(Fragment, null,
            // Sélecteur semaine + totaux
            h('div', { className: 'card', style: { marginBottom: 20 } },
                h('div', { className: 'card-body', style: { display: 'flex', alignItems: 'center', gap: 16, flexWrap: 'wrap' } },
                    h('button', { className: 'btn btn-secondary btn-sm', onClick: goToPreviousWeek }, '← Précédente'),
                    h('div', { style: { textAlign: 'center', minWidth: 200 } },
                        h('div', { style: { fontWeight: 700, fontSize: 20 } }, `Semaine ${selectedWeek.week}`),
                        h('div', { style: { color: COLORS.muted, fontSize: 13 } }, `${weekDates[0].toLocaleDateString('fr-FR')} - ${weekDates[6].toLocaleDateString('fr-FR')}`)
                    ),
                    h('button', { className: 'btn btn-secondary btn-sm', onClick: goToNextWeek }, 'Suivante →'),
                    
                    h('div', { style: { marginLeft: 'auto', display: 'flex', gap: 12, flexWrap: 'wrap' } },
                        h('div', { style: { textAlign: 'center', padding: '10px 20px', background: '#DBEAFE', borderRadius: 10 } },
                            h('div', { style: { fontSize: 11, color: '#1E40AF', fontWeight: 500 } }, 'TRAVAIL'),
                            h('div', { style: { fontSize: 20, fontWeight: 700, color: '#1E40AF' } }, minutesToHM(weekTotals.work))
                        ),
                        h('div', { style: { textAlign: 'center', padding: '10px 20px', background: '#FEF3C7', borderRadius: 10 } },
                            h('div', { style: { fontSize: 11, color: '#92400E', fontWeight: 500 } }, 'TRAJET'),
                            h('div', { style: { fontSize: 20, fontWeight: 700, color: '#92400E' } }, minutesToHM(weekTotals.travel))
                        ),
                        h('div', { style: { textAlign: 'center', padding: '10px 20px', background: '#DCFCE7', borderRadius: 10 } },
                            h('div', { style: { fontSize: 11, color: '#16A34A', fontWeight: 500 } }, 'TOTAL'),
                            h('div', { style: { fontSize: 20, fontWeight: 700, color: '#16A34A' } }, minutesToHM(weekTotals.total))
                        ),
                        weekTotals.nightWork > 0 && h('div', { style: { textAlign: 'center', padding: '10px 20px', background: '#312E81', borderRadius: 10 } },
                            h('div', { style: { fontSize: 11, color: '#C7D2FE', fontWeight: 500 } }, '🌙 NUIT (22h-6h)'),
                            h('div', { style: { fontSize: 20, fontWeight: 700, color: '#fff' } }, minutesToHM(weekTotals.nightWork)),
                            h('div', { style: { fontSize: 9, color: '#A5B4FC' } }, 'payé, hors RTT')
                        ),
                        weekTotals.saturdayMinutes > 0 && h('div', { style: { textAlign: 'center', padding: '10px 20px', background: '#E0E7FF', borderRadius: 10 } },
                            h('div', { style: { fontSize: 11, color: '#4F46E5', fontWeight: 500 } }, 'SAMEDI → RÉCUP'),
                            h('div', { style: { fontSize: 20, fontWeight: 700, color: '#4F46E5' } }, minutesToHM(weekTotals.saturdayMinutes))
                        )
                    )
                )
            ),

            // Soldes
            h('div', { className: 'card', style: { marginBottom: 20 } },
                h('div', { className: 'card-body' },
                    h('div', { style: { fontWeight: 600, marginBottom: 12, fontSize: 14 } }, 
                        '📊 Soldes année ' + leaveYear + ' ',
                        h('span', { style: { fontSize: 11, color: COLORS.muted, fontWeight: 400 } }, `(1er juin ${leaveYear - 1} - 31 mai ${leaveYear})`)
                    ),
                    h('div', { style: { display: 'flex', gap: 20, flexWrap: 'wrap' } },
                        h('div', { style: { padding: '8px 16px', background: '#FEF3C7', borderRadius: 8 } },
                            h('span', { style: { fontSize: 12 } }, '🏖️ Congés: '),
                            h('strong', null, leaveBalances.conges_solde?.toFixed(1) || 0, ' jours'),
                            h('span', { style: { fontSize: 10, color: COLORS.muted, marginLeft: 8 } }, `(Init: ${leaveBalances.conges_initial || 0} + Report: ${leaveBalances.conges_report?.toFixed(1) || 0} + Acquis: ${leaveBalances.conges_acquis || 0} - Pris: ${leaveBalances.conges_pris?.toFixed(1) || 0})`)
                        ),
                        h('div', { style: { padding: '8px 16px', background: '#E0E7FF', borderRadius: 8 } },
                            h('span', { style: { fontSize: 12 } }, '🔄 Récup: '),
                            h('strong', null, (leaveBalances.recup_solde || 0).toFixed(1), ' heures'),
                            h('span', { style: { fontSize: 10, color: COLORS.muted, marginLeft: 8 } }, `(Init: ${leaveBalances.recup_initial || 0}h + Report: ${(leaveBalances.recup_report || 0).toFixed(1)}h + Samedi: ${(leaveBalances.recup_acquis || 0).toFixed(1)}h - Pris: ${(leaveBalances.recup_pris || 0).toFixed(1)}h + Ajust: ${(leaveBalances.recup_ajustements || 0).toFixed(1)}h)`)
                        ),
                        // Heures de nuit (payées, hors RTT)
                        weekTotals.nightWork > 0 && h('div', { style: { padding: '8px 16px', background: '#312E81', borderRadius: 8, color: '#fff' } },
                            h('span', { style: { fontSize: 12 } }, '🌙 Heures nuit (22h-6h): '),
                            h('strong', null, minutesToHM(weekTotals.nightWork)),
                            h('span', { style: { fontSize: 10, marginLeft: 8, opacity: 0.8 } }, '(payées, hors RTT)')
                        )
                    )
                )
            ),

            // Jours - Titre + cards individuelles
            h('div', { style: { marginBottom: 20 } },
                h('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: 16 } },
                    h('h2', { style: { margin: 0, fontSize: 18, fontWeight: 700, color: 'var(--text)' } }, '📅 Détail par jour'),
                    h('div', { style: { display: 'flex', gap: 8 } },
                        h('span', { className: 'badge badge-info' }, 'Lun-Jeu: 8h'),
                        h('span', { className: 'badge badge-primary' }, 'Ven: 7h')
                    )
                ),
                loading ? h('div', { className: 'card', style: { textAlign: 'center', padding: 40 } }, 'Chargement...') :
                days.map((day, i) => renderDayRow(day, i))
            ),

            // Astreintes
            h('div', { className: 'card', style: { marginBottom: 20 } },
                h('div', { className: 'card-body' },
                    h('div', { style: { fontWeight: 600, marginBottom: 16, fontSize: 16 } }, '🚨 Astreintes'),
                    h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 12 } },
                        [
                            { key: 'semaine', label: 'Astreinte Semaine', icon: '📅' },
                            { key: 'weekend', label: 'Astreinte Week-end', icon: '🏠' },
                            { key: 'ferie', label: 'Astreinte Jour Férié', icon: '🎉' },
                            { key: 'soutien', label: 'Astreinte Soutien', icon: '🤝' }
                        ].map(({ key, label, icon }) =>
                            h('label', { key, style: { display: 'flex', alignItems: 'center', gap: 10, padding: 14, borderRadius: 10, background: oncalls[key] ? '#DCFCE7' : '#F8FAFC', border: '2px solid ' + (oncalls[key] ? '#10B981' : 'transparent'), cursor: canEdit ? 'pointer' : 'default' } },
                                h('input', { type: 'checkbox', checked: oncalls[key], disabled: !canEdit, onChange: e => setOncalls(p => ({ ...p, [key]: e.target.checked })) }),
                                h('span', null, icon, ' ', label)
                            )
                        )
                    )
                )
            ),

            // Interventions
            (oncalls.semaine || oncalls.weekend || oncalls.ferie || oncalls.soutien) && h('div', { className: 'card', style: { marginBottom: 20 } },
                h('div', { className: 'card-body' },
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 } },
                        h('div', null,
                            h('div', { style: { fontWeight: 600, fontSize: 16 } }, '🔧 Interventions'),
                            h('div', { style: { fontSize: 12, color: COLORS.muted } }, '⚠️ Seules les interventions du SAMEDI génèrent des récup')
                        ),
                        canEdit && h('button', { className: 'btn btn-primary btn-sm', onClick: addIntervention }, h(Icon, { name: 'plus', size: 16 }), 'Ajouter')
                    ),
                    interventions.length === 0 ?
                        h('div', { style: { textAlign: 'center', padding: 30, color: COLORS.muted } }, 'Aucune intervention cette semaine') :
                        h('div', { className: 'table-container' },
                            h('table', { className: 'table' },
                                h('thead', null, h('tr', null,
                                    h('th', null, 'Date'), h('th', null, 'Heure'), h('th', null, 'N° AC'),
                                    h('th', null, 'Lieu'), h('th', null, 'Motif'), h('th', null, 'Temps site'),
                                    h('th', null, 'Trajet'), h('th', null, 'Samedi?'), h('th', null, '')
                                )),
                                h('tbody', null, interventions.map((inter, i) => {
                                    const interDate = inter.intervention_date ? new Date(inter.intervention_date) : null;
                                    const isSaturday = interDate?.getDay() === 6;
                                    return h('tr', { key: i, style: { background: isSaturday ? '#DCFCE7' : 'transparent' } },
                                        h('td', null, h('input', { type: 'date', value: inter.intervention_date || '', disabled: !canEdit, onChange: e => { const n = [...interventions]; n[i].intervention_date = e.target.value; n[i].is_saturday = new Date(e.target.value).getDay() === 6; setInterventions(n); }, className: 'form-input', style: { width: 130 } })),
                                        h('td', null, h('input', { type: 'time', value: inter.intervention_time || '', disabled: !canEdit, onChange: e => { const n = [...interventions]; n[i].intervention_time = e.target.value; setInterventions(n); }, className: 'form-input', style: { width: 90 } })),
                                        h('td', null, h('input', { type: 'text', value: inter.ac_number || '', disabled: !canEdit, onChange: e => { const n = [...interventions]; n[i].ac_number = e.target.value; setInterventions(n); }, className: 'form-input', style: { width: 80 } })),
                                        h('td', null, h('input', { type: 'text', value: inter.location || '', disabled: !canEdit, onChange: e => { const n = [...interventions]; n[i].location = e.target.value; setInterventions(n); }, className: 'form-input', style: { width: 120 } })),
                                        h('td', null, h('input', { type: 'text', value: inter.reason || '', disabled: !canEdit, onChange: e => { const n = [...interventions]; n[i].reason = e.target.value; setInterventions(n); }, className: 'form-input', style: { width: 120 } })),
                                        h('td', null, h('input', { type: 'number', value: inter.time_on_site_minutes || '', disabled: !canEdit, onChange: e => { const n = [...interventions]; n[i].time_on_site_minutes = e.target.value; setInterventions(n); }, className: 'form-input', placeholder: 'min', style: { width: 70 } })),
                                        h('td', null, h('input', { type: 'number', value: inter.travel_time_minutes || '', disabled: !canEdit, onChange: e => { const n = [...interventions]; n[i].travel_time_minutes = e.target.value; setInterventions(n); }, className: 'form-input', placeholder: 'min', style: { width: 70 } })),
                                        h('td', null, isSaturday ? h('span', { className: 'badge badge-success' }, '✓ SAMEDI') : h('span', { className: 'badge badge-secondary' }, 'Non')),
                                        h('td', null, canEdit && h('button', { className: 'btn btn-danger btn-sm', onClick: () => setInterventions(interventions.filter((_, idx) => idx !== i)) }, h(Icon, { name: 'trash', size: 14 })))
                                    );
                                }))
                            )
                        )
                )
            )
        ) : viewMode === 'history' ? 
        // Vue historique
        h('div', { className: 'card' },
            h('div', { className: 'card-body' },
                h('div', { style: { fontWeight: 600, marginBottom: 16, fontSize: 16 } }, '📜 Historique des feuilles'),
                allTimesheets.length === 0 ?
                    h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune feuille') :
                    h('div', { className: 'table-container' },
                        h('table', { className: 'table' },
                            h('thead', null, h('tr', null,
                                h('th', null, 'Semaine'), h('th', null, 'Période'), h('th', null, 'Travail'),
                                h('th', null, 'Trajet'), h('th', null, 'Total'), h('th', null, 'Statut'), h('th', null, 'Actions')
                            )),
                            h('tbody', null, allTimesheets.map(ts =>
                                h('tr', { key: ts.id, style: { cursor: 'pointer' }, onClick: () => { setSelectedWeek({ week: ts.week_number, year: ts.year }); setViewMode('edit'); } },
                                    h('td', null, h('strong', null, `S${ts.week_number}`), h('span', { style: { color: COLORS.muted, marginLeft: 4 } }, ts.year)),
                                    h('td', { style: { fontSize: 13 } }, `${new Date(ts.week_start).toLocaleDateString('fr-FR')} - ${new Date(ts.week_end).toLocaleDateString('fr-FR')}`),
                                    h('td', null, minutesToHM(ts.total_work_minutes || 0)),
                                    h('td', null, minutesToHM(ts.total_travel_minutes || 0)),
                                    h('td', { style: { fontWeight: 600 } }, minutesToHM(ts.total_minutes || 0)),
                                    h('td', null, h('span', { className: `badge badge-${ts.status === 'valide' ? 'success' : ts.status === 'deverrouille' ? 'warning' : 'secondary'}` }, ts.status === 'valide' ? 'Validée' : ts.status === 'deverrouille' ? 'Déverrouillée' : 'Brouillon')),
                                    h('td', null, h('button', { className: 'btn btn-secondary btn-sm', onClick: e => { e.stopPropagation(); setSelectedWeek({ week: ts.week_number, year: ts.year }); setViewMode('edit'); } }, 'Voir'))
                                )
                            ))
                        )
                    )
            )
        ) : viewMode === 'list' ?
        // v5.8 - Vue Liste compacte
        h('div', { className: 'card' },
            h('div', { className: 'card-header' },
                h('div', { style: { fontWeight: 600, fontSize: 16 } }, '📋 Liste des feuilles d\'heures'),
                h('span', { style: { marginLeft: 'auto', color: COLORS.muted } }, allTimesheets.length, ' feuilles')
            ),
            h('div', { className: 'card-body', style: { padding: 0 } },
                allTimesheets.length === 0 ?
                    h('div', { style: { textAlign: 'center', padding: 40, color: COLORS.muted } }, 'Aucune feuille') :
                    h('div', { className: 'table-container', style: { overflowX: 'auto' } },
                        h('table', { className: 'table', style: { margin: 0 } },
                            h('thead', null, h('tr', null,
                                h('th', { style: { width: 100 } }, 'Semaine'),
                                h('th', { style: { width: 180 } }, 'Période'),
                                h('th', { style: { width: 100, textAlign: 'center' } }, 'Travail'),
                                h('th', { style: { width: 100, textAlign: 'center' } }, 'Trajet'),
                                h('th', { style: { width: 100, textAlign: 'center' } }, 'Total'),
                                h('th', { style: { width: 80, textAlign: 'center' } }, 'RTT'),
                                h('th', { style: { width: 80, textAlign: 'center' } }, 'Récup'),
                                h('th', { style: { width: 110 } }, 'Statut'),
                                h('th', { style: { width: 100 } }, 'Actions')
                            )),
                            h('tbody', null, allTimesheets.map(ts => {
                                const rttMinutes = (ts.total_work_minutes || 0) + (ts.total_travel_minutes || 0) - (39 * 60);
                                const recupMinutes = ts.total_saturday_minutes || 0;
                                return h('tr', { key: ts.id, style: { cursor: 'pointer' }, onClick: () => { setSelectedWeek({ week: ts.week_number, year: ts.year }); setViewMode('edit'); } },
                                    h('td', null, 
                                        h('div', { style: { fontWeight: 700, fontSize: 16, color: COLORS.primary } }, `S${ts.week_number}`),
                                        h('div', { style: { fontSize: 11, color: COLORS.muted } }, ts.year)
                                    ),
                                    h('td', null, 
                                        h('div', { style: { fontSize: 13 } }, new Date(ts.week_start).toLocaleDateString('fr-FR')),
                                        h('div', { style: { fontSize: 11, color: COLORS.muted } }, 'au ' + new Date(ts.week_end).toLocaleDateString('fr-FR'))
                                    ),
                                    h('td', { style: { textAlign: 'center', fontWeight: 500 } }, minutesToHM(ts.total_work_minutes || 0)),
                                    h('td', { style: { textAlign: 'center', color: COLORS.muted } }, minutesToHM(ts.total_travel_minutes || 0)),
                                    h('td', { style: { textAlign: 'center', fontWeight: 700, fontSize: 15, color: rttMinutes > 0 ? COLORS.success : COLORS.danger } }, minutesToHM(ts.total_minutes || 0)),
                                    h('td', { style: { textAlign: 'center' } }, 
                                        rttMinutes !== 0 && h('span', { 
                                            style: { 
                                                fontSize: 12, 
                                                padding: '2px 6px', 
                                                borderRadius: 4, 
                                                background: rttMinutes > 0 ? '#DCFCE7' : '#FEE2E2', 
                                                color: rttMinutes > 0 ? '#16A34A' : '#DC2626' 
                                            } 
                                        }, rttMinutes > 0 ? '+' + minutesToHM(rttMinutes) : minutesToHM(rttMinutes))
                                    ),
                                    h('td', { style: { textAlign: 'center' } },
                                        recupMinutes > 0 && h('span', { style: { fontSize: 12, padding: '2px 6px', borderRadius: 4, background: '#E0E7FF', color: '#4F46E5' } }, '+' + minutesToHM(recupMinutes))
                                    ),
                                    h('td', null, 
                                        h('span', { className: `badge badge-${ts.status === 'valide' ? 'success' : ts.status === 'deverrouille' ? 'warning' : 'secondary'}` }, 
                                            ts.status === 'valide' ? '✓ Validée' : ts.status === 'deverrouille' ? '🔓 Déverr.' : '📝 Brouillon'
                                        )
                                    ),
                                    h('td', null, 
                                        h('button', { 
                                            className: 'btn btn-sm btn-primary', 
                                            onClick: e => { e.stopPropagation(); setSelectedWeek({ week: ts.week_number, year: ts.year }); setViewMode('edit'); } 
                                        }, 'Ouvrir')
                                    )
                                );
                            }))
                        )
                    )
            )
        ) :
        // Vue compteurs (accessible à tous)
        h('div', { className: 'card' },
            h('div', { className: 'card-body' },
                h('div', { style: { fontWeight: 600, marginBottom: 16, fontSize: 16 } }, '📊 Gestion des compteurs'),
                
                // Info calcul congés
                h('div', { style: { background: '#DBEAFE', padding: 12, borderRadius: 8, marginBottom: 16, fontSize: 13 } },
                    h('strong', null, 'ℹ️ Congés payés : '),
                    'Acquisition de 2.08 jours par mois travaillé (25 jours/an)'
                ),
                
                // Compteurs initiaux
                h('div', { style: { background: leaveBalances.initial_locked ? '#FEF3C7' : '#F8FAFC', padding: 16, borderRadius: 10, marginBottom: 20, border: leaveBalances.initial_locked ? '2px solid #F59E0B' : 'none' } },
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12, flexWrap: 'wrap', gap: 8 } },
                        h('div', { style: { fontWeight: 600 } }, 
                            '📊 Compteurs initiaux année ' + leaveYear + ' ',
                            h('span', { style: { fontSize: 11, color: COLORS.muted, fontWeight: 400 } }, `(1er juin ${leaveYear - 1} - 31 mai ${leaveYear})`)
                        ),
                        leaveBalances.initial_locked ? 
                            h('span', { className: 'badge badge-warning', style: { fontSize: 12 } }, '🔒 Verrouillé') :
                            h('span', { className: 'badge badge-secondary', style: { fontSize: 12 } }, '🔓 Non verrouillé')
                    ),
                    
                    // Message si verrouillé
                    leaveBalances.initial_locked && !isAdmin && h('div', { style: { background: '#FEE2E2', padding: 10, borderRadius: 6, marginBottom: 12, fontSize: 12, color: '#DC2626' } },
                        '⚠️ Les compteurs initiaux sont verrouillés et ne peuvent plus être modifiés. Contactez un administrateur si une correction est nécessaire.'
                    ),
                    
                    h('div', { style: { display: 'flex', gap: 16, flexWrap: 'wrap', alignItems: 'flex-end' } },
                        h('div', null,
                            h('label', { style: { fontSize: 12, display: 'block', marginBottom: 4 } }, 'Congés initial (jours)'),
                            h('input', { 
                                type: 'number', 
                                step: '0.5', 
                                id: 'congesInit', 
                                defaultValue: leaveBalances.conges_initial || 0, 
                                disabled: leaveBalances.initial_locked && !isAdmin,
                                className: 'form-input', 
                                style: { width: 100, background: (leaveBalances.initial_locked && !isAdmin) ? '#E5E7EB' : 'white' } 
                            })
                        ),
                        h('div', null,
                            h('label', { style: { fontSize: 12, display: 'block', marginBottom: 4 } }, 'Mois travaillés'),
                            h('input', { 
                                type: 'number', 
                                step: '1', 
                                min: '0', 
                                max: '12', 
                                id: 'moisTravailles', 
                                defaultValue: Math.round((leaveBalances.conges_acquis || 0) / 2.08), 
                                disabled: leaveBalances.initial_locked && !isAdmin,
                                className: 'form-input', 
                                style: { width: 80, background: (leaveBalances.initial_locked && !isAdmin) ? '#E5E7EB' : 'white' } 
                            })
                        ),
                        h('div', null,
                            h('label', { style: { fontSize: 12, display: 'block', marginBottom: 4, color: COLORS.muted } }, 'Congés acquis'),
                            h('span', { style: { display: 'block', padding: '8px 12px', background: '#E0E7FF', borderRadius: 6, fontWeight: 600 }, id: 'congesAcquisDisplay' }, 
                                ((leaveBalances.conges_acquis || 0)).toFixed(2) + ' j'
                            )
                        ),
                        h('div', null,
                            h('label', { style: { fontSize: 12, display: 'block', marginBottom: 4 } }, 'Récup initial (heures)'),
                            h('input', { 
                                type: 'number', 
                                step: '0.5', 
                                id: 'recupInit', 
                                defaultValue: leaveBalances.recup_initial || 0, 
                                disabled: leaveBalances.initial_locked && !isAdmin,
                                className: 'form-input', 
                                style: { width: 100, background: (leaveBalances.initial_locked && !isAdmin) ? '#E5E7EB' : 'white' } 
                            })
                        ),
                        // Bouton Enregistrer (visible si non verrouillé ou admin)
                        (!leaveBalances.initial_locked || isAdmin) && h('button', { className: 'btn btn-primary', onClick: () => {
                            const ci = parseFloat(document.getElementById('congesInit').value) || 0;
                            const mois = parseInt(document.getElementById('moisTravailles').value) || 0;
                            const ca = mois * 2.08;
                            const ri = parseFloat(document.getElementById('recupInit').value) || 0;
                            setInitialBalances(ci, ri, ca);
                        }}, 'Enregistrer'),
                        // Bouton Valider définitivement (visible si non verrouillé)
                        !leaveBalances.initial_locked && h('button', { className: 'btn btn-success', onClick: () => setShowLockConfirm(true) }, '🔒 Valider définitivement'),
                        // Bouton Déverrouiller (visible si verrouillé et admin)
                        leaveBalances.initial_locked && isAdmin && h('button', { className: 'btn btn-warning', onClick: unlockInitialBalances }, '🔓 Déverrouiller')
                    ),
                    !leaveBalances.initial_locked && h('div', { style: { marginTop: 12, fontSize: 11, color: COLORS.muted } },
                        '💡 Entrez le nombre de mois travaillés pour calculer automatiquement les congés acquis (× 2.08j)'
                    ),
                    leaveBalances.initial_locked && leaveBalances.initial_locked_at && h('div', { style: { marginTop: 12, fontSize: 11, color: '#92400E' } },
                        `🔒 Verrouillé le ${new Date(leaveBalances.initial_locked_at).toLocaleDateString('fr-FR')}`
                    )
                ),

                // Récapitulatif des soldes
                h('div', { style: { background: '#F0FDF4', padding: 16, borderRadius: 10, marginBottom: 20 } },
                    h('div', { style: { fontWeight: 600, marginBottom: 12 } }, '📈 Récapitulatif des soldes'),
                    h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 12 } },
                        h('div', { style: { background: 'white', padding: 12, borderRadius: 8, border: '1px solid #D1D5DB' } },
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, '🏖️ CONGÉS (jours)'),
                            h('div', { style: { fontSize: 11, marginBottom: 4 } }, `Initial: ${leaveBalances.conges_initial || 0}j`),
                            h('div', { style: { fontSize: 11, marginBottom: 4 } }, `Report N-1: ${(leaveBalances.conges_report || 0).toFixed(1)}j`),
                            h('div', { style: { fontSize: 11, marginBottom: 4 } }, `Acquis: ${(leaveBalances.conges_acquis || 0).toFixed(2)}j`),
                            h('div', { style: { fontSize: 11, marginBottom: 4, color: '#DC2626' } }, `Pris: -${(leaveBalances.conges_pris || 0).toFixed(1)}j`),
                            h('div', { style: { fontSize: 14, fontWeight: 700, color: '#16A34A', borderTop: '1px solid #E5E7EB', paddingTop: 8, marginTop: 8 } }, 
                                `Solde: ${(leaveBalances.conges_solde || 0).toFixed(1)} jours`
                            )
                        ),
                        h('div', { style: { background: 'white', padding: 12, borderRadius: 8, border: '1px solid #D1D5DB' } },
                            h('div', { style: { fontSize: 12, color: COLORS.muted, marginBottom: 4 } }, '🔄 RÉCUP (heures)'),
                            h('div', { style: { fontSize: 11, marginBottom: 4 } }, `Initial: ${leaveBalances.recup_initial || 0}h`),
                            h('div', { style: { fontSize: 11, marginBottom: 4 } }, `Report N-1: ${(leaveBalances.recup_report || 0).toFixed(1)}h`),
                            h('div', { style: { fontSize: 11, marginBottom: 4 } }, `Samedi astreinte: ${(leaveBalances.recup_acquis || 0).toFixed(1)}h`),
                            h('div', { style: { fontSize: 11, marginBottom: 4, color: '#DC2626' } }, `Pris: -${(leaveBalances.recup_pris || 0).toFixed(1)}h`),
                            h('div', { style: { fontSize: 11, marginBottom: 4, color: leaveBalances.recup_ajustements < 0 ? '#DC2626' : '#16A34A' } }, 
                                `Ajustements: ${(leaveBalances.recup_ajustements || 0) >= 0 ? '+' : ''}${(leaveBalances.recup_ajustements || 0).toFixed(1)}h`
                            ),
                            h('div', { style: { fontSize: 14, fontWeight: 700, color: '#4F46E5', borderTop: '1px solid #E5E7EB', paddingTop: 8, marginTop: 8 } }, 
                                `Solde: ${(leaveBalances.recup_solde || 0).toFixed(1)} heures`
                            )
                        )
                    )
                ),

                // Ajustements
                h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 } },
                    h('div', null,
                        h('div', { style: { fontWeight: 600 } }, '💰 Ajustements'),
                        h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Récup payées, corrections, etc.')
                    ),
                    h('button', { className: 'btn btn-primary btn-sm', onClick: () => setShowAdjustmentModal(true) }, h(Icon, { name: 'plus', size: 16 }), 'Nouvel ajustement')
                ),
                adjustments.length === 0 ?
                    h('div', { style: { textAlign: 'center', padding: 20, color: COLORS.muted } }, 'Aucun ajustement enregistré') :
                    h('div', { className: 'table-container' },
                        h('table', { className: 'table' },
                            h('thead', null, h('tr', null,
                                h('th', null, 'Date'), h('th', null, 'Type'), h('th', null, 'Montant'),
                                h('th', null, 'Motif'), h('th', null, 'Description')
                            )),
                            h('tbody', null, adjustments.map(adj =>
                                h('tr', { key: adj.id },
                                    h('td', null, new Date(adj.created_at).toLocaleDateString('fr-FR')),
                                    h('td', null, h('span', { className: `badge badge-${adj.adjustment_type === 'recup' ? 'info' : 'warning'}` }, adj.adjustment_type === 'recup' ? 'Récup' : 'Congés')),
                                    h('td', { style: { fontWeight: 600, color: adj.amount < 0 ? '#DC2626' : '#16A34A' } }, `${adj.amount > 0 ? '+' : ''}${adj.amount}${adj.adjustment_type === 'recup' ? 'h' : 'j'}`),
                                    h('td', null, adj.reason === 'paiement' ? '💰 Paiement' : adj.reason === 'correction' ? '✏️ Correction' : adj.reason === 'initial' ? '📊 Initial' : adj.reason === 'verrouillage' ? '🔒 Verrouillage' : adj.reason === 'deverrouillage' ? '🔓 Déverrouillage' : adj.reason),
                                    h('td', { style: { color: COLORS.muted, fontSize: 13 } }, adj.description || '-')
                                )
                            ))
                        )
                    )
            )
        ),

        // Modal validation
        showValidateConfirm && h(Modal, { isOpen: true, onClose: () => setShowValidateConfirm(false), title: '⚠️ Confirmer la validation', size: 'md',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => setShowValidateConfirm(false) }, 'Annuler'),
                h('button', { className: 'btn btn-success', onClick: validateTimesheet }, '✓ Confirmer la validation')
            )
        },
            h('div', { style: { textAlign: 'center', padding: 20 } },
                h('div', { style: { fontSize: 48, marginBottom: 16 } }, '⚠️'),
                h('h3', { style: { marginBottom: 16 } }, 'Êtes-vous sûr de vouloir valider cette feuille ?'),
                h('p', { style: { color: COLORS.muted, marginBottom: 20 } }, 
                    'Une fois validée, vous ne pourrez plus modifier cette feuille d\'heures. ',
                    h('strong', null, 'Seul un administrateur pourra la déverrouiller.')
                ),
                h('div', { style: { background: '#FEF3C7', padding: 16, borderRadius: 10, textAlign: 'left' } },
                    h('div', { style: { fontWeight: 600, marginBottom: 8 } }, 'Récapitulatif :'),
                    h('div', null, `• Travail : ${minutesToHM(weekTotals.work)}`),
                    h('div', null, `• Trajet : ${minutesToHM(weekTotals.travel)}`),
                    h('div', null, `• Total : ${minutesToHM(weekTotals.total)}`),
                    weekTotals.conges > 0 && h('div', null, `• Congés : ${weekTotals.conges} jour(s)`),
                    weekTotals.paterniteMaternite > 0 && h('div', { style: { color: '#4F46E5' } }, `• Congé pat./mat. : ${weekTotals.paterniteMaternite} jour(s)`),
                    weekTotals.recupMinutes > 0 && h('div', null, `• Récup pris : ${minutesToHM(weekTotals.recupMinutes)}`),
                    weekTotals.saturdayMinutes > 0 && h('div', { style: { color: '#16A34A' } }, `• Récup acquis (samedi) : ${minutesToHM(weekTotals.saturdayMinutes)}`)
                )
            )
        ),

        // Modal ajustement
        showAdjustmentModal && h(AdjustmentModal),

        // Modal confirmation verrouillage
        showLockConfirm && h(Modal, { isOpen: true, onClose: () => setShowLockConfirm(false), title: '🔒 Verrouiller les compteurs initiaux', size: 'md',
            footer: h(Fragment, null,
                h('button', { className: 'btn btn-secondary', onClick: () => setShowLockConfirm(false) }, 'Annuler'),
                h('button', { className: 'btn btn-warning', onClick: lockInitialBalances }, '🔒 Confirmer le verrouillage')
            )
        },
            h('div', { style: { padding: 10 } },
                h('div', { style: { textAlign: 'center', fontSize: 48, marginBottom: 16 } }, '⚠️'),
                h('h3', { style: { textAlign: 'center', marginBottom: 16, color: '#92400E' } }, 'Attention !'),
                h('div', { style: { background: '#FEF3C7', padding: 16, borderRadius: 10, marginBottom: 16 } },
                    h('p', { style: { marginBottom: 12, fontWeight: 600 } }, 'Vous êtes sur le point de verrouiller définitivement les compteurs initiaux :'),
                    h('ul', { style: { marginLeft: 20, marginBottom: 12 } },
                        h('li', null, `Congés initial : ${leaveBalances.conges_initial || 0} jours`),
                        h('li', null, `Congés acquis : ${(leaveBalances.conges_acquis || 0).toFixed(2)} jours`),
                        h('li', null, `Récup initial : ${leaveBalances.recup_initial || 0} heures`)
                    )
                ),
                h('div', { style: { background: '#FEE2E2', padding: 16, borderRadius: 10, border: '1px solid #FCA5A5' } },
                    h('p', { style: { fontWeight: 600, color: '#DC2626', marginBottom: 8 } }, '⛔ Cette action est irréversible pour vous :'),
                    h('ul', { style: { marginLeft: 20, fontSize: 13 } },
                        h('li', null, 'Vous ne pourrez plus modifier ces valeurs'),
                        h('li', null, 'Seul un administrateur pourra les déverrouiller'),
                        h('li', null, 'Assurez-vous que les valeurs sont correctes avant de valider')
                    )
                )
            )
        )
    );
};




// ==========================================
// STOCKAPP v5.0 - NOUVEAUX COMPOSANTS
// ==========================================

// Hook pour le thème sombre
const useTheme = () => {
    const [themeState, setThemeState] = React.useState(() => ({
        theme: ThemeServiceV58.currentTheme,
        darkMode: ThemeServiceV58.darkMode
    }));

    React.useEffect(() => {
        // Écouter les changements de thème
        const handleThemeChange = (e) => {
            setThemeState({
                theme: e.detail.theme,
                darkMode: e.detail.darkMode
            });
        };
        window.addEventListener('theme-changed', handleThemeChange);
        return () => window.removeEventListener('theme-changed', handleThemeChange);
    }, []);

    const toggleTheme = () => {
        ThemeServiceV58.toggleDarkMode();
    };
    
    return { theme: themeState.darkMode ? 'dark' : 'light', toggleTheme, darkMode: themeState.darkMode };
};

// Bouton toggle thème
const ThemeToggle = ({ theme, onToggle }) => {
    return h('button', {
        className: 'theme-toggle',
        onClick: onToggle,
        title: theme === 'light' ? 'Mode sombre' : 'Mode clair'
    }, theme === 'light' ? '🌙' : '☀️');
};

// Recherche globale (Cmd+K)
const CommandPalette = ({ isOpen, onClose, onNavigate, parts, tasks }) => {
    const [query, setQuery] = React.useState('');
    const [selectedIndex, setSelectedIndex] = React.useState(0);
    const inputRef = React.useRef(null);

    const results = React.useMemo(() => {
        if (!query.trim()) return [];
        const q = query.toLowerCase();
        const results = [];

        // Pages
        const pages = [
            { type: 'page', title: 'Accueil', subtitle: 'Dashboard', icon: '🏠', action: () => onNavigate('dashboard') },
            { type: 'page', title: 'Stock', subtitle: 'Gestion des pièces', icon: '📦', action: () => onNavigate('stock') },
            { type: 'page', title: 'Travaux', subtitle: 'Tâches', icon: '🔧', action: () => onNavigate('travaux') },
            { type: 'page', title: 'Commandes', subtitle: 'Achats', icon: '🛒', action: () => onNavigate('orders') },
            { type: 'page', title: 'Planning', subtitle: 'Calendrier', icon: '📅', action: () => onNavigate('planning') },
            { type: 'page', title: 'Statistiques', subtitle: 'Analyses', icon: '📊', action: () => onNavigate('statistics') },
            { type: 'page', title: 'MES', subtitle: 'Mise en service', icon: '🚀', action: () => onNavigate('commissioning') },
        ];
        
        pages.forEach(p => {
            if (p.title.toLowerCase().includes(q) || p.subtitle.toLowerCase().includes(q)) {
                results.push(p);
            }
        });

        // Pièces
        if (parts && parts.length > 0) {
            parts.filter(p => 
                p.ref?.toLowerCase().includes(q) || 
                p.name?.toLowerCase().includes(q)
            ).slice(0, 5).forEach(p => {
                results.push({
                    type: 'part', title: p.ref, subtitle: p.name,
                    icon: '📦', badge: p.quantity + ' en stock',
                    action: () => { onNavigate('stock'); onClose(); }
                });
            });
        }

        // Tâches
        if (tasks && tasks.length > 0) {
            tasks.filter(t => 
                t.device_number?.toLowerCase().includes(q) ||
                t.description?.toLowerCase().includes(q)
            ).slice(0, 5).forEach(t => {
                results.push({
                    type: 'task', title: t.device_number,
                    subtitle: t.description?.substring(0, 50) || 'Sans description',
                    icon: '🔧', badge: t.status,
                    action: () => { onNavigate('travaux'); onClose(); }
                });
            });
        }

        return results;
    }, [query, parts, tasks, onNavigate]);

    React.useEffect(() => {
        if (isOpen && inputRef.current) {
            inputRef.current.focus();
        }
        setQuery('');
        setSelectedIndex(0);
    }, [isOpen]);

    React.useEffect(() => {
        if (!isOpen) return;
        const handleKeyDown = (e) => {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                setSelectedIndex(i => Math.min(i + 1, results.length - 1));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                setSelectedIndex(i => Math.max(i - 1, 0));
            } else if (e.key === 'Enter' && results[selectedIndex]) {
                e.preventDefault();
                results[selectedIndex].action();
            } else if (e.key === 'Escape') {
                onClose();
            }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [isOpen, results, selectedIndex, onClose]);

    if (!isOpen) return null;

    const grouped = results.reduce((acc, item) => {
        if (!acc[item.type]) acc[item.type] = [];
        acc[item.type].push(item);
        return acc;
    }, {});

    const labels = { page: 'Pages', part: 'Pièces', task: 'Tâches' };

    return h('div', { className: 'command-palette-overlay', onClick: onClose },
        h('div', { className: 'command-palette', onClick: e => e.stopPropagation() },
            h('div', { className: 'command-palette-input' },
                h('span', null, '🔍'),
                h('input', {
                    ref: inputRef, type: 'text',
                    placeholder: 'Rechercher...',
                    value: query,
                    onChange: e => { setQuery(e.target.value); setSelectedIndex(0); }
                }),
                h('div', { className: 'command-palette-kbd' }, h('kbd', null, 'ESC'))
            ),
            h('div', { className: 'command-palette-results' },
                results.length === 0 && query && h('div', { className: 'command-palette-empty' }, 'Aucun résultat'),
                results.length === 0 && !query && h('div', { className: 'command-palette-empty' }, 'Tapez pour rechercher...'),
                Object.entries(grouped).map(([type, items]) =>
                    h('div', { key: type, className: 'command-palette-group' },
                        h('div', { className: 'command-palette-group-title' }, labels[type] || type),
                        items.map((item, idx) => {
                            const globalIdx = results.indexOf(item);
                            return h('div', {
                                key: idx,
                                className: 'command-palette-item ' + (globalIdx === selectedIndex ? 'selected' : ''),
                                onClick: () => item.action(),
                                onMouseEnter: () => setSelectedIndex(globalIdx)
                            },
                                h('div', { className: 'command-palette-item-icon' }, item.icon),
                                h('div', { style: { flex: 1 } },
                                    h('div', { className: 'command-palette-item-title' }, item.title),
                                    h('div', { className: 'command-palette-item-subtitle' }, item.subtitle)
                                ),
                                item.badge && h('div', { className: 'command-palette-item-badge' }, item.badge)
                            );
                        })
                    )
                )
            ),
            h('div', { className: 'command-palette-footer' },
                h('div', { className: 'command-palette-shortcuts' },
                    h('span', null, h('kbd', null, '↑↓'), ' Naviguer'),
                    h('span', null, h('kbd', null, '↵'), ' Sélectionner')
                ),
                h('span', null, 'StockApp v5.6')
            )
        )
    );
};

// Mode Présentation
const PresentationMode = ({ isOpen, onClose, tasks, parts, notifications, orders, requests, timesheets, users }) => {
    const [time, setTime] = React.useState(new Date());
    const [activeSection, setActiveSection] = React.useState('tasks');
    const [autoRotate, setAutoRotate] = React.useState(true);
    const [rotationInterval, setRotationInterval] = React.useState(30); // secondes
    
    const sections = ['tasks', 'orders', 'requests', 'timesheets', 'planning'];

    // Timer pour l'horloge
    React.useEffect(() => {
        if (!isOpen) return;
        const timer = setInterval(() => setTime(new Date()), 1000);
        return () => clearInterval(timer);
    }, [isOpen]);

    // Auto-rotation des onglets
    React.useEffect(() => {
        if (!isOpen || !autoRotate) return;
        const rotateTimer = setInterval(() => {
            setActiveSection(prev => {
                const currentIndex = sections.indexOf(prev);
                const nextIndex = (currentIndex + 1) % sections.length;
                return sections[nextIndex];
            });
        }, rotationInterval * 1000);
        return () => clearInterval(rotateTimer);
    }, [isOpen, autoRotate, rotationInterval]);

    if (!isOpen) return null;

    const lowStockParts = parts?.filter(p => p.quantity <= (p.min_stock || 0)) || [];
    const todayTasks = tasks?.filter(t => t.status !== 'termine').slice(0, 12) || [];
    const urgentTasks = todayTasks.filter(t => t.priority === 'urgente' || t.priority === 'haute');
    const pendingOrders = orders?.filter(o => o.status === 'en-commande') || [];
    const pendingRequests = requests?.filter(r => ['nouveau', 'en_cours', 'en_attente'].includes(r.status)) || [];
    const completedTasksToday = tasks?.filter(t => t.status === 'termine').length || 0;

    // Calculer la semaine courante
    const getWeekDays = () => {
        const now = new Date();
        const monday = new Date(now);
        monday.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
        monday.setHours(0, 0, 0, 0);
        const days = [];
        for (let i = 0; i < 7; i++) {
            const d = new Date(monday);
            d.setDate(monday.getDate() + i);
            days.push(d);
        }
        return days;
    };
    const weekDays = getWeekDays();
    const dayNames = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

    // Calculer la semaine courante (numéro)
    const getWeekNumber = () => {
        const now = new Date();
        const start = new Date(now.getFullYear(), 0, 1);
        const days = Math.floor((now - start) / (24 * 60 * 60 * 1000));
        return Math.ceil((days + start.getDay() + 1) / 7);
    };
    const weekNumber = getWeekNumber();

    const formatTime = d => d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const formatDate = d => d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });

    // Fonction pour obtenir les tâches d'un jour (utilise created_at si pas de date planifiée)
    const getTasksForDay = (day) => {
        const dayStart = new Date(day);
        dayStart.setHours(0, 0, 0, 0);
        const dayEnd = new Date(day);
        dayEnd.setHours(23, 59, 59, 999);
        const dayStr = day.toISOString().split('T')[0];
        
        return tasks?.filter(t => {
            // Vérifier planned_date ou due_date
            if (t.planned_date?.startsWith(dayStr) || t.due_date?.startsWith(dayStr)) return true;
            // Sinon vérifier created_at
            if (t.created_at) {
                const createdDate = new Date(t.created_at);
                return createdDate >= dayStart && createdDate <= dayEnd;
            }
            return false;
        }) || [];
    };

    // Feuilles d'heures de la semaine courante
    const weekTimesheets = timesheets?.filter(ts => ts.week_number === weekNumber && ts.year === new Date().getFullYear()) || [];

    const sectionLabels = {
        tasks: '🔧 Travaux',
        orders: '🛒 Commandes', 
        requests: '📩 Demandes',
        timesheets: '⏱️ Feuilles d\'heures',
        planning: '📅 Planning'
    };

    return h('div', { className: 'presentation-mode' },
        h('div', { className: 'presentation-header' },
            h('div', { className: 'presentation-logo' },
                h('div', { className: 'presentation-logo-icon' }, 'S'),
                h('div', { style: { fontSize: '24px', fontWeight: 700, color: 'var(--text)' } }, 'StockApp - Mode Atelier')
            ),
            h('div', { style: { textAlign: 'center' } },
                h('div', { className: 'presentation-clock' }, formatTime(time)),
                h('div', { className: 'presentation-date' }, formatDate(time), ' • Semaine ', weekNumber)
            ),
            h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                // Contrôle auto-rotation
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, background: 'var(--card)', padding: '8px 12px', borderRadius: 8 } },
                    h('span', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Auto:'),
                    h('button', {
                        onClick: () => setAutoRotate(!autoRotate),
                        style: {
                            padding: '4px 10px',
                            border: 'none',
                            borderRadius: 6,
                            cursor: 'pointer',
                            fontSize: 12,
                            fontWeight: 600,
                            background: autoRotate ? 'var(--success)' : 'var(--muted)',
                            color: 'white'
                        }
                    }, autoRotate ? 'ON' : 'OFF'),
                    autoRotate && h('select', {
                        value: rotationInterval,
                        onChange: e => setRotationInterval(Number(e.target.value)),
                        style: {
                            padding: '4px 8px',
                            border: 'none',
                            borderRadius: 6,
                            fontSize: 12,
                            background: 'var(--background)',
                            color: 'var(--text)',
                            cursor: 'pointer'
                        }
                    },
                        h('option', { value: 10 }, '10s'),
                        h('option', { value: 20 }, '20s'),
                        h('option', { value: 30 }, '30s'),
                        h('option', { value: 60 }, '1min'),
                        h('option', { value: 120 }, '2min')
                    )
                ),
                h('button', { className: 'presentation-exit', onClick: onClose }, '✕ Quitter')
            )
        ),
        
        // KPIs en haut
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(6, 1fr)', gap: 16, padding: '0 32px', marginBottom: 24 } },
            h('div', { className: 'presentation-kpi' },
                h('div', { className: 'presentation-kpi-value', style: { color: 'var(--primary)', fontSize: 48 } }, todayTasks.length),
                h('div', { className: 'presentation-kpi-label' }, '🔧 Tâches actives')
            ),
            h('div', { className: 'presentation-kpi ' + (urgentTasks.length > 0 ? 'alert' : '') },
                h('div', { className: 'presentation-kpi-value', style: { color: 'var(--danger)', fontSize: 48 } }, urgentTasks.length),
                h('div', { className: 'presentation-kpi-label' }, '🚨 Urgentes')
            ),
            h('div', { className: 'presentation-kpi' },
                h('div', { className: 'presentation-kpi-value', style: { color: 'var(--success)', fontSize: 48 } }, completedTasksToday),
                h('div', { className: 'presentation-kpi-label' }, '✅ Terminées')
            ),
            h('div', { className: 'presentation-kpi' },
                h('div', { className: 'presentation-kpi-value', style: { color: 'var(--info)', fontSize: 48 } }, pendingOrders.length),
                h('div', { className: 'presentation-kpi-label' }, '🛒 Commandes')
            ),
            h('div', { className: 'presentation-kpi' },
                h('div', { className: 'presentation-kpi-value', style: { color: 'var(--purple)', fontSize: 48 } }, pendingRequests.length),
                h('div', { className: 'presentation-kpi-label' }, '📩 Demandes')
            ),
            h('div', { className: 'presentation-kpi ' + (lowStockParts.length > 0 ? 'alert' : '') },
                h('div', { className: 'presentation-kpi-value', style: { color: 'var(--warning)', fontSize: 48 } }, lowStockParts.length),
                h('div', { className: 'presentation-kpi-label' }, '⚠️ Alertes stock')
            )
        ),

        // Onglets de navigation avec indicateur de progression
        h('div', { style: { display: 'flex', alignItems: 'center', gap: 8, padding: '0 32px', marginBottom: 16 } },
            sections.map((section, idx) =>
                h('button', {
                    key: section,
                    onClick: () => { setActiveSection(section); setAutoRotate(false); },
                    style: {
                        padding: '12px 24px',
                        border: 'none',
                        borderRadius: 12,
                        cursor: 'pointer',
                        fontWeight: 600,
                        fontSize: 16,
                        background: activeSection === section ? 'var(--primary)' : 'var(--card)',
                        color: activeSection === section ? 'white' : 'var(--text)',
                        transition: 'all 0.2s',
                        position: 'relative',
                        overflow: 'hidden'
                    }
                }, sectionLabels[section])
            ),
            // Indicateur de progression auto-rotation
            autoRotate && h('div', { style: { marginLeft: 'auto', fontSize: 12, color: 'var(--muted)' } }, 
                '⏱️ Prochain: ', rotationInterval, 's'
            )
        ),

        h('div', { className: 'presentation-content', style: { gridTemplateColumns: '3fr 1fr' } },
            // Contenu principal selon l'onglet
            h('div', { style: { display: 'flex', flexDirection: 'column', gap: 16 } },
                // SECTION TRAVAUX
                activeSection === 'tasks' && h('div', { className: 'presentation-tasks', style: { maxHeight: 'calc(100vh - 350px)' } },
                    h('div', { className: 'presentation-tasks-header' },
                        h('div', { className: 'presentation-tasks-title' }, '🔧 Travaux en cours (', todayTasks.length, ')')
                    ),
                    h('div', { className: 'presentation-tasks-list' },
                        todayTasks.map((task, idx) =>
                            h('div', { 
                                key: idx,
                                className: 'presentation-task-item ' + (task.priority === 'urgente' || task.priority === 'haute' ? 'urgent' : '')
                            },
                                h('div', { className: 'presentation-task-number' }, task.device_number),
                                h('div', { style: { flex: 1 } },
                                    h('div', { style: { fontWeight: 600, fontSize: 16, color: 'var(--text)' } }, task.description?.substring(0, 80) || 'Sans description'),
                                    h('div', { style: { fontSize: '14px', color: 'var(--muted)', marginTop: 4 } }, 
                                        '📍 ', task.location || task.tournee || '-', 
                                        task.assigned_to ? ' • 👤 ' + (users?.find(u => u.id === task.assigned_to)?.first_name || 'Non assigné') : ''
                                    )
                                ),
                                h('div', { 
                                    className: 'presentation-task-status',
                                    style: {
                                        background: task.status === 'termine' ? 'var(--success-pastel)' :
                                                   task.status === 'en-stock' ? 'var(--info-pastel)' : 'var(--warning-pastel)',
                                        color: task.status === 'termine' ? 'var(--success)' :
                                               task.status === 'en-stock' ? 'var(--info)' : 'var(--warning)'
                                    }
                                }, task.status?.replace('-', ' ') || 'En attente')
                            )
                        ),
                        todayTasks.length === 0 && h('div', { style: { textAlign: 'center', padding: '60px', color: 'var(--muted)', fontSize: 18 } }, '✅ Aucune tâche en cours')
                    )
                ),

                // SECTION COMMANDES
                activeSection === 'orders' && h('div', { className: 'presentation-tasks', style: { maxHeight: 'calc(100vh - 350px)' } },
                    h('div', { className: 'presentation-tasks-header' },
                        h('div', { className: 'presentation-tasks-title' }, '🛒 Commandes en attente (', pendingOrders.length, ')')
                    ),
                    h('div', { className: 'presentation-tasks-list' },
                        pendingOrders.slice(0, 10).map((order, idx) =>
                            h('div', { 
                                key: idx,
                                className: 'presentation-task-item'
                            },
                                h('div', { style: { minWidth: 120 } },
                                    h('div', { style: { fontWeight: 700, fontSize: 18, color: 'var(--info)' } }, '#', order.id?.toString().slice(-4)),
                                    h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 
                                        new Date(order.created_at).toLocaleDateString('fr-FR')
                                    )
                                ),
                                h('div', { style: { flex: 1 } },
                                    h('div', { style: { fontWeight: 600, fontSize: 16, color: 'var(--text)' } }, order.supplier || 'Fournisseur non défini'),
                                    h('div', { style: { fontSize: 14, color: 'var(--muted)', marginTop: 4 } }, 
                                        order.notes?.substring(0, 100) || 'Aucune note'
                                    )
                                ),
                                h('div', { style: { textAlign: 'right' } },
                                    order.total_amount && h('div', { style: { fontWeight: 700, fontSize: 18, color: 'var(--text)' } }, 
                                        order.total_amount.toLocaleString(), ' €'
                                    ),
                                    h('div', { 
                                        style: {
                                            padding: '6px 12px',
                                            background: 'var(--warning-pastel)',
                                            color: 'var(--warning)',
                                            borderRadius: 20,
                                            fontSize: 12,
                                            fontWeight: 600,
                                            display: 'inline-block',
                                            marginTop: 4
                                        }
                                    }, 'En commande')
                                )
                            )
                        ),
                        pendingOrders.length === 0 && h('div', { style: { textAlign: 'center', padding: '60px', color: 'var(--muted)', fontSize: 18 } }, '✅ Aucune commande en attente')
                    )
                ),

                // SECTION DEMANDES
                activeSection === 'requests' && h('div', { className: 'presentation-tasks', style: { maxHeight: 'calc(100vh - 350px)' } },
                    h('div', { className: 'presentation-tasks-header' },
                        h('div', { className: 'presentation-tasks-title' }, '📩 Demandes en cours (', pendingRequests.length, ')')
                    ),
                    h('div', { className: 'presentation-tasks-list' },
                        pendingRequests.slice(0, 10).map((request, idx) =>
                            h('div', { 
                                key: idx,
                                className: 'presentation-task-item ' + (request.priority === 'urgente' ? 'urgent' : '')
                            },
                                h('div', { style: { minWidth: 100 } },
                                    h('div', { style: { fontWeight: 700, fontSize: 16, color: 'var(--purple)' } }, '#', request.id?.toString().slice(-4)),
                                    h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 
                                        new Date(request.created_at).toLocaleDateString('fr-FR')
                                    )
                                ),
                                h('div', { style: { flex: 1 } },
                                    h('div', { style: { fontWeight: 600, fontSize: 16, color: 'var(--text)' } }, request.subject || 'Sans objet'),
                                    h('div', { style: { fontSize: 14, color: 'var(--muted)', marginTop: 4 } }, 
                                        '📧 ', request.sender_email || '-'
                                    )
                                ),
                                h('div', { 
                                    style: {
                                        padding: '6px 12px',
                                        background: request.status === 'nouveau' ? 'var(--info-pastel)' : 'var(--warning-pastel)',
                                        color: request.status === 'nouveau' ? 'var(--info)' : 'var(--warning)',
                                        borderRadius: 20,
                                        fontSize: 12,
                                        fontWeight: 600
                                    }
                                }, request.status?.replace('_', ' ') || 'Nouveau')
                            )
                        ),
                        pendingRequests.length === 0 && h('div', { style: { textAlign: 'center', padding: '60px', color: 'var(--muted)', fontSize: 18 } }, '✅ Aucune demande en cours')
                    )
                ),

                // SECTION FEUILLES D'HEURES
                activeSection === 'timesheets' && h('div', { className: 'presentation-tasks', style: { maxHeight: 'calc(100vh - 350px)' } },
                    h('div', { className: 'presentation-tasks-header' },
                        h('div', { className: 'presentation-tasks-title' }, '⏱️ Feuilles d\'heures - Semaine ', weekNumber)
                    ),
                    h('div', { className: 'presentation-tasks-list' },
                        users?.map((user, idx) => {
                            const ts = weekTimesheets?.find(t => t.user_id === user.id);
                            const statusIcon = ts?.status === 'valide' ? '✅' : ts?.status === 'soumis' ? '📤' : ts?.status === 'brouillon' ? '📝' : '⏳';
                            const statusText = ts?.status === 'valide' ? 'Validée' : ts?.status === 'soumis' ? 'Soumise' : ts?.status === 'brouillon' ? 'Brouillon' : 'Non commencée';
                            const statusColor = ts?.status === 'valide' ? 'var(--success)' : ts?.status === 'soumis' ? 'var(--info)' : ts?.status === 'brouillon' ? 'var(--warning)' : 'var(--muted)';
                            
                            const minutesToHM = (mins) => {
                                if (!mins) return '0h00';
                                const h = Math.floor(mins / 60);
                                const m = mins % 60;
                                return h + 'h' + m.toString().padStart(2, '0');
                            };
                            
                            return h('div', { 
                                key: idx,
                                className: 'presentation-task-item'
                            },
                                h('div', { 
                                    style: { 
                                        width: 50, height: 50, borderRadius: '50%', 
                                        background: 'var(--primary-pastel)', color: 'var(--primary)',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        fontWeight: 700, fontSize: 18
                                    } 
                                }, (user.first_name?.[0] || 'U') + (user.last_name?.[0] || '')),
                                h('div', { style: { flex: 1, marginLeft: 16 } },
                                    h('div', { style: { fontWeight: 600, fontSize: 18, color: 'var(--text)' } }, 
                                        user.first_name || '', ' ', user.last_name || user.email?.split('@')[0] || ''
                                    ),
                                    h('div', { style: { fontSize: 14, color: 'var(--muted)', marginTop: 4 } }, 
                                        user.role === 'admin' ? '👑 Admin' : user.role === 'technicien' ? '🔧 Technicien' : '👤 Utilisateur'
                                    )
                                ),
                                ts && h('div', { style: { textAlign: 'center', marginRight: 20 } },
                                    h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Travail'),
                                    h('div', { style: { fontWeight: 700, fontSize: 16, color: 'var(--text)' } }, minutesToHM(ts.total_work_minutes))
                                ),
                                ts && h('div', { style: { textAlign: 'center', marginRight: 20 } },
                                    h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, 'Trajet'),
                                    h('div', { style: { fontWeight: 700, fontSize: 16, color: 'var(--text)' } }, minutesToHM(ts.total_travel_minutes))
                                ),
                                h('div', { 
                                    style: {
                                        padding: '8px 16px',
                                        background: statusColor + '20',
                                        color: statusColor,
                                        borderRadius: 20,
                                        fontSize: 14,
                                        fontWeight: 600,
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: 8
                                    }
                                }, h('span', { style: { fontSize: 18 } }, statusIcon), statusText)
                            );
                        }),
                        (!users || users.length === 0) && h('div', { style: { textAlign: 'center', padding: '60px', color: 'var(--muted)', fontSize: 18 } }, 'Aucun utilisateur')
                    )
                ),

                // SECTION PLANNING
                activeSection === 'planning' && h('div', { className: 'presentation-tasks', style: { maxHeight: 'calc(100vh - 350px)', overflow: 'auto' } },
                    h('div', { className: 'presentation-tasks-header' },
                        h('div', { className: 'presentation-tasks-title' }, '📅 Planning de la semaine ', weekNumber)
                    ),
                    h('div', { style: { padding: 16 } },
                        // Grille des jours de la semaine
                        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: 12 } },
                            weekDays.map((day, idx) => {
                                const isToday = day.toDateString() === new Date().toDateString();
                                const dayTasks = getTasksForDay(day);
                                const dayTasksActive = dayTasks.filter(t => t.status !== 'termine');
                                const dayTasksCompleted = dayTasks.filter(t => t.status === 'termine');
                                
                                return h('div', { 
                                    key: idx,
                                    style: {
                                        background: isToday ? 'var(--primary-pastel)' : 'var(--card)',
                                        borderRadius: 12,
                                        padding: 12,
                                        border: isToday ? '3px solid var(--primary)' : '1px solid var(--border)',
                                        minHeight: 220
                                    }
                                },
                                    h('div', { style: { textAlign: 'center', marginBottom: 12, paddingBottom: 8, borderBottom: '1px solid var(--border)' } },
                                        h('div', { style: { fontSize: 13, fontWeight: 600, color: isToday ? 'var(--primary)' : 'var(--muted)', textTransform: 'uppercase' } }, dayNames[idx]),
                                        h('div', { style: { fontSize: 28, fontWeight: 800, color: 'var(--text)' } }, day.getDate()),
                                        h('div', { style: { fontSize: 11, color: 'var(--muted)' } }, day.toLocaleDateString('fr-FR', { month: 'short' }))
                                    ),
                                    // Résumé
                                    h('div', { style: { display: 'flex', justifyContent: 'space-around', marginBottom: 8, fontSize: 11 } },
                                        h('span', { style: { color: 'var(--info)' } }, '📋 ', dayTasksActive.length),
                                        h('span', { style: { color: 'var(--success)' } }, '✅ ', dayTasksCompleted.length)
                                    ),
                                    // Liste des tâches
                                    h('div', { style: { fontSize: 12, maxHeight: 140, overflow: 'auto' } },
                                        dayTasks.slice(0, 4).map((t, tidx) =>
                                            h('div', { 
                                                key: tidx, 
                                                style: { 
                                                    padding: '6px 8px', 
                                                    background: t.status === 'termine' ? 'var(--success-pastel)' : 
                                                               t.priority === 'urgente' ? 'var(--danger-pastel)' : 'var(--background)', 
                                                    borderRadius: 6, 
                                                    marginBottom: 4,
                                                    borderLeft: t.priority === 'urgente' ? '3px solid var(--danger)' : 
                                                               t.status === 'termine' ? '3px solid var(--success)' : '3px solid var(--info)'
                                                } 
                                            }, 
                                                h('div', { style: { fontWeight: 600, color: 'var(--text)', fontSize: 11 } }, t.device_number || 'Tâche'),
                                                h('div', { style: { color: 'var(--muted)', fontSize: 10, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' } }, 
                                                    t.location?.substring(0, 15) || t.description?.substring(0, 15) || '-'
                                                )
                                            )
                                        ),
                                        dayTasks.length > 4 && h('div', { 
                                            style: { fontSize: 11, color: 'var(--primary)', textAlign: 'center', fontWeight: 600, marginTop: 4 } 
                                        }, '+', dayTasks.length - 4, ' autres'),
                                        dayTasks.length === 0 && h('div', { 
                                            style: { fontSize: 11, color: 'var(--muted)', textAlign: 'center', padding: '20px 0' } 
                                        }, 'Aucune tâche')
                                    )
                                );
                            })
                        )
                    )
                )
            ),

            // Sidebar droite - Alertes stock et Activité
            h('div', { className: 'presentation-sidebar' },
                // Alertes stock
                h('div', { className: 'presentation-alerts', style: { marginBottom: 16 } },
                    h('div', { className: 'presentation-alerts-title' }, '⚠️ Alertes stock (', lowStockParts.length, ')'),
                    lowStockParts.slice(0, 6).map((part, idx) =>
                        h('div', { key: idx, className: 'presentation-alert-item' },
                            h('span', null, '📦'),
                            h('div', { style: { flex: 1 } },
                                h('div', { style: { fontWeight: 600, fontSize: 13, color: 'var(--text)' } }, part.ref),
                                h('div', { style: { fontSize: 11, color: 'var(--muted)' } }, part.name?.substring(0, 20))
                            ),
                            h('div', { style: { textAlign: 'right' } },
                                h('div', { style: { fontWeight: 700, color: 'var(--danger)', fontSize: 16 } }, part.quantity),
                                h('div', { style: { fontSize: 10, color: 'var(--muted)' } }, 'min: ', part.min_stock || 0)
                            )
                        )
                    ),
                    lowStockParts.length === 0 && h('div', { style: { textAlign: 'center', padding: '20px', color: 'var(--muted)', fontSize: 13 } }, '✅ Stock OK')
                ),

                // Activité du jour
                h('div', { className: 'presentation-alerts' },
                    h('div', { className: 'presentation-alerts-title' }, '📊 Résumé'),
                    h('div', { style: { padding: '12px', background: 'var(--background)', borderRadius: 8 } },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 12, paddingBottom: 12, borderBottom: '1px solid var(--border)' } },
                            h('span', { style: { color: 'var(--muted)', fontSize: 13 } }, 'Tâches actives'),
                            h('span', { style: { fontWeight: 700, color: 'var(--info)', fontSize: 18 } }, todayTasks.length)
                        ),
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 12, paddingBottom: 12, borderBottom: '1px solid var(--border)' } },
                            h('span', { style: { color: 'var(--muted)', fontSize: 13 } }, 'Terminées'),
                            h('span', { style: { fontWeight: 700, color: 'var(--success)', fontSize: 18 } }, completedTasksToday)
                        ),
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 12, paddingBottom: 12, borderBottom: '1px solid var(--border)' } },
                            h('span', { style: { color: 'var(--muted)', fontSize: 13 } }, 'Urgentes'),
                            h('span', { style: { fontWeight: 700, color: 'var(--danger)', fontSize: 18 } }, urgentTasks.length)
                        ),
                        h('div', { style: { display: 'flex', justifyContent: 'space-between' } },
                            h('span', { style: { color: 'var(--muted)', fontSize: 13 } }, 'Références'),
                            h('span', { style: { fontWeight: 700, color: 'var(--text)', fontSize: 18 } }, parts?.length || 0)
                        )
                    )
                )
            )
        )
    );
};

// Page Statistiques
const StatisticsPage = ({ parts, tasks, orders }) => {
    const [period, setPeriod] = React.useState('month');
    
    const stats = React.useMemo(() => {
        const totalParts = parts?.length || 0;
        const totalQuantity = parts?.reduce((sum, p) => sum + (p.quantity || 0), 0) || 0;
        const lowStock = parts?.filter(p => p.quantity <= p.min_stock).length || 0;
        const totalValue = parts?.reduce((sum, p) => sum + ((p.unit_price || 0) * (p.quantity || 0)), 0) || 0;
        const activeTasks = tasks?.filter(t => t.status !== 'termine').length || 0;
        const completedTasks = tasks?.filter(t => t.status === 'termine').length || 0;
        return { totalParts, totalQuantity, lowStock, totalValue, activeTasks, completedTasks };
    }, [parts, tasks]);

    const monthlyData = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin'].map(month => ({
        month, entries: Math.floor(Math.random() * 100) + 30, exits: Math.floor(Math.random() * 80) + 20
    }));
    const maxBarValue = Math.max(...monthlyData.map(d => Math.max(d.entries, d.exits)));

    const categoryData = React.useMemo(() => {
        const categories = {};
        parts?.forEach(p => { const cat = p.category || 'Autre'; categories[cat] = (categories[cat] || 0) + 1; });
        return Object.entries(categories).map(([name, count], idx) => ({
            name, count,
            color: ['#E11D48', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6'][idx % 5]
        }));
    }, [parts]);

    return h('div', { className: 'stats-page' },
        h('div', { className: 'stats-header' },
            h('h2', null, '📊 Statistiques'),
            h('div', { className: 'stats-period-selector' },
                ['week', 'month', 'quarter', 'year'].map(p =>
                    h('button', {
                        key: p, className: 'stats-period-btn ' + (period === p ? 'active' : ''),
                        onClick: () => setPeriod(p)
                    }, p === 'week' ? 'Semaine' : p === 'month' ? 'Mois' : p === 'quarter' ? 'Trimestre' : 'Année')
                )
            )
        ),
        h('div', { className: 'stats-grid' },
            h('div', { className: 'stats-card' },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--primary-pastel)', color: 'var(--primary)' } }, '📦'),
                h('div', { className: 'stats-card-value' }, stats.totalParts),
                h('div', { className: 'stats-card-label' }, 'Références'),
                h('div', { className: 'stats-card-trend up' }, '↑ 12%')
            ),
            h('div', { className: 'stats-card' },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--info-pastel)', color: 'var(--info)' } }, '📊'),
                h('div', { className: 'stats-card-value' }, stats.totalQuantity.toLocaleString()),
                h('div', { className: 'stats-card-label' }, 'Quantité totale'),
                h('div', { className: 'stats-card-trend up' }, '↑ 8%')
            ),
            h('div', { className: 'stats-card' },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--warning-pastel)', color: 'var(--warning)' } }, '⚠️'),
                h('div', { className: 'stats-card-value' }, stats.lowStock),
                h('div', { className: 'stats-card-label' }, 'Stock bas'),
                h('div', { className: 'stats-card-trend down' }, '↓ 3')
            ),
            h('div', { className: 'stats-card' },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--success-pastel)', color: 'var(--success)' } }, '💰'),
                h('div', { className: 'stats-card-value' }, stats.totalValue.toLocaleString() + ' €'),
                h('div', { className: 'stats-card-label' }, 'Valeur stock'),
                h('div', { className: 'stats-card-trend up' }, '↑ 5%')
            )
        ),
        h('div', { className: 'stats-charts' },
            h('div', { className: 'chart-container' },
                h('div', { className: 'chart-header' },
                    h('div', { className: 'chart-title' }, 'Mouvements de stock'),
                    h('div', { className: 'chart-legend' },
                        h('div', { className: 'chart-legend-item' },
                            h('div', { className: 'chart-legend-dot', style: { background: 'var(--success)' } }), 'Entrées'),
                        h('div', { className: 'chart-legend-item' },
                            h('div', { className: 'chart-legend-dot', style: { background: 'var(--danger)' } }), 'Sorties')
                    )
                ),
                h('div', { className: 'bar-chart' },
                    monthlyData.map((d, idx) =>
                        h('div', { key: idx, className: 'bar-group' },
                            h('div', { className: 'bar-wrapper' },
                                h('div', { className: 'bar entries', style: { height: (d.entries / maxBarValue) * 100 + '%' } }),
                                h('div', { className: 'bar exits', style: { height: (d.exits / maxBarValue) * 100 + '%' } })
                            ),
                            h('div', { className: 'bar-label' }, d.month)
                        )
                    )
                )
            ),
            h('div', { className: 'chart-container' },
                h('div', { className: 'chart-header' },
                    h('div', { className: 'chart-title' }, 'Répartition par catégorie')
                ),
                h('div', { className: 'donut-chart' },
                    h('div', { className: 'donut-visual' },
                        h('svg', { viewBox: '0 0 100 100', width: 180, height: 180 },
                            categoryData.reduce((acc, cat, idx) => {
                                const total = categoryData.reduce((s, c) => s + c.count, 0) || 1;
                                const angle = (cat.count / total) * 360;
                                const startRad = (acc.angle - 90) * Math.PI / 180;
                                const endRad = (acc.angle + angle - 90) * Math.PI / 180;
                                const x1 = 50 + 40 * Math.cos(startRad);
                                const y1 = 50 + 40 * Math.sin(startRad);
                                const x2 = 50 + 40 * Math.cos(endRad);
                                const y2 = 50 + 40 * Math.sin(endRad);
                                const largeArc = angle > 180 ? 1 : 0;
                                acc.elements.push(h('path', {
                                    key: idx,
                                    d: 'M 50 50 L ' + x1 + ' ' + y1 + ' A 40 40 0 ' + largeArc + ' 1 ' + x2 + ' ' + y2 + ' Z',
                                    fill: cat.color
                                }));
                                acc.angle += angle;
                                return acc;
                            }, { angle: 0, elements: [] }).elements,
                            h('circle', { cx: 50, cy: 50, r: 25, fill: 'var(--card)' })
                        ),
                        h('div', { className: 'donut-center' },
                            h('div', { className: 'donut-center-value' }, stats.totalParts),
                            h('div', { className: 'donut-center-label' }, 'Total')
                        )
                    ),
                    h('div', { className: 'donut-legend' },
                        categoryData.slice(0, 5).map((cat, idx) =>
                            h('div', { key: idx, className: 'donut-legend-item' },
                                h('div', { className: 'donut-legend-color', style: { background: cat.color } }),
                                h('div', { className: 'donut-legend-label' }, cat.name),
                                h('div', { className: 'donut-legend-value' }, cat.count)
                            )
                        )
                    )
                )
            )
        ),
        h('div', { className: 'stats-grid', style: { gridTemplateColumns: 'repeat(3, 1fr)' } },
            h('div', { className: 'stats-card' },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--info-pastel)', color: 'var(--info)' } }, '🔧'),
                h('div', { className: 'stats-card-value' }, stats.activeTasks),
                h('div', { className: 'stats-card-label' }, 'Tâches actives')
            ),
            h('div', { className: 'stats-card' },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--success-pastel)', color: 'var(--success)' } }, '✅'),
                h('div', { className: 'stats-card-value' }, stats.completedTasks),
                h('div', { className: 'stats-card-label' }, 'Terminées')
            ),
            h('div', { className: 'stats-card' },
                h('div', { className: 'stats-card-icon', style: { background: 'var(--purple-pastel)', color: 'var(--purple)' } }, '🛒'),
                h('div', { className: 'stats-card-value' }, orders?.length || 0),
                h('div', { className: 'stats-card-label' }, 'Commandes')
            )
        )
    );
};

// Kanban Board pour les tâches
const KanbanBoard = ({ tasks, onTaskMove, onTaskClick }) => {
    const [draggedTask, setDraggedTask] = React.useState(null);
    const [dragOverColumn, setDragOverColumn] = React.useState(null);

    const columns = [
        { id: 'en-commande', title: 'En commande', color: 'var(--warning)' },
        { id: 'en-stock', title: 'En stock', color: 'var(--info)' },
        { id: 'termine', title: 'Terminé', color: 'var(--success)' }
    ];

    const tasksByStatus = React.useMemo(() => {
        const grouped = { 'en-commande': [], 'en-stock': [], 'termine': [] };
        (tasks || []).forEach(task => {
            const status = task.status || 'en-commande';
            if (grouped[status]) grouped[status].push(task);
        });
        return grouped;
    }, [tasks]);

    const handleDragStart = (e, task) => {
        setDraggedTask(task);
        e.dataTransfer.effectAllowed = 'move';
    };

    const handleDrop = (e, columnId) => {
        e.preventDefault();
        setDragOverColumn(null);
        if (draggedTask && draggedTask.status !== columnId && onTaskMove) {
            onTaskMove(draggedTask.id, columnId);
        }
        setDraggedTask(null);
    };

    return h('div', { className: 'kanban-board' },
        columns.map(col =>
            h('div', { key: col.id, className: 'kanban-column' },
                h('div', { className: 'kanban-column-header' },
                    h('div', { className: 'kanban-column-title' },
                        h('span', { style: { width: 8, height: 8, borderRadius: '50%', background: col.color, display: 'inline-block' } }),
                        col.title
                    ),
                    h('span', { className: 'kanban-column-count' }, tasksByStatus[col.id].length)
                ),
                h('div', { 
                    className: 'kanban-column-body ' + (dragOverColumn === col.id ? 'drag-over' : ''),
                    onDragOver: e => { e.preventDefault(); setDragOverColumn(col.id); },
                    onDragLeave: () => setDragOverColumn(null),
                    onDrop: e => handleDrop(e, col.id)
                },
                    tasksByStatus[col.id].map(task =>
                        h('div', {
                            key: task.id,
                            className: 'kanban-card ' + (draggedTask?.id === task.id ? 'dragging' : ''),
                            draggable: true,
                            onDragStart: e => handleDragStart(e, task),
                            onDragEnd: () => setDraggedTask(null),
                            onClick: () => onTaskClick && onTaskClick(task)
                        },
                            h('div', { className: 'kanban-card-header' },
                                h('span', { className: 'kanban-card-number' }, task.device_number),
                                task.priority && h('span', { className: 'kanban-card-priority ' + task.priority }, task.priority)
                            ),
                            h('div', { className: 'kanban-card-title' }, task.description?.substring(0, 80) || 'Sans description'),
                            h('div', { className: 'kanban-card-footer' },
                                task.assigned_to && h('div', { className: 'kanban-card-assignee' },
                                    h('div', { className: 'kanban-card-avatar' }, task.assigned_to.substring(0, 2).toUpperCase()),
                                    task.assigned_to
                                )
                            )
                        )
                    ),
                    tasksByStatus[col.id].length === 0 && h('div', { style: { textAlign: 'center', padding: '40px 20px', color: 'var(--muted)' } }, 'Aucune tâche')
                )
            )
        )
    );
};

// Raccourcis clavier helper
const ShortcutsHelp = ({ isOpen, onClose }) => {
    if (!isOpen) return null;

    const sections = [
        { title: 'Navigation', shortcuts: [
            { keys: ['⌘', 'K'], label: 'Recherche globale' },
            { keys: ['G', 'H'], label: 'Accueil' },
            { keys: ['G', 'S'], label: 'Stock' },
            { keys: ['G', 'T'], label: 'Travaux' },
        ]},
        { title: 'Actions', shortcuts: [
            { keys: ['N'], label: 'Nouveau' },
            { keys: ['S'], label: 'Scanner' },
            { keys: ['P'], label: 'Mode présentation' },
        ]},
        { title: 'Général', shortcuts: [
            { keys: ['?'], label: 'Aide' },
            { keys: ['ESC'], label: 'Fermer' },
        ]}
    ];

    return h('div', { className: 'shortcuts-modal', onClick: onClose },
        h('div', { className: 'shortcuts-content', onClick: e => e.stopPropagation() },
            h('div', { className: 'shortcuts-header' },
                h('div', { className: 'shortcuts-title' }, '⌨️ Raccourcis clavier'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'shortcuts-body' },
                sections.map((section, idx) =>
                    h('div', { key: idx, className: 'shortcuts-section' },
                        h('div', { className: 'shortcuts-section-title' }, section.title),
                        section.shortcuts.map((s, sidx) =>
                            h('div', { key: sidx, className: 'shortcut-item' },
                                h('span', { className: 'shortcut-label' }, s.label),
                                h('div', { className: 'shortcut-keys' },
                                    s.keys.map((k, kidx) => h('kbd', { key: kidx }, k))
                                )
                            )
                        )
                    )
                )
            )
        )
    );
};

// Signature Pad
const SignaturePad = ({ onSave, name }) => {
    const canvasRef = React.useRef(null);
    const [isDrawing, setIsDrawing] = React.useState(false);
    const [hasSignature, setHasSignature] = React.useState(false);

    React.useEffect(() => {
        const canvas = canvasRef.current;
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = '#1E293B';
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
    }, []);

    const getPos = e => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        if (e.touches) return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
        return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
    };

    const start = e => {
        e.preventDefault();
        const ctx = canvasRef.current.getContext('2d');
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        setIsDrawing(true);
        setHasSignature(true);
    };

    const draw = e => {
        if (!isDrawing) return;
        e.preventDefault();
        const ctx = canvasRef.current.getContext('2d');
        const pos = getPos(e);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
    };

    const stop = () => setIsDrawing(false);

    const clear = () => {
        const ctx = canvasRef.current.getContext('2d');
        ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
        setHasSignature(false);
    };

    const save = () => {
        if (!hasSignature) return;
        const dataUrl = canvasRef.current.toDataURL('image/png');
        if (onSave) onSave(dataUrl);
    };

    return h('div', { className: 'signature-pad-container' },
        h('div', { className: 'signature-pad-header' },
            h('div', { className: 'signature-pad-title' }, '✍️ Signature'),
            h('div', { className: 'signature-pad-actions' },
                h('button', { className: 'btn btn-ghost btn-sm', onClick: clear }, '🗑️ Effacer'),
                h('button', { className: 'btn btn-primary btn-sm', onClick: save, disabled: !hasSignature }, '✓ Valider')
            )
        ),
        h('div', { className: 'signature-canvas-wrapper' },
            h('canvas', {
                ref: canvasRef, className: 'signature-canvas', width: 600, height: 200,
                onMouseDown: start, onMouseMove: draw, onMouseUp: stop, onMouseLeave: stop,
                onTouchStart: start, onTouchMove: draw, onTouchEnd: stop
            }),
            h('div', { className: 'signature-line' }),
            h('div', { className: 'signature-label' }, name || 'Signature')
        )
    );
};

// ============================================================================
// v5.1 - BARCODE SCANNER PAGE - Scanner code-barres/QR avec caméra
// ============================================================================
const BarcodeScannerPage = ({ data, user, refresh, showToast }) => {
    const [scannerActive, setScannerActive] = useState(false);
    const [scannedResults, setScannedResults] = useState([]);
    const [searchMode, setSearchMode] = useState('stock'); // stock, task, device
    const [lastScanned, setLastScanned] = useState(null);
    const scannerRef = useRef(null);
    const html5QrCodeRef = useRef(null);

    const startScanner = async () => {
        if (!scannerRef.current || html5QrCodeRef.current) return;
        
        try {
            const html5QrCode = new Html5Qrcode("scanner-container");
            html5QrCodeRef.current = html5QrCode;
            
            await html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                    handleScan(decodedText);
                },
                (errorMessage) => {}
            );
            setScannerActive(true);
        } catch (err) {
            console.error("Erreur scanner:", err);
            showToast('Impossible d\'accéder à la caméra', 'error');
        }
    };

    const stopScanner = async () => {
        if (html5QrCodeRef.current) {
            try {
                await html5QrCodeRef.current.stop();
                html5QrCodeRef.current = null;
            } catch (e) {}
        }
        setScannerActive(false);
    };

    useEffect(() => {
        return () => stopScanner();
    }, []);

    const handleScan = (code) => {
        setLastScanned(code);
        let found = null;
        
        if (searchMode === 'stock') {
            found = data.parts.find(p => p.reference === code || p.barcode === code);
            if (found) {
                setScannedResults(prev => [{ type: 'part', data: found, code, time: new Date() }, ...prev.slice(0, 19)]);
                showToast(`Pièce trouvée: ${found.name}`, 'success');
            }
        } else if (searchMode === 'task') {
            found = data.tasks.find(t => t.device_number === code);
            if (found) {
                setScannedResults(prev => [{ type: 'task', data: found, code, time: new Date() }, ...prev.slice(0, 19)]);
                showToast(`Tâche trouvée: ${found.device_number}`, 'success');
            }
        } else if (searchMode === 'device') {
            found = data.devices?.find(d => d.device_number === code);
            if (found) {
                setScannedResults(prev => [{ type: 'device', data: found, code, time: new Date() }, ...prev.slice(0, 19)]);
                showToast(`Appareil trouvé: ${found.device_number}`, 'success');
            }
        }
        
        if (!found) {
            setScannedResults(prev => [{ type: 'unknown', data: null, code, time: new Date() }, ...prev.slice(0, 19)]);
            showToast(`Code non reconnu: ${code}`, 'warning');
        }
    };

    const handleManualInput = (e) => {
        if (e.key === 'Enter' && e.target.value) {
            handleScan(e.target.value);
            e.target.value = '';
        }
    };

    return h('div', { className: 'page-content scanner-page' },
        h('div', { className: 'page-header' },
            h('div', null,
                h('h1', { className: 'page-title' }, '📷 Scanner Code-barres / QR'),
                h('p', { className: 'page-subtitle' }, 'Scannez des pièces, tâches ou appareils')
            )
        ),
        h('div', { className: 'scanner-layout' },
            h('div', { className: 'scanner-main' },
                h('div', { className: 'scanner-mode-selector' },
                    ['stock', 'task', 'device'].map(mode =>
                        h('button', {
                            key: mode,
                            className: `scanner-mode-btn ${searchMode === mode ? 'active' : ''}`,
                            onClick: () => setSearchMode(mode)
                        }, mode === 'stock' ? '📦 Stock' : mode === 'task' ? '🔧 Travaux' : '🏗️ Appareils')
                    )
                ),
                h('div', { className: 'scanner-container-wrapper' },
                    h('div', { id: 'scanner-container', ref: scannerRef, className: 'scanner-viewport' },
                        !scannerActive && h('div', { className: 'scanner-placeholder' },
                            h('div', { className: 'scanner-icon' }, '📷'),
                            h('p', null, 'Cliquez sur "Démarrer" pour activer la caméra')
                        )
                    ),
                    h('div', { className: 'scanner-controls' },
                        !scannerActive ? 
                            h('button', { className: 'btn btn-primary btn-lg', onClick: startScanner }, '▶️ Démarrer le scanner') :
                            h('button', { className: 'btn btn-danger btn-lg', onClick: stopScanner }, '⏹️ Arrêter')
                    )
                ),
                h('div', { className: 'manual-input-section' },
                    h('label', null, 'Ou saisie manuelle :'),
                    h('input', {
                        type: 'text',
                        className: 'form-input',
                        placeholder: 'Entrez le code et appuyez sur Entrée...',
                        onKeyPress: handleManualInput
                    })
                ),
                lastScanned && h('div', { className: 'last-scanned' },
                    h('span', null, 'Dernier scan: '),
                    h('code', null, lastScanned)
                )
            ),
            h('div', { className: 'scanner-results' },
                h('div', { className: 'results-header' },
                    h('h3', null, '📋 Historique des scans'),
                    h('span', { className: 'results-count' }, scannedResults.length + ' résultats')
                ),
                h('div', { className: 'results-list' },
                    scannedResults.length === 0 ?
                        h('div', { className: 'empty-results' }, 'Aucun scan effectué') :
                        scannedResults.map((result, idx) =>
                            h('div', { key: idx, className: `result-item ${result.type}` },
                                h('div', { className: 'result-icon' },
                                    result.type === 'part' ? '📦' : result.type === 'task' ? '🔧' : result.type === 'device' ? '🏗️' : '❓'
                                ),
                                h('div', { className: 'result-info' },
                                    h('div', { className: 'result-code' }, result.code),
                                    result.data && h('div', { className: 'result-name' },
                                        result.type === 'part' ? result.data.name :
                                        result.type === 'task' ? `Tâche: ${result.data.device_number}` :
                                        result.type === 'device' ? `Appareil: ${result.data.device_number}` : 'Non trouvé'
                                    ),
                                    h('div', { className: 'result-time' }, 
                                        new Date(result.time).toLocaleTimeString()
                                    )
                                ),
                                result.data && h('button', { 
                                    className: 'btn btn-ghost btn-sm',
                                    onClick: () => showToast('Détails: ' + JSON.stringify(result.data).slice(0, 100), 'info')
                                }, '👁️')
                            )
                        )
                )
            )
        )
    );
};

// ============================================================================
// v5.1 - AUDIT PAGE - Historique complet des modifications
// ============================================================================
const AuditPage = ({ data, user, refresh, showToast }) => {
    const [auditLogs, setAuditLogs] = useState([]);
    const [loading, setLoading] = useState(true);
    const [filters, setFilters] = useState({ type: 'all', user: 'all', dateRange: 'week' });
    const [searchQuery, setSearchQuery] = useState('');

    useEffect(() => {
        loadAuditLogs();
    }, [filters]);

    const loadAuditLogs = async () => {
        setLoading(true);
        try {
            // Simuler des logs d'audit (en production, utiliser une table audit_logs)
            const logs = [];
            
            // Générer des logs basés sur les données existantes
            data.parts.forEach(part => {
                if (part.updated_at) {
                    logs.push({
                        id: 'part-' + part.id,
                        type: 'stock',
                        action: 'update',
                        entity: 'Pièce: ' + part.name,
                        entityId: part.id,
                        user: part.updated_by || 'Système',
                        timestamp: part.updated_at,
                        details: { reference: part.reference, quantity: part.quantity }
                    });
                }
            });
            
            data.tasks.forEach(task => {
                logs.push({
                    id: 'task-' + task.id,
                    type: 'task',
                    action: task.status === 'termine' ? 'complete' : 'update',
                    entity: 'Tâche: ' + task.device_number,
                    entityId: task.id,
                    user: task.assigned_to || 'Non assigné',
                    timestamp: task.updated_at || task.created_at,
                    details: { status: task.status, type: task.intervention_type }
                });
            });
            
            data.orders.forEach(order => {
                logs.push({
                    id: 'order-' + order.id,
                    type: 'order',
                    action: order.status === 'recu' ? 'receive' : 'create',
                    entity: 'Commande #' + order.id,
                    entityId: order.id,
                    user: order.created_by || 'Système',
                    timestamp: order.created_at,
                    details: { supplier: order.supplier, status: order.status }
                });
            });
            
            // Trier par date décroissante
            logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            setAuditLogs(logs.slice(0, 100));
        } catch (error) {
            console.error('Erreur chargement audit:', error);
        }
        setLoading(false);
    };

    const filteredLogs = auditLogs.filter(log => {
        if (filters.type !== 'all' && log.type !== filters.type) return false;
        if (searchQuery && !log.entity.toLowerCase().includes(searchQuery.toLowerCase())) return false;
        return true;
    });

    const getActionIcon = (action) => {
        switch (action) {
            case 'create': return '➕';
            case 'update': return '✏️';
            case 'delete': return '🗑️';
            case 'complete': return '✅';
            case 'receive': return '📦';
            default: return '📋';
        }
    };

    const getTypeColor = (type) => {
        switch (type) {
            case 'stock': return 'var(--info)';
            case 'task': return 'var(--warning)';
            case 'order': return 'var(--purple)';
            case 'user': return 'var(--success)';
            default: return 'var(--muted)';
        }
    };

    return h('div', { className: 'page-content audit-page' },
        h('div', { className: 'page-header' },
            h('div', null,
                h('h1', { className: 'page-title' }, '📜 Historique & Audit'),
                h('p', { className: 'page-subtitle' }, 'Traçabilité complète des modifications')
            ),
            h('button', { className: 'btn btn-secondary', onClick: loadAuditLogs }, '🔄 Actualiser')
        ),
        h('div', { className: 'audit-filters' },
            h('div', { className: 'filter-group' },
                h('input', {
                    type: 'text',
                    className: 'form-input',
                    placeholder: '🔍 Rechercher...',
                    value: searchQuery,
                    onChange: e => setSearchQuery(e.target.value)
                })
            ),
            h('div', { className: 'filter-group' },
                h('select', {
                    className: 'form-select',
                    value: filters.type,
                    onChange: e => setFilters({ ...filters, type: e.target.value })
                },
                    h('option', { value: 'all' }, 'Tous les types'),
                    h('option', { value: 'stock' }, '📦 Stock'),
                    h('option', { value: 'task' }, '🔧 Tâches'),
                    h('option', { value: 'order' }, '🛒 Commandes'),
                    h('option', { value: 'user' }, '👤 Utilisateurs')
                )
            ),
            h('div', { className: 'filter-group' },
                h('select', {
                    className: 'form-select',
                    value: filters.dateRange,
                    onChange: e => setFilters({ ...filters, dateRange: e.target.value })
                },
                    h('option', { value: 'today' }, "Aujourd'hui"),
                    h('option', { value: 'week' }, 'Cette semaine'),
                    h('option', { value: 'month' }, 'Ce mois'),
                    h('option', { value: 'all' }, 'Tout')
                )
            )
        ),
        h('div', { className: 'audit-stats' },
            h('div', { className: 'audit-stat' },
                h('div', { className: 'audit-stat-value' }, filteredLogs.length),
                h('div', { className: 'audit-stat-label' }, 'Événements')
            ),
            h('div', { className: 'audit-stat' },
                h('div', { className: 'audit-stat-value' }, filteredLogs.filter(l => l.action === 'create').length),
                h('div', { className: 'audit-stat-label' }, 'Créations')
            ),
            h('div', { className: 'audit-stat' },
                h('div', { className: 'audit-stat-value' }, filteredLogs.filter(l => l.action === 'update').length),
                h('div', { className: 'audit-stat-label' }, 'Modifications')
            )
        ),
        h('div', { className: 'audit-timeline' },
            loading ? 
                h('div', { className: 'loading-state' }, 'Chargement...') :
                filteredLogs.length === 0 ?
                    h('div', { className: 'empty-state' }, 'Aucun événement trouvé') :
                    filteredLogs.map((log, idx) =>
                        h('div', { key: log.id, className: 'timeline-item' },
                            h('div', { className: 'timeline-marker', style: { borderColor: getTypeColor(log.type) } },
                                h('span', null, getActionIcon(log.action))
                            ),
                            h('div', { className: 'timeline-content' },
                                h('div', { className: 'timeline-header' },
                                    h('span', { className: 'timeline-entity' }, log.entity),
                                    h('span', { className: 'timeline-badge', style: { background: getTypeColor(log.type) } }, log.type)
                                ),
                                h('div', { className: 'timeline-meta' },
                                    h('span', null, '👤 ' + log.user),
                                    h('span', null, '📅 ' + new Date(log.timestamp).toLocaleString('fr-FR'))
                                ),
                                log.details && h('div', { className: 'timeline-details' },
                                    Object.entries(log.details).map(([key, value]) =>
                                        h('span', { key: key, className: 'detail-tag' }, key + ': ' + value)
                                    )
                                )
                            )
                        )
                    )
        )
    );
};

// ============================================================================
// v5.1 - IMPORT PAGE - Import en masse CSV/Excel
// ============================================================================
const ImportPage = ({ data, user, refresh, showToast }) => {
    const [importType, setImportType] = useState('parts');
    const [file, setFile] = useState(null);
    const [preview, setPreview] = useState([]);
    const [mapping, setMapping] = useState({});
    const [importing, setImporting] = useState(false);
    const [importResults, setImportResults] = useState(null);
    const [dragOver, setDragOver] = useState(false);

    const expectedFields = {
        parts: ['reference', 'name', 'category', 'quantity', 'min_stock', 'price', 'location', 'supplier'],
        tasks: ['device_number', 'address', 'intervention_type', 'description', 'assigned_to', 'status'],
        orders: ['supplier', 'part_reference', 'quantity', 'unit_price', 'status']
    };

    const handleFileDrop = (e) => {
        e.preventDefault();
        setDragOver(false);
        const droppedFile = e.dataTransfer?.files?.[0] || e.target.files?.[0];
        if (droppedFile) {
            processFile(droppedFile);
        }
    };

    const processFile = async (selectedFile) => {
        setFile(selectedFile);
        const extension = selectedFile.name.split('.').pop().toLowerCase();
        
        try {
            if (extension === 'csv') {
                const text = await selectedFile.text();
                parseCSV(text);
            } else if (['xlsx', 'xls'].includes(extension)) {
                const arrayBuffer = await selectedFile.arrayBuffer();
                parseExcel(arrayBuffer);
            } else {
                showToast('Format non supporté. Utilisez CSV ou Excel.', 'error');
            }
        } catch (error) {
            console.error('Erreur lecture fichier:', error);
            showToast('Erreur lors de la lecture du fichier', 'error');
        }
    };

    const parseCSV = (text) => {
        const lines = text.split('\n').filter(l => l.trim());
        if (lines.length < 2) {
            showToast('Le fichier doit contenir au moins un en-tête et une ligne de données', 'error');
            return;
        }
        
        const headers = lines[0].split(';').map(h => h.trim().replace(/"/g, ''));
        const rows = lines.slice(1).map(line => {
            const values = line.split(';').map(v => v.trim().replace(/"/g, ''));
            const row = {};
            headers.forEach((h, i) => row[h] = values[i] || '');
            return row;
        });
        
        setPreview(rows.slice(0, 10));
        autoMap(headers);
    };

    const parseExcel = (arrayBuffer) => {
        if (typeof XLSX === 'undefined') {
            showToast('Librairie Excel non chargée', 'error');
            return;
        }
        
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        
        if (jsonData.length === 0) {
            showToast('Le fichier Excel est vide', 'error');
            return;
        }
        
        const headers = Object.keys(jsonData[0]);
        setPreview(jsonData.slice(0, 10));
        autoMap(headers);
    };

    const autoMap = (headers) => {
        const newMapping = {};
        const fields = expectedFields[importType];
        
        headers.forEach(header => {
            const headerLower = header.toLowerCase();
            const matchedField = fields.find(f => 
                headerLower.includes(f) || f.includes(headerLower)
            );
            if (matchedField) {
                newMapping[header] = matchedField;
            }
        });
        
        setMapping(newMapping);
    };

    const handleImport = async () => {
        if (preview.length === 0) {
            showToast('Aucune donnée à importer', 'error');
            return;
        }
        
        setImporting(true);
        let success = 0, errors = 0;
        
        try {
            for (const row of preview) {
                const mappedData = {};
                Object.entries(mapping).forEach(([source, target]) => {
                    if (target && row[source]) {
                        mappedData[target] = row[source];
                    }
                });
                
                if (Object.keys(mappedData).length > 0) {
                    const { error } = await db.from(importType).insert(mappedData);
                    if (error) errors++;
                    else success++;
                }
            }
            
            setImportResults({ success, errors, total: preview.length });
            if (success > 0) {
                showToast(`${success} éléments importés avec succès`, 'success');
                refresh();
            }
            if (errors > 0) {
                showToast(`${errors} erreurs lors de l'import`, 'warning');
            }
        } catch (error) {
            console.error('Erreur import:', error);
            showToast('Erreur lors de l\'import', 'error');
        }
        
        setImporting(false);
    };

    const resetImport = () => {
        setFile(null);
        setPreview([]);
        setMapping({});
        setImportResults(null);
    };

    return h('div', { className: 'page-content import-page' },
        h('div', { className: 'page-header' },
            h('div', null,
                h('h1', { className: 'page-title' }, '📥 Import en masse'),
                h('p', { className: 'page-subtitle' }, 'Importez des données depuis CSV ou Excel')
            ),
            file && h('button', { className: 'btn btn-secondary', onClick: resetImport }, '🔄 Recommencer')
        ),
        h('div', { className: 'import-type-selector' },
            h('label', null, 'Type de données à importer :'),
            h('div', { className: 'import-type-buttons' },
                [
                    { id: 'parts', label: '📦 Pièces', icon: '📦' },
                    { id: 'tasks', label: '🔧 Tâches', icon: '🔧' },
                    { id: 'orders', label: '🛒 Commandes', icon: '🛒' }
                ].map(type =>
                    h('button', {
                        key: type.id,
                        className: `import-type-btn ${importType === type.id ? 'active' : ''}`,
                        onClick: () => { setImportType(type.id); resetImport(); }
                    }, type.label)
                )
            )
        ),
        !file ? 
            h('div', {
                className: `import-dropzone ${dragOver ? 'drag-over' : ''}`,
                onDragOver: e => { e.preventDefault(); setDragOver(true); },
                onDragLeave: () => setDragOver(false),
                onDrop: handleFileDrop
            },
                h('div', { className: 'dropzone-content' },
                    h('div', { className: 'dropzone-icon' }, '📁'),
                    h('p', { className: 'dropzone-text' }, 'Glissez-déposez votre fichier ici'),
                    h('p', { className: 'dropzone-subtext' }, 'ou'),
                    h('label', { className: 'btn btn-primary' },
                        'Parcourir...',
                        h('input', {
                            type: 'file',
                            accept: '.csv,.xlsx,.xls',
                            style: { display: 'none' },
                            onChange: handleFileDrop
                        })
                    ),
                    h('p', { className: 'dropzone-formats' }, 'Formats supportés: CSV, XLSX, XLS')
                )
            ) :
            h('div', { className: 'import-preview' },
                h('div', { className: 'preview-header' },
                    h('h3', null, '📄 Aperçu: ' + file.name),
                    h('span', { className: 'preview-count' }, preview.length + ' lignes détectées')
                ),
                h('div', { className: 'mapping-section' },
                    h('h4', null, '🔗 Correspondance des colonnes'),
                    h('div', { className: 'mapping-grid' },
                        Object.keys(preview[0] || {}).map(header =>
                            h('div', { key: header, className: 'mapping-row' },
                                h('span', { className: 'mapping-source' }, header),
                                h('span', { className: 'mapping-arrow' }, '→'),
                                h('select', {
                                    className: 'form-select mapping-target',
                                    value: mapping[header] || '',
                                    onChange: e => setMapping({ ...mapping, [header]: e.target.value })
                                },
                                    h('option', { value: '' }, '-- Ignorer --'),
                                    expectedFields[importType].map(f =>
                                        h('option', { key: f, value: f }, f)
                                    )
                                )
                            )
                        )
                    )
                ),
                h('div', { className: 'preview-table-wrapper' },
                    h('table', { className: 'preview-table' },
                        h('thead', null,
                            h('tr', null,
                                Object.keys(preview[0] || {}).map(header =>
                                    h('th', { key: header }, header)
                                )
                            )
                        ),
                        h('tbody', null,
                            preview.slice(0, 5).map((row, idx) =>
                                h('tr', { key: idx },
                                    Object.values(row).map((val, vidx) =>
                                        h('td', { key: vidx }, String(val).slice(0, 30))
                                    )
                                )
                            )
                        )
                    )
                ),
                h('div', { className: 'import-actions' },
                    h('button', {
                        className: 'btn btn-primary btn-lg',
                        onClick: handleImport,
                        disabled: importing || Object.values(mapping).filter(v => v).length === 0
                    }, importing ? '⏳ Import en cours...' : '✅ Lancer l\'import'),
                    h('button', { className: 'btn btn-secondary', onClick: resetImport }, '❌ Annuler')
                ),
                importResults && h('div', { className: 'import-results' },
                    h('div', { className: 'result-stat success' }, '✅ ' + importResults.success + ' importés'),
                    h('div', { className: 'result-stat error' }, '❌ ' + importResults.errors + ' erreurs'),
                    h('div', { className: 'result-stat total' }, '📊 ' + importResults.total + ' total')
                )
            )
    );
};

// ============================================================================
// v5.1 - ALERTS PAGE - Configuration des alertes
// ============================================================================
const AlertsPage = ({ data, user, refresh, showToast }) => {
    const [alerts, setAlerts] = useState([
        { id: 1, name: 'Stock critique', type: 'stock', condition: 'quantity < min_stock', enabled: true, notify: ['email', 'app'] },
        { id: 2, name: 'Tâche urgente', type: 'task', condition: 'priority = urgent', enabled: true, notify: ['app'] },
        { id: 3, name: 'Commande en retard', type: 'order', condition: 'days_since_order > 7', enabled: false, notify: ['email'] },
        { id: 4, name: 'Nouvelle demande', type: 'request', condition: 'status = nouveau', enabled: true, notify: ['app', 'push'] }
    ]);
    const [editingAlert, setEditingAlert] = useState(null);
    const [showNewAlert, setShowNewAlert] = useState(false);

    const toggleAlert = (id) => {
        setAlerts(alerts.map(a => a.id === id ? { ...a, enabled: !a.enabled } : a));
        showToast('Alerte mise à jour', 'success');
    };

    const deleteAlert = (id) => {
        if (confirm('Supprimer cette alerte ?')) {
            setAlerts(alerts.filter(a => a.id !== id));
            showToast('Alerte supprimée', 'success');
        }
    };

    const saveAlert = (alertData) => {
        if (editingAlert) {
            setAlerts(alerts.map(a => a.id === editingAlert.id ? { ...a, ...alertData } : a));
        } else {
            setAlerts([...alerts, { ...alertData, id: Date.now() }]);
        }
        setEditingAlert(null);
        setShowNewAlert(false);
        showToast('Alerte sauvegardée', 'success');
    };

    const getTypeIcon = (type) => {
        switch (type) {
            case 'stock': return '📦';
            case 'task': return '🔧';
            case 'order': return '🛒';
            case 'request': return '📬';
            default: return '🔔';
        }
    };

    const triggeredAlerts = [
        { alert: alerts[0], count: data.parts.filter(p => p.quantity <= (p.min_stock || 0)).length },
        { alert: alerts[1], count: data.tasks.filter(t => t.priority === 'urgent' && t.status !== 'termine').length },
        { alert: alerts[2], count: 0 },
        { alert: alerts[3], count: (data.requests || []).filter(r => r.status === 'nouveau').length }
    ].filter(a => a.count > 0 && a.alert.enabled);

    return h('div', { className: 'page-content alerts-page' },
        h('div', { className: 'page-header' },
            h('div', null,
                h('h1', { className: 'page-title' }, '🔔 Alertes & Notifications'),
                h('p', { className: 'page-subtitle' }, 'Configurez vos règles d\'alerte')
            ),
            h('button', { className: 'btn btn-primary', onClick: () => setShowNewAlert(true) }, '+ Nouvelle alerte')
        ),
        triggeredAlerts.length > 0 && h('div', { className: 'active-alerts' },
            h('div', { className: 'active-alerts-header' },
                h('h3', null, '⚠️ Alertes actives'),
                h('span', { className: 'badge badge-warning' }, triggeredAlerts.reduce((s, a) => s + a.count, 0))
            ),
            h('div', { className: 'active-alerts-list' },
                triggeredAlerts.map((ta, idx) =>
                    h('div', { key: idx, className: 'active-alert-item' },
                        h('span', { className: 'alert-icon' }, getTypeIcon(ta.alert.type)),
                        h('span', { className: 'alert-name' }, ta.alert.name),
                        h('span', { className: 'alert-count' }, ta.count + ' éléments')
                    )
                )
            )
        ),
        h('div', { className: 'alerts-list' },
            h('div', { className: 'alerts-list-header' },
                h('h3', null, '📋 Règles configurées'),
                h('span', null, alerts.filter(a => a.enabled).length + '/' + alerts.length + ' actives')
            ),
            alerts.map(alert =>
                h('div', { key: alert.id, className: `alert-rule-card ${alert.enabled ? 'enabled' : 'disabled'}` },
                    h('div', { className: 'alert-rule-header' },
                        h('div', { className: 'alert-rule-icon' }, getTypeIcon(alert.type)),
                        h('div', { className: 'alert-rule-info' },
                            h('div', { className: 'alert-rule-name' }, alert.name),
                            h('div', { className: 'alert-rule-condition' }, alert.condition)
                        ),
                        h('label', { className: 'toggle-switch' },
                            h('input', {
                                type: 'checkbox',
                                checked: alert.enabled,
                                onChange: () => toggleAlert(alert.id)
                            }),
                            h('span', { className: 'toggle-slider' })
                        )
                    ),
                    h('div', { className: 'alert-rule-channels' },
                        h('span', { className: 'channels-label' }, 'Notifications:'),
                        alert.notify.map(n =>
                            h('span', { key: n, className: 'channel-badge' },
                                n === 'email' ? '📧' : n === 'app' ? '📱' : n === 'push' ? '🔔' : '💬',
                                ' ' + n
                            )
                        )
                    ),
                    h('div', { className: 'alert-rule-actions' },
                        h('button', { className: 'btn btn-ghost btn-sm', onClick: () => setEditingAlert(alert) }, '✏️ Modifier'),
                        h('button', { className: 'btn btn-ghost btn-sm text-danger', onClick: () => deleteAlert(alert.id) }, '🗑️ Supprimer')
                    )
                )
            )
        ),
        (showNewAlert || editingAlert) && h('div', { className: 'modal-overlay', onClick: () => { setShowNewAlert(false); setEditingAlert(null); } },
            h('div', { className: 'modal alert-modal', onClick: e => e.stopPropagation() },
                h(AlertRuleForm, {
                    alert: editingAlert,
                    onSave: saveAlert,
                    onCancel: () => { setShowNewAlert(false); setEditingAlert(null); }
                })
            )
        )
    );
};

const AlertRuleForm = ({ alert, onSave, onCancel }) => {
    const [form, setForm] = useState(alert || {
        name: '', type: 'stock', condition: '', enabled: true, notify: ['app']
    });

    const conditionTemplates = {
        stock: ['quantity < min_stock', 'quantity = 0', 'days_since_update > 30'],
        task: ['status = en-commande', 'priority = urgent', 'days_overdue > 0'],
        order: ['status = en-commande', 'days_since_order > 7', 'total > 1000'],
        request: ['status = nouveau', 'priority = high', 'age_days > 3']
    };

    return h('div', { className: 'alert-form' },
        h('div', { className: 'modal-header' },
            h('h3', null, alert ? '✏️ Modifier l\'alerte' : '➕ Nouvelle alerte'),
            h('button', { className: 'btn btn-ghost', onClick: onCancel }, '✕')
        ),
        h('div', { className: 'modal-body' },
            h('div', { className: 'form-group' },
                h('label', null, 'Nom de l\'alerte'),
                h('input', {
                    type: 'text',
                    className: 'form-input',
                    value: form.name,
                    onChange: e => setForm({ ...form, name: e.target.value }),
                    placeholder: 'Ex: Stock critique'
                })
            ),
            h('div', { className: 'form-group' },
                h('label', null, 'Type'),
                h('select', {
                    className: 'form-select',
                    value: form.type,
                    onChange: e => setForm({ ...form, type: e.target.value })
                },
                    h('option', { value: 'stock' }, '📦 Stock'),
                    h('option', { value: 'task' }, '🔧 Tâches'),
                    h('option', { value: 'order' }, '🛒 Commandes'),
                    h('option', { value: 'request' }, '📬 Demandes')
                )
            ),
            h('div', { className: 'form-group' },
                h('label', null, 'Condition'),
                h('select', {
                    className: 'form-select',
                    value: form.condition,
                    onChange: e => setForm({ ...form, condition: e.target.value })
                },
                    h('option', { value: '' }, '-- Sélectionner --'),
                    conditionTemplates[form.type].map(c =>
                        h('option', { key: c, value: c }, c)
                    )
                )
            ),
            h('div', { className: 'form-group' },
                h('label', null, 'Canaux de notification'),
                h('div', { className: 'checkbox-group' },
                    ['app', 'email', 'push', 'sms'].map(channel =>
                        h('label', { key: channel, className: 'checkbox-label' },
                            h('input', {
                                type: 'checkbox',
                                checked: form.notify.includes(channel),
                                onChange: e => {
                                    if (e.target.checked) {
                                        setForm({ ...form, notify: [...form.notify, channel] });
                                    } else {
                                        setForm({ ...form, notify: form.notify.filter(n => n !== channel) });
                                    }
                                }
                            }),
                            channel === 'app' ? '📱 App' : channel === 'email' ? '📧 Email' : channel === 'push' ? '🔔 Push' : '💬 SMS'
                        )
                    )
                )
            )
        ),
        h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', onClick: onCancel }, 'Annuler'),
            h('button', {
                className: 'btn btn-primary',
                onClick: () => onSave(form),
                disabled: !form.name || !form.condition
            }, 'Sauvegarder')
        )
    );
};

// ============================================================================
// v5.1 - API DOCS PAGE - Documentation API publique
// ============================================================================
const ApiDocsPage = ({ data, user, refresh, showToast }) => {
    const [activeEndpoint, setActiveEndpoint] = useState('parts');
    const [apiKey, setApiKey] = useState('sk_live_xxxxxxxxxxxxxxxxxxxxx');
    const [showKey, setShowKey] = useState(false);

    const endpoints = [
        {
            id: 'parts',
            name: 'Pièces',
            icon: '📦',
            methods: [
                { method: 'GET', path: '/api/parts', desc: 'Liste toutes les pièces' },
                { method: 'GET', path: '/api/parts/:id', desc: 'Récupère une pièce par ID' },
                { method: 'POST', path: '/api/parts', desc: 'Crée une nouvelle pièce' },
                { method: 'PUT', path: '/api/parts/:id', desc: 'Met à jour une pièce' },
                { method: 'DELETE', path: '/api/parts/:id', desc: 'Supprime une pièce' }
            ]
        },
        {
            id: 'tasks',
            name: 'Tâches',
            icon: '🔧',
            methods: [
                { method: 'GET', path: '/api/tasks', desc: 'Liste toutes les tâches' },
                { method: 'GET', path: '/api/tasks/:id', desc: 'Récupère une tâche par ID' },
                { method: 'POST', path: '/api/tasks', desc: 'Crée une nouvelle tâche' },
                { method: 'PATCH', path: '/api/tasks/:id/status', desc: 'Met à jour le statut' }
            ]
        },
        {
            id: 'orders',
            name: 'Commandes',
            icon: '🛒',
            methods: [
                { method: 'GET', path: '/api/orders', desc: 'Liste toutes les commandes' },
                { method: 'POST', path: '/api/orders', desc: 'Crée une commande' },
                { method: 'PATCH', path: '/api/orders/:id/receive', desc: 'Marque comme reçue' }
            ]
        },
        {
            id: 'stock',
            name: 'Mouvements Stock',
            icon: '📊',
            methods: [
                { method: 'GET', path: '/api/stock/movements', desc: 'Historique des mouvements' },
                { method: 'POST', path: '/api/stock/in', desc: 'Entrée de stock' },
                { method: 'POST', path: '/api/stock/out', desc: 'Sortie de stock' }
            ]
        },
        {
            id: 'webhooks',
            name: 'Webhooks',
            icon: '🔗',
            methods: [
                { method: 'GET', path: '/api/webhooks', desc: 'Liste les webhooks configurés' },
                { method: 'POST', path: '/api/webhooks', desc: 'Crée un nouveau webhook' },
                { method: 'DELETE', path: '/api/webhooks/:id', desc: 'Supprime un webhook' }
            ]
        }
    ];

    const codeExamples = {
        parts: `// Récupérer toutes les pièces
const response = await fetch('https://api.stockapp.fr/api/parts', {
  headers: {
    'Authorization': 'Bearer ${apiKey}',
    'Content-Type': 'application/json'
  }
});
const parts = await response.json();

// Créer une nouvelle pièce
const newPart = await fetch('https://api.stockapp.fr/api/parts', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ${apiKey}',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    reference: 'REF-001',
    name: 'Nouvelle pièce',
    category: 'Électrique',
    quantity: 10,
    min_stock: 2
  })
});`,
        tasks: `// Récupérer les tâches en cours
const tasks = await fetch('https://api.stockapp.fr/api/tasks?status=en-cours', {
  headers: { 'Authorization': 'Bearer ${apiKey}' }
}).then(r => r.json());

// Mettre à jour le statut d'une tâche
await fetch('https://api.stockapp.fr/api/tasks/123/status', {
  method: 'PATCH',
  headers: {
    'Authorization': 'Bearer ${apiKey}',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ status: 'termine' })
});`,
        webhooks: `// Configurer un webhook pour les alertes stock
await fetch('https://api.stockapp.fr/api/webhooks', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer ${apiKey}',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    url: 'https://votre-serveur.com/webhook',
    events: ['stock.low', 'order.created'],
    secret: 'votre_secret_webhook'
  })
});`
    };

    const generateNewKey = () => {
        const newKey = 'sk_live_' + Math.random().toString(36).substr(2, 24);
        setApiKey(newKey);
        showToast('Nouvelle clé API générée', 'success');
    };

    const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text);
        showToast('Copié dans le presse-papier', 'success');
    };

    return h('div', { className: 'page-content api-docs-page' },
        h('div', { className: 'page-header' },
            h('div', null,
                h('h1', { className: 'page-title' }, '🔌 API & Intégrations'),
                h('p', { className: 'page-subtitle' }, 'Documentation de l\'API REST StockApp')
            )
        ),
        h('div', { className: 'api-key-section' },
            h('div', { className: 'api-key-header' },
                h('h3', null, '🔑 Clé API'),
                h('p', null, 'Utilisez cette clé pour authentifier vos requêtes')
            ),
            h('div', { className: 'api-key-display' },
                h('code', { className: 'api-key-value' }, showKey ? apiKey : '••••••••••••••••••••••••'),
                h('button', { className: 'btn btn-ghost btn-sm', onClick: () => setShowKey(!showKey) },
                    showKey ? '👁️ Masquer' : '👁️ Afficher'
                ),
                h('button', { className: 'btn btn-ghost btn-sm', onClick: () => copyToClipboard(apiKey) }, '📋 Copier'),
                h('button', { className: 'btn btn-ghost btn-sm', onClick: generateNewKey }, '🔄 Régénérer')
            ),
            h('div', { className: 'api-key-warning' },
                '⚠️ Ne partagez jamais votre clé API. Régénérez-la si elle est compromise.'
            )
        ),
        h('div', { className: 'api-layout' },
            h('div', { className: 'api-sidebar' },
                h('h4', null, 'Endpoints'),
                endpoints.map(ep =>
                    h('div', {
                        key: ep.id,
                        className: `api-nav-item ${activeEndpoint === ep.id ? 'active' : ''}`,
                        onClick: () => setActiveEndpoint(ep.id)
                    },
                        h('span', null, ep.icon),
                        h('span', null, ep.name)
                    )
                )
            ),
            h('div', { className: 'api-content' },
                endpoints.filter(ep => ep.id === activeEndpoint).map(ep =>
                    h('div', { key: ep.id, className: 'endpoint-detail' },
                        h('div', { className: 'endpoint-header' },
                            h('h2', null, ep.icon + ' ' + ep.name),
                            h('p', null, 'Endpoints disponibles pour la gestion des ' + ep.name.toLowerCase())
                        ),
                        h('div', { className: 'endpoint-methods' },
                            ep.methods.map((m, idx) =>
                                h('div', { key: idx, className: 'method-item' },
                                    h('span', { className: `method-badge ${m.method.toLowerCase()}` }, m.method),
                                    h('code', { className: 'method-path' }, m.path),
                                    h('span', { className: 'method-desc' }, m.desc)
                                )
                            )
                        ),
                        codeExamples[ep.id] && h('div', { className: 'code-example' },
                            h('div', { className: 'code-header' },
                                h('span', null, '💻 Exemple de code'),
                                h('button', {
                                    className: 'btn btn-ghost btn-sm',
                                    onClick: () => copyToClipboard(codeExamples[ep.id])
                                }, '📋 Copier')
                            ),
                            h('pre', { className: 'code-block' },
                                h('code', null, codeExamples[ep.id])
                            )
                        )
                    )
                )
            )
        ),
        h('div', { className: 'api-footer' },
            h('div', { className: 'rate-limits' },
                h('h4', null, '⚡ Limites de requêtes'),
                h('p', null, '• 1000 requêtes/minute pour les endpoints de lecture'),
                h('p', null, '• 100 requêtes/minute pour les endpoints d\'écriture'),
                h('p', null, '• Les webhooks sont déclenchés en temps réel')
            ),
            h('div', { className: 'api-support' },
                h('h4', null, '💬 Support'),
                h('p', null, 'Besoin d\'aide ? Contactez api-support@stockapp.fr')
            )
        )
    );
};

// ============================================================================
// v5.1 - EXPORT EXCEL UTILITY
// ============================================================================
const exportToExcel = (data, filename, sheetName = 'Data') => {
    if (typeof XLSX === 'undefined') {
        console.error('SheetJS non chargé');
        return false;
    }
    
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    XLSX.writeFile(wb, filename + '.xlsx');
    return true;
};

const ExportButton = ({ data, filename, label, type = 'excel' }) => {
    const [exporting, setExporting] = useState(false);

    const handleExport = async () => {
        setExporting(true);
        try {
            if (type === 'excel') {
                exportToExcel(data, filename);
            } else if (type === 'csv') {
                const csv = data.map(row => Object.values(row).join(';')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + '.csv';
                a.click();
            }
        } catch (error) {
            console.error('Erreur export:', error);
        }
        setExporting(false);
    };

    return h('button', {
        className: 'btn btn-secondary btn-sm',
        onClick: handleExport,
        disabled: exporting
    }, exporting ? '⏳' : (type === 'excel' ? '📊' : '📄'), ' ', label || 'Exporter');
};

// Offline Banner
const OfflineBanner = ({ isOnline }) => {
    if (isOnline) return null;
    return h('div', { className: 'offline-banner' },
        h('span', null, '📡'),
        h('span', null, 'Mode hors ligne - Les modifications seront synchronisées')
    );
};

const App = () => {
    // v5.0 - Nouveaux états
    const [showCommandPalette, setShowCommandPalette] = useState(false);
    const [showPresentationMode, setShowPresentationMode] = useState(false);
    const [showShortcutsHelp, setShowShortcutsHelp] = useState(false);
    const [isOnline, setIsOnline] = useState(navigator.onLine);
    const { theme, toggleTheme } = useTheme();
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
    const [sidebarOpen, setSidebarOpen] = useState(false);
    const [currentPage, setCurrentPage] = useState('dashboard');
    const [toasts, setToasts] = useState([]);
    const [showNotificationsDropdown, setShowNotificationsDropdown] = useState(false);
    const [realtimeStatus, setRealtimeStatus] = useState('connecting');
    const [data, setData] = useState({ parts: [], tasks: [], orders: [], users: [], devices: [], requests: [], categories: [], partRequests: [], stockMovements: [] });
    
    // v5.4 - Nouveaux états pour fonctionnalités avancées
    const [showChatPanel, setShowChatPanel] = useState(false);
    const [showNotificationSettings, setShowNotificationSettings] = useState(false);
    const [showOCRImport, setShowOCRImport] = useState(false);
    const [showEnhancedPresentation, setShowEnhancedPresentation] = useState(false);
    const [chatUnreadCount, setChatUnreadCount] = useState(0);
    
    // v5.5 - Nouveaux états pour fonctionnalités avancées
    const [showThemeCustomizer, setShowThemeCustomizer] = useState(false);
    const [showRolesManager, setShowRolesManager] = useState(false);
    const [showShortcutsManager, setShowShortcutsManager] = useState(false);
    const [showNFCInventory, setShowNFCInventory] = useState(false);
    const [showVideoCall, setShowVideoCall] = useState(false);
    const [isIncomingVideoCall, setIsIncomingVideoCall] = useState(false);
    const [videoCallTarget, setVideoCallTarget] = useState(null);
    const [showWidgetPicker, setShowWidgetPicker] = useState(false);
    const [showPhotoAnnotator, setShowPhotoAnnotator] = useState(false);
    const [photoToAnnotate, setPhotoToAnnotate] = useState(null);
    
    // v5.7 - États pour nouvelles fonctionnalités
    const [showAuditLog, setShowAuditLog] = useState(false);
    const [showRouteOptimizer, setShowRouteOptimizer] = useState(false);
    const [routeOptimizerTasks, setRouteOptimizerTasks] = useState([]);
    const [showAutoReports, setShowAutoReports] = useState(false);
    const [showChatPanelNew, setShowChatPanelNew] = useState(false);
    const [chatTaskId, setChatTaskId] = useState(null);
    
    // v5.8 - États HMI avancé
    const [showThemeSelectorV58, setShowThemeSelectorV58] = useState(false);
    const [showPDFTemplates, setShowPDFTemplates] = useState(false);
    const [pdfTemplateCategory, setPdfTemplateCategory] = useState('stock');
    const [showNotificationCenter, setShowNotificationCenter] = useState(false);
    const [quickActionMenu, setQuickActionMenu] = useState({ isOpen: false, position: null, type: null, item: null });
    const [selectedItems, setSelectedItems] = useState([]);
    const [currentView, setCurrentView] = useState('table');
    
    // v5.8 - Chat WhatsApp unifié
    const [showChatWhatsApp, setShowChatWhatsApp] = useState(false);
    
    // v5.8 - État pour forcer re-render quand le thème change
    const [themeVersion, setThemeVersion] = useState(0);
    
    // v5.8 - Split View
    const [splitViewLayout, setSplitViewLayout] = useState(SplitViewService.currentLayout);
    const [splitViewConfig, setSplitViewConfig] = useState(SplitViewService.getConfig());
    
    // v5.5 - Initialiser le thème au démarrage
    useEffect(() => {
        const activeThemeId = ThemeCustomizer.getActiveThemeId();
        ThemeCustomizer.applyTheme(activeThemeId);
    }, []);
    
    // v5.8 - Écouter les changements de thème pour forcer le re-render
    useEffect(() => {
        const handleThemeChange = () => {
            setThemeVersion(v => v + 1);
        };
        window.addEventListener('theme-changed', handleThemeChange);
        return () => window.removeEventListener('theme-changed', handleThemeChange);
    }, []);
    
    // v5.5 - Écoute des événements pour ouvrir les modals
    useEffect(() => {
        const handleOpenNFC = () => setShowNFCInventory(true);
        const handleOpenVideoCall = (e) => { 
            console.log('[VideoCall] Event reçu:', e.detail);
            if (!e.detail || !e.detail.id) {
                console.error('[VideoCall] Utilisateur cible invalide:', e.detail);
                showToast && showToast('Impossible d\'appeler: utilisateur non trouvé', 'error');
                return;
            }
            setVideoCallTarget(e.detail); 
            setIsIncomingVideoCall(false); // C'est un appel sortant
            setShowVideoCall(true); 
        };
        const handleOpenThemeCustomizer = () => setShowThemeCustomizer(true);
        const handleOpenRolesManager = () => setShowRolesManager(true);
        const handleOpenShortcutsManager = () => setShowShortcutsManager(true);
        const handleOpenWidgetPicker = () => setShowWidgetPicker(true);
        const handleOpenPhotoAnnotator = (e) => { 
            console.log('[PhotoAnnotator] Event reçu:', e.detail);
            setPhotoToAnnotate(e.detail); 
            setShowPhotoAnnotator(true); 
        };
        const handleStockMovementCreated = async (e) => {
            console.log('[App] Nouveau mouvement stock:', e.detail);
            // Rafraîchir les mouvements de stock
            if (typeof db !== 'undefined' && db !== null) {
                try {
                    const { data: mvts } = await db.from('stock_withdrawals').select('*').order('withdrawn_at', { ascending: false }).limit(1000);
                    setData(prev => ({ ...prev, stockMovements: mvts || [] }));
                    console.log('[App] Mouvements rafraîchis:', mvts?.length);
                } catch (e) {
                    console.log('[App] Erreur refresh mouvements:', e);
                }
            }
        };
        
        window.addEventListener('open-nfc-inventory', handleOpenNFC);
        window.addEventListener('open-video-call', handleOpenVideoCall);
        window.addEventListener('open-theme-customizer', handleOpenThemeCustomizer);
        window.addEventListener('open-roles-manager', handleOpenRolesManager);
        window.addEventListener('open-shortcuts-manager', handleOpenShortcutsManager);
        window.addEventListener('open-widget-picker', handleOpenWidgetPicker);
        window.addEventListener('open-photo-annotator', handleOpenPhotoAnnotator);
        window.addEventListener('stock-movement-created', handleStockMovementCreated);
        
        // v5.7 - Nouveaux événements
        const handleOpenAuditLog = () => setShowAuditLog(true);
        const handleOpenAutoReports = () => setShowAutoReports(true);
        const handleOpenChat = (e) => { setShowChatWhatsApp(true); };
        const handleOpenRouteOptimizer = (e) => { setRouteOptimizerTasks(e?.detail?.tasks || []); setShowRouteOptimizer(true); };
        const handleShowToast = (e) => { if (e.detail) showToast(e.detail.message, e.detail.type); };
        
        window.addEventListener('open-audit-log', handleOpenAuditLog);
        window.addEventListener('open-auto-reports', handleOpenAutoReports);
        window.addEventListener('open-chat', handleOpenChat);
        window.addEventListener('open-route-optimizer', handleOpenRouteOptimizer);
        window.addEventListener('show-toast', handleShowToast);
        
        return () => {
            window.removeEventListener('open-nfc-inventory', handleOpenNFC);
            window.removeEventListener('open-video-call', handleOpenVideoCall);
            window.removeEventListener('open-theme-customizer', handleOpenThemeCustomizer);
            window.removeEventListener('open-roles-manager', handleOpenRolesManager);
            window.removeEventListener('open-shortcuts-manager', handleOpenShortcutsManager);
            window.removeEventListener('open-widget-picker', handleOpenWidgetPicker);
            window.removeEventListener('open-photo-annotator', handleOpenPhotoAnnotator);
            window.removeEventListener('stock-movement-created', handleStockMovementCreated);
            window.removeEventListener('open-audit-log', handleOpenAuditLog);
            window.removeEventListener('open-auto-reports', handleOpenAutoReports);
            window.removeEventListener('open-chat', handleOpenChat);
            window.removeEventListener('open-route-optimizer', handleOpenRouteOptimizer);
            window.removeEventListener('show-toast', handleShowToast);
        };
    }, []);
    
    // v5.4 - Charger le compteur de messages non lus avec refresh
    useEffect(() => {
        if (!user?.id) return;
        
        // Fonction de mise à jour du compteur
        const updateUnreadCount = async () => {
            try {
                // Essayer d'abord via Supabase
                if (typeof db !== 'undefined' && db !== null) {
                    const { data, error } = await db.from('chat_messages')
                        .select('id', { count: 'exact' })
                        .or(`conversation_id.ilike.%${user.id}%`)
                        .neq('sender_id', user.id)
                        .eq('read', false);
                    
                    if (!error && data) {
                        const count = data.length;
                        console.log('[Chat] Messages non lus (Supabase):', count);
                        setChatUnreadCount(count);
                        return;
                    }
                }
                // Fallback localStorage
                const count = ChatService.getUnreadCount(user.id);
                setChatUnreadCount(count);
            } catch (e) {
                // Fallback silencieux
                const count = ChatService.getUnreadCount(user.id);
                setChatUnreadCount(count);
            }
        };
        
        // Mise à jour initiale
        updateUnreadCount();
        
        // Mise à jour toutes les 10 secondes
        const interval = setInterval(updateUnreadCount, 10000);
        
        // Écouter l'événement de nouveau message
        const handleNewMessage = () => updateUnreadCount();
        window.addEventListener('chat-message-received', handleNewMessage);
        
        return () => {
            clearInterval(interval);
            window.removeEventListener('chat-message-received', handleNewMessage);
        };
    }, [user?.id]);
    
    // v5.0 - Détection online/offline
    useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
        };
    }, []);

    // v5.5 - Raccourcis clavier globaux avec ShortcutsSystem
    useEffect(() => {
        let keyBuffer = [];
        let keyTimeout = null;
        
        const executeAction = (action) => {
            switch(action) {
                case 'openSearch': setShowCommandPalette(true); break;
                case 'newTask': setCurrentPage('tasks'); showToast('Créer une nouvelle tâche', 'info'); break;
                case 'newOrder': setCurrentPage('orders'); showToast('Créer une nouvelle commande', 'info'); break;
                case 'gotoDashboard': setCurrentPage('dashboard'); break;
                case 'gotoStock': setCurrentPage('stock'); break;
                case 'gotoTasks': setCurrentPage('tasks'); break;
                case 'gotoOrders': setCurrentPage('orders'); break;
                case 'gotoPlanning': setCurrentPage('planning'); break;
                case 'gotoMap': setCurrentPage('map'); break;
                case 'gotoAI': setCurrentPage('ai'); break;
                case 'showHelp': setShowShortcutsHelp(true); break;
                case 'toggleTheme': toggleTheme(); break;
                case 'toggleSidebar': setSidebarCollapsed(prev => !prev); break;
                case 'refresh': loadData(); showToast('Données actualisées'); break;
                case 'closeModal': 
                    setShowCommandPalette(false); 
                    setShowPresentationMode(false); 
                    setShowShortcutsHelp(false);
                    setShowThemeCustomizer(false);
                    setShowRolesManager(false);
                    setShowShortcutsManager(false);
                    setShowWidgetPicker(false);
                    setShowPhotoAnnotator(false);
                    break;
                case 'startPresentation': setShowEnhancedPresentation(true); break;
                default: console.log('Action non implémentée:', action);
            }
        };
        
        const handleKeyDown = (e) => {
            // Ignorer si on est dans un champ de saisie
            if (e.target.matches('input, textarea, [contenteditable]')) {
                if (e.key === 'Escape') {
                    e.target.blur();
                }
                return;
            }
            
            // Construire la combinaison de touches
            const keyParts = [];
            if (e.ctrlKey || e.metaKey) keyParts.push('Ctrl');
            if (e.shiftKey) keyParts.push('Shift');
            if (e.altKey) keyParts.push('Alt');
            
            const key = e.key.length === 1 ? e.key.toUpperCase() : e.key;
            if (!['Control', 'Shift', 'Alt', 'Meta'].includes(e.key)) {
                keyParts.push(key);
            }
            
            // Buffer pour les séquences (G puis D)
            if (keyParts.length === 1 && keyParts[0].length === 1) {
                keyBuffer.push(keyParts[0]);
                clearTimeout(keyTimeout);
                keyTimeout = setTimeout(() => { keyBuffer = []; }, 500);
            }
            
            // Chercher une correspondance avec les raccourcis
            const shortcuts = ShortcutsSystem.getAllShortcuts();
            
            for (const shortcut of shortcuts) {
                    // Vérifier séquence (ex: ['G', 'D'])
                    if (shortcut.keys.length === 2 && 
                        shortcut.keys.every(k => k.length === 1) &&
                        keyBuffer.length >= 2 &&
                        keyBuffer[keyBuffer.length - 2] === shortcut.keys[0] &&
                        keyBuffer[keyBuffer.length - 1] === shortcut.keys[1]) {
                        e.preventDefault();
                        executeAction(shortcut.action);
                        keyBuffer = [];
                        return;
                    }
                    
                    // Vérifier combinaison (ex: ['Ctrl', 'K'])
                    if (keyParts.length === shortcut.keys.length && 
                        keyParts.every(k => shortcut.keys.includes(k))) {
                        e.preventDefault();
                        executeAction(shortcut.action);
                        return;
                    }
                }
            
            // Fallback pour les raccourcis de base
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                setShowCommandPalette(true);
            }
            if (e.key === '?' && !e.shiftKey) {
                e.preventDefault();
                setShowShortcutsHelp(true);
            }
            if (e.key === 'Escape') {
                executeAction('closeModal');
            }
        };
        
        window.addEventListener('keydown', handleKeyDown);
        return () => {
            window.removeEventListener('keydown', handleKeyDown);
            clearTimeout(keyTimeout);
        };
    }, []);

    // Hook notifications
    const { 
        notifications, 
        unreadCount, 
        loading: notificationsLoading, 
        markAsRead, 
        markAllAsRead, 
        deleteNotification 
    } = useNotifications(user?.id);
    
    const showToast = (message, type = 'success') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
    };
    
    const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
    
    // Fonction pour gérer les changements temps réel de façon optimisée
    const handleRealtimeChange = useCallback((prevData, tableName, payload) => {
        const { eventType, new: newRecord, old: oldRecord } = payload;
        
        // Copie des données actuelles
        const currentItems = [...(prevData[tableName] || [])];
        
        switch (eventType) {
            case 'INSERT':
                // Ajouter le nouvel enregistrement au début
                return {
                    ...prevData,
                    [tableName]: [newRecord, ...currentItems]
                };
                
            case 'UPDATE':
                // Mettre à jour l'enregistrement existant
                const updateIndex = currentItems.findIndex(item => item.id === newRecord.id);
                if (updateIndex !== -1) {
                    currentItems[updateIndex] = newRecord;
                }
                return {
                    ...prevData,
                    [tableName]: currentItems
                };
                
            case 'DELETE':
                // Supprimer l'enregistrement
                return {
                    ...prevData,
                    [tableName]: currentItems.filter(item => item.id !== oldRecord.id)
                };
                
            default:
                return prevData;
        }
    }, []);
    
    // Navigation depuis une notification
    const handleNotificationNavigate = (actionUrl) => {
        if (actionUrl) {
            // Extraire la page depuis l'URL (/tasks, /stock, etc.)
            const page = actionUrl.replace('/', '').split('?')[0];
            if (page && ['dashboard', 'stock', 'tasks', 'orders', 'timesheet', 'planning', 'ged', 'requests', 'miseenservice'].includes(page)) {
                setCurrentPage(page);
            }
        }
        setShowNotificationsDropdown(false);
    };
    
    const loadData = async () => {
        console.log('Loading data...');
        try {
            // ==================== TABLES PRINCIPALES ====================
            const partsRes = await db.from('parts').select('*').order('name');
            console.log('Parts:', partsRes);
            
            const tasksRes = await db.from('tasks').select('*').order('created_at', { ascending: false });
            console.log('Tasks:', tasksRes);
            
            const ordersRes = await db.from('orders').select('*').order('created_at', { ascending: false });
            console.log('Orders:', ordersRes);
            
            // ==================== TABLES OPTIONNELLES ====================
            let devicesRes = { data: [] };
            try { devicesRes = await db.from('commissioning_devices').select('*').order('device_number'); } catch(e) { console.log('Commissioning devices table not found'); }
            console.log('Devices:', devicesRes);
            
            let requestsRes = { data: [] };
            try { requestsRes = await db.from('requests').select('*').order('created_at', { ascending: false }); } catch(e) { console.log('Requests table not found'); }
            console.log('Requests:', requestsRes);
            
            let categoriesRes = { data: [] };
            try { categoriesRes = await db.from('event_categories').select('*').order('name'); } catch(e) { console.log('Categories table not found'); }
            console.log('Categories:', categoriesRes);
            
            let partRequestsRes = { data: [] };
            try { partRequestsRes = await db.from('wishlist').select('*').order('created_at', { ascending: false }); } catch(e) { console.log('Wishlist table not found'); }
            console.log('Part Requests:', partRequestsRes);
            
            let stockMovementsRes = { data: [] };
            try { 
                stockMovementsRes = await db.from('stock_withdrawals').select('*').order('withdrawn_at', { ascending: false }).limit(1000); 
                if (stockMovementsRes.error) {
                    console.error('Stock withdrawals error:', stockMovementsRes.error);
                } else {
                    console.log('Stock Movements chargés:', stockMovementsRes.data?.length || 0);
                }
            } catch(e) { 
                console.log('Stock withdrawals table not found:', e.message);
            }
            
            let profilesRes = { data: [] };
            try { profilesRes = await db.from('profiles').select('*'); } catch(e) { console.log('Profiles table not found'); }
            console.log('Profiles:', profilesRes);
            
            // ==================== PLANNING & FEUILLES D'HEURES ====================
            let planningEventsRes = { data: [] };
            try { planningEventsRes = await db.from('planning_events').select('*').order('date', { ascending: false }); } catch(e) { console.log('Planning events table not found'); }
            console.log('Planning Events:', planningEventsRes);
            
            let timesheetsRes = { data: [] };
            try { timesheetsRes = await db.from('timesheets').select('*').order('created_at', { ascending: false }); } catch(e) { console.log('Timesheets table not found'); }
            console.log('Timesheets:', timesheetsRes);
            
            let timesheetDaysRes = { data: [] };
            try { timesheetDaysRes = await db.from('timesheet_days').select('*').order('date', { ascending: false }); } catch(e) { console.log('Timesheet days table not found'); }
            console.log('Timesheet Days:', timesheetDaysRes);
            
            // ==================== RAPPORTS MES ====================
            let inspectionReportsRes = { data: [] };
            try { inspectionReportsRes = await db.from('inspection_reports').select('*').order('created_at', { ascending: false }); } catch(e) { console.log('Inspection reports table not found'); }
            console.log('Inspection Reports:', inspectionReportsRes);
            
            let bcReportsRes = { data: [] };
            try { bcReportsRes = await db.from('bc_reports').select('*').order('created_at', { ascending: false }); } catch(e) { console.log('BC reports table not found'); }
            console.log('BC Reports:', bcReportsRes);
            
            // ==================== PARAMÈTRES ====================
            let settingsRes = { data: [] };
            try { settingsRes = await db.from('settings').select('*'); } catch(e) { console.log('Settings table not found'); }
            console.log('Settings:', settingsRes);
            
            let notificationsRes = { data: [] };
            try { notificationsRes = await db.from('notifications').select('*').order('created_at', { ascending: false }).limit(100); } catch(e) { console.log('Notifications table not found'); }
            console.log('Notifications:', notificationsRes);
            
            // ==================== PROGILIFT - ASCENSEURS ====================
            let progiliftAscenseursRes = { data: [] };
            try { 
                // Essayer d'abord la vue qui joint les données
                progiliftAscenseursRes = await db.from('v_progilift_ascenseurs').select('*').order('code');
                if (progiliftAscenseursRes.error) {
                    console.log('Vue v_progilift_ascenseurs non disponible, essai table directe');
                    // Fallback sur la table directe
                    progiliftAscenseursRes = await db.from('progilift_ascenseurs').select('*').order('code');
                }
            } catch(e) { 
                console.log('Progilift ascenseurs not found, trying direct table');
                try {
                    progiliftAscenseursRes = await db.from('progilift_ascenseurs').select('*').order('code');
                } catch(e2) {
                    console.log('Progilift ascenseurs table not found');
                }
            }
            console.log('Progilift Ascenseurs:', progiliftAscenseursRes?.data?.length || 0, 'enregistrements');
            
            // ==================== PROGILIFT - CONTRATS ====================
            let progiliftContratsRes = { data: [] };
            try { 
                progiliftContratsRes = await db.from('progilift_contrats').select('*').order('numero');
            } catch(e) { console.log('Progilift contrats table not found'); }
            console.log('Progilift Contrats:', progiliftContratsRes?.data?.length || 0, 'enregistrements');
            
            // ==================== PROGILIFT - CLIENTS ====================
            let progiliftClientsRes = { data: [] };
            try { 
                progiliftClientsRes = await db.from('progilift_clients').select('*').order('nom');
            } catch(e) { console.log('Progilift clients table not found'); }
            console.log('Progilift Clients:', progiliftClientsRes?.data?.length || 0, 'enregistrements');
            
            const newData = {
                parts: partsRes?.data || [],
                tasks: tasksRes?.data || [],
                orders: ordersRes?.data || [],
                users: profilesRes?.data || [],
                devices: devicesRes?.data || [],
                requests: requestsRes?.data || [],
                categories: categoriesRes?.data || [],
                partRequests: partRequestsRes?.data || [],
                stockMovements: stockMovementsRes?.data || [],
                planningEvents: planningEventsRes?.data || [],
                timesheets: timesheetsRes?.data || [],
                timesheetDays: timesheetDaysRes?.data || [],
                inspectionReports: inspectionReportsRes?.data || [],
                bcReports: bcReportsRes?.data || [],
                settings: settingsRes?.data || [],
                notifications: notificationsRes?.data || [],
                // Données Progilift
                progilift_ascenseurs: progiliftAscenseursRes?.data || [],
                progilift_contrats: progiliftContratsRes?.data || [],
                progilift_clients: progiliftClientsRes?.data || []
            };
            console.log('Final data:', newData);
            setData(newData);
        } catch (err) {
            console.error('Error loading data:', err);
        }
    };
    
    useEffect(() => {
        const checkAuth = async () => {
            const { data: { session } } = await db.auth.getSession();
            if (session?.user) {
                // Essayer de récupérer le profil depuis la table 'profiles'
                let profile = null;
                try {
                    const { data: profileData } = await db.from('profiles').select('*').eq('id', session.user.id).single();
                    if (profileData) profile = profileData;
                } catch (e) {
                    console.log('No profiles table or no profile found');
                }
                
                // Si pas de profil, utiliser les métadonnées Supabase
                if (!profile) {
                    const metadata = session.user.user_metadata || {};
                    profile = {
                        id: session.user.id,
                        email: session.user.email,
                        first_name: metadata.first_name || metadata.name || session.user.email.split('@')[0],
                        last_name: metadata.last_name || '',
                        role: metadata.role || 'admin' // Par défaut admin pour le premier utilisateur
                    };
                }
                
                console.log('User profile:', profile);
                setUser(profile);
                await loadData();
            }
            setLoading(false);
            document.getElementById('loading').style.display = 'none';
        };
        checkAuth();
        
        // Setup realtime subscriptions - 5 CANAUX avec toutes les tables (6 tables par canal max)
        
        // Canal 1: Stock & Commandes (6 tables)
        const channel1 = db.channel('realtime-stock')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'parts' }, (payload) => {
                console.log('🔄 RT parts:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'parts', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'stock_withdrawals' }, (payload) => {
                console.log('🔄 RT stock_withdrawals:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'stockMovements', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'wishlist' }, (payload) => {
                console.log('🔄 RT wishlist:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'partRequests', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
                console.log('🔄 RT orders:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'orders', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'archived_orders' }, (payload) => {
                console.log('🔄 RT archived_orders:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'archivedOrders', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'categories' }, (payload) => {
                console.log('🔄 RT categories:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'categories', payload));
            })
            .subscribe((status, err) => {
                console.log('📡 Canal 1 (Stock):', status, err ? err.message : '');
                if (status === 'SUBSCRIBED') {
                    setRealtimeStatus('connected');
                } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                    setRealtimeStatus('disconnected');
                }
            });
        
        // Canal 2: Travaux & Tâches (6 tables)
        const channel2 = db.channel('realtime-tasks')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, (payload) => {
                console.log('🔄 RT tasks:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'tasks', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'task_photos' }, (payload) => {
                console.log('🔄 RT task_photos:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'taskPhotos', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'archived_tasks' }, (payload) => {
                console.log('🔄 RT archived_tasks:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'archivedTasks', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'requests' }, (payload) => {
                console.log('🔄 RT requests:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'requests', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'request_comments' }, (payload) => {
                console.log('🔄 RT request_comments:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'requestComments', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'documents' }, (payload) => {
                console.log('🔄 RT documents:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'documents', payload));
            })
            .subscribe((status) => {
                console.log('📡 Canal 2 (Tasks):', status);
            });
        
        // Canal 3: Notifications & Users (6 tables)
        const channel3 = db.channel('realtime-notif')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'notifications' }, (payload) => {
                console.log('🔄 RT notifications:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'notifications', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'notification_preferences' }, (payload) => {
                console.log('🔄 RT notification_preferences:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'notificationPreferences', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'push_tokens' }, (payload) => {
                console.log('🔄 RT push_tokens:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'pushTokens', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, (payload) => {
                console.log('🔄 RT profiles:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'users', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'document_folders' }, (payload) => {
                console.log('🔄 RT document_folders:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'documentFolders', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'control_reports' }, (payload) => {
                console.log('🔄 RT control_reports:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'controlReports', payload));
            })
            .subscribe((status) => {
                console.log('📡 Canal 3 (Notif):', status);
            });
        
        // Canal 4: Feuilles d'heures & Congés (6 tables)
        const channel4 = db.channel('realtime-timesheet')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'timesheets' }, (payload) => {
                console.log('🔄 RT timesheets:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'timesheets', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'timesheet_days' }, (payload) => {
                console.log('🔄 RT timesheet_days:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'timesheetDays', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'timesheet_interventions' }, (payload) => {
                console.log('🔄 RT timesheet_interventions:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'timesheetInterventions', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'timesheet_history' }, (payload) => {
                console.log('🔄 RT timesheet_history:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'timesheetHistory', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'user_leave_balances' }, (payload) => {
                console.log('🔄 RT user_leave_balances:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'userLeaveBalances', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'leave_adjustments' }, (payload) => {
                console.log('🔄 RT leave_adjustments:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'leaveAdjustments', payload));
            })
            .subscribe((status) => {
                console.log('📡 Canal 4 (Timesheet):', status);
            });
        
        // Canal 5: Mise en service & Inspections (6 tables)
        const channel5 = db.channel('realtime-mes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'commissioning_devices' }, (payload) => {
                console.log('🔄 RT commissioning_devices:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'devices', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'archived_commissioning_devices' }, (payload) => {
                console.log('🔄 RT archived_commissioning_devices:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'archivedDevices', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'inspection_reports' }, (payload) => {
                console.log('🔄 RT inspection_reports:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'inspectionReports', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'inspection_checkpoints' }, (payload) => {
                console.log('🔄 RT inspection_checkpoints:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'inspectionCheckpoints', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'event_categories' }, (payload) => {
                console.log('🔄 RT event_categories:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'eventCategories', payload));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'bc_reserve_items' }, (payload) => {
                console.log('🔄 RT bc_reserve_items:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'bcReserveItems', payload));
            })
            .subscribe((status) => {
                console.log('📡 Canal 5 (MES):', status);
            });
        
        // Canal 6: Fonctionnalités v5.5 (véhicules, chat, photos annotées)
        const channel6 = db.channel('realtime-v55')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'vehicles' }, (payload) => {
                console.log('🔄 RT vehicles:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'vehicles', payload));
                // Notifier le hook useVehicles
                window.dispatchEvent(new CustomEvent('vehicle-updated', { detail: payload }));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'vehicle_stock' }, (payload) => {
                console.log('🔄 RT vehicle_stock:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'vehicleStock', payload));
                // Notifier le hook useVehicles
                window.dispatchEvent(new CustomEvent('vehicle-stock-updated', { detail: payload }));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, (payload) => {
                console.log('🔄 RT chat_messages:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'chatMessages', payload));
                // Notifier le ChatPanel
                if (payload.eventType === 'INSERT') {
                    window.dispatchEvent(new CustomEvent('new-chat-message', { detail: payload.new }));
                    // Mettre à jour le compteur de messages non lus
                    window.dispatchEvent(new CustomEvent('chat-message-received', { detail: payload.new }));
                }
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'annotated_photos' }, (payload) => {
                console.log('🔄 RT annotated_photos:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'annotatedPhotos', payload));
                // Notifier les composants photo
                window.dispatchEvent(new CustomEvent('photo-annotated', { detail: payload }));
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'video_calls' }, (payload) => {
                console.log('🔄 RT video_calls:', payload.eventType);
                // Gérer les appels vidéo entrants
                if (payload.eventType === 'INSERT' && payload.new.target_user_id === user?.id) {
                    window.dispatchEvent(new CustomEvent('incoming-video-call', { detail: payload.new }));
                }
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'stock_movements' }, (payload) => {
                console.log('🔄 RT stock_movements:', payload.eventType);
                setData(prev => handleRealtimeChange(prev, 'stockMovements', payload));
                // Notifier les composants stock
                window.dispatchEvent(new CustomEvent('stock-movement', { detail: payload }));
            })
            .subscribe((status) => {
                console.log('📡 Canal 6 (v5.5):', status);
            });
        
        console.log('🚀 6 canaux temps réel créés (36 tables)');
        
        return () => { 
            console.log('🛑 Canaux temps réel fermés');
            db.removeChannel(channel1);
            db.removeChannel(channel2);
            db.removeChannel(channel3);
            db.removeChannel(channel4);
            db.removeChannel(channel5);
            db.removeChannel(channel6);
        };
    }, [handleRealtimeChange]);
    
    const handleLogout = async () => {
        await db.auth.signOut();
        setUser(null);
    };
    
    if (loading) return null;
    
    if (!user) {
        return h(Fragment, null,
            h(LoginPage, { onLogin: async (u) => { setUser(u); await loadData(); }, showToast }),
            h('div', { className: 'toast-container' }, toasts.map(t => h(Toast, { key: t.id, ...t, onClose: () => removeToast(t.id) })))
        );
    }
    
    const navItems = [
        { id: 'dashboard', label: 'Tableau de bord', icon: 'dashboard' },
        { id: 'stock', label: 'Stock', icon: 'stock', badge: data.parts.filter(p => p.quantity <= (p.min_stock || 0)).length || null },
        { id: 'tasks', label: 'Travaux', icon: 'tasks', badge: data.tasks.filter(t => t.status !== 'termine' && !t.is_event).length || null },
        { id: 'orders', label: 'Commandes', icon: 'orders', badge: data.orders.filter(o => o.status === 'en-commande').length || null },
        { id: 'requests', label: 'Demandes', icon: 'mail', badge: (data.requests || []).filter(r => ['nouveau', 'en_cours', 'en_attente'].includes(r.status)).length || null },
        { id: 'planning', label: 'Planning', icon: 'planning' },
        { id: 'map', label: 'Carte', icon: 'map' },
        { id: 'tournees', label: 'Tournées', icon: 'route' },
        { id: 'vehicles', label: 'Véhicules', icon: 'truck' },
        { id: 'ai', label: 'IA Prédictive', icon: 'ai' },
        { id: 'timesheet', label: 'Feuilles d\'heures', icon: 'clock' },
        { id: 'ged', label: 'GED', icon: 'folder' },
        { id: 'parc', label: 'Parc ascenseurs', icon: 'building' },
        { id: 'miseenservice', label: 'Mise en service', icon: 'inspection', badge: (data.devices || []).filter(d => d.status !== 'termine').length || null },
    ];
    
    const renderPage = (pageId) => {
        const page = pageId || currentPage;
        const props = { data, user, refresh: loadData, showToast };
        switch (page) {
            case 'dashboard': return h(DashboardPage, props);
            case 'stock': return h(StockPage, props);
            case 'tasks': return h(TasksPage, props);
            case 'orders': return h(OrdersPage, props);
            case 'requests': return h(RequestsPage, props);
            case 'planning': return h(PlanningPage, props);
            case 'map': return h(MapPage, { ...props, InterventionMap: InterventionMap });
            case 'tournees': return h(TourneesEntretienPage, props);
            case 'ai': return h(AIPage, { ...props, PredictiveAIDashboard: PredictiveAIDashboard });
            case 'vehicles': return h(VehiclesPage, props);
            case 'timesheet': return h(TimesheetPage, props);
            case 'ged': return h(GedPage, props);
            case 'parc': return h(ParcAscenseursPage, props);
            case 'miseenservice': return h(MiseEnServicePage, props);
            case 'users': return h(UsersPage, props);
            case 'settings': return h(SettingsPage, props);
            default: return h(DashboardPage, props);
        }
    };
    
    // Rendu du contenu principal (simple ou split view)
    const renderMainContent = () => {
        if (splitViewConfig.layout === 'single') {
            return renderPage(currentPage);
        }
        return h(SplitView, {
            key: splitViewConfig.layout + '-' + splitViewConfig.pages.join('-'),
            renderPage: (pageId, index) => renderPage(pageId),
            navItems: [...navItems, 
                { id: 'users', label: 'Utilisateurs', icon: 'users' },
                { id: 'settings', label: 'Paramètres', icon: 'settings' }
            ],
            onPageChange: (panelIndex, pageId) => {
                console.log('Split view panel', panelIndex, 'changed to', pageId);
                setSplitViewConfig(SplitViewService.getConfig());
            }
        });
    };
    
    return h('div', { className: 'app' },
        // Sidebar
        h('aside', { className: `sidebar ${sidebarCollapsed ? 'collapsed' : ''} ${sidebarOpen ? 'open' : ''}` },
            h('div', { className: 'sidebar-header' },
                h('div', { className: 'sidebar-logo' }, 'S'),
                h('span', { className: 'sidebar-title' }, 'StockApp')
            ),
            h('nav', { className: 'sidebar-nav' },
                h('div', { className: 'nav-section' },
                    h('div', { className: 'nav-section-title' }, 'Menu'),
                    navItems.map(item => h('div', {
                        key: item.id,
                        className: `nav-item ${currentPage === item.id ? 'active' : ''}`,
                        onClick: () => { setCurrentPage(item.id); setSidebarOpen(false); }
                    },
                        h('span', { className: 'nav-item-icon' }, h(Icon, { name: item.icon, size: 20 })),
                        h('span', { className: 'nav-item-text' }, item.label),
                        item.badge && h('span', { className: 'nav-item-badge' }, item.badge)
                    ))
                ),
                h('div', { className: 'nav-section' },
                    h('div', { className: 'nav-section-title' }, 'Système'),
                    user.role === 'admin' && h('div', { 
                        className: `nav-item ${currentPage === 'users' ? 'active' : ''}`, 
                        onClick: () => { setCurrentPage('users'); setSidebarOpen(false); }
                    },
                        h('span', { className: 'nav-item-icon' }, h(Icon, { name: 'users', size: 20 })),
                        h('span', { className: 'nav-item-text' }, 'Utilisateurs'),
                        data.users.length > 0 && h('span', { className: 'nav-item-badge' }, data.users.length)
                    ),
                    h('div', { 
                        className: `nav-item ${currentPage === 'settings' ? 'active' : ''}`, 
                        onClick: () => { setCurrentPage('settings'); setSidebarOpen(false); }
                    },
                        h('span', { className: 'nav-item-icon' }, h(Icon, { name: 'settings', size: 20 })),
                        h('span', { className: 'nav-item-text' }, 'Paramètres')
                    ),
                    h('div', { className: 'nav-item', onClick: handleLogout },
                        h('span', { className: 'nav-item-icon' }, h(Icon, { name: 'logout', size: 20 })),
                        h('span', { className: 'nav-item-text' }, 'Déconnexion')
                    )
                )
            ),
            h('div', { className: 'sidebar-footer' },
                h('button', { className: 'sidebar-toggle', onClick: () => setSidebarCollapsed(!sidebarCollapsed) },
                    h(Icon, { name: sidebarCollapsed ? 'chevronRight' : 'chevronLeft', size: 18 }),
                    h('span', null, 'Réduire')
                )
            )
        ),
        
        // Main Content
        h('main', { className: 'main-content' },
            // Header
            h('header', { className: 'header' },
                h('div', { className: 'header-left' },
                    h('button', { className: 'btn btn-ghost btn-icon mobile-menu-btn', onClick: () => setSidebarOpen(!sidebarOpen) }, h(Icon, { name: 'menu', size: 20 }))
                ),
                h('div', { className: 'header-actions' },
                    // Indicateur temps réel
                    h('div', { 
                        className: `realtime-indicator ${realtimeStatus}`,
                        title: realtimeStatus === 'connected' ? 'Connecté en temps réel' : realtimeStatus === 'disconnected' ? 'Déconnecté' : 'Connexion...'
                    },
                        h('span', { className: 'dot' }),
                        realtimeStatus === 'connected' ? 'Live' : realtimeStatus === 'disconnected' ? 'Offline' : '...'
                    ),
                    // v5.0 - Bouton recherche
                    h('button', {
                        className: 'header-btn',
                        onClick: () => setShowCommandPalette(true),
                        title: 'Recherche (Cmd+K)'
                    }, '🔍'),
                    // v5.0 - Bouton présentation
                    h('button', {
                        className: 'header-btn',
                        onClick: () => setShowPresentationMode(true),
                        title: 'Mode présentation'
                    }, '📺'),
                    // v5.0 - Bouton thème
                    h(ThemeToggle, { theme, onToggle: toggleTheme }),
                    // v5.8 - Bouton Split View
                    h(SplitViewControl, {
                        onLayoutChange: (layoutId) => {
                            setSplitViewLayout(layoutId);
                            setSplitViewConfig(SplitViewService.getConfig());
                        }
                    }),
                    // v5.8 - Bouton Chat WhatsApp
                    h('button', {
                        className: 'header-btn',
                        onClick: () => setShowChatWhatsApp(true),
                        title: 'Messages',
                        style: { position: 'relative' }
                    }, 
                        '💬',
                        chatUnreadCount > 0 && h('span', { className: 'notif-badge-count' }, chatUnreadCount > 9 ? '9+' : chatUnreadCount)
                    ),
                    // v5.7 - Bouton Rapports
                    h('button', {
                        className: 'header-btn',
                        onClick: () => setShowAutoReports(true),
                        title: 'Rapports automatiques'
                    }, '📊'),
                    // v5.7 - Bouton Historique
                    user?.role === 'admin' && h('button', {
                        className: 'header-btn',
                        onClick: () => setShowAuditLog(true),
                        title: 'Historique des actions'
                    }, '📋'),
                    // v5.8 - Boutons HMI avancé
                    h('button', { 
                        className: 'header-btn', 
                        onClick: () => { setPdfTemplateCategory('stock'); setShowPDFTemplates(true); },
                        title: 'Exporter en PDF'
                    }, '📄'),
                    h('button', { 
                        className: 'header-btn', 
                        onClick: () => setShowThemeSelectorV58(true),
                        title: 'Personnaliser le thème'
                    }, '🎨'),
                    h('button', { 
                        className: 'header-btn', 
                        onClick: () => setShowNotificationCenter(true),
                        title: 'Notifications'
                    }, 
                        '🔔',
                        unreadCount > 0 && h('span', { className: 'notif-badge-count' }, unreadCount > 99 ? '99+' : unreadCount)
                    ),
                    h('div', { className: 'user-menu' },
                        h('div', { className: 'user-avatar' }, (user.first_name?.[0] || user.email[0]).toUpperCase()),
                        h('div', { className: 'user-info' },
                            h('div', { className: 'user-name' }, user.first_name ? `${user.first_name} ${user.last_name || ''}` : user.email.split('@')[0]),
                            h('div', { className: 'user-role' }, user.role || 'Utilisateur')
                        )
                    )
                )
            ),
            
            // Page Content
            h('div', { className: `page-content ${splitViewConfig.layout !== 'single' ? 'split-view-active' : ''}` }, renderMainContent())
        ),
        
        // Toasts
        h('div', { className: 'toast-container' }, toasts.map(t => h(Toast, { key: t.id, ...t, onClose: () => removeToast(t.id) }))),
        
        // v5.0 - Composants globaux
        h(CommandPalette, {
            isOpen: showCommandPalette,
            onClose: () => setShowCommandPalette(false),
            onNavigate: (page) => { setCurrentPage(page); setShowCommandPalette(false); },
            parts: data.parts,
            tasks: data.tasks
        }),
        h(PresentationMode, {
            isOpen: showPresentationMode,
            onClose: () => setShowPresentationMode(false),
            tasks: data.tasks,
            parts: data.parts,
            notifications: notifications,
            orders: data.orders,
            requests: data.requests,
            timesheets: data.timesheets,
            users: data.users
        }),
        h(ShortcutsHelp, {
            isOpen: showShortcutsHelp,
            onClose: () => setShowShortcutsHelp(false)
        }),
        h(OfflineBanner, { isOnline: isOnline }),
        
        // ============================================================================
        // COMPOSANTS v5.4 et v5.5 (visibles quand l'utilisateur est connecté)
        // ============================================================================
        
        // v5.8 - Chat WhatsApp unifié
        h(ChatWhatsApp, {
            isOpen: showChatWhatsApp,
            onClose: () => setShowChatWhatsApp(false),
            user: user,
            users: data.users || []
        }),
        
        // v5.4 - Notification Settings Modal
        h(NotificationSettingsModal, {
            isOpen: showNotificationSettings,
            onClose: () => setShowNotificationSettings(false)
        }),
        
        // v5.4 - OCR Import Modal
        h(OCRImportModal, {
            isOpen: showOCRImport,
            onClose: () => setShowOCRImport(false),
            onImport: (result) => {
                showToast('Données importées avec succès', 'success');
                console.log('OCR Import result:', result);
            }
        }),
        
        // v5.4 - Mode Présentation Amélioré
        h(EnhancedPresentationMode, {
            isOpen: showEnhancedPresentation,
            onClose: () => setShowEnhancedPresentation(false),
            data: data
        }),
        
        // v5.5 - Thème Customizer
        h(ThemeCustomizerModal, {
            isOpen: showThemeCustomizer,
            onClose: () => setShowThemeCustomizer(false)
        }),
        
        // v5.5 - Roles Manager
        h(RolesManagerModal, {
            isOpen: showRolesManager,
            onClose: () => setShowRolesManager(false)
        }),
        
        // v5.5 - Shortcuts Manager
        h(ShortcutsManagerModal, {
            isOpen: showShortcutsManager,
            onClose: () => setShowShortcutsManager(false)
        }),
        
        // v5.5 - NFC Inventory
        h(NFCInventoryModal, {
            isOpen: showNFCInventory,
            onClose: () => setShowNFCInventory(false),
            parts: data.parts || [],
            onUpdatePart: (partId, updates) => console.log('Update part', partId, updates)
        }),
        
        // v5.5 - Video Call Panel
        h(VideoCallPanel, {
            isOpen: showVideoCall,
            onClose: () => { setShowVideoCall(false); setVideoCallTarget(null); setIsIncomingVideoCall(false); },
            currentUser: user,
            targetUser: videoCallTarget,
            isIncomingCall: isIncomingVideoCall
        }),
        
        // v5.5 - Incoming Call Listener (écoute les appels entrants en arrière-plan)
        user?.id && !showVideoCall && h(IncomingCallListener, {
            userId: user.id,
            onIncomingCall: (callData) => {
                console.log('[App] Appel entrant détecté:', callData);
                setVideoCallTarget({ id: callData.callerId, first_name: 'Appel entrant' });
                setIsIncomingVideoCall(true);
                setShowVideoCall(true);
            }
        }),
        
        // v5.5 - Offline Indicator (legacy)
        h(OfflineIndicatorV52, {
            isOnline: isOnline,
            queueLength: 0,
            isSyncing: false,
            lastSync: null,
            onSync: () => console.log('Sync requested')
        }),
        
        // v5.5 - Widget Picker Modal
        showWidgetPicker && h(V55WidgetPicker, {
            isOpen: showWidgetPicker,
            onClose: () => setShowWidgetPicker(false),
            availableWidgets: WidgetSystem?.availableWidgets?.filter(w => 
                !WidgetSystem.getLayout().find(l => l.id === w.id)
            ) || [],
            onAdd: (widgetId) => { 
                console.log('[Widget] Ajout demandé:', widgetId);
                // Ajouter le widget au layout
                const widget = WidgetSystem.availableWidgets.find(w => w.id === widgetId);
                if (widget) {
                    const currentLayout = WidgetSystem.getLayout();
                    console.log('[Widget] Layout actuel:', currentLayout);
                    const newWidget = {
                        id: widget.id,
                        x: 0,
                        y: currentLayout.length > 0 ? Math.max(...currentLayout.map(w => (w.y || 0) + (w.h || 2))) : 0,
                        w: widget.defaultSize.w,
                        h: widget.defaultSize.h
                    };
                    currentLayout.push(newWidget);
                    WidgetSystem.saveLayout(currentLayout);
                    console.log('[Widget] Nouveau layout:', currentLayout);
                    // Notifier le dashboard
                    setTimeout(() => {
                        window.dispatchEvent(new CustomEvent('widget-layout-changed'));
                        console.log('[Widget] Event dispatché');
                    }, 100);
                    showToast(`Widget "${widget.name}" ajouté ! Retournez au Dashboard pour le voir.`, 'success');
                } else {
                    console.error('[Widget] Widget non trouvé:', widgetId);
                }
            }
        }),
        
        // v5.5 - Photo Annotator Modal
        showPhotoAnnotator && photoToAnnotate && (() => {
            console.log('[App] PhotoAnnotator - photoToAnnotate:', photoToAnnotate);
            console.log('[App] PhotoAnnotator - URL:', photoToAnnotate?.url);
            return h(PhotoAnnotatorModal, {
                isOpen: showPhotoAnnotator,
                image: photoToAnnotate?.url,
                onClose: () => { setShowPhotoAnnotator(false); setPhotoToAnnotate(null); },
                onSave: async (annotatedBlob) => { 
                    console.log('[App] Photo annotée reçue:', annotatedBlob);
                    
                    try {
                        // Convertir le blob en data URL
                        const reader = new FileReader();
                        reader.onload = async () => {
                            const annotatedDataUrl = reader.result;
                            console.log('[App] Photo convertie en data URL, taille:', annotatedDataUrl.length);
                            
                            // Sauvegarder dans Supabase si disponible
                            if (typeof db !== 'undefined' && db !== null) {
                                try {
                                    // Insertion avec related_type et related_id séparés
                                    const insertData = {
                                        original_url: (photoToAnnotate?.url || 'unknown').substring(0, 500),
                                        annotated_url: annotatedDataUrl,
                                        related_type: photoToAnnotate?.relatedType || 'task',
                                        related_id: photoToAnnotate?.relatedId ? String(photoToAnnotate.relatedId) : null,
                                        created_at: new Date().toISOString()
                                    };
                                    
                                    console.log('[App] Tentative insertion Supabase avec:', Object.keys(insertData), '- related_id:', insertData.related_id);
                                    
                                    const { data: savedPhoto, error } = await db
                                        .from('annotated_photos')
                                        .insert(insertData)
                                        .select()
                                        .single();
                                    
                                    if (error) {
                                        console.error('[App] Erreur Supabase:', error.code, error.message);
                                        
                                        // Si la colonne annotated_url n'existe pas, essayer annotated_data
                                        if (error.message?.includes('annotated_url') || error.code === '42703') {
                                            console.log('[App] Tentative avec annotated_data...');
                                            const insertData2 = {
                                                original_url: (photoToAnnotate?.url || 'unknown').substring(0, 500),
                                                annotated_data: annotatedDataUrl,
                                                related_type: photoToAnnotate?.relatedType || 'task',
                                                related_id: photoToAnnotate?.relatedId ? String(photoToAnnotate.relatedId) : null,
                                                created_at: new Date().toISOString()
                                            };
                                            const { data: saved2, error: err2 } = await db
                                                .from('annotated_photos')
                                                .insert(insertData2)
                                                .select()
                                                .single();
                                            
                                            if (err2) {
                                                console.error('[App] Erreur 2:', err2);
                                                throw err2;
                                            }
                                            console.log('[App] Photo sauvegardée avec annotated_data:', saved2?.id);
                                            showToast('Photo annotée sauvegardée!', 'success');
                                            // Déclencher un événement pour rafraîchir la liste des photos
                                            window.dispatchEvent(new CustomEvent('annotated-photo-saved', { 
                                                detail: { photo: saved2, relatedType: photoToAnnotate?.relatedType, relatedId: photoToAnnotate?.relatedId }
                                            }));
                                        } else if (error.code === '42P01') {
                                            // Table n'existe pas
                                            console.warn('[App] Table annotated_photos inexistante');
                                            throw new Error('Table annotated_photos inexistante - stockage local');
                                        } else {
                                            throw error;
                                        }
                                    } else {
                                        console.log('[App] Photo sauvegardée dans Supabase:', savedPhoto?.id);
                                        showToast('Photo annotée sauvegardée!', 'success');
                                        // Déclencher un événement pour rafraîchir la liste des photos
                                        window.dispatchEvent(new CustomEvent('annotated-photo-saved', { 
                                            detail: { photo: savedPhoto, relatedType: photoToAnnotate?.relatedType, relatedId: photoToAnnotate?.relatedId }
                                        }));
                                    }
                                } catch (e) {
                                    console.error('[App] Exception Supabase:', e.message || e);
                                    // Fallback localStorage
                                    const photos = JSON.parse(localStorage.getItem('annotatedPhotos') || '[]');
                                    photos.push({ 
                                        id: Date.now(), 
                                        data: annotatedDataUrl, 
                                        relatedType: photoToAnnotate?.relatedType,
                                        relatedId: photoToAnnotate?.relatedId,
                                        originalUrl: photoToAnnotate?.url?.substring(0, 100),
                                        createdAt: new Date().toISOString()
                                    });
                                    localStorage.setItem('annotatedPhotos', JSON.stringify(photos));
                                    showToast('Photo stockée localement (Supabase indisponible)', 'warning');
                                    console.log('[App] Photo stockée localement, total:', photos.length);
                                }
                            } else {
                                // Pas de Supabase - localStorage uniquement
                                console.log('[App] Pas de connexion Supabase, stockage local');
                                const photos = JSON.parse(localStorage.getItem('annotatedPhotos') || '[]');
                                photos.push({ 
                                    id: Date.now(), 
                                    data: annotatedDataUrl, 
                                    relatedType: photoToAnnotate?.relatedType,
                                    relatedId: photoToAnnotate?.relatedId,
                                    originalUrl: photoToAnnotate?.url?.substring(0, 100),
                                    createdAt: new Date().toISOString()
                                });
                                localStorage.setItem('annotatedPhotos', JSON.stringify(photos));
                                showToast('Photo annotée (stockée localement)', 'success');
                            }
                            
                            setShowPhotoAnnotator(false); 
                            setPhotoToAnnotate(null);
                        };
                        reader.readAsDataURL(annotatedBlob);
                    } catch (e) {
                        console.error('[App] Erreur conversion photo:', e);
                        showToast('Erreur lors de la sauvegarde', 'error');
                        setShowPhotoAnnotator(false); 
                        setPhotoToAnnotate(null);
                    }
                }
            });
        })(),
        
        // v5.7 - Indicateur hors-ligne amélioré
        h(OfflineIndicator),
        
        // v5.7 - Historique des actions
        showAuditLog && h(AuditLogViewer, {
            isOpen: showAuditLog,
            onClose: () => setShowAuditLog(false),
            user: user
        }),
        
        // v5.7 - Optimiseur d'itinéraire
        showRouteOptimizer && h(RouteOptimizer, {
            tasks: routeOptimizerTasks,
            isOpen: showRouteOptimizer,
            onClose: () => { setShowRouteOptimizer(false); setRouteOptimizerTasks([]); },
            onApply: async (optimizedTasks) => {
                // Appliquer l'ordre optimisé aux tâches
                for (let i = 0; i < optimizedTasks.length; i++) {
                    const hour = 8 + Math.floor(i * 1.5);
                    const time = `${hour.toString().padStart(2, '0')}:00`;
                    try {
                        await db.from('tasks').update({ scheduled_time: time }).eq('id', optimizedTasks[i].id);
                    } catch (e) {}
                }
                showToast(`${optimizedTasks.length} tâches réordonnées`, 'success');
                loadData();
            }
        }),
        
        // v5.7 - Rapports automatiques
        showAutoReports && h(AutoReportsManager, {
            isOpen: showAutoReports,
            onClose: () => setShowAutoReports(false),
            data: data
        }),
        
        // v5.8 - Composants HMI avancé
        h(ToastContainerV58),
        
        showThemeSelectorV58 && h(ThemeSelectorV58, {
            isOpen: showThemeSelectorV58,
            onClose: () => setShowThemeSelectorV58(false)
        }),
        
        showPDFTemplates && h(PDFTemplateModal, {
            isOpen: showPDFTemplates,
            onClose: () => setShowPDFTemplates(false),
            data: data,
            category: pdfTemplateCategory
        }),
        
        showNotificationCenter && h(NotificationCenterV58, {
            isOpen: showNotificationCenter,
            onClose: () => setShowNotificationCenter(false),
            notifications: notifications,
            onMarkAsRead: (id) => setNotifications(n => n.map(x => x.id === id ? {...x, read: true} : x)),
            onMarkAllAsRead: () => setNotifications(n => n.map(x => ({...x, read: true})))
        }),
        
        quickActionMenu.isOpen && h(QuickActionsMenu, {
            isOpen: quickActionMenu.isOpen,
            position: quickActionMenu.position,
            type: quickActionMenu.type,
            item: quickActionMenu.item,
            onAction: (actionId, item) => {
                console.log('Quick action:', actionId, item);
                // Gérer les actions selon le type
            },
            onClose: () => setQuickActionMenu({ isOpen: false, position: null, type: null, item: null })
        }),
        
        selectedItems.length > 0 && h(BulkActionsBar, {
            selectedCount: selectedItems.length,
            type: currentPage,
            onAction: (actionId) => {
                console.log('Bulk action:', actionId, selectedItems);
                setSelectedItems([]);
            },
            onClear: () => setSelectedItems([])
        }),
        
        // Bottom Navigation Mobile
        h(BottomNavigation, {
            currentPage: currentPage,
            onNavigate: (page) => setCurrentPage(page)
        })
    );
};


// ============================================================================
// STOCKAPP v5.2 - COMPOSANTS AMÉLIORÉS INTÉGRÉS
// ============================================================================

/**
 * ============================================================================
 * STOCKAPP v5.2 - AMÉLIORATIONS COMPLÈTES
 * ============================================================================
 * Ce fichier contient toutes les améliorations proposées pour StockApp
 * Prêt à être intégré dans l'application existante
 * 
 * Table des matières:
 * 1. HOOKS UTILITAIRES
 * 2. COMPOSANTS UX/UI
 * 3. SYSTÈME DE PERFORMANCE
 * 4. SÉCURITÉ
 * 5. FONCTIONNALITÉS AVANCÉES
 * 6. MODE OFFLINE AMÉLIORÉ
 * 7. SYSTÈME DE LOGS
 * ============================================================================
 */

// Note: h, useState, useEffect, etc. sont déjà déclarés dans le code principal

// ============================================================================
// 1. HOOKS UTILITAIRES
// ============================================================================

/**
 * Hook amélioré pour la gestion du thème (clair/sombre)
 * Note: useTheme de base existe déjà, celui-ci ajoute setTheme
 */
const useThemeEnhanced = () => {
    const [theme, setTheme] = useState(() => {
        return localStorage.getItem('stockapp-theme') || 'light';
    });

    useEffect(() => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('stockapp-theme', theme);
    }, [theme]);

    const toggleTheme = useCallback(() => {
        setTheme(prev => prev === 'light' ? 'dark' : 'light');
    }, []);

    return { theme, setTheme, toggleTheme };
};

/**
 * Hook pour le debounce des valeurs (optimisation recherche)
 */
const useDebounce = (value, delay = 300) => {
    const [debouncedValue, setDebouncedValue] = useState(value);

    useEffect(() => {
        const handler = setTimeout(() => {
            setDebouncedValue(value);
        }, delay);

        return () => clearTimeout(handler);
    }, [value, delay]);

    return debouncedValue;
};

/**
 * Hook pour colonnes redimensionnables et déplaçables
 * Sauvegarde automatique des préférences utilisateur en localStorage
 */
const useResizableColumns = (tableId, initialColumns) => {
    // État des colonnes avec largeurs et ordre
    const [columns, setColumns] = useState(() => {
        const saved = localStorage.getItem(`table-cols-${tableId}`);
        if (saved) {
            try {
                const prefs = JSON.parse(saved);
                return initialColumns.map((col, idx) => {
                    const savedCol = prefs.find(p => p.key === col.key);
                    return {
                        ...col,
                        width: savedCol?.width || col.width || 150,
                        order: savedCol?.order ?? idx
                    };
                }).sort((a, b) => a.order - b.order);
            } catch (e) { /* ignore */ }
        }
        return initialColumns.map((col, idx) => ({ ...col, width: col.width || 150, order: idx }));
    });
    
    const [resizing, setResizing] = useState(null);
    const [dragging, setDragging] = useState(null);
    const [dragOver, setDragOver] = useState(null);
    
    // Sauvegarder
    const savePrefs = useCallback((cols) => {
        const prefs = cols.map(c => ({ key: c.key, width: c.width, order: c.order }));
        localStorage.setItem(`table-cols-${tableId}`, JSON.stringify(prefs));
    }, [tableId]);
    
    // Redimensionnement - démarrer
    const startResize = useCallback((colKey, clientX) => {
        const col = columns.find(c => c.key === colKey);
        setResizing({ key: colKey, startX: clientX, startWidth: col?.width || 150 });
    }, [columns]);
    
    // Redimensionnement - pendant
    useEffect(() => {
        if (!resizing) return;
        
        const handleMouseMove = (e) => {
            const diff = e.clientX - resizing.startX;
            const newWidth = Math.max(60, resizing.startWidth + diff);
            
            setColumns(prev => prev.map(col => 
                col.key === resizing.key ? { ...col, width: newWidth } : col
            ));
        };
        
        const handleMouseUp = () => {
            setColumns(prev => {
                savePrefs(prev);
                return prev;
            });
            setResizing(null);
        };
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return () => {
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
    }, [resizing, savePrefs]);
    
    // Drag & Drop
    const startDrag = useCallback((e, colKey) => {
        setDragging(colKey);
        e.dataTransfer.effectAllowed = 'move';
    }, []);
    
    const handleDragOver = useCallback((colKey) => {
        if (dragging && dragging !== colKey) setDragOver(colKey);
    }, [dragging]);
    
    const handleDrop = useCallback((colKey) => {
        if (!dragging || dragging === colKey) return;
        
        setColumns(prev => {
            const dragIdx = prev.findIndex(c => c.key === dragging);
            const targetIdx = prev.findIndex(c => c.key === colKey);
            const newCols = [...prev];
            const [removed] = newCols.splice(dragIdx, 1);
            newCols.splice(targetIdx, 0, removed);
            const updated = newCols.map((col, i) => ({ ...col, order: i }));
            savePrefs(updated);
            return updated;
        });
        
        setDragging(null);
        setDragOver(null);
    }, [dragging, savePrefs]);
    
    const onDragEnd = useCallback(() => {
        setDragging(null);
        setDragOver(null);
    }, []);
    
    // Réinitialiser
    const resetColumns = useCallback(() => {
        const reset = initialColumns.map((col, idx) => ({ ...col, width: col.width || 150, order: idx }));
        setColumns(reset);
        localStorage.removeItem(`table-cols-${tableId}`);
    }, [initialColumns, tableId]);
    
    // Générer les props pour un th - inclut tout pour le redimensionnement et le drag
    const getColumnProps = useCallback((colKey) => {
        const col = columns.find(c => c.key === colKey);
        return {
            colConfig: col,
            onResize: startResize,
            onDragStart: startDrag,
            onDragOver: handleDragOver,
            onDrop: handleDrop,
            onDragEnd: onDragEnd,
            isDragOver: dragOver === colKey,
            isResizing: resizing?.key === colKey
        };
    }, [columns, startResize, startDrag, handleDragOver, handleDrop, onDragEnd, dragOver, resizing]);
    
    return {
        columns,
        getColumnProps,
        resetColumns,
        isResizing: !!resizing,
        isDragging: !!dragging
    };
};

/**
 * Hook pour le throttle des fonctions (optimisation scroll/resize)
 */
const useThrottle = (callback, delay = 100) => {
    const lastRan = useRef(Date.now());
    const timeoutRef = useRef(null);

    return useCallback((...args) => {
        const now = Date.now();
        
        if (now - lastRan.current >= delay) {
            callback(...args);
            lastRan.current = now;
        } else {
            clearTimeout(timeoutRef.current);
            timeoutRef.current = setTimeout(() => {
                callback(...args);
                lastRan.current = Date.now();
            }, delay - (now - lastRan.current));
        }
    }, [callback, delay]);
};

/**
 * Hook pour la détection de connexion réseau
 */
const useNetworkStatus = () => {
    const [status, setStatus] = useState({
        isOnline: navigator.onLine,
        type: 'unknown',
        effectiveType: 'unknown',
        downlink: null,
        rtt: null,
        saveData: false
    });

    useEffect(() => {
        const updateNetworkStatus = () => {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            
            setStatus({
                isOnline: navigator.onLine,
                type: connection?.type || 'unknown',
                effectiveType: connection?.effectiveType || 'unknown',
                downlink: connection?.downlink || null,
                rtt: connection?.rtt || null,
                saveData: connection?.saveData || false
            });
        };

        window.addEventListener('online', updateNetworkStatus);
        window.addEventListener('offline', updateNetworkStatus);
        
        const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
        if (connection) {
            connection.addEventListener('change', updateNetworkStatus);
        }

        updateNetworkStatus();

        return () => {
            window.removeEventListener('online', updateNetworkStatus);
            window.removeEventListener('offline', updateNetworkStatus);
            if (connection) {
                connection.removeEventListener('change', updateNetworkStatus);
            }
        };
    }, []);

    return status;
};

/**
 * Hook pour le timeout de session (déconnexion automatique après inactivité)
 */
const useSessionTimeout = (timeout = 30 * 60 * 1000, onTimeout) => {
    const timerRef = useRef(null);
    const warningRef = useRef(null);
    const [showWarning, setShowWarning] = useState(false);
    const [remainingTime, setRemainingTime] = useState(null);

    const resetTimer = useCallback(() => {
        clearTimeout(timerRef.current);
        clearTimeout(warningRef.current);
        setShowWarning(false);
        setRemainingTime(null);

        // Warning 5 minutes avant la déconnexion
        const warningTime = timeout - 5 * 60 * 1000;
        if (warningTime > 0) {
            warningRef.current = setTimeout(() => {
                setShowWarning(true);
                setRemainingTime(5 * 60);
                
                // Countdown
                const countdownInterval = setInterval(() => {
                    setRemainingTime(prev => {
                        if (prev <= 1) {
                            clearInterval(countdownInterval);
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
            }, warningTime);
        }

        timerRef.current = setTimeout(() => {
            onTimeout?.();
        }, timeout);
    }, [timeout, onTimeout]);

    useEffect(() => {
        const events = ['mousedown', 'keydown', 'scroll', 'touchstart', 'mousemove'];
        
        events.forEach(event => {
            document.addEventListener(event, resetTimer, { passive: true });
        });

        resetTimer();

        return () => {
            events.forEach(event => {
                document.removeEventListener(event, resetTimer);
            });
            clearTimeout(timerRef.current);
            clearTimeout(warningRef.current);
        };
    }, [resetTimer]);

    const extendSession = useCallback(() => {
        resetTimer();
    }, [resetTimer]);

    return { showWarning, remainingTime, extendSession };
};

/**
 * Hook pour le rate limiting côté client
 */
const useRateLimiter = (limit = 10, windowMs = 1000) => {
    const requestsRef = useRef([]);

    const checkLimit = useCallback(() => {
        const now = Date.now();
        requestsRef.current = requestsRef.current.filter(time => now - time < windowMs);
        
        if (requestsRef.current.length >= limit) {
            return false;
        }
        
        requestsRef.current.push(now);
        return true;
    }, [limit, windowMs]);

    const execute = useCallback(async (fn) => {
        if (!checkLimit()) {
            throw new Error('Rate limit exceeded. Please wait before making more requests.');
        }
        return fn();
    }, [checkLimit]);

    return { execute, checkLimit };
};

/**
 * Hook pour l'historique des actions (Undo/Redo)
 */
const useActionHistory = (maxHistory = 50) => {
    const [history, setHistory] = useState([]);
    const [currentIndex, setCurrentIndex] = useState(-1);

    const addAction = useCallback((action) => {
        setHistory(prev => {
            const newHistory = prev.slice(0, currentIndex + 1);
            newHistory.push({
                ...action,
                timestamp: Date.now(),
                id: Math.random().toString(36).substr(2, 9)
            });
            
            // Limiter la taille de l'historique
            if (newHistory.length > maxHistory) {
                newHistory.shift();
            }
            
            return newHistory;
        });
        setCurrentIndex(prev => Math.min(prev + 1, maxHistory - 1));
    }, [currentIndex, maxHistory]);

    const undo = useCallback(async () => {
        if (currentIndex < 0) return null;
        
        const action = history[currentIndex];
        if (action.undoFn) {
            await action.undoFn();
        }
        setCurrentIndex(prev => prev - 1);
        return action;
    }, [currentIndex, history]);

    const redo = useCallback(async () => {
        if (currentIndex >= history.length - 1) return null;
        
        const action = history[currentIndex + 1];
        if (action.redoFn) {
            await action.redoFn();
        }
        setCurrentIndex(prev => prev + 1);
        return action;
    }, [currentIndex, history]);

    const canUndo = currentIndex >= 0;
    const canRedo = currentIndex < history.length - 1;

    return { addAction, undo, redo, canUndo, canRedo, history, currentIndex };
};

/**
 * Hook pour les préférences utilisateur persistantes
 */
const useUserPreferences = (userId) => {
    const storageKey = `stockapp-prefs-${userId}`;
    
    const [preferences, setPreferences] = useState(() => {
        const stored = localStorage.getItem(storageKey);
        return stored ? JSON.parse(stored) : {
            theme: 'light',
            sidebarCollapsed: false,
            defaultView: 'list',
            itemsPerPage: 25,
            notifications: {
                sound: true,
                desktop: true,
                email: true
            },
            favorites: [],
            recentSearches: [],
            filterPresets: [],
            dashboardLayout: null
        };
    });

    const updatePreferences = useCallback((updates) => {
        setPreferences(prev => {
            const updated = { ...prev, ...updates };
            localStorage.setItem(storageKey, JSON.stringify(updated));
            return updated;
        });
    }, [storageKey]);

    const addFavorite = useCallback((item) => {
        setPreferences(prev => {
            const favorites = [...prev.favorites.filter(f => f.id !== item.id), item].slice(-20);
            const updated = { ...prev, favorites };
            localStorage.setItem(storageKey, JSON.stringify(updated));
            return updated;
        });
    }, [storageKey]);

    const removeFavorite = useCallback((itemId) => {
        setPreferences(prev => {
            const favorites = prev.favorites.filter(f => f.id !== itemId);
            const updated = { ...prev, favorites };
            localStorage.setItem(storageKey, JSON.stringify(updated));
            return updated;
        });
    }, [storageKey]);

    const addRecentSearch = useCallback((search) => {
        setPreferences(prev => {
            const recentSearches = [search, ...prev.recentSearches.filter(s => s !== search)].slice(0, 10);
            const updated = { ...prev, recentSearches };
            localStorage.setItem(storageKey, JSON.stringify(updated));
            return updated;
        });
    }, [storageKey]);

    const saveFilterPreset = useCallback((name, filters) => {
        setPreferences(prev => {
            const filterPresets = [...prev.filterPresets.filter(p => p.name !== name), { name, filters, createdAt: Date.now() }];
            const updated = { ...prev, filterPresets };
            localStorage.setItem(storageKey, JSON.stringify(updated));
            return updated;
        });
    }, [storageKey]);

    return { 
        preferences, 
        updatePreferences, 
        addFavorite, 
        removeFavorite, 
        addRecentSearch,
        saveFilterPreset
    };
};

/**
 * Hook pour le localStorage avec synchronisation entre onglets
 */
const useLocalStorage = (key, initialValue) => {
    const [storedValue, setStoredValue] = useState(() => {
        try {
            const item = window.localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
        } catch (error) {
            console.error(`Error reading localStorage key "${key}":`, error);
            return initialValue;
        }
    });

    const setValue = useCallback((value) => {
        try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            window.localStorage.setItem(key, JSON.stringify(valueToStore));
            
            // Dispatch custom event for cross-tab sync
            window.dispatchEvent(new CustomEvent('local-storage-change', {
                detail: { key, value: valueToStore }
            }));
        } catch (error) {
            console.error(`Error setting localStorage key "${key}":`, error);
        }
    }, [key, storedValue]);

    useEffect(() => {
        const handleStorageChange = (e) => {
            if (e.key === key && e.newValue) {
                setStoredValue(JSON.parse(e.newValue));
            }
        };

        const handleCustomEvent = (e) => {
            if (e.detail.key === key) {
                setStoredValue(e.detail.value);
            }
        };

        window.addEventListener('storage', handleStorageChange);
        window.addEventListener('local-storage-change', handleCustomEvent);

        return () => {
            window.removeEventListener('storage', handleStorageChange);
            window.removeEventListener('local-storage-change', handleCustomEvent);
        };
    }, [key]);

    return [storedValue, setValue];
};

/**
 * Hook pour la vérification de santé de l'API
 */
const useHealthCheck = (db, interval = 60000) => {
    const [status, setStatus] = useState('checking');
    const [lastCheck, setLastCheck] = useState(null);
    const [latency, setLatency] = useState(null);

    useEffect(() => {
        const checkHealth = async () => {
            const start = performance.now();
            try {
                await db.from('parts').select('count').limit(1);
                setLatency(Math.round(performance.now() - start));
                setStatus('healthy');
            } catch (error) {
                setStatus('unhealthy');
                setLatency(null);
            }
            setLastCheck(new Date());
        };

        checkHealth();
        const timer = setInterval(checkHealth, interval);

        return () => clearInterval(timer);
    }, [db, interval]);

    return { status, lastCheck, latency };
};

// ============================================================================
// 2. COMPOSANTS UX/UI
// ============================================================================

/**
 * Skeleton Loader - Placeholder animé pendant le chargement
 */
const SkeletonLoader = ({ type = 'text', count = 1, width, height }) => {
    const skeletons = Array(count).fill(null);

    const getSkeletonStyle = () => {
        switch (type) {
            case 'circle':
                return { width: width || 40, height: height || 40, borderRadius: '50%' };
            case 'rect':
                return { width: width || '100%', height: height || 100, borderRadius: 8 };
            case 'text':
            default:
                return { width: width || '100%', height: height || 16, borderRadius: 4 };
        }
    };

    return h('div', { className: 'skeleton-container' },
        skeletons.map((_, i) => 
            h('div', {
                key: i,
                className: 'skeleton',
                style: {
                    ...getSkeletonStyle(),
                    animationDelay: `${i * 0.1}s`
                }
            })
        )
    );
};

/**
 * Skeleton pour les lignes de tableau
 */
const TableRowSkeleton = ({ columns = 5, rows = 5 }) => {
    return h(Fragment, null,
        Array(rows).fill(null).map((_, rowIndex) =>
            h('tr', { key: rowIndex, className: 'skeleton-row' },
                Array(columns).fill(null).map((_, colIndex) =>
                    h('td', { key: colIndex },
                        h(SkeletonLoader, { 
                            type: 'text', 
                            width: colIndex === 0 ? '60%' : '80%',
                            height: 14
                        })
                    )
                )
            )
        )
    );
};

/**
 * Skeleton pour les cartes
 */
const CardSkeleton = ({ count = 4 }) => {
    return h('div', { className: 'card-skeleton-grid' },
        Array(count).fill(null).map((_, i) =>
            h('div', { key: i, className: 'card skeleton-card' },
                h(SkeletonLoader, { type: 'rect', height: 120 }),
                h('div', { style: { padding: 16 } },
                    h(SkeletonLoader, { type: 'text', width: '70%', height: 20 }),
                    h('div', { style: { height: 8 } }),
                    h(SkeletonLoader, { type: 'text', width: '90%' }),
                    h(SkeletonLoader, { type: 'text', width: '50%' })
                )
            )
        )
    );
};

/**
 * Breadcrumb - Fil d'Ariane
 */
const Breadcrumb = ({ items, onNavigate }) => {
    return h('nav', { className: 'breadcrumb', 'aria-label': 'Breadcrumb' },
        h('ol', { className: 'breadcrumb-list' },
            items.map((item, index) => {
                const isLast = index === items.length - 1;
                return h('li', { 
                    key: item.path || index, 
                    className: `breadcrumb-item ${isLast ? 'active' : ''}`
                },
                    !isLast ? h('a', {
                        href: '#',
                        onClick: (e) => {
                            e.preventDefault();
                            onNavigate?.(item.path);
                        }
                    }, 
                        item.icon && h(Icon, { name: item.icon, size: 14 }),
                        item.label
                    ) : h('span', null, 
                        item.icon && h(Icon, { name: item.icon, size: 14 }),
                        item.label
                    ),
                    !isLast && h('span', { className: 'breadcrumb-separator' }, '/')
                );
            })
        )
    );
};

/**
 * Progress Bar améliorée avec animation
 */
const ProgressBarEnhanced = ({ value, max = 100, showLabel = true, size = 'md', color = 'primary', animated = false }) => {
    const percentage = Math.min(100, Math.max(0, (value / max) * 100));
    
    const sizeClasses = {
        sm: 'progress-sm',
        md: 'progress-md',
        lg: 'progress-lg'
    };

    return h('div', { className: `progress-container ${sizeClasses[size]}` },
        h('div', { 
            className: `progress-bar progress-${color} ${animated ? 'progress-animated' : ''}`,
            style: { width: `${percentage}%` },
            role: 'progressbar',
            'aria-valuenow': value,
            'aria-valuemin': 0,
            'aria-valuemax': max
        }),
        showLabel && h('span', { className: 'progress-label' }, `${Math.round(percentage)}%`)
    );
};

/**
 * Indicateur de connexion réseau
 */
const ConnectionIndicator = ({ status }) => {
    const getStatusInfo = () => {
        if (!status.isOnline) {
            return { icon: 'wifi-off', text: 'Hors ligne', className: 'offline' };
        }
        
        switch (status.effectiveType) {
            case 'slow-2g':
            case '2g':
                return { icon: 'wifi', text: 'Connexion lente', className: 'slow' };
            case '3g':
                return { icon: 'wifi', text: 'Connexion moyenne', className: 'medium' };
            case '4g':
            default:
                return { icon: 'wifi', text: 'En ligne', className: 'online' };
        }
    };

    const info = getStatusInfo();

    return h('div', { 
        className: `connection-indicator ${info.className}`,
        title: `${info.text}${status.rtt ? ` (${status.rtt}ms)` : ''}`
    },
        h(Icon, { name: info.icon, size: 16 }),
        h('span', { className: 'connection-text' }, info.text)
    );
};

/**
 * Avertissement de timeout de session
 */
const SessionTimeoutWarning = ({ remainingTime, onExtend, onLogout }) => {
    const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    return h('div', { className: 'session-warning-overlay' },
        h('div', { className: 'session-warning-modal' },
            h('div', { className: 'session-warning-icon' },
                h(Icon, { name: 'clock', size: 48 })
            ),
            h('h3', null, 'Session bientôt expirée'),
            h('p', null, `Votre session expirera dans ${formatTime(remainingTime)}`),
            h('p', { className: 'session-warning-hint' }, 
                'Cliquez sur "Continuer" pour rester connecté'
            ),
            h('div', { className: 'session-warning-actions' },
                h('button', { 
                    className: 'btn btn-secondary',
                    onClick: onLogout
                }, 'Se déconnecter'),
                h('button', { 
                    className: 'btn btn-primary',
                    onClick: onExtend
                }, 'Continuer')
            )
        )
    );
};

/**
 * Tour guidé / Onboarding
 */
const GuidedTour = ({ steps, onComplete, onSkip }) => {
    const [currentStep, setCurrentStep] = useState(0);
    const [position, setPosition] = useState({ top: 0, left: 0 });

    useEffect(() => {
        const step = steps[currentStep];
        if (step?.target) {
            const element = document.querySelector(step.target);
            if (element) {
                const rect = element.getBoundingClientRect();
                setPosition({
                    top: rect.bottom + 10,
                    left: rect.left
                });
                element.classList.add('tour-highlight');
                
                return () => element.classList.remove('tour-highlight');
            }
        }
    }, [currentStep, steps]);

    const step = steps[currentStep];

    const handleNext = () => {
        if (currentStep < steps.length - 1) {
            setCurrentStep(prev => prev + 1);
        } else {
            onComplete?.();
        }
    };

    const handlePrev = () => {
        if (currentStep > 0) {
            setCurrentStep(prev => prev - 1);
        }
    };

    return h(Fragment, null,
        h('div', { className: 'tour-overlay' }),
        h('div', { 
            className: 'tour-tooltip',
            style: { top: position.top, left: position.left }
        },
            h('div', { className: 'tour-header' },
                h('span', { className: 'tour-step-indicator' }, 
                    `${currentStep + 1} / ${steps.length}`
                ),
                h('button', { 
                    className: 'tour-close',
                    onClick: onSkip 
                }, '×')
            ),
            h('h4', { className: 'tour-title' }, step?.title),
            h('p', { className: 'tour-content' }, step?.content),
            h('div', { className: 'tour-actions' },
                currentStep > 0 && h('button', { 
                    className: 'btn btn-ghost btn-sm',
                    onClick: handlePrev
                }, 'Précédent'),
                h('button', { 
                    className: 'btn btn-primary btn-sm',
                    onClick: handleNext
                }, currentStep === steps.length - 1 ? 'Terminer' : 'Suivant')
            )
        )
    );
};

/**
 * Recherches récentes avec suggestions
 */
const SearchWithHistory = ({ 
    value, 
    onChange, 
    placeholder, 
    recentSearches = [], 
    onSearch,
    onClearHistory 
}) => {
    const [showHistory, setShowHistory] = useState(false);
    const [focused, setFocused] = useState(false);
    const inputRef = useRef(null);

    const handleFocus = () => {
        setFocused(true);
        if (recentSearches.length > 0 && !value) {
            setShowHistory(true);
        }
    };

    const handleBlur = () => {
        setFocused(false);
        setTimeout(() => setShowHistory(false), 200);
    };

    const handleSelectRecent = (search) => {
        onChange(search);
        onSearch?.(search);
        setShowHistory(false);
    };

    return h('div', { className: 'search-with-history' },
        h('div', { className: `search-input-wrapper ${focused ? 'focused' : ''}` },
            h(Icon, { name: 'search', size: 18, className: 'search-icon' }),
            h('input', {
                ref: inputRef,
                type: 'text',
                className: 'form-input search-input',
                placeholder,
                value,
                onChange: (e) => onChange(e.target.value),
                onFocus: handleFocus,
                onBlur: handleBlur,
                onKeyDown: (e) => e.key === 'Enter' && onSearch?.(value)
            }),
            value && h('button', {
                className: 'search-clear',
                onClick: () => onChange('')
            }, h(Icon, { name: 'x', size: 16 }))
        ),
        showHistory && recentSearches.length > 0 && h('div', { className: 'search-history-dropdown' },
            h('div', { className: 'search-history-header' },
                h('span', null, 'Recherches récentes'),
                h('button', { 
                    className: 'search-history-clear',
                    onClick: onClearHistory
                }, 'Effacer')
            ),
            h('ul', { className: 'search-history-list' },
                recentSearches.map((search, i) =>
                    h('li', { 
                        key: i,
                        onClick: () => handleSelectRecent(search)
                    },
                        h(Icon, { name: 'clock', size: 14 }),
                        h('span', null, search)
                    )
                )
            )
        )
    );
};

/**
 * Gestionnaire de favoris
 */
const FavoritesManager = ({ favorites, onRemove, onSelect, type = 'part' }) => {
    if (favorites.length === 0) {
        return h('div', { className: 'favorites-empty' },
            h(Icon, { name: 'star', size: 32 }),
            h('p', null, 'Aucun favori'),
            h('small', null, 'Cliquez sur ★ pour ajouter des favoris')
        );
    }

    return h('div', { className: 'favorites-list' },
        favorites.map(item =>
            h('div', { 
                key: item.id, 
                className: 'favorite-item',
                onClick: () => onSelect(item)
            },
                h('div', { className: 'favorite-info' },
                    h('span', { className: 'favorite-name' }, item.name || item.ref),
                    item.category && h('span', { className: 'favorite-category' }, item.category)
                ),
                h('button', {
                    className: 'favorite-remove',
                    onClick: (e) => {
                        e.stopPropagation();
                        onRemove(item.id);
                    }
                }, h(Icon, { name: 'x', size: 14 }))
            )
        )
    );
};

/**
 * Bouton favori (étoile)
 */
const FavoriteButton = ({ isFavorite, onToggle, size = 20 }) => {
    return h('button', {
        className: `favorite-btn ${isFavorite ? 'active' : ''}`,
        onClick: (e) => {
            e.stopPropagation();
            onToggle();
        },
        title: isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris'
    },
        h(Icon, { name: isFavorite ? 'star-filled' : 'star', size })
    );
};

/**
 * Filtres sauvegardables
 */
const FilterPresets = ({ presets, currentFilters, onApply, onSave, onDelete }) => {
    const [showSave, setShowSave] = useState(false);
    const [presetName, setPresetName] = useState('');

    const handleSave = () => {
        if (presetName.trim()) {
            onSave(presetName.trim(), currentFilters);
            setPresetName('');
            setShowSave(false);
        }
    };

    return h('div', { className: 'filter-presets' },
        h('div', { className: 'filter-presets-header' },
            h('span', null, 'Filtres enregistrés'),
            h('button', {
                className: 'btn btn-ghost btn-sm',
                onClick: () => setShowSave(!showSave)
            }, h(Icon, { name: 'plus', size: 16 }), 'Enregistrer')
        ),
        showSave && h('div', { className: 'filter-preset-save' },
            h('input', {
                type: 'text',
                className: 'form-input',
                placeholder: 'Nom du filtre',
                value: presetName,
                onChange: (e) => setPresetName(e.target.value),
                onKeyDown: (e) => e.key === 'Enter' && handleSave()
            }),
            h('button', { className: 'btn btn-primary btn-sm', onClick: handleSave }, 'Enregistrer')
        ),
        h('div', { className: 'filter-presets-list' },
            presets.length === 0 
                ? h('p', { className: 'filter-presets-empty' }, 'Aucun filtre enregistré')
                : presets.map(preset =>
                    h('div', { key: preset.name, className: 'filter-preset-item' },
                        h('button', {
                            className: 'filter-preset-apply',
                            onClick: () => onApply(preset.filters)
                        }, preset.name),
                        h('button', {
                            className: 'filter-preset-delete',
                            onClick: () => onDelete(preset.name)
                        }, h(Icon, { name: 'trash', size: 14 }))
                    )
                )
        )
    );
};

/**
 * Sélecteur de vue (liste/grille/kanban)
 */
const ViewModeSelector = ({ mode, onChange, options = ['list', 'grid', 'kanban'] }) => {
    const icons = {
        list: 'list',
        grid: 'grid',
        kanban: 'columns'
    };

    const labels = {
        list: 'Liste',
        grid: 'Grille',
        kanban: 'Kanban'
    };

    return h('div', { className: 'view-mode-selector' },
        options.map(option =>
            h('button', {
                key: option,
                className: `view-mode-btn ${mode === option ? 'active' : ''}`,
                onClick: () => onChange(option),
                title: labels[option]
            }, h(Icon, { name: icons[option], size: 18 }))
        )
    );
};

/**
 * Panneau d'actions rapides (FAB - Floating Action Button)
 */
const QuickActions = ({ actions, position = 'bottom-right' }) => {
    const [isOpen, setIsOpen] = useState(false);

    return h('div', { className: `quick-actions ${position} ${isOpen ? 'open' : ''}` },
        h('div', { className: 'quick-actions-menu' },
            actions.map((action, i) =>
                h('button', {
                    key: i,
                    className: 'quick-action-item',
                    onClick: () => {
                        action.onClick?.();
                        setIsOpen(false);
                    },
                    title: action.label,
                    style: { transitionDelay: `${(actions.length - i - 1) * 50}ms` }
                },
                    h(Icon, { name: action.icon, size: 20 }),
                    h('span', { className: 'quick-action-label' }, action.label)
                )
            )
        ),
        h('button', {
            className: 'quick-actions-trigger',
            onClick: () => setIsOpen(!isOpen)
        },
            h(Icon, { name: isOpen ? 'x' : 'plus', size: 24 })
        )
    );
};

/**
 * Notification Toast améliorée
 */
const ToastImproved = ({ message, type = 'success', action, onClose, duration = 4000 }) => {
    const [progress, setProgress] = useState(100);
    const [isPaused, setIsPaused] = useState(false);

    useEffect(() => {
        if (isPaused) return;

        const startTime = Date.now();
        const interval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const remaining = Math.max(0, 100 - (elapsed / duration) * 100);
            setProgress(remaining);
            
            if (remaining <= 0) {
                clearInterval(interval);
                onClose();
            }
        }, 50);

        return () => clearInterval(interval);
    }, [isPaused, duration, onClose]);

    const icons = {
        success: 'check-circle',
        error: 'x-circle',
        warning: 'alert-triangle',
        info: 'info'
    };

    return h('div', { 
        className: `toast toast-${type}`,
        onMouseEnter: () => setIsPaused(true),
        onMouseLeave: () => setIsPaused(false)
    },
        h('div', { className: 'toast-icon' },
            h(Icon, { name: icons[type], size: 20 })
        ),
        h('div', { className: 'toast-content' },
            h('span', { className: 'toast-message' }, message),
            action && h('button', {
                className: 'toast-action',
                onClick: action.onClick
            }, action.label)
        ),
        h('button', { className: 'toast-close', onClick: onClose },
            h(Icon, { name: 'x', size: 16 })
        ),
        h('div', { 
            className: 'toast-progress',
            style: { width: `${progress}%` }
        })
    );
};

/**
 * Empty State amélioré
 */
const EmptyStateImproved = ({ 
    icon, 
    title, 
    description, 
    action,
    secondaryAction,
    illustration 
}) => {
    return h('div', { className: 'empty-state-improved' },
        illustration 
            ? h('img', { src: illustration, alt: '', className: 'empty-state-illustration' })
            : h('div', { className: 'empty-state-icon' },
                h(Icon, { name: icon || 'inbox', size: 64 })
            ),
        h('h3', { className: 'empty-state-title' }, title),
        description && h('p', { className: 'empty-state-description' }, description),
        (action || secondaryAction) && h('div', { className: 'empty-state-actions' },
            action && h('button', {
                className: 'btn btn-primary',
                onClick: action.onClick
            }, 
                action.icon && h(Icon, { name: action.icon, size: 18 }),
                action.label
            ),
            secondaryAction && h('button', {
                className: 'btn btn-secondary',
                onClick: secondaryAction.onClick
            }, secondaryAction.label)
        )
    );
};

// ============================================================================
// 3. SYSTÈME DE PERFORMANCE
// ============================================================================

/**
 * Liste virtualisée pour de grandes quantités de données
 */
const VirtualizedList = ({ 
    items, 
    rowHeight = 50, 
    overscan = 5,
    renderItem,
    className = ''
}) => {
    const containerRef = useRef(null);
    const [scrollTop, setScrollTop] = useState(0);
    const [containerHeight, setContainerHeight] = useState(0);

    useEffect(() => {
        const container = containerRef.current;
        if (!container) return;

        const handleScroll = () => {
            setScrollTop(container.scrollTop);
        };

        const handleResize = () => {
            setContainerHeight(container.clientHeight);
        };

        container.addEventListener('scroll', handleScroll, { passive: true });
        window.addEventListener('resize', handleResize);
        handleResize();

        return () => {
            container.removeEventListener('scroll', handleScroll);
            window.removeEventListener('resize', handleResize);
        };
    }, []);

    const totalHeight = items.length * rowHeight;
    const startIndex = Math.max(0, Math.floor(scrollTop / rowHeight) - overscan);
    const endIndex = Math.min(
        items.length,
        Math.ceil((scrollTop + containerHeight) / rowHeight) + overscan
    );

    const visibleItems = items.slice(startIndex, endIndex);
    const offsetY = startIndex * rowHeight;

    return h('div', {
        ref: containerRef,
        className: `virtualized-list ${className}`,
        style: { height: '100%', overflow: 'auto' }
    },
        h('div', { style: { height: totalHeight, position: 'relative' } },
            h('div', { style: { transform: `translateY(${offsetY}px)` } },
                visibleItems.map((item, index) =>
                    renderItem(item, startIndex + index)
                )
            )
        )
    );
};

/**
 * Table virtualisée
 */
const VirtualizedTable = ({
    columns,
    data,
    rowHeight = 48,
    headerHeight = 52,
    overscan = 5,
    onRowClick,
    selectedId,
    className = ''
}) => {
    const containerRef = useRef(null);
    const [scrollTop, setScrollTop] = useState(0);
    const [containerHeight, setContainerHeight] = useState(500);

    useEffect(() => {
        const container = containerRef.current;
        if (!container) return;

        const updateSize = () => {
            setContainerHeight(container.clientHeight - headerHeight);
        };

        const handleScroll = () => {
            setScrollTop(container.scrollTop);
        };

        container.addEventListener('scroll', handleScroll, { passive: true });
        window.addEventListener('resize', updateSize);
        updateSize();

        return () => {
            container.removeEventListener('scroll', handleScroll);
            window.removeEventListener('resize', updateSize);
        };
    }, [headerHeight]);

    const totalHeight = data.length * rowHeight;
    const startIndex = Math.max(0, Math.floor(scrollTop / rowHeight) - overscan);
    const endIndex = Math.min(
        data.length,
        Math.ceil((scrollTop + containerHeight) / rowHeight) + overscan
    );

    const visibleData = data.slice(startIndex, endIndex);

    return h('div', {
        ref: containerRef,
        className: `virtualized-table-container ${className}`,
        style: { height: '100%', overflow: 'auto' }
    },
        h('table', { className: 'table' },
            h('thead', { style: { position: 'sticky', top: 0, zIndex: 1 } },
                h('tr', null,
                    columns.map(col =>
                        h('th', { 
                            key: col.key, 
                            style: { width: col.width, minWidth: col.minWidth }
                        }, col.header)
                    )
                )
            ),
            h('tbody', null,
                h('tr', { style: { height: startIndex * rowHeight } },
                    h('td', { colSpan: columns.length })
                ),
                visibleData.map((row, index) =>
                    h('tr', {
                        key: row.id || startIndex + index,
                        className: selectedId === row.id ? 'selected' : '',
                        style: { height: rowHeight },
                        onClick: () => onRowClick?.(row)
                    },
                        columns.map(col =>
                            h('td', { key: col.key },
                                col.render ? col.render(row[col.key], row) : row[col.key]
                            )
                        )
                    )
                ),
                h('tr', { style: { height: (data.length - endIndex) * rowHeight } },
                    h('td', { colSpan: columns.length })
                )
            )
        )
    );
};

/**
 * Table avec colonnes redimensionnables et déplaçables
 * Sauvegarde automatique des préférences en localStorage
 */
const ResizableTable = ({
    tableId,
    columns: initialColumns,
    data,
    onRowClick,
    selectedId,
    className = '',
    emptyMessage = 'Aucune donnée'
}) => {
    // État des colonnes avec largeurs et ordre
    const [columns, setColumns] = useState(() => {
        // Charger les préférences sauvegardées
        const saved = localStorage.getItem(`table-prefs-${tableId}`);
        if (saved) {
            try {
                const prefs = JSON.parse(saved);
                // Fusionner avec les colonnes initiales (pour gérer les nouvelles colonnes)
                return initialColumns.map(col => {
                    const savedCol = prefs.find(p => p.key === col.key);
                    return {
                        ...col,
                        width: savedCol?.width || col.width || 150,
                        order: savedCol?.order ?? initialColumns.indexOf(col),
                        visible: savedCol?.visible ?? true
                    };
                }).sort((a, b) => a.order - b.order);
            } catch (e) {
                console.log('[ResizableTable] Erreur chargement préférences');
            }
        }
        return initialColumns.map((col, i) => ({
            ...col,
            width: col.width || 150,
            order: i,
            visible: true
        }));
    });
    
    const [resizing, setResizing] = useState(null);
    const [dragging, setDragging] = useState(null);
    const [dragOver, setDragOver] = useState(null);
    const tableRef = useRef(null);
    
    // Sauvegarder les préférences
    const savePrefs = useCallback((cols) => {
        const prefs = cols.map(c => ({ key: c.key, width: c.width, order: c.order, visible: c.visible }));
        localStorage.setItem(`table-prefs-${tableId}`, JSON.stringify(prefs));
    }, [tableId]);
    
    // Redimensionnement
    const handleResizeStart = (e, colKey) => {
        e.preventDefault();
        e.stopPropagation();
        setResizing({ key: colKey, startX: e.clientX });
    };
    
    useEffect(() => {
        if (!resizing) return;
        
        const handleMouseMove = (e) => {
            const diff = e.clientX - resizing.startX;
            setColumns(prev => {
                const updated = prev.map(col => {
                    if (col.key === resizing.key) {
                        return { ...col, width: Math.max(60, col.width + diff) };
                    }
                    return col;
                });
                return updated;
            });
            setResizing(prev => ({ ...prev, startX: e.clientX }));
        };
        
        const handleMouseUp = () => {
            setResizing(null);
            setColumns(prev => {
                savePrefs(prev);
                return prev;
            });
        };
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        return () => {
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
    }, [resizing, savePrefs]);
    
    // Drag & Drop des colonnes
    const handleDragStart = (e, colKey) => {
        setDragging(colKey);
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', colKey);
    };
    
    const handleDragOver = (e, colKey) => {
        e.preventDefault();
        if (dragging && dragging !== colKey) {
            setDragOver(colKey);
        }
    };
    
    const handleDragLeave = () => {
        setDragOver(null);
    };
    
    const handleDrop = (e, targetKey) => {
        e.preventDefault();
        if (!dragging || dragging === targetKey) return;
        
        setColumns(prev => {
            const dragIndex = prev.findIndex(c => c.key === dragging);
            const targetIndex = prev.findIndex(c => c.key === targetKey);
            
            const newCols = [...prev];
            const [removed] = newCols.splice(dragIndex, 1);
            newCols.splice(targetIndex, 0, removed);
            
            // Mettre à jour l'ordre
            const updated = newCols.map((col, i) => ({ ...col, order: i }));
            savePrefs(updated);
            return updated;
        });
        
        setDragging(null);
        setDragOver(null);
    };
    
    const handleDragEnd = () => {
        setDragging(null);
        setDragOver(null);
    };
    
    // Réinitialiser les colonnes
    const resetColumns = () => {
        const reset = initialColumns.map((col, i) => ({
            ...col,
            width: col.width || 150,
            order: i,
            visible: true
        }));
        setColumns(reset);
        localStorage.removeItem(`table-prefs-${tableId}`);
    };
    
    const visibleColumns = columns.filter(c => c.visible);
    
    return h('div', { className: `resizable-table-container ${className}`, ref: tableRef },
        // Menu contextuel pour réinitialiser
        h('div', { 
            style: { 
                display: 'flex', 
                justifyContent: 'flex-end', 
                padding: '4px 8px',
                borderBottom: '1px solid var(--border)',
                background: 'var(--background)',
                gap: 8
            }
        },
            h('button', {
                className: 'btn btn-ghost btn-xs',
                onClick: resetColumns,
                title: 'Réinitialiser les colonnes',
                style: { fontSize: 11, padding: '2px 8px' }
            }, '↺ Réinitialiser colonnes')
        ),
        
        h('div', { style: { overflowX: 'auto' } },
            h('table', { className: 'table resizable-table' },
                h('thead', null,
                    h('tr', null,
                        visibleColumns.map(col =>
                            h('th', {
                                key: col.key,
                                style: { 
                                    width: col.width, 
                                    minWidth: 60,
                                    position: 'relative',
                                    cursor: dragging ? 'grabbing' : 'grab',
                                    background: dragOver === col.key ? 'var(--primary-light)' : 'inherit',
                                    userSelect: 'none'
                                },
                                draggable: true,
                                onDragStart: (e) => handleDragStart(e, col.key),
                                onDragOver: (e) => handleDragOver(e, col.key),
                                onDragLeave: handleDragLeave,
                                onDrop: (e) => handleDrop(e, col.key),
                                onDragEnd: handleDragEnd
                            },
                                h('div', { 
                                    style: { 
                                        display: 'flex', 
                                        alignItems: 'center', 
                                        justifyContent: 'space-between',
                                        gap: 4
                                    }
                                },
                                    h('span', { style: { flex: 1 } }, col.header),
                                    h('div', {
                                        className: 'resize-handle',
                                        style: {
                                            width: 8,
                                            height: '100%',
                                            position: 'absolute',
                                            right: 0,
                                            top: 0,
                                            cursor: 'col-resize',
                                            background: resizing?.key === col.key ? 'var(--primary)' : 'transparent'
                                        },
                                        onMouseDown: (e) => handleResizeStart(e, col.key)
                                    })
                                )
                            )
                        )
                    )
                ),
                h('tbody', null,
                    data.length === 0 
                        ? h('tr', null, h('td', { colSpan: visibleColumns.length, style: { textAlign: 'center', padding: 40, color: 'var(--muted)' } }, emptyMessage))
                        : data.map((row, index) =>
                            h('tr', {
                                key: row.id || index,
                                className: selectedId === row.id ? 'selected' : '',
                                onClick: () => onRowClick?.(row),
                                style: { cursor: onRowClick ? 'pointer' : 'default' }
                            },
                                visibleColumns.map(col =>
                                    h('td', { 
                                        key: col.key,
                                        style: { 
                                            width: col.width,
                                            maxWidth: col.width,
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis',
                                            whiteSpace: 'nowrap'
                                        }
                                    },
                                        col.render ? col.render(row[col.key], row) : row[col.key]
                                    )
                                )
                            )
                        )
                )
            )
        )
    );
};

/**
 * Hook pour le filtrage optimisé avec useMemo
 */
const useOptimizedFilter = (data, filters, searchFields) => {
    const debouncedFilters = useDebounce(filters, 300);

    return useMemo(() => {
        if (!data || data.length === 0) return [];

        return data.filter(item => {
            // Recherche textuelle
            if (debouncedFilters.search) {
                const searchLower = debouncedFilters.search.toLowerCase();
                const matchesSearch = searchFields.some(field => {
                    const value = item[field];
                    return value && String(value).toLowerCase().includes(searchLower);
                });
                if (!matchesSearch) return false;
            }

            // Autres filtres
            for (const [key, value] of Object.entries(debouncedFilters)) {
                if (key === 'search' || value === '' || value === 'all' || value === undefined) continue;
                
                if (item[key] !== value) return false;
            }

            return true;
        });
    }, [data, debouncedFilters, searchFields]);
};

/**
 * Hook pour le tri optimisé
 */
const useOptimizedSort = (data, sortConfig) => {
    return useMemo(() => {
        if (!sortConfig || !sortConfig.key) return data;

        return [...data].sort((a, b) => {
            const aValue = a[sortConfig.key];
            const bValue = b[sortConfig.key];

            if (aValue === bValue) return 0;
            if (aValue === null || aValue === undefined) return 1;
            if (bValue === null || bValue === undefined) return -1;

            const comparison = aValue < bValue ? -1 : 1;
            return sortConfig.direction === 'desc' ? -comparison : comparison;
        });
    }, [data, sortConfig]);
};

/**
 * Hook pour la pagination optimisée
 */
const usePagination = (data, itemsPerPage = 25) => {
    const [currentPage, setCurrentPage] = useState(1);

    const totalPages = Math.ceil(data.length / itemsPerPage);
    
    const paginatedData = useMemo(() => {
        const startIndex = (currentPage - 1) * itemsPerPage;
        return data.slice(startIndex, startIndex + itemsPerPage);
    }, [data, currentPage, itemsPerPage]);

    const goToPage = useCallback((page) => {
        setCurrentPage(Math.max(1, Math.min(page, totalPages)));
    }, [totalPages]);

    const nextPage = useCallback(() => {
        goToPage(currentPage + 1);
    }, [currentPage, goToPage]);

    const prevPage = useCallback(() => {
        goToPage(currentPage - 1);
    }, [currentPage, goToPage]);

    // Reset to page 1 when data changes significantly
    useEffect(() => {
        if (currentPage > totalPages) {
            setCurrentPage(Math.max(1, totalPages));
        }
    }, [currentPage, totalPages]);

    return {
        data: paginatedData,
        currentPage,
        totalPages,
        totalItems: data.length,
        goToPage,
        nextPage,
        prevPage,
        hasNext: currentPage < totalPages,
        hasPrev: currentPage > 1
    };
};

/**
 * Composant de pagination
 */
const Pagination = ({ 
    currentPage, 
    totalPages, 
    totalItems,
    onPageChange,
    itemsPerPage,
    showInfo = true 
}) => {
    const getPageNumbers = () => {
        const pages = [];
        const maxVisible = 5;
        
        let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
        let end = Math.min(totalPages, start + maxVisible - 1);
        
        if (end - start < maxVisible - 1) {
            start = Math.max(1, end - maxVisible + 1);
        }

        for (let i = start; i <= end; i++) {
            pages.push(i);
        }

        return pages;
    };

    if (totalPages <= 1) return null;

    const startItem = (currentPage - 1) * itemsPerPage + 1;
    const endItem = Math.min(currentPage * itemsPerPage, totalItems);

    return h('div', { className: 'pagination-container' },
        showInfo && h('div', { className: 'pagination-info' },
            `${startItem}-${endItem} sur ${totalItems}`
        ),
        h('div', { className: 'pagination' },
            h('button', {
                className: 'pagination-btn',
                disabled: currentPage === 1,
                onClick: () => onPageChange(1),
                title: 'Première page'
            }, h(Icon, { name: 'chevrons-left', size: 16 })),
            h('button', {
                className: 'pagination-btn',
                disabled: currentPage === 1,
                onClick: () => onPageChange(currentPage - 1),
                title: 'Page précédente'
            }, h(Icon, { name: 'chevron-left', size: 16 })),
            getPageNumbers().map(page =>
                h('button', {
                    key: page,
                    className: `pagination-btn ${page === currentPage ? 'active' : ''}`,
                    onClick: () => onPageChange(page)
                }, page)
            ),
            h('button', {
                className: 'pagination-btn',
                disabled: currentPage === totalPages,
                onClick: () => onPageChange(currentPage + 1),
                title: 'Page suivante'
            }, h(Icon, { name: 'chevron-right', size: 16 })),
            h('button', {
                className: 'pagination-btn',
                disabled: currentPage === totalPages,
                onClick: () => onPageChange(totalPages),
                title: 'Dernière page'
            }, h(Icon, { name: 'chevrons-right', size: 16 }))
        )
    );
};

// ============================================================================
// 4. SÉCURITÉ
// ============================================================================

/**
 * Validation des entrées utilisateur
 */
const Validators = {
    // Validation de référence
    ref: (value) => {
        if (!value || typeof value !== 'string') {
            return { valid: false, error: 'La référence est requise' };
        }
        if (value.length < 2 || value.length > 50) {
            return { valid: false, error: 'La référence doit contenir entre 2 et 50 caractères' };
        }
        if (!/^[A-Za-z0-9\-_]+$/.test(value)) {
            return { valid: false, error: 'La référence ne peut contenir que des lettres, chiffres, tirets et underscores' };
        }
        return { valid: true };
    },

    // Validation de nom
    name: (value, options = {}) => {
        const { required = true, minLength = 2, maxLength = 100 } = options;
        
        if (!value || typeof value !== 'string') {
            if (required) return { valid: false, error: 'Le nom est requis' };
            return { valid: true };
        }
        if (value.length < minLength) {
            return { valid: false, error: `Le nom doit contenir au moins ${minLength} caractères` };
        }
        if (value.length > maxLength) {
            return { valid: false, error: `Le nom ne peut pas dépasser ${maxLength} caractères` };
        }
        return { valid: true };
    },

    // Validation de quantité
    quantity: (value, options = {}) => {
        const { min = 0, max = 999999 } = options;
        const num = Number(value);
        
        if (isNaN(num)) {
            return { valid: false, error: 'La quantité doit être un nombre' };
        }
        if (!Number.isInteger(num)) {
            return { valid: false, error: 'La quantité doit être un nombre entier' };
        }
        if (num < min) {
            return { valid: false, error: `La quantité ne peut pas être inférieure à ${min}` };
        }
        if (num > max) {
            return { valid: false, error: `La quantité ne peut pas dépasser ${max}` };
        }
        return { valid: true };
    },

    // Validation de prix
    price: (value, options = {}) => {
        const { min = 0, max = 9999999.99, required = false } = options;
        
        if (!value && value !== 0) {
            if (required) return { valid: false, error: 'Le prix est requis' };
            return { valid: true };
        }
        
        const num = Number(value);
        if (isNaN(num)) {
            return { valid: false, error: 'Le prix doit être un nombre' };
        }
        if (num < min) {
            return { valid: false, error: `Le prix ne peut pas être inférieur à ${min}` };
        }
        if (num > max) {
            return { valid: false, error: `Le prix ne peut pas dépasser ${max}` };
        }
        // Vérifier max 2 décimales
        if (Math.round(num * 100) / 100 !== num) {
            return { valid: false, error: 'Le prix ne peut avoir que 2 décimales maximum' };
        }
        return { valid: true };
    },

    // Validation d'email
    email: (value, options = {}) => {
        const { required = true } = options;
        
        if (!value) {
            if (required) return { valid: false, error: 'L\'email est requis' };
            return { valid: true };
        }
        
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
            return { valid: false, error: 'Format d\'email invalide' };
        }
        return { valid: true };
    },

    // Validation de téléphone
    phone: (value, options = {}) => {
        const { required = false } = options;
        
        if (!value) {
            if (required) return { valid: false, error: 'Le téléphone est requis' };
            return { valid: true };
        }
        
        const cleaned = value.replace(/[\s\-\.]/g, '');
        const phoneRegex = /^(\+33|0033|0)?[1-9](\d{8})$/;
        if (!phoneRegex.test(cleaned)) {
            return { valid: false, error: 'Format de téléphone invalide' };
        }
        return { valid: true };
    },

    // Validation de date
    date: (value, options = {}) => {
        const { required = false, minDate, maxDate } = options;
        
        if (!value) {
            if (required) return { valid: false, error: 'La date est requise' };
            return { valid: true };
        }
        
        const date = new Date(value);
        if (isNaN(date.getTime())) {
            return { valid: false, error: 'Format de date invalide' };
        }
        
        if (minDate && date < new Date(minDate)) {
            return { valid: false, error: `La date ne peut pas être antérieure au ${new Date(minDate).toLocaleDateString('fr-FR')}` };
        }
        if (maxDate && date > new Date(maxDate)) {
            return { valid: false, error: `La date ne peut pas être postérieure au ${new Date(maxDate).toLocaleDateString('fr-FR')}` };
        }
        return { valid: true };
    }
};

/**
 * Hook de validation de formulaire
 */
const useFormValidation = (initialValues, validationSchema) => {
    const [values, setValues] = useState(initialValues);
    const [errors, setErrors] = useState({});
    const [touched, setTouched] = useState({});

    const setValue = useCallback((field, value) => {
        setValues(prev => ({ ...prev, [field]: value }));
        
        // Valider le champ si déjà touché
        if (touched[field] && validationSchema[field]) {
            const result = validationSchema[field](value);
            setErrors(prev => ({
                ...prev,
                [field]: result.valid ? null : result.error
            }));
        }
    }, [touched, validationSchema]);

    const setFieldTouched = useCallback((field) => {
        setTouched(prev => ({ ...prev, [field]: true }));
        
        // Valider au blur
        if (validationSchema[field]) {
            const result = validationSchema[field](values[field]);
            setErrors(prev => ({
                ...prev,
                [field]: result.valid ? null : result.error
            }));
        }
    }, [validationSchema, values]);

    const validateAll = useCallback(() => {
        const newErrors = {};
        let isValid = true;

        for (const [field, validator] of Object.entries(validationSchema)) {
            const result = validator(values[field]);
            if (!result.valid) {
                newErrors[field] = result.error;
                isValid = false;
            }
        }

        setErrors(newErrors);
        setTouched(Object.keys(validationSchema).reduce((acc, key) => ({ ...acc, [key]: true }), {}));
        
        return isValid;
    }, [validationSchema, values]);

    const reset = useCallback(() => {
        setValues(initialValues);
        setErrors({});
        setTouched({});
    }, [initialValues]);

    return {
        values,
        errors,
        touched,
        setValue,
        setFieldTouched,
        validateAll,
        reset,
        isValid: Object.keys(errors).every(key => !errors[key])
    };
};

/**
 * Sanitization des entrées
 */
const Sanitizers = {
    // Échapper le HTML
    escapeHtml: (str) => {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    },

    // Nettoyer une chaîne pour SQL (côté client, en complément du serveur)
    cleanString: (str) => {
        if (!str) return '';
        return str.replace(/[<>\"\'\\]/g, '');
    },

    // Normaliser un numéro de téléphone
    normalizePhone: (phone) => {
        if (!phone) return '';
        return phone.replace(/[\s\-\.]/g, '');
    },

    // Formater un prix
    formatPrice: (value) => {
        const num = parseFloat(value);
        if (isNaN(num)) return '0.00';
        return num.toFixed(2);
    },

    // Tronquer un texte
    truncate: (str, maxLength, suffix = '...') => {
        if (!str || str.length <= maxLength) return str;
        return str.substring(0, maxLength - suffix.length) + suffix;
    }
};

/**
 * Composant d'input validé
 */
const ValidatedInput = ({
    type = 'text',
    name,
    label,
    value,
    onChange,
    onBlur,
    error,
    touched,
    required,
    placeholder,
    hint,
    ...props
}) => {
    const showError = touched && error;

    return h('div', { className: `form-group ${showError ? 'has-error' : ''}` },
        label && h('label', { className: 'form-label', htmlFor: name },
            label,
            required && h('span', { className: 'required-indicator' }, '*')
        ),
        h('input', {
            type,
            id: name,
            name,
            className: `form-input ${showError ? 'input-error' : ''}`,
            value: value || '',
            onChange: (e) => onChange(name, e.target.value),
            onBlur: () => onBlur?.(name),
            placeholder,
            'aria-invalid': showError,
            'aria-describedby': showError ? `${name}-error` : undefined,
            ...props
        }),
        showError && h('div', { 
            id: `${name}-error`,
            className: 'form-error',
            role: 'alert'
        }, error),
        hint && !showError && h('div', { className: 'form-hint' }, hint)
    );
};

// ============================================================================
// 5. FONCTIONNALITÉS AVANCÉES
// ============================================================================

/**
 * Système d'export avancé
 */
const ExportManager = {
    // Export Excel avec plusieurs feuilles
    exportExcel: async (sheets, filename) => {
        const XLSX = window.XLSX;
        const wb = XLSX.utils.book_new();

        sheets.forEach(sheet => {
            const ws = XLSX.utils.json_to_sheet(sheet.data);
            
            // Appliquer les largeurs de colonnes
            if (sheet.colWidths) {
                ws['!cols'] = sheet.colWidths.map(w => ({ wch: w }));
            }

            XLSX.utils.book_append_sheet(wb, ws, sheet.name);
        });

        XLSX.writeFile(wb, `${filename}.xlsx`);
    },

    // Export CSV avec options
    exportCSV: (data, filename, options = {}) => {
        const {
            delimiter = ';',
            encoding = 'utf-8',
            includeBOM = true,
            headers = true
        } = options;

        let csv = '';
        
        // BOM pour Excel
        if (includeBOM) {
            csv = '\uFEFF';
        }

        // En-têtes
        if (headers && data.length > 0) {
            csv += Object.keys(data[0]).join(delimiter) + '\n';
        }

        // Données
        data.forEach(row => {
            const values = Object.values(row).map(val => {
                if (val === null || val === undefined) return '';
                const str = String(val);
                // Échapper les guillemets et encadrer si nécessaire
                if (str.includes(delimiter) || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            });
            csv += values.join(delimiter) + '\n';
        });

        const blob = new Blob([csv], { type: `text/csv;charset=${encoding}` });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${filename}.csv`;
        link.click();
        URL.revokeObjectURL(url);
    },

    // Export PDF avec template personnalisé
    exportPDF: async (config) => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF(config.orientation || 'portrait');
        
        // En-tête personnalisé
        if (config.header) {
            doc.setFillColor(config.header.bgColor || '#E11D48');
            doc.rect(0, 0, doc.internal.pageSize.getWidth(), 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text(config.header.title || '', 14, 25);
            
            if (config.header.subtitle) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text(config.header.subtitle, 14, 35);
            }
        }

        let y = config.header ? 55 : 20;

        // Contenu
        if (config.content) {
            doc.setTextColor(0, 0, 0);
            config.content(doc, y);
        }

        // Tableau
        if (config.table) {
            y = ExportManager._drawTable(doc, config.table, y);
        }

        // Pied de page
        if (config.footer !== false) {
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(
                    `Page ${i} / ${pageCount} - Généré le ${new Date().toLocaleDateString('fr-FR')}`,
                    14,
                    doc.internal.pageSize.getHeight() - 10
                );
            }
        }

        doc.save(`${config.filename || 'export'}.pdf`);
    },

    _drawTable: (doc, tableConfig, startY) => {
        const { headers, data, colWidths } = tableConfig;
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 14;
        let y = startY;

        // En-tête du tableau
        doc.setFillColor(240, 240, 240);
        doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);

        let x = margin;
        headers.forEach((header, i) => {
            doc.text(header, x + 2, y + 7);
            x += colWidths[i];
        });
        y += 12;

        // Lignes
        doc.setFont(undefined, 'normal');
        doc.setFontSize(8);

        data.forEach((row, rowIndex) => {
            if (y > doc.internal.pageSize.getHeight() - 30) {
                doc.addPage();
                y = 20;
            }

            // Fond alterné
            if (rowIndex % 2 === 1) {
                doc.setFillColor(250, 250, 250);
                doc.rect(margin, y - 4, pageWidth - margin * 2, 8, 'F');
            }

            x = margin;
            row.forEach((cell, i) => {
                const text = String(cell || '').substring(0, 30);
                doc.text(text, x + 2, y);
                x += colWidths[i];
            });
            y += 8;
        });

        return y;
    }
};

/**
 * Composant de modal d'export
 */
const ExportModal = ({ 
    isOpen, 
    onClose, 
    data, 
    columns,
    title = 'Exporter les données',
    filename = 'export'
}) => {
    const [format, setFormat] = useState('excel');
    const [selectedColumns, setSelectedColumns] = useState(columns.map(c => c.key));
    const [includeHeaders, setIncludeHeaders] = useState(true);
    const [dateRange, setDateRange] = useState({ from: '', to: '' });

    const handleExport = async () => {
        const exportColumns = columns.filter(c => selectedColumns.includes(c.key));
        
        let filteredData = data;
        if (dateRange.from || dateRange.to) {
            filteredData = data.filter(item => {
                const date = new Date(item.created_at || item.date);
                if (dateRange.from && date < new Date(dateRange.from)) return false;
                if (dateRange.to && date > new Date(dateRange.to)) return false;
                return true;
            });
        }

        const exportData = filteredData.map(item => {
            const row = {};
            exportColumns.forEach(col => {
                row[col.header || col.key] = col.format 
                    ? col.format(item[col.key], item) 
                    : item[col.key];
            });
            return row;
        });

        switch (format) {
            case 'excel':
                await ExportManager.exportExcel([{
                    name: 'Données',
                    data: exportData,
                    colWidths: exportColumns.map(c => c.width || 15)
                }], filename);
                break;
            case 'csv':
                ExportManager.exportCSV(exportData, filename, {
                    headers: includeHeaders
                });
                break;
            case 'pdf':
                await ExportManager.exportPDF({
                    filename,
                    header: {
                        title: title,
                        subtitle: `${exportData.length} éléments exportés`
                    },
                    table: {
                        headers: exportColumns.map(c => c.header || c.key),
                        data: exportData.map(row => Object.values(row)),
                        colWidths: exportColumns.map(c => c.pdfWidth || 35)
                    }
                });
                break;
        }

        onClose();
    };

    const toggleColumn = (key) => {
        setSelectedColumns(prev => 
            prev.includes(key) 
                ? prev.filter(k => k !== key)
                : [...prev, key]
        );
    };

    if (!isOpen) return null;

    return h(Modal, { isOpen, onClose, title, size: 'md' },
        h('div', { className: 'export-modal-content' },
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Format d\'export'),
                h('div', { className: 'export-format-buttons' },
                    ['excel', 'csv', 'pdf'].map(f =>
                        h('button', {
                            key: f,
                            className: `btn ${format === f ? 'btn-primary' : 'btn-secondary'}`,
                            onClick: () => setFormat(f)
                        },
                            h(Icon, { name: f === 'excel' ? 'file-spreadsheet' : f === 'csv' ? 'file-text' : 'file', size: 18 }),
                            f.toUpperCase()
                        )
                    )
                )
            ),
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Colonnes à exporter'),
                h('div', { className: 'export-columns-list' },
                    columns.map(col =>
                        h('label', { key: col.key, className: 'export-column-item' },
                            h('input', {
                                type: 'checkbox',
                                checked: selectedColumns.includes(col.key),
                                onChange: () => toggleColumn(col.key)
                            }),
                            col.header || col.key
                        )
                    )
                )
            ),
            h('div', { className: 'form-group' },
                h('label', { className: 'form-label' }, 'Période (optionnel)'),
                h('div', { className: 'form-row' },
                    h('input', {
                        type: 'date',
                        className: 'form-input',
                        value: dateRange.from,
                        onChange: (e) => setDateRange(prev => ({ ...prev, from: e.target.value }))
                    }),
                    h('input', {
                        type: 'date',
                        className: 'form-input',
                        value: dateRange.to,
                        onChange: (e) => setDateRange(prev => ({ ...prev, to: e.target.value }))
                    })
                )
            ),
            h('div', { className: 'export-summary' },
                h(Icon, { name: 'info', size: 16 }),
                `${data.length} éléments seront exportés avec ${selectedColumns.length} colonnes`
            )
        ),
        h('div', { className: 'modal-footer' },
            h('button', { className: 'btn btn-secondary', onClick: onClose }, 'Annuler'),
            h('button', { 
                className: 'btn btn-primary',
                onClick: handleExport,
                disabled: selectedColumns.length === 0
            },
                h(Icon, { name: 'download', size: 18 }),
                'Exporter'
            )
        )
    );
};

/**
 * Composant de comparaison avant/après (pour undo preview)
 */
const DiffViewer = ({ before, after, fields }) => {
    const changes = fields.filter(f => before[f.key] !== after[f.key]);

    if (changes.length === 0) {
        return h('p', { className: 'diff-no-changes' }, 'Aucune modification');
    }

    return h('div', { className: 'diff-viewer' },
        changes.map(field =>
            h('div', { key: field.key, className: 'diff-row' },
                h('span', { className: 'diff-field' }, field.label),
                h('div', { className: 'diff-values' },
                    h('span', { className: 'diff-before' },
                        h(Icon, { name: 'minus', size: 14 }),
                        String(before[field.key] || '(vide)')
                    ),
                    h('span', { className: 'diff-after' },
                        h(Icon, { name: 'plus', size: 14 }),
                        String(after[field.key] || '(vide)')
                    )
                )
            )
        )
    );
};

// ============================================================================
// 6. MODE OFFLINE AMÉLIORÉ
// ============================================================================

/**
 * Gestionnaire de file d'attente offline
 */
const OfflineQueueManager = {
    STORAGE_KEY: 'stockapp-offline-queue',

    getQueue: () => {
        const stored = localStorage.getItem(OfflineQueueManager.STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
    },

    addToQueue: (action) => {
        const queue = OfflineQueueManager.getQueue();
        queue.push({
            ...action,
            id: Math.random().toString(36).substr(2, 9),
            timestamp: Date.now(),
            retries: 0
        });
        localStorage.setItem(OfflineQueueManager.STORAGE_KEY, JSON.stringify(queue));
        return queue.length;
    },

    removeFromQueue: (actionId) => {
        const queue = OfflineQueueManager.getQueue().filter(a => a.id !== actionId);
        localStorage.setItem(OfflineQueueManager.STORAGE_KEY, JSON.stringify(queue));
    },

    clearQueue: () => {
        localStorage.removeItem(OfflineQueueManager.STORAGE_KEY);
    },

    processQueue: async (db, showToast) => {
        const queue = OfflineQueueManager.getQueue();
        if (queue.length === 0) return { success: 0, failed: 0 };

        let success = 0;
        let failed = 0;

        for (const action of queue) {
            try {
                switch (action.type) {
                    case 'INSERT':
                        await db.from(action.table).insert(action.data);
                        break;
                    case 'UPDATE':
                        await db.from(action.table).update(action.data).eq('id', action.id);
                        break;
                    case 'DELETE':
                        await db.from(action.table).delete().eq('id', action.id);
                        break;
                }
                OfflineQueueManager.removeFromQueue(action.id);
                success++;
            } catch (error) {
                console.error('Failed to sync action:', action, error);
                
                // Incrémenter le compteur de retries
                const updatedQueue = OfflineQueueManager.getQueue().map(a => 
                    a.id === action.id ? { ...a, retries: a.retries + 1, lastError: error.message } : a
                );
                localStorage.setItem(OfflineQueueManager.STORAGE_KEY, JSON.stringify(updatedQueue));
                
                // Supprimer après 5 tentatives
                if (action.retries >= 4) {
                    OfflineQueueManager.removeFromQueue(action.id);
                }
                failed++;
            }
        }

        return { success, failed };
    }
};

/**
 * Hook pour la gestion offline
 */
const useOfflineSync = (db) => {
    const [queueLength, setQueueLength] = useState(0);
    const [isSyncing, setIsSyncing] = useState(false);
    const networkStatus = useNetworkStatus();

    useEffect(() => {
        setQueueLength(OfflineQueueManager.getQueue().length);
    }, []);

    useEffect(() => {
        // Sync automatique quand on revient online
        if (networkStatus.isOnline && queueLength > 0 && !isSyncing) {
            syncQueue();
        }
    }, [networkStatus.isOnline]);

    const addToQueue = useCallback((action) => {
        const newLength = OfflineQueueManager.addToQueue(action);
        setQueueLength(newLength);
    }, []);

    const syncQueue = useCallback(async () => {
        if (isSyncing || !networkStatus.isOnline) return;
        
        setIsSyncing(true);
        const result = await OfflineQueueManager.processQueue(db);
        setQueueLength(OfflineQueueManager.getQueue().length);
        setIsSyncing(false);
        
        return result;
    }, [db, isSyncing, networkStatus.isOnline]);

    const clearQueue = useCallback(() => {
        OfflineQueueManager.clearQueue();
        setQueueLength(0);
    }, []);

    return {
        queueLength,
        isSyncing,
        isOnline: networkStatus.isOnline,
        addToQueue,
        syncQueue,
        clearQueue
    };
};

/**
 * Indicateur de synchronisation offline
 */
const OfflineSyncIndicator = ({ queueLength, isSyncing, onSync, onClear }) => {
    if (queueLength === 0) return null;

    return h('div', { className: 'offline-sync-indicator' },
        h('div', { className: 'offline-sync-info' },
            h(Icon, { name: isSyncing ? 'loader' : 'cloud-off', size: 20, className: isSyncing ? 'spinning' : '' }),
            h('span', null, 
                isSyncing 
                    ? 'Synchronisation...' 
                    : `${queueLength} modification${queueLength > 1 ? 's' : ''} en attente`
            )
        ),
        !isSyncing && h('div', { className: 'offline-sync-actions' },
            h('button', { 
                className: 'btn btn-sm btn-primary',
                onClick: onSync
            }, 'Synchroniser'),
            h('button', { 
                className: 'btn btn-sm btn-ghost',
                onClick: onClear,
                title: 'Annuler les modifications en attente'
            }, h(Icon, { name: 'trash', size: 16 }))
        )
    );
};

/**
 * Wrapper pour les opérations DB avec support offline
 */
const createOfflineAwareDB = (db, offlineSync) => {
    return {
        from: (table) => ({
            insert: async (data) => {
                if (!offlineSync.isOnline) {
                    offlineSync.addToQueue({ type: 'INSERT', table, data });
                    return { data, offline: true };
                }
                return db.from(table).insert(data);
            },
            update: (data) => ({
                eq: async (field, value) => {
                    if (!offlineSync.isOnline) {
                        offlineSync.addToQueue({ type: 'UPDATE', table, data, id: value });
                        return { data, offline: true };
                    }
                    return db.from(table).update(data).eq(field, value);
                }
            }),
            delete: () => ({
                eq: async (field, value) => {
                    if (!offlineSync.isOnline) {
                        offlineSync.addToQueue({ type: 'DELETE', table, id: value });
                        return { offline: true };
                    }
                    return db.from(table).delete().eq(field, value);
                }
            }),
            select: (...args) => db.from(table).select(...args)
        })
    };
};

// ============================================================================
// 7. SYSTÈME DE LOGS
// ============================================================================

/**
 * Logger structuré
 */
const Logger = {
    levels: {
        DEBUG: 0,
        INFO: 1,
        WARN: 2,
        ERROR: 3
    },

    currentLevel: 1, // INFO par défaut

    setLevel: (level) => {
        Logger.currentLevel = Logger.levels[level] || 1;
    },

    _format: (level, message, data) => {
        const timestamp = new Date().toISOString();
        return {
            timestamp,
            level,
            message,
            data,
            url: window.location.href,
            userAgent: navigator.userAgent
        };
    },

    _log: (level, levelNum, message, data) => {
        if (levelNum < Logger.currentLevel) return;

        const entry = Logger._format(level, message, data);
        
        // Console
        const consoleMethods = {
            DEBUG: console.debug,
            INFO: console.info,
            WARN: console.warn,
            ERROR: console.error
        };
        consoleMethods[level](`[${level}] ${message}`, data || '');

        // Stockage local (dernières 100 entrées)
        Logger._store(entry);

        // Si erreur, envoyer à un service externe (si configuré)
        if (level === 'ERROR' && Logger.errorHandler) {
            Logger.errorHandler(entry);
        }
    },

    _store: (entry) => {
        const stored = JSON.parse(localStorage.getItem('stockapp-logs') || '[]');
        stored.push(entry);
        // Garder les 100 dernières entrées
        while (stored.length > 100) {
            stored.shift();
        }
        localStorage.setItem('stockapp-logs', JSON.stringify(stored));
    },

    debug: (message, data) => Logger._log('DEBUG', 0, message, data),
    info: (message, data) => Logger._log('INFO', 1, message, data),
    warn: (message, data) => Logger._log('WARN', 2, message, data),
    error: (message, data) => Logger._log('ERROR', 3, message, data),

    // Mesure de performance
    performance: (label, fn) => {
        const start = performance.now();
        const result = fn();
        const duration = performance.now() - start;
        Logger.info(`[PERF] ${label}`, { duration: `${duration.toFixed(2)}ms` });
        return result;
    },

    // Performance async
    performanceAsync: async (label, fn) => {
        const start = performance.now();
        const result = await fn();
        const duration = performance.now() - start;
        Logger.info(`[PERF] ${label}`, { duration: `${duration.toFixed(2)}ms` });
        return result;
    },

    // Récupérer les logs
    getLogs: (level) => {
        const logs = JSON.parse(localStorage.getItem('stockapp-logs') || '[]');
        if (level) {
            return logs.filter(l => l.level === level);
        }
        return logs;
    },

    // Effacer les logs
    clearLogs: () => {
        localStorage.removeItem('stockapp-logs');
    },

    // Exporter les logs
    exportLogs: () => {
        const logs = Logger.getLogs();
        const blob = new Blob([JSON.stringify(logs, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `stockapp-logs-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
    },

    // Configurer un handler d'erreur externe
    errorHandler: null,
    setErrorHandler: (handler) => {
        Logger.errorHandler = handler;
    }
};

/**
 * Error Boundary Component
 */
class ErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false, error: null, errorInfo: null };
    }

    static getDerivedStateFromError(error) {
        return { hasError: true, error };
    }

    componentDidCatch(error, errorInfo) {
        this.setState({ errorInfo });
        Logger.error('React Error Boundary caught an error', {
            error: error.toString(),
            stack: error.stack,
            componentStack: errorInfo.componentStack
        });
    }

    render() {
        if (this.state.hasError) {
            return h('div', { className: 'error-boundary' },
                h('div', { className: 'error-boundary-content' },
                    h('div', { className: 'error-boundary-icon' },
                        h(Icon, { name: 'alert-triangle', size: 64 })
                    ),
                    h('h2', null, 'Oups ! Une erreur est survenue'),
                    h('p', null, 'L\'application a rencontré un problème inattendu.'),
                    this.props.showDetails && this.state.error && h('details', null,
                        h('summary', null, 'Détails techniques'),
                        h('pre', null, this.state.error.toString()),
                        this.state.errorInfo && h('pre', null, this.state.errorInfo.componentStack)
                    ),
                    h('div', { className: 'error-boundary-actions' },
                        h('button', {
                            className: 'btn btn-primary',
                            onClick: () => window.location.reload()
                        }, 'Recharger l\'application'),
                        h('button', {
                            className: 'btn btn-secondary',
                            onClick: () => {
                                Logger.exportLogs();
                            }
                        }, 'Exporter les logs')
                    )
                )
            );
        }

        return this.props.children;
    }
}

// ============================================================================
// EXPORTS
// ============================================================================

// Exporter tous les composants et hooks pour utilisation dans l'application
window.StockAppImprovements = {
    // Hooks
    useTheme,
    useDebounce,
    useThrottle,
    useNetworkStatus,
    useSessionTimeout,
    useRateLimiter,
    useActionHistory,
    useUserPreferences,
    useLocalStorage,
    useHealthCheck,
    useOptimizedFilter,
    useOptimizedSort,
    usePagination,
    useFormValidation,
    useOfflineSync,

    // Composants UI
    SkeletonLoader,
    TableRowSkeleton,
    CardSkeleton,
    Breadcrumb,
    ProgressBar,
    ConnectionIndicator,
    SessionTimeoutWarning,
    GuidedTour,
    SearchWithHistory,
    FavoritesManager,
    FavoriteButton,
    FilterPresets,
    ViewModeSelector,
    QuickActions,
    ToastImproved,
    EmptyStateImproved,
    Pagination,
    ValidatedInput,
    ExportModal,
    DiffViewer,
    OfflineSyncIndicator,
    ErrorBoundary,

    // Performance
    VirtualizedList,
    VirtualizedTable,

    // Utilitaires
    Validators,
    Sanitizers,
    ExportManager,
    OfflineQueueManager,
    createOfflineAwareDB,
    Logger
};

console.log('[StockApp Improvements] Module chargé avec succès');


// ============================================================================
// STOCKAPP v5.2 - COMPOSANTS MOBILE
// ============================================================================

/**
 * ============================================================================
 * STOCKAPP v5.2 - COMPOSANTS MOBILES & INTERACTIONS AVANCÉES
 * ============================================================================
 * Ce fichier contient les composants pour:
 * - Gestes tactiles (swipe, pull-to-refresh)
 * - Interactions mobiles avancées
 * - Composants adaptatifs
 * ============================================================================
 */

// Note: h, useState, useEffect, etc. sont déjà déclarés dans le code principal

// ============================================================================
// SWIPE ACTIONS
// ============================================================================

/**
 * Hook pour détecter les gestes de swipe
 */
const useSwipeGesture = (options = {}) => {
    const {
        threshold = 50,
        onSwipeLeft,
        onSwipeRight,
        onSwipeUp,
        onSwipeDown,
        preventScroll = false
    } = options;

    const touchStart = useRef({ x: 0, y: 0 });
    const touchEnd = useRef({ x: 0, y: 0 });

    const onTouchStart = useCallback((e) => {
        touchStart.current = {
            x: e.targetTouches[0].clientX,
            y: e.targetTouches[0].clientY
        };
    }, []);

    const onTouchMove = useCallback((e) => {
        touchEnd.current = {
            x: e.targetTouches[0].clientX,
            y: e.targetTouches[0].clientY
        };

        if (preventScroll) {
            const deltaX = Math.abs(touchEnd.current.x - touchStart.current.x);
            const deltaY = Math.abs(touchEnd.current.y - touchStart.current.y);
            if (deltaX > deltaY) {
                e.preventDefault();
            }
        }
    }, [preventScroll]);

    const onTouchEnd = useCallback(() => {
        const deltaX = touchEnd.current.x - touchStart.current.x;
        const deltaY = touchEnd.current.y - touchStart.current.y;
        const absDeltaX = Math.abs(deltaX);
        const absDeltaY = Math.abs(deltaY);

        if (Math.max(absDeltaX, absDeltaY) < threshold) return;

        if (absDeltaX > absDeltaY) {
            // Swipe horizontal
            if (deltaX > 0) {
                onSwipeRight?.();
            } else {
                onSwipeLeft?.();
            }
        } else {
            // Swipe vertical
            if (deltaY > 0) {
                onSwipeDown?.();
            } else {
                onSwipeUp?.();
            }
        }
    }, [threshold, onSwipeLeft, onSwipeRight, onSwipeUp, onSwipeDown]);

    return {
        onTouchStart,
        onTouchMove,
        onTouchEnd
    };
};

/**
 * Composant de ligne avec actions swipe
 */
const SwipeableRow = ({
    children,
    leftActions = [],
    rightActions = [],
    onSwipeLeft,
    onSwipeRight,
    threshold = 80,
    className = ''
}) => {
    const rowRef = useRef(null);
    const [offset, setOffset] = useState(0);
    const [isDragging, setIsDragging] = useState(false);
    const [showActions, setShowActions] = useState(null); // 'left' | 'right' | null
    const startX = useRef(0);
    const currentX = useRef(0);

    const handleTouchStart = (e) => {
        startX.current = e.touches[0].clientX;
        currentX.current = startX.current;
        setIsDragging(true);
    };

    const handleTouchMove = (e) => {
        if (!isDragging) return;
        
        currentX.current = e.touches[0].clientX;
        const delta = currentX.current - startX.current;
        
        // Limiter le déplacement
        const maxOffset = Math.max(leftActions.length, rightActions.length) * 80;
        const limitedOffset = Math.max(-maxOffset, Math.min(maxOffset, delta));
        
        // Résistance aux bords
        const resistance = 0.5;
        if ((delta > 0 && leftActions.length === 0) || (delta < 0 && rightActions.length === 0)) {
            setOffset(limitedOffset * resistance);
        } else {
            setOffset(limitedOffset);
        }
    };

    const handleTouchEnd = () => {
        setIsDragging(false);
        
        if (Math.abs(offset) > threshold) {
            if (offset > 0 && leftActions.length > 0) {
                setShowActions('left');
                setOffset(leftActions.length * 80);
                onSwipeRight?.();
            } else if (offset < 0 && rightActions.length > 0) {
                setShowActions('right');
                setOffset(-rightActions.length * 80);
                onSwipeLeft?.();
            } else {
                resetPosition();
            }
        } else {
            resetPosition();
        }
    };

    const resetPosition = () => {
        setOffset(0);
        setShowActions(null);
    };

    const handleActionClick = (action) => {
        action.onClick?.();
        resetPosition();
    };

    return h('div', { 
        className: `swipeable-row-container ${className}`,
        style: { position: 'relative', overflow: 'hidden' }
    },
        // Actions de gauche
        leftActions.length > 0 && h('div', { 
            className: 'swipe-actions swipe-actions-left',
            style: {
                position: 'absolute',
                left: 0,
                top: 0,
                bottom: 0,
                display: 'flex',
                transform: `translateX(${Math.min(0, offset - leftActions.length * 80)}px)`,
                transition: isDragging ? 'none' : 'transform 0.3s ease'
            }
        },
            leftActions.map((action, i) =>
                h('button', {
                    key: i,
                    className: `swipe-action swipe-action-${action.color || 'primary'}`,
                    onClick: () => handleActionClick(action),
                    style: { width: 80 }
                },
                    h(Icon, { name: action.icon, size: 20 }),
                    action.label && h('span', null, action.label)
                )
            )
        ),
        
        // Actions de droite
        rightActions.length > 0 && h('div', { 
            className: 'swipe-actions swipe-actions-right',
            style: {
                position: 'absolute',
                right: 0,
                top: 0,
                bottom: 0,
                display: 'flex',
                transform: `translateX(${Math.max(0, offset + rightActions.length * 80)}px)`,
                transition: isDragging ? 'none' : 'transform 0.3s ease'
            }
        },
            rightActions.map((action, i) =>
                h('button', {
                    key: i,
                    className: `swipe-action swipe-action-${action.color || 'danger'}`,
                    onClick: () => handleActionClick(action),
                    style: { width: 80 }
                },
                    h(Icon, { name: action.icon, size: 20 }),
                    action.label && h('span', null, action.label)
                )
            )
        ),
        
        // Contenu principal
        h('div', {
            ref: rowRef,
            className: 'swipeable-row-content',
            style: {
                transform: `translateX(${offset}px)`,
                transition: isDragging ? 'none' : 'transform 0.3s ease',
                background: 'var(--card)',
                position: 'relative',
                zIndex: 1
            },
            onTouchStart: handleTouchStart,
            onTouchMove: handleTouchMove,
            onTouchEnd: handleTouchEnd,
            onClick: showActions ? resetPosition : undefined
        }, children)
    );
};

// ============================================================================
// PULL TO REFRESH
// ============================================================================

/**
 * Composant Pull to Refresh
 */
const PullToRefresh = ({
    children,
    onRefresh,
    threshold = 80,
    maxPull = 120,
    refreshingText = 'Actualisation...',
    pullText = 'Tirer pour actualiser',
    releaseText = 'Relâcher pour actualiser'
}) => {
    const containerRef = useRef(null);
    const [pullDistance, setPullDistance] = useState(0);
    const [isRefreshing, setIsRefreshing] = useState(false);
    const [isPulling, setIsPulling] = useState(false);
    const startY = useRef(0);

    const handleTouchStart = (e) => {
        if (containerRef.current?.scrollTop === 0) {
            startY.current = e.touches[0].clientY;
            setIsPulling(true);
        }
    };

    const handleTouchMove = (e) => {
        if (!isPulling || isRefreshing) return;
        
        const currentY = e.touches[0].clientY;
        const delta = currentY - startY.current;
        
        if (delta > 0) {
            e.preventDefault();
            // Résistance progressive
            const resistance = 1 - Math.min(delta / (maxPull * 2), 0.5);
            const distance = Math.min(delta * resistance, maxPull);
            setPullDistance(distance);
        }
    };

    const handleTouchEnd = async () => {
        if (!isPulling) return;
        
        setIsPulling(false);
        
        if (pullDistance >= threshold && !isRefreshing) {
            setIsRefreshing(true);
            setPullDistance(60); // Position de chargement
            
            try {
                await onRefresh?.();
            } finally {
                setIsRefreshing(false);
                setPullDistance(0);
            }
        } else {
            setPullDistance(0);
        }
    };

    const getStatusText = () => {
        if (isRefreshing) return refreshingText;
        if (pullDistance >= threshold) return releaseText;
        return pullText;
    };

    const getRotation = () => {
        if (isRefreshing) return 0;
        return Math.min((pullDistance / threshold) * 180, 180);
    };

    return h('div', {
        ref: containerRef,
        className: 'pull-to-refresh-container',
        onTouchStart: handleTouchStart,
        onTouchMove: handleTouchMove,
        onTouchEnd: handleTouchEnd,
        style: { 
            overflow: 'auto',
            height: '100%',
            position: 'relative'
        }
    },
        h('div', {
            className: `pull-to-refresh-indicator ${isRefreshing ? 'refreshing' : ''}`,
            style: {
                height: pullDistance,
                transition: isPulling ? 'none' : 'height 0.3s ease',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                overflow: 'hidden'
            }
        },
            h('div', { className: 'pull-to-refresh-content' },
                h('div', {
                    className: `pull-to-refresh-icon ${isRefreshing ? 'spinning' : ''}`,
                    style: {
                        transform: `rotate(${getRotation()}deg)`,
                        transition: isPulling ? 'none' : 'transform 0.3s ease'
                    }
                },
                    h(Icon, { name: isRefreshing ? 'loader' : 'arrow-down', size: 24 })
                ),
                h('span', { className: 'pull-to-refresh-text' }, getStatusText())
            )
        ),
        children
    );
};

// ============================================================================
// BOTTOM SHEET
// ============================================================================

/**
 * Composant Bottom Sheet (panneau du bas mobile)
 */
const BottomSheet = ({
    isOpen,
    onClose,
    title,
    children,
    snapPoints = [0.5, 0.9],
    initialSnap = 0,
    showHandle = true
}) => {
    const sheetRef = useRef(null);
    const [currentSnap, setCurrentSnap] = useState(initialSnap);
    const [isDragging, setIsDragging] = useState(false);
    const [dragOffset, setDragOffset] = useState(0);
    const startY = useRef(0);

    const getHeight = () => {
        const snapHeight = snapPoints[currentSnap] * window.innerHeight;
        return isDragging ? snapHeight - dragOffset : snapHeight;
    };

    const handleTouchStart = (e) => {
        startY.current = e.touches[0].clientY;
        setIsDragging(true);
    };

    const handleTouchMove = (e) => {
        if (!isDragging) return;
        const delta = e.touches[0].clientY - startY.current;
        setDragOffset(delta);
    };

    const handleTouchEnd = () => {
        setIsDragging(false);
        
        const currentHeight = getHeight();
        const windowHeight = window.innerHeight;
        
        // Trouver le snap point le plus proche
        let closestSnap = 0;
        let closestDistance = Infinity;
        
        snapPoints.forEach((point, index) => {
            const snapHeight = point * windowHeight;
            const distance = Math.abs(currentHeight - snapHeight);
            if (distance < closestDistance) {
                closestDistance = distance;
                closestSnap = index;
            }
        });
        
        // Fermer si tiré suffisamment vers le bas
        if (dragOffset > 100 && currentSnap === 0) {
            onClose?.();
        } else {
            setCurrentSnap(closestSnap);
        }
        
        setDragOffset(0);
    };

    useEffect(() => {
        if (isOpen) {
            setCurrentSnap(initialSnap);
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
        
        return () => {
            document.body.style.overflow = '';
        };
    }, [isOpen, initialSnap]);

    if (!isOpen) return null;

    return h('div', { className: 'bottom-sheet-overlay', onClick: onClose },
        h('div', {
            ref: sheetRef,
            className: 'bottom-sheet',
            style: {
                height: getHeight(),
                transition: isDragging ? 'none' : 'height 0.3s ease'
            },
            onClick: (e) => e.stopPropagation()
        },
            showHandle && h('div', {
                className: 'bottom-sheet-handle',
                onTouchStart: handleTouchStart,
                onTouchMove: handleTouchMove,
                onTouchEnd: handleTouchEnd
            },
                h('div', { className: 'bottom-sheet-handle-bar' })
            ),
            title && h('div', { className: 'bottom-sheet-header' },
                h('h3', null, title),
                h('button', { 
                    className: 'bottom-sheet-close',
                    onClick: onClose
                }, h(Icon, { name: 'x', size: 20 }))
            ),
            h('div', { className: 'bottom-sheet-content' }, children)
        )
    );
};

// ============================================================================
// HAPTIC FEEDBACK
// ============================================================================

/**
 * Utilitaires pour le feedback haptique
 */
const HapticFeedback = {
    // Vibration légère
    light: () => {
        if ('vibrate' in navigator) {
            navigator.vibrate(10);
        }
    },
    
    // Vibration moyenne
    medium: () => {
        if ('vibrate' in navigator) {
            navigator.vibrate(20);
        }
    },
    
    // Vibration forte
    heavy: () => {
        if ('vibrate' in navigator) {
            navigator.vibrate(30);
        }
    },
    
    // Vibration de succès
    success: () => {
        if ('vibrate' in navigator) {
            navigator.vibrate([10, 50, 10]);
        }
    },
    
    // Vibration d'erreur
    error: () => {
        if ('vibrate' in navigator) {
            navigator.vibrate([30, 50, 30, 50, 30]);
        }
    },
    
    // Vibration de notification
    notification: () => {
        if ('vibrate' in navigator) {
            navigator.vibrate([20, 100, 20]);
        }
    }
};

// ============================================================================
// LONG PRESS
// ============================================================================

/**
 * Hook pour détecter les appuis longs
 */
const useLongPress = (callback, options = {}) => {
    const { delay = 500, onStart, onEnd } = options;
    const timeoutRef = useRef(null);
    const isLongPress = useRef(false);

    const start = useCallback((e) => {
        isLongPress.current = false;
        onStart?.();
        
        timeoutRef.current = setTimeout(() => {
            isLongPress.current = true;
            HapticFeedback.medium();
            callback(e);
        }, delay);
    }, [callback, delay, onStart]);

    const clear = useCallback(() => {
        clearTimeout(timeoutRef.current);
        onEnd?.();
    }, [onEnd]);

    return {
        onMouseDown: start,
        onMouseUp: clear,
        onMouseLeave: clear,
        onTouchStart: start,
        onTouchEnd: clear,
        onTouchCancel: clear
    };
};

/**
 * Composant avec support long press
 */
const LongPressable = ({ 
    children, 
    onLongPress, 
    onPress,
    delay = 500,
    className = ''
}) => {
    const longPressHandlers = useLongPress(onLongPress, { delay });
    const isLongPress = useRef(false);

    const handleClick = (e) => {
        if (!isLongPress.current) {
            onPress?.(e);
        }
        isLongPress.current = false;
    };

    return h('div', {
        className: `long-pressable ${className}`,
        onClick: handleClick,
        ...longPressHandlers
    }, children);
};

// ============================================================================
// CONTEXT MENU MOBILE
// ============================================================================

/**
 * Menu contextuel pour mobile (remplace le clic droit)
 */
const MobileContextMenu = ({ 
    isOpen, 
    onClose, 
    position,
    actions = []
}) => {
    const menuRef = useRef(null);

    useEffect(() => {
        if (isOpen) {
            HapticFeedback.light();
        }
    }, [isOpen]);

    useEffect(() => {
        const handleClickOutside = (e) => {
            if (menuRef.current && !menuRef.current.contains(e.target)) {
                onClose();
            }
        };

        if (isOpen) {
            document.addEventListener('touchstart', handleClickOutside);
            document.addEventListener('mousedown', handleClickOutside);
        }

        return () => {
            document.removeEventListener('touchstart', handleClickOutside);
            document.removeEventListener('mousedown', handleClickOutside);
        };
    }, [isOpen, onClose]);

    if (!isOpen) return null;

    // Ajuster la position pour rester dans l'écran
    const adjustedPosition = {
        x: Math.min(position.x, window.innerWidth - 200),
        y: Math.min(position.y, window.innerHeight - (actions.length * 50 + 20))
    };

    return h('div', {
        ref: menuRef,
        className: 'mobile-context-menu',
        style: {
            position: 'fixed',
            left: adjustedPosition.x,
            top: adjustedPosition.y,
            zIndex: 10000
        }
    },
        actions.map((action, i) =>
            h('button', {
                key: i,
                className: `context-menu-item ${action.danger ? 'danger' : ''}`,
                onClick: () => {
                    HapticFeedback.light();
                    action.onClick?.();
                    onClose();
                },
                disabled: action.disabled
            },
                action.icon && h(Icon, { name: action.icon, size: 18 }),
                h('span', null, action.label)
            )
        )
    );
};

// ============================================================================
// FLOATING LABEL INPUT
// ============================================================================

/**
 * Input avec label flottant (style Material Design)
 */
const FloatingLabelInput = ({
    id,
    label,
    type = 'text',
    value,
    onChange,
    error,
    required,
    disabled,
    ...props
}) => {
    const [isFocused, setIsFocused] = useState(false);
    const hasValue = value && value.length > 0;

    return h('div', { 
        className: `floating-input ${isFocused ? 'focused' : ''} ${hasValue ? 'has-value' : ''} ${error ? 'has-error' : ''} ${disabled ? 'disabled' : ''}`
    },
        h('input', {
            id,
            type,
            value,
            onChange,
            disabled,
            required,
            onFocus: () => setIsFocused(true),
            onBlur: () => setIsFocused(false),
            ...props
        }),
        h('label', { htmlFor: id },
            label,
            required && h('span', { className: 'required' }, ' *')
        ),
        h('div', { className: 'floating-input-line' }),
        error && h('span', { className: 'floating-input-error' }, error)
    );
};

// ============================================================================
// CHIP INPUT
// ============================================================================

/**
 * Input avec chips/tags
 */
const ChipInput = ({
    value = [],
    onChange,
    placeholder = 'Ajouter...',
    suggestions = [],
    maxChips,
    allowCustom = true
}) => {
    const [inputValue, setInputValue] = useState('');
    const [showSuggestions, setShowSuggestions] = useState(false);
    const inputRef = useRef(null);

    const filteredSuggestions = suggestions.filter(s => 
        s.toLowerCase().includes(inputValue.toLowerCase()) &&
        !value.includes(s)
    );

    const addChip = (chip) => {
        if (maxChips && value.length >= maxChips) return;
        if (value.includes(chip)) return;
        
        onChange([...value, chip]);
        setInputValue('');
        HapticFeedback.light();
    };

    const removeChip = (index) => {
        const newValue = value.filter((_, i) => i !== index);
        onChange(newValue);
        HapticFeedback.light();
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && inputValue.trim()) {
            e.preventDefault();
            if (allowCustom || filteredSuggestions.includes(inputValue.trim())) {
                addChip(inputValue.trim());
            }
        } else if (e.key === 'Backspace' && !inputValue && value.length > 0) {
            removeChip(value.length - 1);
        }
    };

    return h('div', { className: 'chip-input-container' },
        h('div', { 
            className: 'chip-input',
            onClick: () => inputRef.current?.focus()
        },
            value.map((chip, i) =>
                h('span', { key: i, className: 'chip' },
                    chip,
                    h('button', {
                        className: 'chip-remove',
                        onClick: (e) => {
                            e.stopPropagation();
                            removeChip(i);
                        }
                    }, '×')
                )
            ),
            h('input', {
                ref: inputRef,
                type: 'text',
                value: inputValue,
                onChange: (e) => setInputValue(e.target.value),
                onFocus: () => setShowSuggestions(true),
                onBlur: () => setTimeout(() => setShowSuggestions(false), 200),
                onKeyDown: handleKeyDown,
                placeholder: value.length === 0 ? placeholder : '',
                disabled: maxChips && value.length >= maxChips
            })
        ),
        showSuggestions && filteredSuggestions.length > 0 && h('div', { className: 'chip-suggestions' },
            filteredSuggestions.map((suggestion, i) =>
                h('button', {
                    key: i,
                    className: 'chip-suggestion',
                    onMouseDown: (e) => {
                        e.preventDefault();
                        addChip(suggestion);
                    }
                }, suggestion)
            )
        )
    );
};

// ============================================================================
// SEGMENTED CONTROL
// ============================================================================

/**
 * Contrôle segmenté (style iOS)
 */
const SegmentedControl = ({
    options,
    value,
    onChange,
    size = 'md',
    fullWidth = false
}) => {
    const getOptionIndex = () => options.findIndex(o => o.value === value);
    const activeIndex = getOptionIndex();

    return h('div', { 
        className: `segmented-control segmented-${size} ${fullWidth ? 'full-width' : ''}`
    },
        h('div', {
            className: 'segmented-indicator',
            style: {
                width: `${100 / options.length}%`,
                transform: `translateX(${activeIndex * 100}%)`
            }
        }),
        options.map((option, i) =>
            h('button', {
                key: option.value,
                className: `segmented-option ${value === option.value ? 'active' : ''}`,
                onClick: () => {
                    HapticFeedback.light();
                    onChange(option.value);
                },
                disabled: option.disabled
            },
                option.icon && h(Icon, { name: option.icon, size: 16 }),
                h('span', null, option.label)
            )
        )
    );
};

// ============================================================================
// STEPPER
// ============================================================================

/**
 * Contrôle stepper pour quantités
 */
const Stepper = ({
    value,
    onChange,
    min = 0,
    max = 999,
    step = 1,
    size = 'md',
    disabled = false
}) => {
    const decrease = () => {
        if (value > min) {
            HapticFeedback.light();
            onChange(Math.max(min, value - step));
        }
    };

    const increase = () => {
        if (value < max) {
            HapticFeedback.light();
            onChange(Math.min(max, value + step));
        }
    };

    return h('div', { className: `stepper stepper-${size} ${disabled ? 'disabled' : ''}` },
        h('button', {
            className: 'stepper-btn stepper-decrease',
            onClick: decrease,
            disabled: disabled || value <= min
        }, h(Icon, { name: 'minus', size: 18 })),
        h('span', { className: 'stepper-value' }, value),
        h('button', {
            className: 'stepper-btn stepper-increase',
            onClick: increase,
            disabled: disabled || value >= max
        }, h(Icon, { name: 'plus', size: 18 }))
    );
};

// ============================================================================
// ACTION SHEET
// ============================================================================

/**
 * Action Sheet (menu d'actions iOS style)
 */
const ActionSheet = ({
    isOpen,
    onClose,
    title,
    message,
    actions = [],
    cancelLabel = 'Annuler'
}) => {
    useEffect(() => {
        if (isOpen) {
            HapticFeedback.light();
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
        
        return () => {
            document.body.style.overflow = '';
        };
    }, [isOpen]);

    if (!isOpen) return null;

    return h('div', { className: 'action-sheet-overlay', onClick: onClose },
        h('div', { 
            className: 'action-sheet',
            onClick: (e) => e.stopPropagation()
        },
            h('div', { className: 'action-sheet-content' },
                (title || message) && h('div', { className: 'action-sheet-header' },
                    title && h('div', { className: 'action-sheet-title' }, title),
                    message && h('div', { className: 'action-sheet-message' }, message)
                ),
                h('div', { className: 'action-sheet-actions' },
                    actions.map((action, i) =>
                        h('button', {
                            key: i,
                            className: `action-sheet-btn ${action.destructive ? 'destructive' : ''}`,
                            onClick: () => {
                                HapticFeedback.light();
                                action.onClick?.();
                                onClose();
                            },
                            disabled: action.disabled
                        },
                            action.icon && h(Icon, { name: action.icon, size: 20 }),
                            action.label
                        )
                    )
                )
            ),
            h('button', {
                className: 'action-sheet-cancel',
                onClick: onClose
            }, cancelLabel)
        )
    );
};

// ============================================================================
// EXPORTS
// ============================================================================

window.StockAppMobile = {
    // Hooks
    useSwipeGesture,
    useLongPress,
    
    // Composants
    SwipeableRow,
    PullToRefresh,
    BottomSheet,
    LongPressable,
    MobileContextMenu,
    FloatingLabelInput,
    ChipInput,
    SegmentedControl,
    Stepper,
    ActionSheet,
    
    // Utilitaires
    HapticFeedback
};

console.log('[StockApp Mobile] Module chargé avec succès');


// ============================================================================
// STOCKAPP v5.2 - TOURS GUIDÉS
// ============================================================================

/**
 * ============================================================================
 * STOCKAPP v5.2 - CONFIGURATION DU TOUR GUIDÉ (ONBOARDING)
 * ============================================================================
 * Configuration des étapes du tour guidé pour les nouveaux utilisateurs
 * ============================================================================
 */

// ============================================================================
// TOURS DISPONIBLES
// ============================================================================

const Tours = {
    // Tour principal pour les nouveaux utilisateurs
    welcome: {
        id: 'welcome-tour',
        name: 'Bienvenue sur StockApp',
        description: 'Découvrez les fonctionnalités principales de l\'application',
        steps: [
            {
                target: '.sidebar-logo',
                title: 'Bienvenue sur StockApp! 👋',
                content: 'StockApp est votre outil de gestion de stock et d\'interventions. Laissez-nous vous faire découvrir les fonctionnalités principales.',
                position: 'right'
            },
            {
                target: '.nav-item[href="/dashboard"]',
                title: 'Tableau de bord',
                content: 'Votre vue d\'ensemble avec les indicateurs clés: stock, interventions en cours, alertes...',
                position: 'right'
            },
            {
                target: '.nav-item[href="/stock"]',
                title: 'Gestion du Stock',
                content: 'Gérez vos pièces et fournitures: ajout, modification, suivi des quantités et alertes de rupture.',
                position: 'right'
            },
            {
                target: '.nav-item[href="/travaux"]',
                title: 'Travaux & Interventions',
                content: 'Planifiez et suivez vos interventions terrain. Assignez des techniciens et suivez l\'avancement.',
                position: 'right'
            },
            {
                target: '.global-search-trigger',
                title: 'Recherche globale',
                content: 'Recherchez n\'importe quoi rapidement avec Ctrl+K (ou ⌘K sur Mac). Pièces, travaux, utilisateurs...',
                position: 'bottom'
            },
            {
                target: '.notifications-btn',
                title: 'Notifications',
                content: 'Restez informé des alertes stock, nouvelles assignations et mises à jour importantes.',
                position: 'bottom'
            },
            {
                target: '.theme-toggle',
                title: 'Mode sombre',
                content: 'Basculez entre le mode clair et sombre selon vos préférences.',
                position: 'bottom'
            },
            {
                target: '.user-menu',
                title: 'Votre profil',
                content: 'Accédez à vos paramètres, préférences et déconnexion ici.',
                position: 'bottom-end'
            }
        ]
    },

    // Tour pour la page Stock
    stock: {
        id: 'stock-tour',
        name: 'Gestion du Stock',
        description: 'Apprenez à gérer efficacement votre inventaire',
        steps: [
            {
                target: '.stock-header',
                title: 'Page Stock',
                content: 'Bienvenue dans la gestion de votre inventaire. Voyons les fonctionnalités disponibles.',
                position: 'bottom'
            },
            {
                target: '.btn-add-part',
                title: 'Ajouter une pièce',
                content: 'Créez de nouvelles références avec toutes les informations: désignation, catégorie, quantité, seuil d\'alerte...',
                position: 'bottom'
            },
            {
                target: '.stock-search',
                title: 'Recherche',
                content: 'Recherchez par référence ou désignation. Les résultats s\'affichent instantanément.',
                position: 'bottom'
            },
            {
                target: '.category-filter',
                title: 'Filtrer par catégorie',
                content: 'Filtrez l\'affichage par catégorie pour retrouver rapidement vos pièces.',
                position: 'bottom'
            },
            {
                target: '.view-mode-selector',
                title: 'Mode d\'affichage',
                content: 'Basculez entre la vue liste et la vue grille selon vos préférences.',
                position: 'bottom'
            },
            {
                target: '.stock-alerts-badge',
                title: 'Alertes stock',
                content: 'Les pièces en rupture ou sous le seuil minimum sont signalées ici. Cliquez pour les voir.',
                position: 'left'
            },
            {
                target: '.export-btn',
                title: 'Export',
                content: 'Exportez votre inventaire en PDF ou Excel pour vos rapports et inventaires.',
                position: 'bottom'
            },
            {
                target: '.stock-row:first-child',
                title: 'Actions sur une pièce',
                content: 'Cliquez sur une pièce pour voir les détails. Utilisez les icônes pour modifier, ajuster le stock ou voir l\'historique.',
                position: 'top'
            }
        ]
    },

    // Tour pour la page Travaux
    tasks: {
        id: 'tasks-tour',
        name: 'Gestion des Travaux',
        description: 'Maîtrisez la gestion des interventions',
        steps: [
            {
                target: '.tasks-header',
                title: 'Page Travaux',
                content: 'Gérez ici toutes vos interventions et travaux planifiés.',
                position: 'bottom'
            },
            {
                target: '.btn-add-task',
                title: 'Nouveau travail',
                content: 'Créez une nouvelle intervention avec tous les détails: lieu, équipement, technicien assigné...',
                position: 'bottom'
            },
            {
                target: '.status-filter',
                title: 'Filtrer par statut',
                content: 'Filtrez les travaux par statut: non défini, en commande, en stock, effectué.',
                position: 'bottom'
            },
            {
                target: '.kanban-toggle',
                title: 'Vue Kanban',
                content: 'Passez en vue Kanban pour visualiser vos travaux par colonne de statut. Glissez-déposez pour changer le statut!',
                position: 'bottom'
            },
            {
                target: '.task-row:first-child .status-badge',
                title: 'Changer le statut',
                content: 'Cliquez sur le badge de statut pour le modifier rapidement.',
                position: 'left'
            },
            {
                target: '.task-row:first-child .assign-select',
                title: 'Assigner un technicien',
                content: 'Assignez ou réassignez un technicien directement depuis la liste.',
                position: 'left'
            },
            {
                target: '.archives-btn',
                title: 'Archives',
                content: 'Consultez l\'historique des travaux terminés et archivés.',
                position: 'bottom'
            }
        ]
    },

    // Tour pour le Dashboard
    dashboard: {
        id: 'dashboard-tour',
        name: 'Tableau de bord',
        description: 'Comprendre votre tableau de bord',
        steps: [
            {
                target: '.dashboard-stats',
                title: 'Statistiques clés',
                content: 'Vue rapide de vos indicateurs principaux: travaux, stock, alertes.',
                position: 'bottom'
            },
            {
                target: '.dashboard-chart',
                title: 'Graphiques',
                content: 'Visualisez l\'évolution de votre activité sur les dernières semaines.',
                position: 'top'
            },
            {
                target: '.recent-tasks',
                title: 'Travaux récents',
                content: 'Accès rapide aux derniers travaux créés ou modifiés.',
                position: 'left'
            },
            {
                target: '.low-stock-widget',
                title: 'Alertes stock',
                content: 'Liste des pièces en rupture nécessitant une action.',
                position: 'left'
            },
            {
                target: '.quick-actions-widget',
                title: 'Actions rapides',
                content: 'Raccourcis vers les actions les plus fréquentes.',
                position: 'top'
            }
        ]
    },

    // Tour pour les fonctionnalités avancées
    advanced: {
        id: 'advanced-tour',
        name: 'Fonctionnalités avancées',
        description: 'Découvrez les fonctionnalités expert',
        steps: [
            {
                target: '.keyboard-shortcuts-hint',
                title: 'Raccourcis clavier',
                content: 'Appuyez sur ? pour voir tous les raccourcis clavier disponibles et gagner en productivité.',
                position: 'bottom'
            },
            {
                target: '.bulk-actions-btn',
                title: 'Actions groupées',
                content: 'Sélectionnez plusieurs éléments et appliquez des actions en masse.',
                position: 'bottom'
            },
            {
                target: '.filters-advanced',
                title: 'Filtres avancés',
                content: 'Combinez plusieurs critères de filtrage et sauvegardez vos filtres favoris.',
                position: 'bottom'
            },
            {
                target: '.import-btn',
                title: 'Import de données',
                content: 'Importez vos données depuis Excel ou CSV pour une mise à jour rapide.',
                position: 'bottom'
            },
            {
                target: '.api-docs-link',
                title: 'API & Intégrations',
                content: 'Consultez la documentation API pour intégrer StockApp avec vos autres outils.',
                position: 'left'
            }
        ]
    },

    // Tour mobile
    mobile: {
        id: 'mobile-tour',
        name: 'Version mobile',
        description: 'Optimisez votre utilisation sur mobile',
        steps: [
            {
                target: '.mobile-menu-btn',
                title: 'Menu',
                content: 'Accédez au menu principal en tapant ici.',
                position: 'bottom'
            },
            {
                target: '.scan-btn',
                title: 'Scanner',
                content: 'Scannez les codes-barres directement avec votre appareil photo.',
                position: 'bottom'
            },
            {
                target: '.swipeable-row',
                title: 'Gestes tactiles',
                content: 'Glissez les lignes vers la gauche ou la droite pour accéder aux actions rapides.',
                position: 'top'
            },
            {
                target: '.pull-to-refresh-hint',
                title: 'Actualiser',
                content: 'Tirez vers le bas pour rafraîchir les données.',
                position: 'bottom'
            }
        ]
    }
};

// ============================================================================
// GESTIONNAIRE DE TOURS
// ============================================================================

const TourManager = {
    STORAGE_KEY: 'stockapp-tours-completed',

    // Vérifier si un tour a été complété
    isCompleted: (tourId) => {
        const completed = JSON.parse(localStorage.getItem(TourManager.STORAGE_KEY) || '[]');
        return completed.includes(tourId);
    },

    // Marquer un tour comme complété
    markCompleted: (tourId) => {
        const completed = JSON.parse(localStorage.getItem(TourManager.STORAGE_KEY) || '[]');
        if (!completed.includes(tourId)) {
            completed.push(tourId);
            localStorage.setItem(TourManager.STORAGE_KEY, JSON.stringify(completed));
        }
    },

    // Réinitialiser tous les tours
    resetAll: () => {
        localStorage.removeItem(TourManager.STORAGE_KEY);
    },

    // Réinitialiser un tour spécifique
    reset: (tourId) => {
        const completed = JSON.parse(localStorage.getItem(TourManager.STORAGE_KEY) || '[]');
        const filtered = completed.filter(id => id !== tourId);
        localStorage.setItem(TourManager.STORAGE_KEY, JSON.stringify(filtered));
    },

    // Obtenir le tour approprié pour une page
    getTourForPage: (page) => {
        const tourMap = {
            'dashboard': 'dashboard',
            'stock': 'stock',
            'travaux': 'tasks',
            'tasks': 'tasks'
        };
        return tourMap[page] || null;
    },

    // Vérifier si c'est la première visite
    isFirstVisit: () => {
        return !localStorage.getItem('stockapp-visited');
    },

    // Marquer comme visité
    markVisited: () => {
        localStorage.setItem('stockapp-visited', 'true');
    },

    // Obtenir les tours disponibles pour l'utilisateur
    getAvailableTours: (userRole) => {
        const baseTours = ['welcome', 'stock', 'tasks', 'dashboard'];
        
        if (userRole === 'admin') {
            baseTours.push('advanced');
        }
        
        if (window.innerWidth <= 768) {
            baseTours.push('mobile');
        }
        
        return baseTours.map(id => ({
            ...Tours[id],
            completed: TourManager.isCompleted(Tours[id].id)
        }));
    }
};

// ============================================================================
// COMPOSANT LISTE DES TOURS
// ============================================================================

const ToursList = ({ onStartTour, userRole }) => {
    const tours = TourManager.getAvailableTours(userRole);

    return h('div', { className: 'tours-list' },
        h('div', { className: 'tours-header' },
            h('h3', null, 'Guides interactifs'),
            h('p', null, 'Apprenez à utiliser StockApp avec nos tutoriels guidés')
        ),
        h('div', { className: 'tours-grid' },
            tours.map(tour =>
                h('div', { 
                    key: tour.id, 
                    className: `tour-card ${tour.completed ? 'completed' : ''}`
                },
                    h('div', { className: 'tour-card-header' },
                        tour.completed && h('span', { className: 'tour-completed-badge' }, '✓'),
                        h('h4', null, tour.name)
                    ),
                    h('p', null, tour.description),
                    h('div', { className: 'tour-card-footer' },
                        h('span', { className: 'tour-steps-count' }, 
                            `${tour.steps.length} étapes`
                        ),
                        h('button', {
                            className: 'btn btn-sm btn-primary',
                            onClick: () => onStartTour(tour.id)
                        }, tour.completed ? 'Refaire' : 'Commencer')
                    )
                )
            )
        ),
        h('button', {
            className: 'btn btn-ghost btn-sm reset-tours-btn',
            onClick: () => {
                TourManager.resetAll();
                window.location.reload();
            }
        }, 'Réinitialiser tous les tutoriels')
    );
};

// ============================================================================
// STYLES CSS POUR LES TOURS
// ============================================================================

const TourStyles = `
.tours-list {
    padding: 20px;
}

.tours-header {
    margin-bottom: 24px;
}

.tours-header h3 {
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
}

.tours-header p {
    font-size: 14px;
    color: var(--text-secondary);
}

.tours-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.tour-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    transition: var(--transition);
}

.tour-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.tour-card.completed {
    background: var(--success-pastel);
    border-color: var(--success);
}

.tour-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.tour-completed-badge {
    width: 20px;
    height: 20px;
    background: var(--success);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}

.tour-card h4 {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
}

.tour-card p {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 16px;
    line-height: 1.5;
}

.tour-card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.tour-steps-count {
    font-size: 12px;
    color: var(--muted);
}

.reset-tours-btn {
    margin-top: 16px;
}

/* Highlight pendant le tour */
.tour-highlight {
    position: relative;
    z-index: 9999 !important;
    box-shadow: 0 0 0 4px var(--primary), 0 0 0 9999px rgba(0, 0, 0, 0.5) !important;
    border-radius: var(--radius);
}

/* Animation du highlight */
@keyframes tour-pulse {
    0%, 100% {
        box-shadow: 0 0 0 4px var(--primary), 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }
    50% {
        box-shadow: 0 0 0 8px var(--primary-light), 0 0 0 9999px rgba(0, 0, 0, 0.5);
    }
}

.tour-highlight {
    animation: tour-pulse 2s infinite;
}
`;

// ============================================================================
// EXPORTS
// ============================================================================

window.StockAppTours = {
    Tours,
    TourManager,
    ToursList,
    TourStyles
};

console.log('[StockApp Tours] Module chargé avec succès');
/**
 * ============================================================================
 * STOCKAPP v5.3 - NOUVELLES FONCTIONNALITÉS
 * ============================================================================
 * 1. Dashboard personnalisable (widgets drag & drop)
 * 2. Rapports automatiques programmables
 * 3. Double-clic planning
 * 4. Export planning PDF
 * 5. Colonnes redimensionnables
 * 6. Vue Gantt planning
 * 7. Mode multi-sélection
 * 8. Templates de tâches
 * ============================================================================
 */

// ============================================================================
// 1. DASHBOARD PERSONNALISABLE
// ============================================================================

const DASHBOARD_WIDGETS = {
    kpi_stock: {
        id: 'kpi_stock',
        title: 'KPIs Stock',
        icon: '📦',
        size: 'small',
        category: 'stock'
    },
    kpi_tasks: {
        id: 'kpi_tasks',
        title: 'KPIs Tâches',
        icon: '🔧',
        size: 'small',
        category: 'tasks'
    },
    kpi_orders: {
        id: 'kpi_orders',
        title: 'KPIs Commandes',
        icon: '🛒',
        size: 'small',
        category: 'orders'
    },
    chart_stock_movements: {
        id: 'chart_stock_movements',
        title: 'Mouvements de stock',
        icon: '📈',
        size: 'large',
        category: 'charts'
    },
    chart_tasks_status: {
        id: 'chart_tasks_status',
        title: 'Statut des tâches',
        icon: '📊',
        size: 'medium',
        category: 'charts'
    },
    chart_stock_by_category: {
        id: 'chart_stock_by_category',
        title: 'Stock par catégorie',
        icon: '🥧',
        size: 'medium',
        category: 'charts'
    },
    low_stock_alerts: {
        id: 'low_stock_alerts',
        title: 'Alertes stock bas',
        icon: '⚠️',
        size: 'medium',
        category: 'alerts'
    },
    recent_tasks: {
        id: 'recent_tasks',
        title: 'Tâches récentes',
        icon: '📋',
        size: 'medium',
        category: 'tasks'
    },
    upcoming_events: {
        id: 'upcoming_events',
        title: 'Événements à venir',
        icon: '📅',
        size: 'medium',
        category: 'planning'
    },
    team_workload: {
        id: 'team_workload',
        title: 'Charge équipe',
        icon: '👥',
        size: 'medium',
        category: 'team'
    },
    quick_actions: {
        id: 'quick_actions',
        title: 'Actions rapides',
        icon: '⚡',
        size: 'small',
        category: 'actions'
    },
    notifications_feed: {
        id: 'notifications_feed',
        title: 'Fil de notifications',
        icon: '🔔',
        size: 'medium',
        category: 'notifications'
    }
};

const DEFAULT_DASHBOARD_LAYOUT = [
    { id: 'kpi_stock', x: 0, y: 0, w: 3, h: 2 },
    { id: 'kpi_tasks', x: 3, y: 0, w: 3, h: 2 },
    { id: 'kpi_orders', x: 6, y: 0, w: 3, h: 2 },
    { id: 'quick_actions', x: 9, y: 0, w: 3, h: 2 },
    { id: 'chart_stock_movements', x: 0, y: 2, w: 8, h: 4 },
    { id: 'chart_tasks_status', x: 8, y: 2, w: 4, h: 4 },
    { id: 'low_stock_alerts', x: 0, y: 6, w: 4, h: 4 },
    { id: 'recent_tasks', x: 4, y: 6, w: 4, h: 4 },
    { id: 'upcoming_events', x: 8, y: 6, w: 4, h: 4 }
];

/**
 * Hook pour gérer le dashboard personnalisable
 */
const useDashboardLayout = () => {
    const [layout, setLayout] = useState(() => {
        const saved = localStorage.getItem('stockapp-dashboard-layout');
        return saved ? JSON.parse(saved) : DEFAULT_DASHBOARD_LAYOUT;
    });
    
    const [editMode, setEditMode] = useState(false);
    const [draggedWidget, setDraggedWidget] = useState(null);

    useEffect(() => {
        localStorage.setItem('stockapp-dashboard-layout', JSON.stringify(layout));
    }, [layout]);

    const addWidget = (widgetId) => {
        if (layout.find(w => w.id === widgetId)) return;
        const widget = DASHBOARD_WIDGETS[widgetId];
        const newWidget = {
            id: widgetId,
            x: 0,
            y: Math.max(...layout.map(w => w.y + w.h), 0),
            w: widget.size === 'small' ? 3 : widget.size === 'medium' ? 4 : 8,
            h: widget.size === 'small' ? 2 : 4
        };
        setLayout([...layout, newWidget]);
    };

    const removeWidget = (widgetId) => {
        setLayout(layout.filter(w => w.id !== widgetId));
    };

    const updateWidgetPosition = (widgetId, newPos) => {
        setLayout(layout.map(w => w.id === widgetId ? { ...w, ...newPos } : w));
    };

    const resetLayout = () => {
        setLayout(DEFAULT_DASHBOARD_LAYOUT);
    };

    return {
        layout,
        editMode,
        setEditMode,
        draggedWidget,
        setDraggedWidget,
        addWidget,
        removeWidget,
        updateWidgetPosition,
        resetLayout
    };
};

/**
 * Composant Widget du Dashboard
 */
const DashboardWidget = ({ widget, layoutItem, data, editMode, onRemove, onDragStart, onDragEnd }) => {
    const widgetConfig = DASHBOARD_WIDGETS[widget];
    if (!widgetConfig) return null;

    const renderContent = () => {
        switch (widget) {
            case 'kpi_stock':
                return h('div', { className: 'widget-kpi-grid' },
                    h('div', { className: 'widget-kpi' },
                        h('div', { className: 'widget-kpi-value' }, data.parts?.length || 0),
                        h('div', { className: 'widget-kpi-label' }, 'Références')
                    ),
                    h('div', { className: 'widget-kpi' },
                        h('div', { className: 'widget-kpi-value' }, data.parts?.reduce((s, p) => s + (p.quantity || 0), 0).toLocaleString()),
                        h('div', { className: 'widget-kpi-label' }, 'Quantité totale')
                    ),
                    h('div', { className: 'widget-kpi' },
                        h('div', { className: 'widget-kpi-value widget-kpi-warning' }, data.parts?.filter(p => p.quantity <= (p.min_quantity || 0)).length || 0),
                        h('div', { className: 'widget-kpi-label' }, 'Stock bas')
                    )
                );
            
            case 'kpi_tasks':
                const pending = data.tasks?.filter(t => t.status !== 'termine').length || 0;
                const completed = data.tasks?.filter(t => t.status === 'termine').length || 0;
                const urgent = data.tasks?.filter(t => t.priority === 'urgent').length || 0;
                return h('div', { className: 'widget-kpi-grid' },
                    h('div', { className: 'widget-kpi' },
                        h('div', { className: 'widget-kpi-value' }, pending),
                        h('div', { className: 'widget-kpi-label' }, 'En cours')
                    ),
                    h('div', { className: 'widget-kpi' },
                        h('div', { className: 'widget-kpi-value widget-kpi-success' }, completed),
                        h('div', { className: 'widget-kpi-label' }, 'Terminées')
                    ),
                    h('div', { className: 'widget-kpi' },
                        h('div', { className: 'widget-kpi-value widget-kpi-danger' }, urgent),
                        h('div', { className: 'widget-kpi-label' }, 'Urgentes')
                    )
                );

            case 'kpi_orders':
                const enCommande = data.orders?.filter(o => o.status === 'en-commande').length || 0;
                const recues = data.orders?.filter(o => o.status === 'recue').length || 0;
                return h('div', { className: 'widget-kpi-grid' },
                    h('div', { className: 'widget-kpi' },
                        h('div', { className: 'widget-kpi-value' }, data.orders?.length || 0),
                        h('div', { className: 'widget-kpi-label' }, 'Total')
                    ),
                    h('div', { className: 'widget-kpi' },
                        h('div', { className: 'widget-kpi-value widget-kpi-warning' }, enCommande),
                        h('div', { className: 'widget-kpi-label' }, 'En attente')
                    ),
                    h('div', { className: 'widget-kpi' },
                        h('div', { className: 'widget-kpi-value widget-kpi-success' }, recues),
                        h('div', { className: 'widget-kpi-label' }, 'Reçues')
                    )
                );

            case 'low_stock_alerts':
                const lowStock = data.parts?.filter(p => p.quantity <= (p.min_quantity || 0)).slice(0, 5) || [];
                return h('div', { className: 'widget-list' },
                    lowStock.length === 0 
                        ? h('div', { className: 'widget-empty' }, '✅ Aucune alerte')
                        : lowStock.map(p => h('div', { key: p.id, className: 'widget-list-item widget-list-item-warning' },
                            h('div', { className: 'widget-list-item-title' }, p.name),
                            h('div', { className: 'widget-list-item-subtitle' }, `${p.quantity} / ${p.min_quantity || 0} min`)
                        ))
                );

            case 'recent_tasks':
                const recentTasks = data.tasks?.slice(0, 5) || [];
                return h('div', { className: 'widget-list' },
                    recentTasks.map(t => h('div', { key: t.id, className: 'widget-list-item' },
                        h('div', { className: 'widget-list-item-title' }, t.device_number || t.subject),
                        h('div', { className: 'widget-list-item-subtitle' }, t.status)
                    ))
                );

            case 'upcoming_events':
                const today = new Date().toISOString().split('T')[0];
                const upcoming = data.events?.filter(e => e.scheduled_date >= today).slice(0, 5) || [];
                return h('div', { className: 'widget-list' },
                    upcoming.length === 0
                        ? h('div', { className: 'widget-empty' }, 'Aucun événement à venir')
                        : upcoming.map(e => h('div', { key: e.id, className: 'widget-list-item' },
                            h('div', { className: 'widget-list-item-title' }, e.title),
                            h('div', { className: 'widget-list-item-subtitle' }, e.scheduled_date)
                        ))
                );

            case 'quick_actions':
                return h('div', { className: 'widget-actions' },
                    h('button', { className: 'widget-action-btn' }, '➕ Nouvelle pièce'),
                    h('button', { className: 'widget-action-btn' }, '📋 Nouvelle tâche'),
                    h('button', { className: 'widget-action-btn' }, '📅 Nouvel événement'),
                    h('button', { className: 'widget-action-btn' }, '🛒 Nouvelle commande')
                );

            case 'team_workload':
                const workload = {};
                data.tasks?.forEach(t => {
                    if (t.assigned_to) {
                        workload[t.assigned_to] = (workload[t.assigned_to] || 0) + 1;
                    }
                });
                const teamData = Object.entries(workload).slice(0, 5).map(([userId, count]) => {
                    const user = data.users?.find(u => u.id === userId);
                    return { name: user?.first_name || 'Inconnu', count };
                });
                return h('div', { className: 'widget-list' },
                    teamData.map((t, i) => h('div', { key: i, className: 'widget-list-item' },
                        h('div', { className: 'widget-list-item-title' }, t.name),
                        h('div', { className: 'widget-workload-bar' },
                            h('div', { className: 'widget-workload-fill', style: { width: `${Math.min(t.count * 10, 100)}%` } })
                        ),
                        h('span', { className: 'widget-workload-count' }, t.count)
                    ))
                );

            default:
                return h('div', { className: 'widget-empty' }, 'Widget en construction');
        }
    };

    return h('div', {
        className: `dashboard-widget ${editMode ? 'dashboard-widget-edit' : ''}`,
        style: {
            gridColumn: `span ${layoutItem.w}`,
            gridRow: `span ${layoutItem.h}`
        },
        draggable: editMode,
        onDragStart: (e) => editMode && onDragStart(e, layoutItem.id),
        onDragEnd: onDragEnd
    },
        h('div', { className: 'widget-header' },
            h('div', { className: 'widget-title' },
                h('span', { className: 'widget-icon' }, widgetConfig.icon),
                widgetConfig.title
            ),
            editMode && h('button', { 
                className: 'widget-remove-btn',
                onClick: () => onRemove(layoutItem.id)
            }, '✕')
        ),
        h('div', { className: 'widget-content' }, renderContent())
    );
};

/**
 * Panneau d'ajout de widgets
 */
const WidgetPicker = ({ layout, onAddWidget, onClose }) => {
    const availableWidgets = Object.values(DASHBOARD_WIDGETS).filter(
        w => !layout.find(l => l.id === w.id)
    );

    const categories = [...new Set(availableWidgets.map(w => w.category))];

    return h('div', { className: 'widget-picker-overlay', onClick: onClose },
        h('div', { className: 'widget-picker', onClick: e => e.stopPropagation() },
            h('div', { className: 'widget-picker-header' },
                h('h3', null, 'Ajouter un widget'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'widget-picker-content' },
                categories.map(cat => h('div', { key: cat, className: 'widget-picker-category' },
                    h('h4', { className: 'widget-picker-category-title' }, cat.charAt(0).toUpperCase() + cat.slice(1)),
                    h('div', { className: 'widget-picker-grid' },
                        availableWidgets
                            .filter(w => w.category === cat)
                            .map(w => h('div', {
                                key: w.id,
                                className: 'widget-picker-item',
                                onClick: () => { onAddWidget(w.id); onClose(); }
                            },
                                h('span', { className: 'widget-picker-icon' }, w.icon),
                                h('span', { className: 'widget-picker-name' }, w.title)
                            ))
                    )
                ))
            )
        )
    );
};


// ============================================================================
// 2. RAPPORTS AUTOMATIQUES PROGRAMMABLES
// ============================================================================

const REPORT_TYPES = {
    stock_summary: { name: 'Résumé stock', icon: '📦' },
    low_stock: { name: 'Alertes stock bas', icon: '⚠️' },
    tasks_summary: { name: 'Résumé tâches', icon: '📋' },
    completed_tasks: { name: 'Tâches terminées', icon: '✅' },
    team_activity: { name: 'Activité équipe', icon: '👥' },
    orders_summary: { name: 'Résumé commandes', icon: '🛒' },
    planning_weekly: { name: 'Planning hebdomadaire', icon: '📅' },
    full_report: { name: 'Rapport complet', icon: '📊' }
};

const SCHEDULE_FREQUENCIES = {
    daily: { name: 'Quotidien', cron: '0 8 * * *' },
    weekly_monday: { name: 'Hebdo (Lundi)', cron: '0 8 * * 1' },
    weekly_friday: { name: 'Hebdo (Vendredi)', cron: '0 17 * * 5' },
    monthly_first: { name: 'Mensuel (1er)', cron: '0 8 1 * *' },
    monthly_last: { name: 'Mensuel (Dernier)', cron: '0 8 L * *' }
};

/**
 * Hook pour gérer les rapports programmés
 */
const useScheduledReports = () => {
    const [reports, setReports] = useState(() => {
        const saved = localStorage.getItem('stockapp-scheduled-reports');
        return saved ? JSON.parse(saved) : [];
    });

    useEffect(() => {
        localStorage.setItem('stockapp-scheduled-reports', JSON.stringify(reports));
    }, [reports]);

    const addReport = (report) => {
        const newReport = {
            id: Date.now().toString(),
            ...report,
            createdAt: new Date().toISOString(),
            lastRun: null,
            nextRun: calculateNextRun(report.frequency),
            enabled: true
        };
        setReports([...reports, newReport]);
        return newReport;
    };

    const updateReport = (id, updates) => {
        setReports(reports.map(r => r.id === id ? { ...r, ...updates } : r));
    };

    const deleteReport = (id) => {
        setReports(reports.filter(r => r.id !== id));
    };

    const toggleReport = (id) => {
        setReports(reports.map(r => r.id === id ? { ...r, enabled: !r.enabled } : r));
    };

    const runReport = async (id, data) => {
        const report = reports.find(r => r.id === id);
        if (!report) return null;
        
        const result = generateReport(report.type, data, report.options);
        updateReport(id, { 
            lastRun: new Date().toISOString(),
            nextRun: calculateNextRun(report.frequency)
        });
        return result;
    };

    return { reports, addReport, updateReport, deleteReport, toggleReport, runReport };
};

const calculateNextRun = (frequency) => {
    const now = new Date();
    const next = new Date(now);
    
    switch (frequency) {
        case 'daily':
            next.setDate(next.getDate() + 1);
            next.setHours(8, 0, 0, 0);
            break;
        case 'weekly_monday':
            next.setDate(next.getDate() + ((8 - next.getDay()) % 7 || 7));
            next.setHours(8, 0, 0, 0);
            break;
        case 'weekly_friday':
            next.setDate(next.getDate() + ((12 - next.getDay()) % 7 || 7));
            next.setHours(17, 0, 0, 0);
            break;
        case 'monthly_first':
            next.setMonth(next.getMonth() + 1, 1);
            next.setHours(8, 0, 0, 0);
            break;
        case 'monthly_last':
            next.setMonth(next.getMonth() + 2, 0);
            next.setHours(8, 0, 0, 0);
            break;
    }
    return next.toISOString();
};

const generateReport = (type, data, options = {}) => {
    const report = {
        type,
        generatedAt: new Date().toISOString(),
        data: {}
    };

    switch (type) {
        case 'stock_summary':
            report.data = {
                totalParts: data.parts?.length || 0,
                totalQuantity: data.parts?.reduce((s, p) => s + (p.quantity || 0), 0) || 0,
                totalValue: data.parts?.reduce((s, p) => s + ((p.quantity || 0) * (p.price || 0)), 0) || 0,
                lowStock: data.parts?.filter(p => p.quantity <= (p.min_quantity || 0)).length || 0,
                categories: [...new Set(data.parts?.map(p => p.category))].length
            };
            break;
        case 'low_stock':
            report.data = {
                items: data.parts?.filter(p => p.quantity <= (p.min_quantity || 0)) || []
            };
            break;
        case 'tasks_summary':
            report.data = {
                total: data.tasks?.length || 0,
                pending: data.tasks?.filter(t => t.status !== 'termine').length || 0,
                completed: data.tasks?.filter(t => t.status === 'termine').length || 0,
                urgent: data.tasks?.filter(t => t.priority === 'urgent').length || 0
            };
            break;
        case 'full_report':
            report.data = {
                stock: generateReport('stock_summary', data).data,
                tasks: generateReport('tasks_summary', data).data,
                lowStock: generateReport('low_stock', data).data
            };
            break;
    }

    return report;
};

/**
 * Modal de configuration des rapports
 */
const ScheduledReportsModal = ({ isOpen, onClose, reports, onAdd, onDelete, onToggle, onRun, data }) => {
    const [showForm, setShowForm] = useState(false);
    const [formData, setFormData] = useState({
        name: '',
        type: 'stock_summary',
        frequency: 'weekly_monday',
        recipients: '',
        format: 'pdf'
    });

    if (!isOpen) return null;

    const handleSubmit = () => {
        if (!formData.name) return;
        onAdd({
            ...formData,
            recipients: formData.recipients.split(',').map(e => e.trim()).filter(Boolean)
        });
        setFormData({ name: '', type: 'stock_summary', frequency: 'weekly_monday', recipients: '', format: 'pdf' });
        setShowForm(false);
    };

    return h('div', { className: 'modal-overlay', onClick: onClose },
        h('div', { className: 'modal modal-lg', onClick: e => e.stopPropagation() },
            h('div', { className: 'modal-header' },
                h('h2', null, '📊 Rapports automatiques'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'modal-body' },
                !showForm ? h(Fragment, null,
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 20 } },
                        h('p', { style: { color: 'var(--muted)' } }, `${reports.length} rapport(s) configuré(s)`),
                        h('button', { className: 'btn btn-primary', onClick: () => setShowForm(true) }, '+ Nouveau rapport')
                    ),
                    reports.length === 0 
                        ? h('div', { className: 'empty-state' }, 
                            h('div', { className: 'empty-icon' }, '📊'),
                            h('p', null, 'Aucun rapport programmé'),
                            h('p', { className: 'text-muted' }, 'Créez des rapports automatiques envoyés par email')
                        )
                        : h('div', { className: 'reports-list' },
                            reports.map(r => h('div', { key: r.id, className: `report-item ${!r.enabled ? 'report-disabled' : ''}` },
                                h('div', { className: 'report-info' },
                                    h('div', { className: 'report-icon' }, REPORT_TYPES[r.type]?.icon || '📄'),
                                    h('div', null,
                                        h('div', { className: 'report-name' }, r.name),
                                        h('div', { className: 'report-meta' }, 
                                            REPORT_TYPES[r.type]?.name, ' • ',
                                            SCHEDULE_FREQUENCIES[r.frequency]?.name
                                        ),
                                        r.nextRun && h('div', { className: 'report-next' }, 
                                            '⏰ Prochain envoi: ', new Date(r.nextRun).toLocaleDateString('fr-FR')
                                        )
                                    )
                                ),
                                h('div', { className: 'report-actions' },
                                    h('button', { 
                                        className: 'btn btn-sm btn-ghost',
                                        onClick: () => onRun(r.id, data),
                                        title: 'Exécuter maintenant'
                                    }, '▶️'),
                                    h('button', { 
                                        className: `btn btn-sm ${r.enabled ? 'btn-success' : 'btn-ghost'}`,
                                        onClick: () => onToggle(r.id)
                                    }, r.enabled ? '✓ Actif' : 'Inactif'),
                                    h('button', { 
                                        className: 'btn btn-sm btn-danger',
                                        onClick: () => onDelete(r.id)
                                    }, '🗑️')
                                )
                            ))
                        )
                ) : h('div', { className: 'report-form' },
                    h('div', { className: 'form-group' },
                        h('label', null, 'Nom du rapport'),
                        h('input', {
                            type: 'text',
                            className: 'form-control',
                            value: formData.name,
                            onChange: e => setFormData({ ...formData, name: e.target.value }),
                            placeholder: 'Ex: Rapport hebdomadaire stock'
                        })
                    ),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Type de rapport'),
                            h('select', {
                                className: 'form-control',
                                value: formData.type,
                                onChange: e => setFormData({ ...formData, type: e.target.value })
                            },
                                Object.entries(REPORT_TYPES).map(([key, val]) =>
                                    h('option', { key, value: key }, val.icon, ' ', val.name)
                                )
                            )
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Fréquence'),
                            h('select', {
                                className: 'form-control',
                                value: formData.frequency,
                                onChange: e => setFormData({ ...formData, frequency: e.target.value })
                            },
                                Object.entries(SCHEDULE_FREQUENCIES).map(([key, val]) =>
                                    h('option', { key, value: key }, val.name)
                                )
                            )
                        )
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Destinataires (emails séparés par des virgules)'),
                        h('input', {
                            type: 'text',
                            className: 'form-control',
                            value: formData.recipients,
                            onChange: e => setFormData({ ...formData, recipients: e.target.value }),
                            placeholder: 'email1@exemple.fr, email2@exemple.fr'
                        })
                    ),
                    h('div', { className: 'form-group' },
                        h('label', null, 'Format'),
                        h('div', { className: 'btn-group' },
                            ['pdf', 'excel', 'csv'].map(f => h('button', {
                                key: f,
                                className: `btn ${formData.format === f ? 'btn-primary' : 'btn-ghost'}`,
                                onClick: () => setFormData({ ...formData, format: f })
                            }, f.toUpperCase()))
                        )
                    ),
                    h('div', { className: 'form-actions' },
                        h('button', { className: 'btn btn-ghost', onClick: () => setShowForm(false) }, 'Annuler'),
                        h('button', { className: 'btn btn-primary', onClick: handleSubmit }, 'Créer le rapport')
                    )
                )
            )
        )
    );
};


// ============================================================================
// 3. DOUBLE-CLIC PLANNING (création rapide)
// ============================================================================

/**
 * Hook pour gérer le double-clic sur le planning
 */
const usePlanningDoubleClick = (onCreateEvent) => {
    const handleDoubleClick = useCallback((date, hour) => {
        const scheduledDate = new Date(date);
        scheduledDate.setHours(hour || 9, 0, 0, 0);
        
        onCreateEvent({
            scheduled_date: scheduledDate.toISOString().split('T')[0],
            start_time: `${String(hour || 9).padStart(2, '0')}:00`,
            end_time: `${String((hour || 9) + 1).padStart(2, '0')}:00`
        });
    }, [onCreateEvent]);

    return { handleDoubleClick };
};


// ============================================================================
// 4. EXPORT PLANNING PDF
// ============================================================================

const exportPlanningToPDF = async (events, dateRange, viewMode, users = []) => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('landscape', 'mm', 'a4');
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    
    // En-tête
    doc.setFillColor(225, 29, 72);
    doc.rect(0, 0, pageWidth, 25, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.setFont('helvetica', 'bold');
    doc.text('Planning StockApp', margin, 16);
    
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    const dateText = viewMode === 'week' 
        ? `Semaine du ${dateRange.start.toLocaleDateString('fr-FR')} au ${dateRange.end.toLocaleDateString('fr-FR')}`
        : dateRange.start.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    doc.text(dateText, pageWidth - margin, 16, { align: 'right' });
    
    // Corps du planning
    let y = 35;
    const colWidth = (pageWidth - margin * 2) / 7;
    const rowHeight = 8;
    
    // Jours de la semaine
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.setFont('helvetica', 'bold');
    
    const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
    days.forEach((day, i) => {
        const x = margin + i * colWidth;
        doc.setFillColor(248, 250, 252);
        doc.rect(x, y, colWidth, rowHeight, 'F');
        doc.setDrawColor(226, 232, 240);
        doc.rect(x, y, colWidth, rowHeight, 'S');
        doc.text(day, x + colWidth / 2, y + 5.5, { align: 'center' });
    });
    
    y += rowHeight;
    
    // Dates
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(9);
    const startDate = new Date(dateRange.start);
    for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const x = margin + i * colWidth;
        doc.text(date.getDate().toString(), x + colWidth / 2, y + 5, { align: 'center' });
    }
    
    y += rowHeight;
    
    // Événements groupés par jour
    const eventsByDay = {};
    for (let i = 0; i < 7; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        eventsByDay[i] = events.filter(e => e.scheduled_date === dateStr);
    }
    
    // Trouver le nombre max d'événements par jour
    const maxEvents = Math.max(...Object.values(eventsByDay).map(e => e.length), 1);
    const eventHeight = 12;
    
    // Dessiner les événements
    for (let row = 0; row < maxEvents && y < pageHeight - 20; row++) {
        for (let col = 0; col < 7; col++) {
            const x = margin + col * colWidth;
            const event = eventsByDay[col][row];
            
            doc.setDrawColor(226, 232, 240);
            doc.rect(x, y, colWidth, eventHeight, 'S');
            
            if (event) {
                // Fond coloré selon catégorie
                const colors = {
                    'controle': [59, 130, 246],
                    'entretiens': [16, 185, 129],
                    'mise_en_service': [139, 92, 246],
                    'sav_travaux': [249, 115, 22],
                    'reunion': [236, 72, 153],
                    'default': [148, 163, 184]
                };
                const color = colors[event.category] || colors.default;
                doc.setFillColor(...color);
                doc.roundedRect(x + 1, y + 1, colWidth - 2, eventHeight - 2, 1, 1, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(7);
                doc.text(event.title?.substring(0, 15) || 'Sans titre', x + 3, y + 5);
                doc.setFontSize(6);
                doc.text(event.start_time || '', x + 3, y + 9);
            }
        }
        y += eventHeight;
    }
    
    // Pied de page
    doc.setTextColor(148, 163, 184);
    doc.setFontSize(8);
    doc.text(`Généré le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, margin, pageHeight - 10);
    doc.text('StockApp v5.6', pageWidth - margin, pageHeight - 10, { align: 'right' });
    
    // Téléchargement
    const filename = `planning-${dateRange.start.toISOString().split('T')[0]}.pdf`;
    doc.save(filename);
    
    return filename;
};


// ============================================================================
// 6. VUE GANTT PLANNING
// ============================================================================

/**
 * Composant Vue Gantt
 */
const GanttView = ({ events, users, dateRange, onEventClick, categories = [] }) => {
    const [scale, setScale] = useState('day'); // 'hour', 'day', 'week'
    
    const days = useMemo(() => {
        const result = [];
        const current = new Date(dateRange.start);
        while (current <= dateRange.end) {
            result.push(new Date(current));
            current.setDate(current.getDate() + 1);
        }
        return result;
    }, [dateRange]);

    // Filtrer les événements par la plage de dates
    const filteredEvents = useMemo(() => {
        const startStr = dateRange.start.toISOString().split('T')[0];
        const endStr = dateRange.end.toISOString().split('T')[0];
        return events.filter(e => {
            const eventDate = e.scheduled_date;
            return eventDate >= startStr && eventDate <= endStr;
        });
    }, [events, dateRange]);

    // Utiliser directement les utilisateurs passés (déjà filtrés par le planning)
    const technicianRows = useMemo(() => {
        return users.map(tech => ({
            user: tech,
            events: filteredEvents.filter(e => e.assigned_to === tech.id)
        }));
    }, [users, filteredEvents]);

    const getEventPosition = (event, dayWidth) => {
        const eventDate = new Date(event.scheduled_date);
        const startOfRange = new Date(dateRange.start);
        const dayIndex = Math.floor((eventDate - startOfRange) / (1000 * 60 * 60 * 24));
        
        let left = dayIndex * dayWidth;
        let width = dayWidth - 4;
        
        // Utiliser scheduled_time et estimated_duration
        if (event.scheduled_time) {
            const [startH, startM] = event.scheduled_time.split(':').map(Number);
            const duration = event.estimated_duration || 60; // minutes
            const durationHours = duration / 60;
            width = Math.max((durationHours / 12) * dayWidth, 30); // 12h de travail par jour
            left += (startH / 24) * dayWidth;
        }
        
        return { left: `${left}px`, width: `${Math.max(width, 30)}px` };
    };

    const getCategoryColor = (event) => {
        // D'abord chercher dans les catégories passées
        const cat = categories.find(c => c.name === event.event_category);
        if (cat?.color) return cat.color;
        
        // Fallback par nom de catégorie
        const colors = {
            'Contrôle': '#3B82F6',
            'Entretiens': '#10B981',
            'Mise en service': '#8B5CF6',
            'SAV/Travaux': '#F97316',
            'Réunion': '#EC4899',
            'Formation': '#06B6D4',
            'Déplacement': '#14B8A6',
            'Congé': '#EF4444'
        };
        return colors[event.event_category] || '#94A3B8';
    };
    
    const getEventTitle = (event) => {
        return event.device_number || event.location || event.work_list || event.event_category || 'Tâche';
    };

    const dayWidth = scale === 'hour' ? 100 : scale === 'week' ? 30 : 50;
    const totalWidth = days.length * dayWidth;

    return h('div', { className: 'gantt-container' },
        // Header avec contrôles
        h('div', { className: 'gantt-toolbar' },
            h('div', { className: 'gantt-scale-selector' },
                h('span', null, 'Échelle:'),
                h('button', { 
                    className: `btn btn-sm ${scale === 'hour' ? 'btn-primary' : 'btn-ghost'}`,
                    onClick: () => setScale('hour')
                }, 'Heure'),
                h('button', { 
                    className: `btn btn-sm ${scale === 'day' ? 'btn-primary' : 'btn-ghost'}`,
                    onClick: () => setScale('day')
                }, 'Jour'),
                h('button', { 
                    className: `btn btn-sm ${scale === 'week' ? 'btn-primary' : 'btn-ghost'}`,
                    onClick: () => setScale('week')
                }, 'Semaine')
            ),
            h('div', { className: 'gantt-legend' },
                categories.slice(0, 6).map(cat => h('div', { key: cat.id, className: 'gantt-legend-item' },
                    h('div', { className: 'gantt-legend-color', style: { background: cat.color } }),
                    h('span', null, cat.name)
                ))
            ),
            h('div', { style: { marginLeft: 'auto', fontSize: 12, color: '#64748B' } },
                filteredEvents.length, ' tâche(s) • ', users.length, ' technicien(s)'
            )
        ),
        
        // Gantt Chart
        h('div', { className: 'gantt-chart' },
            // Timeline header
            h('div', { className: 'gantt-header' },
                h('div', { className: 'gantt-header-label' }, 'Technicien'),
                h('div', { className: 'gantt-timeline', style: { width: totalWidth } },
                    days.map((day, i) => h('div', { 
                        key: i,
                        className: `gantt-day-header ${day.toDateString() === new Date().toDateString() ? 'gantt-today' : ''}`,
                        style: { width: dayWidth }
                    },
                        h('div', { className: 'gantt-day-name' }, day.toLocaleDateString('fr-FR', { weekday: 'short' })),
                        h('div', { className: 'gantt-day-num' }, day.getDate())
                    ))
                )
            ),
            
            // Rows
            h('div', { className: 'gantt-body' },
                technicianRows.map(row => h('div', { key: row.user.id, className: 'gantt-row' },
                    h('div', { className: 'gantt-row-label' },
                        h('div', { className: 'gantt-user-avatar' }, 
                            (row.user.first_name?.[0] || row.user.email[0]).toUpperCase()
                        ),
                        h('span', null, row.user.first_name || row.user.email.split('@')[0]),
                        h('span', { style: { marginLeft: 'auto', fontSize: 11, color: '#94A3B8' } }, row.events.length)
                    ),
                    h('div', { className: 'gantt-row-timeline', style: { width: totalWidth } },
                        // Grid lines
                        days.map((day, i) => h('div', { 
                            key: i,
                            className: `gantt-grid-cell ${day.toDateString() === new Date().toDateString() ? 'gantt-today-cell' : ''}`,
                            style: { width: dayWidth }
                        })),
                        // Events
                        row.events.map(event => {
                            const pos = getEventPosition(event, dayWidth);
                            const title = getEventTitle(event);
                            const color = getCategoryColor(event);
                            return h('div', {
                                key: event.id,
                                className: `gantt-event ${event.status === 'termine' ? 'gantt-event-done' : ''}`,
                                style: {
                                    ...pos,
                                    background: color,
                                    opacity: event.status === 'termine' ? 0.6 : 1
                                },
                                onClick: () => onEventClick(event),
                                title: `${title}\n${event.scheduled_time || ''} • ${event.event_category || ''}\n${event.location || ''}`
                            },
                                h('span', { className: 'gantt-event-title' }, title.substring(0, 15))
                            );
                        })
                    )
                )),
                
                // Row pour les événements non assignés
                filteredEvents.filter(e => !e.assigned_to).length > 0 && h('div', { className: 'gantt-row gantt-row-unassigned' },
                    h('div', { className: 'gantt-row-label' },
                        h('div', { className: 'gantt-user-avatar unassigned' }, '?'),
                        h('span', null, 'Non assigné'),
                        h('span', { style: { marginLeft: 'auto', fontSize: 11, color: '#94A3B8' } }, filteredEvents.filter(e => !e.assigned_to).length)
                    ),
                    h('div', { className: 'gantt-row-timeline', style: { width: totalWidth } },
                        days.map((_, i) => h('div', { 
                            key: i,
                            className: 'gantt-grid-cell',
                            style: { width: dayWidth }
                        })),
                        filteredEvents.filter(e => !e.assigned_to).map(event => {
                            const pos = getEventPosition(event, dayWidth);
                            const title = getEventTitle(event);
                            return h('div', {
                                key: event.id,
                                className: 'gantt-event gantt-event-unassigned',
                                style: pos,
                                onClick: () => onEventClick(event),
                                title: title
                            },
                                h('span', { className: 'gantt-event-title' }, title.substring(0, 15))
                            );
                        })
                    )
                )
            )
        )
    );
};


// ============================================================================
// 7. MODE MULTI-SÉLECTION
// ============================================================================

/**
 * Hook pour gérer la multi-sélection
 */
const useMultiSelect = (items, idKey = 'id') => {
    const [selectedIds, setSelectedIds] = useState(new Set());
    const [lastSelectedIndex, setLastSelectedIndex] = useState(null);

    const toggleSelect = useCallback((id, index, shiftKey = false) => {
        setSelectedIds(prev => {
            const newSet = new Set(prev);
            
            if (shiftKey && lastSelectedIndex !== null && index !== null) {
                // Sélection par plage avec Shift
                const start = Math.min(lastSelectedIndex, index);
                const end = Math.max(lastSelectedIndex, index);
                for (let i = start; i <= end; i++) {
                    if (items[i]) newSet.add(items[i][idKey]);
                }
            } else {
                if (newSet.has(id)) {
                    newSet.delete(id);
                } else {
                    newSet.add(id);
                }
            }
            
            return newSet;
        });
        setLastSelectedIndex(index);
    }, [items, idKey, lastSelectedIndex]);

    const selectAll = useCallback(() => {
        setSelectedIds(new Set(items.map(item => item[idKey])));
    }, [items, idKey]);

    const clearSelection = useCallback(() => {
        setSelectedIds(new Set());
        setLastSelectedIndex(null);
    }, []);

    const isSelected = useCallback((id) => selectedIds.has(id), [selectedIds]);

    const selectedItems = useMemo(() => 
        items.filter(item => selectedIds.has(item[idKey])),
        [items, selectedIds, idKey]
    );

    return {
        selectedIds,
        selectedItems,
        selectedCount: selectedIds.size,
        toggleSelect,
        selectAll,
        clearSelection,
        isSelected
    };
};

/**
 * Barre d'actions pour la multi-sélection
 */
const MultiSelectBar = ({ selectedCount, onClearSelection, actions = [] }) => {
    if (selectedCount === 0) return null;

    return h('div', { className: 'multi-select-bar' },
        h('div', { className: 'multi-select-info' },
            h('span', { className: 'multi-select-count' }, selectedCount),
            h('span', null, ' élément(s) sélectionné(s)')
        ),
        h('div', { className: 'multi-select-actions' },
            actions.map((action, i) => h('button', {
                key: i,
                className: `btn btn-sm ${action.variant || 'btn-ghost'}`,
                onClick: action.onClick,
                disabled: action.disabled
            }, action.icon && h('span', { className: 'btn-icon' }, action.icon), action.label)),
            h('button', { 
                className: 'btn btn-sm btn-ghost',
                onClick: onClearSelection
            }, '✕ Désélectionner')
        )
    );
};


// ============================================================================
// 8. TEMPLATES DE TÂCHES
// ============================================================================

const DEFAULT_TASK_TEMPLATES = [
    {
        id: 'maintenance_preventive',
        name: 'Maintenance préventive',
        icon: '🔧',
        category: 'maintenance',
        fields: {
            type: 'entretien',
            priority: 'normale',
            estimated_duration: 120,
            checklist: [
                'Vérification visuelle générale',
                'Contrôle des niveaux',
                'Test de fonctionnement',
                'Nettoyage',
                'Rapport d\'intervention'
            ]
        }
    },
    {
        id: 'depannage_urgent',
        name: 'Dépannage urgent',
        icon: '🚨',
        category: 'sav',
        fields: {
            type: 'sav_travaux',
            priority: 'urgent',
            estimated_duration: 60,
            checklist: [
                'Diagnostic de la panne',
                'Réparation',
                'Test après réparation',
                'Rapport client'
            ]
        }
    },
    {
        id: 'mise_en_service',
        name: 'Mise en service',
        icon: '🚀',
        category: 'installation',
        fields: {
            type: 'mise_en_service',
            priority: 'normale',
            estimated_duration: 240,
            checklist: [
                'Vérification du matériel livré',
                'Installation physique',
                'Configuration',
                'Tests de fonctionnement',
                'Formation utilisateur',
                'Remise des documents'
            ]
        }
    },
    {
        id: 'controle_reglementaire',
        name: 'Contrôle réglementaire',
        icon: '📋',
        category: 'controle',
        fields: {
            type: 'controle',
            priority: 'haute',
            estimated_duration: 180,
            checklist: [
                'Vérification documentaire',
                'Contrôle visuel',
                'Tests obligatoires',
                'Rédaction du rapport',
                'Mise en conformité si nécessaire'
            ]
        }
    },
    {
        id: 'visite_client',
        name: 'Visite client',
        icon: '👥',
        category: 'commercial',
        fields: {
            type: 'reunion',
            priority: 'normale',
            estimated_duration: 60,
            checklist: [
                'Préparation du dossier client',
                'Entretien',
                'Prise de notes',
                'Compte-rendu'
            ]
        }
    }
];

/**
 * Hook pour gérer les templates de tâches
 */
const useTaskTemplates = () => {
    const [templates, setTemplates] = useState(() => {
        const saved = localStorage.getItem('stockapp-task-templates');
        return saved ? JSON.parse(saved) : DEFAULT_TASK_TEMPLATES;
    });

    useEffect(() => {
        localStorage.setItem('stockapp-task-templates', JSON.stringify(templates));
    }, [templates]);

    const addTemplate = (template) => {
        const newTemplate = {
            id: `custom_${Date.now()}`,
            ...template
        };
        setTemplates([...templates, newTemplate]);
        return newTemplate;
    };

    const updateTemplate = (id, updates) => {
        setTemplates(templates.map(t => t.id === id ? { ...t, ...updates } : t));
    };

    const deleteTemplate = (id) => {
        // Ne pas supprimer les templates par défaut
        if (!id.startsWith('custom_')) return false;
        setTemplates(templates.filter(t => t.id !== id));
        return true;
    };

    const applyTemplate = (templateId) => {
        const template = templates.find(t => t.id === templateId);
        if (!template) return null;
        return { ...template.fields };
    };

    const resetToDefaults = () => {
        setTemplates(DEFAULT_TASK_TEMPLATES);
    };

    return {
        templates,
        addTemplate,
        updateTemplate,
        deleteTemplate,
        applyTemplate,
        resetToDefaults
    };
};

/**
 * Sélecteur de template
 */
const TemplateSelector = ({ templates, onSelect, onManage }) => {
    const [isOpen, setIsOpen] = useState(false);
    const categories = [...new Set(templates.map(t => t.category))];

    return h('div', { className: 'template-selector' },
        h('button', {
            className: 'btn btn-ghost template-trigger',
            onClick: () => setIsOpen(!isOpen)
        }, '📝 Utiliser un template'),
        
        isOpen && h('div', { className: 'template-dropdown' },
            h('div', { className: 'template-dropdown-header' },
                h('span', null, 'Choisir un template'),
                h('button', { 
                    className: 'btn btn-sm btn-ghost',
                    onClick: onManage
                }, '⚙️ Gérer')
            ),
            h('div', { className: 'template-list' },
                categories.map(cat => h('div', { key: cat, className: 'template-category' },
                    h('div', { className: 'template-category-title' }, cat),
                    templates.filter(t => t.category === cat).map(t => h('div', {
                        key: t.id,
                        className: 'template-item',
                        onClick: () => { onSelect(t.id); setIsOpen(false); }
                    },
                        h('span', { className: 'template-icon' }, t.icon),
                        h('div', { className: 'template-info' },
                            h('div', { className: 'template-name' }, t.name),
                            h('div', { className: 'template-meta' }, 
                                t.fields.estimated_duration ? `${t.fields.estimated_duration} min` : '',
                                t.fields.checklist ? ` • ${t.fields.checklist.length} étapes` : ''
                            )
                        )
                    ))
                ))
            )
        )
    );
};

/**
 * Modal de gestion des templates
 */
const TemplateManagerModal = ({ isOpen, onClose, templates, onAdd, onUpdate, onDelete, onReset }) => {
    const [editingTemplate, setEditingTemplate] = useState(null);
    const [formData, setFormData] = useState({
        name: '',
        icon: '📋',
        category: 'custom',
        fields: {
            type: 'entretien',
            priority: 'normale',
            estimated_duration: 60,
            checklist: []
        }
    });
    const [newChecklistItem, setNewChecklistItem] = useState('');

    if (!isOpen) return null;

    const handleSave = () => {
        if (!formData.name) return;
        
        if (editingTemplate) {
            onUpdate(editingTemplate, formData);
        } else {
            onAdd(formData);
        }
        
        setFormData({
            name: '',
            icon: '📋',
            category: 'custom',
            fields: { type: 'entretien', priority: 'normale', estimated_duration: 60, checklist: [] }
        });
        setEditingTemplate(null);
    };

    const addChecklistItem = () => {
        if (!newChecklistItem.trim()) return;
        setFormData({
            ...formData,
            fields: {
                ...formData.fields,
                checklist: [...(formData.fields.checklist || []), newChecklistItem.trim()]
            }
        });
        setNewChecklistItem('');
    };

    const removeChecklistItem = (index) => {
        setFormData({
            ...formData,
            fields: {
                ...formData.fields,
                checklist: formData.fields.checklist.filter((_, i) => i !== index)
            }
        });
    };

    return h('div', { className: 'modal-overlay', onClick: onClose },
        h('div', { className: 'modal modal-lg', onClick: e => e.stopPropagation() },
            h('div', { className: 'modal-header' },
                h('h2', null, '📝 Gestion des templates'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'modal-body', style: { display: 'flex', gap: 24 } },
                // Liste des templates
                h('div', { style: { flex: 1, borderRight: '1px solid var(--border)', paddingRight: 24 } },
                    h('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: 16 } },
                        h('h4', null, 'Templates existants'),
                        h('button', { 
                            className: 'btn btn-sm btn-ghost',
                            onClick: onReset,
                            title: 'Restaurer les templates par défaut'
                        }, '🔄 Reset')
                    ),
                    h('div', { className: 'template-manager-list' },
                        templates.map(t => h('div', { 
                            key: t.id, 
                            className: `template-manager-item ${editingTemplate === t.id ? 'editing' : ''}`,
                            onClick: () => {
                                setEditingTemplate(t.id);
                                setFormData(t);
                            }
                        },
                            h('span', { className: 'template-icon' }, t.icon),
                            h('div', { className: 'template-info' },
                                h('div', { className: 'template-name' }, t.name),
                                h('div', { className: 'template-meta' }, t.category)
                            ),
                            t.id.startsWith('custom_') && h('button', {
                                className: 'btn btn-sm btn-danger',
                                onClick: (e) => { e.stopPropagation(); onDelete(t.id); }
                            }, '🗑️')
                        ))
                    )
                ),
                
                // Formulaire d'édition
                h('div', { style: { flex: 1 } },
                    h('h4', null, editingTemplate ? 'Modifier le template' : 'Nouveau template'),
                    h('div', { className: 'template-form' },
                        h('div', { className: 'form-row' },
                            h('div', { className: 'form-group', style: { flex: 3 } },
                                h('label', null, 'Nom'),
                                h('input', {
                                    type: 'text',
                                    className: 'form-control',
                                    value: formData.name,
                                    onChange: e => setFormData({ ...formData, name: e.target.value })
                                })
                            ),
                            h('div', { className: 'form-group', style: { flex: 1 } },
                                h('label', null, 'Icône'),
                                h('input', {
                                    type: 'text',
                                    className: 'form-control',
                                    value: formData.icon,
                                    onChange: e => setFormData({ ...formData, icon: e.target.value }),
                                    maxLength: 2
                                })
                            )
                        ),
                        h('div', { className: 'form-row' },
                            h('div', { className: 'form-group' },
                                h('label', null, 'Catégorie'),
                                h('input', {
                                    type: 'text',
                                    className: 'form-control',
                                    value: formData.category,
                                    onChange: e => setFormData({ ...formData, category: e.target.value })
                                })
                            ),
                            h('div', { className: 'form-group' },
                                h('label', null, 'Durée estimée (min)'),
                                h('input', {
                                    type: 'number',
                                    className: 'form-control',
                                    value: formData.fields.estimated_duration,
                                    onChange: e => setFormData({
                                        ...formData,
                                        fields: { ...formData.fields, estimated_duration: parseInt(e.target.value) || 0 }
                                    })
                                })
                            )
                        ),
                        h('div', { className: 'form-row' },
                            h('div', { className: 'form-group' },
                                h('label', null, 'Type'),
                                h('select', {
                                    className: 'form-control',
                                    value: formData.fields.type,
                                    onChange: e => setFormData({
                                        ...formData,
                                        fields: { ...formData.fields, type: e.target.value }
                                    })
                                },
                                    h('option', { value: 'entretien' }, 'Entretien'),
                                    h('option', { value: 'controle' }, 'Contrôle'),
                                    h('option', { value: 'sav_travaux' }, 'SAV/Travaux'),
                                    h('option', { value: 'mise_en_service' }, 'Mise en service'),
                                    h('option', { value: 'reunion' }, 'Réunion')
                                )
                            ),
                            h('div', { className: 'form-group' },
                                h('label', null, 'Priorité'),
                                h('select', {
                                    className: 'form-control',
                                    value: formData.fields.priority,
                                    onChange: e => setFormData({
                                        ...formData,
                                        fields: { ...formData.fields, priority: e.target.value }
                                    })
                                },
                                    h('option', { value: 'basse' }, 'Basse'),
                                    h('option', { value: 'normale' }, 'Normale'),
                                    h('option', { value: 'haute' }, 'Haute'),
                                    h('option', { value: 'urgent' }, 'Urgent')
                                )
                            )
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Checklist'),
                            h('div', { className: 'checklist-editor' },
                                (formData.fields.checklist || []).map((item, i) => h('div', { 
                                    key: i, 
                                    className: 'checklist-item'
                                },
                                    h('span', null, item),
                                    h('button', {
                                        className: 'btn btn-sm btn-ghost',
                                        onClick: () => removeChecklistItem(i)
                                    }, '✕')
                                )),
                                h('div', { className: 'checklist-add' },
                                    h('input', {
                                        type: 'text',
                                        className: 'form-control',
                                        value: newChecklistItem,
                                        onChange: e => setNewChecklistItem(e.target.value),
                                        placeholder: 'Nouvelle étape...',
                                        onKeyPress: e => e.key === 'Enter' && addChecklistItem()
                                    }),
                                    h('button', {
                                        className: 'btn btn-sm btn-primary',
                                        onClick: addChecklistItem
                                    }, '+')
                                )
                            )
                        ),
                        h('div', { className: 'form-actions' },
                            editingTemplate && h('button', {
                                className: 'btn btn-ghost',
                                onClick: () => {
                                    setEditingTemplate(null);
                                    setFormData({
                                        name: '',
                                        icon: '📋',
                                        category: 'custom',
                                        fields: { type: 'entretien', priority: 'normale', estimated_duration: 60, checklist: [] }
                                    });
                                }
                            }, 'Annuler'),
                            h('button', {
                                className: 'btn btn-primary',
                                onClick: handleSave,
                                disabled: !formData.name
                            }, editingTemplate ? 'Mettre à jour' : 'Créer le template')
                        )
                    )
                )
            )
        )
    );
};


// ============================================================================
// STYLES CSS ADDITIONNELS
// ============================================================================

const V53_STYLES = `
/* Dashboard personnalisable */
.dashboard-customizable {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
    padding: 16px;
}

.dashboard-widget {
    background: var(--card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    overflow: hidden;
    transition: all 0.2s ease;
}

.dashboard-widget-edit {
    cursor: grab;
    border: 2px dashed var(--primary);
}

.dashboard-widget-edit:hover {
    box-shadow: var(--shadow-lg);
}

.widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--background);
}

.widget-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 14px;
}

.widget-icon {
    font-size: 16px;
}

.widget-remove-btn {
    width: 24px;
    height: 24px;
    border: none;
    background: var(--danger-pastel);
    color: var(--danger);
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
}

.widget-content {
    padding: 16px;
}

.widget-kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.widget-kpi {
    text-align: center;
}

.widget-kpi-value {
    font-size: 24px;
    font-weight: 800;
    color: var(--text);
}

.widget-kpi-value.widget-kpi-warning { color: var(--warning); }
.widget-kpi-value.widget-kpi-danger { color: var(--danger); }
.widget-kpi-value.widget-kpi-success { color: var(--success); }

.widget-kpi-label {
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
}

.widget-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
}

.widget-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--background);
    border-radius: var(--radius);
}

.widget-list-item-warning {
    background: var(--warning-pastel);
    border-left: 3px solid var(--warning);
}

.widget-list-item-title {
    font-weight: 500;
    font-size: 13px;
}

.widget-list-item-subtitle {
    font-size: 11px;
    color: var(--muted);
}

.widget-empty {
    text-align: center;
    padding: 24px;
    color: var(--muted);
}

.widget-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

.widget-action-btn {
    padding: 12px;
    border: 1px solid var(--border);
    background: var(--background);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
}

.widget-action-btn:hover {
    background: var(--primary-pastel);
    border-color: var(--primary);
}

.widget-workload-bar {
    flex: 1;
    height: 8px;
    background: var(--background);
    border-radius: 4px;
    overflow: hidden;
    margin: 0 12px;
}

.widget-workload-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.widget-workload-count {
    font-weight: 600;
    font-size: 12px;
    min-width: 30px;
    text-align: right;
}

/* Widget Picker */
.widget-picker-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.widget-picker {
    background: var(--card);
    border-radius: var(--radius-xl);
    width: 500px;
    max-height: 80vh;
    overflow: hidden;
}

.widget-picker-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
}

.widget-picker-content {
    padding: 16px;
    overflow-y: auto;
    max-height: calc(80vh - 60px);
}

.widget-picker-category-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    margin: 16px 0 8px 0;
}

.widget-picker-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.widget-picker-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--background);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
}

.widget-picker-item:hover {
    background: var(--primary-pastel);
}

.widget-picker-icon {
    font-size: 20px;
}

.widget-picker-name {
    font-size: 13px;
    font-weight: 500;
}

/* Rapports programmés */
.reports-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.report-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: var(--background);
    border-radius: var(--radius);
    border: 1px solid var(--border);
}

.report-item.report-disabled {
    opacity: 0.5;
}

.report-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.report-icon {
    font-size: 24px;
}

.report-name {
    font-weight: 600;
    font-size: 14px;
}

.report-meta {
    font-size: 12px;
    color: var(--muted);
}

.report-next {
    font-size: 11px;
    color: var(--info);
    margin-top: 4px;
}

.report-actions {
    display: flex;
    gap: 8px;
}

.report-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Colonnes redimensionnables */
.resizable-header {
    position: relative;
    user-select: none;
}

.resize-handle {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 8px;
    cursor: col-resize;
    background: transparent;
}

.resize-handle:hover,
.resizable-header.resizing .resize-handle {
    background: var(--primary);
    opacity: 0.5;
}

/* Vue Gantt */
.gantt-container {
    background: var(--card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    overflow: hidden;
}

.gantt-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--background);
}

.gantt-scale-selector {
    display: flex;
    align-items: center;
    gap: 8px;
}

.gantt-legend {
    display: flex;
    gap: 16px;
}

.gantt-legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
}

.gantt-legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
}

.gantt-chart {
    overflow-x: auto;
}

.gantt-header {
    display: flex;
    border-bottom: 1px solid var(--border);
    background: var(--background);
    position: sticky;
    top: 0;
    z-index: 10;
}

.gantt-header-label {
    width: 200px;
    min-width: 200px;
    padding: 12px 16px;
    font-weight: 600;
    font-size: 12px;
    border-right: 1px solid var(--border);
}

.gantt-timeline {
    display: flex;
}

.gantt-day-header {
    text-align: center;
    padding: 8px 4px;
    border-right: 1px solid var(--border);
}

.gantt-day-header.gantt-today {
    background: var(--primary-pastel);
}

.gantt-day-name {
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
}

.gantt-day-num {
    font-size: 14px;
    font-weight: 600;
}

.gantt-body {
    max-height: 400px;
    overflow-y: auto;
}

.gantt-row {
    display: flex;
    border-bottom: 1px solid var(--border);
    min-height: 50px;
}

.gantt-row-label {
    width: 200px;
    min-width: 200px;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-right: 1px solid var(--border);
    background: var(--card);
}

.gantt-user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--primary-pastel);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 12px;
}

.gantt-user-avatar.unassigned {
    background: var(--muted);
    color: white;
}

.gantt-row-timeline {
    display: flex;
    position: relative;
    background: var(--background);
}

.gantt-grid-cell {
    border-right: 1px solid var(--border);
    height: 100%;
}

.gantt-event {
    position: absolute;
    top: 8px;
    height: calc(100% - 16px);
    border-radius: 4px;
    padding: 4px 8px;
    color: white;
    font-size: 11px;
    cursor: pointer;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    transition: transform 0.2s;
    z-index: 5;
}

.gantt-event:hover {
    transform: scale(1.02);
    z-index: 10;
}

.gantt-event-unassigned {
    background: var(--muted) !important;
}

.gantt-today-cell {
    background: rgba(59, 130, 246, 0.08) !important;
}

.gantt-event-done {
    text-decoration: line-through;
    opacity: 0.6;
}

.gantt-event-title {
    font-weight: 500;
}

/* Multi-sélection */
.multi-select-bar {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--card);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    padding: 12px 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    z-index: 100;
    border: 1px solid var(--border);
    animation: slideUp 0.2s ease;
}

.multi-select-info {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
}

.multi-select-count {
    font-weight: 700;
    color: var(--primary);
}

.multi-select-actions {
    display: flex;
    gap: 8px;
}

/* Templates */
.template-selector {
    position: relative;
}

.template-trigger {
    display: flex;
    align-items: center;
    gap: 8px;
}

.template-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border);
    width: 300px;
    z-index: 100;
    animation: fadeIn 0.15s ease;
}

.template-dropdown-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
}

.template-list {
    max-height: 300px;
    overflow-y: auto;
    padding: 8px;
}

.template-category-title {
    font-size: 10px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    padding: 8px 12px 4px;
}

.template-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: background 0.15s;
}

.template-item:hover {
    background: var(--background);
}

.template-icon {
    font-size: 20px;
}

.template-info {
    flex: 1;
}

.template-name {
    font-weight: 500;
    font-size: 13px;
}

.template-meta {
    font-size: 11px;
    color: var(--muted);
}

.template-manager-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 400px;
    overflow-y: auto;
}

.template-manager-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--background);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.15s;
}

.template-manager-item:hover,
.template-manager-item.editing {
    background: var(--primary-pastel);
}

.template-form {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.checklist-editor {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.checklist-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: var(--background);
    border-radius: var(--radius);
}

.checklist-add {
    display: flex;
    gap: 8px;
}

.checklist-add input {
    flex: 1;
}

/* Empty state */
.empty-state {
    text-align: center;
    padding: 40px;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

/* Form row */
.form-row {
    display: flex;
    gap: 16px;
}

.form-row .form-group {
    flex: 1;
}

.form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 16px;
}

/* Button group */
.btn-group {
    display: flex;
    gap: 4px;
}

.btn-group .btn {
    border-radius: 0;
}

.btn-group .btn:first-child {
    border-radius: var(--radius) 0 0 var(--radius);
}

.btn-group .btn:last-child {
    border-radius: 0 var(--radius) var(--radius) 0;
}
`;

// Injecter les styles
if (typeof document !== 'undefined') {
    const styleEl = document.createElement('style');
    styleEl.textContent = V53_STYLES;
    document.head.appendChild(styleEl);
}


// ============================================================================
// EXPORTS
// ============================================================================

window.StockAppV53 = {
    // Dashboard
    DASHBOARD_WIDGETS,
    DEFAULT_DASHBOARD_LAYOUT,
    useDashboardLayout,
    DashboardWidget,
    WidgetPicker,
    
    // Rapports
    REPORT_TYPES,
    SCHEDULE_FREQUENCIES,
    useScheduledReports,
    ScheduledReportsModal,
    generateReport,
    
    // Planning
    usePlanningDoubleClick,
    exportPlanningToPDF,
    GanttView,
    
    // Tableaux
    useResizableColumns,
    
    // Multi-sélection
    useMultiSelect,
    MultiSelectBar,
    
    // Templates
    DEFAULT_TASK_TEMPLATES,
    useTaskTemplates,
    TemplateSelector,
    TemplateManagerModal
};

console.log('[StockApp v5.6] Nouvelles fonctionnalités chargées avec succès');


/**
 * ============================================================================
 * STOCKAPP v5.4 - FONCTIONNALITÉS AVANCÉES
 * ============================================================================
 * 1. IA Prédictive pour anticiper les pannes
 * 2. OCR Documents pour import automatique
 * 3. Géolocalisation des interventions sur carte
 * 4. Chat interne entre techniciens
 * 5. Notifications push paramétrables
 * 6. Mode présentation amélioré avec slides auto
 * ============================================================================
 */

// ============================================================================
// 1. IA PRÉDICTIVE - ANTICIPATION DES PANNES
// ============================================================================

/**
 * Modèle d'analyse prédictive basé sur l'historique des interventions
 * Utilise des heuristiques et patterns pour prédire les pannes
 */
const PredictiveAI = {
    // Facteurs de risque par type d'équipement
    riskFactors: {
        ascenseur: { baseFailureRate: 0.02, ageMultiplier: 1.5, usageMultiplier: 1.3 },
        climatisation: { baseFailureRate: 0.03, ageMultiplier: 1.4, usageMultiplier: 1.2 },
        chauffage: { baseFailureRate: 0.025, ageMultiplier: 1.3, usageMultiplier: 1.1 },
        ventilation: { baseFailureRate: 0.02, ageMultiplier: 1.2, usageMultiplier: 1.15 },
        electrique: { baseFailureRate: 0.015, ageMultiplier: 1.6, usageMultiplier: 1.1 },
        plomberie: { baseFailureRate: 0.02, ageMultiplier: 1.4, usageMultiplier: 1.2 },
        default: { baseFailureRate: 0.02, ageMultiplier: 1.3, usageMultiplier: 1.2 }
    },

    // Patterns saisonniers
    seasonalPatterns: {
        climatisation: { summer: 1.8, winter: 0.5, spring: 1.0, fall: 0.8 },
        chauffage: { summer: 0.3, winter: 2.0, spring: 0.8, fall: 1.2 },
        default: { summer: 1.0, winter: 1.0, spring: 1.0, fall: 1.0 }
    },

    /**
     * Calcule le score de risque pour un équipement
     */
    calculateRiskScore(equipment, history = []) {
        const type = this.detectEquipmentType(equipment);
        const factors = this.riskFactors[type] || this.riskFactors.default;
        
        // Âge de l'équipement
        const age = this.calculateAge(equipment.installation_date);
        const ageFactor = age > 10 ? factors.ageMultiplier * 1.5 : 
                         age > 5 ? factors.ageMultiplier : 1;

        // Fréquence d'utilisation estimée
        const usageFactor = equipment.usage_intensity === 'high' ? factors.usageMultiplier * 1.3 :
                           equipment.usage_intensity === 'medium' ? factors.usageMultiplier : 1;

        // Historique des pannes
        const recentFailures = history.filter(h => {
            const date = new Date(h.date);
            const monthsAgo = (new Date() - date) / (1000 * 60 * 60 * 24 * 30);
            return monthsAgo <= 12 && h.type === 'panne';
        }).length;
        const historyFactor = 1 + (recentFailures * 0.2);

        // Pattern saisonnier
        const season = this.getCurrentSeason();
        const seasonalPattern = this.seasonalPatterns[type] || this.seasonalPatterns.default;
        const seasonFactor = seasonalPattern[season];

        // Dernière maintenance
        const daysSinceLastMaintenance = this.daysSince(equipment.last_maintenance_date);
        const maintenanceFactor = daysSinceLastMaintenance > 365 ? 1.5 :
                                  daysSinceLastMaintenance > 180 ? 1.2 : 1;

        // Score final
        const baseScore = factors.baseFailureRate * 100;
        const finalScore = baseScore * ageFactor * usageFactor * historyFactor * seasonFactor * maintenanceFactor;
        
        return Math.min(Math.round(finalScore), 100);
    },

    /**
     * Détecte le type d'équipement à partir du nom/description
     */
    detectEquipmentType(equipment) {
        const text = `${equipment.name || ''} ${equipment.description || ''} ${equipment.category || ''}`.toLowerCase();
        
        if (text.includes('ascenseur') || text.includes('monte-charge') || text.includes('élévateur')) return 'ascenseur';
        if (text.includes('clim') || text.includes('climatisation') || text.includes('pac') || text.includes('froid')) return 'climatisation';
        if (text.includes('chauff') || text.includes('chaudière') || text.includes('radiateur')) return 'chauffage';
        if (text.includes('ventil') || text.includes('vmc') || text.includes('extraction')) return 'ventilation';
        if (text.includes('électr') || text.includes('tableau') || text.includes('disjoncteur')) return 'electrique';
        if (text.includes('plomb') || text.includes('sanitaire') || text.includes('eau')) return 'plomberie';
        
        return 'default';
    },

    /**
     * Calcule l'âge en années
     */
    calculateAge(installationDate) {
        if (!installationDate) return 5; // Valeur par défaut
        const install = new Date(installationDate);
        const now = new Date();
        return (now - install) / (1000 * 60 * 60 * 24 * 365);
    },

    /**
     * Calcule le nombre de jours depuis une date
     */
    daysSince(date) {
        if (!date) return 365;
        return Math.floor((new Date() - new Date(date)) / (1000 * 60 * 60 * 24));
    },

    /**
     * Retourne la saison actuelle
     */
    getCurrentSeason() {
        const month = new Date().getMonth();
        if (month >= 2 && month <= 4) return 'spring';
        if (month >= 5 && month <= 7) return 'summer';
        if (month >= 8 && month <= 10) return 'fall';
        return 'winter';
    },

    /**
     * Génère des recommandations basées sur le score de risque
     */
    generateRecommendations(equipment, riskScore, history = []) {
        const recommendations = [];
        const type = this.detectEquipmentType(equipment);

        if (riskScore >= 70) {
            recommendations.push({
                priority: 'urgent',
                type: 'maintenance_preventive',
                message: `Maintenance préventive urgente recommandée`,
                reason: 'Score de risque élevé'
            });
        } else if (riskScore >= 50) {
            recommendations.push({
                priority: 'haute',
                type: 'inspection',
                message: `Inspection approfondie recommandée`,
                reason: 'Score de risque modéré'
            });
        }

        const daysSinceMaintenance = this.daysSince(equipment.last_maintenance_date);
        if (daysSinceMaintenance > 365) {
            recommendations.push({
                priority: 'haute',
                type: 'maintenance',
                message: `Maintenance annuelle en retard (${Math.floor(daysSinceMaintenance / 30)} mois)`,
                reason: 'Dernière maintenance > 12 mois'
            });
        } else if (daysSinceMaintenance > 300) {
            recommendations.push({
                priority: 'normale',
                type: 'maintenance',
                message: `Planifier la maintenance annuelle`,
                reason: 'Maintenance à prévoir dans le mois'
            });
        }

        // Recommandations saisonnières
        const season = this.getCurrentSeason();
        if (type === 'climatisation' && season === 'spring') {
            recommendations.push({
                priority: 'normale',
                type: 'preparation',
                message: `Préparer la climatisation pour l'été`,
                reason: 'Approche de la saison chaude'
            });
        }
        if (type === 'chauffage' && season === 'fall') {
            recommendations.push({
                priority: 'normale',
                type: 'preparation',
                message: `Préparer le chauffage pour l'hiver`,
                reason: 'Approche de la saison froide'
            });
        }

        return recommendations;
    },

    /**
     * Prédit la date probable de la prochaine panne
     */
    predictNextFailure(equipment, history = []) {
        const riskScore = this.calculateRiskScore(equipment, history);
        
        // Estimation basée sur le score de risque
        let daysUntilFailure;
        if (riskScore >= 80) daysUntilFailure = Math.floor(Math.random() * 30) + 15;
        else if (riskScore >= 60) daysUntilFailure = Math.floor(Math.random() * 60) + 30;
        else if (riskScore >= 40) daysUntilFailure = Math.floor(Math.random() * 90) + 60;
        else daysUntilFailure = Math.floor(Math.random() * 180) + 90;

        const predictedDate = new Date();
        predictedDate.setDate(predictedDate.getDate() + daysUntilFailure);

        return {
            date: predictedDate,
            confidence: riskScore >= 60 ? 'haute' : riskScore >= 40 ? 'moyenne' : 'basse',
            daysUntil: daysUntilFailure
        };
    },

    /**
     * Analyse un ensemble d'équipements et retourne les plus à risque
     */
    analyzeFleet(equipments, tasksHistory = []) {
        return equipments.map(eq => {
            const history = tasksHistory.filter(t => 
                t.device_number === eq.device_number || t.equipment_id === eq.id
            );
            const riskScore = this.calculateRiskScore(eq, history);
            const recommendations = this.generateRecommendations(eq, riskScore, history);
            const prediction = this.predictNextFailure(eq, history);

            return {
                equipment: eq,
                riskScore,
                riskLevel: riskScore >= 70 ? 'critical' : riskScore >= 50 ? 'warning' : riskScore >= 30 ? 'moderate' : 'low',
                recommendations,
                prediction
            };
        }).sort((a, b) => b.riskScore - a.riskScore);
    }
};

/**
 * Composant Dashboard IA Prédictive
 */
const PredictiveAIDashboard = ({ data, onCreateTask }) => {
    const [analysis, setAnalysis] = useState([]);
    const [loading, setLoading] = useState(true);
    const [selectedEquipment, setSelectedEquipment] = useState(null);
    const [filterLevel, setFilterLevel] = useState('all');

    useEffect(() => {
        // Simuler une analyse (dans la vraie vie, cela viendrait d'une API)
        setLoading(true);
        setTimeout(() => {
            const equipments = data.devices || data.tasks?.filter(t => t.device_number).map(t => ({
                id: t.id,
                device_number: t.device_number,
                name: t.device_number,
                description: t.description,
                location: t.location,
                installation_date: t.installation_date,
                last_maintenance_date: t.last_maintenance_date
            })) || [];
            
            const uniqueEquipments = equipments.reduce((acc, eq) => {
                if (!acc.find(e => e.device_number === eq.device_number)) {
                    acc.push(eq);
                }
                return acc;
            }, []);

            const results = PredictiveAI.analyzeFleet(uniqueEquipments, data.tasks || []);
            setAnalysis(results);
            setLoading(false);
        }, 1000);
    }, [data]);

    const filteredAnalysis = filterLevel === 'all' 
        ? analysis 
        : analysis.filter(a => a.riskLevel === filterLevel);

    const stats = {
        critical: analysis.filter(a => a.riskLevel === 'critical').length,
        warning: analysis.filter(a => a.riskLevel === 'warning').length,
        moderate: analysis.filter(a => a.riskLevel === 'moderate').length,
        low: analysis.filter(a => a.riskLevel === 'low').length
    };

    const getRiskColor = (level) => {
        switch(level) {
            case 'critical': return '#EF4444';
            case 'warning': return '#F59E0B';
            case 'moderate': return '#3B82F6';
            case 'low': return '#10B981';
            default: return '#94A3B8';
        }
    };

    const getRiskLabel = (level) => {
        switch(level) {
            case 'critical': return 'Critique';
            case 'warning': return 'Attention';
            case 'moderate': return 'Modéré';
            case 'low': return 'Faible';
            default: return 'Inconnu';
        }
    };

    if (loading) {
        return h('div', { className: 'ai-dashboard-loading' },
            h('div', { className: 'ai-loading-spinner' }),
            h('p', null, 'Analyse prédictive en cours...'),
            h('p', { className: 'ai-loading-hint' }, 'L\'IA analyse l\'historique des interventions')
        );
    }

    return h('div', { className: 'ai-dashboard' },
        // En-tête
        h('div', { className: 'ai-header' },
            h('div', { className: 'ai-title' },
                h('span', { className: 'ai-icon' }, '🤖'),
                h('div', null,
                    h('h2', null, 'IA Prédictive'),
                    h('p', null, `${analysis.length} équipements analysés`)
                )
            ),
            h('div', { className: 'ai-stats' },
                h('div', { className: 'ai-stat ai-stat-critical', onClick: () => setFilterLevel(filterLevel === 'critical' ? 'all' : 'critical') },
                    h('span', { className: 'ai-stat-value' }, stats.critical),
                    h('span', { className: 'ai-stat-label' }, 'Critiques')
                ),
                h('div', { className: 'ai-stat ai-stat-warning', onClick: () => setFilterLevel(filterLevel === 'warning' ? 'all' : 'warning') },
                    h('span', { className: 'ai-stat-value' }, stats.warning),
                    h('span', { className: 'ai-stat-label' }, 'Attention')
                ),
                h('div', { className: 'ai-stat ai-stat-moderate', onClick: () => setFilterLevel(filterLevel === 'moderate' ? 'all' : 'moderate') },
                    h('span', { className: 'ai-stat-value' }, stats.moderate),
                    h('span', { className: 'ai-stat-label' }, 'Modérés')
                ),
                h('div', { className: 'ai-stat ai-stat-low', onClick: () => setFilterLevel(filterLevel === 'low' ? 'all' : 'low') },
                    h('span', { className: 'ai-stat-value' }, stats.low),
                    h('span', { className: 'ai-stat-label' }, 'Faibles')
                )
            )
        ),

        // Liste des équipements
        h('div', { className: 'ai-equipment-list' },
            filteredAnalysis.slice(0, 20).map((item, index) => h('div', {
                key: item.equipment.id || index,
                className: `ai-equipment-card ai-risk-${item.riskLevel}`,
                onClick: () => setSelectedEquipment(item)
            },
                h('div', { className: 'ai-equipment-header' },
                    h('div', { className: 'ai-equipment-info' },
                        h('h4', null, item.equipment.device_number || item.equipment.name),
                        h('p', null, item.equipment.location || 'Emplacement non défini')
                    ),
                    h('div', { className: 'ai-risk-badge', style: { background: getRiskColor(item.riskLevel) } },
                        h('span', { className: 'ai-risk-score' }, item.riskScore),
                        h('span', { className: 'ai-risk-label' }, getRiskLabel(item.riskLevel))
                    )
                ),
                h('div', { className: 'ai-equipment-prediction' },
                    h('span', { className: 'ai-prediction-icon' }, '📅'),
                    h('span', null, `Risque de panne dans ~${item.prediction.daysUntil} jours`),
                    h('span', { className: `ai-confidence ai-confidence-${item.prediction.confidence}` }, 
                        `(${item.prediction.confidence})`
                    )
                ),
                item.recommendations.length > 0 && h('div', { className: 'ai-recommendations-preview' },
                    h('span', { className: 'ai-rec-count' }, item.recommendations.length),
                    h('span', null, 'recommandation(s)')
                )
            ))
        ),

        // Modal détails équipement
        selectedEquipment && h('div', { className: 'modal-overlay', onClick: () => setSelectedEquipment(null) },
            h('div', { className: 'modal ai-detail-modal', onClick: e => e.stopPropagation() },
                h('div', { className: 'modal-header' },
                    h('h2', null, selectedEquipment.equipment.device_number || selectedEquipment.equipment.name),
                    h('button', { className: 'btn btn-ghost', onClick: () => setSelectedEquipment(null) }, '✕')
                ),
                h('div', { className: 'modal-body' },
                    // Score de risque visuel
                    h('div', { className: 'ai-detail-risk' },
                        h('div', { className: 'ai-risk-gauge' },
                            h('div', { 
                                className: 'ai-risk-fill',
                                style: { 
                                    width: `${selectedEquipment.riskScore}%`,
                                    background: getRiskColor(selectedEquipment.riskLevel)
                                }
                            })
                        ),
                        h('div', { className: 'ai-risk-info' },
                            h('span', { className: 'ai-risk-value' }, selectedEquipment.riskScore, '%'),
                            h('span', { 
                                className: 'ai-risk-level',
                                style: { color: getRiskColor(selectedEquipment.riskLevel) }
                            }, getRiskLabel(selectedEquipment.riskLevel))
                        )
                    ),

                    // Prédiction
                    h('div', { className: 'ai-detail-section' },
                        h('h4', null, '📊 Prédiction'),
                        h('div', { className: 'ai-prediction-detail' },
                            h('div', { className: 'ai-prediction-date' },
                                h('span', { className: 'ai-pred-label' }, 'Date estimée de panne'),
                                h('span', { className: 'ai-pred-value' }, 
                                    selectedEquipment.prediction.date.toLocaleDateString('fr-FR', {
                                        day: 'numeric', month: 'long', year: 'numeric'
                                    })
                                )
                            ),
                            h('div', { className: 'ai-prediction-days' },
                                h('span', { className: 'ai-pred-days' }, selectedEquipment.prediction.daysUntil),
                                h('span', null, 'jours')
                            )
                        )
                    ),

                    // Recommandations
                    h('div', { className: 'ai-detail-section' },
                        h('h4', null, '💡 Recommandations'),
                        selectedEquipment.recommendations.length === 0 
                            ? h('p', { className: 'ai-no-rec' }, 'Aucune recommandation particulière')
                            : h('div', { className: 'ai-recommendations' },
                                selectedEquipment.recommendations.map((rec, i) => h('div', {
                                    key: i,
                                    className: `ai-recommendation ai-rec-${rec.priority}`
                                },
                                    h('div', { className: 'ai-rec-header' },
                                        h('span', { className: `ai-rec-priority priority-${rec.priority}` }, 
                                            rec.priority === 'urgent' ? '🚨' : rec.priority === 'haute' ? '⚠️' : 'ℹ️'
                                        ),
                                        h('span', { className: 'ai-rec-type' }, rec.type.replace('_', ' '))
                                    ),
                                    h('p', { className: 'ai-rec-message' }, rec.message),
                                    h('p', { className: 'ai-rec-reason' }, rec.reason)
                                ))
                            )
                    ),

                    // Actions
                    h('div', { className: 'ai-detail-actions' },
                        h('button', { 
                            className: 'btn btn-primary',
                            onClick: () => {
                                onCreateTask && onCreateTask({
                                    device_number: selectedEquipment.equipment.device_number,
                                    type: 'maintenance_preventive',
                                    priority: selectedEquipment.riskLevel === 'critical' ? 'urgente' : 'haute',
                                    description: `Maintenance préventive - Score de risque: ${selectedEquipment.riskScore}%`
                                });
                                setSelectedEquipment(null);
                            }
                        }, '📋 Créer une tâche de maintenance'),
                        h('button', { 
                            className: 'btn btn-secondary',
                            onClick: () => setSelectedEquipment(null)
                        }, 'Fermer')
                    )
                )
            )
        )
    );
};


// ============================================================================
// 2. OCR DOCUMENTS - IMPORT AUTOMATIQUE
// ============================================================================

/**
 * Service OCR utilisant Tesseract.js
 * Peut extraire du texte depuis des images et PDFs
 */
const OCRService = {
    worker: null,
    isInitialized: false,

    /**
     * Initialise le worker Tesseract
     */
    async initialize() {
        if (this.isInitialized) return;
        
        // Charger Tesseract.js dynamiquement
        if (!window.Tesseract) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js';
            await new Promise((resolve, reject) => {
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        this.worker = await window.Tesseract.createWorker('fra');
        this.isInitialized = true;
    },

    /**
     * Extrait le texte d'une image
     */
    async extractText(imageSource) {
        await this.initialize();
        const { data: { text } } = await this.worker.recognize(imageSource);
        return text;
    },

    /**
     * Parse un bon de commande
     */
    parseOrderDocument(text) {
        const result = {
            type: 'order',
            supplier: null,
            orderNumber: null,
            date: null,
            items: [],
            total: null,
            confidence: 0
        };

        // Patterns de détection
        const patterns = {
            orderNumber: /(?:n[°o]?\s*(?:commande|cde|order)|commande\s*n[°o]?)\s*[:\s]*([A-Z0-9-]+)/i,
            date: /(?:date|le)\s*[:\s]*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/i,
            supplier: /(?:fournisseur|supplier|de\s*:)\s*[:\s]*([^\n]+)/i,
            total: /(?:total|montant)\s*(?:ttc|ht)?\s*[:\s]*(\d+[,\.]\d{2})\s*€?/i,
            item: /(\d+)\s*[x×]\s*(.+?)\s+(\d+[,\.]\d{2})\s*€?/gi
        };

        // Extraction
        const orderMatch = text.match(patterns.orderNumber);
        if (orderMatch) result.orderNumber = orderMatch[1];

        const dateMatch = text.match(patterns.date);
        if (dateMatch) result.date = dateMatch[1];

        const supplierMatch = text.match(patterns.supplier);
        if (supplierMatch) result.supplier = supplierMatch[1].trim();

        const totalMatch = text.match(patterns.total);
        if (totalMatch) result.total = parseFloat(totalMatch[1].replace(',', '.'));

        // Items
        let itemMatch;
        while ((itemMatch = patterns.item.exec(text)) !== null) {
            result.items.push({
                quantity: parseInt(itemMatch[1]),
                description: itemMatch[2].trim(),
                price: parseFloat(itemMatch[3].replace(',', '.'))
            });
        }

        // Calcul de confiance
        let confidencePoints = 0;
        if (result.orderNumber) confidencePoints += 25;
        if (result.date) confidencePoints += 20;
        if (result.supplier) confidencePoints += 20;
        if (result.items.length > 0) confidencePoints += 25;
        if (result.total) confidencePoints += 10;
        result.confidence = confidencePoints;

        return result;
    },

    /**
     * Parse un rapport d'intervention
     */
    parseInterventionReport(text) {
        const result = {
            type: 'intervention',
            interventionNumber: null,
            date: null,
            technician: null,
            equipment: null,
            location: null,
            description: null,
            duration: null,
            partsUsed: [],
            confidence: 0
        };

        const patterns = {
            interventionNumber: /(?:n[°o]?\s*(?:intervention|inter|rapport)|intervention\s*n[°o]?)\s*[:\s]*([A-Z0-9-]+)/i,
            date: /(?:date|le)\s*[:\s]*(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/i,
            technician: /(?:technicien|intervenant|réalisé par)\s*[:\s]*([^\n]+)/i,
            equipment: /(?:équipement|appareil|machine|n[°o]?\s*série)\s*[:\s]*([^\n]+)/i,
            location: /(?:lieu|site|adresse|client)\s*[:\s]*([^\n]+)/i,
            duration: /(?:durée|temps)\s*[:\s]*(\d+)\s*(?:h|heures?|min)/i,
            parts: /(?:pièces?|références?)\s*[:\s]*([^\n]+)/gi
        };

        // Extraction
        const interventionMatch = text.match(patterns.interventionNumber);
        if (interventionMatch) result.interventionNumber = interventionMatch[1];

        const dateMatch = text.match(patterns.date);
        if (dateMatch) result.date = dateMatch[1];

        const techMatch = text.match(patterns.technician);
        if (techMatch) result.technician = techMatch[1].trim();

        const equipMatch = text.match(patterns.equipment);
        if (equipMatch) result.equipment = equipMatch[1].trim();

        const locationMatch = text.match(patterns.location);
        if (locationMatch) result.location = locationMatch[1].trim();

        const durationMatch = text.match(patterns.duration);
        if (durationMatch) result.duration = parseInt(durationMatch[1]);

        // Description (tout le texte restant après nettoyage)
        result.description = text.substring(0, 500).replace(/\n+/g, ' ').trim();

        // Calcul de confiance
        let confidencePoints = 0;
        if (result.interventionNumber) confidencePoints += 20;
        if (result.date) confidencePoints += 20;
        if (result.technician) confidencePoints += 15;
        if (result.equipment) confidencePoints += 20;
        if (result.location) confidencePoints += 15;
        if (result.duration) confidencePoints += 10;
        result.confidence = confidencePoints;

        return result;
    },

    /**
     * Détecte automatiquement le type de document
     */
    detectDocumentType(text) {
        const lowerText = text.toLowerCase();
        
        if (lowerText.includes('commande') || lowerText.includes('order') || lowerText.includes('bon de')) {
            return 'order';
        }
        if (lowerText.includes('intervention') || lowerText.includes('rapport') || lowerText.includes('technicien')) {
            return 'intervention';
        }
        if (lowerText.includes('facture') || lowerText.includes('invoice')) {
            return 'invoice';
        }
        if (lowerText.includes('devis') || lowerText.includes('quote')) {
            return 'quote';
        }
        
        return 'unknown';
    }
};

/**
 * Composant OCR Import
 */
const OCRImportModal = ({ isOpen, onClose, onImport }) => {
    const [file, setFile] = useState(null);
    const [preview, setPreview] = useState(null);
    const [processing, setProcessing] = useState(false);
    const [progress, setProgress] = useState(0);
    const [result, setResult] = useState(null);
    const [rawText, setRawText] = useState('');
    const [showRawText, setShowRawText] = useState(false);
    const fileInputRef = useRef(null);

    const handleFileSelect = async (e) => {
        const selectedFile = e.target.files[0];
        if (!selectedFile) return;

        setFile(selectedFile);
        setResult(null);
        setRawText('');

        // Créer la prévisualisation
        if (selectedFile.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => setPreview(e.target.result);
            reader.readAsDataURL(selectedFile);
        } else {
            setPreview(null);
        }
    };

    const handleProcess = async () => {
        if (!file) return;

        setProcessing(true);
        setProgress(10);

        try {
            // Initialiser OCR
            setProgress(20);
            await OCRService.initialize();
            
            setProgress(40);
            
            // Extraire le texte
            let text;
            if (file.type.startsWith('image/')) {
                text = await OCRService.extractText(file);
            } else if (file.type === 'application/pdf') {
                // Pour les PDFs, on pourrait utiliser pdf.js
                text = "Extraction PDF non supportée. Veuillez convertir en image.";
            }
            
            setProgress(70);
            setRawText(text);

            // Détecter et parser le document
            const docType = OCRService.detectDocumentType(text);
            let parsed;
            
            if (docType === 'order') {
                parsed = OCRService.parseOrderDocument(text);
            } else if (docType === 'intervention') {
                parsed = OCRService.parseInterventionReport(text);
            } else {
                parsed = {
                    type: 'unknown',
                    rawText: text,
                    confidence: 0
                };
            }

            setProgress(100);
            setResult(parsed);
        } catch (error) {
            console.error('OCR Error:', error);
            setResult({ error: error.message });
        } finally {
            setProcessing(false);
        }
    };

    const handleImport = () => {
        if (result && !result.error) {
            onImport(result);
            onClose();
        }
    };

    if (!isOpen) return null;

    return h('div', { className: 'modal-overlay', onClick: onClose },
        h('div', { className: 'modal modal-lg ocr-modal', onClick: e => e.stopPropagation() },
            h('div', { className: 'modal-header' },
                h('h2', null, '📄 Import OCR'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'modal-body' },
                // Zone de drop
                h('div', { 
                    className: `ocr-dropzone ${file ? 'has-file' : ''}`,
                    onClick: () => fileInputRef.current?.click(),
                    onDragOver: e => e.preventDefault(),
                    onDrop: e => {
                        e.preventDefault();
                        const droppedFile = e.dataTransfer.files[0];
                        if (droppedFile) {
                            setFile(droppedFile);
                            handleFileSelect({ target: { files: [droppedFile] } });
                        }
                    }
                },
                    h('input', {
                        ref: fileInputRef,
                        type: 'file',
                        accept: 'image/*,.pdf',
                        onChange: handleFileSelect,
                        style: { display: 'none' }
                    }),
                    !file ? h(Fragment, null,
                        h('div', { className: 'ocr-dropzone-icon' }, '📷'),
                        h('p', null, 'Glissez un document ou cliquez pour sélectionner'),
                        h('p', { className: 'ocr-hint' }, 'Formats acceptés: Images (JPG, PNG), PDF')
                    ) : h(Fragment, null,
                        preview && h('img', { src: preview, className: 'ocr-preview', alt: 'Preview' }),
                        h('p', { className: 'ocr-filename' }, file.name),
                        h('button', { 
                            className: 'btn btn-sm btn-ghost',
                            onClick: (e) => { e.stopPropagation(); setFile(null); setPreview(null); setResult(null); }
                        }, '✕ Supprimer')
                    )
                ),

                // Bouton de traitement
                file && !result && h('div', { className: 'ocr-actions' },
                    h('button', {
                        className: 'btn btn-primary btn-lg',
                        onClick: handleProcess,
                        disabled: processing
                    }, processing ? `Analyse en cours... ${progress}%` : '🔍 Analyser le document')
                ),

                // Barre de progression
                processing && h('div', { className: 'ocr-progress' },
                    h('div', { className: 'ocr-progress-bar', style: { width: `${progress}%` } })
                ),

                // Résultats
                result && !result.error && h('div', { className: 'ocr-result' },
                    h('div', { className: 'ocr-result-header' },
                        h('h3', null, 
                            result.type === 'order' ? '🛒 Bon de commande détecté' :
                            result.type === 'intervention' ? '🔧 Rapport d\'intervention détecté' :
                            '📄 Document détecté'
                        ),
                        h('div', { className: `ocr-confidence confidence-${result.confidence >= 70 ? 'high' : result.confidence >= 40 ? 'medium' : 'low'}` },
                            `Confiance: ${result.confidence}%`
                        )
                    ),

                    // Données extraites selon le type
                    result.type === 'order' && h('div', { className: 'ocr-data' },
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'N° Commande'),
                            h('span', null, result.orderNumber || '-')
                        ),
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'Fournisseur'),
                            h('span', null, result.supplier || '-')
                        ),
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'Date'),
                            h('span', null, result.date || '-')
                        ),
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'Total'),
                            h('span', null, result.total ? `${result.total} €` : '-')
                        ),
                        result.items.length > 0 && h('div', { className: 'ocr-items' },
                            h('label', null, 'Articles détectés'),
                            h('ul', null, result.items.map((item, i) => 
                                h('li', { key: i }, `${item.quantity}x ${item.description} - ${item.price}€`)
                            ))
                        )
                    ),

                    result.type === 'intervention' && h('div', { className: 'ocr-data' },
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'N° Intervention'),
                            h('span', null, result.interventionNumber || '-')
                        ),
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'Date'),
                            h('span', null, result.date || '-')
                        ),
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'Technicien'),
                            h('span', null, result.technician || '-')
                        ),
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'Équipement'),
                            h('span', null, result.equipment || '-')
                        ),
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'Lieu'),
                            h('span', null, result.location || '-')
                        ),
                        h('div', { className: 'ocr-field' },
                            h('label', null, 'Durée'),
                            h('span', null, result.duration ? `${result.duration}h` : '-')
                        )
                    ),

                    // Texte brut
                    h('button', { 
                        className: 'btn btn-sm btn-ghost',
                        onClick: () => setShowRawText(!showRawText)
                    }, showRawText ? '▲ Masquer le texte brut' : '▼ Voir le texte brut'),
                    
                    showRawText && h('pre', { className: 'ocr-raw-text' }, rawText)
                ),

                result && result.error && h('div', { className: 'ocr-error' },
                    h('p', null, '❌ Erreur: ', result.error)
                )
            ),

            result && !result.error && h('div', { className: 'modal-footer' },
                h('button', { className: 'btn btn-ghost', onClick: onClose }, 'Annuler'),
                h('button', { 
                    className: 'btn btn-primary',
                    onClick: handleImport,
                    disabled: result.confidence < 30
                }, '✓ Importer les données')
            )
        )
    );
};

// ============================================================================
// 3. GÉOLOCALISATION DES INTERVENTIONS SUR CARTE
// ============================================================================

/**
 * Service de géolocalisation
 */
const GeoService = {
    /**
     * Obtient la position actuelle de l'utilisateur
     */
    async getCurrentPosition() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                reject(new Error('Géolocalisation non supportée'));
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (position) => resolve({
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                }),
                (error) => reject(error),
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });
    },

    /**
     * Géocode une adresse vers des coordonnées
     * Utilise Photon (Komoot) - gratuit, rapide, basé sur OSM
     */
    async geocodeAddress(address) {
        try {
            const encoded = encodeURIComponent(address);
            const response = await fetch(
                `https://photon.komoot.io/api/?q=${encoded}&limit=1&lang=fr`
            );
            const data = await response.json();
            
            if (data.features && data.features.length > 0) {
                const feature = data.features[0];
                const [lng, lat] = feature.geometry.coordinates;
                const props = feature.properties;
                const displayName = [props.name, props.street, props.city, props.country].filter(Boolean).join(', ');
                return {
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                    displayName: displayName
                };
            }
            return null;
        } catch (error) {
            console.error('Geocoding error:', error);
            return null;
        }
    },

    /**
     * Calcule la distance entre deux points (en km)
     */
    calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371; // Rayon de la Terre en km
        const dLat = this.toRad(lat2 - lat1);
        const dLng = this.toRad(lng2 - lng1);
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    },

    toRad(deg) {
        return deg * (Math.PI / 180);
    },

    /**
     * Optimise un itinéraire (algorithme du plus proche voisin)
     */
    optimizeRoute(points, startPoint) {
        if (points.length <= 1) return points;
        
        const remaining = [...points];
        const route = [];
        let current = startPoint || remaining.shift();
        
        while (remaining.length > 0) {
            let nearestIndex = 0;
            let nearestDistance = Infinity;
            
            for (let i = 0; i < remaining.length; i++) {
                const dist = this.calculateDistance(
                    current.lat, current.lng,
                    remaining[i].lat, remaining[i].lng
                );
                if (dist < nearestDistance) {
                    nearestDistance = dist;
                    nearestIndex = i;
                }
            }
            
            route.push(remaining[nearestIndex]);
            current = remaining[nearestIndex];
            remaining.splice(nearestIndex, 1);
        }
        
        return route;
    }
};

/**
 * Composant Carte des interventions avec Leaflet
 */
const InterventionMap = ({ events, users, onEventClick, onOptimizeRoute, showToast, geoSearchCenter, mapCenter, selectedTournee }) => {
    const mapRef = useRef(null);
    const mapInstanceRef = useRef(null);
    const markersRef = useRef([]);
    const clusterGroupRef = useRef(null);
    const searchCircleRef = useRef(null);
    const routeLineRef = useRef(null);
    const [userPosition, setUserPosition] = useState(null);
    const [selectedTechnician, setSelectedTechnician] = useState('all');
    const [showOptimized, setShowOptimized] = useState(false);
    const [loading, setLoading] = useState(true);
    const [mapReady, setMapReady] = useState(false);
    const [useClustering, setUseClustering] = useState(true);
    const [mapStyle, setMapStyle] = useState('streets');
    const [showHeatmap, setShowHeatmap] = useState(false);

    // Charger Leaflet et plugins dynamiquement
    useEffect(() => {
        const loadLeaflet = async () => {
            if (!window.L) {
                const css = document.createElement('link');
                css.rel = 'stylesheet';
                css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(css);

                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                await new Promise(resolve => {
                    script.onload = resolve;
                    document.head.appendChild(script);
                });
            }
            
            if (!window.L.markerClusterGroup) {
                const clusterCss = document.createElement('link');
                clusterCss.rel = 'stylesheet';
                clusterCss.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css';
                document.head.appendChild(clusterCss);
                
                const clusterCss2 = document.createElement('link');
                clusterCss2.rel = 'stylesheet';
                clusterCss2.href = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css';
                document.head.appendChild(clusterCss2);
                
                const clusterScript = document.createElement('script');
                clusterScript.src = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';
                await new Promise(resolve => {
                    clusterScript.onload = resolve;
                    document.head.appendChild(clusterScript);
                });
            }
            
            setMapReady(true);
        };
        loadLeaflet();
    }, []);

    // Styles de carte
    const mapStyles = {
        streets: { url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', attribution: '© OpenStreetMap', name: '🗺️ Plan' },
        satellite: { url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', attribution: '© Esri', name: '🛰️ Satellite' },
        terrain: { url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', attribution: '© OpenTopoMap', name: '⛰️ Relief' },
        dark: { url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', attribution: '© CartoDB', name: '🌙 Sombre' }
    };

    // Initialiser la carte
    useEffect(() => {
        if (!mapReady || !mapRef.current || mapInstanceRef.current) return;

        mapInstanceRef.current = window.L.map(mapRef.current, {
            zoomControl: false,
            scrollWheelZoom: true
        }).setView([45.75, 4.85], 10); // Centre sur Lyon par défaut
        
        // Contrôle zoom en haut à droite
        window.L.control.zoom({ position: 'topright' }).addTo(mapInstanceRef.current);
        
        // Couche de tuiles
        const style = mapStyles[mapStyle];
        window.L.tileLayer(style.url, { attribution: style.attribution, maxZoom: 19 }).addTo(mapInstanceRef.current);

        // Clusters intelligents avec couleur selon priorité dominante
        if (window.L.markerClusterGroup) {
            clusterGroupRef.current = window.L.markerClusterGroup({
                chunkedLoading: true,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: true,
                zoomToBoundsOnClick: true,
                maxClusterRadius: 60,
                iconCreateFunction: (cluster) => {
                    const markers = cluster.getAllChildMarkers();
                    const count = markers.length;
                    
                    // Calculer la couleur dominante selon les priorités
                    let urgent = 0, haute = 0, enCours = 0, termine = 0;
                    markers.forEach(m => {
                        const e = m.eventData;
                        if (e) {
                            if (e.priority === 'urgente') urgent++;
                            else if (e.priority === 'haute') haute++;
                            else if (e.status === 'en-cours') enCours++;
                            else if (e.status === 'termine') termine++;
                        }
                    });
                    
                    let color = '#3B82F6'; // Bleu par défaut
                    let borderColor = '#2563EB';
                    if (urgent > 0) { color = '#EF4444'; borderColor = '#DC2626'; }
                    else if (haute > 0) { color = '#F59E0B'; borderColor = '#D97706'; }
                    else if (enCours > 0) { color = '#8B5CF6'; borderColor = '#7C3AED'; }
                    else if (termine === count) { color = '#10B981'; borderColor = '#059669'; }
                    
                    const size = count < 10 ? 40 : count < 50 ? 48 : 56;
                    
                    return window.L.divIcon({
                        html: `<div style="
                            background: ${color};
                            color: white;
                            width: ${size}px;
                            height: ${size}px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: 700;
                            font-size: ${count < 10 ? 14 : 12}px;
                            border: 3px solid ${borderColor};
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            transition: transform 0.2s;
                        ">${count}</div>`,
                        className: 'marker-cluster-custom',
                        iconSize: [size, size]
                    });
                }
            });
            mapInstanceRef.current.addLayer(clusterGroupRef.current);
        }

        setLoading(false);

        return () => {
            if (mapInstanceRef.current) {
                mapInstanceRef.current.remove();
                mapInstanceRef.current = null;
            }
        };
    }, [mapReady]);

    // Changer le style de carte
    useEffect(() => {
        if (!mapInstanceRef.current || !mapReady) return;
        
        mapInstanceRef.current.eachLayer(layer => {
            if (layer instanceof window.L.TileLayer) {
                mapInstanceRef.current.removeLayer(layer);
            }
        });
        
        const style = mapStyles[mapStyle];
        window.L.tileLayer(style.url, { attribution: style.attribution, maxZoom: 19 }).addTo(mapInstanceRef.current);
    }, [mapStyle, mapReady]);

    // Position utilisateur
    useEffect(() => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => setUserPosition({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                err => console.log('Position non disponible:', err.message)
            );
        }
    }, []);

    // Centrer sur la recherche géographique
    useEffect(() => {
        if (!mapInstanceRef.current || !mapReady || !geoSearchCenter) return;
        
        // Supprimer l'ancien cercle
        if (searchCircleRef.current) {
            searchCircleRef.current.remove();
            searchCircleRef.current = null;
        }
        
        // Créer le cercle de recherche
        const radiusMeters = geoSearchCenter.radius * 1000;
        searchCircleRef.current = window.L.circle([geoSearchCenter.lat, geoSearchCenter.lng], {
            radius: radiusMeters,
            color: '#E11D48',
            fillColor: '#E11D48',
            fillOpacity: 0.1,
            weight: 2,
            dashArray: '5, 10'
        }).addTo(mapInstanceRef.current);
        
        // Ajouter un marqueur central
        const centerIcon = window.L.divIcon({
            className: 'search-center-marker',
            html: '<div style="background:#E11D48;color:white;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid white;box-shadow:0 4px 12px rgba(225,29,72,0.4)">🎯</div>',
            iconSize: [36, 36],
            iconAnchor: [18, 18]
        });
        const centerMarker = window.L.marker([geoSearchCenter.lat, geoSearchCenter.lng], { icon: centerIcon })
            .addTo(mapInstanceRef.current)
            .bindPopup(`<b>Centre de recherche</b><br>${geoSearchCenter.name || 'Position recherchée'}<br>Rayon: ${geoSearchCenter.radius} km`);
        
        markersRef.current.push(centerMarker);
        
        // Zoomer sur le cercle
        mapInstanceRef.current.fitBounds(searchCircleRef.current.getBounds(), { padding: [30, 30] });
        
    }, [geoSearchCenter, mapReady]);

    // Centrer sur mapCenter si fourni
    useEffect(() => {
        if (!mapInstanceRef.current || !mapReady || !mapCenter) return;
        mapInstanceRef.current.setView([mapCenter.lat, mapCenter.lng], mapCenter.zoom || 13);
    }, [mapCenter, mapReady]);

    // Mettre à jour les marqueurs
    useEffect(() => {
        if (!mapInstanceRef.current || !mapReady) return;

        // Supprimer les anciens marqueurs
        markersRef.current.forEach(m => { if (m.remove) m.remove(); });
        markersRef.current = [];
        
        if (clusterGroupRef.current) clusterGroupRef.current.clearLayers();
        if (routeLineRef.current) { routeLineRef.current.remove(); routeLineRef.current = null; }

        // Filtrer les événements
        let filteredEvents = events.filter(e => e.lat && e.lng);
        if (selectedTechnician !== 'all') {
            filteredEvents = filteredEvents.filter(e => e.assigned_to === selectedTechnician);
        }

        // Optimiser si demandé
        if (showOptimized && userPosition && filteredEvents.length > 1) {
            filteredEvents.sort((a, b) => {
                const distA = Math.sqrt(Math.pow(a.lat - userPosition.lat, 2) + Math.pow(a.lng - userPosition.lng, 2));
                const distB = Math.sqrt(Math.pow(b.lat - userPosition.lat, 2) + Math.pow(b.lng - userPosition.lng, 2));
                return distA - distB;
            });
        }

        // Créer les marqueurs
        const bounds = [];
        const markers = [];
        
        filteredEvents.forEach((event, index) => {
            const tech = users.find(u => u.id === event.assigned_to);
            const color = getMarkerColor(event);
            const isUrgent = event.priority === 'urgente';
            
            const icon = window.L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background: ${color};
                    color: white;
                    width: ${isUrgent ? 38 : 32}px;
                    height: ${isUrgent ? 38 : 32}px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: ${isUrgent ? 14 : 12}px;
                    border: ${isUrgent ? 3 : 2}px solid white;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.35);
                    cursor: pointer;
                    ${isUrgent ? 'animation: pulse-urgent 1.5s infinite;' : ''}
                ">${showOptimized ? index + 1 : (isUrgent ? '⚠️' : '📍')}</div>`,
                iconSize: [isUrgent ? 38 : 32, isUrgent ? 38 : 32],
                iconAnchor: [isUrgent ? 19 : 16, isUrgent ? 19 : 16]
            });

            const marker = window.L.marker([event.lat, event.lng], { icon });
            marker.eventData = event; // Stocker les données pour le clustering
            
            // Popup enrichi
            const techName = tech ? `${tech.first_name || ''} ${tech.last_name || ''}`.trim() : 'Non assigné';
            const statusLabels = { 'termine': '✅ Terminé', 'en-cours': '🔄 En cours', 'planifie': '📅 Planifié' };
            const priorityLabels = { 'urgente': '🔴 Urgente', 'haute': '🟠 Haute', 'normal': '🔵 Normale', 'basse': '⚪ Basse' };
            
            marker.bindPopup(`
                <div style="min-width:240px;font-family:system-ui,-apple-system,sans-serif">
                    <div style="font-weight:700;font-size:15px;margin-bottom:10px;color:#1E293B;border-bottom:2px solid ${color};padding-bottom:8px">
                        ${event.device_number || event.title || 'Intervention'}
                    </div>
                    <div style="font-size:12px;color:#64748B;margin-bottom:6px;display:flex;align-items:center;gap:6px">
                        <span style="font-size:14px">📍</span> ${event.location || 'Lieu non défini'}
                    </div>
                    <div style="font-size:12px;color:#64748B;margin-bottom:6px;display:flex;align-items:center;gap:6px">
                        <span style="font-size:14px">📅</span> ${event.scheduled_date || '-'} ${event.scheduled_time ? `à ${event.scheduled_time}` : ''}
                    </div>
                    <div style="font-size:12px;color:#64748B;margin-bottom:10px;display:flex;align-items:center;gap:6px">
                        <span style="font-size:14px">👤</span> ${techName}
                    </div>
                    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
                        <span style="padding:3px 8px;background:${color}20;color:${color};border-radius:4px;font-size:11px;font-weight:600">${statusLabels[event.status] || event.status}</span>
                        ${event.priority && event.priority !== 'normal' ? `<span style="padding:3px 8px;background:#FEF3C7;color:#92400E;border-radius:4px;font-size:11px;font-weight:600">${priorityLabels[event.priority]}</span>` : ''}
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${event.lat},${event.lng}" target="_blank" style="flex:1;padding:8px 12px;background:#4285F4;color:white;border-radius:6px;font-size:11px;text-decoration:none;text-align:center;font-weight:600">🗺️ Google Maps</a>
                        <a href="https://waze.com/ul?ll=${event.lat},${event.lng}&navigate=yes" target="_blank" style="flex:1;padding:8px 12px;background:#33CCFF;color:white;border-radius:6px;font-size:11px;text-decoration:none;text-align:center;font-weight:600">🚙 Waze</a>
                    </div>
                </div>
            `, { maxWidth: 300 });
            
            marker.on('click', () => onEventClick && onEventClick(event));

            markers.push(marker);
            bounds.push([event.lat, event.lng]);
        });

        // Ajouter les marqueurs
        if (useClustering && clusterGroupRef.current && markers.length > 0) {
            clusterGroupRef.current.addLayers(markers);
        } else {
            markers.forEach(m => m.addTo(mapInstanceRef.current));
        }
        markersRef.current = markers;

        // Position utilisateur
        if (userPosition) {
            const userIcon = window.L.divIcon({
                className: 'user-marker',
                html: '<div style="background:#3B82F6;width:22px;height:22px;border-radius:50%;border:3px solid white;box-shadow:0 0 20px rgba(59,130,246,0.6);animation:pulse 2s infinite"></div>',
                iconSize: [22, 22],
                iconAnchor: [11, 11]
            });
            const userMarker = window.L.marker([userPosition.lat, userPosition.lng], { icon: userIcon })
                .addTo(mapInstanceRef.current)
                .bindPopup('<b>📍 Votre position</b>');
            markersRef.current.push(userMarker);
            bounds.push([userPosition.lat, userPosition.lng]);
        }

        // Ajuster la vue (sauf si recherche géographique active)
        if (bounds.length > 0 && !geoSearchCenter && !mapCenter) {
            mapInstanceRef.current.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
        }

        // Tracer l'itinéraire optimisé ou de tournée
        const shouldDrawRoute = showOptimized || selectedTournee;
        if (shouldDrawRoute && filteredEvents.length > 1) {
            const routePoints = userPosition 
                ? [[userPosition.lat, userPosition.lng], ...filteredEvents.map(e => [e.lat, e.lng])]
                : filteredEvents.map(e => [e.lat, e.lng]);
            
            const routeColor = selectedTournee?.techColor || '#E11D48';
            
            routeLineRef.current = window.L.polyline(routePoints, {
                color: routeColor,
                weight: 4,
                opacity: 0.85,
                dashArray: selectedTournee ? null : '10, 10',
                lineCap: 'round',
                lineJoin: 'round'
            }).addTo(mapInstanceRef.current);
            
            // Calculer distance totale
            let totalDist = 0;
            for (let i = 0; i < routePoints.length - 1; i++) {
                const lat1 = routePoints[i][0], lng1 = routePoints[i][1];
                const lat2 = routePoints[i+1][0], lng2 = routePoints[i+1][1];
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                totalDist += R * c;
            }
            
            if (showToast && showOptimized) {
                showToast(`Itinéraire: ${Math.round(totalDist)} km (~${Math.round(totalDist/40*60)} min)`, 'info');
            }
        }
    }, [events, users, selectedTechnician, showOptimized, userPosition, mapReady, useClustering, geoSearchCenter, selectedTournee]);

    const getMarkerColor = (event) => {
        if (event.status === 'termine') return '#10B981';
        if (event.priority === 'urgente') return '#EF4444';
        if (event.priority === 'haute') return '#F59E0B';
        if (event.status === 'en-cours') return '#8B5CF6';
        return '#3B82F6';
    };

    // Export Google Maps
    const exportToGoogleMaps = () => {
        let filteredEvents = events.filter(e => e.lat && e.lng);
        if (selectedTechnician !== 'all') {
            filteredEvents = filteredEvents.filter(e => e.assigned_to === selectedTechnician);
        }
        
        if (filteredEvents.length === 0) {
            showToast && showToast('Aucune intervention à exporter', 'warning');
            return;
        }
        
        const waypoints = filteredEvents.slice(0, 10);
        const origin = userPosition ? `${userPosition.lat},${userPosition.lng}` : `${waypoints[0].lat},${waypoints[0].lng}`;
        const destination = `${waypoints[waypoints.length - 1].lat},${waypoints[waypoints.length - 1].lng}`;
        const waypointsStr = waypoints.slice(1, -1).map(e => `${e.lat},${e.lng}`).join('|');
        
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypointsStr ? `&waypoints=${waypointsStr}` : ''}&travelmode=driving`, '_blank');
    };

    // Centrer sur ma position
    const centerOnUser = () => {
        if (userPosition && mapInstanceRef.current) {
            mapInstanceRef.current.setView([userPosition.lat, userPosition.lng], 14);
        } else {
            navigator.geolocation.getCurrentPosition(
                pos => {
                    setUserPosition({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                    mapInstanceRef.current?.setView([pos.coords.latitude, pos.coords.longitude], 14);
                },
                () => showToast && showToast('Position non disponible', 'warning')
            );
        }
    };

    const technicians = users.filter(u => u.role === 'technicien' || u.role === 'admin');
    const eventsWithCoords = events.filter(e => e.lat && e.lng).length;
    const urgentCount = events.filter(e => e.priority === 'urgente').length;

    // CSS animations
    useEffect(() => {
        if (!document.getElementById('map-styles-v59')) {
            const style = document.createElement('style');
            style.id = 'map-styles-v59';
            style.textContent = `
                @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
                @keyframes pulse-urgent { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 50% { transform: scale(1.1); } 70% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
                .leaflet-popup-content-wrapper { border-radius: 12px !important; box-shadow: 0 8px 30px rgba(0,0,0,0.15) !important; }
                .leaflet-popup-tip { box-shadow: 0 4px 10px rgba(0,0,0,0.1) !important; }
                .marker-cluster-custom:hover { transform: scale(1.15); }
                .leaflet-control-zoom { border: none !important; box-shadow: 0 2px 10px rgba(0,0,0,0.15) !important; border-radius: 8px !important; overflow: hidden; }
                .leaflet-control-zoom a { width: 34px !important; height: 34px !important; line-height: 34px !important; font-size: 18px !important; }
            `;
            document.head.appendChild(style);
        }
    }, []);

    return h('div', { className: 'intervention-map-container card', style: { overflow: 'hidden', borderRadius: 12 } },
        // Toolbar améliorée
        h('div', { style: { 
            padding: '10px 16px', 
            background: 'linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%)',
            borderBottom: `1px solid ${COLORS.border}`, 
            display: 'flex', 
            gap: 10, 
            flexWrap: 'wrap', 
            alignItems: 'center' 
        } },
            // Filtre technicien
            h('select', {
                className: 'form-select',
                value: selectedTechnician,
                onChange: e => setSelectedTechnician(e.target.value),
                style: { minWidth: 150, fontSize: 13 }
            },
                h('option', { value: 'all' }, '👥 Tous'),
                technicians.map(t => h('option', { key: t.id, value: t.id }, 
                    `👤 ${t.first_name || t.email?.split('@')[0] || 'Tech'}`
                ))
            ),
            
            // Style de carte
            h('select', {
                className: 'form-select',
                value: mapStyle,
                onChange: e => setMapStyle(e.target.value),
                style: { minWidth: 110, fontSize: 13 }
            },
                Object.entries(mapStyles).map(([key, style]) => h('option', { key, value: key }, style.name))
            ),
            
            // Boutons d'action
            h('div', { style: { display: 'flex', gap: 6 } },
                h('button', {
                    className: `btn btn-sm ${useClustering ? 'btn-primary' : 'btn-ghost'}`,
                    onClick: () => setUseClustering(!useClustering),
                    title: 'Regrouper les marqueurs'
                }, '🔘'),
                h('button', {
                    className: `btn btn-sm ${showOptimized ? 'btn-primary' : 'btn-ghost'}`,
                    onClick: () => setShowOptimized(!showOptimized),
                    disabled: eventsWithCoords < 2,
                    title: 'Optimiser itinéraire'
                }, '🛣️'),
                h('button', {
                    className: 'btn btn-sm btn-ghost',
                    onClick: centerOnUser,
                    title: 'Ma position'
                }, '📍'),
                h('button', {
                    className: 'btn btn-sm btn-ghost',
                    onClick: exportToGoogleMaps,
                    disabled: eventsWithCoords === 0,
                    title: 'Exporter vers Google Maps'
                }, '🗺️')
            ),
            
            // Stats
            h('div', { style: { marginLeft: 'auto', display: 'flex', gap: 12, alignItems: 'center' } },
                urgentCount > 0 && h('span', { style: { 
                    padding: '4px 10px', 
                    background: '#FEE2E2', 
                    color: '#DC2626', 
                    borderRadius: 6, 
                    fontSize: 12, 
                    fontWeight: 600 
                } }, `${urgentCount} urgente(s)`),
                h('span', { style: { fontSize: 12, color: COLORS.muted } }, 
                    `${eventsWithCoords}/${events.length} GPS`
                )
            )
        ),

        // Carte
        h('div', { 
            ref: mapRef, 
            style: { height: 520, background: '#E5E7EB', position: 'relative' }
        },
            loading && h('div', { style: { 
                position: 'absolute', inset: 0, 
                display: 'flex', flexDirection: 'column',
                alignItems: 'center', justifyContent: 'center',
                background: 'rgba(255,255,255,0.95)', zIndex: 1000
            } },
                h('div', { style: { 
                    width: 44, height: 44, 
                    border: '4px solid #E5E7EB', 
                    borderTopColor: COLORS.primary, 
                    borderRadius: '50%', 
                    animation: 'spin 1s linear infinite' 
                } }),
                h('p', { style: { marginTop: 14, color: COLORS.muted, fontWeight: 500 } }, 'Chargement de la carte...')
            )
        ),

        // Légende améliorée
        h('div', { style: { 
            padding: '10px 16px', 
            background: COLORS.card,
            borderTop: `1px solid ${COLORS.border}`, 
            display: 'flex', 
            gap: 14, 
            flexWrap: 'wrap',
            fontSize: 11,
            alignItems: 'center'
        } },
            h('span', { style: { fontWeight: 600, color: COLORS.textSecondary, marginRight: 4 } }, 'Légende:'),
            [
                { color: '#3B82F6', label: 'Planifié' },
                { color: '#8B5CF6', label: 'En cours' },
                { color: '#F59E0B', label: 'Priorité haute' },
                { color: '#EF4444', label: 'Urgent' },
                { color: '#10B981', label: 'Terminé' }
            ].map(item => h('div', { key: item.label, style: { display: 'flex', alignItems: 'center', gap: 5 } },
                h('span', { style: { width: 10, height: 10, borderRadius: '50%', background: item.color, boxShadow: '0 1px 3px rgba(0,0,0,0.2)' } }),
                h('span', { style: { color: COLORS.textSecondary } }, item.label)
            )),
            userPosition && h('div', { style: { display: 'flex', alignItems: 'center', gap: 5, marginLeft: 'auto' } },
                h('span', { style: { width: 10, height: 10, borderRadius: '50%', background: '#3B82F6', boxShadow: '0 0 6px rgba(59,130,246,0.5)' } }),
                h('span', { style: { color: COLORS.textSecondary } }, 'Ma position')
            ),
            geoSearchCenter && h('div', { style: { display: 'flex', alignItems: 'center', gap: 5 } },
                h('span', { style: { width: 10, height: 10, borderRadius: '50%', background: '#E11D48', border: '2px dashed #E11D48' } }),
                h('span', { style: { color: COLORS.textSecondary } }, `Zone (${geoSearchCenter.radius}km)`)
            )
        )
    );
};


// ============================================================================
// 4. CHAT INTERNE ENTRE TECHNICIENS
// ============================================================================

/**
 * Service de chat (simulation avec localStorage/Supabase)
 * En production, utiliser Supabase Realtime ou WebSocket
 */
const ChatService = {
    STORAGE_KEY: 'stockapp-chat-messages',
    listeners: [],
    realtimeChannel: null,

    /**
     * Initialise le service avec temps réel Supabase
     */
    async init(userId) {
        // Écouter les nouveaux messages en temps réel
        window.addEventListener('new-chat-message', (e) => {
            const message = e.detail;
            if (message.conversation_id?.includes(userId)) {
                this.listeners.forEach(cb => cb(message));
            }
        });
    },

    /**
     * Récupère les messages d'une conversation (Supabase ou localStorage)
     */
    async getMessagesAsync(conversationId) {
        try {
            const { data, error } = await db.from('chat_messages')
                .select('*')
                .eq('conversation_id', conversationId)
                .order('created_at', { ascending: true });
            
            if (!error && data) {
                return data.map(m => ({
                    id: m.id,
                    conversationId: m.conversation_id,
                    senderId: m.sender_id,
                    content: m.content,
                    type: m.type || 'text',
                    timestamp: m.created_at,
                    read: m.read
                }));
            }
        } catch (e) {
            console.log('Fallback localStorage pour messages');
        }
        return this.getMessages(conversationId);
    },

    /**
     * Récupère les messages d'une conversation (localStorage fallback)
     */
    getMessages(conversationId) {
        const all = this.getAllMessages();
        return all.filter(m => m.conversationId === conversationId)
                  .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    },

    /**
     * Récupère tous les messages
     */
    getAllMessages() {
        try {
            return JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
        } catch {
            return [];
        }
    },

    /**
     * Envoie un message (Supabase + localStorage)
     */
    async sendMessageAsync(conversationId, senderId, content, type = 'text') {
        const message = {
            id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
            conversationId,
            senderId,
            content,
            type,
            timestamp: new Date().toISOString(),
            read: false
        };

        // Sauvegarder en localStorage d'abord (pour offline)
        const messages = this.getAllMessages();
        messages.push(message);
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(messages));

        // Sauvegarder sur Supabase
        try {
            await db.from('chat_messages').insert({
                id: message.id,
                conversation_id: conversationId,
                sender_id: senderId,
                content: content,
                type: type,
                read: false
            });
        } catch (e) {
            console.log('Message sauvegardé localement, sync plus tard');
        }

        // Notifier les listeners locaux
        this.listeners.forEach(cb => cb(message));

        return message;
    },

    /**
     * Envoie un message (sync)
     */
    sendMessage(conversationId, senderId, content, type = 'text') {
        this.sendMessageAsync(conversationId, senderId, content, type);
        return { conversationId, senderId, content, type, timestamp: new Date().toISOString() };
    },

    /**
     * Marque les messages comme lus
     */
    async markAsRead(conversationId, userId) {
        // localStorage
        const messages = this.getAllMessages();
        messages.forEach(m => {
            if (m.conversationId === conversationId && m.senderId !== userId) {
                m.read = true;
            }
        });
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(messages));

        // Supabase
        try {
            await db.from('chat_messages')
                .update({ read: true })
                .eq('conversation_id', conversationId)
                .neq('sender_id', userId);
        } catch (e) {
            console.log('markAsRead sync plus tard');
        }
    },

    /**
     * Compte les messages non lus
     */
    getUnreadCount(userId) {
        const messages = this.getAllMessages();
        return messages.filter(m => m.senderId !== userId && !m.read).length;
    },

    /**
     * Récupère les conversations d'un utilisateur (Supabase)
     */
    async getConversationsAsync(userId, users) {
        try {
            // Récupérer tous les messages impliquant cet utilisateur depuis Supabase
            const { data, error } = await db.from('chat_messages')
                .select('*')
                .or(`conversation_id.ilike.%${userId}%`)
                .order('created_at', { ascending: false });
            
            if (!error && data && data.length > 0) {
                const conversationIds = [...new Set(data.map(m => m.conversation_id))];
                
                return conversationIds.map(convId => {
                    const convMessages = data.filter(m => m.conversation_id === convId);
                    const lastMessage = convMessages[0]; // Premier car trié desc
                    const otherUserId = convId.split('-').find(id => id !== userId);
                    const otherUser = users.find(u => u.id === otherUserId);
                    const unreadCount = convMessages.filter(m => m.sender_id !== userId && !m.read).length;

                    return {
                        id: convId,
                        otherUser,
                        lastMessage: lastMessage ? {
                            id: lastMessage.id,
                            content: lastMessage.content,
                            timestamp: lastMessage.created_at
                        } : null,
                        unreadCount,
                        updatedAt: lastMessage?.created_at
                    };
                }).sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0));
            }
        } catch (e) {
            console.log('Fallback localStorage pour conversations');
        }
        return this.getConversations(userId, users);
    },

    /**
     * Récupère les conversations d'un utilisateur
     */
    getConversations(userId, users) {
        const messages = this.getAllMessages();
        const conversationIds = [...new Set(messages
            .filter(m => m.conversationId?.includes(userId))
            .map(m => m.conversationId)
        )];

        return conversationIds.map(convId => {
            const convMessages = messages.filter(m => m.conversationId === convId);
            const lastMessage = convMessages[convMessages.length - 1];
            const otherUserId = convId.split('-').find(id => id !== userId);
            const otherUser = users.find(u => u.id === otherUserId);
            const unreadCount = convMessages.filter(m => m.senderId !== userId && !m.read).length;

            return {
                id: convId,
                otherUser,
                lastMessage,
                unreadCount,
                updatedAt: lastMessage?.timestamp
            };
        }).sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0));
    },

    /**
     * Crée un ID de conversation entre deux utilisateurs
     */
    createConversationId(userId1, userId2) {
        return [userId1, userId2].sort().join('-');
    },

    /**
     * Ajoute un listener pour les nouveaux messages
     */
    onMessage(callback) {
        this.listeners.push(callback);
        return () => {
            this.listeners = this.listeners.filter(cb => cb !== callback);
        };
    }
};

/**
 * Composant Chat Panel
 */
const ChatPanel = ({ isOpen, onClose, currentUser, users }) => {
    const [activeConversation, setActiveConversation] = useState(null);
    const [conversations, setConversations] = useState([]);
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [showNewChat, setShowNewChat] = useState(false);
    const [isTyping, setIsTyping] = useState(false);
    const messagesEndRef = useRef(null);

    // Debug
    useEffect(() => {
        console.log('[ChatPanel] currentUser:', currentUser);
        console.log('[ChatPanel] users:', users);
    }, [currentUser, users]);

    // Charger les conversations (localStorage + Supabase)
    useEffect(() => {
        if (currentUser?.id) {
            // D'abord localStorage pour affichage immédiat
            const localConvs = ChatService.getConversations(currentUser.id, users || []);
            console.log('[ChatPanel] Conversations localStorage:', localConvs);
            setConversations(localConvs);
            
            // Puis Supabase pour avoir toutes les conversations
            ChatService.getConversationsAsync(currentUser.id, users || []).then(supabaseConvs => {
                console.log('[ChatPanel] Conversations Supabase:', supabaseConvs);
                if (supabaseConvs && supabaseConvs.length > 0) {
                    // Fusionner les conversations
                    setConversations(prev => {
                        const allConvs = [...prev];
                        supabaseConvs.forEach(conv => {
                            const existing = allConvs.findIndex(c => c.id === conv.id);
                            if (existing === -1) {
                                allConvs.push(conv);
                            } else if (conv.lastMessage) {
                                // Mettre à jour avec les infos Supabase
                                allConvs[existing] = conv;
                            }
                        });
                        return allConvs.sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0));
                    });
                }
            });
        }
    }, [currentUser, users]);

    // Charger les messages de la conversation active (depuis Supabase)
    useEffect(() => {
        if (activeConversation && currentUser?.id) {
            // Charger d'abord depuis localStorage pour affichage immédiat
            const localMsgs = ChatService.getMessages(activeConversation.id);
            if (localMsgs.length > 0) {
                setMessages(localMsgs);
            }
            
            // Puis charger depuis Supabase pour avoir les messages de l'autre utilisateur
            ChatService.getMessagesAsync(activeConversation.id).then(supabaseMsgs => {
                console.log('[ChatPanel] Messages Supabase:', supabaseMsgs);
                if (supabaseMsgs && supabaseMsgs.length > 0) {
                    // Fusionner avec les messages locaux (éviter doublons)
                    setMessages(prev => {
                        const allMsgs = [...prev];
                        supabaseMsgs.forEach(msg => {
                            if (!allMsgs.find(m => m.id === msg.id)) {
                                allMsgs.push(msg);
                            }
                        });
                        // Trier par date
                        allMsgs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        return allMsgs;
                    });
                }
            });
            
            ChatService.markAsRead(activeConversation.id, currentUser.id);
        }
    }, [activeConversation, currentUser]);

    // Scroll en bas lors de nouveaux messages
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    // Écouter les nouveaux messages en TEMPS RÉEL
    useEffect(() => {
        // Listener pour les messages locaux (ChatService)
        const unsubscribe = ChatService.onMessage((message) => {
            if (activeConversation && message.conversationId === activeConversation.id) {
                setMessages(prev => {
                    // Éviter les doublons
                    if (prev.find(m => m.id === message.id)) return prev;
                    return [...prev, message];
                });
            }
            setConversations(ChatService.getConversations(currentUser.id, users));
        });

        // Listener pour les messages temps réel Supabase
        const handleRealtimeMessage = (e) => {
            const msg = e.detail;
            if (activeConversation && msg.conversation_id === activeConversation.id) {
                const formattedMsg = {
                    id: msg.id,
                    conversationId: msg.conversation_id,
                    senderId: msg.sender_id,
                    content: msg.content,
                    type: msg.type || 'text',
                    timestamp: msg.created_at,
                    read: msg.read
                };
                setMessages(prev => {
                    if (prev.find(m => m.id === formattedMsg.id)) return prev;
                    return [...prev, formattedMsg];
                });
                // Marquer comme lu si c'est pas nous
                if (msg.sender_id !== currentUser.id) {
                    ChatService.markAsRead(activeConversation.id, currentUser.id);
                }
            }
            // Rafraîchir la liste des conversations
            setTimeout(() => {
                setConversations(ChatService.getConversations(currentUser.id, users));
            }, 100);
        };

        window.addEventListener('new-chat-message', handleRealtimeMessage);

        // Rafraîchir les messages toutes les 5 secondes si conversation active
        const refreshInterval = setInterval(() => {
            if (activeConversation) {
                ChatService.getMessagesAsync(activeConversation.id).then(supabaseMsgs => {
                    if (supabaseMsgs && supabaseMsgs.length > 0) {
                        setMessages(prev => {
                            const allMsgs = [...prev];
                            let hasNew = false;
                            supabaseMsgs.forEach(msg => {
                                if (!allMsgs.find(m => m.id === msg.id)) {
                                    allMsgs.push(msg);
                                    hasNew = true;
                                }
                            });
                            if (hasNew) {
                                allMsgs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                                return allMsgs;
                            }
                            return prev;
                        });
                    }
                });
            }
        }, 5000);

        return () => {
            unsubscribe();
            window.removeEventListener('new-chat-message', handleRealtimeMessage);
            clearInterval(refreshInterval);
        };
    }, [activeConversation, currentUser, users]);

    const handleSend = async () => {
        if (!newMessage.trim() || !activeConversation || !currentUser?.id) return;

        const msgContent = newMessage.trim();
        setNewMessage(''); // Vider immédiatement
        
        // Créer le message localement pour affichage immédiat
        const localMsg = {
            id: 'temp_' + Date.now(),
            conversationId: activeConversation.id,
            senderId: currentUser.id,
            content: msgContent,
            type: 'text',
            timestamp: new Date().toISOString(),
            read: false
        };
        
        // Ajouter immédiatement aux messages affichés
        setMessages(prev => [...prev, localMsg]);
        
        // Envoyer via le service (sauvegarde localStorage + Supabase)
        try {
            const sentMsg = await ChatService.sendMessageAsync(
                activeConversation.id,
                currentUser.id,
                msgContent
            );
            console.log('[Chat] Message envoyé:', sentMsg);
            
            // Remplacer le message temporaire par le vrai
            setMessages(prev => prev.map(m => m.id === localMsg.id ? sentMsg : m));
            
            // Rafraîchir les conversations
            setConversations(ChatService.getConversations(currentUser.id, users || []));
        } catch (e) {
            console.error('[Chat] Erreur envoi:', e);
        }
    };

    const startNewConversation = (otherUser) => {
        if (!currentUser?.id || !otherUser?.id) {
            console.error('[Chat] IDs utilisateurs manquants:', { currentUser, otherUser });
            return;
        }
        const convId = ChatService.createConversationId(String(currentUser.id), String(otherUser.id));
        console.log('[Chat] Nouvelle conversation créée:', convId, 'avec', otherUser);
        setActiveConversation({
            id: convId,
            otherUser
        });
        setShowNewChat(false);
    };

    const formatTime = (timestamp) => {
        const date = new Date(timestamp);
        const now = new Date();
        const isToday = date.toDateString() === now.toDateString();
        
        if (isToday) {
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }
        return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
    };

    if (!isOpen) return null;

    const otherUsers = users.filter(u => u.id !== currentUser?.id);

    return h('div', { className: 'chat-panel' },
        h('div', { className: 'chat-header' },
            h('h3', null, activeConversation ? activeConversation.otherUser?.first_name || 'Chat' : '💬 Messages'),
            h('div', { className: 'chat-header-actions' },
                activeConversation && activeConversation.otherUser?.id && h('button', { 
                    className: 'btn btn-ghost btn-sm',
                    onClick: () => {
                        console.log('[Chat] Appel vidéo vers:', activeConversation.otherUser);
                        window.dispatchEvent(new CustomEvent('open-video-call', { 
                            detail: activeConversation.otherUser 
                        }));
                    },
                    title: 'Appel vidéo'
                }, '📹'),
                activeConversation && h('button', { 
                    className: 'btn btn-ghost btn-sm',
                    onClick: () => setActiveConversation(null)
                }, '←'),
                !activeConversation && h('button', { 
                    className: 'btn btn-ghost btn-sm',
                    onClick: () => setShowNewChat(true)
                }, '+'),
                h('button', { className: 'btn btn-ghost btn-sm', onClick: onClose }, '✕')
            )
        ),

        // Liste des conversations
        !activeConversation && !showNewChat && h('div', { className: 'chat-conversations' },
            conversations.length === 0 
                ? h('div', { className: 'chat-empty' },
                    h('p', null, 'Aucune conversation'),
                    h('button', { 
                        className: 'btn btn-primary btn-sm',
                        onClick: () => setShowNewChat(true)
                    }, 'Démarrer une discussion')
                )
                : conversations.map(conv => h('div', {
                    key: conv.id,
                    className: `chat-conversation-item ${conv.unreadCount > 0 ? 'unread' : ''}`,
                    onClick: () => setActiveConversation(conv)
                },
                    h('div', { className: 'chat-avatar' },
                        (conv.otherUser?.first_name?.[0] || '?').toUpperCase()
                    ),
                    h('div', { className: 'chat-conversation-info' },
                        h('div', { className: 'chat-conversation-name' },
                            conv.otherUser?.first_name || 'Utilisateur'
                        ),
                        h('div', { className: 'chat-conversation-preview' },
                            conv.lastMessage?.content?.substring(0, 30) || 'Nouveau chat'
                        )
                    ),
                    h('div', { className: 'chat-conversation-meta' },
                        conv.lastMessage && h('span', { className: 'chat-time' }, 
                            formatTime(conv.lastMessage.timestamp)
                        ),
                        conv.unreadCount > 0 && h('span', { className: 'chat-unread-badge' }, conv.unreadCount)
                    )
                ))
        ),

        // Nouvelle conversation
        showNewChat && h('div', { className: 'chat-new' },
            h('div', { className: 'chat-new-header' },
                h('button', { className: 'btn btn-ghost btn-sm', onClick: () => setShowNewChat(false) }, '←'),
                h('span', null, 'Nouveau message')
            ),
            h('div', { className: 'chat-users-list' },
                otherUsers.map(user => h('div', {
                    key: user.id,
                    className: 'chat-user-item',
                    style: { display: 'flex', alignItems: 'center', gap: 8 }
                },
                    h('div', { 
                        style: { flex: 1, display: 'flex', alignItems: 'center', gap: 8, cursor: 'pointer' },
                        onClick: () => startNewConversation(user)
                    },
                        h('div', { className: 'chat-avatar' }, (user.first_name?.[0] || '?').toUpperCase()),
                        h('div', { className: 'chat-user-info' },
                            h('div', { className: 'chat-user-name' }, user.first_name || user.email),
                            h('div', { className: 'chat-user-role' }, user.role)
                        )
                    ),
                    h('button', {
                        className: 'btn btn-ghost btn-sm',
                        onClick: (e) => {
                            e.stopPropagation();
                            window.dispatchEvent(new CustomEvent('open-video-call', { detail: user }));
                        },
                        title: 'Appel vidéo'
                    }, '📹')
                ))
            )
        ),

        // Messages de la conversation
        activeConversation && (() => {
            console.log('[ChatPanel] Rendering messages:', messages.length, messages.map(m => m.content));
            return h(Fragment, null,
                h('div', { className: 'chat-messages' },
                    // Debug: nombre de messages
                    h('div', { 
                        style: { textAlign: 'center', fontSize: 10, color: 'var(--muted)', padding: 4, background: 'var(--background)', borderRadius: 4, marginBottom: 8 } 
                    }, `${messages.length} message(s) - ID conv: ${activeConversation.id?.substring(0, 8)}...`),
                    messages.length === 0 && h('div', { 
                        style: { textAlign: 'center', padding: 40, color: 'var(--muted)' } 
                    }, 'Aucun message. Commencez la conversation !'),
                    messages.map(msg => {
                        const isMine = String(msg.senderId) === String(currentUser?.id);
                        return h('div', {
                            key: msg.id,
                            className: `chat-message ${isMine ? 'sent' : 'received'}`
                        },
                            h('div', { className: 'chat-message-content' }, msg.content),
                            h('div', { className: 'chat-message-time' }, formatTime(msg.timestamp))
                        );
                    }),
                    h('div', { ref: messagesEndRef })
                ),
                h('div', { className: 'chat-input' },
                    h('input', {
                        type: 'text',
                        placeholder: 'Écrivez votre message...',
                        value: newMessage,
                        onChange: e => setNewMessage(e.target.value),
                        onKeyPress: e => e.key === 'Enter' && handleSend()
                    }),
                    h('button', { 
                        className: 'btn btn-primary',
                        onClick: handleSend,
                        disabled: !newMessage.trim()
                    }, '➤')
                )
            );
        })()
    );
};

/**
 * Bouton flottant de chat
 */
const ChatButton = ({ unreadCount, onClick }) => {
    return h('button', {
        className: 'chat-fab',
        onClick,
        title: unreadCount > 0 ? `${unreadCount} message(s) non lu(s)` : 'Messages'
    },
        h('span', { className: 'chat-fab-icon' }, '💬'),
        unreadCount > 0 && h('span', { className: 'chat-fab-badge' }, unreadCount > 99 ? '99+' : unreadCount)
    );
};

// ============================================================================
// 5. NOTIFICATIONS PUSH PARAMÉTRABLES
// ============================================================================

/**
 * Service de notifications push (v5.4)
 */
const PushNotificationServiceV54 = {
    permission: null,
    subscribed: false,

    /**
     * Vérifie si les notifications sont supportées
     */
    isSupported() {
        return 'Notification' in window && 'serviceWorker' in navigator;
    },

    /**
     * Demande la permission
     */
    async requestPermission() {
        if (!this.isSupported()) return false;
        
        const permission = await Notification.requestPermission();
        this.permission = permission;
        return permission === 'granted';
    },

    /**
     * Vérifie la permission actuelle
     */
    getPermission() {
        if (!this.isSupported()) return 'denied';
        return Notification.permission;
    },

    /**
     * Envoie une notification
     */
    async send(title, options = {}) {
        if (this.getPermission() !== 'granted') {
            console.log('Notifications non autorisées');
            return false;
        }

        const defaultOptions = {
            icon: '/icon-192.png',
            badge: '/badge-72.png',
            vibrate: [200, 100, 200],
            requireInteraction: false,
            silent: false,
            ...options
        };

        try {
            // Utiliser le service worker si disponible
            const registration = await navigator.serviceWorker.ready;
            await registration.showNotification(title, defaultOptions);
            return true;
        } catch (error) {
            // Fallback vers notification simple
            new Notification(title, defaultOptions);
            return true;
        }
    },

    /**
     * Récupère les paramètres de notification
     */
    getSettings() {
        const defaults = {
            enabled: true,
            sound: true,
            vibration: true,
            categories: {
                stock_low: { enabled: true, label: 'Stock bas' },
                task_assigned: { enabled: true, label: 'Tâche assignée' },
                task_urgent: { enabled: true, label: 'Tâche urgente' },
                task_completed: { enabled: true, label: 'Tâche terminée' },
                order_received: { enabled: true, label: 'Commande reçue' },
                chat_message: { enabled: true, label: 'Nouveau message' },
                planning_reminder: { enabled: true, label: 'Rappel planning' },
                maintenance_due: { enabled: true, label: 'Maintenance due' },
                ai_alert: { enabled: true, label: 'Alerte IA prédictive' }
            },
            quietHours: {
                enabled: false,
                start: '22:00',
                end: '07:00'
            }
        };

        try {
            const saved = localStorage.getItem('stockapp-push-settings');
            return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
        } catch {
            return defaults;
        }
    },

    /**
     * Sauvegarde les paramètres
     */
    saveSettings(settings) {
        localStorage.setItem('stockapp-push-settings', JSON.stringify(settings));
    },

    /**
     * Vérifie si une catégorie de notification est activée
     */
    isCategoryEnabled(category) {
        const settings = this.getSettings();
        if (!settings.enabled) return false;
        if (settings.categories[category]?.enabled === false) return false;
        
        // Vérifier les heures calmes
        if (settings.quietHours.enabled) {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const { start, end } = settings.quietHours;
            
            if (start < end) {
                // Heures calmes ne passent pas minuit
                if (currentTime >= start && currentTime < end) return false;
            } else {
                // Heures calmes passent minuit
                if (currentTime >= start || currentTime < end) return false;
            }
        }
        
        return true;
    },

    /**
     * Envoie une notification si la catégorie est activée
     */
    async notify(category, title, body, data = {}) {
        if (!this.isCategoryEnabled(category)) return false;
        
        const settings = this.getSettings();
        
        return this.send(title, {
            body,
            tag: category,
            data: { ...data, category },
            silent: !settings.sound,
            vibrate: settings.vibration ? [200, 100, 200] : []
        });
    }
};

/**
 * Hook pour les notifications push
 */
const usePushNotifications = () => {
    const [permission, setPermission] = useState(PushNotificationService.getPermission());
    const [settings, setSettings] = useState(PushNotificationService.getSettings());

    const requestPermission = async () => {
        const granted = await PushNotificationService.requestPermission();
        setPermission(PushNotificationService.getPermission());
        return granted;
    };

    const updateSettings = (newSettings) => {
        const updated = { ...settings, ...newSettings };
        PushNotificationService.saveSettings(updated);
        setSettings(updated);
    };

    const toggleCategory = (category) => {
        const updated = {
            ...settings,
            categories: {
                ...settings.categories,
                [category]: {
                    ...settings.categories[category],
                    enabled: !settings.categories[category]?.enabled
                }
            }
        };
        PushNotificationService.saveSettings(updated);
        setSettings(updated);
    };

    const notify = (category, title, body, data) => {
        return PushNotificationService.notify(category, title, body, data);
    };

    return {
        permission,
        settings,
        requestPermission,
        updateSettings,
        toggleCategory,
        notify,
        isSupported: PushNotificationService.isSupported()
    };
};

/**
 * Modal de configuration des notifications
 */
const NotificationSettingsModal = ({ isOpen, onClose }) => {
    const { permission, settings, requestPermission, updateSettings, toggleCategory, isSupported } = usePushNotifications();
    const [testSent, setTestSent] = useState(false);

    if (!isOpen) return null;

    const handleTestNotification = async () => {
        const sent = await PushNotificationService.send('Test StockApp', {
            body: 'Les notifications fonctionnent correctement !',
            tag: 'test'
        });
        setTestSent(sent);
        setTimeout(() => setTestSent(false), 3000);
    };

    return h('div', { className: 'modal-overlay', onClick: onClose },
        h('div', { className: 'modal notification-settings-modal', onClick: e => e.stopPropagation() },
            h('div', { className: 'modal-header' },
                h('h2', null, '🔔 Paramètres de notifications'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'modal-body' },
                // État de la permission
                !isSupported && h('div', { className: 'notification-warning' },
                    h('p', null, '⚠️ Les notifications ne sont pas supportées par votre navigateur')
                ),

                isSupported && permission !== 'granted' && h('div', { className: 'notification-permission' },
                    h('p', null, 'Les notifications sont désactivées'),
                    h('button', { 
                        className: 'btn btn-primary',
                        onClick: requestPermission
                    }, '🔔 Activer les notifications')
                ),

                isSupported && permission === 'granted' && h(Fragment, null,
                    // Toggle global
                    h('div', { className: 'notification-toggle-main' },
                        h('label', { className: 'toggle-label' },
                            h('span', null, 'Notifications activées'),
                            h('input', {
                                type: 'checkbox',
                                checked: settings.enabled,
                                onChange: () => updateSettings({ enabled: !settings.enabled })
                            }),
                            h('span', { className: 'toggle-slider' })
                        )
                    ),

                    // Options son/vibration
                    h('div', { className: 'notification-options' },
                        h('label', { className: 'toggle-label' },
                            h('span', null, '🔊 Son'),
                            h('input', {
                                type: 'checkbox',
                                checked: settings.sound,
                                onChange: () => updateSettings({ sound: !settings.sound })
                            }),
                            h('span', { className: 'toggle-slider' })
                        ),
                        h('label', { className: 'toggle-label' },
                            h('span', null, '📳 Vibration'),
                            h('input', {
                                type: 'checkbox',
                                checked: settings.vibration,
                                onChange: () => updateSettings({ vibration: !settings.vibration })
                            }),
                            h('span', { className: 'toggle-slider' })
                        )
                    ),

                    // Catégories
                    h('div', { className: 'notification-categories' },
                        h('h4', null, 'Types de notifications'),
                        Object.entries(settings.categories).map(([key, cat]) => 
                            h('label', { key, className: 'notification-category' },
                                h('span', null, cat.label),
                                h('input', {
                                    type: 'checkbox',
                                    checked: cat.enabled,
                                    onChange: () => toggleCategory(key)
                                }),
                                h('span', { className: 'toggle-slider' })
                            )
                        )
                    ),

                    // Heures calmes
                    h('div', { className: 'notification-quiet-hours' },
                        h('h4', null, '🌙 Heures calmes'),
                        h('label', { className: 'toggle-label' },
                            h('span', null, 'Activer les heures calmes'),
                            h('input', {
                                type: 'checkbox',
                                checked: settings.quietHours.enabled,
                                onChange: () => updateSettings({
                                    quietHours: { ...settings.quietHours, enabled: !settings.quietHours.enabled }
                                })
                            }),
                            h('span', { className: 'toggle-slider' })
                        ),
                        settings.quietHours.enabled && h('div', { className: 'quiet-hours-times' },
                            h('label', null, 'De'),
                            h('input', {
                                type: 'time',
                                value: settings.quietHours.start,
                                onChange: e => updateSettings({
                                    quietHours: { ...settings.quietHours, start: e.target.value }
                                })
                            }),
                            h('label', null, 'À'),
                            h('input', {
                                type: 'time',
                                value: settings.quietHours.end,
                                onChange: e => updateSettings({
                                    quietHours: { ...settings.quietHours, end: e.target.value }
                                })
                            })
                        )
                    ),

                    // Test
                    h('div', { className: 'notification-test' },
                        h('button', {
                            className: 'btn btn-secondary',
                            onClick: handleTestNotification
                        }, testSent ? '✓ Notification envoyée' : '🔔 Tester les notifications')
                    )
                )
            )
        )
    );
};


// ============================================================================
// 6. MODE PRÉSENTATION AMÉLIORÉ AVEC SLIDES AUTO
// ============================================================================

/**
 * Mode présentation avec slides automatiques
 */
const EnhancedPresentationMode = ({ 
    isOpen, 
    onClose, 
    data, 
    settings: customSettings 
}) => {
    const defaultSettings = {
        autoPlay: true,
        interval: 10000, // 10 secondes
        slides: ['overview', 'tasks', 'stock', 'planning', 'team', 'alerts'],
        theme: 'dark',
        showClock: true,
        showProgress: true,
        transitions: 'slide' // slide, fade, zoom
    };

    const [settings, setSettings] = useState({ ...defaultSettings, ...customSettings });
    const [currentSlide, setCurrentSlide] = useState(0);
    const [isPaused, setIsPaused] = useState(false);
    const [showSettings, setShowSettings] = useState(false);
    const [isFullscreen, setIsFullscreen] = useState(false);
    const containerRef = useRef(null);
    const timerRef = useRef(null);

    const enabledSlides = settings.slides.filter(s => s);

    // Auto-play
    useEffect(() => {
        if (isOpen && settings.autoPlay && !isPaused && enabledSlides.length > 1) {
            timerRef.current = setInterval(() => {
                setCurrentSlide(prev => (prev + 1) % enabledSlides.length);
            }, settings.interval);
        }
        return () => clearInterval(timerRef.current);
    }, [isOpen, settings.autoPlay, settings.interval, isPaused, enabledSlides.length]);

    // Raccourcis clavier
    useEffect(() => {
        if (!isOpen) return;

        const handleKeyDown = (e) => {
            switch(e.key) {
                case 'ArrowRight':
                case ' ':
                    setCurrentSlide(prev => (prev + 1) % enabledSlides.length);
                    break;
                case 'ArrowLeft':
                    setCurrentSlide(prev => (prev - 1 + enabledSlides.length) % enabledSlides.length);
                    break;
                case 'p':
                    setIsPaused(p => !p);
                    break;
                case 'f':
                    toggleFullscreen();
                    break;
                case 'Escape':
                    onClose();
                    break;
            }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [isOpen, enabledSlides.length, onClose]);

    const toggleFullscreen = () => {
        if (!document.fullscreenElement) {
            containerRef.current?.requestFullscreen();
            setIsFullscreen(true);
        } else {
            document.exitFullscreen();
            setIsFullscreen(false);
        }
    };

    // Données calculées
    const stats = useMemo(() => {
        const tasks = data.tasks || [];
        const parts = data.parts || [];
        const orders = data.orders || [];
        const events = data.events || [];

        return {
            totalTasks: tasks.length,
            pendingTasks: tasks.filter(t => t.status !== 'termine').length,
            completedTasks: tasks.filter(t => t.status === 'termine').length,
            urgentTasks: tasks.filter(t => t.priority === 'urgent' || t.priority === 'urgente').length,
            todayTasks: tasks.filter(t => {
                const today = new Date().toISOString().split('T')[0];
                return t.scheduled_date === today;
            }).length,
            totalParts: parts.length,
            totalStock: parts.reduce((s, p) => s + (p.quantity || 0), 0),
            lowStock: parts.filter(p => p.quantity <= (p.min_quantity || p.min_stock || 0)).length,
            stockValue: parts.reduce((s, p) => s + ((p.quantity || 0) * (p.price || 0)), 0),
            pendingOrders: orders.filter(o => o.status === 'en-commande').length,
            todayEvents: events.filter(e => {
                const today = new Date().toISOString().split('T')[0];
                return e.scheduled_date === today;
            }).length,
            weekEvents: events.filter(e => {
                const now = new Date();
                const weekLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                const eventDate = new Date(e.scheduled_date);
                return eventDate >= now && eventDate <= weekLater;
            }).length
        };
    }, [data]);

    const renderSlide = (slideType) => {
        switch(slideType) {
            case 'overview':
                return h('div', { className: 'pres-slide pres-overview' },
                    h('h1', { className: 'pres-title' }, '📊 Vue d\'ensemble'),
                    h('div', { className: 'pres-stats-grid' },
                        h('div', { className: 'pres-stat pres-stat-primary' },
                            h('div', { className: 'pres-stat-value' }, stats.pendingTasks),
                            h('div', { className: 'pres-stat-label' }, 'Tâches en cours')
                        ),
                        h('div', { className: 'pres-stat pres-stat-success' },
                            h('div', { className: 'pres-stat-value' }, stats.completedTasks),
                            h('div', { className: 'pres-stat-label' }, 'Tâches terminées')
                        ),
                        h('div', { className: 'pres-stat pres-stat-warning' },
                            h('div', { className: 'pres-stat-value' }, stats.lowStock),
                            h('div', { className: 'pres-stat-label' }, 'Alertes stock')
                        ),
                        h('div', { className: 'pres-stat pres-stat-info' },
                            h('div', { className: 'pres-stat-value' }, stats.todayEvents),
                            h('div', { className: 'pres-stat-label' }, 'Événements aujourd\'hui')
                        )
                    )
                );

            case 'tasks':
                const recentTasks = (data.tasks || [])
                    .filter(t => t.status !== 'termine')
                    .slice(0, 8);
                return h('div', { className: 'pres-slide pres-tasks' },
                    h('h1', { className: 'pres-title' }, '📋 Tâches en cours'),
                    h('div', { className: 'pres-task-list' },
                        recentTasks.map((task, i) => h('div', { 
                            key: task.id,
                            className: `pres-task-item pres-priority-${task.priority || 'normal'}`,
                            style: { animationDelay: `${i * 0.1}s` }
                        },
                            h('div', { className: 'pres-task-number' }, task.device_number || `#${task.id}`),
                            h('div', { className: 'pres-task-info' },
                                h('div', { className: 'pres-task-location' }, task.location || task.site_name || '-'),
                                h('div', { className: 'pres-task-date' }, task.scheduled_date || '-')
                            ),
                            h('div', { className: `pres-task-priority priority-${task.priority || 'normal'}` },
                                task.priority === 'urgent' || task.priority === 'urgente' ? '🚨' : 
                                task.priority === 'haute' ? '⚠️' : '📌'
                            )
                        ))
                    ),
                    stats.urgentTasks > 0 && h('div', { className: 'pres-alert' },
                        '🚨 ', stats.urgentTasks, ' tâche(s) urgente(s)'
                    )
                );

            case 'stock':
                const lowStockItems = (data.parts || [])
                    .filter(p => p.quantity <= (p.min_quantity || p.min_stock || 0))
                    .slice(0, 6);
                return h('div', { className: 'pres-slide pres-stock' },
                    h('h1', { className: 'pres-title' }, '📦 État du stock'),
                    h('div', { className: 'pres-stock-stats' },
                        h('div', { className: 'pres-stock-stat' },
                            h('div', { className: 'pres-stock-value' }, stats.totalParts),
                            h('div', { className: 'pres-stock-label' }, 'Références')
                        ),
                        h('div', { className: 'pres-stock-stat' },
                            h('div', { className: 'pres-stock-value' }, stats.totalStock.toLocaleString()),
                            h('div', { className: 'pres-stock-label' }, 'Quantité totale')
                        ),
                        h('div', { className: 'pres-stock-stat' },
                            h('div', { className: 'pres-stock-value' }, stats.stockValue.toLocaleString(), '€'),
                            h('div', { className: 'pres-stock-label' }, 'Valeur stock')
                        )
                    ),
                    lowStockItems.length > 0 && h(Fragment, null,
                        h('h2', { className: 'pres-subtitle' }, '⚠️ Alertes stock bas'),
                        h('div', { className: 'pres-low-stock-list' },
                            lowStockItems.map((item, i) => h('div', { 
                                key: item.id,
                                className: 'pres-low-stock-item',
                                style: { animationDelay: `${i * 0.1}s` }
                            },
                                h('span', { className: 'pres-item-name' }, item.name),
                                h('span', { className: 'pres-item-qty' }, item.quantity, ' / ', item.min_quantity || item.min_stock || 0)
                            ))
                        )
                    )
                );

            case 'planning':
                const todayEvents = (data.events || [])
                    .filter(e => e.scheduled_date === new Date().toISOString().split('T')[0])
                    .slice(0, 6);
                return h('div', { className: 'pres-slide pres-planning' },
                    h('h1', { className: 'pres-title' }, '📅 Planning du jour'),
                    h('div', { className: 'pres-date' }, 
                        new Date().toLocaleDateString('fr-FR', { 
                            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' 
                        })
                    ),
                    todayEvents.length === 0 
                        ? h('div', { className: 'pres-no-events' }, '✓ Aucun événement prévu')
                        : h('div', { className: 'pres-events-list' },
                            todayEvents.map((evt, i) => h('div', { 
                                key: evt.id,
                                className: 'pres-event-item',
                                style: { animationDelay: `${i * 0.1}s` }
                            },
                                h('div', { className: 'pres-event-time' }, evt.start_time || '-'),
                                h('div', { className: 'pres-event-info' },
                                    h('div', { className: 'pres-event-title' }, evt.title || evt.device_number),
                                    h('div', { className: 'pres-event-location' }, evt.location || '-')
                                ),
                                h('div', { className: 'pres-event-category' }, evt.event_category || '-')
                            ))
                        ),
                    h('div', { className: 'pres-week-preview' },
                        h('span', null, '📆 Cette semaine: '),
                        h('strong', null, stats.weekEvents, ' événement(s)')
                    )
                );

            case 'team':
                const teamStats = {};
                (data.tasks || []).forEach(t => {
                    if (t.assigned_to) {
                        if (!teamStats[t.assigned_to]) {
                            teamStats[t.assigned_to] = { pending: 0, completed: 0 };
                        }
                        if (t.status === 'termine') {
                            teamStats[t.assigned_to].completed++;
                        } else {
                            teamStats[t.assigned_to].pending++;
                        }
                    }
                });
                const teamData = Object.entries(teamStats)
                    .map(([userId, stats]) => {
                        const user = (data.users || []).find(u => u.id === userId);
                        return { user, ...stats };
                    })
                    .filter(t => t.user)
                    .slice(0, 6);

                return h('div', { className: 'pres-slide pres-team' },
                    h('h1', { className: 'pres-title' }, '👥 Charge équipe'),
                    h('div', { className: 'pres-team-list' },
                        teamData.map((member, i) => h('div', { 
                            key: member.user.id,
                            className: 'pres-team-member',
                            style: { animationDelay: `${i * 0.1}s` }
                        },
                            h('div', { className: 'pres-team-avatar' },
                                (member.user.first_name?.[0] || '?').toUpperCase()
                            ),
                            h('div', { className: 'pres-team-info' },
                                h('div', { className: 'pres-team-name' }, 
                                    member.user.first_name || member.user.email
                                ),
                                h('div', { className: 'pres-team-stats' },
                                    h('span', { className: 'pres-team-pending' }, member.pending, ' en cours'),
                                    h('span', { className: 'pres-team-completed' }, member.completed, ' terminées')
                                )
                            ),
                            h('div', { className: 'pres-team-bar' },
                                h('div', { 
                                    className: 'pres-team-bar-fill',
                                    style: { width: `${Math.min(member.pending * 10, 100)}%` }
                                })
                            )
                        ))
                    )
                );

            case 'alerts':
                const alerts = [];
                
                // Stock bas
                if (stats.lowStock > 0) {
                    alerts.push({ type: 'warning', icon: '📦', message: `${stats.lowStock} article(s) en stock bas` });
                }
                // Tâches urgentes
                if (stats.urgentTasks > 0) {
                    alerts.push({ type: 'danger', icon: '🚨', message: `${stats.urgentTasks} tâche(s) urgente(s)` });
                }
                // Commandes en attente
                if (stats.pendingOrders > 0) {
                    alerts.push({ type: 'info', icon: '🛒', message: `${stats.pendingOrders} commande(s) en attente` });
                }

                return h('div', { className: 'pres-slide pres-alerts' },
                    h('h1', { className: 'pres-title' }, '⚠️ Alertes & Notifications'),
                    alerts.length === 0 
                        ? h('div', { className: 'pres-no-alerts' },
                            h('div', { className: 'pres-check-icon' }, '✓'),
                            h('p', null, 'Aucune alerte')
                        )
                        : h('div', { className: 'pres-alerts-list' },
                            alerts.map((alert, i) => h('div', { 
                                key: i,
                                className: `pres-alert-item pres-alert-${alert.type}`,
                                style: { animationDelay: `${i * 0.2}s` }
                            },
                                h('span', { className: 'pres-alert-icon' }, alert.icon),
                                h('span', { className: 'pres-alert-message' }, alert.message)
                            ))
                        )
                );

            default:
                return h('div', { className: 'pres-slide' }, 'Slide non définie');
        }
    };

    if (!isOpen) return null;

    return h('div', { 
        ref: containerRef,
        className: `presentation-mode ${settings.theme}`
    },
        // Contrôles
        h('div', { className: 'pres-controls' },
            h('button', { className: 'pres-control-btn', onClick: () => setIsPaused(!isPaused) },
                isPaused ? '▶' : '⏸'
            ),
            h('button', { className: 'pres-control-btn', onClick: () => setCurrentSlide(prev => (prev - 1 + enabledSlides.length) % enabledSlides.length) }, '◀'),
            h('button', { className: 'pres-control-btn', onClick: () => setCurrentSlide(prev => (prev + 1) % enabledSlides.length) }, '▶'),
            h('button', { className: 'pres-control-btn', onClick: toggleFullscreen },
                isFullscreen ? '⊠' : '⊞'
            ),
            h('button', { className: 'pres-control-btn', onClick: () => setShowSettings(true) }, '⚙'),
            h('button', { className: 'pres-control-btn pres-close-btn', onClick: onClose }, '✕')
        ),

        // Horloge
        settings.showClock && h(PresentationClock),

        // Indicateur de pause
        isPaused && h('div', { className: 'pres-paused-indicator' }, '⏸ En pause'),

        // Slides
        h('div', { className: `pres-slides-container transition-${settings.transitions}` },
            renderSlide(enabledSlides[currentSlide])
        ),

        // Barre de progression
        settings.showProgress && h('div', { className: 'pres-progress' },
            h('div', { 
                className: 'pres-progress-bar',
                style: { width: `${((currentSlide + 1) / enabledSlides.length) * 100}%` }
            })
        ),

        // Indicateurs de slides
        h('div', { className: 'pres-dots' },
            enabledSlides.map((_, i) => h('div', {
                key: i,
                className: `pres-dot ${i === currentSlide ? 'active' : ''}`,
                onClick: () => setCurrentSlide(i)
            }))
        ),

        // Modal paramètres
        showSettings && h('div', { className: 'pres-settings-overlay', onClick: () => setShowSettings(false) },
            h('div', { className: 'pres-settings-modal', onClick: e => e.stopPropagation() },
                h('h3', null, '⚙️ Paramètres de présentation'),
                h('div', { className: 'pres-setting' },
                    h('label', null, 'Lecture automatique'),
                    h('input', {
                        type: 'checkbox',
                        checked: settings.autoPlay,
                        onChange: e => setSettings({ ...settings, autoPlay: e.target.checked })
                    })
                ),
                h('div', { className: 'pres-setting' },
                    h('label', null, 'Intervalle (secondes)'),
                    h('input', {
                        type: 'range',
                        min: 5,
                        max: 30,
                        value: settings.interval / 1000,
                        onChange: e => setSettings({ ...settings, interval: e.target.value * 1000 })
                    }),
                    h('span', null, settings.interval / 1000, 's')
                ),
                h('div', { className: 'pres-setting' },
                    h('label', null, 'Thème'),
                    h('select', {
                        value: settings.theme,
                        onChange: e => setSettings({ ...settings, theme: e.target.value })
                    },
                        h('option', { value: 'dark' }, 'Sombre'),
                        h('option', { value: 'light' }, 'Clair'),
                        h('option', { value: 'blue' }, 'Bleu')
                    )
                ),
                h('div', { className: 'pres-setting' },
                    h('label', null, 'Transition'),
                    h('select', {
                        value: settings.transitions,
                        onChange: e => setSettings({ ...settings, transitions: e.target.value })
                    },
                        h('option', { value: 'slide' }, 'Glissement'),
                        h('option', { value: 'fade' }, 'Fondu'),
                        h('option', { value: 'zoom' }, 'Zoom')
                    )
                ),
                h('button', { 
                    className: 'btn btn-primary',
                    onClick: () => setShowSettings(false)
                }, 'Fermer')
            )
        )
    );
};

/**
 * Horloge pour le mode présentation
 */
const PresentationClock = () => {
    const [time, setTime] = useState(new Date());

    useEffect(() => {
        const timer = setInterval(() => setTime(new Date()), 1000);
        return () => clearInterval(timer);
    }, []);

    return h('div', { className: 'pres-clock' },
        h('span', { className: 'pres-clock-time' }, 
            time.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })
        ),
        h('span', { className: 'pres-clock-date' },
            time.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric', month: 'short' })
        )
    );
};

// ============================================================================
// STYLES CSS v5.4
// ============================================================================

const V54_STYLES = `
/* ============================================================================
   IA PRÉDICTIVE
   ============================================================================ */

.ai-dashboard {
    padding: 20px;
}

.ai-dashboard-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px;
    color: var(--muted);
}

.ai-loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--border);
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 16px;
}

.ai-loading-hint {
    font-size: 13px;
    margin-top: 8px;
}

.ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
}

.ai-title {
    display: flex;
    align-items: center;
    gap: 16px;
}

.ai-icon {
    font-size: 48px;
}

.ai-title h2 {
    margin: 0;
    font-size: 24px;
}

.ai-title p {
    margin: 4px 0 0;
    color: var(--muted);
    font-size: 14px;
}

.ai-stats {
    display: flex;
    gap: 12px;
}

.ai-stat {
    padding: 12px 20px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

.ai-stat:hover {
    transform: scale(1.05);
}

.ai-stat-critical { background: rgba(239, 68, 68, 0.1); color: #EF4444; }
.ai-stat-warning { background: rgba(245, 158, 11, 0.1); color: #F59E0B; }
.ai-stat-moderate { background: rgba(59, 130, 246, 0.1); color: #3B82F6; }
.ai-stat-low { background: rgba(16, 185, 129, 0.1); color: #10B981; }

.ai-stat-value {
    font-size: 28px;
    font-weight: 800;
}

.ai-stat-label {
    font-size: 12px;
    margin-top: 4px;
}

.ai-equipment-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 16px;
}

.ai-equipment-card {
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid var(--border);
}

.ai-equipment-card:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-2px);
}

.ai-risk-critical { border-left: 4px solid #EF4444; }
.ai-risk-warning { border-left: 4px solid #F59E0B; }
.ai-risk-moderate { border-left: 4px solid #3B82F6; }
.ai-risk-low { border-left: 4px solid #10B981; }

.ai-equipment-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.ai-equipment-info h4 {
    margin: 0;
    font-size: 16px;
}

.ai-equipment-info p {
    margin: 4px 0 0;
    color: var(--muted);
    font-size: 13px;
}

.ai-risk-badge {
    padding: 8px 12px;
    border-radius: 20px;
    color: white;
    text-align: center;
}

.ai-risk-score {
    font-size: 20px;
    font-weight: 800;
    display: block;
}

.ai-risk-label {
    font-size: 10px;
    text-transform: uppercase;
}

.ai-equipment-prediction {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: var(--text-secondary);
    padding: 8px 0;
    border-top: 1px solid var(--border);
    margin-top: 8px;
}

.ai-confidence {
    font-size: 11px;
    opacity: 0.7;
}

.ai-recommendations-preview {
    font-size: 12px;
    color: var(--muted);
}

.ai-rec-count {
    font-weight: 600;
    color: var(--primary);
    margin-right: 4px;
}

/* AI Detail Modal */
.ai-detail-modal {
    max-width: 600px;
}

.ai-detail-risk {
    margin-bottom: 24px;
}

.ai-risk-gauge {
    height: 12px;
    background: var(--background);
    border-radius: 6px;
    overflow: hidden;
}

.ai-risk-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.5s ease;
}

.ai-risk-info {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
}

.ai-risk-value {
    font-size: 24px;
    font-weight: 800;
}

.ai-risk-level {
    font-weight: 600;
}

.ai-detail-section {
    margin-bottom: 24px;
}

.ai-detail-section h4 {
    margin: 0 0 12px;
    font-size: 16px;
}

.ai-prediction-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: var(--background);
    border-radius: var(--radius);
}

.ai-pred-label {
    font-size: 13px;
    color: var(--muted);
}

.ai-pred-value {
    font-weight: 600;
    margin-top: 4px;
}

.ai-prediction-days {
    text-align: center;
}

.ai-pred-days {
    font-size: 36px;
    font-weight: 800;
    color: var(--primary);
    display: block;
}

.ai-recommendations {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.ai-recommendation {
    padding: 12px;
    border-radius: var(--radius);
    background: var(--background);
}

.ai-rec-urgent { border-left: 3px solid #EF4444; }
.ai-rec-haute { border-left: 3px solid #F59E0B; }
.ai-rec-normale { border-left: 3px solid #3B82F6; }

.ai-rec-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.ai-rec-type {
    font-weight: 600;
    text-transform: capitalize;
}

.ai-rec-message {
    margin: 0;
    font-size: 14px;
}

.ai-rec-reason {
    margin: 4px 0 0;
    font-size: 12px;
    color: var(--muted);
}

.ai-detail-actions {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

/* ============================================================================
   OCR IMPORT
   ============================================================================ */

.ocr-modal {
    max-width: 700px;
}

.ocr-dropzone {
    border: 2px dashed var(--border);
    border-radius: var(--radius-lg);
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--background);
}

.ocr-dropzone:hover {
    border-color: var(--primary);
    background: var(--primary-pastel);
}

.ocr-dropzone.has-file {
    border-style: solid;
    border-color: var(--success);
}

.ocr-dropzone-icon {
    font-size: 48px;
    margin-bottom: 16px;
}

.ocr-hint {
    font-size: 13px;
    color: var(--muted);
    margin-top: 8px;
}

.ocr-preview {
    max-width: 200px;
    max-height: 200px;
    border-radius: var(--radius);
    margin-bottom: 12px;
}

.ocr-filename {
    font-weight: 600;
    margin-bottom: 8px;
}

.ocr-actions {
    margin-top: 20px;
    text-align: center;
}

.ocr-progress {
    height: 4px;
    background: var(--background);
    border-radius: 2px;
    margin-top: 16px;
    overflow: hidden;
}

.ocr-progress-bar {
    height: 100%;
    background: var(--primary);
    transition: width 0.3s;
}

.ocr-result {
    margin-top: 24px;
    padding: 20px;
    background: var(--background);
    border-radius: var(--radius-lg);
}

.ocr-result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.ocr-result-header h3 {
    margin: 0;
}

.ocr-confidence {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.ocr-confidence.confidence-high { background: #D1FAE5; color: #059669; }
.ocr-confidence.confidence-medium { background: #FEF3C7; color: #D97706; }
.ocr-confidence.confidence-low { background: #FEE2E2; color: #DC2626; }

.ocr-data {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.ocr-field {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.ocr-field label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
}

.ocr-field span {
    font-weight: 500;
}

.ocr-items {
    grid-column: span 2;
}

.ocr-items ul {
    margin: 8px 0 0;
    padding-left: 20px;
}

.ocr-raw-text {
    margin-top: 12px;
    padding: 12px;
    background: var(--card);
    border-radius: var(--radius);
    font-size: 12px;
    max-height: 200px;
    overflow: auto;
    white-space: pre-wrap;
}

.ocr-error {
    padding: 20px;
    background: var(--danger-pastel);
    border-radius: var(--radius);
    color: var(--danger);
}

/* ============================================================================
   CARTE DES INTERVENTIONS
   ============================================================================ */

.intervention-map-container {
    background: var(--card);
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--border);
}

.map-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--background);
    border-bottom: 1px solid var(--border);
}

.map-filters {
    display: flex;
    gap: 12px;
}

.map-filters select {
    min-width: 200px;
}

.map-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.map-count {
    font-size: 13px;
    color: var(--muted);
}

.map-container {
    position: relative;
}

.map-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--background);
    z-index: 10;
}

.map-legend {
    display: flex;
    gap: 16px;
    padding: 12px 16px;
    background: var(--background);
    border-top: 1px solid var(--border);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

/* ============================================================================
   CHAT
   ============================================================================ */

.chat-panel {
    position: fixed;
    right: 20px;
    bottom: 80px;
    width: 360px;
    height: 500px;
    background: var(--card);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    display: flex;
    flex-direction: column;
    z-index: 1000;
    overflow: hidden;
    animation: slideUp 0.3s ease;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: var(--primary);
    color: white;
}

.chat-header h3 {
    margin: 0;
    font-size: 16px;
}

.chat-header-actions {
    display: flex;
    gap: 8px;
}

.chat-header-actions button {
    color: white;
}

.chat-conversations {
    flex: 1;
    overflow-y: auto;
}

.chat-empty {
    text-align: center;
    padding: 40px 20px;
    color: var(--muted);
}

.chat-conversation-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.15s;
    border-bottom: 1px solid var(--border);
}

.chat-conversation-item:hover {
    background: var(--background);
}

.chat-conversation-item.unread {
    background: var(--primary-pastel);
}

.chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    flex-shrink: 0;
}

.chat-conversation-info {
    flex: 1;
    min-width: 0;
}

.chat-conversation-name {
    font-weight: 600;
    font-size: 14px;
}

.chat-conversation-preview {
    font-size: 13px;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-conversation-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 4px;
}

.chat-time {
    font-size: 11px;
    color: var(--muted);
}

.chat-unread-badge {
    background: var(--primary);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    min-height: 200px; /* Debug: assurer une hauteur minimale */
    background: var(--card); /* Debug: fond visible */
}

.chat-message {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 14px;
    border: 1px solid var(--border); /* Debug: bordure visible */
}

.chat-message.sent {
    align-self: flex-end;
    background: var(--primary);
    color: white;
    border-bottom-right-radius: 4px;
}

.chat-message.received {
    align-self: flex-start;
    background: var(--background);
    border-bottom-left-radius: 4px;
}

.chat-message-time {
    font-size: 10px;
    opacity: 0.7;
    margin-top: 4px;
}

.chat-input {
    display: flex;
    gap: 8px;
    padding: 12px 16px;
    border-top: 1px solid var(--border);
}

.chat-input input {
    flex: 1;
    padding: 10px 16px;
    border: 1px solid var(--border);
    border-radius: 20px;
    outline: none;
}

.chat-input input:focus {
    border-color: var(--primary);
}

.chat-fab {
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: var(--shadow-lg);
    z-index: 999;
    transition: all 0.2s;
}

.chat-fab:hover {
    transform: scale(1.1);
}

.chat-fab-icon {
    font-size: 24px;
}

.chat-fab-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #EF4444;
    color: white;
    font-size: 12px;
    font-weight: 700;
    min-width: 22px;
    height: 22px;
    padding: 0 6px;
    border-radius: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: badge-pulse 1.5s ease-in-out infinite;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
}

@keyframes badge-pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5); }
    50% { transform: scale(1.15); box-shadow: 0 2px 12px rgba(239, 68, 68, 0.8); }
}

.chat-new, .chat-users-list {
    flex: 1;
    overflow-y: auto;
}

.chat-new-header {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
}

.chat-user-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: background 0.15s;
}

.chat-user-item:hover {
    background: var(--background);
}

.chat-user-name {
    font-weight: 500;
}

.chat-user-role {
    font-size: 12px;
    color: var(--muted);
}

/* ============================================================================
   NOTIFICATIONS
   ============================================================================ */

.notification-settings-modal {
    max-width: 500px;
}

.notification-warning {
    padding: 16px;
    background: var(--warning-pastel);
    border-radius: var(--radius);
    margin-bottom: 16px;
}

.notification-permission {
    text-align: center;
    padding: 40px;
}

.notification-toggle-main {
    padding: 16px;
    background: var(--background);
    border-radius: var(--radius);
    margin-bottom: 20px;
}

.toggle-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
}

.toggle-slider {
    width: 48px;
    height: 24px;
    background: var(--border);
    border-radius: 12px;
    position: relative;
    transition: background 0.2s;
}

.toggle-label input {
    display: none;
}

.toggle-label input:checked + .toggle-slider {
    background: var(--primary);
}

.toggle-slider::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: transform 0.2s;
}

.toggle-label input:checked + .toggle-slider::after {
    transform: translateX(24px);
}

.notification-options {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
}

.notification-options label {
    flex: 1;
    padding: 12px;
    background: var(--background);
    border-radius: var(--radius);
}

.notification-categories h4 {
    margin: 0 0 12px;
    font-size: 14px;
    color: var(--muted);
}

.notification-category {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid var(--border);
}

.notification-quiet-hours {
    margin-top: 20px;
    padding: 16px;
    background: var(--background);
    border-radius: var(--radius);
}

.notification-quiet-hours h4 {
    margin: 0 0 12px;
}

.quiet-hours-times {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 12px;
}

.quiet-hours-times input {
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
}

.notification-test {
    margin-top: 20px;
    text-align: center;
}

/* ============================================================================
   MODE PRÉSENTATION
   ============================================================================ */

.presentation-mode {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.presentation-mode.dark {
    background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
    color: white;
}

.presentation-mode.light {
    background: linear-gradient(135deg, #F8FAFC 0%, #E2E8F0 100%);
    color: #1E293B;
}

.presentation-mode.blue {
    background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%);
    color: white;
}

.pres-controls {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    gap: 8px;
    z-index: 10;
    opacity: 0.3;
    transition: opacity 0.3s;
}

.pres-controls:hover {
    opacity: 1;
}

.pres-control-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: rgba(255,255,255,0.1);
    color: inherit;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
}

.pres-control-btn:hover {
    background: rgba(255,255,255,0.2);
}

.pres-close-btn {
    background: rgba(239, 68, 68, 0.3);
}

.pres-clock {
    position: absolute;
    top: 20px;
    left: 20px;
    z-index: 10;
}

.pres-clock-time {
    font-size: 48px;
    font-weight: 800;
    display: block;
}

.pres-clock-date {
    font-size: 16px;
    opacity: 0.7;
}

.pres-paused-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    padding: 12px 24px;
    background: rgba(0,0,0,0.5);
    border-radius: var(--radius);
    z-index: 20;
}

.pres-slides-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 80px;
}

.pres-slide {
    width: 100%;
    max-width: 1200px;
    animation: presSlideIn 0.5s ease;
}

.transition-slide .pres-slide {
    animation: presSlideIn 0.5s ease;
}

.transition-fade .pres-slide {
    animation: presFadeIn 0.5s ease;
}

.transition-zoom .pres-slide {
    animation: presZoomIn 0.5s ease;
}

@keyframes presSlideIn {
    from { opacity: 0; transform: translateX(50px); }
    to { opacity: 1; transform: translateX(0); }
}

@keyframes presFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes presZoomIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

.pres-title {
    font-size: 48px;
    font-weight: 800;
    margin: 0 0 40px;
    text-align: center;
}

.pres-subtitle {
    font-size: 28px;
    margin: 32px 0 20px;
}

.pres-stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 24px;
}

.pres-stat {
    padding: 40px;
    border-radius: var(--radius-xl);
    text-align: center;
    background: rgba(255,255,255,0.1);
}

.pres-stat-primary { background: rgba(225, 29, 72, 0.2); }
.pres-stat-success { background: rgba(16, 185, 129, 0.2); }
.pres-stat-warning { background: rgba(245, 158, 11, 0.2); }
.pres-stat-info { background: rgba(59, 130, 246, 0.2); }

.pres-stat-value {
    font-size: 64px;
    font-weight: 800;
}

.pres-stat-label {
    font-size: 18px;
    opacity: 0.8;
    margin-top: 8px;
}

.pres-task-list, .pres-events-list, .pres-team-list, .pres-low-stock-list, .pres-alerts-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.pres-task-item, .pres-event-item, .pres-team-member, .pres-low-stock-item, .pres-alert-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 24px;
    background: rgba(255,255,255,0.1);
    border-radius: var(--radius);
    animation: presItemIn 0.3s ease backwards;
}

@keyframes presItemIn {
    from { opacity: 0; transform: translateX(-20px); }
    to { opacity: 1; transform: translateX(0); }
}

.pres-task-number, .pres-event-time {
    font-size: 20px;
    font-weight: 700;
    min-width: 120px;
}

.pres-task-info, .pres-event-info, .pres-team-info {
    flex: 1;
}

.pres-task-location, .pres-event-title, .pres-team-name {
    font-size: 18px;
    font-weight: 600;
}

.pres-task-date, .pres-event-location, .pres-team-stats {
    font-size: 14px;
    opacity: 0.7;
}

.pres-task-priority {
    font-size: 28px;
}

.pres-alert {
    margin-top: 24px;
    padding: 16px 24px;
    background: rgba(239, 68, 68, 0.3);
    border-radius: var(--radius);
    text-align: center;
    font-size: 20px;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.pres-progress {
    position: absolute;
    bottom: 60px;
    left: 80px;
    right: 80px;
    height: 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 2px;
}

.pres-progress-bar {
    height: 100%;
    background: var(--primary);
    border-radius: 2px;
    transition: width 0.3s;
}

.pres-dots {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
}

.pres-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(255,255,255,0.3);
    cursor: pointer;
    transition: all 0.2s;
}

.pres-dot.active {
    background: white;
    transform: scale(1.2);
}

.pres-settings-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

.pres-settings-modal {
    background: var(--card);
    color: var(--text);
    padding: 24px;
    border-radius: var(--radius-xl);
    min-width: 300px;
}

.pres-settings-modal h3 {
    margin: 0 0 20px;
}

.pres-setting {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

.pres-setting label {
    font-weight: 500;
}

.pres-date {
    text-align: center;
    font-size: 24px;
    opacity: 0.8;
    margin-bottom: 32px;
}

.pres-no-events, .pres-no-alerts {
    text-align: center;
    padding: 60px;
    font-size: 24px;
    opacity: 0.7;
}

.pres-check-icon {
    font-size: 72px;
    margin-bottom: 16px;
}

.pres-week-preview {
    text-align: center;
    margin-top: 32px;
    font-size: 18px;
    opacity: 0.8;
}

.pres-stock-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
    margin-bottom: 32px;
}

.pres-stock-stat {
    text-align: center;
    padding: 32px;
    background: rgba(255,255,255,0.1);
    border-radius: var(--radius-lg);
}

.pres-stock-value {
    font-size: 48px;
    font-weight: 800;
}

.pres-stock-label {
    font-size: 16px;
    opacity: 0.7;
    margin-top: 8px;
}

.pres-item-name {
    flex: 1;
    font-size: 18px;
}

.pres-item-qty {
    font-weight: 700;
    color: #F59E0B;
}

.pres-team-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 700;
}

.pres-team-pending {
    color: #F59E0B;
}

.pres-team-completed {
    color: #10B981;
    margin-left: 16px;
}

.pres-team-bar {
    width: 150px;
    height: 8px;
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
    overflow: hidden;
}

.pres-team-bar-fill {
    height: 100%;
    background: var(--primary);
}

.pres-alert-item {
    font-size: 20px;
}

.pres-alert-critical { background: rgba(239, 68, 68, 0.3); }
.pres-alert-danger { background: rgba(239, 68, 68, 0.3); }
.pres-alert-warning { background: rgba(245, 158, 11, 0.3); }
.pres-alert-info { background: rgba(59, 130, 246, 0.3); }

.pres-alert-icon {
    font-size: 32px;
}

.pres-alert-message {
    flex: 1;
}
`;

// Injecter les styles
if (typeof document !== 'undefined') {
    const styleEl = document.createElement('style');
    styleEl.textContent = V54_STYLES;
    document.head.appendChild(styleEl);
}



/**
 * ============================================================================
 * STOCKAPP v5.5 - FONCTIONNALITÉS AVANCÉES
 * ============================================================================
 * 1. Thèmes personnalisés
 * 2. Widgets configurables
 * 3. Vues sauvegardées
 * 4. Rôles personnalisés
 * 5. Raccourcis personnalisés
 * 6. Appels vidéo intégrés
 * 7. Inventaire par scan NFC
 * 8. Gestion des véhicules
 * 9. Comparaison périodes
 * 10. Mode hors-ligne avancé
 * 11. Photos annotées
 * ============================================================================
 */

// ============================================================================
// 1. THÈMES PERSONNALISÉS
// ============================================================================

const ThemeCustomizer = {
    STORAGE_KEY: 'stockapp-custom-themes',
    ACTIVE_THEME_KEY: 'stockapp-active-theme',

    defaultThemes: [
        {
            id: 'light',
            name: 'Clair',
            icon: '☀️',
            isSystem: true,
            colors: {
                primary: '#E11D48',
                primaryHover: '#BE123C',
                primaryPastel: '#FFF1F2',
                background: '#F8FAFC',
                card: '#FFFFFF',
                text: '#1E293B',
                textSecondary: '#64748B',
                border: '#E2E8F0',
                success: '#10B981',
                warning: '#F59E0B',
                danger: '#EF4444',
                info: '#3B82F6'
            }
        },
        {
            id: 'dark',
            name: 'Sombre',
            icon: '🌙',
            isSystem: true,
            colors: {
                primary: '#E11D48',
                primaryHover: '#F43F5E',
                primaryPastel: '#3D1F2A',
                background: '#0F172A',
                card: '#1E293B',
                text: '#F1F5F9',
                textSecondary: '#94A3B8',
                border: '#334155',
                success: '#10B981',
                warning: '#F59E0B',
                danger: '#EF4444',
                info: '#3B82F6'
            }
        },
        {
            id: 'blue',
            name: 'Bleu Corporate',
            icon: '💼',
            isSystem: true,
            colors: {
                primary: '#2563EB',
                primaryHover: '#1D4ED8',
                primaryPastel: '#EFF6FF',
                background: '#F8FAFC',
                card: '#FFFFFF',
                text: '#1E293B',
                textSecondary: '#64748B',
                border: '#E2E8F0',
                success: '#10B981',
                warning: '#F59E0B',
                danger: '#EF4444',
                info: '#3B82F6'
            }
        },
        {
            id: 'green',
            name: 'Vert Nature',
            icon: '🌿',
            isSystem: true,
            colors: {
                primary: '#059669',
                primaryHover: '#047857',
                primaryPastel: '#ECFDF5',
                background: '#F0FDF4',
                card: '#FFFFFF',
                text: '#1E293B',
                textSecondary: '#64748B',
                border: '#D1FAE5',
                success: '#10B981',
                warning: '#F59E0B',
                danger: '#EF4444',
                info: '#3B82F6'
            }
        }
    ],

    getCustomThemes() {
        try {
            return JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
        } catch {
            return [];
        }
    },

    getAllThemes() {
        return [...this.defaultThemes, ...this.getCustomThemes()];
    },

    saveCustomTheme(theme) {
        const customs = this.getCustomThemes();
        const existingIndex = customs.findIndex(t => t.id === theme.id);
        if (existingIndex >= 0) {
            customs[existingIndex] = theme;
        } else {
            customs.push({ ...theme, id: `custom_${Date.now()}`, isSystem: false });
        }
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(customs));
        return customs;
    },

    deleteCustomTheme(themeId) {
        const customs = this.getCustomThemes().filter(t => t.id !== themeId);
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(customs));
        return customs;
    },

    getActiveThemeId() {
        return localStorage.getItem(this.ACTIVE_THEME_KEY) || 'light';
    },

    setActiveTheme(themeId) {
        localStorage.setItem(this.ACTIVE_THEME_KEY, themeId);
        this.applyTheme(themeId);
    },

    applyTheme(themeId) {
        const theme = this.getAllThemes().find(t => t.id === themeId);
        if (!theme) return;

        const root = document.documentElement;
        Object.entries(theme.colors).forEach(([key, value]) => {
            const cssVar = `--${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
            root.style.setProperty(cssVar, value);
        });

        // Appliquer le mode dark/light pour les autres styles
        document.body.classList.toggle('dark-mode', themeId === 'dark' || theme.colors.background.startsWith('#0') || theme.colors.background.startsWith('#1'));
    }
};

/**
 * Hook pour les thèmes personnalisés
 */
const useCustomThemes = () => {
    const [themes, setThemes] = useState(ThemeCustomizer.getAllThemes());
    const [activeThemeId, setActiveThemeId] = useState(ThemeCustomizer.getActiveThemeId());

    useEffect(() => {
        ThemeCustomizer.applyTheme(activeThemeId);
    }, [activeThemeId]);

    const saveTheme = (theme) => {
        ThemeCustomizer.saveCustomTheme(theme);
        setThemes(ThemeCustomizer.getAllThemes());
    };

    const deleteTheme = (themeId) => {
        ThemeCustomizer.deleteCustomTheme(themeId);
        setThemes(ThemeCustomizer.getAllThemes());
        if (activeThemeId === themeId) {
            setActiveTheme('light');
        }
    };

    const setActiveTheme = (themeId) => {
        ThemeCustomizer.setActiveTheme(themeId);
        setActiveThemeId(themeId);
    };

    return { themes, activeThemeId, saveTheme, deleteTheme, setActiveTheme };
};

/**
 * Modal de personnalisation des thèmes
 */
const ThemeCustomizerModal = ({ isOpen, onClose }) => {
    const { themes, activeThemeId, saveTheme, deleteTheme, setActiveTheme } = useCustomThemes();
    const [editingTheme, setEditingTheme] = useState(null);
    const [newTheme, setNewTheme] = useState({
        name: '',
        icon: '🎨',
        colors: { ...ThemeCustomizer.defaultThemes[0].colors }
    });

    const colorLabels = {
        primary: 'Couleur principale',
        primaryHover: 'Principale (survol)',
        primaryPastel: 'Principale (pastel)',
        background: 'Arrière-plan',
        card: 'Cartes',
        text: 'Texte',
        textSecondary: 'Texte secondaire',
        border: 'Bordures',
        success: 'Succès',
        warning: 'Avertissement',
        danger: 'Danger',
        info: 'Information'
    };

    const handleSave = () => {
        if (!newTheme.name) return;
        saveTheme(editingTheme ? { ...editingTheme, ...newTheme } : newTheme);
        setNewTheme({ name: '', icon: '🎨', colors: { ...ThemeCustomizer.defaultThemes[0].colors } });
        setEditingTheme(null);
    };

    const startEdit = (theme) => {
        setEditingTheme(theme);
        setNewTheme({ name: theme.name, icon: theme.icon, colors: { ...theme.colors } });
    };

    if (!isOpen) return null;

    return h('div', { className: 'modal-overlay', onClick: onClose },
        h('div', { className: 'modal modal-lg theme-modal', onClick: e => e.stopPropagation() },
            h('div', { className: 'modal-header' },
                h('h2', null, '🎨 Thèmes personnalisés'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'modal-body' },
                // Liste des thèmes
                h('div', { className: 'theme-list' },
                    h('h4', null, 'Thèmes disponibles'),
                    h('div', { className: 'theme-grid' },
                        themes.map(theme => h('div', {
                            key: theme.id,
                            className: `theme-card ${activeThemeId === theme.id ? 'active' : ''}`,
                            onClick: () => setActiveTheme(theme.id)
                        },
                            h('div', { className: 'theme-preview', style: {
                                background: theme.colors.background,
                                borderColor: theme.colors.border
                            }},
                                h('div', { className: 'theme-preview-header', style: { background: theme.colors.primary } }),
                                h('div', { className: 'theme-preview-card', style: { background: theme.colors.card, borderColor: theme.colors.border } },
                                    h('div', { className: 'theme-preview-text', style: { background: theme.colors.text } }),
                                    h('div', { className: 'theme-preview-text-secondary', style: { background: theme.colors.textSecondary } })
                                )
                            ),
                            h('div', { className: 'theme-info' },
                                h('span', { className: 'theme-icon' }, theme.icon),
                                h('span', { className: 'theme-name' }, theme.name),
                                activeThemeId === theme.id && h('span', { className: 'theme-active-badge' }, '✓')
                            ),
                            !theme.isSystem && h('div', { className: 'theme-actions' },
                                h('button', { 
                                    className: 'btn btn-sm btn-ghost',
                                    onClick: (e) => { e.stopPropagation(); startEdit(theme); }
                                }, '✏️'),
                                h('button', { 
                                    className: 'btn btn-sm btn-ghost',
                                    onClick: (e) => { e.stopPropagation(); deleteTheme(theme.id); }
                                }, '🗑️')
                            )
                        ))
                    )
                ),

                // Éditeur de thème
                h('div', { className: 'theme-editor' },
                    h('h4', null, editingTheme ? `Modifier "${editingTheme.name}"` : 'Créer un nouveau thème'),
                    h('div', { className: 'theme-editor-form' },
                        h('div', { className: 'form-row' },
                            h('div', { className: 'form-group' },
                                h('label', null, 'Nom du thème'),
                                h('input', {
                                    type: 'text',
                                    className: 'form-control',
                                    value: newTheme.name,
                                    onChange: e => setNewTheme({ ...newTheme, name: e.target.value }),
                                    placeholder: 'Mon thème personnalisé'
                                })
                            ),
                            h('div', { className: 'form-group' },
                                h('label', null, 'Icône'),
                                h('select', {
                                    className: 'form-control',
                                    value: newTheme.icon,
                                    onChange: e => setNewTheme({ ...newTheme, icon: e.target.value })
                                },
                                    ['🎨', '🌈', '💼', '🏢', '🌿', '🌊', '🔥', '💜', '🖤', '❤️'].map(icon =>
                                        h('option', { key: icon, value: icon }, icon)
                                    )
                                )
                            )
                        ),
                        h('div', { className: 'color-grid' },
                            Object.entries(colorLabels).map(([key, label]) => h('div', {
                                key,
                                className: 'color-input-group'
                            },
                                h('label', null, label),
                                h('div', { className: 'color-input-wrapper' },
                                    h('input', {
                                        type: 'color',
                                        value: newTheme.colors[key],
                                        onChange: e => setNewTheme({
                                            ...newTheme,
                                            colors: { ...newTheme.colors, [key]: e.target.value }
                                        })
                                    }),
                                    h('input', {
                                        type: 'text',
                                        className: 'form-control',
                                        value: newTheme.colors[key],
                                        onChange: e => setNewTheme({
                                            ...newTheme,
                                            colors: { ...newTheme.colors, [key]: e.target.value }
                                        })
                                    })
                                )
                            ))
                        ),
                        h('div', { className: 'theme-editor-actions' },
                            editingTheme && h('button', {
                                className: 'btn btn-ghost',
                                onClick: () => { setEditingTheme(null); setNewTheme({ name: '', icon: '🎨', colors: { ...ThemeCustomizer.defaultThemes[0].colors } }); }
                            }, 'Annuler'),
                            h('button', {
                                className: 'btn btn-primary',
                                onClick: handleSave,
                                disabled: !newTheme.name
                            }, editingTheme ? 'Mettre à jour' : 'Créer le thème')
                        )
                    )
                )
            )
        )
    );
};


// ============================================================================
// 2. WIDGETS CONFIGURABLES
// ============================================================================

const WidgetSystem = {
    STORAGE_KEY: 'stockapp-dashboard-widgets',
    CUSTOM_KEY: 'stockapp-custom-widgets',

    availableWidgets: [
        { id: 'kpi-stock', name: 'KPI Stock', icon: '📦', category: 'kpi', defaultSize: { w: 3, h: 2 }, description: 'Total des pièces en stock' },
        { id: 'kpi-tasks', name: 'KPI Tâches', icon: '📋', category: 'kpi', defaultSize: { w: 3, h: 2 }, description: 'Tâches en cours' },
        { id: 'kpi-orders', name: 'KPI Commandes', icon: '🛒', category: 'kpi', defaultSize: { w: 3, h: 2 }, description: 'Commandes en attente' },
        { id: 'kpi-team', name: 'KPI Équipe', icon: '👥', category: 'kpi', defaultSize: { w: 3, h: 2 }, description: 'Membres de l\'équipe' },
        { id: 'chart-stock-movements', name: 'Mouvements stock', icon: '📈', category: 'chart', defaultSize: { w: 6, h: 4 }, description: 'Graphique des mouvements' },
        { id: 'chart-tasks-status', name: 'Statuts tâches', icon: '📊', category: 'chart', defaultSize: { w: 4, h: 4 }, description: 'Répartition des statuts' },
        { id: 'chart-tasks-trend', name: 'Tendance tâches', icon: '📉', category: 'chart', defaultSize: { w: 6, h: 4 }, description: 'Évolution dans le temps' },
        { id: 'list-low-stock', name: 'Alertes stock bas', icon: '⚠️', category: 'list', defaultSize: { w: 4, h: 4 }, description: 'Pièces en rupture' },
        { id: 'list-recent-tasks', name: 'Tâches récentes', icon: '🕐', category: 'list', defaultSize: { w: 4, h: 4 }, description: 'Dernières tâches' },
        { id: 'list-upcoming-events', name: 'Événements à venir', icon: '📅', category: 'list', defaultSize: { w: 4, h: 4 }, description: 'Prochains événements' },
        { id: 'list-pending-orders', name: 'Commandes en attente', icon: '📦', category: 'list', defaultSize: { w: 4, h: 3 }, description: 'Commandes à traiter' },
        { id: 'map-interventions', name: 'Carte interventions', icon: '🗺️', category: 'special', defaultSize: { w: 6, h: 5 }, description: 'Localisation des interventions' },
        { id: 'ai-predictions', name: 'Prédictions IA', icon: '🤖', category: 'special', defaultSize: { w: 6, h: 4 }, description: 'Suggestions intelligentes' },
        { id: 'quick-actions', name: 'Actions rapides', icon: '⚡', category: 'utility', defaultSize: { w: 3, h: 3 }, description: 'Raccourcis' },
        { id: 'weather', name: 'Météo', icon: '🌤️', category: 'utility', defaultSize: { w: 2, h: 2 }, description: 'Prévisions météo' },
        { id: 'clock', name: 'Horloge', icon: '🕐', category: 'utility', defaultSize: { w: 2, h: 2 }, description: 'Heure actuelle' },
        { id: 'notes', name: 'Notes personnelles', icon: '📝', category: 'utility', defaultSize: { w: 4, h: 3 }, description: 'Bloc-notes' },
        { id: 'team-presence', name: 'Présence équipe', icon: '🟢', category: 'team', defaultSize: { w: 3, h: 4 }, description: 'Qui est en ligne' },
        { id: 'vehicle-status', name: 'État véhicules', icon: '🚗', category: 'fleet', defaultSize: { w: 4, h: 3 }, description: 'Statut de la flotte' }
    ],

    defaultLayout: [],

    getLayout() {
        try {
            return JSON.parse(localStorage.getItem(this.STORAGE_KEY)) || [];
        } catch {
            return [];
        }
    },

    saveLayout(layout) {
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(layout));
        console.log('[WidgetSystem] Layout sauvegardé:', layout);
    },

    resetLayout() {
        localStorage.removeItem(this.STORAGE_KEY);
        return [];
    }
};

/**
 * Hook pour les widgets configurables
 */
const useConfigurableWidgets = () => {
    const [layout, setLayout] = useState(WidgetSystem.getLayout());
    const [editMode, setEditMode] = useState(false);
    const [draggedWidget, setDraggedWidget] = useState(null);

    const addWidget = (widgetId) => {
        const widget = WidgetSystem.availableWidgets.find(w => w.id === widgetId);
        if (!widget || layout.find(l => l.id === widgetId)) return;

        const newWidget = {
            id: widgetId,
            x: 0,
            y: Math.max(0, ...layout.map(l => l.y + l.h)),
            w: widget.defaultSize.w,
            h: widget.defaultSize.h
        };
        const newLayout = [...layout, newWidget];
        setLayout(newLayout);
        WidgetSystem.saveLayout(newLayout);
    };

    const removeWidget = (widgetId) => {
        const newLayout = layout.filter(l => l.id !== widgetId);
        setLayout(newLayout);
        WidgetSystem.saveLayout(newLayout);
    };

    const updateWidget = (widgetId, updates) => {
        const newLayout = layout.map(l => l.id === widgetId ? { ...l, ...updates } : l);
        setLayout(newLayout);
        WidgetSystem.saveLayout(newLayout);
    };

    const resetLayout = () => {
        const newLayout = WidgetSystem.resetLayout();
        setLayout(newLayout);
    };

    const availableWidgets = WidgetSystem.availableWidgets.filter(w => !layout.find(l => l.id === w.id));

    return {
        layout,
        editMode,
        setEditMode,
        addWidget,
        removeWidget,
        updateWidget,
        resetLayout,
        availableWidgets,
        allWidgets: WidgetSystem.availableWidgets,
        draggedWidget,
        setDraggedWidget
    };
};

/**
 * Composant Widget configurable
 */
const ConfigurableWidget = ({ widget, layoutItem, editMode, onRemove, onUpdate, data, children }) => {
    const [isResizing, setIsResizing] = useState(false);

    const widgetInfo = WidgetSystem.availableWidgets.find(w => w.id === widget) || {};

    return h('div', {
        className: `dashboard-widget ${editMode ? 'edit-mode' : ''}`,
        style: {
            gridColumn: `span ${layoutItem.w}`,
            gridRow: `span ${layoutItem.h}`
        }
    },
        h('div', { className: 'widget-header' },
            h('span', { className: 'widget-icon' }, widgetInfo.icon),
            h('span', { className: 'widget-title' }, widgetInfo.name),
            editMode && h('div', { className: 'widget-edit-controls' },
                h('button', { 
                    className: 'btn btn-sm btn-ghost',
                    onClick: () => onUpdate(widget, { w: Math.max(2, layoutItem.w - 1) })
                }, '◀'),
                h('button', { 
                    className: 'btn btn-sm btn-ghost',
                    onClick: () => onUpdate(widget, { w: Math.min(12, layoutItem.w + 1) })
                }, '▶'),
                h('button', { 
                    className: 'btn btn-sm btn-ghost',
                    onClick: () => onUpdate(widget, { h: Math.max(2, layoutItem.h - 1) })
                }, '▲'),
                h('button', { 
                    className: 'btn btn-sm btn-ghost',
                    onClick: () => onUpdate(widget, { h: Math.min(8, layoutItem.h + 1) })
                }, '▼'),
                h('button', { 
                    className: 'btn btn-sm btn-danger',
                    onClick: () => onRemove(widget)
                }, '✕')
            )
        ),
        h('div', { className: 'widget-content' }, children)
    );
};

/**
 * Sélecteur de widgets
 */
const V55WidgetPicker = ({ isOpen, onClose, availableWidgets, onAdd }) => {
    const [filter, setFilter] = useState('all');

    if (!isOpen) return null;

    const categories = {
        all: 'Tous',
        kpi: 'KPIs',
        chart: 'Graphiques',
        list: 'Listes',
        special: 'Spéciaux',
        utility: 'Utilitaires',
        team: 'Équipe',
        fleet: 'Flotte'
    };

    const filtered = filter === 'all' 
        ? availableWidgets 
        : availableWidgets.filter(w => w.category === filter);

    return h('div', { className: 'modal-overlay', onClick: onClose },
        h('div', { className: 'modal widget-picker-modal', onClick: e => e.stopPropagation() },
            h('div', { className: 'modal-header' },
                h('h2', null, '➕ Ajouter un widget'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'modal-body' },
                h('div', { className: 'widget-picker-filters' },
                    Object.entries(categories).map(([key, label]) => h('button', {
                        key,
                        className: `btn btn-sm ${filter === key ? 'btn-primary' : 'btn-ghost'}`,
                        onClick: () => setFilter(key)
                    }, label))
                ),
                h('div', { className: 'widget-picker-grid' },
                    filtered.length === 0 
                        ? h('p', { className: 'widget-picker-empty' }, 'Tous les widgets de cette catégorie sont déjà ajoutés')
                        : filtered.map(widget => h('div', {
                            key: widget.id,
                            className: 'widget-picker-item',
                            onClick: () => { onAdd(widget.id); onClose(); }
                        },
                            h('span', { className: 'widget-picker-icon' }, widget.icon),
                            h('span', { className: 'widget-picker-name' }, widget.name),
                            h('span', { className: 'widget-picker-size' }, `${widget.defaultSize.w}×${widget.defaultSize.h}`)
                        ))
                )
            )
        )
    );
};


// ============================================================================
// 3. VUES SAUVEGARDÉES
// ============================================================================

const SavedViewsSystem = {
    STORAGE_KEY: 'stockapp-saved-views',

    getViews(pageId) {
        try {
            const all = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '{}');
            return all[pageId] || [];
        } catch {
            return [];
        }
    },

    saveView(pageId, view) {
        const all = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '{}');
        if (!all[pageId]) all[pageId] = [];
        
        const existingIndex = all[pageId].findIndex(v => v.id === view.id);
        if (existingIndex >= 0) {
            all[pageId][existingIndex] = view;
        } else {
            all[pageId].push({ ...view, id: `view_${Date.now()}` });
        }
        
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(all));
        return all[pageId];
    },

    deleteView(pageId, viewId) {
        const all = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '{}');
        if (all[pageId]) {
            all[pageId] = all[pageId].filter(v => v.id !== viewId);
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(all));
        }
        return all[pageId] || [];
    },

    getActiveView(pageId) {
        return localStorage.getItem(`stockapp-active-view-${pageId}`);
    },

    setActiveView(pageId, viewId) {
        if (viewId) {
            localStorage.setItem(`stockapp-active-view-${pageId}`, viewId);
        } else {
            localStorage.removeItem(`stockapp-active-view-${pageId}`);
        }
    }
};

/**
 * Hook pour les vues sauvegardées
 */
const useSavedViews = (pageId) => {
    const [views, setViews] = useState(SavedViewsSystem.getViews(pageId));
    const [activeViewId, setActiveViewId] = useState(SavedViewsSystem.getActiveView(pageId));

    const saveView = (name, config) => {
        const view = {
            id: `view_${Date.now()}`,
            name,
            config,
            createdAt: new Date().toISOString()
        };
        const updated = SavedViewsSystem.saveView(pageId, view);
        setViews(updated);
        return view;
    };

    const updateView = (viewId, updates) => {
        const view = views.find(v => v.id === viewId);
        if (view) {
            const updated = SavedViewsSystem.saveView(pageId, { ...view, ...updates });
            setViews(updated);
        }
    };

    const deleteView = (viewId) => {
        const updated = SavedViewsSystem.deleteView(pageId, viewId);
        setViews(updated);
        if (activeViewId === viewId) {
            setActiveViewId(null);
            SavedViewsSystem.setActiveView(pageId, null);
        }
    };

    const applyView = (viewId) => {
        setActiveViewId(viewId);
        SavedViewsSystem.setActiveView(pageId, viewId);
        return views.find(v => v.id === viewId)?.config;
    };

    const clearActiveView = () => {
        setActiveViewId(null);
        SavedViewsSystem.setActiveView(pageId, null);
    };

    const activeView = views.find(v => v.id === activeViewId);

    return { views, activeView, activeViewId, saveView, updateView, deleteView, applyView, clearActiveView };
};

/**
 * Composant de gestion des vues
 */
const SavedViewsBar = ({ pageId, currentConfig, onApplyView }) => {
    const { views, activeViewId, saveView, deleteView, applyView, clearActiveView } = useSavedViews(pageId);
    const [showSaveModal, setShowSaveModal] = useState(false);
    const [newViewName, setNewViewName] = useState('');

    const handleSave = () => {
        if (!newViewName.trim()) return;
        saveView(newViewName, currentConfig);
        setNewViewName('');
        setShowSaveModal(false);
    };

    const handleApply = (viewId) => {
        const config = applyView(viewId);
        if (config && onApplyView) {
            onApplyView(config);
        }
    };

    return h('div', { className: 'saved-views-bar' },
        h('div', { className: 'saved-views-list' },
            h('button', {
                className: `btn btn-sm ${!activeViewId ? 'btn-primary' : 'btn-ghost'}`,
                onClick: clearActiveView
            }, '📋 Par défaut'),
            views.map(view => h('button', {
                key: view.id,
                className: `btn btn-sm ${activeViewId === view.id ? 'btn-primary' : 'btn-ghost'}`,
                onClick: () => handleApply(view.id)
            },
                h('span', null, view.name),
                h('span', { 
                    className: 'view-delete',
                    onClick: (e) => { e.stopPropagation(); deleteView(view.id); }
                }, '×')
            ))
        ),
        h('button', {
            className: 'btn btn-sm btn-secondary',
            onClick: () => setShowSaveModal(true)
        }, '💾 Sauvegarder la vue'),

        showSaveModal && h('div', { className: 'modal-overlay', onClick: () => setShowSaveModal(false) },
            h('div', { className: 'modal modal-sm', onClick: e => e.stopPropagation() },
                h('div', { className: 'modal-header' },
                    h('h3', null, 'Sauvegarder la vue'),
                    h('button', { className: 'btn btn-ghost', onClick: () => setShowSaveModal(false) }, '✕')
                ),
                h('div', { className: 'modal-body' },
                    h('div', { className: 'form-group' },
                        h('label', null, 'Nom de la vue'),
                        h('input', {
                            type: 'text',
                            className: 'form-control',
                            value: newViewName,
                            onChange: e => setNewViewName(e.target.value),
                            placeholder: 'Ma vue personnalisée',
                            autoFocus: true
                        })
                    )
                ),
                h('div', { className: 'modal-footer' },
                    h('button', { className: 'btn btn-ghost', onClick: () => setShowSaveModal(false) }, 'Annuler'),
                    h('button', { 
                        className: 'btn btn-primary',
                        onClick: handleSave,
                        disabled: !newViewName.trim()
                    }, 'Sauvegarder')
                )
            )
        )
    );
};

// ============================================================================
// 4. RÔLES PERSONNALISÉS
// ============================================================================

const RolesSystem = {
    STORAGE_KEY: 'stockapp-custom-roles',

    defaultRoles: [
        {
            id: 'admin',
            name: 'Administrateur',
            icon: '👑',
            isSystem: true,
            permissions: {
                stock_read: true, stock_write: true, stock_delete: true,
                tasks_read: true, tasks_write: true, tasks_delete: true,
                orders_read: true, orders_write: true, orders_delete: true,
                planning_read: true, planning_write: true, planning_delete: true,
                users_read: true, users_write: true, users_delete: true,
                settings_read: true, settings_write: true,
                reports_read: true, reports_export: true,
                vehicles_read: true, vehicles_write: true,
                ai_access: true
            }
        },
        {
            id: 'technicien',
            name: 'Technicien',
            icon: '🔧',
            isSystem: true,
            permissions: {
                stock_read: true, stock_write: true, stock_delete: false,
                tasks_read: true, tasks_write: true, tasks_delete: false,
                orders_read: true, orders_write: true, orders_delete: false,
                planning_read: true, planning_write: false, planning_delete: false,
                users_read: true, users_write: false, users_delete: false,
                settings_read: false, settings_write: false,
                reports_read: true, reports_export: true,
                vehicles_read: true, vehicles_write: true,
                ai_access: false
            }
        },
        {
            id: 'gestionnaire',
            name: 'Gestionnaire',
            icon: '📊',
            isSystem: true,
            permissions: {
                stock_read: true, stock_write: true, stock_delete: true,
                tasks_read: true, tasks_write: true, tasks_delete: false,
                orders_read: true, orders_write: true, orders_delete: true,
                planning_read: true, planning_write: true, planning_delete: false,
                users_read: true, users_write: false, users_delete: false,
                settings_read: true, settings_write: false,
                reports_read: true, reports_export: true,
                vehicles_read: true, vehicles_write: true,
                ai_access: true
            }
        },
        {
            id: 'lecture_seule',
            name: 'Lecture seule',
            icon: '👁️',
            isSystem: true,
            permissions: {
                stock_read: true, stock_write: false, stock_delete: false,
                tasks_read: true, tasks_write: false, tasks_delete: false,
                orders_read: true, orders_write: false, orders_delete: false,
                planning_read: true, planning_write: false, planning_delete: false,
                users_read: false, users_write: false, users_delete: false,
                settings_read: false, settings_write: false,
                reports_read: true, reports_export: false,
                vehicles_read: true, vehicles_write: false,
                ai_access: false
            }
        }
    ],

    permissionLabels: {
        stock_read: 'Voir le stock',
        stock_write: 'Modifier le stock',
        stock_delete: 'Supprimer du stock',
        tasks_read: 'Voir les tâches',
        tasks_write: 'Modifier les tâches',
        tasks_delete: 'Supprimer les tâches',
        orders_read: 'Voir les commandes',
        orders_write: 'Modifier les commandes',
        orders_delete: 'Supprimer les commandes',
        planning_read: 'Voir le planning',
        planning_write: 'Modifier le planning',
        planning_delete: 'Supprimer du planning',
        users_read: 'Voir les utilisateurs',
        users_write: 'Modifier les utilisateurs',
        users_delete: 'Supprimer les utilisateurs',
        settings_read: 'Voir les paramètres',
        settings_write: 'Modifier les paramètres',
        reports_read: 'Voir les rapports',
        reports_export: 'Exporter les rapports',
        vehicles_read: 'Voir les véhicules',
        vehicles_write: 'Modifier les véhicules',
        ai_access: 'Accès IA prédictive'
    },

    permissionCategories: {
        'Stock': ['stock_read', 'stock_write', 'stock_delete'],
        'Tâches': ['tasks_read', 'tasks_write', 'tasks_delete'],
        'Commandes': ['orders_read', 'orders_write', 'orders_delete'],
        'Planning': ['planning_read', 'planning_write', 'planning_delete'],
        'Utilisateurs': ['users_read', 'users_write', 'users_delete'],
        'Paramètres': ['settings_read', 'settings_write'],
        'Rapports': ['reports_read', 'reports_export'],
        'Véhicules': ['vehicles_read', 'vehicles_write'],
        'IA': ['ai_access']
    },

    getCustomRoles() {
        // Fallback localStorage si pas de cache async
        try {
            return JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
        } catch {
            return [];
        }
    },

    async getCustomRolesAsync() {
        // Essayer Supabase d'abord
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const { data, error } = await db.from('custom_roles')
                    .select('*')
                    .eq('is_system', false)
                    .order('name');
                if (!error && data) {
                    // Mapper les données Supabase vers le format local
                    const mapped = data.map(r => ({
                        id: r.id,
                        name: r.name,
                        icon: r.icon,
                        isSystem: false,
                        permissions: r.permissions || {}
                    }));
                    // Mettre en cache localStorage
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(mapped));
                    return mapped;
                }
            } catch (e) { console.log('Fallback to localStorage for roles'); }
        }
        return this.getCustomRoles();
    },

    getAllRoles() {
        return [...this.defaultRoles, ...this.getCustomRoles()];
    },

    async getAllRolesAsync() {
        const customs = await this.getCustomRolesAsync();
        return [...this.defaultRoles, ...customs];
    },

    async saveRole(role) {
        // Essayer Supabase d'abord
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const roleData = {
                    name: role.name,
                    icon: role.icon || '👤',
                    permissions: role.permissions,
                    is_system: false
                };
                
                if (role.id && !role.id.startsWith('role_')) {
                    // Update existing
                    const { data, error } = await db.from('custom_roles')
                        .update(roleData)
                        .eq('id', role.id)
                        .eq('is_system', false)
                        .select()
                        .single();
                    if (!error && data) {
                        await this.getCustomRolesAsync(); // Refresh cache
                        return this.getAllRoles();
                    }
                } else {
                    // Insert new
                    const { data, error } = await db.from('custom_roles')
                        .insert([roleData])
                        .select()
                        .single();
                    if (!error && data) {
                        await this.getCustomRolesAsync(); // Refresh cache
                        return this.getAllRoles();
                    }
                }
            } catch (e) { console.log('Fallback to localStorage for saveRole'); }
        }
        
        // Fallback localStorage
        const customs = this.getCustomRoles();
        const existingIndex = customs.findIndex(r => r.id === role.id);
        if (existingIndex >= 0) {
            customs[existingIndex] = role;
        } else {
            customs.push({ ...role, id: `role_${Date.now()}`, isSystem: false });
        }
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(customs));
        return this.getAllRoles();
    },

    async deleteRole(roleId) {
        // Essayer Supabase d'abord
        if (typeof db !== 'undefined' && db !== null && !roleId.startsWith('role_')) {
            try {
                const { error } = await db.from('custom_roles')
                    .delete()
                    .eq('id', roleId)
                    .eq('is_system', false);
                if (!error) {
                    await this.getCustomRolesAsync(); // Refresh cache
                    return this.getAllRoles();
                }
            } catch (e) { console.log('Fallback to localStorage for deleteRole'); }
        }
        
        // Fallback localStorage
        const customs = this.getCustomRoles().filter(r => r.id !== roleId);
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(customs));
        return this.getAllRoles();
    },

    getRole(roleId) {
        return this.getAllRoles().find(r => r.id === roleId);
    },

    hasPermission(roleId, permission) {
        const role = this.getRole(roleId);
        return role?.permissions?.[permission] === true;
    }
};

/**
 * Hook pour les rôles personnalisés
 */
const useCustomRoles = () => {
    const [roles, setRoles] = useState(RolesSystem.getAllRoles());

    const saveRole = (role) => {
        const updated = RolesSystem.saveRole(role);
        setRoles(updated);
    };

    const deleteRole = (roleId) => {
        const updated = RolesSystem.deleteRole(roleId);
        setRoles(updated);
    };

    const hasPermission = (roleId, permission) => {
        return RolesSystem.hasPermission(roleId, permission);
    };

    return { roles, saveRole, deleteRole, hasPermission, permissionLabels: RolesSystem.permissionLabels, permissionCategories: RolesSystem.permissionCategories };
};

/**
 * Modal de gestion des rôles
 */
const RolesManagerModal = ({ isOpen, onClose }) => {
    const { roles, saveRole, deleteRole, permissionLabels, permissionCategories } = useCustomRoles();
    const [editingRole, setEditingRole] = useState(null);
    const [newRole, setNewRole] = useState({
        name: '',
        icon: '👤',
        permissions: {}
    });

    const handleSave = () => {
        if (!newRole.name) return;
        saveRole(editingRole ? { ...editingRole, ...newRole } : newRole);
        setNewRole({ name: '', icon: '👤', permissions: {} });
        setEditingRole(null);
    };

    const startEdit = (role) => {
        if (role.isSystem) return;
        setEditingRole(role);
        setNewRole({ name: role.name, icon: role.icon, permissions: { ...role.permissions } });
    };

    const duplicateRole = (role) => {
        setEditingRole(null);
        setNewRole({ 
            name: `${role.name} (copie)`, 
            icon: role.icon, 
            permissions: { ...role.permissions } 
        });
    };

    const togglePermission = (perm) => {
        setNewRole({
            ...newRole,
            permissions: {
                ...newRole.permissions,
                [perm]: !newRole.permissions[perm]
            }
        });
    };

    const toggleCategory = (category) => {
        const perms = permissionCategories[category];
        const allEnabled = perms.every(p => newRole.permissions[p]);
        const newPerms = { ...newRole.permissions };
        perms.forEach(p => newPerms[p] = !allEnabled);
        setNewRole({ ...newRole, permissions: newPerms });
    };

    if (!isOpen) return null;

    return h('div', { className: 'modal-overlay', onClick: onClose },
        h('div', { className: 'modal modal-xl roles-modal', onClick: e => e.stopPropagation() },
            h('div', { className: 'modal-header' },
                h('h2', null, '🔐 Gestion des rôles'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'modal-body roles-modal-body' },
                // Liste des rôles
                h('div', { className: 'roles-list' },
                    h('h4', null, 'Rôles existants'),
                    roles.map(role => h('div', {
                        key: role.id,
                        className: `role-card ${role.isSystem ? 'system' : ''} ${editingRole?.id === role.id ? 'editing' : ''}`,
                        onClick: () => !role.isSystem && startEdit(role)
                    },
                        h('div', { className: 'role-header' },
                            h('span', { className: 'role-icon' }, role.icon),
                            h('span', { className: 'role-name' }, role.name),
                            role.isSystem && h('span', { className: 'role-system-badge' }, 'Système')
                        ),
                        h('div', { className: 'role-permissions-count' },
                            Object.values(role.permissions).filter(Boolean).length, ' permissions'
                        ),
                        h('div', { className: 'role-actions' },
                            h('button', {
                                className: 'btn btn-sm btn-ghost',
                                onClick: (e) => { e.stopPropagation(); duplicateRole(role); }
                            }, '📋'),
                            !role.isSystem && h('button', {
                                className: 'btn btn-sm btn-ghost',
                                onClick: (e) => { e.stopPropagation(); deleteRole(role.id); }
                            }, '🗑️')
                        )
                    ))
                ),

                // Éditeur de rôle
                h('div', { className: 'role-editor' },
                    h('h4', null, editingRole ? `Modifier "${editingRole.name}"` : 'Créer un nouveau rôle'),
                    h('div', { className: 'role-editor-form' },
                        h('div', { className: 'form-row' },
                            h('div', { className: 'form-group' },
                                h('label', null, 'Nom du rôle'),
                                h('input', {
                                    type: 'text',
                                    className: 'form-control',
                                    value: newRole.name,
                                    onChange: e => setNewRole({ ...newRole, name: e.target.value }),
                                    placeholder: 'Responsable technique'
                                })
                            ),
                            h('div', { className: 'form-group' },
                                h('label', null, 'Icône'),
                                h('select', {
                                    className: 'form-control',
                                    value: newRole.icon,
                                    onChange: e => setNewRole({ ...newRole, icon: e.target.value })
                                },
                                    ['👤', '👑', '🔧', '📊', '👁️', '🛡️', '⚙️', '📋', '🚗', '🏢'].map(icon =>
                                        h('option', { key: icon, value: icon }, icon)
                                    )
                                )
                            )
                        ),

                        h('div', { className: 'permissions-grid' },
                            Object.entries(permissionCategories).map(([category, perms]) => h('div', {
                                key: category,
                                className: 'permission-category'
                            },
                                h('div', { 
                                    className: 'permission-category-header',
                                    onClick: () => toggleCategory(category)
                                },
                                    h('span', null, category),
                                    h('span', { className: 'permission-category-count' },
                                        `${perms.filter(p => newRole.permissions[p]).length}/${perms.length}`
                                    )
                                ),
                                h('div', { className: 'permission-list' },
                                    perms.map(perm => h('label', {
                                        key: perm,
                                        className: 'permission-item'
                                    },
                                        h('input', {
                                            type: 'checkbox',
                                            checked: !!newRole.permissions[perm],
                                            onChange: () => togglePermission(perm)
                                        }),
                                        h('span', null, permissionLabels[perm])
                                    ))
                                )
                            ))
                        ),

                        h('div', { className: 'role-editor-actions' },
                            editingRole && h('button', {
                                className: 'btn btn-ghost',
                                onClick: () => { setEditingRole(null); setNewRole({ name: '', icon: '👤', permissions: {} }); }
                            }, 'Annuler'),
                            h('button', {
                                className: 'btn btn-primary',
                                onClick: handleSave,
                                disabled: !newRole.name
                            }, editingRole ? 'Mettre à jour' : 'Créer le rôle')
                        )
                    )
                )
            )
        )
    );
};


// ============================================================================
// 5. RACCOURCIS PERSONNALISÉS
// ============================================================================

const ShortcutsSystem = {
    STORAGE_KEY: 'stockapp-custom-shortcuts',

    defaultShortcuts: [
        { id: 'search', keys: ['Ctrl', 'K'], action: 'openSearch', label: 'Recherche globale', category: 'navigation' },
        { id: 'new-task', keys: ['Ctrl', 'N'], action: 'newTask', label: 'Nouvelle tâche', category: 'creation' },
        { id: 'new-order', keys: ['Ctrl', 'Shift', 'N'], action: 'newOrder', label: 'Nouvelle commande', category: 'creation' },
        { id: 'dashboard', keys: ['G', 'D'], action: 'gotoDashboard', label: 'Aller au dashboard', category: 'navigation' },
        { id: 'stock', keys: ['G', 'S'], action: 'gotoStock', label: 'Aller au stock', category: 'navigation' },
        { id: 'tasks', keys: ['G', 'T'], action: 'gotoTasks', label: 'Aller aux tâches', category: 'navigation' },
        { id: 'planning', keys: ['G', 'P'], action: 'gotoPlanning', label: 'Aller au planning', category: 'navigation' },
        { id: 'help', keys: ['?'], action: 'showHelp', label: 'Afficher l\'aide', category: 'utility' },
        { id: 'theme', keys: ['Ctrl', 'Shift', 'T'], action: 'toggleTheme', label: 'Changer de thème', category: 'utility' },
        { id: 'refresh', keys: ['Ctrl', 'R'], action: 'refresh', label: 'Actualiser', category: 'utility' },
        { id: 'escape', keys: ['Escape'], action: 'closeModal', label: 'Fermer', category: 'utility' }
    ],

    availableActions: [
        { id: 'openSearch', label: 'Ouvrir la recherche', category: 'navigation' },
        { id: 'newTask', label: 'Nouvelle tâche', category: 'creation' },
        { id: 'newOrder', label: 'Nouvelle commande', category: 'creation' },
        { id: 'newPart', label: 'Nouvelle pièce', category: 'creation' },
        { id: 'gotoDashboard', label: 'Aller au dashboard', category: 'navigation' },
        { id: 'gotoStock', label: 'Aller au stock', category: 'navigation' },
        { id: 'gotoTasks', label: 'Aller aux tâches', category: 'navigation' },
        { id: 'gotoOrders', label: 'Aller aux commandes', category: 'navigation' },
        { id: 'gotoPlanning', label: 'Aller au planning', category: 'navigation' },
        { id: 'gotoMap', label: 'Aller à la carte', category: 'navigation' },
        { id: 'gotoAI', label: 'Aller à l\'IA', category: 'navigation' },
        { id: 'showHelp', label: 'Afficher l\'aide', category: 'utility' },
        { id: 'toggleTheme', label: 'Changer de thème', category: 'utility' },
        { id: 'toggleSidebar', label: 'Basculer la sidebar', category: 'utility' },
        { id: 'refresh', label: 'Actualiser les données', category: 'utility' },
        { id: 'closeModal', label: 'Fermer la modale', category: 'utility' },
        { id: 'startPresentation', label: 'Mode présentation', category: 'utility' },
        { id: 'exportPDF', label: 'Exporter en PDF', category: 'export' },
        { id: 'exportExcel', label: 'Exporter en Excel', category: 'export' }
    ],

    getCustomShortcuts() {
        try {
            return JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
        } catch {
            return [];
        }
    },

    getAllShortcuts() {
        const customs = this.getCustomShortcuts();
        // Merge: customs override defaults
        return this.defaultShortcuts.map(def => {
            const custom = customs.find(c => c.id === def.id);
            return custom || def;
        }).concat(customs.filter(c => !this.defaultShortcuts.find(d => d.id === c.id)));
    },

    saveShortcut(shortcut) {
        const customs = this.getCustomShortcuts();
        const existingIndex = customs.findIndex(s => s.id === shortcut.id);
        if (existingIndex >= 0) {
            customs[existingIndex] = shortcut;
        } else {
            customs.push({ ...shortcut, id: shortcut.id || `shortcut_${Date.now()}` });
        }
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(customs));
        return this.getAllShortcuts();
    },

    deleteShortcut(shortcutId) {
        const customs = this.getCustomShortcuts().filter(s => s.id !== shortcutId);
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(customs));
        return this.getAllShortcuts();
    },

    resetToDefaults() {
        localStorage.removeItem(this.STORAGE_KEY);
        return this.defaultShortcuts;
    },

    formatKeys(keys) {
        return keys.map(k => {
            if (k === 'Ctrl') return '⌃';
            if (k === 'Shift') return '⇧';
            if (k === 'Alt') return '⌥';
            if (k === 'Meta' || k === 'Cmd') return '⌘';
            if (k === 'Escape') return 'Esc';
            return k;
        }).join(' + ');
    }
};

/**
 * Hook pour les raccourcis personnalisés
 */
const useCustomShortcuts = (actionHandlers = {}) => {
    const [shortcuts, setShortcuts] = useState(ShortcutsSystem.getAllShortcuts());
    const [recording, setRecording] = useState(null);
    const recordedKeys = useRef([]);

    // Gestionnaire de raccourcis
    useEffect(() => {
        const handleKeyDown = (e) => {
            // Mode enregistrement
            if (recording) {
                e.preventDefault();
                const key = e.key === ' ' ? 'Space' : e.key;
                const modifiers = [];
                if (e.ctrlKey) modifiers.push('Ctrl');
                if (e.shiftKey) modifiers.push('Shift');
                if (e.altKey) modifiers.push('Alt');
                if (e.metaKey) modifiers.push('Meta');
                
                if (!['Control', 'Shift', 'Alt', 'Meta'].includes(key)) {
                    recordedKeys.current = [...modifiers, key];
                    setRecording({ ...recording, keys: recordedKeys.current });
                }
                return;
            }

            // Ignorer si dans un input
            if (e.target.matches('input, textarea, select')) return;

            // Chercher un raccourci correspondant
            const matchedShortcut = shortcuts.find(s => {
                const requiresCtrl = s.keys.includes('Ctrl');
                const requiresShift = s.keys.includes('Shift');
                const requiresAlt = s.keys.includes('Alt');
                const mainKey = s.keys.find(k => !['Ctrl', 'Shift', 'Alt', 'Meta'].includes(k));

                return (requiresCtrl === e.ctrlKey || requiresCtrl === e.metaKey) &&
                       requiresShift === e.shiftKey &&
                       requiresAlt === e.altKey &&
                       mainKey?.toLowerCase() === e.key.toLowerCase();
            });

            if (matchedShortcut && actionHandlers[matchedShortcut.action]) {
                e.preventDefault();
                actionHandlers[matchedShortcut.action]();
            }
        };

        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
    }, [shortcuts, recording, actionHandlers]);

    const saveShortcut = (shortcut) => {
        const updated = ShortcutsSystem.saveShortcut(shortcut);
        setShortcuts(updated);
    };

    const deleteShortcut = (shortcutId) => {
        const updated = ShortcutsSystem.deleteShortcut(shortcutId);
        setShortcuts(updated);
    };

    const resetToDefaults = () => {
        const updated = ShortcutsSystem.resetToDefaults();
        setShortcuts(updated);
    };

    const startRecording = (shortcut) => {
        recordedKeys.current = [];
        setRecording(shortcut);
    };

    const stopRecording = () => {
        if (recording && recordedKeys.current.length > 0) {
            saveShortcut({ ...recording, keys: recordedKeys.current });
        }
        setRecording(null);
        recordedKeys.current = [];
    };

    return { 
        shortcuts, 
        saveShortcut, 
        deleteShortcut, 
        resetToDefaults,
        recording,
        startRecording,
        stopRecording,
        availableActions: ShortcutsSystem.availableActions,
        formatKeys: ShortcutsSystem.formatKeys
    };
};

/**
 * Modal de gestion des raccourcis
 */
const ShortcutsManagerModal = ({ isOpen, onClose }) => {
    const { shortcuts, saveShortcut, deleteShortcut, resetToDefaults, recording, startRecording, stopRecording, availableActions, formatKeys } = useCustomShortcuts();
    const [filter, setFilter] = useState('all');
    const [showAddNew, setShowAddNew] = useState(false);
    const [newShortcut, setNewShortcut] = useState({ keys: [], action: '', label: '' });

    const categories = {
        all: 'Tous',
        navigation: 'Navigation',
        creation: 'Création',
        utility: 'Utilitaires',
        export: 'Export'
    };

    const filtered = filter === 'all' ? shortcuts : shortcuts.filter(s => s.category === filter);

    if (!isOpen) return null;

    return h('div', { className: 'modal-overlay', onClick: onClose },
        h('div', { className: 'modal modal-lg shortcuts-modal', onClick: e => e.stopPropagation() },
            h('div', { className: 'modal-header' },
                h('h2', null, '⌨️ Raccourcis clavier'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'modal-body' },
                // Filtres
                h('div', { className: 'shortcuts-filters' },
                    Object.entries(categories).map(([key, label]) => h('button', {
                        key,
                        className: `btn btn-sm ${filter === key ? 'btn-primary' : 'btn-ghost'}`,
                        onClick: () => setFilter(key)
                    }, label)),
                    h('div', { className: 'shortcuts-actions' },
                        h('button', { 
                            className: 'btn btn-sm btn-secondary',
                            onClick: () => setShowAddNew(true)
                        }, '+ Nouveau'),
                        h('button', { 
                            className: 'btn btn-sm btn-ghost',
                            onClick: resetToDefaults
                        }, '↺ Réinitialiser')
                    )
                ),

                // Liste des raccourcis
                h('div', { className: 'shortcuts-list' },
                    filtered.map(shortcut => h('div', {
                        key: shortcut.id,
                        className: `shortcut-item ${recording?.id === shortcut.id ? 'recording' : ''}`
                    },
                        h('div', { className: 'shortcut-info' },
                            h('span', { className: 'shortcut-label' }, shortcut.label),
                            h('span', { className: 'shortcut-action' }, shortcut.action)
                        ),
                        h('div', { className: 'shortcut-keys' },
                            recording?.id === shortcut.id
                                ? h('span', { className: 'recording-indicator' }, 
                                    recording.keys.length > 0 ? formatKeys(recording.keys) : 'Appuyez sur les touches...'
                                )
                                : h('kbd', null, formatKeys(shortcut.keys))
                        ),
                        h('div', { className: 'shortcut-item-actions' },
                            recording?.id === shortcut.id
                                ? h('button', { className: 'btn btn-sm btn-primary', onClick: stopRecording }, '✓')
                                : h('button', { 
                                    className: 'btn btn-sm btn-ghost',
                                    onClick: () => startRecording(shortcut)
                                }, '⌨️'),
                            h('button', { 
                                className: 'btn btn-sm btn-ghost',
                                onClick: () => deleteShortcut(shortcut.id)
                            }, '🗑️')
                        )
                    ))
                ),

                // Ajouter un nouveau raccourci
                showAddNew && h('div', { className: 'shortcut-add-form' },
                    h('h4', null, 'Nouveau raccourci'),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Action'),
                            h('select', {
                                className: 'form-control',
                                value: newShortcut.action,
                                onChange: e => {
                                    const action = availableActions.find(a => a.id === e.target.value);
                                    setNewShortcut({ 
                                        ...newShortcut, 
                                        action: e.target.value,
                                        label: action?.label || '',
                                        category: action?.category || 'utility'
                                    });
                                }
                            },
                                h('option', { value: '' }, 'Sélectionner une action'),
                                availableActions.map(a => h('option', { key: a.id, value: a.id }, a.label))
                            )
                        ),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Touches'),
                            h('button', { 
                                className: 'btn btn-secondary',
                                onClick: () => startRecording({ ...newShortcut, id: 'new' })
                            }, recording?.id === 'new' 
                                ? (recording.keys.length > 0 ? formatKeys(recording.keys) : 'Appuyez...')
                                : (newShortcut.keys.length > 0 ? formatKeys(newShortcut.keys) : 'Enregistrer')
                            )
                        )
                    ),
                    h('div', { className: 'form-actions' },
                        h('button', { className: 'btn btn-ghost', onClick: () => setShowAddNew(false) }, 'Annuler'),
                        h('button', { 
                            className: 'btn btn-primary',
                            disabled: !newShortcut.action || newShortcut.keys.length === 0,
                            onClick: () => {
                                saveShortcut(newShortcut);
                                setNewShortcut({ keys: [], action: '', label: '' });
                                setShowAddNew(false);
                            }
                        }, 'Ajouter')
                    )
                )
            )
        )
    );
};


// ============================================================================
// 6. APPELS VIDÉO INTÉGRÉS (WebRTC)
// ============================================================================

const VideoCallService = {
    peerConnection: null,
    localStream: null,
    remoteStream: null,
    signalingChannel: null,
    currentCallerId: null,
    currentCalleeId: null,
    onRemoteStreamCallback: null,
    onIceCandidateCallback: null,
    iceCandidatesQueue: [],

    config: {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' },
            { urls: 'stun:stun2.l.google.com:19302' },
            { urls: 'stun:stun3.l.google.com:19302' }
        ]
    },

    async startLocalStream(video = true, audio = true) {
        try {
            console.log('[VideoCall] 📹 Demande accès caméra/micro...');
            
            // Vérifier si l'API est disponible
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('API MediaDevices non disponible. Utilisez HTTPS.');
            }
            
            this.localStream = await navigator.mediaDevices.getUserMedia({ 
                video: video ? { 
                    width: { ideal: 640, max: 1280 }, 
                    height: { ideal: 480, max: 720 },
                    facingMode: 'user'
                } : false, 
                audio: audio ? {
                    echoCancellation: true,
                    noiseSuppression: true
                } : false
            });
            
            console.log('[VideoCall] ✅ Stream local obtenu:', this.localStream.getTracks().map(t => `${t.kind}:${t.enabled}`).join(', '));
            return this.localStream;
        } catch (error) {
            console.error('[VideoCall] ❌ Erreur accès caméra/micro:', error.name, error.message);
            if (error.name === 'NotAllowedError') {
                throw new Error('Accès caméra/micro refusé. Autorisez l\'accès dans les paramètres.');
            } else if (error.name === 'NotFoundError') {
                throw new Error('Aucune caméra ou micro trouvé.');
            } else if (error.name === 'NotReadableError') {
                throw new Error('Caméra/micro déjà utilisé.');
            }
            throw new Error(`Erreur caméra: ${error.message}`);
        }
    },

    stopLocalStream() {
        if (this.localStream) {
            this.localStream.getTracks().forEach(track => {
                track.stop();
                console.log('[VideoCall] Track arrêté:', track.kind);
            });
            this.localStream = null;
        }
    },

    setupPeerConnection(onRemoteStream, onIceCandidate) {
        console.log('[VideoCall] Configuration PeerConnection...');
        this.peerConnection = new RTCPeerConnection(this.config);
        this.onRemoteStreamCallback = onRemoteStream;
        this.onIceCandidateCallback = onIceCandidate;
        
        // Ajouter les pistes locales
        if (this.localStream) {
            this.localStream.getTracks().forEach(track => {
                console.log('[VideoCall] Ajout piste locale:', track.kind);
                this.peerConnection.addTrack(track, this.localStream);
            });
        }

        // Écouter les pistes distantes
        this.peerConnection.ontrack = (event) => {
            console.log('[VideoCall] Piste distante reçue:', event.track.kind);
            this.remoteStream = event.streams[0];
            if (this.onRemoteStreamCallback) {
                this.onRemoteStreamCallback(event.streams[0]);
            }
        };

        // Gestion des ICE candidates
        this.peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                console.log('[VideoCall] ICE candidate généré:', event.candidate.type);
                if (this.onIceCandidateCallback) {
                    this.onIceCandidateCallback(event.candidate);
                }
            }
        };

        // États de connexion
        this.peerConnection.onconnectionstatechange = () => {
            console.log('[VideoCall] État connexion:', this.peerConnection.connectionState);
        };

        this.peerConnection.oniceconnectionstatechange = () => {
            console.log('[VideoCall] État ICE:', this.peerConnection.iceConnectionState);
        };

        return this.peerConnection;
    },

    async createOffer(onRemoteStream, onIceCandidate) {
        this.setupPeerConnection(onRemoteStream, onIceCandidate);
        
        const offer = await this.peerConnection.createOffer();
        await this.peerConnection.setLocalDescription(offer);
        console.log('[VideoCall] Offre créée');
        
        return offer;
    },

    async handleAnswer(answer) {
        if (this.peerConnection) {
            console.log('[VideoCall] Traitement réponse...');
            await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            
            // Traiter les ICE candidates en attente
            while (this.iceCandidatesQueue.length > 0) {
                const candidate = this.iceCandidatesQueue.shift();
                await this.addIceCandidate(candidate);
            }
        }
    },

    async handleOffer(offer, onRemoteStream, onIceCandidate) {
        this.setupPeerConnection(onRemoteStream, onIceCandidate);

        console.log('[VideoCall] Traitement offre entrante...');
        await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await this.peerConnection.createAnswer();
        await this.peerConnection.setLocalDescription(answer);
        console.log('[VideoCall] Réponse créée');
        
        return answer;
    },

    async addIceCandidate(candidate) {
        if (this.peerConnection) {
            if (this.peerConnection.remoteDescription) {
                try {
                    await this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    console.log('[VideoCall] ICE candidate ajouté');
                } catch (e) {
                    console.log('[VideoCall] Erreur ajout ICE:', e);
                }
            } else {
                // Mettre en file d'attente si pas encore de description distante
                this.iceCandidatesQueue.push(candidate);
                console.log('[VideoCall] ICE candidate mis en attente');
            }
        }
    },

    endCall() {
        console.log('[VideoCall] Fin d\'appel');
        if (this.peerConnection) {
            this.peerConnection.close();
            this.peerConnection = null;
        }
        this.stopLocalStream();
        this.remoteStream = null;
        this.currentCallerId = null;
        this.currentCalleeId = null;
        this.iceCandidatesQueue = [];
    },

    toggleMute() {
        if (this.localStream) {
            const audioTrack = this.localStream.getAudioTracks()[0];
            if (audioTrack) {
                audioTrack.enabled = !audioTrack.enabled;
                console.log('[VideoCall] Micro:', audioTrack.enabled ? 'ON' : 'OFF');
                return !audioTrack.enabled;
            }
        }
        return false;
    },

    toggleVideo() {
        if (this.localStream) {
            const videoTrack = this.localStream.getVideoTracks()[0];
            if (videoTrack) {
                videoTrack.enabled = !videoTrack.enabled;
                console.log('[VideoCall] Caméra:', videoTrack.enabled ? 'ON' : 'OFF');
                return !videoTrack.enabled;
            }
        }
        return false;
    },

    // ========== SIGNALING VIA SUPABASE ==========
    
    async sendSignal(callerId, calleeId, signalType, signalData) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                // signal_data doit être un objet pour JSONB
                const payload = {
                    caller_id: callerId,
                    callee_id: calleeId,
                    signal_type: signalType,
                    signal_data: signalData, // Envoyer comme objet, pas string
                    status: 'pending'
                };
                
                console.log('[VideoCall] Envoi signal:', signalType, 'de', callerId, 'à', calleeId);
                
                const { data, error } = await db.from('video_call_signals').insert([payload]).select().single();
                
                if (error) {
                    console.error('[VideoCall] Erreur envoi signal:', error.message, error.details);
                    // Essayer sans .select() si erreur
                    if (error.message?.includes('permission') || error.code === '42501') {
                        console.log('[VideoCall] Réessai sans select...');
                        const { error: error2 } = await db.from('video_call_signals').insert([payload]);
                        if (error2) {
                            console.error('[VideoCall] Échec définitif:', error2);
                            return null;
                        }
                        return payload;
                    }
                    return null;
                }
                
                console.log('[VideoCall] Signal envoyé avec succès:', signalType);
                return data;
            } catch (e) {
                console.error('[VideoCall] Exception envoi signal:', e);
            }
        } else {
            console.warn('[VideoCall] Supabase non disponible pour signaling');
        }
        return null;
    },

    subscribeToSignals(userId, onSignal) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const channelName = 'video-signals-' + userId + '-' + Date.now();
                console.log('[VideoCall] Abonnement canal:', channelName);
                
                this.signalingChannel = db.channel(channelName)
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'video_call_signals',
                        filter: `callee_id=eq.${userId}`
                    }, (payload) => {
                        console.log('[VideoCall] Signal reçu:', payload.new?.signal_type);
                        onSignal && onSignal(payload.new);
                    })
                    .subscribe((status) => {
                        console.log('[VideoCall] Status abonnement:', status);
                    });
                
                return this.signalingChannel;
            } catch (e) {
                console.error('[VideoCall] Erreur abonnement signaux:', e);
            }
        }
        return null;
    },

    unsubscribeFromSignals() {
        if (this.signalingChannel && typeof db !== 'undefined') {
            db.removeChannel(this.signalingChannel);
            this.signalingChannel = null;
            console.log('[VideoCall] Désabonné des signaux');
        }
    },

    async getPendingSignals(userId) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const { data, error } = await db.from('video_call_signals')
                    .select('*')
                    .eq('callee_id', userId)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: true });
                
                if (!error && data) {
                    console.log('[VideoCall] Signaux en attente:', data.length);
                    return data;
                }
            } catch (e) {
                console.error('[VideoCall] Erreur chargement signaux:', e);
            }
        }
        return [];
    },

    async markSignalProcessed(signalId, status = 'processed') {
        if (typeof db !== 'undefined' && db !== null && signalId) {
            try {
                await db.from('video_call_signals')
                    .update({ status })
                    .eq('id', signalId);
                console.log('[VideoCall] Signal marqué:', status);
            } catch (e) {
                console.error('[VideoCall] Erreur mise à jour signal:', e);
            }
        }
    },
    
    // Nettoyer les vieux signaux (plus de 5 minutes)
    async cleanupOldSignals(userId) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
                await db.from('video_call_signals')
                    .delete()
                    .or(`caller_id.eq.${userId},callee_id.eq.${userId}`)
                    .lt('created_at', fiveMinutesAgo);
            } catch (e) {
                // Silencieux
            }
        }
    }
};

/**
 * Hook pour les appels vidéo avec signaling complet
 */
const useVideoCall = (currentUserId) => {
    const [isInCall, setIsInCall] = useState(false);
    const [localStream, setLocalStream] = useState(null);
    const [remoteStream, setRemoteStream] = useState(null);
    const [isMuted, setIsMuted] = useState(false);
    const [isVideoOff, setIsVideoOff] = useState(false);
    const [callStatus, setCallStatus] = useState('idle'); // idle, calling, ringing, connecting, connected
    const [error, setError] = useState(null);
    const [targetUserId, setTargetUserId] = useState(null);
    const [incomingCall, setIncomingCall] = useState(null);

    // Callback pour recevoir le stream distant
    const handleRemoteStream = useCallback((stream) => {
        console.log('[useVideoCall] Stream distant reçu');
        setRemoteStream(stream);
        setCallStatus('connected');
    }, []);

    // Callback pour envoyer les ICE candidates
    const handleIceCandidate = useCallback((candidate) => {
        if (currentUserId && targetUserId) {
            VideoCallService.sendSignal(currentUserId, targetUserId, 'ice-candidate', candidate);
        }
    }, [currentUserId, targetUserId]);

    // Gérer les signaux entrants
    const handleSignal = useCallback(async (signal) => {
        if (!signal) return;
        
        const signalData = typeof signal.signal_data === 'string' 
            ? JSON.parse(signal.signal_data) 
            : signal.signal_data;
        
        console.log('[useVideoCall] Traitement signal:', signal.signal_type);
        
        switch (signal.signal_type) {
            case 'offer':
                // Appel entrant
                console.log('[useVideoCall] Appel entrant de:', signal.caller_id);
                setIncomingCall({
                    signalId: signal.id,
                    callerId: signal.caller_id,
                    offer: signalData
                });
                setCallStatus('ringing');
                // Notification sonore ou visuelle pourrait être ajoutée ici
                window.dispatchEvent(new CustomEvent('incoming-video-call', { 
                    detail: { callerId: signal.caller_id, signalId: signal.id } 
                }));
                break;
                
            case 'answer':
                // Réponse à notre appel
                console.log('[useVideoCall] Réponse reçue');
                await VideoCallService.handleAnswer(signalData);
                setCallStatus('connected');
                await VideoCallService.markSignalProcessed(signal.id);
                break;
                
            case 'ice-candidate':
                // ICE candidate du pair distant
                await VideoCallService.addIceCandidate(signalData);
                await VideoCallService.markSignalProcessed(signal.id);
                break;
                
            case 'hang-up':
                // L'autre personne a raccroché
                console.log('[useVideoCall] Raccroché par l\'autre partie');
                endCall();
                await VideoCallService.markSignalProcessed(signal.id);
                break;
        }
    }, []);

    // S'abonner aux signaux au montage
    useEffect(() => {
        if (currentUserId) {
            console.log('[useVideoCall] Abonnement aux signaux pour:', currentUserId);
            VideoCallService.subscribeToSignals(currentUserId, handleSignal);
            VideoCallService.cleanupOldSignals(currentUserId);
            
            // Polling backup toutes les 3 secondes
            const pollInterval = setInterval(async () => {
                if (isInCall || incomingCall) return;
                const signals = await VideoCallService.getPendingSignals(currentUserId);
                for (const signal of signals) {
                    await handleSignal(signal);
                }
            }, 3000);
            
            return () => {
                VideoCallService.unsubscribeFromSignals();
                clearInterval(pollInterval);
            };
        }
    }, [currentUserId, handleSignal, isInCall, incomingCall]);

    // Démarrer un appel sortant
    const startCall = async (targetId) => {
        if (!currentUserId) {
            setError('Utilisateur non connecté');
            return;
        }
        
        try {
            setError(null);
            setTargetUserId(targetId);
            setCallStatus('calling');
            console.log('[useVideoCall] Démarrage appel vers:', targetId);
            
            // Obtenir le stream local
            const stream = await VideoCallService.startLocalStream();
            setLocalStream(stream);
            
            // Créer l'offre avec callbacks
            const offer = await VideoCallService.createOffer(handleRemoteStream, (candidate) => {
                VideoCallService.sendSignal(currentUserId, targetId, 'ice-candidate', candidate);
            });
            
            // Envoyer l'offre via Supabase
            await VideoCallService.sendSignal(currentUserId, targetId, 'offer', offer);
            
            setIsInCall(true);
            console.log('[useVideoCall] Offre envoyée, en attente de réponse...');
        } catch (err) {
            console.error('[useVideoCall] Erreur démarrage appel:', err);
            setError(err.message || 'Erreur lors du démarrage de l\'appel');
            setCallStatus('idle');
            VideoCallService.endCall();
        }
    };

    // Répondre à un appel entrant
    const answerCall = async () => {
        if (!incomingCall) {
            setError('Pas d\'appel entrant');
            return;
        }
        
        try {
            setError(null);
            const { callerId, offer, signalId } = incomingCall;
            setTargetUserId(callerId);
            setCallStatus('connecting');
            console.log('[useVideoCall] Réponse à l\'appel de:', callerId);
            
            // Obtenir le stream local
            const stream = await VideoCallService.startLocalStream();
            setLocalStream(stream);
            
            // Créer la réponse
            const answer = await VideoCallService.handleOffer(offer, handleRemoteStream, (candidate) => {
                VideoCallService.sendSignal(currentUserId, callerId, 'ice-candidate', candidate);
            });
            
            // Envoyer la réponse
            await VideoCallService.sendSignal(currentUserId, callerId, 'answer', answer);
            await VideoCallService.markSignalProcessed(signalId);
            
            setIsInCall(true);
            setIncomingCall(null);
            setCallStatus('connected');
            console.log('[useVideoCall] Réponse envoyée');
        } catch (err) {
            console.error('[useVideoCall] Erreur réponse appel:', err);
            setError(err.message || 'Erreur lors de la réponse');
            setCallStatus('idle');
            setIncomingCall(null);
            VideoCallService.endCall();
        }
    };

    // Refuser un appel entrant
    const rejectCall = async () => {
        if (incomingCall) {
            await VideoCallService.markSignalProcessed(incomingCall.signalId, 'rejected');
            setIncomingCall(null);
            setCallStatus('idle');
        }
    };

    // Terminer l'appel
    const endCall = useCallback(() => {
        console.log('[useVideoCall] Fin d\'appel');
        
        // Notifier l'autre partie
        if (currentUserId && targetUserId) {
            VideoCallService.sendSignal(currentUserId, targetUserId, 'hang-up', { reason: 'user_ended' });
        }
        
        VideoCallService.endCall();
        setIsInCall(false);
        setLocalStream(null);
        setRemoteStream(null);
        setCallStatus('idle');
        setIsMuted(false);
        setIsVideoOff(false);
        setTargetUserId(null);
        setIncomingCall(null);
        setError(null);
    }, [currentUserId, targetUserId]);

    const toggleMute = () => {
        const muted = VideoCallService.toggleMute();
        setIsMuted(muted);
    };

    const toggleVideo = () => {
        const off = VideoCallService.toggleVideo();
        setIsVideoOff(off);
    };

    return {
        isInCall,
        localStream,
        remoteStream,
        isMuted,
        isVideoOff,
        callStatus,
        error,
        incomingCall,
        startCall,
        answerCall,
        rejectCall,
        endCall,
        toggleMute,
        toggleVideo
    };
};

/**
 * Composant qui écoute les appels entrants en arrière-plan
 */
const IncomingCallListener = ({ userId, onIncomingCall }) => {
    const checkIntervalRef = useRef(null);
    const lastCheckedRef = useRef(new Date().toISOString());
    
    useEffect(() => {
        if (!userId) return;
        
        console.log('[IncomingCall] Démarrage écoute pour:', userId.substring(0, 8));
        
        const checkForIncomingCalls = async () => {
            if (typeof db === 'undefined' || !db) return;
            
            try {
                const { data, error } = await db.from('video_call_signals')
                    .select('*')
                    .eq('callee_id', userId)
                    .eq('signal_type', 'offer')
                    .eq('status', 'pending')
                    .gt('created_at', lastCheckedRef.current)
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (!error && data && data.length > 0) {
                    const call = data[0];
                    console.log('[IncomingCall] 📞 Appel entrant détecté de:', call.caller_id?.substring(0, 8));
                    lastCheckedRef.current = call.created_at;
                    onIncomingCall && onIncomingCall({
                        callerId: call.caller_id,
                        signalId: call.id,
                        offer: call.signal_data
                    });
                }
            } catch (e) {
                // Silencieux
            }
        };
        
        // Vérifier toutes les 2 secondes
        checkForIncomingCalls();
        checkIntervalRef.current = setInterval(checkForIncomingCalls, 2000);
        
        return () => {
            if (checkIntervalRef.current) {
                clearInterval(checkIntervalRef.current);
            }
            console.log('[IncomingCall] Arrêt écoute');
        };
    }, [userId, onIncomingCall]);
    
    return null; // Composant invisible
};

/**
 * Composant appel vidéo avec gestion des appels entrants
 */
const VideoCallPanel = ({ isOpen, onClose, currentUser, targetUser, isIncomingCall: isIncomingCallProp }) => {
    const currentUserId = currentUser?.id;
    const { 
        isInCall, localStream, remoteStream, isMuted, isVideoOff, 
        callStatus, error, incomingCall, startCall, answerCall, rejectCall, endCall, toggleMute, toggleVideo 
    } = useVideoCall(currentUserId);
    
    const localVideoRef = useRef(null);
    const remoteVideoRef = useRef(null);
    const [debugInfo, setDebugInfo] = useState([]);
    const [showDebug, setShowDebug] = useState(false);

    const addDebug = (msg) => {
        console.log('[VideoCallPanel]', msg);
        setDebugInfo(prev => [...prev.slice(-9), `${new Date().toLocaleTimeString()} - ${msg}`]);
    };

    // Attacher le stream local
    useEffect(() => {
        if (localVideoRef.current && localStream) {
            localVideoRef.current.srcObject = localStream;
            addDebug('Stream local attaché');
        }
    }, [localStream]);

    // Attacher le stream distant
    useEffect(() => {
        if (remoteVideoRef.current && remoteStream) {
            remoteVideoRef.current.srcObject = remoteStream;
            addDebug('Stream distant attaché - CONNECTÉ!');
        }
    }, [remoteStream]);

    // Démarrer l'appel quand le panel s'ouvre avec un targetUser (UNIQUEMENT pour appel sortant)
    useEffect(() => {
        if (isOpen && targetUser && !isInCall && !incomingCall && currentUserId && !isIncomingCallProp) {
            addDebug(`Démarrage appel sortant vers: ${targetUser.first_name || targetUser.id}`);
            startCall(targetUser.id);
        }
    }, [isOpen, targetUser, isInCall, incomingCall, currentUserId, isIncomingCallProp]);

    // Pour les appels entrants, log le status
    useEffect(() => {
        if (isIncomingCallProp) {
            addDebug('📞 Appel entrant - en attente de réponse');
        }
    }, [isIncomingCallProp]);

    // Log du status
    useEffect(() => {
        if (callStatus !== 'idle') {
            addDebug(`Status: ${callStatus}`);
        }
    }, [callStatus]);

    // Log des erreurs
    useEffect(() => {
        if (error) {
            addDebug(`ERREUR: ${error}`);
        }
    }, [error]);

    const handleClose = () => {
        addDebug('Fermeture appel');
        endCall();
        onClose();
    };

    const handleAnswer = () => {
        addDebug('Réponse à l\'appel');
        answerCall();
    };

    const handleReject = () => {
        addDebug('Appel refusé');
        rejectCall();
        onClose();
    };

    if (!isOpen) return null;

    // Déterminer le nom à afficher
    const displayName = incomingCall 
        ? `Appel entrant...` 
        : (targetUser?.first_name || targetUser?.email || 'Utilisateur');
    
    const displayInitial = incomingCall 
        ? '📞' 
        : (targetUser?.first_name?.[0] || '?').toUpperCase();

    // Status texte
    const statusText = {
        'idle': '',
        'calling': '📞 Appel en cours...',
        'ringing': '🔔 Appel entrant...',
        'connecting': '⏳ Connexion...',
        'connected': '🟢 Connecté'
    }[callStatus] || '';

    return h('div', { 
        style: { 
            position: 'fixed', 
            top: 0, left: 0, right: 0, bottom: 0,
            background: 'rgba(0, 0, 0, 0.95)', 
            zIndex: 99999,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
        } 
    },
        h('div', { 
            style: { 
                width: '95%',
                maxWidth: 900,
                background: '#1F2937',
                borderRadius: 16,
                overflow: 'hidden'
            }
        },
            // En-tête
            h('div', { 
                style: { 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    padding: 16,
                    background: '#111827',
                    borderBottom: '1px solid #374151'
                }
            },
                h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                    h('div', { 
                        style: { 
                            width: 48, height: 48, borderRadius: '50%',
                            background: '#3B82F6', color: 'white',
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            fontSize: 20, fontWeight: 600
                        }
                    }, displayInitial),
                    h('div', null,
                        h('span', { style: { fontWeight: 600, color: 'white', fontSize: 18, display: 'block' } }, displayName),
                        h('span', { style: { fontSize: 13, color: '#9CA3AF' } }, statusText || 'Connexion...')
                    )
                ),
                h('div', { style: { display: 'flex', gap: 8 } },
                    h('button', { 
                        style: { padding: '8px 12px', background: '#374151', color: 'white', border: 'none', borderRadius: 8, cursor: 'pointer' },
                        onClick: () => setShowDebug(!showDebug)
                    }, '🔧'),
                    h('button', { 
                        style: { padding: '8px 16px', background: '#EF4444', color: 'white', border: 'none', borderRadius: 8, cursor: 'pointer', fontWeight: 600 },
                        onClick: handleClose 
                    }, '✕ Fermer')
                )
            ),

            // Zone vidéo
            h('div', { 
                style: { 
                    position: 'relative',
                    aspectRatio: '16/9',
                    background: '#000',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                }
            },
                // Vidéo distante (grande)
                h('video', { 
                    ref: remoteVideoRef,
                    autoPlay: true,
                    playsInline: true,
                    style: { width: '100%', height: '100%', objectFit: 'cover' }
                }),
                // Vidéo locale (petite)
                h('video', { 
                    ref: localVideoRef,
                    autoPlay: true,
                    playsInline: true,
                    muted: true,
                    style: { 
                        position: 'absolute', bottom: 16, right: 16,
                        width: 180, height: 135,
                        borderRadius: 8, border: '2px solid white',
                        objectFit: 'cover', transform: 'scaleX(-1)'
                    }
                }),
                // Placeholder si pas de vidéo distante
                !remoteStream && h('div', { 
                    style: { 
                        position: 'absolute', inset: 0,
                        display: 'flex', flexDirection: 'column',
                        alignItems: 'center', justifyContent: 'center',
                        color: 'white', textAlign: 'center'
                    }
                },
                    h('div', { style: { fontSize: 64, marginBottom: 16 } }, 
                        (callStatus === 'ringing' || isIncomingCallProp) ? '🔔' :
                        callStatus === 'calling' ? '📞' : 
                        callStatus === 'connecting' ? '⏳' : '📹'
                    ),
                    h('div', { style: { fontSize: 18, marginBottom: 8 } }, 
                        (callStatus === 'ringing' || isIncomingCallProp) ? '📞 Appel entrant!' :
                        callStatus === 'calling' ? 'Appel en cours...' :
                        callStatus === 'connecting' ? 'Connexion...' : 
                        'Initialisation...'
                    ),
                    h('div', { style: { fontSize: 13, color: 'rgba(255,255,255,0.6)' } }, 
                        (callStatus === 'ringing' || isIncomingCallProp) 
                            ? 'Cliquez ✓ pour répondre ou ✕ pour refuser'
                            : 'L\'autre personne doit avoir l\'application ouverte'
                    )
                )
            ),

            // Erreur
            error && h('div', { 
                style: { 
                    padding: 12, margin: 16,
                    background: '#7F1D1D', color: '#FCA5A5',
                    borderRadius: 8, fontSize: 13
                }
            }, '⚠️ ', error),

            // Debug panel
            showDebug && h('div', { 
                style: { 
                    padding: 12, margin: '0 16px',
                    background: '#111827', 
                    color: '#10B981', 
                    fontSize: 11, 
                    fontFamily: 'monospace',
                    maxHeight: 150,
                    overflow: 'auto',
                    borderRadius: 8
                } 
            },
                h('div', { style: { marginBottom: 8, color: '#9CA3AF', paddingBottom: 8, borderBottom: '1px solid #374151' } }, 
                    h('div', null, 'User: ', currentUserId?.substring?.(0, 8) || 'N/A'),
                    h('div', null, 'Target: ', targetUser?.id?.substring?.(0, 8) || 'N/A'),
                    h('div', null, 'Status: ', callStatus),
                    h('div', null, 'LocalStream: ', localStream ? '✅' : '❌'),
                    h('div', null, 'RemoteStream: ', remoteStream ? '✅' : '❌')
                ),
                h('div', { style: { display: 'flex', gap: 8, marginBottom: 8 } },
                    h('button', {
                        style: { padding: '6px 12px', fontSize: 11, background: '#3B82F6', color: 'white', border: 'none', borderRadius: 4, cursor: 'pointer' },
                        onClick: async () => {
                            addDebug('🧪 Test Supabase...');
                            if (typeof db === 'undefined') {
                                addDebug('❌ db non défini!');
                                return;
                            }
                            try {
                                const { error } = await db.from('video_call_signals').select('id').limit(1);
                                addDebug(error ? `❌ ${error.message}` : '✅ Table OK');
                            } catch (e) {
                                addDebug(`❌ ${e.message}`);
                            }
                        }
                    }, '🧪 Test DB'),
                    h('button', {
                        style: { padding: '6px 12px', fontSize: 11, background: '#10B981', color: 'white', border: 'none', borderRadius: 4, cursor: 'pointer' },
                        onClick: async () => {
                            addDebug('📹 Test caméra...');
                            try {
                                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                                addDebug(`✅ Caméra: ${stream.getTracks().length} tracks`);
                                stream.getTracks().forEach(t => t.stop());
                            } catch (e) {
                                addDebug(`❌ ${e.name}: ${e.message}`);
                            }
                        }
                    }, '📹 Test Cam')
                ),
                debugInfo.map((info, i) => h('div', { 
                    key: i, 
                    style: { color: info.includes('❌') ? '#EF4444' : info.includes('✅') ? '#10B981' : '#9CA3AF' } 
                }, info))
            ),

            // Contrôles
            h('div', { 
                style: { 
                    display: 'flex', 
                    justifyContent: 'center', 
                    gap: 16,
                    padding: 16,
                    background: '#111827'
                }
            },
                // Boutons pour appel entrant (ringing ou isIncomingCallProp sans être en appel)
                (callStatus === 'ringing' || (isIncomingCallProp && !isInCall)) ? [
                    h('button', { 
                        key: 'answer',
                        style: { 
                            width: 72, height: 72, borderRadius: '50%',
                            background: '#10B981',
                            color: 'white', border: 'none', fontSize: 32, cursor: 'pointer',
                            boxShadow: '0 0 20px rgba(16, 185, 129, 0.5)'
                        },
                        onClick: handleAnswer,
                        title: 'Répondre'
                    }, '✓'),
                    h('button', { 
                        key: 'reject',
                        style: { 
                            width: 72, height: 72, borderRadius: '50%',
                            background: '#EF4444',
                            color: 'white', border: 'none', fontSize: 32, cursor: 'pointer',
                            boxShadow: '0 0 20px rgba(239, 68, 68, 0.5)'
                        },
                        onClick: handleReject,
                        title: 'Refuser'
                    }, '✕')
                ] : [
                    // Boutons normaux (en appel ou appelant)
                    h('button', { 
                        key: 'mute',
                        style: { 
                            width: 56, height: 56, borderRadius: '50%',
                            background: isMuted ? '#EF4444' : '#374151',
                            color: 'white', border: 'none', fontSize: 24, cursor: 'pointer'
                        },
                        onClick: toggleMute,
                        title: isMuted ? 'Activer micro' : 'Couper micro'
                    }, isMuted ? '🔇' : '🎤'),
                    h('button', { 
                        key: 'video',
                        style: { 
                            width: 56, height: 56, borderRadius: '50%',
                            background: isVideoOff ? '#EF4444' : '#374151',
                            color: 'white', border: 'none', fontSize: 24, cursor: 'pointer'
                        },
                        onClick: toggleVideo,
                        title: isVideoOff ? 'Activer caméra' : 'Couper caméra'
                    }, isVideoOff ? '📷' : '🎥'),
                    h('button', { 
                        key: 'hangup',
                        style: { 
                            width: 56, height: 56, borderRadius: '50%',
                            background: '#EF4444',
                            color: 'white', border: 'none', fontSize: 24, cursor: 'pointer'
                        },
                        onClick: handleClose,
                        title: 'Raccrocher'
                    }, '📞')
                ]
            )
        )
    )
};

// ============================================================================
// 7. INVENTAIRE PAR SCAN NFC
// ============================================================================

const NFCService = {
    isSupported: 'NDEFReader' in window,
    reader: null,
    writer: null,

    async startReading(onRead, onError) {
        if (!this.isSupported) {
            onError && onError(new Error('NFC non supporté sur cet appareil'));
            return false;
        }

        try {
            this.reader = new NDEFReader();
            await this.reader.scan();
            
            this.reader.addEventListener('reading', ({ message, serialNumber }) => {
                const records = [];
                for (const record of message.records) {
                    if (record.recordType === 'text') {
                        const decoder = new TextDecoder(record.encoding);
                        records.push({
                            type: 'text',
                            data: decoder.decode(record.data)
                        });
                    } else if (record.recordType === 'url') {
                        const decoder = new TextDecoder();
                        records.push({
                            type: 'url',
                            data: decoder.decode(record.data)
                        });
                    }
                }
                onRead && onRead({ serialNumber, records });
            });

            this.reader.addEventListener('readingerror', () => {
                onError && onError(new Error('Erreur de lecture NFC'));
            });

            return true;
        } catch (error) {
            onError && onError(error);
            return false;
        }
    },

    stopReading() {
        // Le reader ne peut pas être arrêté directement, mais on peut ignorer les événements
        this.reader = null;
    },

    async writeTag(data) {
        if (!this.isSupported) {
            throw new Error('NFC non supporté');
        }

        try {
            const writer = new NDEFReader();
            await writer.write({
                records: [{ recordType: 'text', data: JSON.stringify(data) }]
            });
            return true;
        } catch (error) {
            throw error;
        }
    },

    parseStockAppTag(data) {
        try {
            // Format attendu: STOCKAPP:PART:xxx ou STOCKAPP:DEVICE:xxx
            if (typeof data === 'string') {
                if (data.startsWith('STOCKAPP:')) {
                    const parts = data.split(':');
                    return {
                        type: parts[1]?.toLowerCase(), // 'part' ou 'device'
                        id: parts[2],
                        extra: parts.slice(3).join(':')
                    };
                }
                // Essayer de parser comme JSON
                return JSON.parse(data);
            }
            return data;
        } catch {
            return { type: 'unknown', raw: data };
        }
    },

    // Sauvegarder l'inventaire en base de données Supabase
    async saveInventoryLog(inventoryData, userId) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const { data, error } = await db.from('nfc_inventory_logs').insert([{
                    location: inventoryData.location || null,
                    vehicle_id: inventoryData.vehicleId || null,
                    total_expected: inventoryData.totalExpected || 0,
                    total_scanned: inventoryData.scannedItems?.length || 0,
                    total_missing: inventoryData.missingItems?.length || 0,
                    scanned_items: inventoryData.scannedItems || [],
                    missing_items: inventoryData.missingItems || [],
                    notes: inventoryData.notes || null,
                    status: 'completed',
                    performed_by: userId,
                    completed_at: new Date().toISOString()
                }]).select().single();
                
                if (!error && data) {
                    console.log('[NFC] Inventaire sauvegardé:', data.id);
                    return data;
                }
            } catch (e) {
                console.log('[NFC] Erreur sauvegarde inventaire:', e);
            }
        }
        return null;
    },

    // Récupérer l'historique des inventaires
    async getInventoryHistory(limit = 50) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const { data, error } = await db.from('nfc_inventory_logs')
                    .select('*')
                    .order('inventory_date', { ascending: false })
                    .limit(limit);
                
                if (!error && data) return data;
            } catch (e) {
                console.log('[NFC] Erreur chargement historique:', e);
            }
        }
        return [];
    },

    // Mettre à jour le tag NFC d'une pièce
    async updatePartNFCTag(partId, nfcTag) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const { error } = await db.from('parts')
                    .update({ nfc_tag: nfcTag })
                    .eq('id', partId);
                
                return !error;
            } catch (e) {
                console.log('[NFC] Erreur mise à jour tag:', e);
            }
        }
        return false;
    }
};

/**
 * Hook pour l'inventaire NFC
 */
const useNFCInventory = (parts, onUpdatePart) => {
    const [isScanning, setIsScanning] = useState(false);
    const [lastScan, setLastScan] = useState(null);
    const [scannedItems, setScannedItems] = useState([]);
    const [error, setError] = useState(null);
    const [mode, setMode] = useState('read'); // 'read', 'write', 'inventory'

    const startScanning = async () => {
        setError(null);
        const success = await NFCService.startReading(
            (result) => {
                const parsed = NFCService.parseStockAppTag(result.records[0]?.data);
                const scanResult = {
                    ...parsed,
                    serialNumber: result.serialNumber,
                    timestamp: new Date().toISOString()
                };
                
                setLastScan(scanResult);
                
                if (mode === 'inventory') {
                    // Trouver la pièce correspondante
                    const part = parts.find(p => 
                        p.id === parsed.id || 
                        p.reference === parsed.id ||
                        p.nfc_tag === result.serialNumber
                    );
                    
                    if (part && !scannedItems.find(s => s.partId === part.id)) {
                        setScannedItems(prev => [...prev, {
                            partId: part.id,
                            part,
                            scannedAt: new Date().toISOString(),
                            serialNumber: result.serialNumber
                        }]);
                    }
                }
            },
            (err) => {
                setError(err.message);
            }
        );
        
        if (success) {
            setIsScanning(true);
        }
    };

    const stopScanning = () => {
        NFCService.stopReading();
        setIsScanning(false);
    };

    const writeTag = async (data) => {
        try {
            setError(null);
            await NFCService.writeTag(data);
            return true;
        } catch (err) {
            setError(err.message);
            return false;
        }
    };

    const clearInventory = () => {
        setScannedItems([]);
        setLastScan(null);
    };

    const validateInventory = () => {
        const results = {
            scanned: scannedItems.length,
            total: parts.length,
            missing: parts.filter(p => !scannedItems.find(s => s.partId === p.id)),
            found: scannedItems
        };
        return results;
    };

    return {
        isSupported: NFCService.isSupported,
        isScanning,
        lastScan,
        scannedItems,
        error,
        mode,
        setMode,
        startScanning,
        stopScanning,
        writeTag,
        clearInventory,
        validateInventory
    };
};

/**
 * Modal Inventaire NFC
 */
const NFCInventoryModal = ({ isOpen, onClose, parts, onUpdatePart }) => {
    const { 
        isSupported, isScanning, lastScan, scannedItems, error, mode, setMode,
        startScanning, stopScanning, writeTag, clearInventory, validateInventory 
    } = useNFCInventory(parts, onUpdatePart);
    
    const [selectedPart, setSelectedPart] = useState(null);
    const [inventoryResults, setInventoryResults] = useState(null);

    const handleValidate = () => {
        const results = validateInventory();
        setInventoryResults(results);
    };

    if (!isOpen) return null;

    return h('div', { className: 'modal-overlay', onClick: onClose },
        h('div', { className: 'modal modal-lg nfc-modal', onClick: e => e.stopPropagation() },
            h('div', { className: 'modal-header' },
                h('h2', null, '📱 Inventaire NFC'),
                h('button', { className: 'btn btn-ghost', onClick: onClose }, '✕')
            ),
            h('div', { className: 'modal-body' },
                !isSupported && h('div', { className: 'nfc-not-supported' },
                    h('span', { className: 'nfc-icon' }, '📵'),
                    h('h3', null, 'NFC non disponible'),
                    h('p', null, 'Votre appareil ne supporte pas le NFC ou la fonctionnalité n\'est pas activée.'),
                    h('p', null, 'Utilisez un smartphone Android avec Chrome pour accéder à cette fonctionnalité.')
                ),

                isSupported && h(Fragment, null,
                    // Sélecteur de mode
                    h('div', { className: 'nfc-mode-selector' },
                        h('button', {
                            className: `btn ${mode === 'read' ? 'btn-primary' : 'btn-ghost'}`,
                            onClick: () => setMode('read')
                        }, '📖 Lecture'),
                        h('button', {
                            className: `btn ${mode === 'inventory' ? 'btn-primary' : 'btn-ghost'}`,
                            onClick: () => setMode('inventory')
                        }, '📋 Inventaire'),
                        h('button', {
                            className: `btn ${mode === 'write' ? 'btn-primary' : 'btn-ghost'}`,
                            onClick: () => setMode('write')
                        }, '✏️ Écriture')
                    ),

                    // Zone de scan
                    h('div', { className: 'nfc-scan-zone' },
                        h('div', { className: `nfc-scanner ${isScanning ? 'active' : ''}` },
                            h('div', { className: 'nfc-scanner-icon' }, isScanning ? '📡' : '📱'),
                            h('div', { className: 'nfc-scanner-waves' }),
                            h('p', null, isScanning ? 'Approchez un badge NFC...' : 'Scanner en pause')
                        ),
                        h('button', {
                            className: `btn btn-lg ${isScanning ? 'btn-danger' : 'btn-primary'}`,
                            onClick: isScanning ? stopScanning : startScanning
                        }, isScanning ? '⏹ Arrêter' : '▶ Démarrer le scan')
                    ),

                    // Erreur
                    error && h('div', { className: 'nfc-error' },
                        h('span', null, '⚠️ ', error)
                    ),

                    // Dernier scan
                    lastScan && h('div', { className: 'nfc-last-scan' },
                        h('h4', null, 'Dernier scan'),
                        h('div', { className: 'nfc-scan-result' },
                            h('div', { className: 'nfc-scan-serial' }, 
                                h('label', null, 'N° série'),
                                h('code', null, lastScan.serialNumber)
                            ),
                            lastScan.type && h('div', { className: 'nfc-scan-type' },
                                h('label', null, 'Type'),
                                h('span', null, lastScan.type)
                            ),
                            lastScan.id && h('div', { className: 'nfc-scan-id' },
                                h('label', null, 'ID'),
                                h('span', null, lastScan.id)
                            )
                        )
                    ),

                    // Mode Inventaire
                    mode === 'inventory' && h('div', { className: 'nfc-inventory' },
                        h('div', { className: 'nfc-inventory-header' },
                            h('h4', null, `Articles scannés: ${scannedItems.length} / ${parts.length}`),
                            h('div', { className: 'nfc-inventory-actions' },
                                h('button', { 
                                    className: 'btn btn-sm btn-ghost',
                                    onClick: clearInventory
                                }, '🗑️ Effacer'),
                                h('button', { 
                                    className: 'btn btn-sm btn-primary',
                                    onClick: handleValidate
                                }, '✓ Valider')
                            )
                        ),
                        h('div', { className: 'nfc-inventory-progress' },
                            h('div', { 
                                className: 'nfc-inventory-bar',
                                style: { width: `${(scannedItems.length / parts.length) * 100}%` }
                            })
                        ),
                        h('div', { className: 'nfc-scanned-list' },
                            scannedItems.map((item, i) => h('div', {
                                key: item.partId,
                                className: 'nfc-scanned-item'
                            },
                                h('span', { className: 'nfc-item-index' }, i + 1),
                                h('span', { className: 'nfc-item-name' }, item.part?.name || item.partId),
                                h('span', { className: 'nfc-item-ref' }, item.part?.reference),
                                h('span', { className: 'nfc-item-time' }, 
                                    new Date(item.scannedAt).toLocaleTimeString()
                                )
                            ))
                        )
                    ),

                    // Mode Écriture
                    mode === 'write' && h('div', { className: 'nfc-write' },
                        h('h4', null, 'Écrire sur un badge'),
                        h('div', { className: 'form-group' },
                            h('label', null, 'Sélectionner une pièce'),
                            h('select', {
                                className: 'form-control',
                                value: selectedPart?.id || '',
                                onChange: e => setSelectedPart(parts.find(p => p.id === e.target.value))
                            },
                                h('option', { value: '' }, 'Choisir une pièce...'),
                                parts.slice(0, 100).map(p => h('option', { key: p.id, value: p.id }, 
                                    `${p.reference} - ${p.name}`
                                ))
                            )
                        ),
                        selectedPart && h('div', { className: 'nfc-write-preview' },
                            h('p', null, 'Données à écrire:'),
                            h('code', null, `STOCKAPP:PART:${selectedPart.id}`),
                            h('button', {
                                className: 'btn btn-primary',
                                onClick: () => writeTag({ type: 'part', id: selectedPart.id, ref: selectedPart.reference })
                            }, '✏️ Écrire sur le badge')
                        )
                    ),

                    // Résultats d'inventaire
                    inventoryResults && h('div', { className: 'nfc-results modal-overlay', onClick: () => setInventoryResults(null) },
                        h('div', { className: 'nfc-results-content', onClick: e => e.stopPropagation() },
                            h('h3', null, '📊 Résultats de l\'inventaire'),
                            h('div', { className: 'nfc-results-stats' },
                                h('div', { className: 'nfc-stat success' },
                                    h('span', { className: 'nfc-stat-value' }, inventoryResults.scanned),
                                    h('span', { className: 'nfc-stat-label' }, 'Scannés')
                                ),
                                h('div', { className: 'nfc-stat warning' },
                                    h('span', { className: 'nfc-stat-value' }, inventoryResults.missing.length),
                                    h('span', { className: 'nfc-stat-label' }, 'Manquants')
                                ),
                                h('div', { className: 'nfc-stat info' },
                                    h('span', { className: 'nfc-stat-value' }, inventoryResults.total),
                                    h('span', { className: 'nfc-stat-label' }, 'Total')
                                )
                            ),
                            inventoryResults.missing.length > 0 && h('div', { className: 'nfc-missing-list' },
                                h('h4', null, 'Articles non scannés'),
                                inventoryResults.missing.slice(0, 20).map(part => h('div', {
                                    key: part.id,
                                    className: 'nfc-missing-item'
                                },
                                    h('span', null, part.reference),
                                    h('span', null, part.name)
                                ))
                            ),
                            h('button', { 
                                className: 'btn btn-primary',
                                onClick: () => setInventoryResults(null)
                            }, 'Fermer')
                        )
                    )
                )
            )
        )
    );
};


// ============================================================================
// 8. GESTION DES VÉHICULES
// ============================================================================

const VehicleService = {
    STORAGE_KEY: 'stockapp-vehicles',

    // Méthode pour vérifier si Supabase est disponible
    useSupabase() {
        return typeof db !== 'undefined' && db !== null;
    },

    async getVehicles() {
        if (this.useSupabase()) {
            try {
                const { data, error } = await db.from('vehicles').select('*').order('name');
                if (!error && data) return data.map(v => this.mapVehicleFromDb(v));
            } catch (e) { console.log('Fallback to localStorage for vehicles'); }
        }
        // Fallback localStorage
        try {
            return JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
        } catch {
            return [];
        }
    },

    async saveVehicle(vehicle) {
        if (this.useSupabase()) {
            try {
                // Mapper camelCase vers snake_case pour Supabase
                const vehicleData = {
                    name: vehicle.name,
                    plate: vehicle.plate,
                    type: vehicle.type || 'van',
                    assigned_to: vehicle.assignedTo || vehicle.assigned_to || null,
                    brand: vehicle.brand || null,
                    model: vehicle.model || null,
                    year: vehicle.year || null,
                    mileage: vehicle.mileage || 0,
                    fuel_type: vehicle.fuelType || vehicle.fuel_type || 'diesel',
                    last_maintenance: vehicle.lastMaintenance || vehicle.last_maintenance || null,
                    next_maintenance: vehicle.nextMaintenance || vehicle.next_maintenance || null,
                    insurance_expiry: vehicle.insuranceExpiry || vehicle.insurance_expiry || null,
                    technical_control_expiry: vehicle.technicalControlExpiry || vehicle.technical_control_expiry || null,
                    notes: vehicle.notes || null,
                    status: vehicle.status || 'available'
                };
                
                if (vehicle.id && !vehicle.id.startsWith('vehicle_')) {
                    // Update existing
                    vehicleData.updated_at = new Date().toISOString();
                    const { data, error } = await db.from('vehicles').update(vehicleData).eq('id', vehicle.id).select().single();
                    if (!error) return this.mapVehicleFromDb(data);
                    console.log('Erreur update vehicle:', error);
                } else {
                    // Insert new
                    const { data, error } = await db.from('vehicles').insert([vehicleData]).select().single();
                    if (!error) return this.mapVehicleFromDb(data);
                    console.log('Erreur insert vehicle:', error);
                }
            } catch (e) { console.log('Fallback to localStorage for saveVehicle', e); }
        }
        // Fallback localStorage
        const vehicles = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
        const existingIndex = vehicles.findIndex(v => v.id === vehicle.id);
        if (existingIndex >= 0) {
            vehicles[existingIndex] = vehicle;
        } else {
            vehicles.push({ ...vehicle, id: `vehicle_${Date.now()}`, createdAt: new Date().toISOString() });
        }
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(vehicles));
        return vehicles;
    },
    
    // Mapper les données Supabase (snake_case) vers JS (camelCase)
    mapVehicleFromDb(dbVehicle) {
        if (!dbVehicle) return null;
        return {
            id: dbVehicle.id,
            name: dbVehicle.name,
            plate: dbVehicle.plate,
            type: dbVehicle.type,
            assignedTo: dbVehicle.assigned_to,
            brand: dbVehicle.brand,
            model: dbVehicle.model,
            year: dbVehicle.year,
            mileage: dbVehicle.mileage,
            fuelType: dbVehicle.fuel_type,
            lastMaintenance: dbVehicle.last_maintenance,
            nextMaintenance: dbVehicle.next_maintenance,
            insuranceExpiry: dbVehicle.insurance_expiry,
            technicalControlExpiry: dbVehicle.technical_control_expiry,
            notes: dbVehicle.notes,
            status: dbVehicle.status,
            createdAt: dbVehicle.created_at,
            updatedAt: dbVehicle.updated_at
        };
    },

    async deleteVehicle(vehicleId) {
        if (this.useSupabase() && !vehicleId.startsWith('vehicle_')) {
            try {
                const { error } = await db.from('vehicles').delete().eq('id', vehicleId);
                if (!error) return true;
            } catch (e) { console.log('Fallback to localStorage for deleteVehicle'); }
        }
        // Fallback localStorage
        const vehicles = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]').filter(v => v.id !== vehicleId);
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(vehicles));
        return vehicles;
    },

    // Version synchrone pour l'affichage (utilise localStorage uniquement)
    getVehicleStockSync(vehicleId) {
        if (!vehicleId) return [];
        const key = `stockapp-vehicle-stock-${vehicleId}`;
        try {
            return JSON.parse(localStorage.getItem(key) || '[]');
        } catch {
            return [];
        }
    },

    async getVehicleStock(vehicleId) {
        if (this.useSupabase() && !vehicleId.startsWith('vehicle_')) {
            try {
                const { data, error } = await db.from('vehicle_stock')
                    .select('*, parts:part_id(id, ref, name)')
                    .eq('vehicle_id', vehicleId);
                if (!error && data) return data.map(s => ({ partId: s.part_id, quantity: s.quantity, part: s.parts }));
            } catch (e) { console.log('Fallback to localStorage for getVehicleStock'); }
        }
        // Fallback localStorage
        const key = `stockapp-vehicle-stock-${vehicleId}`;
        try {
            return JSON.parse(localStorage.getItem(key) || '[]');
        } catch {
            return [];
        }
    },

    async updateVehicleStock(vehicleId, partId, quantity) {
        if (this.useSupabase() && !vehicleId.startsWith('vehicle_')) {
            try {
                const { error } = await db.from('vehicle_stock').upsert({
                    vehicle_id: vehicleId,
                    part_id: partId,
                    quantity: quantity
                }, { onConflict: 'vehicle_id,part_id' });
                if (!error) return true;
            } catch (e) { console.log('Fallback to localStorage'); }
        }
        // Fallback localStorage
        const key = `stockapp-vehicle-stock-${vehicleId}`;
        const stock = JSON.parse(localStorage.getItem(key) || '[]');
        const existing = stock.find(s => s.partId === partId);
        if (existing) {
            existing.quantity = quantity;
        } else {
            stock.push({ partId, quantity });
        }
        localStorage.setItem(key, JSON.stringify(stock));
    },

    async transferStock(fromVehicleId, toVehicleId, partId, quantity) {
        if (this.useSupabase() && !fromVehicleId.startsWith('vehicle_')) {
            try {
                const { data, error } = await db.rpc('transfer_vehicle_stock', {
                    p_from_vehicle_id: fromVehicleId,
                    p_to_vehicle_id: toVehicleId,
                    p_part_id: partId,
                    p_quantity: quantity,
                    p_user_id: null,
                    p_notes: null
                });
                if (!error) return true;
            } catch (e) { console.log('Fallback to localStorage for transferStock'); }
        }
        // Fallback localStorage
        const fromStock = JSON.parse(localStorage.getItem(`stockapp-vehicle-stock-${fromVehicleId}`) || '[]');
        const toStock = JSON.parse(localStorage.getItem(`stockapp-vehicle-stock-${toVehicleId}`) || '[]');
        
        const fromItem = fromStock.find(s => s.partId === partId);
        if (!fromItem || fromItem.quantity < quantity) {
            throw new Error('Stock insuffisant');
        }

        fromItem.quantity -= quantity;
        if (fromItem.quantity === 0) {
            fromStock.splice(fromStock.indexOf(fromItem), 1);
        }

        const toItem = toStock.find(s => s.partId === partId);
        if (toItem) {
            toItem.quantity += quantity;
        } else {
            toStock.push({ partId, quantity });
        }

        localStorage.setItem(`stockapp-vehicle-stock-${fromVehicleId}`, JSON.stringify(fromStock));
        localStorage.setItem(`stockapp-vehicle-stock-${toVehicleId}`, JSON.stringify(toStock));

        return { fromStock, toStock };
    }
};

/**
 * Hook pour la gestion des véhicules (avec support Supabase)
 */
const useVehicles = (data, user, refresh, showToast) => {
    const [vehicles, setVehicles] = useState([]);
    const [selectedVehicle, setSelectedVehicle] = useState(null);
    const [vehicleStock, setVehicleStock] = useState([]);
    const [loading, setLoading] = useState(true);

    // Charger les véhicules au démarrage
    useEffect(() => {
        const loadVehicles = async () => {
            setLoading(true);
            const data = await VehicleService.getVehicles();
            setVehicles(Array.isArray(data) ? data : []);
            setLoading(false);
        };
        loadVehicles();

        // Écouter les changements temps réel
        const handleVehicleChange = async () => {
            const data = await VehicleService.getVehicles();
            setVehicles(Array.isArray(data) ? data : []);
        };

        const handleStockChange = async () => {
            if (selectedVehicle) {
                const stock = await VehicleService.getVehicleStock(selectedVehicle.id);
                setVehicleStock(Array.isArray(stock) ? stock : []);
            }
        };

        // Écouter les événements de changement
        window.addEventListener('vehicle-updated', handleVehicleChange);
        window.addEventListener('vehicle-stock-updated', handleStockChange);

        return () => {
            window.removeEventListener('vehicle-updated', handleVehicleChange);
            window.removeEventListener('vehicle-stock-updated', handleStockChange);
        };
    }, []);

    // Charger le stock quand un véhicule est sélectionné
    useEffect(() => {
        const loadStock = async () => {
            if (selectedVehicle) {
                const stock = await VehicleService.getVehicleStock(selectedVehicle.id);
                setVehicleStock(Array.isArray(stock) ? stock : []);
            }
        };
        loadStock();
    }, [selectedVehicle]);

    const saveVehicle = async (vehicle) => {
        const result = await VehicleService.saveVehicle(vehicle);
        // Recharger les véhicules
        const data = await VehicleService.getVehicles();
        setVehicles(Array.isArray(data) ? data : []);
        return result;
    };

    const deleteVehicle = async (vehicleId) => {
        await VehicleService.deleteVehicle(vehicleId);
        const data = await VehicleService.getVehicles();
        setVehicles(Array.isArray(data) ? data : []);
        if (selectedVehicle?.id === vehicleId) {
            setSelectedVehicle(null);
        }
    };

    const addToVehicleStock = async (vehicleId, partId, quantity, fromMainStock = true) => {
        try {
            // 1. Vérifier et décrémenter le stock principal si demandé
            if (fromMainStock) {
                const part = data?.parts?.find(p => p.id === partId);
                if (!part) {
                    showToast && showToast('Pièce introuvable', 'error');
                    return false;
                }
                if ((part.quantity || 0) < quantity) {
                    showToast && showToast('Stock principal insuffisant', 'error');
                    return false;
                }
                
                // Décrémenter le stock principal
                if (typeof db !== 'undefined' && db !== null) {
                    await db.from('parts').update({ quantity: part.quantity - quantity }).eq('id', partId);
                }
                // Mise à jour locale
                if (typeof refresh === 'function') {
                    setTimeout(() => refresh(), 500);
                }
            }
            
            // 2. Ajouter au stock véhicule
            const stock = await VehicleService.getVehicleStock(vehicleId);
            const existing = stock.find(s => s.partId === partId || s.part_id === partId);
            const newQty = (existing?.quantity || 0) + quantity;
            await VehicleService.updateVehicleStock(vehicleId, partId, newQty);
            
            // 3. Créer un mouvement de stock dans stock_withdrawals
            if (typeof db !== 'undefined' && db !== null) {
                const part = data?.parts?.find(p => p.id === partId);
                const vehicle = vehicles.find(v => v.id === vehicleId);
                const userName = ((user?.first_name || '') + ' ' + (user?.last_name || '')).trim() || user?.email || 'Système';
                const movementData = {
                    part_id: partId,
                    part_ref: part?.ref || part?.reference || '-',
                    part_name: part?.name || 'Pièce',
                    quantity: quantity,
                    type: 'sortie',
                    reason: `Transfert vers véhicule ${vehicle?.name || ''} (${vehicle?.plate || vehicle?.registration || vehicleId})`,
                    withdrawn_by: userName,
                    user_id: user?.id || null,
                    withdrawn_at: new Date().toISOString()
                };
                
                console.log('[VehicleStock] Création mouvement:', movementData);
                
                try {
                    const { data: insertedMvt, error: mvtError } = await db.from('stock_withdrawals').insert(movementData).select().single();
                    if (mvtError) {
                        console.error('[VehicleStock] Erreur mouvement:', mvtError.code, mvtError.message);
                        if (mvtError.code === '42P01') {
                            showToast && showToast('Table stock_withdrawals manquante - exécutez le script SQL', 'warning');
                        }
                    } else {
                        console.log('[VehicleStock] ✅ Mouvement créé:', insertedMvt?.id);
                        // Dispatch event pour refresh
                        window.dispatchEvent(new CustomEvent('stock-movement-created', { detail: insertedMvt }));
                    }
                } catch (mvtErr) {
                    console.error('[VehicleStock] Exception mouvement:', mvtErr);
                }
            }
            
            // 4. Rafraîchir l'affichage
            if (selectedVehicle?.id === vehicleId) {
                const updatedStock = await VehicleService.getVehicleStock(vehicleId);
                setVehicleStock(updatedStock);
            }
            
            showToast && showToast(`${quantity} pièce(s) ajoutée(s) au véhicule`, 'success');
            return true;
        } catch (error) {
            console.error('[VehicleStock] Erreur ajout:', error);
            showToast && showToast('Erreur lors de l\'ajout', 'error');
            return false;
        }
    };

    const removeFromVehicleStock = async (vehicleId, partId, quantity, toMainStock = true) => {
        try {
            const stock = await VehicleService.getVehicleStock(vehicleId);
            const existing = stock.find(s => s.partId === partId || s.part_id === partId);
            
            if (!existing || existing.quantity < quantity) {
                showToast && showToast('Stock véhicule insuffisant', 'error');
                return false;
            }
            
            const newQty = existing.quantity - quantity;
            
            // 1. Mettre à jour ou supprimer du stock véhicule
            if (newQty > 0) {
                await VehicleService.updateVehicleStock(vehicleId, partId, newQty);
            } else {
                // Supprimer l'entrée si qty = 0
                if (VehicleService.useSupabase() && !vehicleId.startsWith('vehicle_')) {
                    await db.from('vehicle_stock').delete().eq('vehicle_id', vehicleId).eq('part_id', partId);
                } else {
                    const key = `stockapp-vehicle-stock-${vehicleId}`;
                    const updatedStock = stock.filter(s => (s.partId || s.part_id) !== partId);
                    localStorage.setItem(key, JSON.stringify(updatedStock));
                }
            }
            
            // 2. Remettre dans le stock principal si demandé
            if (toMainStock) {
                const part = data?.parts?.find(p => p.id === partId);
                if (part && typeof db !== 'undefined' && db !== null) {
                    await db.from('parts').update({ quantity: (part.quantity || 0) + quantity }).eq('id', partId);
                }
                if (typeof refresh === 'function') {
                    setTimeout(() => refresh(), 500);
                }
            }
            
            // 3. Créer un mouvement de stock dans stock_withdrawals
            if (typeof db !== 'undefined' && db !== null) {
                const part = data?.parts?.find(p => p.id === partId);
                const vehicle = vehicles.find(v => v.id === vehicleId);
                const userName = ((user?.first_name || '') + ' ' + (user?.last_name || '')).trim() || user?.email || 'Système';
                const movementData = {
                    part_id: partId,
                    part_ref: part?.ref || part?.reference || '-',
                    part_name: part?.name || 'Pièce',
                    quantity: quantity,
                    type: toMainStock ? 'entree' : 'sortie',
                    reason: toMainStock 
                        ? `Retour du véhicule ${vehicle?.name || ''} (${vehicle?.plate || vehicle?.registration || vehicleId})` 
                        : `Consommé depuis véhicule ${vehicle?.name || ''} (${vehicle?.plate || vehicle?.registration || vehicleId})`,
                    withdrawn_by: userName,
                    user_id: user?.id || null,
                    withdrawn_at: new Date().toISOString()
                };
                
                try {
                    const { data: insertedMvt, error: mvtError } = await db.from('stock_withdrawals').insert(movementData).select().single();
                    if (mvtError) {
                        console.error('[VehicleStock] Erreur mouvement:', mvtError.code, mvtError.message);
                    } else {
                        console.log('[VehicleStock] ✅ Mouvement créé:', toMainStock ? 'entree (retour)' : 'sortie (consommation)');
                        window.dispatchEvent(new CustomEvent('stock-movement-created', { detail: insertedMvt }));
                    }
                } catch (mvtErr) {
                    console.error('[VehicleStock] Exception mouvement:', mvtErr);
                }
            }
            
            // 4. Rafraîchir l'affichage
            if (selectedVehicle?.id === vehicleId) {
                const updatedStock = await VehicleService.getVehicleStock(vehicleId);
                setVehicleStock(updatedStock);
            }
            
            showToast && showToast(`${quantity} pièce(s) retirée(s) du véhicule`, 'success');
            return true;
        } catch (error) {
            console.error('[VehicleStock] Erreur retrait:', error);
            showToast && showToast('Erreur lors du retrait', 'error');
            return false;
        }
    };

    const updateVehicleStockQuantity = async (vehicleId, partId, newQuantity) => {
        try {
            const stock = await VehicleService.getVehicleStock(vehicleId);
            const existing = stock.find(s => s.partId === partId || s.part_id === partId);
            const currentQty = existing?.quantity || 0;
            const diff = newQuantity - currentQty;
            
            if (diff === 0) return true;
            
            if (diff > 0) {
                // Ajouter la différence
                return await addToVehicleStock(vehicleId, partId, diff, true);
            } else {
                // Retirer la différence (retour au stock principal)
                return await removeFromVehicleStock(vehicleId, partId, -diff, true);
            }
        } catch (error) {
            console.error('[VehicleStock] Erreur modification:', error);
            return false;
        }
    };

    const deleteFromVehicleStock = async (vehicleId, partId, returnToStock = true) => {
        const stock = await VehicleService.getVehicleStock(vehicleId);
        const existing = stock.find(s => s.partId === partId || s.part_id === partId);
        if (existing) {
            return await removeFromVehicleStock(vehicleId, partId, existing.quantity, returnToStock);
        }
        return false;
    };

    const transferStock = async (fromVehicleId, toVehicleId, partId, quantity) => {
        try {
            await VehicleService.transferStock(fromVehicleId, toVehicleId, partId, quantity);
            if (selectedVehicle?.id === fromVehicleId || selectedVehicle?.id === toVehicleId) {
                const stock = await VehicleService.getVehicleStock(selectedVehicle.id);
                setVehicleStock(stock);
            }
            return true;
        } catch (error) {
            return false;
        }
    };

    return {
        vehicles,
        loading,
        selectedVehicle,
        setSelectedVehicle,
        vehicleStock,
        saveVehicle,
        deleteVehicle,
        addToVehicleStock,
        removeFromVehicleStock,
        updateVehicleStockQuantity,
        deleteFromVehicleStock,
        transferStock
    };
};


/**
 * Page de gestion des véhicules - v5.6 Gestion de Flotte
 */
const VehiclesPage = ({ data, user, refresh, showToast }) => {
    const [activeTab, setActiveTab] = useState('vehicles');
    const [vehicles, setVehicles] = useState([]);
    const [selectedVehicle, setSelectedVehicle] = useState(null);
    const [fuelExpenses, setFuelExpenses] = useState([]);
    const [maintenanceRecords, setMaintenanceRecords] = useState([]);
    const [vehicleAlerts, setVehicleAlerts] = useState([]);
    const [loading, setLoading] = useState(true);
    
    const [showVehicleModal, setShowVehicleModal] = useState(false);
    const [showFuelModal, setShowFuelModal] = useState(false);
    const [showMaintenanceModal, setShowMaintenanceModal] = useState(false);
    const [editingItem, setEditingItem] = useState(null);
    
    // Stock véhicule (existant)
    const { vehicleStock, addToVehicleStock, removeFromVehicleStock, updateVehicleStockQuantity, deleteFromVehicleStock } = useVehicles(data, user, refresh, showToast);
    const [showAddStockModal, setShowAddStockModal] = useState(false);
    const [stockSearch, setStockSearch] = useState('');
    const [selectedPartToAdd, setSelectedPartToAdd] = useState(null);
    const [quantityToAdd, setQuantityToAdd] = useState(1);
    
    const emptyVehicleForm = {
        name: '', plate: '', type: 'van', brand: '', model: '', year: new Date().getFullYear(),
        vin: '', assigned_to: '', insurance_company: '', insurance_number: '', insurance_expiry: '',
        ct_date: '', ct_expiry: '', current_mileage: 0, last_service_date: '', last_service_mileage: '',
        next_service_mileage: '', next_service_date: '', notes: '', status: 'active'
    };
    const [vehicleForm, setVehicleForm] = useState(emptyVehicleForm);
    
    const emptyFuelForm = {
        vehicle_id: '', date: new Date().toISOString().split('T')[0], mileage: '',
        liters: '', price_per_liter: '', total_amount: '', fuel_type: 'diesel', station: '', notes: ''
    };
    const [fuelForm, setFuelForm] = useState(emptyFuelForm);
    
    const emptyMaintenanceForm = {
        vehicle_id: '', type: 'oil_change', date: new Date().toISOString().split('T')[0],
        mileage: '', description: '', cost: '', provider: '', next_date: '', next_mileage: ''
    };
    const [maintenanceForm, setMaintenanceForm] = useState(emptyMaintenanceForm);

    const vehicleTypes = [
        { id: 'van', label: 'Fourgon', icon: '🚐' },
        { id: 'truck', label: 'Camion', icon: '🚛' },
        { id: 'car', label: 'Voiture', icon: '🚗' },
        { id: 'motorcycle', label: 'Moto', icon: '🏍️' },
        { id: 'utility', label: 'Utilitaire', icon: '🚚' }
    ];
    
    const fuelTypes = [
        { id: 'diesel', label: 'Diesel' },
        { id: 'essence', label: 'Essence' },
        { id: 'electric', label: 'Électrique' },
        { id: 'hybrid', label: 'Hybride' }
    ];
    
    const maintenanceTypes = [
        { id: 'oil_change', label: 'Vidange', icon: '🛢️' },
        { id: 'tires', label: 'Pneus', icon: '🔘' },
        { id: 'brakes', label: 'Freins', icon: '🛑' },
        { id: 'ct', label: 'Contrôle technique', icon: '📋' },
        { id: 'battery', label: 'Batterie', icon: '🔋' },
        { id: 'other', label: 'Autre', icon: '🔧' }
    ];

    useEffect(() => { loadFleetData(); }, []);

    const loadFleetData = async () => {
        setLoading(true);
        try {
            const [vehiclesRes, fuelRes, maintRes, alertsRes] = await Promise.all([
                db.from('vehicles').select('*').order('name'),
                db.from('fuel_expenses').select('*').order('date', { ascending: false }).limit(100),
                db.from('vehicle_maintenance').select('*').order('date', { ascending: false }).limit(100),
                db.from('vehicle_alerts').select('*').eq('status', 'pending').order('due_date')
            ]);
            
            if (vehiclesRes.data) setVehicles(vehiclesRes.data);
            if (fuelRes.data) setFuelExpenses(fuelRes.data);
            if (maintRes.data) setMaintenanceRecords(maintRes.data);
            if (alertsRes.data) setVehicleAlerts(alertsRes.data);
        } catch (err) {
            console.log('Erreur chargement flotte:', err);
            setVehicles(VehicleService.getVehicles());
        }
        setLoading(false);
    };

    const saveVehicle = async () => {
        try {
            if (editingItem) {
                const { error } = await db.from('vehicles').update(vehicleForm).eq('id', editingItem.id);
                if (error) throw error;
                showToast('Véhicule modifié', 'success');
            } else {
                const { error } = await db.from('vehicles').insert(vehicleForm);
                if (error) throw error;
                showToast('Véhicule créé', 'success');
            }
            setShowVehicleModal(false);
            setVehicleForm(emptyVehicleForm);
            setEditingItem(null);
            loadFleetData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
            VehicleService.saveVehicle(vehicleForm);
            showToast('Véhicule sauvegardé localement', 'warning');
        }
    };

    const saveFuelExpense = async () => {
        try {
            const expense = { ...fuelForm, user_id: user.id, total_amount: fuelForm.total_amount || (fuelForm.liters * fuelForm.price_per_liter) };
            if (editingItem) {
                await db.from('fuel_expenses').update(expense).eq('id', editingItem.id);
            } else {
                await db.from('fuel_expenses').insert(expense);
            }
            if (fuelForm.mileage && fuelForm.vehicle_id) {
                await db.from('vehicles').update({ current_mileage: parseInt(fuelForm.mileage), last_mileage_update: new Date().toISOString() }).eq('id', fuelForm.vehicle_id);
            }
            showToast('Dépense carburant enregistrée', 'success');
            setShowFuelModal(false);
            setFuelForm(emptyFuelForm);
            setEditingItem(null);
            loadFleetData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };

    const saveMaintenance = async () => {
        try {
            if (editingItem) {
                await db.from('vehicle_maintenance').update(maintenanceForm).eq('id', editingItem.id);
            } else {
                await db.from('vehicle_maintenance').insert(maintenanceForm);
            }
            if (maintenanceForm.type === 'oil_change' && maintenanceForm.vehicle_id) {
                await db.from('vehicles').update({ last_service_date: maintenanceForm.date, last_service_mileage: maintenanceForm.mileage, next_service_date: maintenanceForm.next_date, next_service_mileage: maintenanceForm.next_mileage }).eq('id', maintenanceForm.vehicle_id);
            }
            if (maintenanceForm.type === 'ct' && maintenanceForm.vehicle_id) {
                await db.from('vehicles').update({ ct_date: maintenanceForm.date, ct_expiry: maintenanceForm.next_date }).eq('id', maintenanceForm.vehicle_id);
            }
            showToast('Entretien enregistré', 'success');
            setShowMaintenanceModal(false);
            setMaintenanceForm(emptyMaintenanceForm);
            setEditingItem(null);
            loadFleetData();
        } catch (err) {
            showToast('Erreur: ' + err.message, 'error');
        }
    };

    const stats = useMemo(() => {
        const thisMonth = new Date().toISOString().slice(0, 7);
        const monthlyFuel = fuelExpenses.filter(f => f.date?.startsWith(thisMonth));
        const totalFuelCost = monthlyFuel.reduce((sum, f) => sum + (parseFloat(f.total_amount) || 0), 0);
        const totalLiters = monthlyFuel.reduce((sum, f) => sum + (parseFloat(f.liters) || 0), 0);
        const monthlyMaint = maintenanceRecords.filter(m => m.date?.startsWith(thisMonth));
        const totalMaintCost = monthlyMaint.reduce((sum, m) => sum + (parseFloat(m.cost) || 0), 0);
        return {
            totalVehicles: vehicles.length,
            activeVehicles: vehicles.filter(v => v.status === 'active').length,
            pendingAlerts: vehicleAlerts.length,
            monthlyFuelCost: totalFuelCost,
            monthlyLiters: totalLiters,
            monthlyMaintCost: totalMaintCost,
            avgFuelPrice: totalLiters > 0 ? (totalFuelCost / totalLiters).toFixed(3) : 0
        };
    }, [vehicles, fuelExpenses, maintenanceRecords, vehicleAlerts]);

    const getVehicleTypeInfo = (type) => vehicleTypes.find(t => t.id === type) || vehicleTypes[0];
    const getUserName = (userId) => { const u = data.users?.find(u => u.id === userId); return u ? `${u.first_name || ''} ${u.last_name || ''}`.trim() || u.email : 'Non assigné'; };
    const getPartInfo = (partId) => data.parts?.find(p => p.id === partId);
    const currentVehicleStock = selectedVehicle ? (VehicleService.getVehicleStockSync(selectedVehicle.id) || []) : [];
    const totalStockValue = currentVehicleStock.reduce((sum, item) => { const part = getPartInfo(item.partId); return sum + (item.quantity * (part?.price || 0)); }, 0);

    return h('div', null,
        h('div', { className: 'page-header' },
            h('div', { className: 'page-header-left' },
                h('h1', { className: 'page-title' }, '🚗 Gestion de flotte'),
                h('p', { className: 'page-subtitle' }, `${stats.totalVehicles} véhicule(s) • ${stats.pendingAlerts} alerte(s)`)
            ),
            h('div', { className: 'page-actions' },
                h('button', { className: 'btn btn-primary', onClick: () => { setVehicleForm(emptyVehicleForm); setEditingItem(null); setShowVehicleModal(true); } }, '+ Nouveau véhicule')
            )
        ),

        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: 16, marginBottom: 24 } },
            h('div', { className: 'card', style: { padding: 20, textAlign: 'center' } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.primary } }, stats.totalVehicles),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Véhicules')
            ),
            h('div', { className: 'card', style: { padding: 20, textAlign: 'center' } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.success } }, stats.activeVehicles),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Actifs')
            ),
            h('div', { className: 'card', style: { padding: 20, textAlign: 'center' } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.warning } }, stats.pendingAlerts),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Alertes')
            ),
            h('div', { className: 'card', style: { padding: 20, textAlign: 'center' } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.info } }, `${stats.monthlyFuelCost.toFixed(0)}€`),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Carburant/mois')
            ),
            h('div', { className: 'card', style: { padding: 20, textAlign: 'center' } },
                h('div', { style: { fontSize: 28, fontWeight: 700, color: COLORS.purple } }, `${stats.monthlyMaintCost.toFixed(0)}€`),
                h('div', { style: { fontSize: 12, color: COLORS.muted } }, 'Entretien/mois')
            )
        ),

        h('div', { className: 'tabs', style: { marginBottom: 20 } },
            h('button', { className: `tab ${activeTab === 'vehicles' ? 'active' : ''}`, onClick: () => setActiveTab('vehicles') }, '🚗 Véhicules'),
            h('button', { className: `tab ${activeTab === 'fuel' ? 'active' : ''}`, onClick: () => setActiveTab('fuel') }, '⛽ Carburant'),
            h('button', { className: `tab ${activeTab === 'maintenance' ? 'active' : ''}`, onClick: () => setActiveTab('maintenance') }, '🔧 Entretiens'),
            h('button', { className: `tab ${activeTab === 'alerts' ? 'active' : ''}`, onClick: () => setActiveTab('alerts') }, '⚠️ Alertes ', stats.pendingAlerts > 0 && h('span', { className: 'badge badge-danger', style: { marginLeft: 4 } }, stats.pendingAlerts))
        ),

        loading ? h('div', { style: { padding: 40, textAlign: 'center' } }, 'Chargement...') :

        activeTab === 'vehicles' && h('div', { className: 'vehicles-layout', style: { display: 'flex', gap: 20 } },
            h('div', { style: { flex: '0 0 350px' } },
                h('div', { style: { display: 'flex', flexDirection: 'column', gap: 12 } },
                    vehicles.map(vehicle => {
                        const typeInfo = getVehicleTypeInfo(vehicle.type);
                        const hasAlerts = vehicleAlerts.some(a => a.vehicle_id === vehicle.id);
                        return h('div', { key: vehicle.id, className: `card ${selectedVehicle?.id === vehicle.id ? 'selected' : ''}`, style: { cursor: 'pointer', border: hasAlerts ? '2px solid ' + COLORS.warning : selectedVehicle?.id === vehicle.id ? '2px solid ' + COLORS.primary : undefined, padding: 16 }, onClick: () => setSelectedVehicle(vehicle) },
                            h('div', { style: { display: 'flex', gap: 12, alignItems: 'center' } },
                                h('div', { style: { fontSize: 28 } }, typeInfo.icon),
                                h('div', { style: { flex: 1 } },
                                    h('div', { style: { fontWeight: 700 } }, vehicle.name),
                                    h('div', { style: { fontSize: 12, color: COLORS.muted } }, vehicle.plate),
                                    vehicle.brand && h('div', { style: { fontSize: 11, color: COLORS.muted } }, `${vehicle.brand} ${vehicle.model || ''}`)
                                ),
                                h('div', { style: { textAlign: 'right', fontSize: 11 } },
                                    h('div', null, getUserName(vehicle.assigned_to)),
                                    vehicle.current_mileage && h('div', { style: { color: COLORS.muted } }, `${vehicle.current_mileage.toLocaleString()} km`)
                                )
                            ),
                            hasAlerts && h('div', { style: { marginTop: 8, padding: 6, background: COLORS.warningPastel, borderRadius: 4, fontSize: 11, color: COLORS.warning } }, '⚠️ Alertes en attente')
                        );
                    }),
                    vehicles.length === 0 && h('div', { className: 'card', style: { padding: 30, textAlign: 'center' } },
                        h('div', { style: { fontSize: 40, marginBottom: 12 } }, '🚗'),
                        h('p', { style: { color: COLORS.muted } }, 'Aucun véhicule')
                    )
                )
            ),

            selectedVehicle && h('div', { style: { flex: 1 } },
                h('div', { className: 'card' },
                    h('div', { style: { padding: 20, borderBottom: '1px solid ' + COLORS.border } },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
                            h('div', { style: { display: 'flex', gap: 16, alignItems: 'center' } },
                                h('div', { style: { fontSize: 48 } }, getVehicleTypeInfo(selectedVehicle.type).icon),
                                h('div', null,
                                    h('h2', { style: { margin: 0 } }, selectedVehicle.name),
                                    h('div', { style: { fontSize: 18, color: COLORS.muted } }, selectedVehicle.plate),
                                    selectedVehicle.brand && h('div', { style: { marginTop: 4 } }, `${selectedVehicle.brand} ${selectedVehicle.model || ''} ${selectedVehicle.year || ''}`)
                                )
                            ),
                            h('div', { style: { display: 'flex', gap: 8 } },
                                h('button', { className: 'btn btn-sm btn-secondary', onClick: () => { setVehicleForm(selectedVehicle); setEditingItem(selectedVehicle); setShowVehicleModal(true); } }, '✏️ Modifier'),
                                h('button', { className: 'btn btn-sm btn-primary', onClick: () => setShowAddStockModal(true) }, '+ Stock')
                            )
                        )
                    ),

                    h('div', { style: { padding: 20 } },
                        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16, marginBottom: 20 } },
                            h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, '👤 Assigné à'),
                                h('div', { style: { fontWeight: 600 } }, getUserName(selectedVehicle.assigned_to))
                            ),
                            h('div', { style: { padding: 16, background: COLORS.background, borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, '📍 Kilométrage'),
                                h('div', { style: { fontWeight: 600 } }, selectedVehicle.current_mileage ? `${selectedVehicle.current_mileage.toLocaleString()} km` : '-')
                            ),
                            h('div', { style: { padding: 16, background: selectedVehicle.ct_expiry && new Date(selectedVehicle.ct_expiry) < new Date(Date.now() + 30*24*60*60*1000) ? COLORS.warningPastel : COLORS.background, borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, '📋 CT expire'),
                                h('div', { style: { fontWeight: 600 } }, selectedVehicle.ct_expiry ? new Date(selectedVehicle.ct_expiry).toLocaleDateString('fr-FR') : '-')
                            ),
                            h('div', { style: { padding: 16, background: selectedVehicle.insurance_expiry && new Date(selectedVehicle.insurance_expiry) < new Date(Date.now() + 30*24*60*60*1000) ? COLORS.warningPastel : COLORS.background, borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 11, color: COLORS.muted, marginBottom: 4 } }, '🛡️ Assurance'),
                                h('div', { style: { fontWeight: 600 } }, selectedVehicle.insurance_expiry ? new Date(selectedVehicle.insurance_expiry).toLocaleDateString('fr-FR') : '-')
                            )
                        ),

                        selectedVehicle.vin && h('div', { style: { marginBottom: 16, padding: 12, background: COLORS.background, borderRadius: 8 } },
                            h('span', { style: { fontSize: 12, color: COLORS.muted } }, 'VIN: '),
                            h('span', { style: { fontFamily: 'monospace' } }, selectedVehicle.vin)
                        ),

                        h('h4', { style: { marginBottom: 12 } }, '📦 Stock embarqué'),
                        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12, marginBottom: 16 } },
                            h('div', { style: { padding: 12, background: COLORS.primaryPastel, borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 20, fontWeight: 700, color: COLORS.primary } }, currentVehicleStock.length),
                                h('div', { style: { fontSize: 11 } }, 'Références')
                            ),
                            h('div', { style: { padding: 12, background: COLORS.successPastel, borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 20, fontWeight: 700, color: COLORS.success } }, currentVehicleStock.reduce((sum, s) => sum + s.quantity, 0)),
                                h('div', { style: { fontSize: 11 } }, 'Quantité')
                            ),
                            h('div', { style: { padding: 12, background: COLORS.infoPastel, borderRadius: 8, textAlign: 'center' } },
                                h('div', { style: { fontSize: 20, fontWeight: 700, color: COLORS.info } }, totalStockValue.toLocaleString() + '€'),
                                h('div', { style: { fontSize: 11 } }, 'Valeur')
                            )
                        ),

                        currentVehicleStock.length > 0 && h('table', { className: 'table', style: { fontSize: 13 } },
                            h('thead', null,
                                h('tr', null,
                                    h('th', null, 'Référence'),
                                    h('th', null, 'Désignation'),
                                    h('th', null, 'Qté'),
                                    h('th', null, 'Actions')
                                )
                            ),
                            h('tbody', null,
                                currentVehicleStock.slice(0, 10).map(item => {
                                    const part = getPartInfo(item.partId);
                                    return h('tr', { key: item.partId },
                                        h('td', null, h('span', { className: 'badge badge-secondary' }, part?.reference || '-')),
                                        h('td', null, part?.name || 'Inconnu'),
                                        h('td', null, h('strong', null, item.quantity)),
                                        h('td', null,
                                            h('div', { style: { display: 'flex', gap: 4 } },
                                                h('button', { className: 'btn btn-xs btn-ghost', onClick: () => removeFromVehicleStock(selectedVehicle.id, item.partId, 1, true) }, '−'),
                                                h('button', { className: 'btn btn-xs btn-ghost', onClick: () => addToVehicleStock(selectedVehicle.id, item.partId, 1, true) }, '+')
                                            )
                                        )
                                    );
                                })
                            )
                        ),
                        currentVehicleStock.length === 0 && h('p', { style: { color: COLORS.muted, textAlign: 'center', padding: 20 } }, 'Aucun article dans ce véhicule')
                    )
                )
            )
        ),

        activeTab === 'fuel' && h('div', null,
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 } },
                h('div', null,
                    h('h3', { style: { margin: 0 } }, '⛽ Dépenses carburant'),
                    h('p', { style: { margin: 0, color: COLORS.muted, fontSize: 13 } }, `Ce mois: ${stats.monthlyFuelCost.toFixed(2)}€ • ${stats.monthlyLiters.toFixed(1)}L • Moy: ${stats.avgFuelPrice}€/L`)
                ),
                h('button', { className: 'btn btn-primary', onClick: () => { setFuelForm(emptyFuelForm); setEditingItem(null); setShowFuelModal(true); } }, '+ Ajouter plein')
            ),
            h('div', { className: 'card' },
                h('table', { className: 'table' },
                    h('thead', null, h('tr', null, h('th', null, 'Date'), h('th', null, 'Véhicule'), h('th', null, 'Km'), h('th', null, 'Litres'), h('th', null, 'Prix/L'), h('th', null, 'Total'), h('th', null, ''))),
                    h('tbody', null,
                        fuelExpenses.slice(0, 50).map(exp => {
                            const v = vehicles.find(v => v.id === exp.vehicle_id);
                            return h('tr', { key: exp.id },
                                h('td', null, exp.date ? new Date(exp.date).toLocaleDateString('fr-FR') : '-'),
                                h('td', null, v?.name || '-'),
                                h('td', null, exp.mileage ? `${exp.mileage.toLocaleString()}` : '-'),
                                h('td', null, exp.liters ? `${exp.liters}L` : '-'),
                                h('td', null, exp.price_per_liter ? `${exp.price_per_liter}€` : '-'),
                                h('td', null, h('strong', null, `${(exp.total_amount || 0).toFixed(2)}€`)),
                                h('td', null, h('button', { className: 'btn btn-sm btn-ghost', onClick: () => { setFuelForm(exp); setEditingItem(exp); setShowFuelModal(true); } }, '✏️'))
                            );
                        }),
                        fuelExpenses.length === 0 && h('tr', null, h('td', { colSpan: 7, style: { textAlign: 'center', padding: 30, color: COLORS.muted } }, 'Aucune dépense'))
                    )
                )
            )
        ),

        activeTab === 'maintenance' && h('div', null,
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20 } },
                h('div', null,
                    h('h3', { style: { margin: 0 } }, '🔧 Entretiens'),
                    h('p', { style: { margin: 0, color: COLORS.muted, fontSize: 13 } }, `Ce mois: ${stats.monthlyMaintCost.toFixed(2)}€`)
                ),
                h('button', { className: 'btn btn-primary', onClick: () => { setMaintenanceForm(emptyMaintenanceForm); setEditingItem(null); setShowMaintenanceModal(true); } }, '+ Ajouter entretien')
            ),
            h('div', { className: 'card' },
                h('table', { className: 'table' },
                    h('thead', null, h('tr', null, h('th', null, 'Date'), h('th', null, 'Véhicule'), h('th', null, 'Type'), h('th', null, 'Description'), h('th', null, 'Coût'), h('th', null, 'Prochain'), h('th', null, ''))),
                    h('tbody', null,
                        maintenanceRecords.slice(0, 50).map(rec => {
                            const v = vehicles.find(v => v.id === rec.vehicle_id);
                            const typeInfo = maintenanceTypes.find(t => t.id === rec.type) || maintenanceTypes[5];
                            return h('tr', { key: rec.id },
                                h('td', null, rec.date ? new Date(rec.date).toLocaleDateString('fr-FR') : '-'),
                                h('td', null, v?.name || '-'),
                                h('td', null, h('span', { className: 'badge badge-secondary' }, typeInfo.icon, ' ', typeInfo.label)),
                                h('td', null, rec.description || '-'),
                                h('td', null, rec.cost ? `${rec.cost}€` : '-'),
                                h('td', null, rec.next_date && h('span', { style: { fontSize: 12 } }, new Date(rec.next_date).toLocaleDateString('fr-FR'))),
                                h('td', null, h('button', { className: 'btn btn-sm btn-ghost', onClick: () => { setMaintenanceForm(rec); setEditingItem(rec); setShowMaintenanceModal(true); } }, '✏️'))
                            );
                        }),
                        maintenanceRecords.length === 0 && h('tr', null, h('td', { colSpan: 7, style: { textAlign: 'center', padding: 30, color: COLORS.muted } }, 'Aucun entretien'))
                    )
                )
            )
        ),

        activeTab === 'alerts' && h('div', null,
            h('h3', { style: { marginBottom: 20 } }, `⚠️ Alertes (${vehicleAlerts.length})`),
            vehicleAlerts.length === 0 ? h('div', { className: 'card', style: { padding: 40, textAlign: 'center' } }, h('div', { style: { fontSize: 48, marginBottom: 16 } }, '✅'), h('p', { style: { color: COLORS.muted } }, 'Aucune alerte')) :
            h('div', { style: { display: 'flex', flexDirection: 'column', gap: 12 } },
                vehicleAlerts.map(alert => {
                    const v = vehicles.find(v => v.id === alert.vehicle_id);
                    return h('div', { key: alert.id, className: 'card', style: { padding: 16, borderLeft: '4px solid ' + COLORS.warning } },
                        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' } },
                            h('div', null,
                                h('div', { style: { fontWeight: 600, marginBottom: 4 } }, alert.title),
                                h('div', { style: { fontSize: 13, color: COLORS.muted } }, alert.description),
                                alert.due_date && h('div', { style: { fontSize: 12, marginTop: 8 } }, '📅 ', new Date(alert.due_date).toLocaleDateString('fr-FR'))
                            ),
                            h('button', { className: 'btn btn-sm btn-secondary', onClick: async () => { await db.from('vehicle_alerts').update({ status: 'acknowledged' }).eq('id', alert.id); loadFleetData(); showToast('Alerte acquittée'); } }, '✓ OK')
                        )
                    );
                })
            )
        ),

        showVehicleModal && h(Modal, { isOpen: true, onClose: () => setShowVehicleModal(false), title: editingItem ? 'Modifier véhicule' : 'Nouveau véhicule', size: 'lg' },
            h('div', null,
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Nom *'), h('input', { className: 'form-input', value: vehicleForm.name, onChange: e => setVehicleForm({...vehicleForm, name: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Immatriculation *'), h('input', { className: 'form-input', value: vehicleForm.plate, onChange: e => setVehicleForm({...vehicleForm, plate: e.target.value.toUpperCase()}) }))
                ),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Type'), h('select', { className: 'form-select', value: vehicleForm.type, onChange: e => setVehicleForm({...vehicleForm, type: e.target.value}) }, vehicleTypes.map(t => h('option', { key: t.id, value: t.id }, `${t.icon} ${t.label}`)))),
                    h('div', { className: 'form-group' }, h('label', null, 'Assigné à'), h('select', { className: 'form-select', value: vehicleForm.assigned_to || '', onChange: e => setVehicleForm({...vehicleForm, assigned_to: e.target.value}) }, h('option', { value: '' }, 'Non assigné'), (data.users || []).filter(u => u.role === 'technicien' || u.role === 'admin').map(u => h('option', { key: u.id, value: u.id }, `${u.first_name || ''} ${u.last_name || ''}`.trim() || u.email))))
                ),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Marque'), h('input', { className: 'form-input', value: vehicleForm.brand || '', onChange: e => setVehicleForm({...vehicleForm, brand: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Modèle'), h('input', { className: 'form-input', value: vehicleForm.model || '', onChange: e => setVehicleForm({...vehicleForm, model: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Année'), h('input', { type: 'number', className: 'form-input', value: vehicleForm.year || '', onChange: e => setVehicleForm({...vehicleForm, year: parseInt(e.target.value) || ''}) }))
                ),
                h('div', { className: 'form-group' }, h('label', null, 'VIN'), h('input', { className: 'form-input', value: vehicleForm.vin || '', onChange: e => setVehicleForm({...vehicleForm, vin: e.target.value}) })),
                h('hr', { style: { margin: '20px 0' } }),
                h('h4', null, '📋 Contrôle Technique'),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Date dernier CT'), h('input', { type: 'date', className: 'form-input', value: vehicleForm.ct_date || '', onChange: e => setVehicleForm({...vehicleForm, ct_date: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Expiration CT'), h('input', { type: 'date', className: 'form-input', value: vehicleForm.ct_expiry || '', onChange: e => setVehicleForm({...vehicleForm, ct_expiry: e.target.value}) }))
                ),
                h('h4', null, '🛡️ Assurance'),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Compagnie'), h('input', { className: 'form-input', value: vehicleForm.insurance_company || '', onChange: e => setVehicleForm({...vehicleForm, insurance_company: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'N° Police'), h('input', { className: 'form-input', value: vehicleForm.insurance_number || '', onChange: e => setVehicleForm({...vehicleForm, insurance_number: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Expiration'), h('input', { type: 'date', className: 'form-input', value: vehicleForm.insurance_expiry || '', onChange: e => setVehicleForm({...vehicleForm, insurance_expiry: e.target.value}) }))
                ),
                h('h4', null, '🔧 Entretien'),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Kilométrage actuel'), h('input', { type: 'number', className: 'form-input', value: vehicleForm.current_mileage || '', onChange: e => setVehicleForm({...vehicleForm, current_mileage: parseInt(e.target.value) || 0}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Prochain entretien (km)'), h('input', { type: 'number', className: 'form-input', value: vehicleForm.next_service_mileage || '', onChange: e => setVehicleForm({...vehicleForm, next_service_mileage: parseInt(e.target.value) || ''}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Prochain entretien (date)'), h('input', { type: 'date', className: 'form-input', value: vehicleForm.next_service_date || '', onChange: e => setVehicleForm({...vehicleForm, next_service_date: e.target.value}) }))
                ),
                h('div', { className: 'form-group' }, h('label', null, 'Notes'), h('textarea', { className: 'form-input', rows: 2, value: vehicleForm.notes || '', onChange: e => setVehicleForm({...vehicleForm, notes: e.target.value}) })),
                h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end', marginTop: 20 } },
                    h('button', { className: 'btn btn-secondary', onClick: () => setShowVehicleModal(false) }, 'Annuler'),
                    h('button', { className: 'btn btn-primary', onClick: saveVehicle, disabled: !vehicleForm.name || !vehicleForm.plate }, 'Enregistrer')
                )
            )
        ),

        showFuelModal && h(Modal, { isOpen: true, onClose: () => setShowFuelModal(false), title: editingItem ? 'Modifier dépense' : 'Nouveau plein', size: 'md' },
            h('div', null,
                h('div', { className: 'form-group' }, h('label', null, 'Véhicule *'), h('select', { className: 'form-select', value: fuelForm.vehicle_id || '', onChange: e => setFuelForm({...fuelForm, vehicle_id: e.target.value}) }, h('option', { value: '' }, '-- Sélectionner --'), vehicles.map(v => h('option', { key: v.id, value: v.id }, `${v.name} (${v.plate})`)))),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Date'), h('input', { type: 'date', className: 'form-input', value: fuelForm.date || '', onChange: e => setFuelForm({...fuelForm, date: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Kilométrage'), h('input', { type: 'number', className: 'form-input', value: fuelForm.mileage || '', onChange: e => setFuelForm({...fuelForm, mileage: e.target.value}) }))
                ),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Litres'), h('input', { type: 'number', step: '0.01', className: 'form-input', value: fuelForm.liters || '', onChange: e => setFuelForm({...fuelForm, liters: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Prix/L'), h('input', { type: 'number', step: '0.001', className: 'form-input', value: fuelForm.price_per_liter || '', onChange: e => setFuelForm({...fuelForm, price_per_liter: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Total €'), h('input', { type: 'number', step: '0.01', className: 'form-input', value: fuelForm.total_amount || '', onChange: e => setFuelForm({...fuelForm, total_amount: e.target.value}) }))
                ),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Type'), h('select', { className: 'form-select', value: fuelForm.fuel_type || 'diesel', onChange: e => setFuelForm({...fuelForm, fuel_type: e.target.value}) }, fuelTypes.map(t => h('option', { key: t.id, value: t.id }, t.label)))),
                    h('div', { className: 'form-group' }, h('label', null, 'Station'), h('input', { className: 'form-input', value: fuelForm.station || '', onChange: e => setFuelForm({...fuelForm, station: e.target.value}) }))
                ),
                h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end', marginTop: 20 } },
                    h('button', { className: 'btn btn-secondary', onClick: () => setShowFuelModal(false) }, 'Annuler'),
                    h('button', { className: 'btn btn-primary', onClick: saveFuelExpense, disabled: !fuelForm.vehicle_id }, 'Enregistrer')
                )
            )
        ),

        showMaintenanceModal && h(Modal, { isOpen: true, onClose: () => setShowMaintenanceModal(false), title: editingItem ? 'Modifier entretien' : 'Nouvel entretien', size: 'md' },
            h('div', null,
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Véhicule *'), h('select', { className: 'form-select', value: maintenanceForm.vehicle_id || '', onChange: e => setMaintenanceForm({...maintenanceForm, vehicle_id: e.target.value}) }, h('option', { value: '' }, '-- Sélectionner --'), vehicles.map(v => h('option', { key: v.id, value: v.id }, `${v.name} (${v.plate})`)))),
                    h('div', { className: 'form-group' }, h('label', null, 'Type'), h('select', { className: 'form-select', value: maintenanceForm.type || 'oil_change', onChange: e => setMaintenanceForm({...maintenanceForm, type: e.target.value}) }, maintenanceTypes.map(t => h('option', { key: t.id, value: t.id }, `${t.icon} ${t.label}`))))
                ),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Date'), h('input', { type: 'date', className: 'form-input', value: maintenanceForm.date || '', onChange: e => setMaintenanceForm({...maintenanceForm, date: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Kilométrage'), h('input', { type: 'number', className: 'form-input', value: maintenanceForm.mileage || '', onChange: e => setMaintenanceForm({...maintenanceForm, mileage: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Coût €'), h('input', { type: 'number', step: '0.01', className: 'form-input', value: maintenanceForm.cost || '', onChange: e => setMaintenanceForm({...maintenanceForm, cost: e.target.value}) }))
                ),
                h('div', { className: 'form-group' }, h('label', null, 'Description'), h('textarea', { className: 'form-input', rows: 2, value: maintenanceForm.description || '', onChange: e => setMaintenanceForm({...maintenanceForm, description: e.target.value}) })),
                h('div', { className: 'form-group' }, h('label', null, 'Prestataire'), h('input', { className: 'form-input', value: maintenanceForm.provider || '', onChange: e => setMaintenanceForm({...maintenanceForm, provider: e.target.value}) })),
                h('hr', { style: { margin: '16px 0' } }),
                h('h4', { style: { marginBottom: 12 } }, 'Prochain entretien'),
                h('div', { className: 'form-row' },
                    h('div', { className: 'form-group' }, h('label', null, 'Date'), h('input', { type: 'date', className: 'form-input', value: maintenanceForm.next_date || '', onChange: e => setMaintenanceForm({...maintenanceForm, next_date: e.target.value}) })),
                    h('div', { className: 'form-group' }, h('label', null, 'Kilométrage'), h('input', { type: 'number', className: 'form-input', value: maintenanceForm.next_mileage || '', onChange: e => setMaintenanceForm({...maintenanceForm, next_mileage: e.target.value}) }))
                ),
                h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end', marginTop: 20 } },
                    h('button', { className: 'btn btn-secondary', onClick: () => setShowMaintenanceModal(false) }, 'Annuler'),
                    h('button', { className: 'btn btn-primary', onClick: saveMaintenance, disabled: !maintenanceForm.vehicle_id }, 'Enregistrer')
                )
            )
        ),

        showAddStockModal && selectedVehicle && h(Modal, { isOpen: true, onClose: () => setShowAddStockModal(false), title: `Ajouter stock à ${selectedVehicle.name}`, size: 'md' },
            h('div', null,
                h('div', { className: 'form-group' },
                    h('label', null, 'Rechercher pièce'),
                    h('input', { className: 'form-input', placeholder: 'Référence ou nom...', value: stockSearch, onChange: e => setStockSearch(e.target.value) })
                ),
                h('div', { style: { maxHeight: 300, overflowY: 'auto' } },
                    (data.parts || []).filter(p => !stockSearch || p.name?.toLowerCase().includes(stockSearch.toLowerCase()) || p.reference?.toLowerCase().includes(stockSearch.toLowerCase())).slice(0, 20).map(part =>
                        h('div', { key: part.id, onClick: () => setSelectedPartToAdd(part), style: { padding: 12, cursor: 'pointer', borderRadius: 8, marginBottom: 8, background: selectedPartToAdd?.id === part.id ? COLORS.primaryPastel : COLORS.background, border: selectedPartToAdd?.id === part.id ? '2px solid ' + COLORS.primary : '2px solid transparent' } },
                            h('div', { style: { fontWeight: 600 } }, part.reference),
                            h('div', { style: { fontSize: 13, color: COLORS.muted } }, part.name),
                            h('div', { style: { fontSize: 12, marginTop: 4 } }, 'Stock: ', part.quantity || 0)
                        )
                    )
                ),
                selectedPartToAdd && h('div', { style: { marginTop: 16, padding: 16, background: COLORS.background, borderRadius: 8 } },
                    h('div', { style: { marginBottom: 12 } }, h('strong', null, selectedPartToAdd.name)),
                    h('div', { className: 'form-row' },
                        h('div', { className: 'form-group' },
                            h('label', null, 'Quantité'),
                            h('input', { type: 'number', className: 'form-input', min: 1, value: quantityToAdd, onChange: e => setQuantityToAdd(parseInt(e.target.value) || 1) })
                        )
                    )
                ),
                h('div', { style: { display: 'flex', gap: 12, justifyContent: 'flex-end', marginTop: 20 } },
                    h('button', { className: 'btn btn-secondary', onClick: () => setShowAddStockModal(false) }, 'Annuler'),
                    h('button', { className: 'btn btn-primary', disabled: !selectedPartToAdd, onClick: () => { addToVehicleStock(selectedVehicle.id, selectedPartToAdd.id, quantityToAdd, true); setShowAddStockModal(false); setSelectedPartToAdd(null); setStockSearch(''); setQuantityToAdd(1); showToast('Stock ajouté au véhicule'); } }, 'Ajouter')
                )
            )
        )
    );
};


// ============================================================================
// 9. COMPARAISON PÉRIODES
// ============================================================================

const PeriodComparisonService = {
    calculateStats(data, startDate, endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);

        const tasks = (data.tasks || []).filter(t => {
            const d = new Date(t.created_at || t.scheduled_date);
            return d >= start && d <= end;
        });

        const completedTasks = tasks.filter(t => t.status === 'termine');
        const orders = (data.orders || []).filter(o => {
            const d = new Date(o.created_at);
            return d >= start && d <= end;
        });

        const stockMovements = (data.stockMovements || []).filter(m => {
            const d = new Date(m.created_at);
            return d >= start && d <= end;
        });

        return {
            period: { start: startDate, end: endDate },
            tasks: {
                total: tasks.length,
                completed: completedTasks.length,
                completionRate: tasks.length > 0 ? Math.round((completedTasks.length / tasks.length) * 100) : 0,
                urgent: tasks.filter(t => t.priority === 'urgent' || t.priority === 'urgente').length
            },
            orders: {
                total: orders.length,
                received: orders.filter(o => o.status === 'recu').length,
                pending: orders.filter(o => o.status === 'en-commande').length,
                totalValue: orders.reduce((sum, o) => sum + (o.total_price || 0), 0)
            },
            stock: {
                movements: stockMovements.length,
                entries: stockMovements.filter(m => m.type === 'entree').length,
                exits: stockMovements.filter(m => m.type === 'sortie').length
            }
        };
    },

    compare(stats1, stats2) {
        const calcChange = (v1, v2) => {
            if (v2 === 0) return v1 > 0 ? 100 : 0;
            return Math.round(((v1 - v2) / v2) * 100);
        };

        return {
            tasks: {
                totalChange: calcChange(stats1.tasks.total, stats2.tasks.total),
                completedChange: calcChange(stats1.tasks.completed, stats2.tasks.completed),
                completionRateChange: stats1.tasks.completionRate - stats2.tasks.completionRate
            },
            orders: {
                totalChange: calcChange(stats1.orders.total, stats2.orders.total),
                valueChange: calcChange(stats1.orders.totalValue, stats2.orders.totalValue)
            },
            stock: {
                movementsChange: calcChange(stats1.stock.movements, stats2.stock.movements)
            }
        };
    },

    getPeriodPresets() {
        const now = new Date();
        const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
        const thisQuarter = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 1);
        const lastQuarter = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3 - 3, 1);
        const lastQuarterEnd = new Date(now.getFullYear(), Math.floor(now.getMonth() / 3) * 3, 0);
        const thisYear = new Date(now.getFullYear(), 0, 1);
        const lastYear = new Date(now.getFullYear() - 1, 0, 1);
        const lastYearEnd = new Date(now.getFullYear() - 1, 11, 31);

        return [
            { 
                id: 'month', 
                label: 'Mois en cours vs précédent',
                period1: { start: thisMonth.toISOString().split('T')[0], end: now.toISOString().split('T')[0] },
                period2: { start: lastMonth.toISOString().split('T')[0], end: lastMonthEnd.toISOString().split('T')[0] }
            },
            { 
                id: 'quarter', 
                label: 'Trimestre en cours vs précédent',
                period1: { start: thisQuarter.toISOString().split('T')[0], end: now.toISOString().split('T')[0] },
                period2: { start: lastQuarter.toISOString().split('T')[0], end: lastQuarterEnd.toISOString().split('T')[0] }
            },
            { 
                id: 'year', 
                label: 'Année en cours vs précédente',
                period1: { start: thisYear.toISOString().split('T')[0], end: now.toISOString().split('T')[0] },
                period2: { start: lastYear.toISOString().split('T')[0], end: lastYearEnd.toISOString().split('T')[0] }
            }
        ];
    }
};

/**
 * Composant de comparaison de périodes
 */
const PeriodComparisonWidget = ({ data }) => {
    const presets = PeriodComparisonService.getPeriodPresets();
    const [selectedPreset, setSelectedPreset] = useState(presets[0]);
    const [customPeriods, setCustomPeriods] = useState(null);
    const [showCustom, setShowCustom] = useState(false);

    const activePeriods = customPeriods || selectedPreset;
    
    const stats1 = useMemo(() => 
        PeriodComparisonService.calculateStats(data, activePeriods.period1.start, activePeriods.period1.end),
        [data, activePeriods]
    );
    
    const stats2 = useMemo(() => 
        PeriodComparisonService.calculateStats(data, activePeriods.period2.start, activePeriods.period2.end),
        [data, activePeriods]
    );

    const comparison = useMemo(() => 
        PeriodComparisonService.compare(stats1, stats2),
        [stats1, stats2]
    );

    const formatChange = (value, suffix = '') => {
        const sign = value > 0 ? '+' : '';
        const color = value > 0 ? 'var(--success)' : value < 0 ? 'var(--danger)' : 'var(--muted)';
        return h('span', { style: { color } }, `${sign}${value}${suffix}`);
    };

    const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });

    return h('div', { className: 'period-comparison' },
        h('div', { className: 'comparison-header' },
            h('h3', null, '📊 Comparaison de périodes'),
            h('div', { className: 'comparison-presets' },
                presets.map(preset => h('button', {
                    key: preset.id,
                    className: `btn btn-sm ${selectedPreset.id === preset.id && !customPeriods ? 'btn-primary' : 'btn-ghost'}`,
                    onClick: () => { setSelectedPreset(preset); setCustomPeriods(null); }
                }, preset.label)),
                h('button', {
                    className: `btn btn-sm ${showCustom ? 'btn-primary' : 'btn-ghost'}`,
                    onClick: () => setShowCustom(!showCustom)
                }, '📅 Personnalisé')
            )
        ),

        showCustom && h('div', { className: 'comparison-custom' },
            h('div', { className: 'comparison-period' },
                h('label', null, 'Période 1'),
                h('input', { 
                    type: 'date',
                    onChange: e => setCustomPeriods(prev => ({
                        ...prev,
                        period1: { ...prev?.period1, start: e.target.value }
                    }))
                }),
                h('span', null, 'à'),
                h('input', { 
                    type: 'date',
                    onChange: e => setCustomPeriods(prev => ({
                        ...prev,
                        period1: { ...prev?.period1, end: e.target.value }
                    }))
                })
            ),
            h('div', { className: 'comparison-period' },
                h('label', null, 'Période 2'),
                h('input', { 
                    type: 'date',
                    onChange: e => setCustomPeriods(prev => ({
                        ...prev,
                        period2: { ...prev?.period2, start: e.target.value }
                    }))
                }),
                h('span', null, 'à'),
                h('input', { 
                    type: 'date',
                    onChange: e => setCustomPeriods(prev => ({
                        ...prev,
                        period2: { ...prev?.period2, end: e.target.value }
                    }))
                })
            )
        ),

        h('div', { className: 'comparison-periods-label' },
            h('div', { className: 'period-label period-1' },
                h('span', { className: 'period-dot' }),
                formatDate(activePeriods.period1.start), ' - ', formatDate(activePeriods.period1.end)
            ),
            h('span', null, 'vs'),
            h('div', { className: 'period-label period-2' },
                h('span', { className: 'period-dot' }),
                formatDate(activePeriods.period2.start), ' - ', formatDate(activePeriods.period2.end)
            )
        ),

        h('div', { className: 'comparison-grid' },
            // Tâches
            h('div', { className: 'comparison-card' },
                h('div', { className: 'comparison-card-header' },
                    h('span', null, '📋 Tâches'),
                    formatChange(comparison.tasks.totalChange, '%')
                ),
                h('div', { className: 'comparison-values' },
                    h('div', { className: 'comparison-value period-1' },
                        h('span', { className: 'value' }, stats1.tasks.total),
                        h('span', { className: 'label' }, 'Total')
                    ),
                    h('div', { className: 'comparison-value period-2' },
                        h('span', { className: 'value' }, stats2.tasks.total),
                        h('span', { className: 'label' }, 'Total')
                    )
                ),
                h('div', { className: 'comparison-sub' },
                    h('span', null, 'Taux de complétion: ', stats1.tasks.completionRate, '% vs ', stats2.tasks.completionRate, '%'),
                    formatChange(comparison.tasks.completionRateChange, ' pts')
                )
            ),

            // Commandes
            h('div', { className: 'comparison-card' },
                h('div', { className: 'comparison-card-header' },
                    h('span', null, '🛒 Commandes'),
                    formatChange(comparison.orders.totalChange, '%')
                ),
                h('div', { className: 'comparison-values' },
                    h('div', { className: 'comparison-value period-1' },
                        h('span', { className: 'value' }, stats1.orders.total),
                        h('span', { className: 'label' }, 'Total')
                    ),
                    h('div', { className: 'comparison-value period-2' },
                        h('span', { className: 'value' }, stats2.orders.total),
                        h('span', { className: 'label' }, 'Total')
                    )
                ),
                h('div', { className: 'comparison-sub' },
                    h('span', null, 'Valeur: ', stats1.orders.totalValue.toLocaleString(), '€ vs ', stats2.orders.totalValue.toLocaleString(), '€'),
                    formatChange(comparison.orders.valueChange, '%')
                )
            ),

            // Stock
            h('div', { className: 'comparison-card' },
                h('div', { className: 'comparison-card-header' },
                    h('span', null, '📦 Mouvements stock'),
                    formatChange(comparison.stock.movementsChange, '%')
                ),
                h('div', { className: 'comparison-values' },
                    h('div', { className: 'comparison-value period-1' },
                        h('span', { className: 'value' }, stats1.stock.movements),
                        h('span', { className: 'label' }, 'Mouvements')
                    ),
                    h('div', { className: 'comparison-value period-2' },
                        h('span', { className: 'value' }, stats2.stock.movements),
                        h('span', { className: 'label' }, 'Mouvements')
                    )
                ),
                h('div', { className: 'comparison-sub' },
                    h('span', null, 'Entrées: ', stats1.stock.entries, ' | Sorties: ', stats1.stock.exits)
                )
            )
        )
    );
};

// ============================================================================
// 10. MODE HORS-LIGNE AVANCÉ
// ============================================================================

const OfflineServiceV52 = {
    QUEUE_KEY: 'stockapp-offline-queue',
    CACHE_KEY: 'stockapp-offline-cache',
    LAST_SYNC_KEY: 'stockapp-last-sync',

    isOnline() {
        return navigator.onLine;
    },

    // File d'attente des actions hors-ligne
    getQueue() {
        try {
            return JSON.parse(localStorage.getItem(this.QUEUE_KEY) || '[]');
        } catch {
            return [];
        }
    },

    addToQueue(action) {
        const queue = this.getQueue();
        queue.push({
            id: `action_${Date.now()}`,
            ...action,
            timestamp: new Date().toISOString(),
            retries: 0
        });
        localStorage.setItem(this.QUEUE_KEY, JSON.stringify(queue));
        return queue;
    },

    removeFromQueue(actionId) {
        const queue = this.getQueue().filter(a => a.id !== actionId);
        localStorage.setItem(this.QUEUE_KEY, JSON.stringify(queue));
        return queue;
    },

    clearQueue() {
        localStorage.removeItem(this.QUEUE_KEY);
    },

    // Cache des données
    getCache() {
        try {
            return JSON.parse(localStorage.getItem(this.CACHE_KEY) || '{}');
        } catch {
            return {};
        }
    },

    updateCache(key, data) {
        const cache = this.getCache();
        cache[key] = {
            data,
            timestamp: new Date().toISOString()
        };
        localStorage.setItem(this.CACHE_KEY, JSON.stringify(cache));
    },

    getCachedData(key) {
        const cache = this.getCache();
        return cache[key]?.data;
    },

    getLastSync() {
        return localStorage.getItem(this.LAST_SYNC_KEY);
    },

    setLastSync() {
        localStorage.setItem(this.LAST_SYNC_KEY, new Date().toISOString());
    },

    // Synchronisation
    async syncQueue(executeAction) {
        if (!this.isOnline()) return { success: false, reason: 'offline' };

        const queue = this.getQueue();
        const results = { success: [], failed: [] };

        for (const action of queue) {
            try {
                await executeAction(action);
                this.removeFromQueue(action.id);
                results.success.push(action);
            } catch (error) {
                action.retries++;
                action.lastError = error.message;
                
                if (action.retries >= 3) {
                    results.failed.push(action);
                    this.removeFromQueue(action.id);
                }
            }
        }

        if (results.success.length > 0) {
            this.setLastSync();
        }

        return results;
    },

    // Résolution de conflits
    resolveConflict(localData, serverData, strategy = 'server-wins') {
        switch (strategy) {
            case 'server-wins':
                return serverData;
            case 'local-wins':
                return localData;
            case 'merge':
                return { ...serverData, ...localData };
            case 'newest':
                const localTime = new Date(localData.updated_at || 0);
                const serverTime = new Date(serverData.updated_at || 0);
                return localTime > serverTime ? localData : serverData;
            default:
                return serverData;
        }
    }
};

/**
 * Hook pour le mode hors-ligne
 */
const useOfflineMode = (supabase, onSync) => {
    const [isOnline, setIsOnline] = useState(navigator.onLine);
    const [queue, setQueue] = useState(OfflineService.getQueue());
    const [isSyncing, setIsSyncing] = useState(false);
    const [lastSync, setLastSync] = useState(OfflineService.getLastSync());
    const [conflicts, setConflicts] = useState([]);

    // Écouter les changements de connexion
    useEffect(() => {
        const handleOnline = () => {
            setIsOnline(true);
            // Auto-sync quand on revient en ligne
            syncNow();
        };
        const handleOffline = () => setIsOnline(false);

        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);

        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
        };
    }, []);

    // Ajouter une action à la file
    const queueAction = (type, table, data) => {
        const updated = OfflineService.addToQueue({ type, table, data });
        setQueue(updated);
    };

    // Exécuter une action (utilisé lors de la sync)
    const executeAction = async (action) => {
        if (!supabase) throw new Error('Supabase non disponible');

        switch (action.type) {
            case 'insert':
                const { error: insertError } = await supabase.from(action.table).insert(action.data);
                if (insertError) throw insertError;
                break;
            case 'update':
                const { error: updateError } = await supabase.from(action.table).update(action.data).eq('id', action.data.id);
                if (updateError) throw updateError;
                break;
            case 'delete':
                const { error: deleteError } = await supabase.from(action.table).delete().eq('id', action.data.id);
                if (deleteError) throw deleteError;
                break;
        }
    };

    // Synchroniser maintenant
    const syncNow = async () => {
        if (!isOnline || isSyncing) return;

        setIsSyncing(true);
        try {
            const results = await OfflineService.syncQueue(executeAction);
            setQueue(OfflineService.getQueue());
            setLastSync(OfflineService.getLastSync());
            
            if (onSync) {
                onSync(results);
            }
        } finally {
            setIsSyncing(false);
        }
    };

    // Mettre en cache
    const cacheData = (key, data) => {
        OfflineService.updateCache(key, data);
    };

    // Récupérer du cache
    const getCached = (key) => {
        return OfflineService.getCachedData(key);
    };

    return {
        isOnline,
        queue,
        queueLength: queue.length,
        isSyncing,
        lastSync,
        conflicts,
        queueAction,
        syncNow,
        cacheData,
        getCached,
        clearQueue: () => {
            OfflineService.clearQueue();
            setQueue([]);
        }
    };
};

/**
 * Indicateur de statut hors-ligne (v5.2)
 */
const OfflineIndicatorV52 = ({ isOnline, queueLength, isSyncing, lastSync, onSync }) => {
    const [expanded, setExpanded] = useState(false);

    const formatLastSync = (timestamp) => {
        if (!timestamp) return 'Jamais';
        const date = new Date(timestamp);
        const now = new Date();
        const diff = (now - date) / 1000;
        
        if (diff < 60) return 'À l\'instant';
        if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`;
        if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)}h`;
        return date.toLocaleDateString('fr-FR');
    };

    return h('div', { className: `offline-indicator ${isOnline ? 'online' : 'offline'}` },
        h('div', { 
            className: 'offline-indicator-main',
            onClick: () => setExpanded(!expanded)
        },
            h('span', { className: 'offline-status-dot' }),
            h('span', { className: 'offline-status-text' }, 
                isOnline ? 'En ligne' : 'Hors ligne'
            ),
            queueLength > 0 && h('span', { className: 'offline-queue-badge' }, queueLength)
        ),
        
        expanded && h('div', { className: 'offline-indicator-details' },
            h('div', { className: 'offline-detail' },
                h('span', null, 'Dernière sync:'),
                h('span', null, formatLastSync(lastSync))
            ),
            queueLength > 0 && h('div', { className: 'offline-detail' },
                h('span', null, 'Actions en attente:'),
                h('span', null, queueLength)
            ),
            isOnline && queueLength > 0 && h('button', {
                className: 'btn btn-sm btn-primary',
                onClick: onSync,
                disabled: isSyncing
            }, isSyncing ? 'Sync...' : '🔄 Synchroniser'),
            !isOnline && h('p', { className: 'offline-warning' },
                '⚠️ Les modifications seront synchronisées quand vous serez en ligne'
            )
        )
    );
};


// ============================================================================
// 11. PHOTOS ANNOTÉES
// ============================================================================

/**
 * Service pour la gestion des photos annotées (Supabase)
 */
const PhotoService = {
    BUCKET_NAME: 'photos',

    // Upload une photo annotée vers Supabase Storage
    async upload(blob, filename) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const path = `annotated/${Date.now()}_${filename || 'photo.jpg'}`;
                
                const { data, error } = await db.storage
                    .from(this.BUCKET_NAME)
                    .upload(path, blob, { contentType: 'image/jpeg' });
                
                if (!error && data) {
                    // Obtenir l'URL publique
                    const { data: urlData } = db.storage
                        .from(this.BUCKET_NAME)
                        .getPublicUrl(path);
                    
                    console.log('[Photo] Upload réussi:', urlData.publicUrl);
                    return urlData.publicUrl;
                }
            } catch (e) {
                console.log('[Photo] Erreur upload:', e);
            }
        }
        return null;
    },

    // Sauvegarder les métadonnées de la photo
    async save(photoData, userId) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const { data, error } = await db.from('annotated_photos').insert([{
                    original_url: photoData.originalUrl || null,
                    annotated_url: photoData.annotatedUrl,
                    related_type: photoData.relatedType || null,
                    related_id: photoData.relatedId || null,
                    annotations: photoData.annotations || [],
                    description: photoData.description || null,
                    created_by: userId
                }]).select().single();
                
                if (!error && data) {
                    console.log('[Photo] Sauvegarde réussie:', data.id);
                    return data;
                }
            } catch (e) {
                console.log('[Photo] Erreur sauvegarde:', e);
            }
        }
        return null;
    },

    // Récupérer les photos liées à un élément
    async getByRelated(relatedType, relatedId) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                const { data, error } = await db.from('annotated_photos')
                    .select('*')
                    .eq('related_type', relatedType)
                    .eq('related_id', relatedId)
                    .order('created_at', { ascending: false });
                
                if (!error && data) return data;
            } catch (e) {
                console.log('[Photo] Erreur chargement:', e);
            }
        }
        return [];
    },

    // Supprimer une photo
    async delete(photoId) {
        if (typeof db !== 'undefined' && db !== null) {
            try {
                // Récupérer l'URL pour supprimer le fichier
                const { data: photo } = await db.from('annotated_photos')
                    .select('annotated_url')
                    .eq('id', photoId)
                    .single();
                
                if (photo?.annotated_url) {
                    // Extraire le chemin du fichier
                    const url = new URL(photo.annotated_url);
                    const path = url.pathname.split('/').slice(-2).join('/');
                    await db.storage.from(this.BUCKET_NAME).remove([path]);
                }
                
                // Supprimer les métadonnées
                const { error } = await db.from('annotated_photos').delete().eq('id', photoId);
                
                if (!error) {
                    console.log('[Photo] Suppression réussie');
                    return true;
                }
            } catch (e) {
                console.log('[Photo] Erreur suppression:', e);
            }
        }
        return false;
    }
};

/**
 * Composant d'annotation de photos
 */
const PhotoAnnotator = ({ image, onSave, onClose }) => {
    const canvasRef = useRef(null);
    const containerRef = useRef(null);
    const imageRef = useRef(null); // Garder l'image en mémoire
    const [tool, setTool] = useState('draw'); // draw, arrow, circle, rectangle, text
    const [color, setColor] = useState('#E11D48');
    const [lineWidth, setLineWidth] = useState(3);
    const [isDrawing, setIsDrawing] = useState(false);
    const [startPos, setStartPos] = useState(null);
    const [annotations, setAnnotations] = useState([]);
    const [currentAnnotation, setCurrentAnnotation] = useState(null);
    const [textInput, setTextInput] = useState('');
    const [textPosition, setTextPosition] = useState(null);
    const [imageLoaded, setImageLoaded] = useState(false);
    const [imageError, setImageError] = useState(null);
    const [imageUrl, setImageUrl] = useState(null);
    const [loadingStatus, setLoadingStatus] = useState('');

    // Fonction pour valider une data URL
    const isValidDataUrl = (str) => {
        if (!str || typeof str !== 'string') return false;
        // Vérifier le format de base
        if (!str.startsWith('data:image/')) return false;
        // Vérifier qu'il y a bien une partie base64
        const parts = str.split(',');
        if (parts.length !== 2) return false;
        // Vérifier que la partie base64 n'est pas trop courte (image corrompue)
        if (parts[1].length < 100) return false;
        return true;
    };

    // Fonction pour valider une URL HTTP
    const isValidHttpUrl = (str) => {
        try {
            const url = new URL(str);
            return url.protocol === 'http:' || url.protocol === 'https:';
        } catch {
            return false;
        }
    };

    // Préparer l'URL de l'image
    useEffect(() => {
        if (!image) {
            setImageError('Aucune image fournie');
            setLoadingStatus('Erreur: aucune image');
            return;
        }
        
        let url = null;
        setLoadingStatus('Analyse de l\'image...');
        
        // Log sécurisé (pas de console.log de grandes chaînes base64)
        const imageType = typeof image;
        const imagePreview = typeof image === 'string' 
            ? (image.length > 100 ? image.substring(0, 50) + '...[' + image.length + ' chars]...' + image.substring(image.length - 20) : image)
            : image;
        console.log('[PhotoAnnotator] Image reçue:', imageType, imagePreview);
        
        // Si c'est un objet File/Blob, créer une URL
        if (image instanceof Blob || image instanceof File) {
            url = URL.createObjectURL(image);
            setLoadingStatus('Fichier converti en URL');
            console.log('[PhotoAnnotator] Blob/File -> URL créée');
        }
        // Si c'est une chaîne
        else if (typeof image === 'string' && image.length > 0) {
            
            // 1. Data URL complète (déjà formatée)
            if (image.startsWith('data:image/')) {
                if (isValidDataUrl(image)) {
                    url = image;
                    setLoadingStatus('Data URL valide détectée (' + Math.round(image.length/1024) + ' KB)');
                    console.log('[PhotoAnnotator] Data URL valide, taille:', image.length);
                } else {
                    setImageError('L\'image semble corrompue ou incomplète.\n\nL\'URL data: est mal formée.');
                    setLoadingStatus('Erreur: Data URL invalide');
                    console.error('[PhotoAnnotator] Data URL invalide');
                    return;
                }
            }
            // 2. Blob URL
            else if (image.startsWith('blob:')) {
                url = image;
                setLoadingStatus('Blob URL détectée');
            }
            // 3. Base64 brut (PNG commence par iVBORw, JPEG par /9j/)
            else if (image.startsWith('iVBORw') || image.startsWith('/9j/')) {
                const mimeType = image.startsWith('iVBORw') ? 'image/png' : 'image/jpeg';
                url = 'data:' + mimeType + ';base64,' + image;
                setLoadingStatus('Base64 brut converti');
                console.log('[PhotoAnnotator] Base64 brut détecté, type:', mimeType);
            }
            // 4. URL HTTP(S)
            else if (image.startsWith('http://') || image.startsWith('https://')) {
                if (isValidHttpUrl(image)) {
                    url = image;
                    setLoadingStatus('URL HTTP détectée');
                    console.log('[PhotoAnnotator] URL HTTP:', image.substring(0, 80));
                } else {
                    setImageError('URL invalide: ' + image.substring(0, 100));
                    return;
                }
            }
            // 5. URL Supabase (peut ne pas commencer par http)
            else if (image.includes('supabase.co') || image.includes('supabase.in')) {
                url = image.startsWith('//') ? 'https:' + image : image;
                setLoadingStatus('URL Supabase détectée');
            }
            // 6. Chemin relatif
            else if (image.startsWith('/') && !image.includes(' ')) {
                url = window.location.origin + image;
                setLoadingStatus('Chemin relatif converti');
            }
            // 7. Chaîne inconnue - probablement corrompue
            else {
                // Vérifier si c'est peut-être un fragment de base64
                if (image.match(/^[A-Za-z0-9+/=]+$/) && image.length < 100) {
                    setImageError('L\'image semble être un fragment de données corrompues.\n\nFragment reçu: "' + image.substring(0, 50) + '"');
                } else {
                    setImageError('Format d\'image non reconnu.\n\nDébut de la chaîne: "' + image.substring(0, 50) + '"');
                }
                setLoadingStatus('Erreur: format non reconnu');
                console.error('[PhotoAnnotator] Format non reconnu:', image.substring(0, 50));
                return;
            }
        } else {
            setImageError('Format d\'image non supporté: ' + imageType);
            setLoadingStatus('Erreur: type non supporté');
            return;
        }
        
        if (url) {
            setImageUrl(url);
            setImageError(null);
        }
    }, [image]);

    // Charger l'image
    useEffect(() => {
        if (!canvasRef.current || !imageUrl) return;

        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        setLoadingStatus('Chargement de l\'image...');
        
        // Pour les data URLs et blobs, pas besoin de CORS
        const isDataOrBlob = imageUrl.startsWith('data:') || imageUrl.startsWith('blob:');
        const needsCORS = !isDataOrBlob && imageUrl.startsWith('http');
        let corsAttempt = 0;
        
        const tryLoad = () => {
            // Pour les URLs HTTP externes, essayer d'abord avec CORS
            if (needsCORS && corsAttempt === 0) {
                img.crossOrigin = 'anonymous';
            } else {
                img.crossOrigin = null;
            }
            
            // Ne pas modifier les data URLs
            let finalUrl = imageUrl;
            if (!isDataOrBlob && corsAttempt > 0) {
                // Ajouter un timestamp pour contourner le cache
                finalUrl = imageUrl + (imageUrl.includes('?') ? '&' : '?') + 'nocache=' + Date.now();
            }
            
            console.log('[PhotoAnnotator] Tentative', corsAttempt, '- CORS:', img.crossOrigin);
            img.src = finalUrl;
        };
        
        img.onload = () => {
            console.log('[PhotoAnnotator] Image chargée:', img.width, 'x', img.height);
            setLoadingStatus('');
            
            // Garder l'image en mémoire
            imageRef.current = img;
            
            // Ajuster la taille du canvas
            const maxWidth = containerRef.current?.clientWidth || 800;
            const maxHeight = 600;
            let width = img.width;
            let height = img.height;

            if (width > maxWidth) {
                height = (maxWidth / width) * height;
                width = maxWidth;
            }
            if (height > maxHeight) {
                width = (maxHeight / height) * width;
                height = maxHeight;
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            setImageLoaded(true);
            setImageError(null);
        };
        
        img.onerror = (e) => {
            console.error('[PhotoAnnotator] Erreur de chargement, tentative', corsAttempt);
            
            // Réessayer sans CORS si c'est une URL externe
            if (needsCORS && corsAttempt < 2) {
                corsAttempt++;
                setLoadingStatus('Réessai (' + corsAttempt + ')...');
                setTimeout(tryLoad, 200);
            } else {
                let errorMsg = 'Impossible de charger l\'image.';
                
                if (isDataOrBlob) {
                    errorMsg += '\n\nL\'image embarquée semble corrompue ou invalide.';
                } else {
                    errorMsg += '\n\nCauses possibles:\n- L\'URL n\'est plus valide\n- Restrictions CORS du serveur\n- Image supprimée';
                }
                
                setImageError(errorMsg);
                setLoadingStatus('Échec du chargement');
            }
        };

        tryLoad();
        
        // Cleanup
        return () => {
            img.onload = null;
            img.onerror = null;
        };
    }, [imageUrl]);

    // Redessiner les annotations (utilise l'image en mémoire)
    useEffect(() => {
        if (!imageLoaded || !imageRef.current) return;
        redrawCanvas();
    }, [annotations, currentAnnotation, imageLoaded]);

    const redrawCanvas = () => {
        if (!imageRef.current) return;
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        
        // Utiliser l'image en mémoire
        ctx.drawImage(imageRef.current, 0, 0, canvas.width, canvas.height);
        
        // Dessiner les annotations sauvegardées
        annotations.forEach(ann => drawAnnotation(ctx, ann));
        
        // Dessiner l'annotation en cours
        if (currentAnnotation) {
            drawAnnotation(ctx, currentAnnotation);
        }
    };

    const drawAnnotation = (ctx, annotation) => {
        ctx.strokeStyle = annotation.color;
        ctx.fillStyle = annotation.color;
        ctx.lineWidth = annotation.lineWidth;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        switch (annotation.type) {
            case 'draw':
                if (annotation.points && annotation.points.length > 1) {
                    ctx.beginPath();
                    ctx.moveTo(annotation.points[0].x, annotation.points[0].y);
                    annotation.points.forEach(p => ctx.lineTo(p.x, p.y));
                    ctx.stroke();
                }
                break;

            case 'arrow':
                if (annotation.start && annotation.end) {
                    const { start, end } = annotation;
                    const angle = Math.atan2(end.y - start.y, end.x - start.x);
                    const headLength = 15;

                    ctx.beginPath();
                    ctx.moveTo(start.x, start.y);
                    ctx.lineTo(end.x, end.y);
                    ctx.stroke();

                    // Tête de flèche
                    ctx.beginPath();
                    ctx.moveTo(end.x, end.y);
                    ctx.lineTo(
                        end.x - headLength * Math.cos(angle - Math.PI / 6),
                        end.y - headLength * Math.sin(angle - Math.PI / 6)
                    );
                    ctx.moveTo(end.x, end.y);
                    ctx.lineTo(
                        end.x - headLength * Math.cos(angle + Math.PI / 6),
                        end.y - headLength * Math.sin(angle + Math.PI / 6)
                    );
                    ctx.stroke();
                }
                break;

            case 'circle':
                if (annotation.center && annotation.radius) {
                    ctx.beginPath();
                    ctx.arc(annotation.center.x, annotation.center.y, annotation.radius, 0, Math.PI * 2);
                    ctx.stroke();
                }
                break;

            case 'rectangle':
                if (annotation.start && annotation.end) {
                    ctx.strokeRect(
                        annotation.start.x,
                        annotation.start.y,
                        annotation.end.x - annotation.start.x,
                        annotation.end.y - annotation.start.y
                    );
                }
                break;

            case 'text':
                if (annotation.position && annotation.text) {
                    ctx.font = `${annotation.lineWidth * 6}px Arial`;
                    ctx.fillText(annotation.text, annotation.position.x, annotation.position.y);
                }
                break;
        }
    };

    const getCanvasPos = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    };

    const handleStart = (e) => {
        e.preventDefault();
        const pos = getCanvasPos(e);
        setIsDrawing(true);
        setStartPos(pos);

        if (tool === 'text') {
            setTextPosition(pos);
            return;
        }

        if (tool === 'draw') {
            setCurrentAnnotation({
                type: 'draw',
                color,
                lineWidth,
                points: [pos]
            });
        } else {
            setCurrentAnnotation({
                type: tool,
                color,
                lineWidth,
                start: pos
            });
        }
    };

    const handleMove = (e) => {
        if (!isDrawing || tool === 'text') return;
        e.preventDefault();
        
        const pos = getCanvasPos(e);

        if (tool === 'draw') {
            setCurrentAnnotation(prev => ({
                ...prev,
                points: [...(prev?.points || []), pos]
            }));
        } else if (tool === 'circle') {
            const radius = Math.sqrt(
                Math.pow(pos.x - startPos.x, 2) + Math.pow(pos.y - startPos.y, 2)
            );
            setCurrentAnnotation(prev => ({
                ...prev,
                center: startPos,
                radius
            }));
        } else {
            setCurrentAnnotation(prev => ({
                ...prev,
                end: pos
            }));
        }
    };

    const handleEnd = (e) => {
        if (!isDrawing) return;
        setIsDrawing(false);

        if (tool !== 'text' && currentAnnotation) {
            setAnnotations(prev => [...prev, currentAnnotation]);
            setCurrentAnnotation(null);
        }
    };

    const handleTextSubmit = () => {
        if (textInput && textPosition) {
            setAnnotations(prev => [...prev, {
                type: 'text',
                color,
                lineWidth,
                position: textPosition,
                text: textInput
            }]);
            setTextInput('');
            setTextPosition(null);
        }
    };

    const handleUndo = () => {
        setAnnotations(prev => prev.slice(0, -1));
    };

    const handleClear = () => {
        setAnnotations([]);
    };

    const handleSave = () => {
        const canvas = canvasRef.current;
        if (!canvas) {
            console.error('[PhotoAnnotator] Canvas non trouvé!');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        console.log('[PhotoAnnotator] Canvas dimensions:', canvas.width, 'x', canvas.height);
        console.log('[PhotoAnnotator] imageRef.current:', imageRef.current ? 'présent' : 'absent');
        console.log('[PhotoAnnotator] Annotations à sauvegarder:', annotations);
        
        // S'assurer que l'image et les annotations sont dessinées
        if (imageRef.current) {
            // Redessiner l'image de base
            ctx.drawImage(imageRef.current, 0, 0, canvas.width, canvas.height);
            
            // Dessiner toutes les annotations sauvegardées
            console.log('[PhotoAnnotator] Dessin de', annotations.length, 'annotations...');
            annotations.forEach((ann, i) => {
                console.log('[PhotoAnnotator] Annotation', i, ':', ann.type, ann.color);
                drawAnnotation(ctx, ann);
            });
            
            // Dessiner l'annotation en cours si elle existe
            if (currentAnnotation) {
                console.log('[PhotoAnnotator] + annotation en cours:', currentAnnotation.type);
                drawAnnotation(ctx, currentAnnotation);
            }
        } else {
            console.warn('[PhotoAnnotator] Pas d\'image de référence pour la sauvegarde');
        }
        
        // Exporter le canvas avec les annotations
        canvas.toBlob(blob => {
            console.log('[PhotoAnnotator] Blob créé:', blob?.size, 'bytes, type:', blob?.type);
            if (blob) {
                onSave(blob);
            } else {
                console.error('[PhotoAnnotator] Échec création blob');
            }
        }, 'image/jpeg', 0.9);
    };

    const [manualFile, setManualFile] = useState(null);
    const fileInputRef = useRef(null);

    const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            setManualFile(url);
            setImageUrl(url);
            setImageError(null);
            setLoadingStatus('Fichier chargé manuellement');
        }
    };

    const tools = [
        { id: 'draw', icon: '✏️', label: 'Dessin libre' },
        { id: 'arrow', icon: '➡️', label: 'Flèche' },
        { id: 'circle', icon: '⭕', label: 'Cercle' },
        { id: 'rectangle', icon: '⬜', label: 'Rectangle' },
        { id: 'text', icon: '🔤', label: 'Texte' }
    ];

    const colors = ['#E11D48', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#000000', '#FFFFFF'];

    // Formater l'URL pour l'affichage
    const formatUrlForDisplay = (url) => {
        if (!url) return 'Non définie';
        if (url.startsWith('data:')) {
            const parts = url.split(',');
            const header = parts[0];
            const dataLength = parts[1]?.length || 0;
            return `${header},[${Math.round(dataLength/1024)} KB de données base64]`;
        }
        if (url.length > 100) {
            return url.substring(0, 80) + '...[' + url.length + ' caractères]';
        }
        return url;
    };

    return h('div', { className: 'photo-annotator' },
        // Input file caché pour le chargement manuel
        h('input', {
            ref: fileInputRef,
            type: 'file',
            accept: 'image/*',
            onChange: handleFileSelect,
            style: { display: 'none' }
        }),
        
        // Afficher une erreur si l'image ne charge pas
        imageError && h('div', { 
            style: { 
                padding: 40, textAlign: 'center', color: '#DC2626', 
                background: '#FEE2E2', borderRadius: 8, margin: 20 
            } 
        },
            h('div', { style: { fontSize: 48, marginBottom: 16 } }, '⚠️'),
            h('p', { style: { fontWeight: 600, marginBottom: 8 } }, 'Erreur de chargement'),
            h('p', { style: { fontSize: 13, color: '#7F1D1D', whiteSpace: 'pre-line' } }, imageError),
            
            // Option de charger manuellement
            h('div', { style: { marginTop: 20, padding: 16, background: '#DBEAFE', borderRadius: 8 } },
                h('p', { style: { fontSize: 13, color: '#1E40AF', marginBottom: 12 } }, 
                    '💡 Vous pouvez charger une image depuis votre appareil:'
                ),
                h('button', {
                    className: 'btn btn-primary',
                    onClick: () => fileInputRef.current?.click()
                }, '📂 Choisir un fichier')
            ),
            
            h('div', { style: { marginTop: 16, padding: 12, background: 'white', borderRadius: 8, textAlign: 'left' } },
                h('p', { style: { fontSize: 11, color: '#6B7280', marginBottom: 8 } }, 'Détails techniques:'),
                h('code', { style: { fontSize: 10, wordBreak: 'break-all', color: '#374151', display: 'block' } }, 
                    formatUrlForDisplay(imageUrl)
                ),
                imageUrl && !imageUrl.startsWith('data:') && h('div', { style: { marginTop: 12, display: 'flex', gap: 8 } },
                    h('a', { 
                        href: imageUrl, 
                        target: '_blank', 
                        className: 'btn btn-sm btn-ghost',
                        style: { textDecoration: 'none' }
                    }, '🔗 Ouvrir l\'URL'),
                    h('button', { 
                        className: 'btn btn-sm btn-ghost',
                        onClick: () => navigator.clipboard.writeText(imageUrl).then(() => alert('URL copiée !'))
                    }, '📋 Copier')
                )
            ),
            
            // Essayer d'afficher l'image sans CORS (preview seulement) - uniquement pour les URLs HTTP
            imageUrl && !imageUrl.startsWith('data:') && h('div', { style: { marginTop: 16 } },
                h('p', { style: { fontSize: 11, color: '#6B7280', marginBottom: 8 } }, 'Aperçu (si disponible):'),
                h('img', { 
                    src: imageUrl, 
                    style: { maxWidth: 200, maxHeight: 150, borderRadius: 8, border: '1px solid #ccc' },
                    onError: (e) => e.target.style.display = 'none'
                })
            ),
            
            h('button', { 
                className: 'btn btn-secondary', 
                style: { marginTop: 16 },
                onClick: onClose 
            }, 'Fermer')
        ),
        
        // Toolbar et canvas
        !imageError && h('div', { className: 'annotator-toolbar' },
            h('div', { className: 'annotator-tools' },
                tools.map(t => h('button', {
                    key: t.id,
                    className: `annotator-tool ${tool === t.id ? 'active' : ''}`,
                    onClick: () => setTool(t.id),
                    title: t.label
                }, t.icon))
            ),
            h('div', { className: 'annotator-colors' },
                colors.map(c => h('button', {
                    key: c,
                    className: `annotator-color ${color === c ? 'active' : ''}`,
                    style: { background: c },
                    onClick: () => setColor(c)
                }))
            ),
            h('div', { className: 'annotator-size' },
                h('input', {
                    type: 'range',
                    min: 1,
                    max: 10,
                    value: lineWidth,
                    onChange: e => setLineWidth(parseInt(e.target.value))
                }),
                h('span', null, lineWidth, 'px')
            ),
            h('div', { className: 'annotator-actions' },
                h('button', { className: 'btn btn-sm btn-ghost', onClick: handleUndo, disabled: annotations.length === 0 }, '↩️ Annuler'),
                h('button', { className: 'btn btn-sm btn-ghost', onClick: handleClear }, '🗑️ Effacer'),
                h('button', { className: 'btn btn-sm btn-primary', onClick: handleSave }, '💾 Sauvegarder'),
                h('button', { className: 'btn btn-sm btn-ghost', onClick: onClose }, '✕')
            )
        ),

        !imageError && h('div', { className: 'annotator-canvas-container', ref: containerRef },
            // Indicateur de chargement
            !imageLoaded && loadingStatus && h('div', { 
                style: { 
                    position: 'absolute', 
                    inset: 0, 
                    display: 'flex', 
                    flexDirection: 'column',
                    alignItems: 'center', 
                    justifyContent: 'center',
                    background: 'rgba(255,255,255,0.9)',
                    zIndex: 10
                } 
            },
                h('div', { style: { fontSize: 48, marginBottom: 16, animation: 'spin 1s linear infinite' } }, '⏳'),
                h('p', { style: { color: 'var(--muted)' } }, loadingStatus)
            ),
            h('canvas', {
                ref: canvasRef,
                className: 'annotator-canvas',
                onMouseDown: handleStart,
                onMouseMove: handleMove,
                onMouseUp: handleEnd,
                onMouseLeave: handleEnd,
                onTouchStart: handleStart,
                onTouchMove: handleMove,
                onTouchEnd: handleEnd
            }),
            
            textPosition && h('div', { 
                className: 'annotator-text-input',
                style: { left: textPosition.x, top: textPosition.y }
            },
                h('input', {
                    type: 'text',
                    value: textInput,
                    onChange: e => setTextInput(e.target.value),
                    placeholder: 'Entrez votre texte',
                    autoFocus: true,
                    onKeyPress: e => e.key === 'Enter' && handleTextSubmit()
                }),
                h('button', { onClick: handleTextSubmit }, '✓')
            )
        )
    );
};

/**
 * Modal pour annoter une photo
 */
const PhotoAnnotatorModal = ({ isOpen, image, onSave, onClose }) => {
    if (!isOpen) return null;

    return h('div', { className: 'modal-overlay photo-annotator-overlay' },
        h('div', { className: 'modal modal-xl photo-annotator-modal' },
            h(PhotoAnnotator, { image, onSave, onClose })
        )
    );
};

/**
 * Bouton de capture photo avec annotation
 */
const PhotoCaptureButton = ({ onCapture, onAnnotatedCapture }) => {
    const [showAnnotator, setShowAnnotator] = useState(false);
    const [capturedImage, setCapturedImage] = useState(null);
    const fileInputRef = useRef(null);

    const handleCapture = (e) => {
        const file = e.target.files[0];
        if (file) {
            setCapturedImage(file);
            setShowAnnotator(true);
        }
    };

    const handleSave = (annotatedBlob) => {
        onAnnotatedCapture && onAnnotatedCapture(annotatedBlob);
        setShowAnnotator(false);
        setCapturedImage(null);
    };

    return h(Fragment, null,
        h('input', {
            ref: fileInputRef,
            type: 'file',
            accept: 'image/*',
            capture: 'environment',
            onChange: handleCapture,
            style: { display: 'none' }
        }),
        h('button', {
            className: 'btn btn-secondary',
            onClick: () => fileInputRef.current?.click()
        }, '📷 Photo annotée'),
        
        showAnnotator && h(PhotoAnnotatorModal, {
            isOpen: true,
            image: capturedImage,
            onSave: handleSave,
            onClose: () => { setShowAnnotator(false); setCapturedImage(null); }
        })
    );
};


// ============================================================================
// STYLES CSS v5.5
// ============================================================================

const V55_STYLES = `
/* ============================================================================
   TABLEAUX REDIMENSIONNABLES
   ============================================================================ */

.resizable-table-container {
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--card);
}

.resizable-table {
    width: 100%;
    border-collapse: collapse;
}

.resizable-table thead th {
    position: relative;
    background: var(--background);
    border-bottom: 2px solid var(--border);
    padding: 12px 16px;
    font-weight: 600;
    text-align: left;
    white-space: nowrap;
    transition: background 0.2s;
}

.resizable-table thead th:hover {
    background: var(--hover);
}

.resizable-table thead th .resize-handle {
    opacity: 0;
    transition: opacity 0.2s;
}

.resizable-table thead th:hover .resize-handle,
.resizable-table thead th .resize-handle:hover {
    opacity: 1;
    background: var(--border) !important;
}

.resizable-table tbody td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
}

.resizable-table tbody tr:hover {
    background: var(--hover);
}

.resizable-table tbody tr.selected {
    background: var(--primary-pastel);
}

/* Indicateur de drag */
.resizable-table thead th[data-dragging="true"] {
    opacity: 0.5;
}

/* ============================================================================
   THÈMES PERSONNALISÉS
   ============================================================================ */

.theme-modal .modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

.theme-list h4, .theme-editor h4 {
    margin: 0 0 16px;
    font-size: 16px;
}

.theme-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.theme-card {
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 12px;
    cursor: pointer;
    transition: all 0.2s;
}

.theme-card:hover {
    border-color: var(--primary);
}

.theme-card.active {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-pastel);
}

.theme-preview {
    height: 80px;
    border-radius: var(--radius);
    border: 1px solid;
    overflow: hidden;
    margin-bottom: 8px;
}

.theme-preview-header {
    height: 20px;
}

.theme-preview-card {
    margin: 8px;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid;
}

.theme-preview-text {
    height: 6px;
    width: 60%;
    border-radius: 3px;
    margin-bottom: 4px;
}

.theme-preview-text-secondary {
    height: 4px;
    width: 40%;
    border-radius: 2px;
    opacity: 0.5;
}

.theme-info {
    display: flex;
    align-items: center;
    gap: 8px;
}

.theme-icon {
    font-size: 18px;
}

.theme-name {
    flex: 1;
    font-weight: 500;
}

.theme-active-badge {
    color: var(--success);
}

.theme-actions {
    display: flex;
    gap: 4px;
    margin-top: 8px;
}

.color-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 20px;
}

.color-input-group label {
    display: block;
    font-size: 12px;
    margin-bottom: 4px;
    color: var(--text-secondary);
}

.color-input-wrapper {
    display: flex;
    gap: 8px;
}

.color-input-wrapper input[type="color"] {
    width: 40px;
    height: 36px;
    padding: 2px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
}

.color-input-wrapper input[type="text"] {
    flex: 1;
    font-family: monospace;
}

.theme-editor-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 20px;
}

/* ============================================================================
   WIDGETS CONFIGURABLES
   ============================================================================ */

.dashboard-widget.edit-mode {
    border: 2px dashed var(--primary);
}

.widget-edit-controls {
    display: flex;
    gap: 4px;
}

.widget-picker-modal .modal-body {
    max-height: 60vh;
}

.widget-picker-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
}

.widget-picker-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 12px;
}

.widget-picker-item {
    padding: 16px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.widget-picker-item:hover {
    border-color: var(--primary);
    background: var(--primary-pastel);
}

.widget-picker-icon {
    font-size: 32px;
    display: block;
    margin-bottom: 8px;
}

.widget-picker-name {
    font-weight: 500;
    display: block;
}

.widget-picker-size {
    font-size: 11px;
    color: var(--muted);
}

.widget-picker-empty {
    grid-column: 1 / -1;
    text-align: center;
    color: var(--muted);
    padding: 40px;
}

/* ============================================================================
   VUES SAUVEGARDÉES
   ============================================================================ */

.saved-views-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 0;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
}

.saved-views-list {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    flex: 1;
}

.view-delete {
    margin-left: 8px;
    opacity: 0;
    transition: opacity 0.2s;
}

.saved-views-list button:hover .view-delete {
    opacity: 1;
}

/* ============================================================================
   RÔLES PERSONNALISÉS
   ============================================================================ */

.roles-modal-body {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
}

.roles-list {
    border-right: 1px solid var(--border);
    padding-right: 24px;
}

.role-card {
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
}

.role-card:hover {
    border-color: var(--primary);
}

.role-card.editing {
    border-color: var(--primary);
    background: var(--primary-pastel);
}

.role-card.system {
    opacity: 0.8;
}

.role-header {
    display: flex;
    align-items: center;
    gap: 8px;
}

.role-icon {
    font-size: 20px;
}

.role-name {
    flex: 1;
    font-weight: 500;
}

.role-system-badge {
    font-size: 10px;
    background: var(--muted);
    color: white;
    padding: 2px 6px;
    border-radius: 10px;
}

.role-permissions-count {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
}

.role-actions {
    display: flex;
    gap: 4px;
    margin-top: 8px;
}

.permissions-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
}

.permission-category {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
}

.permission-category-header {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    background: var(--background);
    cursor: pointer;
    font-weight: 500;
}

.permission-list {
    padding: 8px 12px;
}

.permission-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 0;
    cursor: pointer;
}

.permission-item input {
    margin: 0;
}

/* ============================================================================
   RACCOURCIS PERSONNALISÉS
   ============================================================================ */

.shortcuts-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
}

.shortcuts-actions {
    margin-left: auto;
    display: flex;
    gap: 8px;
}

.shortcuts-list {
    max-height: 400px;
    overflow-y: auto;
}

.shortcut-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px;
    border-bottom: 1px solid var(--border);
}

.shortcut-item.recording {
    background: var(--primary-pastel);
}

.shortcut-info {
    flex: 1;
}

.shortcut-label {
    font-weight: 500;
}

.shortcut-action {
    font-size: 12px;
    color: var(--muted);
}

.shortcut-keys kbd {
    background: var(--background);
    padding: 4px 8px;
    border-radius: var(--radius);
    font-family: monospace;
    font-size: 13px;
}

.recording-indicator {
    color: var(--primary);
    font-weight: 500;
    animation: pulse 1s infinite;
}

.shortcut-add-form {
    margin-top: 20px;
    padding: 16px;
    background: var(--background);
    border-radius: var(--radius);
}

/* ============================================================================
   APPELS VIDÉO
   ============================================================================ */

.video-call-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.video-call-panel {
    width: 100%;
    max-width: 900px;
    background: var(--card);
    border-radius: var(--radius-xl);
    overflow: hidden;
}

.video-call-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background: var(--background);
}

.video-call-user {
    display: flex;
    align-items: center;
    gap: 12px;
}

.video-call-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: 600;
}

.video-call-name {
    font-weight: 600;
    font-size: 18px;
}

.video-call-status {
    font-size: 13px;
    color: var(--muted);
}

.video-call-videos {
    position: relative;
    aspect-ratio: 16/9;
    background: #000;
}

.video-call-remote {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.video-call-local {
    position: absolute;
    bottom: 16px;
    right: 16px;
    width: 200px;
    border-radius: var(--radius);
    border: 2px solid white;
    box-shadow: var(--shadow-lg);
}

.video-call-no-video {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 48px;
}

.video-call-error {
    padding: 12px;
    background: var(--danger-pastel);
    color: var(--danger);
    text-align: center;
}

.video-call-controls {
    display: flex;
    justify-content: center;
    gap: 16px;
    padding: 24px;
    background: var(--background);
}

.video-call-btn {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: var(--card);
    font-size: 24px;
    cursor: pointer;
    transition: all 0.2s;
}

.video-call-btn:hover {
    background: var(--border);
}

.video-call-btn.active {
    background: var(--warning);
}

.video-call-btn.end-call {
    background: var(--danger);
    color: white;
    transform: rotate(135deg);
}

.video-call-btn.answer-call {
    background: var(--success);
    color: white;
}

.video-call-waiting {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.8);
    color: white;
}

.video-call-waiting-icon {
    font-size: 64px;
    margin-bottom: 16px;
    animation: pulse 2s infinite;
}

.video-call-waiting-text {
    font-size: 18px;
    color: rgba(255, 255, 255, 0.8);
}

@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.1); }
}

.video-call-incoming {
    display: flex;
    justify-content: center;
    gap: 32px;
    padding: 24px;
    background: var(--background);
}

.video-call-incoming .video-call-btn {
    width: 72px;
    height: 72px;
    font-size: 32px;
}

/* ============================================================================
   NFC INVENTAIRE
   ============================================================================ */

.nfc-modal .modal-body {
    min-height: 500px;
}

.nfc-not-supported {
    text-align: center;
    padding: 60px;
}

.nfc-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

.nfc-mode-selector {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
}

.nfc-scan-zone {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px;
}

.nfc-scanner {
    width: 200px;
    height: 200px;
    border: 3px solid var(--border);
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 24px;
    position: relative;
}

.nfc-scanner.active {
    border-color: var(--primary);
}

.nfc-scanner-icon {
    font-size: 64px;
}

.nfc-scanner.active .nfc-scanner-waves::before,
.nfc-scanner.active .nfc-scanner-waves::after {
    content: '';
    position: absolute;
    inset: -10px;
    border: 2px solid var(--primary);
    border-radius: 50%;
    animation: nfcWave 2s infinite;
}

.nfc-scanner.active .nfc-scanner-waves::after {
    animation-delay: 1s;
}

@keyframes nfcWave {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(1.5); opacity: 0; }
}

.nfc-last-scan, .nfc-inventory, .nfc-write {
    margin-top: 24px;
    padding: 16px;
    background: var(--background);
    border-radius: var(--radius);
}

.nfc-scan-result {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.nfc-scan-result label {
    font-size: 12px;
    color: var(--muted);
}

.nfc-scan-result code {
    font-family: monospace;
    background: var(--card);
    padding: 4px 8px;
    border-radius: var(--radius);
}

.nfc-inventory-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.nfc-inventory-progress {
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 16px;
}

.nfc-inventory-bar {
    height: 100%;
    background: var(--primary);
    transition: width 0.3s;
}

.nfc-scanned-list {
    max-height: 200px;
    overflow-y: auto;
}

.nfc-scanned-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    border-bottom: 1px solid var(--border);
}

.nfc-item-index {
    width: 24px;
    height: 24px;
    background: var(--success);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.nfc-item-name {
    flex: 1;
}

.nfc-item-ref {
    color: var(--muted);
}

.nfc-item-time {
    font-size: 12px;
    color: var(--muted);
}

.nfc-results {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}

.nfc-results-content {
    background: var(--card);
    padding: 24px;
    border-radius: var(--radius-xl);
    max-width: 500px;
}

.nfc-results-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin: 20px 0;
}

.nfc-stat {
    text-align: center;
    padding: 16px;
    border-radius: var(--radius);
}

.nfc-stat.success { background: rgba(16, 185, 129, 0.1); }
.nfc-stat.warning { background: rgba(245, 158, 11, 0.1); }
.nfc-stat.info { background: rgba(59, 130, 246, 0.1); }

.nfc-stat-value {
    font-size: 32px;
    font-weight: 800;
}

.nfc-stat-label {
    font-size: 12px;
    color: var(--muted);
}

.nfc-missing-list {
    max-height: 200px;
    overflow-y: auto;
    margin-top: 16px;
}

.nfc-missing-item {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    border-bottom: 1px solid var(--border);
}

/* ============================================================================
   VÉHICULES
   ============================================================================ */

.vehicles-layout {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 24px;
}

.vehicles-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.vehicle-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.2s;
}

.vehicle-card:hover, .vehicle-card.selected {
    border-color: var(--primary);
    background: var(--primary-pastel);
}

.vehicle-icon {
    font-size: 32px;
}

.vehicle-info {
    flex: 1;
}

.vehicle-name {
    font-weight: 600;
}

.vehicle-plate {
    font-family: monospace;
    color: var(--muted);
}

.vehicle-assigned {
    font-size: 12px;
    color: var(--text-secondary);
}

.vehicle-stock-count {
    font-size: 12px;
    color: var(--muted);
}

.vehicle-detail {
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: 24px;
}

.vehicle-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
}

.vehicle-detail-title {
    display: flex;
    align-items: center;
    gap: 16px;
}

.vehicle-detail-icon {
    font-size: 48px;
}

.vehicle-detail-title h2 {
    margin: 0;
}

.vehicle-detail-title p {
    margin: 4px 0 0;
    color: var(--muted);
    font-family: monospace;
}

.vehicle-detail-actions {
    display: flex;
    gap: 8px;
}

.vehicle-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.vehicle-stat {
    text-align: center;
    padding: 16px;
    background: var(--background);
    border-radius: var(--radius);
}

.vehicle-stat-value {
    font-size: 24px;
    font-weight: 800;
}

.vehicle-stat-label {
    font-size: 12px;
    color: var(--muted);
}

.vehicle-stock-list h4 {
    margin: 0 0 16px;
}

.empty-stock {
    text-align: center;
    color: var(--muted);
    padding: 40px;
}

/* ============================================================================
   COMPARAISON PÉRIODES
   ============================================================================ */

.period-comparison {
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: 24px;
}

.comparison-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
    margin-bottom: 20px;
}

.comparison-header h3 {
    margin: 0;
}

.comparison-presets {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.comparison-custom {
    display: flex;
    gap: 24px;
    padding: 16px;
    background: var(--background);
    border-radius: var(--radius);
    margin-bottom: 16px;
}

.comparison-period {
    display: flex;
    align-items: center;
    gap: 8px;
}

.comparison-period label {
    font-weight: 500;
    min-width: 80px;
}

.comparison-period input {
    padding: 6px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
}

.comparison-periods-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 16px;
    margin-bottom: 20px;
}

.period-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.period-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.period-1 .period-dot { background: var(--primary); }
.period-2 .period-dot { background: var(--muted); }

.comparison-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
}

.comparison-card {
    padding: 20px;
    background: var(--background);
    border-radius: var(--radius-lg);
}

.comparison-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    font-weight: 600;
}

.comparison-values {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
}

.comparison-value {
    text-align: center;
    padding: 12px;
    border-radius: var(--radius);
}

.comparison-value.period-1 { background: var(--primary-pastel); }
.comparison-value.period-2 { background: var(--card); }

.comparison-value .value {
    font-size: 28px;
    font-weight: 800;
    display: block;
}

.comparison-value .label {
    font-size: 12px;
    color: var(--muted);
}

.comparison-sub {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-secondary);
}

/* ============================================================================
   MODE HORS-LIGNE
   ============================================================================ */

.offline-indicator {
    position: fixed;
    bottom: 80px;
    left: 20px;
    z-index: 1000;
}

.offline-indicator-main {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--card);
    border-radius: 20px;
    box-shadow: var(--shadow-lg);
    cursor: pointer;
}

.offline-status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.offline-indicator.online .offline-status-dot { background: var(--success); }
.offline-indicator.offline .offline-status-dot { background: var(--danger); }

.offline-queue-badge {
    background: var(--warning);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
}

.offline-indicator-details {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 8px;
    padding: 16px;
    background: var(--card);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    min-width: 250px;
}

.offline-detail {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 13px;
}

.offline-warning {
    font-size: 12px;
    color: var(--warning);
    margin-top: 8px;
}

/* ============================================================================
   PHOTOS ANNOTÉES
   ============================================================================ */

.photo-annotator-overlay {
    background: rgba(0, 0, 0, 0.95);
}

.photo-annotator-modal {
    max-width: 95vw;
    max-height: 95vh;
}

.photo-annotator {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.annotator-toolbar {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 16px;
    background: var(--background);
    border-bottom: 1px solid var(--border);
    flex-wrap: wrap;
}

.annotator-tools {
    display: flex;
    gap: 4px;
}

.annotator-tool {
    width: 40px;
    height: 40px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background: var(--card);
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s;
}

.annotator-tool:hover {
    border-color: var(--primary);
}

.annotator-tool.active {
    background: var(--primary);
    border-color: var(--primary);
}

.annotator-colors {
    display: flex;
    gap: 4px;
}

.annotator-color {
    width: 28px;
    height: 28px;
    border: 2px solid transparent;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s;
}

.annotator-color:hover, .annotator-color.active {
    border-color: var(--text);
    transform: scale(1.1);
}

.annotator-size {
    display: flex;
    align-items: center;
    gap: 8px;
}

.annotator-size input {
    width: 80px;
}

.annotator-actions {
    display: flex;
    gap: 8px;
    margin-left: auto;
}

.annotator-canvas-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    background: #1a1a1a;
    overflow: auto;
    position: relative;
}

.annotator-canvas {
    max-width: 100%;
    max-height: 100%;
    cursor: crosshair;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
}

.annotator-text-input {
    position: absolute;
    display: flex;
    gap: 4px;
}

.annotator-text-input input {
    padding: 4px 8px;
    border: 1px solid var(--primary);
    border-radius: var(--radius);
    outline: none;
}

.annotator-text-input button {
    padding: 4px 8px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
}
`;

// Injecter les styles
if (typeof document !== 'undefined') {
    const styleEl = document.createElement('style');
    styleEl.textContent = V55_STYLES;
    document.head.appendChild(styleEl);
}


// ============================================================================
// EXPORTS
// ============================================================================

window.StockAppV55 = {
    // Thèmes personnalisés
    ThemeCustomizer,
    useCustomThemes,
    ThemeCustomizerModal,
    
    // Widgets configurables
    WidgetSystem,
    useConfigurableWidgets,
    ConfigurableWidget,
    WidgetPicker: V55WidgetPicker,
    
    // Vues sauvegardées
    SavedViewsSystem,
    useSavedViews,
    SavedViewsBar,
    
    // Rôles personnalisés
    RolesSystem,
    useCustomRoles,
    RolesManagerModal,
    
    // Raccourcis personnalisés
    ShortcutsSystem,
    useCustomShortcuts,
    ShortcutsManagerModal,
    
    // Appels vidéo
    VideoCallService,
    useVideoCall,
    VideoCallPanel,
    
    // NFC Inventaire
    NFCService,
    useNFCInventory,
    NFCInventoryModal,
    
    // Véhicules
    VehicleService,
    useVehicles,
    VehiclesPage,
    
    // Comparaison périodes
    PeriodComparisonService,
    PeriodComparisonWidget,
    
    // Mode hors-ligne
    OfflineService,
    useOfflineMode,
    OfflineIndicator,
    
    // Photos annotées
    PhotoService,
    PhotoAnnotator,
    PhotoAnnotatorModal,
    PhotoCaptureButton
};

console.log('[StockApp v5.6] Fonctionnalités avancées chargées avec succès');

// ============================================================================
// EXPORTS
// ============================================================================

window.StockAppV54 = {
    // IA Prédictive
    PredictiveAI,
    PredictiveAIDashboard,
    
    // OCR
    OCRService,
    OCRImportModal,
    
    // Géolocalisation
    GeoService,
    InterventionMap,
    
    // Chat
    ChatService,
    ChatPanel,
    ChatButton,
    
    // Notifications Push
    PushNotificationService,
    usePushNotifications,
    NotificationSettingsModal,
    
    // Mode Présentation
    EnhancedPresentationMode,
    PresentationClock
};

console.log('[StockApp v5.4] Fonctionnalités IA/OCR/Géo/Chat chargées avec succès');

// Debug info
console.log('[StockApp] Vérification des modules:');
console.log('  - StockAppV55:', typeof window.StockAppV55 !== 'undefined' ? '✓' : '✗');
console.log('  - StockAppV54:', typeof window.StockAppV54 !== 'undefined' ? '✓' : '✗');
console.log('  - ThemeCustomizer:', window.StockAppV55?.ThemeCustomizer ? '✓' : '✗');
console.log('  - VehicleService:', window.StockAppV55?.VehicleService ? '✓' : '✗');
console.log('  - RolesSystem:', window.StockAppV55?.RolesSystem ? '✓' : '✗');

// Debug composants directs
console.log('[StockApp] Vérification des composants directs:');
console.log('  - ChatButton:', typeof ChatButton === 'function' ? '✓' : '✗');
console.log('  - ChatPanel:', typeof ChatPanel === 'function' ? '✓' : '✗');
console.log('  - V55WidgetPicker:', typeof V55WidgetPicker === 'function' ? '✓' : '✗');
console.log('  - PhotoAnnotatorModal:', typeof PhotoAnnotatorModal === 'function' ? '✓' : '✗');
console.log('  - VehiclesPage:', typeof VehiclesPage === 'function' ? '✓' : '✗');

// Vérifier les styles V54
const allStyles = document.querySelectorAll('style');
let chatFabFound = false;
allStyles.forEach(s => { if (s.textContent && s.textContent.includes('chat-fab')) chatFabFound = true; });
console.log('  - CSS chat-fab:', chatFabFound ? '✓' : '✗ (MANQUANT!)');

// Render
ReactDOM.createRoot(document.getElementById('root')).render(h(App));
    </script>
</body>
</html>
