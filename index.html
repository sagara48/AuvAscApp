<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StockApp v8.0 - Optimized</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU3RvY2tBcHAgLSBBdXZlcmduZSBBc2NlbnNldXJzIiwic2hvcnRfbmFtZSI6IlN0b2NrQXBwIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNGOUZBRkIiLCJ0aGVtZV9jb2xvciI6IiMzQjgyRjYiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzRSUzQ3JlY3QgZmlsbD0nJTIzM0I4MkY2JyByeD0nMjAnIHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1NSUyNScgZG9taW5hbnQtYmFzZWxpbmU9J21pZGRsZScgdGV4dC1hbmNob3I9J21pZGRsZScgZmlsbD0nd2hpdGUnIGZvbnQtc2l6ZT0nNTAnIGZvbnQtd2VpZ2h0PSdib2xkJyUzRVMlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StockApp">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%233B82F6' rx='20' width='100' height='100'/%3E%3Ctext x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='50' font-weight='bold'%3ES%3C/text%3E%3C/svg%3E">
    
    <!-- Preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
/* ============================================
   CSS VARIABLES & THEMES
   ============================================ */
:root {
    /* Colors */
    --primary: #3B82F6;
    --primary-light: #EFF6FF;
    --primary-dark: #1D4ED8;
    --secondary: #8B5CF6;
    --secondary-light: #EDE9FE;
    --success: #10B981;
    --success-light: #D1FAE5;
    --warning: #F59E0B;
    --warning-light: #FEF3C7;
    --danger: #EF4444;
    --danger-light: #FEE2E2;
    --info: #06B6D4;
    --info-light: #CFFAFE;
    
    /* Neutrals */
    --text: #1F2937;
    --text-secondary: #4B5563;
    --muted: #9CA3AF;
    --border: #E5E7EB;
    --background: #F9FAFB;
    --card: #FFFFFF;
    --overlay: rgba(0, 0, 0, 0.5);
    
    /* Layout */
    --sidebar-width: 260px;
    --sidebar-collapsed: 72px;
    --header-height: 64px;
    
    /* Effects */
    --radius-sm: 8px;
    --radius: 12px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.05);
    --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-fast: all 0.15s ease;
    
    /* Font sizes */
    --font-size-base: 16px;
}

/* Dark Theme */
[data-theme="dark"] {
    --text: #F9FAFB;
    --text-secondary: #D1D5DB;
    --muted: #6B7280;
    --border: #374151;
    --background: #111827;
    --card: #1F2937;
    --overlay: rgba(0, 0, 0, 0.7);
    --primary-light: #1E3A5F;
    --success-light: #064E3B;
    --warning-light: #78350F;
    --danger-light: #7F1D1D;
}

/* High Contrast */
[data-theme="high-contrast"] {
    --primary: #0066FF;
    --text: #000000;
    --background: #FFFFFF;
    --card: #FFFFFF;
    --border: #000000;
}

/* Font Size Adjustments */
.font-size-large { --font-size-base: 18px; }
.font-size-xlarge { --font-size-base: 20px; }

/* ============================================
   RESET & BASE
   ============================================ */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

html { font-size: var(--font-size-base); scroll-behavior: smooth; }

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--background);
    color: var(--text);
    line-height: 1.5;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Focus Visible for Accessibility */
:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
}

/* Skip Link */
.skip-link {
    position: absolute;
    top: -40px;
    left: 0;
    background: var(--primary);
    color: white;
    padding: 8px 16px;
    z-index: 10000;
    transition: top 0.3s;
}
.skip-link:focus { top: 0; }

/* ============================================
   ANIMATIONS
   ============================================ */
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
@keyframes slideOut { from { transform: translateX(0); } to { transform: translateX(100%); } }
@keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
@keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Power Save Mode */
.power-save * { animation: none !important; transition: none !important; }

/* ============================================
   SKELETON LOADERS
   ============================================ */
.skeleton {
    background: linear-gradient(90deg, var(--border) 25%, var(--background) 50%, var(--border) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: var(--radius-sm);
}

.skeleton-text { height: 1em; margin-bottom: 0.5em; }
.skeleton-text:last-child { width: 70%; }
.skeleton-title { height: 1.5em; width: 60%; margin-bottom: 1em; }
.skeleton-avatar { width: 48px; height: 48px; border-radius: 50%; }
.skeleton-card { height: 120px; border-radius: var(--radius); }
.skeleton-kpi { height: 140px; border-radius: var(--radius-lg); }

/* ============================================
   LAYOUT
   ============================================ */
.app { display: flex; min-height: 100vh; }

.main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    transition: margin-left 0.3s ease;
}

.sidebar-collapsed .main-content { margin-left: var(--sidebar-collapsed); }

.page-content {
    flex: 1;
    padding: 24px;
    animation: fadeIn 0.3s ease;
}

/* ============================================
   SIDEBAR
   ============================================ */
.sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: var(--sidebar-width);
    background: var(--card);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    z-index: 100;
    transition: width 0.3s ease, transform 0.3s ease;
}

.sidebar-collapsed .sidebar { width: var(--sidebar-collapsed); }

.sidebar-header {
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border);
}

.sidebar-logo {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 800;
    font-size: 18px;
    flex-shrink: 0;
}

.sidebar-title {
    font-weight: 700;
    font-size: 20px;
    white-space: nowrap;
    overflow: hidden;
}

.sidebar-collapsed .sidebar-title { display: none; }

.sidebar-nav {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
    overflow-x: hidden;
}

.nav-section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
    padding: 16px 12px 8px;
    white-space: nowrap;
}

.sidebar-collapsed .nav-section-title { display: none; }

.nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 14px;
    border-radius: 10px;
    cursor: pointer;
    transition: var(--transition-fast);
    margin-bottom: 2px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    text-decoration: none;
    position: relative;
}

.nav-item:hover { background: var(--background); color: var(--text); }
.nav-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }

.nav-item-icon {
    font-size: 20px;
    width: 24px;
    text-align: center;
    flex-shrink: 0;
}

.nav-item-text { white-space: nowrap; overflow: hidden; }
.sidebar-collapsed .nav-item-text { display: none; }

.nav-item-badge {
    margin-left: auto;
    background: var(--danger);
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
}

.sidebar-collapsed .nav-item-badge {
    position: absolute;
    top: 4px;
    right: 4px;
    padding: 2px 5px;
    font-size: 9px;
}

/* Tooltip for collapsed sidebar */
.nav-item[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    left: calc(100% + 10px);
    top: 50%;
    transform: translateY(-50%);
    background: var(--text);
    color: var(--background);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    white-space: nowrap;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
}

.sidebar-collapsed .nav-item[data-tooltip]:hover::after { opacity: 1; }

/* ============================================
   HEADER
   ============================================ */
.header {
    height: var(--header-height);
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 50;
}

.header-left { display: flex; align-items: center; gap: 16px; }
.header-right { display: flex; align-items: center; gap: 12px; }

.header-btn {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: none;
    background: var(--background);
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition-fast);
    position: relative;
    color: var(--text);
}

.header-btn:hover { background: var(--border); transform: scale(1.05); }
.header-btn:active { transform: scale(0.95); }

.header-btn .badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--danger);
    color: white;
    font-size: 10px;
    font-weight: 700;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--card);
}

/* Realtime Indicator */
.realtime-indicator {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 20px;
}

.realtime-indicator.connected { background: var(--success-light); color: var(--success); }
.realtime-indicator.disconnected { background: var(--danger-light); color: var(--danger); }
.realtime-indicator.connecting { background: var(--warning-light); color: var(--warning); }

.realtime-indicator .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
}

.realtime-indicator.connected .dot { animation: pulse 2s infinite; }

/* User Menu */
.user-menu {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 12px 6px 6px;
    border-radius: 12px;
    cursor: pointer;
    transition: var(--transition-fast);
}

.user-menu:hover { background: var(--background); }

.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 14px;
}

.user-info { line-height: 1.3; }
.user-name { font-weight: 600; font-size: 14px; }
.user-role { font-size: 12px; color: var(--muted); }

/* ============================================
   CARDS & PANELS
   ============================================ */
.card {
    background: var(--card);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    overflow: hidden;
    transition: var(--transition);
}

.card:hover { box-shadow: var(--shadow); }

.card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-title {
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.card-body { padding: 20px; }
.card-footer { padding: 16px 20px; border-top: 1px solid var(--border); background: var(--background); }

/* KPI Cards */
.kpi-card {
    padding: 20px;
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.kpi-card:active { transform: scale(0.98); }

.kpi-card.gradient { color: white; }
.kpi-card.normal { background: var(--card); border: 1px solid var(--border); }

.kpi-card.primary { background: linear-gradient(135deg, #3B82F6, #1D4ED8); }
.kpi-card.success { background: linear-gradient(135deg, #10B981, #059669); }
.kpi-card.warning { background: linear-gradient(135deg, #F59E0B, #D97706); }
.kpi-card.danger { background: linear-gradient(135deg, #EF4444, #DC2626); }
.kpi-card.purple { background: linear-gradient(135deg, #8B5CF6, #7C3AED); }
.kpi-card.teal { background: linear-gradient(135deg, #14B8A6, #0D9488); }
.kpi-card.info { background: linear-gradient(135deg, #06B6D4, #0891B2); }

.kpi-header { display: flex; justify-content: space-between; align-items: flex-start; }
.kpi-value { font-size: 36px; font-weight: 800; line-height: 1; }
.kpi-label { font-size: 14px; opacity: 0.9; margin-top: 4px; }
.kpi-icon { font-size: 32px; opacity: 0.9; }
.kpi-footer { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.2); font-size: 13px; }
.kpi-card.normal .kpi-footer { border-top-color: var(--border); }

/* ============================================
   BUTTONS
   ============================================ */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: var(--transition-fast);
    border: none;
    text-decoration: none;
    white-space: nowrap;
}

.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover:not(:disabled) { background: var(--primary-dark); }

.btn-secondary { background: var(--background); color: var(--text); border: 1px solid var(--border); }
.btn-secondary:hover:not(:disabled) { background: var(--border); }

.btn-success { background: var(--success); color: white; }
.btn-success:hover:not(:disabled) { filter: brightness(0.9); }

.btn-danger { background: var(--danger); color: white; }
.btn-danger:hover:not(:disabled) { filter: brightness(0.9); }

.btn-ghost { background: transparent; color: var(--text-secondary); }
.btn-ghost:hover:not(:disabled) { background: var(--background); color: var(--text); }

.btn-sm { padding: 6px 12px; font-size: 13px; }
.btn-lg { padding: 14px 28px; font-size: 16px; }
.btn-icon { width: 40px; height: 40px; padding: 0; }

/* ============================================
   FORMS
   ============================================ */
.form-group { margin-bottom: 16px; }

.form-label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 6px;
    color: var(--text-secondary);
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 14px;
    background: var(--card);
    color: var(--text);
    transition: var(--transition-fast);
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
}

.form-input::placeholder { color: var(--muted); }

.form-textarea { min-height: 100px; resize: vertical; }

/* ============================================
   BADGES
   ============================================ */
.badge {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.badge-primary { background: var(--primary-light); color: var(--primary); }
.badge-success { background: var(--success-light); color: var(--success); }
.badge-warning { background: var(--warning-light); color: var(--warning); }
.badge-danger { background: var(--danger-light); color: var(--danger); }
.badge-info { background: var(--info-light); color: var(--info); }
.badge-secondary { background: var(--background); color: var(--text-secondary); }

/* ============================================
   MODALS
   ============================================ */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: var(--overlay);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 24px;
    animation: fadeIn 0.2s ease;
}

.modal {
    background: var(--card);
    border-radius: var(--radius-xl);
    max-width: 560px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: scaleIn 0.2s ease;
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title { font-size: 18px; font-weight: 700; }

.modal-close {
    width: 32px;
    height: 32px;
    border: none;
    background: var(--background);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: var(--muted);
    transition: var(--transition-fast);
}

.modal-close:hover { background: var(--border); color: var(--text); }

.modal-body { padding: 24px; overflow-y: auto; flex: 1; }
.modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

/* ============================================
   TOAST NOTIFICATIONS
   ============================================ */
.toast-container {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 400px;
}

.toast {
    background: var(--card);
    border-radius: var(--radius);
    padding: 16px 20px;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: flex-start;
    gap: 12px;
    animation: slideIn 0.3s ease;
    border-left: 4px solid var(--primary);
}

.toast.success { border-left-color: var(--success); }
.toast.warning { border-left-color: var(--warning); }
.toast.error { border-left-color: var(--danger); }

.toast-icon { font-size: 20px; flex-shrink: 0; }
.toast-content { flex: 1; }
.toast-title { font-weight: 600; margin-bottom: 2px; }
.toast-message { font-size: 14px; color: var(--text-secondary); }

.toast-close {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: var(--muted);
    padding: 0;
}

/* ============================================
   TABLES
   ============================================ */
.table-container { overflow-x: auto; }

.table {
    width: 100%;
    border-collapse: collapse;
}

.table th, .table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.table th {
    font-weight: 600;
    font-size: 13px;
    color: var(--text-secondary);
    background: var(--background);
    position: sticky;
    top: 0;
}

.table tbody tr { transition: var(--transition-fast); }
.table tbody tr:hover { background: var(--background); }

/* ============================================
   DROPDOWN
   ============================================ */
.dropdown { position: relative; }

.dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    min-width: 200px;
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow-xl);
    border: 1px solid var(--border);
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: var(--transition-fast);
}

.dropdown-menu.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.dropdown-item {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: var(--transition-fast);
    font-size: 14px;
}

.dropdown-item:hover { background: var(--background); }
.dropdown-item:first-child { border-radius: var(--radius) var(--radius) 0 0; }
.dropdown-item:last-child { border-radius: 0 0 var(--radius) var(--radius); }

.dropdown-divider { height: 1px; background: var(--border); margin: 4px 0; }

/* ============================================
   TABS
   ============================================ */
.tabs {
    display: flex;
    gap: 4px;
    background: var(--background);
    padding: 4px;
    border-radius: var(--radius);
    width: fit-content;
}

.tab {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
    background: transparent;
    color: var(--muted);
    transition: var(--transition-fast);
}

.tab:hover { color: var(--text); }
.tab.active { background: var(--card); color: var(--primary); box-shadow: var(--shadow-sm); }

/* ============================================
   CHAT FAB
   ============================================ */
.chat-fab {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #25D366, #128C7E);
    color: white;
    border: none;
    cursor: pointer;
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 20px rgba(37, 211, 102, 0.4);
    transition: var(--transition);
    z-index: 999;
}

.chat-fab:hover { transform: scale(1.1); box-shadow: 0 6px 30px rgba(37, 211, 102, 0.5); }
.chat-fab:active { transform: scale(0.95); }

.chat-fab .badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--danger);
    min-width: 22px;
    height: 22px;
    border-radius: 11px;
    font-size: 12px;
    font-weight: 700;
    border: 2px solid white;
}

/* ============================================
   AI ASSISTANT
   ============================================ */
.ai-suggestion {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: linear-gradient(135deg, #F3E8FF, #E0E7FF);
    border-radius: var(--radius-lg);
    border-left: 4px solid var(--secondary);
    margin-bottom: 16px;
    animation: slideUp 0.3s ease;
}

[data-theme="dark"] .ai-suggestion {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(99, 102, 241, 0.2));
}

.ai-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--secondary), #6366F1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}

.ai-content { flex: 1; }
.ai-content p { font-size: 14px; margin-bottom: 12px; }
.ai-actions { display: flex; gap: 8px; flex-wrap: wrap; }

/* ============================================
   SWIPE ACTIONS
   ============================================ */
.swipe-container { position: relative; overflow: hidden; }

.swipe-action-left, .swipe-action-right {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 20px;
}

.swipe-action-left { left: 0; background: var(--danger); }
.swipe-action-right { right: 0; background: var(--primary); }

.swipe-content {
    background: var(--card);
    position: relative;
    z-index: 1;
    transition: transform 0.3s ease;
}

/* ============================================
   RESPONSIVE
   ============================================ */
@media (max-width: 1024px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.open { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .sidebar-collapsed .main-content { margin-left: 0; }
}

@media (max-width: 768px) {
    .page-content { padding: 16px; }
    .header { padding: 0 16px; }
    .modal { margin: 16px; max-height: calc(100vh - 32px); }
    .toast-container { left: 16px; right: 16px; max-width: none; }
    .chat-fab { bottom: 16px; right: 16px; width: 56px; height: 56px; }
}

/* ============================================
   PRINT
   ============================================ */
@media print {
    .sidebar, .header, .chat-fab, .toast-container { display: none !important; }
    .main-content { margin-left: 0 !important; }
    .page-content { padding: 0 !important; }
    .card { break-inside: avoid; }
}

/* ============================================
   LOADING SCREEN
   ============================================ */
#loading {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
}

#loading .spinner {
    width: 48px;
    height: 48px;
    border: 3px solid rgba(255,255,255,0.2);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

#loading .loading-text {
    color: white;
    margin-top: 16px;
    font-weight: 500;
}
    </style>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Aller au contenu principal</a>
    
    <!-- Loading Screen -->
    <div id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Chargement de StockApp...</div>
    </div>
    
    <div id="root"></div>
    
<script>
// ============================================
// CONFIGURATION
// ============================================
const CONFIG = {
    SUPABASE_URL: 'https://xxxxx.supabase.co',
    SUPABASE_ANON_KEY: 'xxxxx',
    APP_VERSION: '8.0.0',
    CACHE_TTL: 5 * 60 * 1000, // 5 minutes
    DEBOUNCE_DELAY: 300,
    MAX_RETRIES: 3,
    OFFLINE_QUEUE_KEY: 'stockapp_offline_queue',
    WIDGET_CONFIG_KEY: 'stockapp_widgets',
    SHORTCUTS_KEY: 'stockapp_shortcuts'
};

// ============================================
// REACT SETUP
// ============================================
const { useState, useEffect, useMemo, useCallback, useRef, useReducer, createContext, useContext, memo, lazy, Suspense } = React;
const h = React.createElement;

// ============================================
// SUPABASE CLIENT (ou mock en mode demo)
// ============================================
const IS_DEMO_MODE = CONFIG.SUPABASE_URL.includes('xxxxx');

// Mock Supabase pour le mode demo
const supabaseMock = {
    from: () => ({
        select: () => ({ order: () => ({ data: [], error: null }), eq: () => ({ single: () => ({ data: null, error: null }) }), data: [], error: null }),
        insert: () => ({ data: null, error: null }),
        update: () => ({ eq: () => ({ data: null, error: null }) }),
        delete: () => ({ eq: () => ({ data: null, error: null }) })
    }),
    auth: {
        getSession: async () => ({ data: { session: null }, error: null }),
        getUser: async () => ({ data: { user: null }, error: null }),
        signInWithPassword: async () => ({ data: null, error: { message: 'Mode demo - utilisez le bouton Demo' } }),
        signOut: async () => ({ error: null }),
        onAuthStateChange: () => ({ data: { subscription: { unsubscribe: () => {} } } })
    },
    channel: () => ({
        on: () => ({ subscribe: () => {} })
    }),
    removeChannel: () => {}
};

const supabaseClient = IS_DEMO_MODE 
    ? supabaseMock 
    : window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);

// ============================================
// UTILITIES
// ============================================

// Debounce
const debounce = (fn, delay) => {
    let timeoutId;
    return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), delay);
    };
};

// Throttle
const throttle = (fn, limit) => {
    let inThrottle;
    return (...args) => {
        if (!inThrottle) {
            fn(...args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
};

// Deep Equal
const deepEqual = (a, b) => JSON.stringify(a) === JSON.stringify(b);

// Format Date
const formatDate = (date) => {
    if (!date) return '-';
    const d = new Date(date);
    const now = new Date();
    const diffDays = Math.floor((d - now) / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return "Aujourd'hui";
    if (diffDays === 1) return 'Demain';
    if (diffDays === -1) return 'Hier';
    
    return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
};

// Format Relative Time
const formatRelative = (date) => {
    if (!date) return '-';
    const d = new Date(date);
    const now = new Date();
    const diffMs = now - d;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return "Ã€ l'instant";
    if (diffMins < 60) return `Il y a ${diffMins} min`;
    if (diffHours < 24) return `Il y a ${diffHours}h`;
    if (diffDays < 7) return `Il y a ${diffDays}j`;
    
    return d.toLocaleDateString('fr-FR');
};

// Format Currency
const formatCurrency = (amount) => {
    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(amount || 0);
};

// Generate UUID
const generateId = () => crypto.randomUUID?.() || Math.random().toString(36).substr(2, 9);

// Haptic Feedback
const haptic = (type = 'light') => {
    if ('vibrate' in navigator) {
        const patterns = { light: [10], medium: [20], heavy: [30, 10, 30] };
        navigator.vibrate(patterns[type] || patterns.light);
    }
};

// Play Sound
const playSound = (type) => {
    const sounds = {
        success: [523.25, 0.1],
        error: [261.63, 0.2],
        notification: [783.99, 0.15]
    };
    if (sounds[type]) {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.value = sounds[type][0];
            gain.gain.value = 0.1;
            osc.start();
            osc.stop(ctx.currentTime + sounds[type][1]);
        } catch (e) {}
    }
};

// ============================================
// DATA CACHE SERVICE
// ============================================
const DataCache = {
    storage: new Map(),
    
    get(key) {
        const item = this.storage.get(key);
        if (!item) return null;
        if (Date.now() > item.expires) {
            this.storage.delete(key);
            return null;
        }
        return item.data;
    },
    
    set(key, data, ttl = CONFIG.CACHE_TTL) {
        this.storage.set(key, { data, expires: Date.now() + ttl });
    },
    
    invalidate(key) {
        if (key) {
            this.storage.delete(key);
        } else {
            this.storage.clear();
        }
    },
    
    has(key) {
        return this.get(key) !== null;
    }
};

// ============================================
// OFFLINE QUEUE SERVICE
// ============================================
const OfflineQueue = {
    queue: [],
    
    init() {
        const saved = localStorage.getItem(CONFIG.OFFLINE_QUEUE_KEY);
        if (saved) {
            try { this.queue = JSON.parse(saved); } catch (e) {}
        }
    },
    
    add(action) {
        this.queue.push({ ...action, id: generateId(), timestamp: Date.now() });
        this.save();
    },
    
    save() {
        localStorage.setItem(CONFIG.OFFLINE_QUEUE_KEY, JSON.stringify(this.queue));
    },
    
    async process() {
        if (!navigator.onLine || this.queue.length === 0) return;
        
        const toProcess = [...this.queue];
        this.queue = [];
        this.save();
        
        for (const action of toProcess) {
            try {
                await this.execute(action);
            } catch (e) {
                console.error('Failed to process offline action:', e);
                this.queue.push(action);
            }
        }
        this.save();
    },
    
    async execute(action) {
        const { table, type, data, id } = action;
        switch (type) {
            case 'insert':
                await supabaseClient.from(table).insert(data);
                break;
            case 'update':
                await supabaseClient.from(table).update(data).eq('id', id);
                break;
            case 'delete':
                await supabaseClient.from(table).delete().eq('id', id);
                break;
        }
    },
    
    getCount() {
        return this.queue.length;
    }
};

// Initialize offline queue
OfflineQueue.init();

// Process queue when back online
window.addEventListener('online', () => OfflineQueue.process());

// ============================================
// API SERVICE (Centralized)
// ============================================
const API = {
    async request(table, action, data = null, options = {}) {
        const cacheKey = `${table}:${action}:${JSON.stringify(options)}`;
        
        // Check cache for GET requests
        if (action === 'select' && DataCache.has(cacheKey)) {
            return { data: DataCache.get(cacheKey), error: null, cached: true };
        }
        
        // Handle offline
        if (!navigator.onLine && action !== 'select') {
            OfflineQueue.add({ table, type: action, data, ...options });
            return { data: null, error: null, offline: true };
        }
        
        try {
            let query = supabaseClient.from(table);
            
            switch (action) {
                case 'select':
                    query = query.select(options.select || '*');
                    if (options.filter) {
                        Object.entries(options.filter).forEach(([key, value]) => {
                            query = query.eq(key, value);
                        });
                    }
                    if (options.order) {
                        query = query.order(options.order.column, { ascending: options.order.ascending ?? true });
                    }
                    if (options.limit) query = query.limit(options.limit);
                    break;
                case 'insert':
                    query = query.insert(data).select();
                    break;
                case 'update':
                    query = query.update(data).eq('id', options.id).select();
                    break;
                case 'delete':
                    query = query.delete().eq('id', options.id);
                    break;
                case 'upsert':
                    query = query.upsert(data).select();
                    break;
            }
            
            const result = await query;
            
            // Cache GET results
            if (action === 'select' && !result.error) {
                DataCache.set(cacheKey, result.data);
            }
            
            // Invalidate cache on mutations
            if (['insert', 'update', 'delete', 'upsert'].includes(action)) {
                DataCache.invalidate();
            }
            
            return result;
        } catch (error) {
            console.error(`API ${action} error:`, error);
            return { data: null, error };
        }
    },
    
    // Convenience methods
    tasks: {
        list: (options) => API.request('tasks', 'select', null, options),
        get: (id) => API.request('tasks', 'select', null, { filter: { id } }),
        create: (data) => API.request('tasks', 'insert', data),
        update: (id, data) => API.request('tasks', 'update', data, { id }),
        delete: (id) => API.request('tasks', 'delete', null, { id })
    },
    
    parts: {
        list: (options) => API.request('parts', 'select', null, options),
        get: (id) => API.request('parts', 'select', null, { filter: { id } }),
        create: (data) => API.request('parts', 'insert', data),
        update: (id, data) => API.request('parts', 'update', data, { id }),
        delete: (id) => API.request('parts', 'delete', null, { id })
    },
    
    equipments: {
        list: (options) => API.request('equipements', 'select', null, options),
        get: (id) => API.request('equipements', 'select', null, { filter: { id } }),
        create: (data) => API.request('equipements', 'insert', data),
        update: (id, data) => API.request('equipements', 'update', data, { id })
    },
    
    requests: {
        list: (options) => API.request('requests', 'select', null, options),
        create: (data) => API.request('requests', 'insert', data),
        update: (id, data) => API.request('requests', 'update', data, { id })
    },
    
    orders: {
        list: (options) => API.request('orders', 'select', null, options),
        create: (data) => API.request('orders', 'insert', data),
        update: (id, data) => API.request('orders', 'update', data, { id })
    }
};

// ============================================
// REALTIME SERVICE
// ============================================
const RealtimeService = {
    channels: new Map(),
    listeners: new Map(),
    status: 'disconnected',
    
    subscribe(table, callback) {
        const listenerId = generateId();
        
        if (!this.channels.has(table)) {
            const channel = supabaseClient
                .channel(`public:${table}`)
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table },
                    (payload) => {
                        // Notify all listeners for this table
                        const tableListeners = this.listeners.get(table) || [];
                        tableListeners.forEach(({ callback }) => callback(payload));
                        
                        // Invalidate cache
                        DataCache.invalidate();
                    }
                )
                .subscribe((status) => {
                    this.status = status === 'SUBSCRIBED' ? 'connected' : 'connecting';
                });
            
            this.channels.set(table, channel);
            this.listeners.set(table, []);
        }
        
        const tableListeners = this.listeners.get(table);
        tableListeners.push({ id: listenerId, callback });
        
        return () => this.unsubscribe(table, listenerId);
    },
    
    unsubscribe(table, listenerId) {
        const tableListeners = this.listeners.get(table) || [];
        const filtered = tableListeners.filter(l => l.id !== listenerId);
        this.listeners.set(table, filtered);
        
        // If no more listeners, remove channel
        if (filtered.length === 0) {
            const channel = this.channels.get(table);
            if (channel) {
                supabaseClient.removeChannel(channel);
                this.channels.delete(table);
            }
        }
    },
    
    subscribeToAll(tables, callback) {
        const unsubscribes = tables.map(table => this.subscribe(table, callback));
        return () => unsubscribes.forEach(unsub => unsub());
    },
    
    getStatus() {
        return this.status;
    }
};

// ============================================
// NOTIFICATION SERVICE
// ============================================
const NotificationService = {
    permission: 'default',
    
    async init() {
        if ('Notification' in window) {
            this.permission = Notification.permission;
            if (this.permission === 'default') {
                this.permission = await Notification.requestPermission();
            }
        }
    },
    
    async send(title, options = {}) {
        if (this.permission !== 'granted') return;
        
        try {
            const notification = new Notification(title, {
                icon: '/icon-192.png',
                badge: '/badge-72.png',
                vibrate: [200, 100, 200],
                ...options
            });
            
            notification.onclick = () => {
                window.focus();
                notification.close();
                if (options.onClick) options.onClick();
            };
            
            return notification;
        } catch (e) {
            console.error('Notification error:', e);
        }
    },
    
    // Smart notification rules
    rules: [
        {
            id: 'equipment_stop',
            condition: (data) => data.equipements?.some(e => e.statut === 'arret'),
            title: (data) => `ðŸš¨ ${data.equipements.filter(e => e.statut === 'arret').length} Ã©quipement(s) Ã  l'arrÃªt`,
            priority: 'critical',
            channels: ['push', 'sms', 'email']
        },
        {
            id: 'task_overdue',
            condition: (data) => data.tasks?.some(t => t.due_date && new Date(t.due_date) < new Date() && t.status !== 'termine'),
            title: (data) => `â° ${data.tasks.filter(t => t.due_date && new Date(t.due_date) < new Date() && t.status !== 'termine').length} tÃ¢che(s) en retard`,
            priority: 'high',
            channels: ['push']
        },
        {
            id: 'stock_critical',
            condition: (data) => data.parts?.some(p => p.quantity <= (p.min_stock || 0)),
            title: (data) => `ðŸ“¦ ${data.parts.filter(p => p.quantity <= (p.min_stock || 0)).length} article(s) en stock critique`,
            priority: 'medium',
            channels: ['push', 'email']
        }
    ],
    
    checkRules(data) {
        const triggered = [];
        for (const rule of this.rules) {
            if (rule.condition(data)) {
                triggered.push({
                    ...rule,
                    title: typeof rule.title === 'function' ? rule.title(data) : rule.title
                });
            }
        }
        return triggered;
    }
};

// ============================================
// AI ASSISTANT SERVICE
// ============================================
const AIAssistant = {
    suggestions: [],
    
    analyze(data) {
        const suggestions = [];
        
        // Check for high-risk equipment
        const riskEquipments = (data.equipements || []).filter(e => (e.score_ml || 0) > 70);
        if (riskEquipments.length > 0) {
            const top = riskEquipments.sort((a, b) => b.score_ml - a.score_ml)[0];
            suggestions.push({
                id: 'risk_equipment',
                type: 'warning',
                icon: 'âš ï¸',
                title: 'Ã‰quipement Ã  risque dÃ©tectÃ©',
                message: `"${top.nom || top.immeuble}" prÃ©sente un score de risque de ${top.score_ml}%. Recommandation: maintenance prÃ©ventive sous 48h.`,
                actions: [
                    { label: 'ðŸ“… Planifier', action: 'schedule_maintenance', data: top },
                    { label: 'Voir dÃ©tails', action: 'view_equipment', data: top }
                ]
            });
        }
        
        // Check for stock needed for upcoming tasks
        const upcomingTasks = (data.tasks || []).filter(t => {
            const date = new Date(t.scheduled_date);
            const now = new Date();
            const diffDays = (date - now) / (1000 * 60 * 60 * 24);
            return diffDays >= 0 && diffDays <= 7 && t.status !== 'termine';
        });
        
        const criticalStock = (data.parts || []).filter(p => p.quantity <= (p.min_stock || 0));
        if (criticalStock.length > 0 && upcomingTasks.length > 0) {
            suggestions.push({
                id: 'stock_alert',
                type: 'alert',
                icon: 'ðŸ“¦',
                title: 'Stock insuffisant pour interventions',
                message: `${criticalStock.length} article(s) en rupture nÃ©cessaires pour les ${upcomingTasks.length} interventions de cette semaine.`,
                actions: [
                    { label: 'ðŸ›’ Commander', action: 'create_order', data: criticalStock },
                    { label: 'Voir stock', action: 'navigate', data: 'stock' }
                ]
            });
        }
        
        // Check for upcoming controls
        const controlsExpiring = (data.equipements || []).filter(e => {
            if (!e.prochain_controle) return false;
            const days = (new Date(e.prochain_controle) - new Date()) / (1000 * 60 * 60 * 24);
            return days > 0 && days <= 30;
        });
        
        if (controlsExpiring.length > 0) {
            suggestions.push({
                id: 'controls_expiring',
                type: 'info',
                icon: 'ðŸ“‹',
                title: 'ContrÃ´les Ã  planifier',
                message: `${controlsExpiring.length} Ã©quipement(s) ont un contrÃ´le rÃ©glementaire dans les 30 prochains jours.`,
                actions: [
                    { label: 'Voir liste', action: 'navigate', data: 'parc' }
                ]
            });
        }
        
        this.suggestions = suggestions;
        return suggestions;
    },
    
    getSuggestions() {
        return this.suggestions;
    },
    
    dismissSuggestion(id) {
        this.suggestions = this.suggestions.filter(s => s.id !== id);
    }
};

// ============================================
// KEYBOARD SHORTCUTS SERVICE
// ============================================
const KeyboardService = {
    shortcuts: new Map(),
    enabled: true,
    
    defaultShortcuts: [
        { key: 'k', meta: true, action: 'search', label: 'Recherche globale' },
        { key: 'n', meta: true, action: 'new', label: 'Nouveau' },
        { key: 's', meta: true, action: 'save', label: 'Sauvegarder' },
        { key: 'Escape', action: 'close', label: 'Fermer' },
        { key: '/', meta: true, action: 'help', label: 'Aide raccourcis' },
        { key: 'd', sequence: 'g', action: 'goto_dashboard', label: 'Dashboard' },
        { key: 's', sequence: 'g', action: 'goto_stock', label: 'Stock' },
        { key: 't', sequence: 'g', action: 'goto_tasks', label: 'Travaux' },
        { key: 'p', sequence: 'g', action: 'goto_planning', label: 'Planning' }
    ],
    
    sequenceBuffer: '',
    sequenceTimeout: null,
    
    init(handlers) {
        this.handlers = handlers;
        
        document.addEventListener('keydown', (e) => {
            if (!this.enabled) return;
            
            // Ignore if in input
            if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
                if (e.key === 'Escape') {
                    e.target.blur();
                }
                return;
            }
            
            // Handle sequence shortcuts (g + d, g + s, etc.)
            if (this.sequenceBuffer) {
                clearTimeout(this.sequenceTimeout);
                const shortcut = this.defaultShortcuts.find(
                    s => s.sequence === this.sequenceBuffer && s.key === e.key.toLowerCase()
                );
                this.sequenceBuffer = '';
                
                if (shortcut && this.handlers[shortcut.action]) {
                    e.preventDefault();
                    this.handlers[shortcut.action]();
                    return;
                }
            }
            
            // Start sequence
            if (e.key.toLowerCase() === 'g' && !e.metaKey && !e.ctrlKey) {
                this.sequenceBuffer = 'g';
                this.sequenceTimeout = setTimeout(() => {
                    this.sequenceBuffer = '';
                }, 1000);
                return;
            }
            
            // Handle meta shortcuts
            const shortcut = this.defaultShortcuts.find(s => 
                s.key.toLowerCase() === e.key.toLowerCase() &&
                !!s.meta === (e.metaKey || e.ctrlKey) &&
                !s.sequence
            );
            
            if (shortcut && this.handlers[shortcut.action]) {
                e.preventDefault();
                this.handlers[shortcut.action]();
            }
        });
    },
    
    enable() { this.enabled = true; },
    disable() { this.enabled = false; },
    
    getShortcuts() {
        return this.defaultShortcuts;
    }
};

// ============================================
// WIDGET SERVICE
// ============================================
const WidgetService = {
    defaultWidgets: [
        { id: 'kpi-tasks', name: 'KPI Travaux', size: '1x1', position: { x: 0, y: 0 } },
        { id: 'kpi-stock', name: 'KPI Stock', size: '1x1', position: { x: 1, y: 0 } },
        { id: 'kpi-requests', name: 'KPI Demandes', size: '1x1', position: { x: 2, y: 0 } },
        { id: 'kpi-orders', name: 'KPI Commandes', size: '1x1', position: { x: 3, y: 0 } },
        { id: 'list-tasks', name: 'Prochains travaux', size: '2x1', position: { x: 0, y: 1 } },
        { id: 'list-requests', name: 'DerniÃ¨res demandes', size: '2x1', position: { x: 2, y: 1 } }
    ],
    
    availableWidgets: [
        { id: 'kpi-tasks', name: 'KPI Travaux', size: '1x1', icon: 'ðŸ”§' },
        { id: 'kpi-stock', name: 'KPI Stock', size: '1x1', icon: 'ðŸ“¦' },
        { id: 'kpi-requests', name: 'KPI Demandes', size: '1x1', icon: 'ðŸ“©' },
        { id: 'kpi-orders', name: 'KPI Commandes', size: '1x1', icon: 'ðŸ›’' },
        { id: 'kpi-equipments', name: 'KPI Ã‰quipements', size: '1x1', icon: 'ðŸ›—' },
        { id: 'kpi-sla', name: 'Taux SLA', size: '1x1', icon: 'âœ…' },
        { id: 'list-tasks', name: 'Prochains travaux', size: '2x1', icon: 'ðŸ“…' },
        { id: 'list-requests', name: 'DerniÃ¨res demandes', size: '2x1', icon: 'ðŸ“©' },
        { id: 'list-urgent', name: 'Urgences', size: '1x2', icon: 'ðŸš¨' },
        { id: 'chart-monthly', name: 'Graphique mensuel', size: '2x1', icon: 'ðŸ“Š' },
        { id: 'chart-by-type', name: 'Par type', size: '2x1', icon: 'ðŸ“ˆ' },
        { id: 'map-interventions', name: 'Carte interventions', size: '2x2', icon: 'ðŸ—ºï¸' },
        { id: 'calendar-week', name: 'Planning semaine', size: '2x1', icon: 'ðŸ“…' },
        { id: 'ai-suggestions', name: 'Suggestions IA', size: '2x1', icon: 'ðŸ¤–' }
    ],
    
    getUserWidgets() {
        const saved = localStorage.getItem(CONFIG.WIDGET_CONFIG_KEY);
        if (saved) {
            try { return JSON.parse(saved); } catch (e) {}
        }
        return this.defaultWidgets;
    },
    
    saveWidgets(widgets) {
        localStorage.setItem(CONFIG.WIDGET_CONFIG_KEY, JSON.stringify(widgets));
    },
    
    resetWidgets() {
        localStorage.removeItem(CONFIG.WIDGET_CONFIG_KEY);
        return this.defaultWidgets;
    }
};

// ============================================
// AUDIT LOG SERVICE
// ============================================
const AuditLog = {
    async log(action, details = {}) {
        const user = supabaseClient.auth.getUser();
        
        await supabaseClient.from('audit_logs').insert({
            user_id: user?.data?.user?.id,
            action,
            details,
            ip_address: null, // Would need server-side
            user_agent: navigator.userAgent,
            timestamp: new Date().toISOString()
        });
    },
    
    // Actions to log
    ACTIONS: {
        LOGIN: 'login',
        LOGOUT: 'logout',
        CREATE: 'create',
        UPDATE: 'update',
        DELETE: 'delete',
        EXPORT: 'export',
        PERMISSION_CHANGE: 'permission_change'
    }
};

// ============================================
// BATTERY AWARE SERVICE
// ============================================
const BatteryService = {
    battery: null,
    powerSaveMode: false,
    
    async init() {
        if ('getBattery' in navigator) {
            try {
                this.battery = await navigator.getBattery();
                this.checkLevel();
                this.battery.addEventListener('levelchange', () => this.checkLevel());
            } catch (e) {}
        }
    },
    
    checkLevel() {
        if (this.battery && this.battery.level < 0.2 && !this.battery.charging) {
            this.enablePowerSave();
        } else {
            this.disablePowerSave();
        }
    },
    
    enablePowerSave() {
        if (this.powerSaveMode) return;
        this.powerSaveMode = true;
        document.body.classList.add('power-save');
    },
    
    disablePowerSave() {
        if (!this.powerSaveMode) return;
        this.powerSaveMode = false;
        document.body.classList.remove('power-save');
    },
    
    isPowerSaveMode() {
        return this.powerSaveMode;
    }
};

// Initialize battery service
BatteryService.init();

// ============================================
// CONTEXT PROVIDERS
// ============================================

// Theme Context
const ThemeContext = createContext({ theme: 'light', setTheme: () => {} });

// User Context
const UserContext = createContext({ user: null, setUser: () => {} });

// Data Context
const DataContext = createContext({ data: {}, dispatch: () => {} });

// Toast Context
const ToastContext = createContext({ showToast: () => {} });

// Navigation Context
const NavigationContext = createContext({ currentPage: 'dashboard', setCurrentPage: () => {} });

console.log('âœ… StockApp v8.0 Services loaded');

// ============================================
// CUSTOM HOOKS
// ============================================

// useDebounce
const useDebounce = (value, delay = CONFIG.DEBOUNCE_DELAY) => {
    const [debouncedValue, setDebouncedValue] = useState(value);
    
    useEffect(() => {
        const handler = setTimeout(() => setDebouncedValue(value), delay);
        return () => clearTimeout(handler);
    }, [value, delay]);
    
    return debouncedValue;
};

// useLocalStorage
const useLocalStorage = (key, initialValue) => {
    const [storedValue, setStoredValue] = useState(() => {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : initialValue;
        } catch (e) {
            return initialValue;
        }
    });
    
    const setValue = (value) => {
        try {
            const valueToStore = value instanceof Function ? value(storedValue) : value;
            setStoredValue(valueToStore);
            localStorage.setItem(key, JSON.stringify(valueToStore));
        } catch (e) {}
    };
    
    return [storedValue, setValue];
};

// useOnlineStatus
const useOnlineStatus = () => {
    const [isOnline, setIsOnline] = useState(navigator.onLine);
    
    useEffect(() => {
        const handleOnline = () => setIsOnline(true);
        const handleOffline = () => setIsOnline(false);
        
        window.addEventListener('online', handleOnline);
        window.addEventListener('offline', handleOffline);
        
        return () => {
            window.removeEventListener('online', handleOnline);
            window.removeEventListener('offline', handleOffline);
        };
    }, []);
    
    return isOnline;
};

// useRealtime
const useRealtime = (tables, callback) => {
    const [status, setStatus] = useState('connecting');
    
    useEffect(() => {
        const channels = [];
        
        tables.forEach(table => {
            const channel = supabaseClient
                .channel(`realtime:${table}`)
                .on('postgres_changes', { event: '*', schema: 'public', table }, (payload) => {
                    callback(table, payload);
                })
                .subscribe((status) => {
                    setStatus(status === 'SUBSCRIBED' ? 'connected' : status === 'CLOSED' ? 'disconnected' : 'connecting');
                });
            
            channels.push(channel);
        });
        
        return () => {
            channels.forEach(channel => supabaseClient.removeChannel(channel));
        };
    }, [tables.join(',')]);
    
    return status;
};

// useKeyboardShortcut
const useKeyboardShortcut = (key, callback, options = {}) => {
    useEffect(() => {
        const handler = (e) => {
            if (options.meta && !(e.metaKey || e.ctrlKey)) return;
            if (options.shift && !e.shiftKey) return;
            if (options.alt && !e.altKey) return;
            if (e.key.toLowerCase() !== key.toLowerCase()) return;
            
            // Ignore if in input
            if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName) && !options.global) return;
            
            e.preventDefault();
            callback(e);
        };
        
        document.addEventListener('keydown', handler);
        return () => document.removeEventListener('keydown', handler);
    }, [key, callback, options.meta, options.shift, options.alt, options.global]);
};

// useIntersectionObserver (for lazy loading)
const useIntersectionObserver = (ref, options = {}) => {
    const [isVisible, setIsVisible] = useState(false);
    
    useEffect(() => {
        if (!ref.current) return;
        
        const observer = new IntersectionObserver(([entry]) => {
            setIsVisible(entry.isIntersecting);
        }, { threshold: 0.1, ...options });
        
        observer.observe(ref.current);
        
        return () => observer.disconnect();
    }, [ref, options.threshold, options.rootMargin]);
    
    return isVisible;
};

// useVirtualList
const useVirtualList = (items, itemHeight, containerHeight) => {
    const [scrollTop, setScrollTop] = useState(0);
    
    const visibleCount = Math.ceil(containerHeight / itemHeight) + 2;
    const startIndex = Math.max(0, Math.floor(scrollTop / itemHeight) - 1);
    const endIndex = Math.min(items.length, startIndex + visibleCount);
    
    const visibleItems = items.slice(startIndex, endIndex).map((item, i) => ({
        ...item,
        index: startIndex + i,
        style: {
            position: 'absolute',
            top: (startIndex + i) * itemHeight,
            height: itemHeight,
            left: 0,
            right: 0
        }
    }));
    
    const totalHeight = items.length * itemHeight;
    
    const onScroll = (e) => setScrollTop(e.target.scrollTop);
    
    return { visibleItems, totalHeight, onScroll, startIndex, endIndex };
};

// useSwipe
const useSwipe = (ref, options = {}) => {
    const [swipeState, setSwipeState] = useState({ direction: null, distance: 0 });
    const startX = useRef(0);
    const startY = useRef(0);
    
    useEffect(() => {
        const element = ref.current;
        if (!element) return;
        
        const handleTouchStart = (e) => {
            startX.current = e.touches[0].clientX;
            startY.current = e.touches[0].clientY;
        };
        
        const handleTouchMove = (e) => {
            const deltaX = e.touches[0].clientX - startX.current;
            const deltaY = e.touches[0].clientY - startY.current;
            
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                setSwipeState({
                    direction: deltaX > 0 ? 'right' : 'left',
                    distance: Math.abs(deltaX)
                });
            }
        };
        
        const handleTouchEnd = () => {
            if (swipeState.distance > (options.threshold || 50)) {
                if (swipeState.direction === 'left' && options.onSwipeLeft) {
                    options.onSwipeLeft();
                } else if (swipeState.direction === 'right' && options.onSwipeRight) {
                    options.onSwipeRight();
                }
            }
            setSwipeState({ direction: null, distance: 0 });
        };
        
        element.addEventListener('touchstart', handleTouchStart);
        element.addEventListener('touchmove', handleTouchMove);
        element.addEventListener('touchend', handleTouchEnd);
        
        return () => {
            element.removeEventListener('touchstart', handleTouchStart);
            element.removeEventListener('touchmove', handleTouchMove);
            element.removeEventListener('touchend', handleTouchEnd);
        };
    }, [ref, options.onSwipeLeft, options.onSwipeRight, options.threshold, swipeState.distance, swipeState.direction]);
    
    return swipeState;
};

// ============================================
// DATA REDUCER
// ============================================
const dataReducer = (state, action) => {
    switch (action.type) {
        case 'SET_DATA':
            return { ...state, ...action.payload };
        case 'SET_LOADING':
            return { ...state, loading: action.payload };
        case 'UPDATE_ITEM':
            const { table, item } = action.payload;
            return {
                ...state,
                [table]: state[table].map(i => i.id === item.id ? { ...i, ...item } : i)
            };
        case 'ADD_ITEM':
            return {
                ...state,
                [action.payload.table]: [...state[action.payload.table], action.payload.item]
            };
        case 'REMOVE_ITEM':
            return {
                ...state,
                [action.payload.table]: state[action.payload.table].filter(i => i.id !== action.payload.id)
            };
        case 'REALTIME_UPDATE':
            const { eventType, new: newRecord, old: oldRecord, table: tableName } = action.payload;
            if (eventType === 'INSERT') {
                return {
                    ...state,
                    [tableName]: [...(state[tableName] || []), newRecord]
                };
            } else if (eventType === 'UPDATE') {
                return {
                    ...state,
                    [tableName]: (state[tableName] || []).map(i => i.id === newRecord.id ? newRecord : i)
                };
            } else if (eventType === 'DELETE') {
                return {
                    ...state,
                    [tableName]: (state[tableName] || []).filter(i => i.id !== oldRecord.id)
                };
            }
            return state;
        default:
            return state;
    }
};

const initialDataState = {
    loading: true,
    tasks: [],
    parts: [],
    orders: [],
    requests: [],
    equipements: [],
    pannes: [],
    entretiens: [],
    users: [],
    categories: []
};

// ============================================
// BASE COMPONENTS
// ============================================

// Skeleton Components
const Skeleton = memo(({ type = 'text', width, height, className = '' }) => {
    const styles = {
        text: { height: '1em', marginBottom: '0.5em' },
        title: { height: '1.5em', width: '60%', marginBottom: '1em' },
        avatar: { width: 48, height: 48, borderRadius: '50%' },
        card: { height: 120, borderRadius: 'var(--radius)' },
        kpi: { height: 140, borderRadius: 'var(--radius-lg)' }
    };
    
    return h('div', {
        className: `skeleton ${className}`,
        style: { ...styles[type], width, height }
    });
});

// Loading Skeleton for Dashboard
const DashboardSkeleton = memo(() => {
    return h('div', null,
        h('div', { style: { marginBottom: 24 } },
            h(Skeleton, { type: 'title' }),
            h(Skeleton, { width: '40%' })
        ),
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: 16, marginBottom: 24 } },
            [1,2,3,4].map(i => h(Skeleton, { key: i, type: 'kpi' }))
        ),
        h('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 20 } },
            h(Skeleton, { type: 'card', height: 300 }),
            h(Skeleton, { type: 'card', height: 300 })
        )
    );
});

// Toast Component
const Toast = memo(({ id, type = 'info', title, message, onClose }) => {
    useEffect(() => {
        const timer = setTimeout(() => onClose(id), 5000);
        return () => clearTimeout(timer);
    }, [id, onClose]);
    
    const icons = { success: 'âœ…', error: 'âŒ', warning: 'âš ï¸', info: 'â„¹ï¸' };
    
    return h('div', { className: `toast ${type}`, role: 'alert' },
        h('span', { className: 'toast-icon' }, icons[type]),
        h('div', { className: 'toast-content' },
            h('div', { className: 'toast-title' }, title),
            message && h('div', { className: 'toast-message' }, message)
        ),
        h('button', { className: 'toast-close', onClick: () => onClose(id), 'aria-label': 'Fermer' }, 'Ã—')
    );
});

// Modal Component
const Modal = memo(({ isOpen, onClose, title, children, footer, size = 'md' }) => {
    useEffect(() => {
        if (isOpen) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
        return () => { document.body.style.overflow = ''; };
    }, [isOpen]);
    
    useKeyboardShortcut('Escape', onClose, { global: true });
    
    if (!isOpen) return null;
    
    const sizes = { sm: 400, md: 560, lg: 720, xl: 900 };
    
    return h('div', { 
        className: 'modal-overlay',
        onClick: (e) => e.target === e.currentTarget && onClose()
    },
        h('div', { 
            className: 'modal',
            style: { maxWidth: sizes[size] },
            role: 'dialog',
            'aria-modal': 'true',
            'aria-labelledby': 'modal-title'
        },
            h('div', { className: 'modal-header' },
                h('h2', { className: 'modal-title', id: 'modal-title' }, title),
                h('button', { className: 'modal-close', onClick: onClose, 'aria-label': 'Fermer' }, 'Ã—')
            ),
            h('div', { className: 'modal-body' }, children),
            footer && h('div', { className: 'modal-footer' }, footer)
        )
    );
});

// Virtual List Component
const VirtualList = memo(({ items, itemHeight, containerHeight, renderItem }) => {
    const containerRef = useRef(null);
    const { visibleItems, totalHeight, onScroll } = useVirtualList(items, itemHeight, containerHeight);
    
    return h('div', {
        ref: containerRef,
        style: { height: containerHeight, overflow: 'auto', position: 'relative' },
        onScroll
    },
        h('div', { style: { height: totalHeight, position: 'relative' } },
            visibleItems.map(item => h('div', { key: item.id || item.index, style: item.style },
                renderItem(item, item.index)
            ))
        )
    );
});

// Swipeable Row Component
const SwipeableRow = memo(({ children, onSwipeLeft, onSwipeRight, leftAction, rightAction }) => {
    const ref = useRef(null);
    const [offset, setOffset] = useState(0);
    const startX = useRef(0);
    const [isSwiping, setIsSwiping] = useState(false);
    
    const handleTouchStart = (e) => {
        startX.current = e.touches[0].clientX;
        setIsSwiping(true);
    };
    
    const handleTouchMove = (e) => {
        if (!isSwiping) return;
        const deltaX = e.touches[0].clientX - startX.current;
        setOffset(Math.max(-80, Math.min(80, deltaX)));
    };
    
    const handleTouchEnd = () => {
        setIsSwiping(false);
        if (offset > 50 && onSwipeRight) {
            onSwipeRight();
            haptic('medium');
        } else if (offset < -50 && onSwipeLeft) {
            onSwipeLeft();
            haptic('medium');
        }
        setOffset(0);
    };
    
    return h('div', { 
        className: 'swipe-container',
        ref,
        onTouchStart: handleTouchStart,
        onTouchMove: handleTouchMove,
        onTouchEnd: handleTouchEnd
    },
        leftAction && h('div', { className: 'swipe-action-left' }, leftAction),
        rightAction && h('div', { className: 'swipe-action-right' }, rightAction),
        h('div', { 
            className: 'swipe-content',
            style: { transform: `translateX(${offset}px)` }
        }, children)
    );
});

// AI Suggestion Component
const AISuggestion = memo(({ suggestion, onAction, onDismiss }) => {
    const bgColors = {
        warning: 'linear-gradient(135deg, #FEF3C7, #FEE2E2)',
        alert: 'linear-gradient(135deg, #FEE2E2, #FECACA)',
        info: 'linear-gradient(135deg, #E0E7FF, #C7D2FE)'
    };
    
    return h('div', { 
        className: 'ai-suggestion',
        style: { background: bgColors[suggestion.type] || bgColors.info }
    },
        h('div', { className: 'ai-icon' }, suggestion.icon || 'ðŸ¤–'),
        h('div', { className: 'ai-content' },
            h('p', null,
                h('strong', null, suggestion.title),
                ' â€” ',
                suggestion.message
            ),
            h('div', { className: 'ai-actions' },
                suggestion.actions?.map((action, i) => h('button', {
                    key: i,
                    className: `btn ${i === 0 ? 'btn-primary btn-sm' : 'btn-secondary btn-sm'}`,
                    onClick: () => onAction(action)
                }, action.label)),
                h('button', {
                    className: 'btn btn-ghost btn-sm',
                    onClick: () => onDismiss(suggestion.id)
                }, 'Ignorer')
            )
        )
    );
});

// Dropdown Component
const Dropdown = memo(({ trigger, children, align = 'right' }) => {
    const [isOpen, setIsOpen] = useState(false);
    const ref = useRef(null);
    
    useEffect(() => {
        const handleClickOutside = (e) => {
            if (ref.current && !ref.current.contains(e.target)) {
                setIsOpen(false);
            }
        };
        
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);
    
    return h('div', { className: 'dropdown', ref },
        h('div', { onClick: () => setIsOpen(!isOpen) }, trigger),
        h('div', { 
            className: `dropdown-menu ${isOpen ? 'open' : ''}`,
            style: align === 'left' ? { left: 0, right: 'auto' } : {}
        }, children)
    );
});

// Badge Component
const Badge = memo(({ children, variant = 'primary', size = 'md' }) => {
    const sizeStyles = {
        sm: { fontSize: 10, padding: '2px 6px' },
        md: { fontSize: 12, padding: '4px 10px' },
        lg: { fontSize: 14, padding: '6px 14px' }
    };
    
    return h('span', { 
        className: `badge badge-${variant}`,
        style: sizeStyles[size]
    }, children);
});

// Empty State Component
const EmptyState = memo(({ icon = 'ðŸ“­', title, message, action }) => {
    return h('div', { style: { padding: 60, textAlign: 'center' } },
        h('div', { style: { fontSize: 48, marginBottom: 16 } }, icon),
        h('h3', { style: { fontSize: 18, fontWeight: 600, marginBottom: 8 } }, title),
        message && h('p', { style: { color: 'var(--muted)', marginBottom: 16 } }, message),
        action && h('button', { className: 'btn btn-primary', onClick: action.onClick }, action.label)
    );
});

// Search Input with Debounce
const SearchInput = memo(({ value, onChange, placeholder = 'Rechercher...', debounceMs = 300 }) => {
    const [localValue, setLocalValue] = useState(value);
    const debouncedValue = useDebounce(localValue, debounceMs);
    
    useEffect(() => {
        if (debouncedValue !== value) {
            onChange(debouncedValue);
        }
    }, [debouncedValue]);
    
    useEffect(() => {
        setLocalValue(value);
    }, [value]);
    
    return h('div', { style: { position: 'relative' } },
        h('span', { 
            style: { position: 'absolute', left: 14, top: '50%', transform: 'translateY(-50%)', fontSize: 16 }
        }, 'ðŸ”'),
        h('input', {
            type: 'search',
            className: 'form-input',
            style: { paddingLeft: 42 },
            placeholder,
            value: localValue,
            onChange: (e) => setLocalValue(e.target.value)
        })
    );
});

console.log('âœ… StockApp v8.0 Components loaded');

// ============================================
// NAVIGATION COMPONENTS
// ============================================

// Sidebar Component
const Sidebar = memo(({ collapsed, currentPage, onNavigate, onToggleCollapse, badges = {} }) => {
    const menuItems = [
        { id: 'dashboard', icon: 'ðŸ“Š', label: 'Dashboard' },
        { id: 'stock', icon: 'ðŸ“¦', label: 'Stock', badge: badges.stockCritique },
        { id: 'tasks', icon: 'ðŸ”§', label: 'Travaux', badge: badges.tasksUrgent },
        { id: 'orders', icon: 'ðŸ›’', label: 'Commandes' },
        { id: 'requests', icon: 'ðŸ“©', label: 'Demandes', badge: badges.requestsNew },
        { id: 'planning', icon: 'ðŸ“…', label: 'Planning' },
        { id: 'interventions', icon: 'ðŸ”§', label: 'Interventions' },
        { id: 'map', icon: 'ðŸ—ºï¸', label: 'Carte' },
        { id: 'parc', icon: 'ðŸ›—', label: 'Parc ascenseurs' },
        { id: 'ai', icon: 'ðŸ¤–', label: 'IA PrÃ©dictive' }
    ];
    
    const systemItems = [
        { id: 'settings', icon: 'âš™ï¸', label: 'ParamÃ¨tres' }
    ];
    
    return h('aside', { 
        className: `sidebar ${collapsed ? 'collapsed' : ''}`,
        role: 'navigation',
        'aria-label': 'Navigation principale'
    },
        h('div', { className: 'sidebar-header' },
            h('div', { className: 'sidebar-logo' }, 'S'),
            !collapsed && h('span', { className: 'sidebar-title' }, 'StockApp')
        ),
        h('nav', { className: 'sidebar-nav' },
            h('div', { className: 'nav-section-title' }, 'Menu'),
            menuItems.map(item => h('a', {
                key: item.id,
                className: `nav-item ${currentPage === item.id ? 'active' : ''}`,
                onClick: () => onNavigate(item.id),
                'data-tooltip': item.label,
                role: 'menuitem',
                tabIndex: 0,
                onKeyDown: (e) => e.key === 'Enter' && onNavigate(item.id)
            },
                h('span', { className: 'nav-item-icon' }, item.icon),
                h('span', { className: 'nav-item-text' }, item.label),
                item.badge > 0 && h('span', { className: 'nav-item-badge' }, item.badge > 99 ? '99+' : item.badge)
            )),
            h('div', { className: 'nav-section-title' }, 'SystÃ¨me'),
            systemItems.map(item => h('a', {
                key: item.id,
                className: `nav-item ${currentPage === item.id ? 'active' : ''}`,
                onClick: () => onNavigate(item.id),
                'data-tooltip': item.label,
                role: 'menuitem',
                tabIndex: 0
            },
                h('span', { className: 'nav-item-icon' }, item.icon),
                h('span', { className: 'nav-item-text' }, item.label)
            ))
        )
    );
});

// Header Component
const Header = memo(({ 
    user, 
    realtimeStatus, 
    onSearch, 
    onNotifications, 
    onTools, 
    onThemeToggle, 
    onUserMenu,
    notificationCount = 0,
    theme = 'light'
}) => {
    const [showToolsDropdown, setShowToolsDropdown] = useState(false);
    
    const tools = [
        { id: 'presentation', icon: 'ðŸ“º', label: 'PrÃ©sentation' },
        { id: 'split', icon: 'â—«', label: 'Split View' },
        { id: 'reports', icon: 'ðŸ“Š', label: 'Rapports' },
        { id: 'export', icon: 'ðŸ“„', label: 'Export PDF' },
        { id: 'widgets', icon: 'âš™ï¸', label: 'Widgets' },
        { id: 'audit', icon: 'ðŸ“‹', label: 'Historique', admin: true }
    ];
    
    return h('header', { className: 'header', role: 'banner' },
        h('div', { className: 'header-left' },
            h('button', { 
                className: 'btn btn-ghost btn-icon',
                onClick: () => {},
                'aria-label': 'Menu'
            }, 'â˜°')
        ),
        h('div', { className: 'header-right' },
            // Realtime Status
            h('div', { 
                className: `realtime-indicator ${realtimeStatus}`,
                'aria-live': 'polite'
            },
                h('span', { className: 'dot' }),
                realtimeStatus === 'connected' ? 'Live' : realtimeStatus === 'disconnected' ? 'Offline' : '...'
            ),
            
            // Search
            h('button', {
                className: 'header-btn',
                onClick: onSearch,
                title: 'Recherche (âŒ˜K)',
                'aria-label': 'Ouvrir la recherche'
            }, 'ðŸ”'),
            
            // Notifications
            h('button', {
                className: 'header-btn',
                onClick: onNotifications,
                title: 'Notifications',
                'aria-label': `${notificationCount} notifications`
            },
                'ðŸ””',
                notificationCount > 0 && h('span', { className: 'badge' }, notificationCount > 9 ? '9+' : notificationCount)
            ),
            
            // Tools Dropdown
            h(Dropdown, {
                trigger: h('button', {
                    className: 'header-btn',
                    title: 'Outils',
                    'aria-label': 'Menu outils'
                }, 'ðŸ› ï¸'),
                align: 'right'
            },
                h('div', { style: { padding: '12px 16px', borderBottom: '1px solid var(--border)', fontWeight: 600 } }, 'ðŸ› ï¸ Outils'),
                h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 4, padding: 8 } },
                    tools.filter(t => !t.admin || user?.role === 'admin').map(tool => h('div', {
                        key: tool.id,
                        className: 'dropdown-item',
                        style: { flexDirection: 'column', alignItems: 'center', padding: 12, textAlign: 'center', borderRadius: 8 },
                        onClick: () => onTools(tool.id)
                    },
                        h('span', { style: { fontSize: 20, marginBottom: 4 } }, tool.icon),
                        h('span', { style: { fontSize: 11 } }, tool.label)
                    ))
                ),
                h('div', { className: 'dropdown-divider' }),
                h('div', { 
                    className: 'dropdown-item',
                    style: { justifyContent: 'center', color: 'var(--primary)', fontSize: 13 },
                    onClick: () => onTools('settings')
                }, 'Tous les paramÃ¨tres â†’')
            ),
            
            // Theme Toggle
            h('button', {
                className: 'header-btn',
                onClick: onThemeToggle,
                title: 'Changer de thÃ¨me',
                'aria-label': `ThÃ¨me actuel: ${theme}`
            }, theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™'),
            
            // User Menu
            h('div', { 
                className: 'user-menu',
                onClick: onUserMenu,
                role: 'button',
                tabIndex: 0
            },
                h('div', { className: 'user-avatar' }, (user?.first_name?.[0] || user?.email?.[0] || 'U').toUpperCase()),
                h('div', { className: 'user-info' },
                    h('div', { className: 'user-name' }, user?.first_name || user?.email?.split('@')[0] || 'Utilisateur'),
                    h('div', { className: 'user-role' }, user?.role || 'Utilisateur')
                )
            )
        )
    );
});

// Command Palette (Search)
const CommandPalette = memo(({ isOpen, onClose, onNavigate, data }) => {
    const [query, setQuery] = useState('');
    const [results, setResults] = useState([]);
    const inputRef = useRef(null);
    const debouncedQuery = useDebounce(query, 200);
    
    useEffect(() => {
        if (isOpen && inputRef.current) {
            inputRef.current.focus();
        }
    }, [isOpen]);
    
    useEffect(() => {
        if (!debouncedQuery) {
            setResults([]);
            return;
        }
        
        const q = debouncedQuery.toLowerCase();
        const searchResults = [];
        
        // Search pages
        const pages = [
            { type: 'page', id: 'dashboard', name: 'Dashboard', icon: 'ðŸ“Š' },
            { type: 'page', id: 'stock', name: 'Stock', icon: 'ðŸ“¦' },
            { type: 'page', id: 'tasks', name: 'Travaux', icon: 'ðŸ”§' },
            { type: 'page', id: 'planning', name: 'Planning', icon: 'ðŸ“…' },
            { type: 'page', id: 'parc', name: 'Parc ascenseurs', icon: 'ðŸ›—' }
        ];
        
        pages.filter(p => p.name.toLowerCase().includes(q)).forEach(p => {
            searchResults.push({ ...p, category: 'Navigation' });
        });
        
        // Search tasks
        (data.tasks || []).filter(t => 
            t.type?.toLowerCase().includes(q) || 
            t.description?.toLowerCase().includes(q) ||
            t.location?.toLowerCase().includes(q)
        ).slice(0, 5).forEach(t => {
            searchResults.push({ type: 'task', id: t.id, name: t.type || 'Travail', subtitle: t.location, icon: 'ðŸ”§', category: 'Travaux' });
        });
        
        // Search parts
        (data.parts || []).filter(p => 
            p.name?.toLowerCase().includes(q) ||
            p.reference?.toLowerCase().includes(q)
        ).slice(0, 5).forEach(p => {
            searchResults.push({ type: 'part', id: p.id, name: p.name, subtitle: p.reference, icon: 'ðŸ“¦', category: 'Stock' });
        });
        
        // Search equipments
        (data.equipements || []).filter(e => 
            e.nom?.toLowerCase().includes(q) ||
            e.immeuble?.toLowerCase().includes(q) ||
            e.adresse?.toLowerCase().includes(q)
        ).slice(0, 5).forEach(e => {
            searchResults.push({ type: 'equipment', id: e.id, name: e.nom || e.immeuble, subtitle: e.adresse, icon: 'ðŸ›—', category: 'Ã‰quipements' });
        });
        
        setResults(searchResults);
    }, [debouncedQuery, data]);
    
    const handleSelect = (result) => {
        if (result.type === 'page') {
            onNavigate(result.id);
        } else {
            // Navigate to detail page
            onNavigate(result.type === 'task' ? 'tasks' : result.type === 'part' ? 'stock' : 'parc');
        }
        setQuery('');
        onClose();
    };
    
    if (!isOpen) return null;
    
    return h('div', { 
        className: 'modal-overlay',
        onClick: (e) => e.target === e.currentTarget && onClose(),
        style: { alignItems: 'flex-start', paddingTop: '15vh' }
    },
        h('div', { 
            style: { 
                background: 'var(--card)', 
                borderRadius: 'var(--radius-lg)', 
                width: '100%', 
                maxWidth: 600,
                overflow: 'hidden',
                boxShadow: 'var(--shadow-xl)'
            }
        },
            h('div', { style: { padding: 16, borderBottom: '1px solid var(--border)' } },
                h('input', {
                    ref: inputRef,
                    type: 'search',
                    className: 'form-input',
                    style: { border: 'none', fontSize: 18, padding: 0, background: 'transparent' },
                    placeholder: 'Rechercher une page, un travail, un article...',
                    value: query,
                    onChange: (e) => setQuery(e.target.value),
                    onKeyDown: (e) => {
                        if (e.key === 'Escape') onClose();
                        if (e.key === 'Enter' && results.length > 0) handleSelect(results[0]);
                    }
                })
            ),
            results.length > 0 && h('div', { style: { maxHeight: 400, overflow: 'auto' } },
                Object.entries(results.reduce((acc, r) => {
                    if (!acc[r.category]) acc[r.category] = [];
                    acc[r.category].push(r);
                    return acc;
                }, {})).map(([category, items]) => h('div', { key: category },
                    h('div', { style: { padding: '8px 16px', fontSize: 11, fontWeight: 600, color: 'var(--muted)', textTransform: 'uppercase' } }, category),
                    items.map((item, i) => h('div', {
                        key: item.id,
                        style: { 
                            padding: '12px 16px', 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: 12, 
                            cursor: 'pointer',
                            background: i === 0 ? 'var(--primary-light)' : 'transparent'
                        },
                        onClick: () => handleSelect(item)
                    },
                        h('span', { style: { fontSize: 20 } }, item.icon),
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { fontWeight: 500 } }, item.name),
                            item.subtitle && h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, item.subtitle)
                        ),
                        h('span', { style: { fontSize: 12, color: 'var(--muted)' } }, 'â†µ')
                    ))
                ))
            ),
            results.length === 0 && query && h('div', { style: { padding: 40, textAlign: 'center', color: 'var(--muted)' } },
                h('div', { style: { fontSize: 32, marginBottom: 8 } }, 'ðŸ”'),
                'Aucun rÃ©sultat pour "', query, '"'
            ),
            h('div', { style: { padding: '8px 16px', borderTop: '1px solid var(--border)', display: 'flex', gap: 16, fontSize: 12, color: 'var(--muted)' } },
                h('span', null, 'â†µ SÃ©lectionner'),
                h('span', null, 'â†‘â†“ Naviguer'),
                h('span', null, 'Esc Fermer')
            )
        )
    );
});

// Keyboard Shortcuts Help Modal
const ShortcutsHelp = memo(({ isOpen, onClose }) => {
    const shortcuts = KeyboardService.getShortcuts();
    
    const formatKey = (shortcut) => {
        const keys = [];
        if (shortcut.meta) keys.push('âŒ˜');
        if (shortcut.shift) keys.push('â‡§');
        if (shortcut.alt) keys.push('âŒ¥');
        if (shortcut.sequence) keys.push(shortcut.sequence.toUpperCase(), '+');
        keys.push(shortcut.key.toUpperCase());
        return keys;
    };
    
    return h(Modal, { isOpen, onClose, title: 'âŒ¨ï¸ Raccourcis clavier', size: 'md' },
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: 12 } },
            shortcuts.map(shortcut => h('div', {
                key: shortcut.action,
                style: { 
                    display: 'flex', 
                    justifyContent: 'space-between', 
                    alignItems: 'center',
                    padding: '10px 14px',
                    background: 'var(--background)',
                    borderRadius: 8
                }
            },
                h('span', { style: { fontSize: 14 } }, shortcut.label),
                h('div', { style: { display: 'flex', gap: 4 } },
                    formatKey(shortcut).map((key, i) => h('span', {
                        key: i,
                        style: {
                            background: 'var(--card)',
                            border: '1px solid var(--border)',
                            borderBottomWidth: 3,
                            padding: '4px 8px',
                            borderRadius: 6,
                            fontSize: 12,
                            fontWeight: 600,
                            fontFamily: 'monospace'
                        }
                    }, key))
                )
            ))
        )
    );
});

console.log('âœ… StockApp v8.0 Navigation Components loaded');

// ============================================
// DASHBOARD COMPONENTS
// ============================================

// KPI Card Widget
const KPIWidget = memo(({ value, label, icon, color, footer, onClick, loading }) => {
    if (loading) {
        return h('div', { className: 'kpi-card normal' },
            h(Skeleton, { type: 'kpi' })
        );
    }
    
    const isGradient = ['primary', 'success', 'warning', 'danger', 'purple', 'teal', 'info'].includes(color);
    
    return h('div', { 
        className: `kpi-card ${isGradient ? `gradient ${color}` : 'normal'}`,
        onClick,
        role: 'button',
        tabIndex: 0,
        onKeyDown: (e) => e.key === 'Enter' && onClick?.()
    },
        h('div', { className: 'kpi-header' },
            h('div', null,
                h('div', { className: 'kpi-value' }, value),
                h('div', { className: 'kpi-label' }, label)
            ),
            h('span', { className: 'kpi-icon' }, icon)
        ),
        footer && h('div', { className: 'kpi-footer' }, footer)
    );
});

// List Widget (Tasks, Requests, etc.)
const ListWidget = memo(({ title, icon, items, onViewAll, onItemClick, emptyIcon, emptyMessage, renderItem, loading }) => {
    if (loading) {
        return h('div', { className: 'card' },
            h('div', { className: 'card-header' },
                h(Skeleton, { width: 150 })
            ),
            h('div', { className: 'card-body', style: { padding: 0 } },
                [1,2,3].map(i => h('div', { key: i, style: { padding: '14px 20px', borderBottom: '1px solid var(--border)' } },
                    h('div', { style: { display: 'flex', gap: 12 } },
                        h(Skeleton, { type: 'avatar', width: 40, height: 40 }),
                        h('div', { style: { flex: 1 } },
                            h(Skeleton, { width: '60%' }),
                            h(Skeleton, { width: '40%' })
                        )
                    )
                ))
            )
        );
    }
    
    return h('div', { className: 'card' },
        h('div', { className: 'card-header' },
            h('h3', { className: 'card-title' }, icon, ' ', title),
            onViewAll && h('button', { className: 'btn btn-ghost btn-sm', onClick: onViewAll }, 'Voir tout â†’')
        ),
        h('div', { className: 'card-body', style: { padding: 0 } },
            items.length === 0 
                ? h(EmptyState, { icon: emptyIcon || 'ðŸ“­', title: emptyMessage || 'Aucun Ã©lÃ©ment' })
                : items.map((item, i) => h(SwipeableRow, {
                    key: item.id,
                    onSwipeLeft: item.onDelete,
                    onSwipeRight: item.onEdit,
                    leftAction: 'ðŸ—‘ï¸',
                    rightAction: 'âœï¸'
                },
                    h('div', { 
                        style: { 
                            padding: '14px 20px', 
                            borderBottom: i < items.length - 1 ? '1px solid var(--border)' : 'none',
                            cursor: 'pointer'
                        },
                        onClick: () => onItemClick?.(item)
                    }, renderItem(item, i))
                ))
        )
    );
});

// Chart Widget
const ChartWidget = memo(({ title, type = 'bar', data, loading }) => {
    const canvasRef = useRef(null);
    const chartRef = useRef(null);
    
    useEffect(() => {
        if (!canvasRef.current || !data || loading) return;
        
        if (chartRef.current) {
            chartRef.current.destroy();
        }
        
        chartRef.current = new Chart(canvasRef.current, {
            type,
            data,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
        
        return () => {
            if (chartRef.current) {
                chartRef.current.destroy();
            }
        };
    }, [data, type, loading]);
    
    if (loading) {
        return h('div', { className: 'card' },
            h('div', { className: 'card-header' }, h(Skeleton, { width: 150 })),
            h('div', { className: 'card-body' }, h(Skeleton, { height: 200 }))
        );
    }
    
    return h('div', { className: 'card' },
        h('div', { className: 'card-header' },
            h('h3', { className: 'card-title' }, title)
        ),
        h('div', { className: 'card-body', style: { height: 250 } },
            h('canvas', { ref: canvasRef })
        )
    );
});

// Dashboard Page
const DashboardPage = memo(({ data, user, onNavigate, showToast, loading }) => {
    const [activeTab, setActiveTab] = useState('overview');
    const [selectedSector, setSelectedSector] = useState('all');
    const [aiSuggestions, setAiSuggestions] = useState([]);
    
    // Calculate KPIs
    const kpis = useMemo(() => {
        if (loading) return {};
        
        const tasks = data.tasks || [];
        const parts = data.parts || [];
        const orders = data.orders || [];
        const requests = data.requests || [];
        const equipements = data.equipements || [];
        
        const today = new Date();
        const tasksEnCours = tasks.filter(t => t.status !== 'termine' && !t.is_event);
        const tasksUrgentes = tasksEnCours.filter(t => ['haute', 'urgente', 'critique'].includes(t.priority));
        const tasksRetard = tasksEnCours.filter(t => t.due_date && new Date(t.due_date) < today);
        const stockCritique = parts.filter(p => p.quantity <= (p.min_stock || 0));
        const commandesEnCours = orders.filter(o => o.status === 'en-commande');
        const demandesOuvertes = requests.filter(r => ['nouveau', 'en_cours', 'en_attente'].includes(r.status));
        const demandesUrgentes = demandesOuvertes.filter(r => ['critique', 'urgente', 'haute'].includes(r.priority));
        
        // Weekly stats
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay());
        const terminesSemaine = tasks.filter(t => t.status === 'termine' && new Date(t.updated_at || t.created_at) >= startOfWeek).length;
        
        // Sector KPIs
        const filteredEquipements = selectedSector === 'all' ? equipements : equipements.filter(e => e.secteur === selectedSector);
        const arrets = filteredEquipements.filter(e => e.statut === 'arret' || e.en_panne);
        const riskEquipments = filteredEquipements.filter(e => (e.score_ml || 0) > 70);
        
        return {
            tasksEnCours: tasksEnCours.length,
            tasksUrgentes: tasksUrgentes.length,
            tasksRetard: tasksRetard.length,
            terminesSemaine,
            stockCritique: stockCritique.length,
            stockCritiqueList: stockCritique.slice(0, 5),
            commandesEnCours: commandesEnCours.length,
            demandesOuvertes: demandesOuvertes.length,
            demandesUrgentes: demandesUrgentes.length,
            totalEquipements: filteredEquipements.length,
            arrets: arrets.length,
            arretsList: arrets.slice(0, 5),
            riskEquipments: riskEquipments.length,
            riskEquipmentsList: riskEquipments.sort((a, b) => (b.score_ml || 0) - (a.score_ml || 0)).slice(0, 5)
        };
    }, [data, loading, selectedSector]);
    
    // Get upcoming tasks
    const prochainsTravaux = useMemo(() => {
        if (loading) return [];
        return (data.tasks || [])
            .filter(t => t.status !== 'termine' && !t.is_event && t.scheduled_date)
            .sort((a, b) => new Date(a.scheduled_date) - new Date(b.scheduled_date))
            .slice(0, 5);
    }, [data.tasks, loading]);
    
    // Get recent requests
    const dernieresdemandes = useMemo(() => {
        if (loading) return [];
        return (data.requests || [])
            .filter(r => ['nouveau', 'en_cours', 'en_attente'].includes(r.status))
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .slice(0, 5);
    }, [data.requests, loading]);
    
    // Get available sectors
    const sectors = useMemo(() => {
        const sectorSet = new Set();
        (data.equipements || []).forEach(e => e.secteur && sectorSet.add(e.secteur));
        return Array.from(sectorSet).sort();
    }, [data.equipements]);
    
    // AI Analysis
    useEffect(() => {
        if (!loading && data) {
            const suggestions = AIAssistant.analyze(data);
            setAiSuggestions(suggestions);
        }
    }, [data, loading]);
    
    const handleAIAction = (action) => {
        if (action.action === 'navigate') {
            onNavigate(action.data);
        } else if (action.action === 'schedule_maintenance') {
            onNavigate('tasks');
            // Could also open a modal to create task
        } else if (action.action === 'create_order') {
            onNavigate('orders');
        }
    };
    
    const handleDismissSuggestion = (id) => {
        setAiSuggestions(prev => prev.filter(s => s.id !== id));
        AIAssistant.dismissSuggestion(id);
    };
    
    // Date info
    const today = new Date();
    const weekNumber = Math.ceil((today - new Date(today.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));
    
    if (loading) {
        return h(DashboardSkeleton);
    }
    
    return h('div', { id: 'main-content', role: 'main' },
        // Header
        h('div', { style: { marginBottom: 24 } },
            h('h1', { style: { fontSize: 28, fontWeight: 700, marginBottom: 4 } },
                `Bonjour ${user?.first_name || 'Utilisateur'} ðŸ‘‹`
            ),
            h('p', { style: { color: 'var(--muted)' } },
                `${today.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' })} â€¢ Semaine ${weekNumber}`
            )
        ),
        
        // AI Suggestions
        aiSuggestions.length > 0 && h('div', { style: { marginBottom: 24 } },
            aiSuggestions.map(suggestion => h(AISuggestion, {
                key: suggestion.id,
                suggestion,
                onAction: handleAIAction,
                onDismiss: handleDismissSuggestion
            }))
        ),
        
        // Tabs
        h('div', { className: 'tabs', style: { marginBottom: 24 } },
            h('button', { 
                className: `tab ${activeTab === 'overview' ? 'active' : ''}`,
                onClick: () => setActiveTab('overview')
            }, 'ðŸ“‹ Vue d\'ensemble'),
            h('button', { 
                className: `tab ${activeTab === 'sector' ? 'active' : ''}`,
                onClick: () => setActiveTab('sector')
            }, 'ðŸ¢ Mon Secteur')
        ),
        
        // Overview Tab
        activeTab === 'overview' && h('div', null,
            // KPIs
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: 16, marginBottom: 24 } },
                h(KPIWidget, {
                    value: kpis.tasksEnCours,
                    label: 'Travaux en cours',
                    icon: 'ðŸ”§',
                    color: kpis.tasksUrgentes > 0 ? 'primary' : null,
                    footer: (kpis.tasksUrgentes > 0 || kpis.tasksRetard > 0) && 
                        `${kpis.tasksUrgentes > 0 ? `âš¡ ${kpis.tasksUrgentes} urgent${kpis.tasksUrgentes > 1 ? 's' : ''}` : ''}${kpis.tasksUrgentes > 0 && kpis.tasksRetard > 0 ? ' â€¢ ' : ''}${kpis.tasksRetard > 0 ? `â° ${kpis.tasksRetard} en retard` : ''}`,
                    onClick: () => onNavigate('tasks')
                }),
                h(KPIWidget, {
                    value: kpis.stockCritique,
                    label: 'Stock critique',
                    icon: 'ðŸ“¦',
                    color: kpis.stockCritique > 0 ? 'warning' : null,
                    footer: kpis.stockCritique > 0 && kpis.stockCritiqueList.map(p => p.name).join(', ').substring(0, 40) + (kpis.stockCritique > 5 ? '...' : ''),
                    onClick: () => onNavigate('stock')
                }),
                h(KPIWidget, {
                    value: kpis.demandesOuvertes,
                    label: 'Demandes ouvertes',
                    icon: 'ðŸ“©',
                    color: kpis.demandesUrgentes > 0 ? 'info' : null,
                    footer: kpis.demandesUrgentes > 0 && `ðŸ”´ ${kpis.demandesUrgentes} urgente${kpis.demandesUrgentes > 1 ? 's' : ''}`,
                    onClick: () => onNavigate('requests')
                }),
                h(KPIWidget, {
                    value: kpis.commandesEnCours,
                    label: 'Commandes en cours',
                    icon: 'ðŸ›’',
                    footer: `âœ… ${kpis.terminesSemaine} terminÃ©${kpis.terminesSemaine > 1 ? 's' : ''} cette semaine`,
                    onClick: () => onNavigate('orders')
                })
            ),
            
            // Lists
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: 20, marginBottom: 24 } },
                h(ListWidget, {
                    title: 'Prochains travaux',
                    icon: 'ðŸ“…',
                    items: prochainsTravaux,
                    onViewAll: () => onNavigate('tasks'),
                    emptyIcon: 'âœ¨',
                    emptyMessage: 'Aucun travail planifiÃ©',
                    renderItem: (task) => h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                        h('div', null,
                            h('div', { style: { fontWeight: 500 } }, task.type || 'Travail'),
                            h('div', { style: { fontSize: 13, color: 'var(--muted)' } }, task.location || task.description?.substring(0, 40) || '-')
                        ),
                        h('div', { style: { textAlign: 'right' } },
                            h('div', { style: { fontSize: 13, fontWeight: 500, color: new Date(task.scheduled_date) < new Date() ? 'var(--danger)' : 'var(--text)' } }, formatDate(task.scheduled_date)),
                            task.priority && ['haute', 'urgente', 'critique'].includes(task.priority) && h(Badge, { variant: 'danger', size: 'sm' }, task.priority)
                        )
                    )
                }),
                h(ListWidget, {
                    title: 'DerniÃ¨res demandes',
                    icon: 'ðŸ“©',
                    items: dernieresdemandes,
                    onViewAll: () => onNavigate('requests'),
                    emptyIcon: 'ðŸ“­',
                    emptyMessage: 'Aucune demande en attente',
                    renderItem: (req) => h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                        h('div', null,
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 8 } },
                                h('span', { style: { fontWeight: 500 } }, req.type || 'Demande'),
                                ['critique', 'urgente', 'haute'].includes(req.priority) && h(Badge, { variant: 'danger', size: 'sm' }, '!')
                            ),
                            h('div', { style: { fontSize: 13, color: 'var(--muted)' } }, req.title || req.description?.substring(0, 40) || '-')
                        ),
                        h('div', { style: { textAlign: 'right' } },
                            h(Badge, { variant: req.status === 'nouveau' ? 'info' : req.status === 'en_cours' ? 'warning' : 'secondary', size: 'sm' },
                                req.status === 'nouveau' ? 'Nouveau' : req.status === 'en_cours' ? 'En cours' : req.status
                            ),
                            h('div', { style: { fontSize: 11, color: 'var(--muted)', marginTop: 4 } }, formatRelative(req.created_at))
                        )
                    )
                })
            ),
            
            // Quick Actions
            h('div', { style: { display: 'flex', gap: 12, flexWrap: 'wrap' } },
                h('button', { className: 'btn btn-primary', onClick: () => onNavigate('tasks') }, 'âž• Nouveau travail'),
                h('button', { className: 'btn btn-secondary', onClick: () => onNavigate('interventions') }, 'ðŸ”§ Intervention terrain'),
                h('button', { className: 'btn btn-secondary', onClick: () => onNavigate('planning') }, 'ðŸ“… Planning'),
                h('button', { className: 'btn btn-secondary', onClick: () => onNavigate('parc') }, 'ðŸ›— Parc ascenseurs')
            )
        ),
        
        // Sector Tab
        activeTab === 'sector' && h('div', null,
            // Sector Selector
            sectors.length > 0 && h('div', { style: { display: 'flex', gap: 8, marginBottom: 20, flexWrap: 'wrap' } },
                h('button', {
                    className: `btn btn-sm ${selectedSector === 'all' ? 'btn-primary' : 'btn-secondary'}`,
                    onClick: () => setSelectedSector('all')
                }, 'Tous les secteurs'),
                ...sectors.map(sector => h('button', {
                    key: sector,
                    className: `btn btn-sm ${selectedSector === sector ? 'btn-primary' : 'btn-secondary'}`,
                    onClick: () => setSelectedSector(sector)
                }, sector))
            ),
            
            // Sector KPIs
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(180px, 1fr))', gap: 16, marginBottom: 24 } },
                h(KPIWidget, {
                    value: kpis.totalEquipements,
                    label: 'Ã‰quipements',
                    icon: 'ðŸ›—',
                    color: 'primary'
                }),
                h(KPIWidget, {
                    value: kpis.arrets,
                    label: 'Ã€ l\'arrÃªt',
                    icon: 'â¸ï¸',
                    color: kpis.arrets > 0 ? 'danger' : null,
                    footer: kpis.arrets > 0 && 'ðŸš¨ Intervention requise'
                }),
                h(KPIWidget, {
                    value: kpis.riskEquipments,
                    label: 'Ã€ risque (IA)',
                    icon: 'âš ï¸',
                    color: kpis.riskEquipments > 0 ? 'warning' : null
                }),
                h(KPIWidget, {
                    value: `${kpis.totalEquipements > 0 ? Math.round((1 - kpis.arrets / kpis.totalEquipements) * 100) : 100}%`,
                    label: 'DisponibilitÃ©',
                    icon: 'âœ…',
                    color: 'success'
                })
            ),
            
            // Sector Lists
            h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: 20 } },
                h(ListWidget, {
                    title: 'Ã‰quipements Ã  l\'arrÃªt',
                    icon: 'ðŸš¨',
                    items: kpis.arretsList || [],
                    emptyIcon: 'âœ…',
                    emptyMessage: 'Aucun Ã©quipement Ã  l\'arrÃªt',
                    renderItem: (eq) => h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                        h('div', null,
                            h('div', { style: { fontWeight: 500 } }, eq.nom || eq.immeuble || 'Ã‰quipement'),
                            h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, eq.adresse || eq.secteur || '-')
                        ),
                        h(Badge, { variant: 'danger' }, 'ArrÃªt')
                    )
                }),
                h(ListWidget, {
                    title: 'Ã‰quipements Ã  risque (IA)',
                    icon: 'âš ï¸',
                    items: kpis.riskEquipmentsList || [],
                    emptyIcon: 'âœ…',
                    emptyMessage: 'Aucun Ã©quipement Ã  risque',
                    renderItem: (eq) => h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                        h('div', null,
                            h('div', { style: { fontWeight: 500 } }, eq.nom || eq.immeuble || 'Ã‰quipement'),
                            h('div', { style: { fontSize: 12, color: 'var(--muted)' } }, `Score ML: ${eq.score_ml || 0}%`)
                        ),
                        h('button', { className: 'btn btn-ghost btn-sm', onClick: () => onNavigate('parc') }, 'Planifier')
                    )
                })
            )
        )
    );
});

console.log('âœ… StockApp v8.0 Dashboard loaded');

// ============================================
// PLACEHOLDER PAGES (to be expanded)
// ============================================

const StockPage = memo(({ data, onNavigate, showToast }) => {
    const [search, setSearch] = useState('');
    const debouncedSearch = useDebounce(search, 300);
    
    const filteredParts = useMemo(() => {
        if (!debouncedSearch) return data.parts || [];
        const q = debouncedSearch.toLowerCase();
        return (data.parts || []).filter(p => 
            p.name?.toLowerCase().includes(q) ||
            p.reference?.toLowerCase().includes(q) ||
            p.category?.toLowerCase().includes(q)
        );
    }, [data.parts, debouncedSearch]);
    
    const criticalParts = filteredParts.filter(p => p.quantity <= (p.min_stock || 0));
    
    return h('div', null,
        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 } },
            h('h1', { style: { fontSize: 28, fontWeight: 700 } }, 'ðŸ“¦ Stock'),
            h('button', { className: 'btn btn-primary' }, 'âž• Nouvel article')
        ),
        
        h(SearchInput, {
            value: search,
            onChange: setSearch,
            placeholder: 'Rechercher un article...'
        }),
        
        criticalParts.length > 0 && h('div', { 
            style: { 
                background: 'var(--warning-light)', 
                padding: 16, 
                borderRadius: 'var(--radius)', 
                marginTop: 16,
                display: 'flex',
                alignItems: 'center',
                gap: 12
            }
        },
            h('span', { style: { fontSize: 24 } }, 'âš ï¸'),
            h('div', null,
                h('strong', null, `${criticalParts.length} article(s) en stock critique`),
                h('div', { style: { fontSize: 13, color: 'var(--text-secondary)' } }, 
                    criticalParts.slice(0, 3).map(p => p.name).join(', ') + (criticalParts.length > 3 ? '...' : '')
                )
            )
        ),
        
        h('div', { className: 'card', style: { marginTop: 24 } },
            h('div', { className: 'table-container' },
                h('table', { className: 'table' },
                    h('thead', null,
                        h('tr', null,
                            h('th', null, 'Article'),
                            h('th', null, 'RÃ©fÃ©rence'),
                            h('th', null, 'QuantitÃ©'),
                            h('th', null, 'Stock min'),
                            h('th', null, 'Statut'),
                            h('th', null, 'Actions')
                        )
                    ),
                    h('tbody', null,
                        filteredParts.slice(0, 50).map(part => h('tr', { key: part.id },
                            h('td', null, h('strong', null, part.name)),
                            h('td', null, part.reference || '-'),
                            h('td', null, part.quantity),
                            h('td', null, part.min_stock || '-'),
                            h('td', null, 
                                h(Badge, { 
                                    variant: part.quantity <= (part.min_stock || 0) ? 'danger' : part.quantity <= (part.min_stock || 0) * 1.5 ? 'warning' : 'success'
                                }, part.quantity <= (part.min_stock || 0) ? 'Critique' : part.quantity <= (part.min_stock || 0) * 1.5 ? 'Bas' : 'OK')
                            ),
                            h('td', null,
                                h('button', { className: 'btn btn-ghost btn-sm' }, 'âœï¸'),
                                h('button', { className: 'btn btn-ghost btn-sm' }, 'ðŸ“Š')
                            )
                        ))
                    )
                )
            )
        )
    );
});

const TasksPage = memo(({ data, onNavigate, showToast }) => {
    const [filter, setFilter] = useState('all');
    
    const filteredTasks = useMemo(() => {
        const tasks = (data.tasks || []).filter(t => !t.is_event);
        if (filter === 'all') return tasks;
        if (filter === 'urgent') return tasks.filter(t => ['haute', 'urgente', 'critique'].includes(t.priority));
        if (filter === 'overdue') return tasks.filter(t => t.due_date && new Date(t.due_date) < new Date() && t.status !== 'termine');
        if (filter === 'today') return tasks.filter(t => t.scheduled_date && formatDate(t.scheduled_date) === "Aujourd'hui");
        return tasks.filter(t => t.status === filter);
    }, [data.tasks, filter]);
    
    return h('div', null,
        h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 24 } },
            h('h1', { style: { fontSize: 28, fontWeight: 700 } }, 'ðŸ”§ Travaux'),
            h('button', { className: 'btn btn-primary' }, 'âž• Nouveau travail')
        ),
        
        h('div', { className: 'tabs', style: { marginBottom: 24 } },
            ['all', 'urgent', 'overdue', 'today', 'en_cours', 'termine'].map(f => h('button', {
                key: f,
                className: `tab ${filter === f ? 'active' : ''}`,
                onClick: () => setFilter(f)
            }, f === 'all' ? 'Tous' : f === 'urgent' ? 'âš¡ Urgents' : f === 'overdue' ? 'â° Retard' : f === 'today' ? "Aujourd'hui" : f === 'en_cours' ? 'En cours' : 'TerminÃ©s'))
        ),
        
        h('div', { className: 'card' },
            filteredTasks.length === 0 
                ? h(EmptyState, { icon: 'âœ¨', title: 'Aucun travail', message: 'Tous les travaux sont Ã  jour !' })
                : h('div', { className: 'card-body', style: { padding: 0 } },
                    filteredTasks.map((task, i) => h('div', {
                        key: task.id,
                        style: { 
                            padding: '16px 20px', 
                            borderBottom: i < filteredTasks.length - 1 ? '1px solid var(--border)' : 'none',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }
                    },
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                                h('input', { type: 'checkbox', checked: task.status === 'termine', onChange: () => {} }),
                                h('div', null,
                                    h('div', { style: { fontWeight: 500 } }, task.type || 'Travail'),
                                    h('div', { style: { fontSize: 13, color: 'var(--muted)' } }, task.location || task.description?.substring(0, 50) || '-')
                                )
                            )
                        ),
                        h('div', { style: { display: 'flex', alignItems: 'center', gap: 12 } },
                            task.assigned_to && h('div', { 
                                style: { 
                                    width: 32, height: 32, borderRadius: '50%', 
                                    background: 'var(--primary-light)', 
                                    display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    fontSize: 12, fontWeight: 600, color: 'var(--primary)'
                                }
                            }, task.assigned_to.substring(0, 2).toUpperCase()),
                            h('div', { style: { textAlign: 'right' } },
                                h('div', { style: { fontSize: 13, color: task.due_date && new Date(task.due_date) < new Date() && task.status !== 'termine' ? 'var(--danger)' : 'var(--text)' } }, 
                                    formatDate(task.scheduled_date || task.due_date)
                                ),
                                task.priority && h(Badge, { 
                                    variant: ['haute', 'urgente', 'critique'].includes(task.priority) ? 'danger' : 'secondary',
                                    size: 'sm'
                                }, task.priority)
                            )
                        )
                    ))
                )
        )
    );
});

const SettingsPage = memo(({ user, theme, onThemeChange, showToast }) => {
    const [activeTab, setActiveTab] = useState('profile');
    
    const tabs = [
        { id: 'profile', label: 'ðŸ‘¤ Profil', icon: 'ðŸ‘¤' },
        { id: 'notifications', label: 'ðŸ”” Notifications', icon: 'ðŸ””' },
        { id: 'appearance', label: 'ðŸŽ¨ Apparence', icon: 'ðŸŽ¨' },
        { id: 'shortcuts', label: 'âŒ¨ï¸ Raccourcis', icon: 'âŒ¨ï¸' },
        { id: 'accessibility', label: 'â™¿ AccessibilitÃ©', icon: 'â™¿' },
        { id: 'security', label: 'ðŸ”’ SÃ©curitÃ©', icon: 'ðŸ”’' },
        { id: 'data', label: 'ðŸ“¥ DonnÃ©es', icon: 'ðŸ“¥' },
        { id: 'about', label: 'â„¹ï¸ Ã€ propos', icon: 'â„¹ï¸' }
    ];
    
    return h('div', null,
        h('h1', { style: { fontSize: 28, fontWeight: 700, marginBottom: 24 } }, 'âš™ï¸ ParamÃ¨tres'),
        
        h('div', { style: { display: 'grid', gridTemplateColumns: '220px 1fr', gap: 24 } },
            // Sidebar
            h('div', { className: 'card' },
                h('div', { style: { padding: 8 } },
                    tabs.map(tab => h('div', {
                        key: tab.id,
                        style: {
                            padding: '12px 14px',
                            borderRadius: 10,
                            cursor: 'pointer',
                            background: activeTab === tab.id ? 'var(--primary-light)' : 'transparent',
                            color: activeTab === tab.id ? 'var(--primary)' : 'var(--text-secondary)',
                            fontWeight: activeTab === tab.id ? 600 : 500,
                            marginBottom: 4,
                            display: 'flex',
                            alignItems: 'center',
                            gap: 10,
                            fontSize: 14
                        },
                        onClick: () => setActiveTab(tab.id)
                    },
                        h('span', null, tab.icon),
                        tab.label.split(' ').slice(1).join(' ')
                    ))
                )
            ),
            
            // Content
            h('div', { className: 'card' },
                h('div', { className: 'card-body' },
                    activeTab === 'profile' && h('div', null,
                        h('h2', { style: { fontSize: 18, fontWeight: 600, marginBottom: 24 } }, 'ðŸ‘¤ Mon Profil'),
                        h('div', { className: 'form-group' },
                            h('label', { className: 'form-label' }, 'PrÃ©nom'),
                            h('input', { className: 'form-input', defaultValue: user?.first_name || '' })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', { className: 'form-label' }, 'Nom'),
                            h('input', { className: 'form-input', defaultValue: user?.last_name || '' })
                        ),
                        h('div', { className: 'form-group' },
                            h('label', { className: 'form-label' }, 'Email'),
                            h('input', { className: 'form-input', type: 'email', defaultValue: user?.email || '', disabled: true })
                        ),
                        h('button', { className: 'btn btn-primary' }, 'Enregistrer')
                    ),
                    
                    activeTab === 'appearance' && h('div', null,
                        h('h2', { style: { fontSize: 18, fontWeight: 600, marginBottom: 24 } }, 'ðŸŽ¨ Apparence'),
                        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 16 } },
                            ['light', 'dark', 'high-contrast'].map(t => h('div', {
                                key: t,
                                style: {
                                    padding: 20,
                                    borderRadius: 12,
                                    border: `2px solid ${theme === t ? 'var(--primary)' : 'var(--border)'}`,
                                    cursor: 'pointer',
                                    textAlign: 'center'
                                },
                                onClick: () => onThemeChange(t)
                            },
                                h('div', { style: { fontSize: 32, marginBottom: 8 } }, t === 'light' ? 'â˜€ï¸' : t === 'dark' ? 'ðŸŒ™' : 'ðŸ”²'),
                                h('div', { style: { fontWeight: 500 } }, t === 'light' ? 'Clair' : t === 'dark' ? 'Sombre' : 'Contraste Ã©levÃ©')
                            ))
                        ),
                        h('div', { style: { marginTop: 24 } },
                            h('h3', { style: { fontSize: 16, fontWeight: 600, marginBottom: 12 } }, 'Taille du texte'),
                            h('div', { className: 'tabs' },
                                ['Normal', 'Grand', 'TrÃ¨s grand'].map((size, i) => h('button', {
                                    key: size,
                                    className: 'tab',
                                    onClick: () => {
                                        document.body.classList.remove('font-size-large', 'font-size-xlarge');
                                        if (i === 1) document.body.classList.add('font-size-large');
                                        if (i === 2) document.body.classList.add('font-size-xlarge');
                                    }
                                }, size))
                            )
                        )
                    ),
                    
                    activeTab === 'shortcuts' && h(ShortcutsHelp, { isOpen: true, onClose: () => {} }),
                    
                    activeTab === 'security' && h('div', null,
                        h('h2', { style: { fontSize: 18, fontWeight: 600, marginBottom: 24 } }, 'ðŸ”’ SÃ©curitÃ©'),
                        h('div', { className: 'card', style: { background: 'var(--background)', marginBottom: 16 } },
                            h('div', { className: 'card-body', style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                                h('div', null,
                                    h('div', { style: { fontWeight: 600 } }, 'Authentification Ã  deux facteurs'),
                                    h('div', { style: { fontSize: 13, color: 'var(--muted)' } }, 'Ajoutez une couche de sÃ©curitÃ© supplÃ©mentaire')
                                ),
                                h('button', { className: 'btn btn-secondary' }, 'Activer')
                            )
                        ),
                        h('div', { className: 'card', style: { background: 'var(--background)' } },
                            h('div', { className: 'card-body', style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' } },
                                h('div', null,
                                    h('div', { style: { fontWeight: 600 } }, 'Changer le mot de passe'),
                                    h('div', { style: { fontSize: 13, color: 'var(--muted)' } }, 'DerniÃ¨re modification il y a 30 jours')
                                ),
                                h('button', { className: 'btn btn-secondary' }, 'Modifier')
                            )
                        )
                    ),
                    
                    activeTab === 'about' && h('div', null,
                        h('h2', { style: { fontSize: 18, fontWeight: 600, marginBottom: 24 } }, 'â„¹ï¸ Ã€ propos'),
                        h('div', { style: { textAlign: 'center', padding: 40 } },
                            h('div', { 
                                style: { 
                                    width: 80, height: 80, 
                                    background: 'linear-gradient(135deg, var(--primary), var(--secondary))',
                                    borderRadius: 20,
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: 'white',
                                    fontSize: 36,
                                    fontWeight: 800,
                                    margin: '0 auto 16px'
                                }
                            }, 'S'),
                            h('h3', { style: { fontSize: 24, fontWeight: 700 } }, 'StockApp'),
                            h('p', { style: { color: 'var(--muted)', marginBottom: 8 } }, 'Version 8.0.0 Optimized'),
                            h('p', { style: { color: 'var(--muted)', fontSize: 13 } }, 'Â© 2025 Auvergne Ascenseurs'),
                            h('div', { style: { marginTop: 24, display: 'flex', gap: 12, justifyContent: 'center' } },
                                h('button', { className: 'btn btn-secondary btn-sm' }, 'ðŸ“„ Changelog'),
                                h('button', { className: 'btn btn-secondary btn-sm' }, 'ðŸ› Reporter un bug')
                            )
                        )
                    )
                )
            )
        )
    );
});

// Simple placeholder pages
const PlaceholderPage = memo(({ title, icon }) => {
    return h('div', { style: { textAlign: 'center', padding: 60 } },
        h('div', { style: { fontSize: 64, marginBottom: 16 } }, icon),
        h('h1', { style: { fontSize: 28, fontWeight: 700, marginBottom: 8 } }, title),
        h('p', { style: { color: 'var(--muted)' } }, 'Cette page est en cours de dÃ©veloppement')
    );
});

console.log('âœ… StockApp v8.0 Pages loaded');

// ============================================
// CHAT COMPONENT (WhatsApp Style)
// ============================================
const ChatPanel = memo(({ isOpen, onClose, user, users = [] }) => {
    const [messages, setMessages] = useState([]);
    const [newMessage, setNewMessage] = useState('');
    const [activeConversation, setActiveConversation] = useState('team');
    const messagesEndRef = useRef(null);
    
    // Simulated messages
    useEffect(() => {
        setMessages([
            { id: 1, sender: 'Pierre D.', text: 'La panne au centre commercial est rÃ©solue ðŸ‘', time: '10:32', isMe: false },
            { id: 2, sender: 'Moi', text: 'Super ! Tu peux enchaÃ®ner sur Beaumont ?', time: '10:35', isMe: true },
            { id: 3, sender: 'Marie L.', text: "J'ai besoin d'un relais type RX2 pour Jaude, on en a en stock ?", time: '10:42', isMe: false },
            { id: 4, sender: 'Moi', text: 'Je vÃ©rifie et je te dis', time: '10:43', isMe: true }
        ]);
    }, []);
    
    // Scroll to bottom on new messages
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);
    
    const handleSend = () => {
        if (!newMessage.trim()) return;
        
        const msg = {
            id: Date.now(),
            sender: 'Moi',
            text: newMessage,
            time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            isMe: true
        };
        
        setMessages(prev => [...prev, msg]);
        setNewMessage('');
        haptic('light');
    };
    
    if (!isOpen) return null;
    
    return h('div', {
        style: {
            position: 'fixed',
            bottom: 100,
            right: 24,
            width: 380,
            height: 500,
            background: 'var(--card)',
            borderRadius: 20,
            boxShadow: '0 20px 60px rgba(0,0,0,0.2)',
            zIndex: 998,
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden',
            animation: 'scaleIn 0.2s ease'
        }
    },
        // Header
        h('div', {
            style: {
                background: 'linear-gradient(135deg, #25D366, #128C7E)',
                color: 'white',
                padding: '16px 20px',
                display: 'flex',
                alignItems: 'center',
                gap: 12
            }
        },
            h('div', {
                style: {
                    width: 40,
                    height: 40,
                    borderRadius: '50%',
                    background: 'rgba(255,255,255,0.2)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: 20
                }
            }, 'ðŸ‘¥'),
            h('div', { style: { flex: 1 } },
                h('div', { style: { fontWeight: 600, fontSize: 16 } }, 'Messages Ã‰quipe'),
                h('div', { style: { fontSize: 12, opacity: 0.9 } }, `${users.length || 4} membres`)
            ),
            h('button', {
                style: {
                    background: 'none',
                    border: 'none',
                    color: 'white',
                    fontSize: 20,
                    cursor: 'pointer',
                    padding: 4,
                    opacity: 0.8
                },
                onClick: onClose
            }, 'âœ•')
        ),
        
        // Messages
        h('div', {
            style: {
                flex: 1,
                padding: 16,
                overflowY: 'auto',
                background: '#E5DDD5',
                display: 'flex',
                flexDirection: 'column',
                gap: 8
            }
        },
            messages.map(msg => h('div', {
                key: msg.id,
                style: {
                    maxWidth: '80%',
                    padding: '10px 14px',
                    borderRadius: 12,
                    background: msg.isMe ? '#DCF8C6' : 'white',
                    alignSelf: msg.isMe ? 'flex-end' : 'flex-start',
                    borderBottomRightRadius: msg.isMe ? 4 : 12,
                    borderBottomLeftRadius: msg.isMe ? 12 : 4
                }
            },
                !msg.isMe && h('div', { style: { fontWeight: 600, fontSize: 12, color: '#25D366', marginBottom: 4 } }, msg.sender),
                h('div', { style: { fontSize: 14 } }, msg.text),
                h('div', { style: { fontSize: 11, color: 'var(--muted)', marginTop: 4, textAlign: 'right' } }, msg.time)
            )),
            h('div', { ref: messagesEndRef })
        ),
        
        // Input
        h('div', {
            style: {
                padding: '12px 16px',
                background: 'var(--background)',
                display: 'flex',
                gap: 12,
                alignItems: 'center'
            }
        },
            h('input', {
                type: 'text',
                placeholder: 'Ã‰crire un message...',
                value: newMessage,
                onChange: (e) => setNewMessage(e.target.value),
                onKeyDown: (e) => e.key === 'Enter' && handleSend(),
                style: {
                    flex: 1,
                    padding: '12px 16px',
                    border: 'none',
                    borderRadius: 24,
                    fontSize: 14,
                    background: 'white'
                }
            }),
            h('button', {
                onClick: handleSend,
                style: {
                    width: 44,
                    height: 44,
                    borderRadius: '50%',
                    background: '#25D366',
                    color: 'white',
                    border: 'none',
                    cursor: 'pointer',
                    fontSize: 18,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center'
                }
            }, 'âž¤')
        )
    );
});

// ============================================
// NOTIFICATION CENTER
// ============================================
const NotificationCenter = memo(({ isOpen, onClose, notifications = [] }) => {
    const [filter, setFilter] = useState('all');
    
    const filteredNotifications = notifications.filter(n => {
        if (filter === 'all') return true;
        if (filter === 'unread') return !n.read;
        return n.type === filter;
    });
    
    if (!isOpen) return null;
    
    return h('div', {
        style: {
            position: 'fixed',
            top: 'var(--header-height)',
            right: 0,
            width: 400,
            height: 'calc(100vh - var(--header-height))',
            background: 'var(--card)',
            borderLeft: '1px solid var(--border)',
            zIndex: 100,
            display: 'flex',
            flexDirection: 'column',
            animation: 'slideIn 0.3s ease'
        }
    },
        h('div', { style: { padding: '20px', borderBottom: '1px solid var(--border)' } },
            h('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 16 } },
                h('h2', { style: { fontSize: 18, fontWeight: 700 } }, 'ðŸ”” Notifications'),
                h('button', { className: 'btn btn-ghost btn-sm', onClick: onClose }, 'âœ•')
            ),
            h('div', { className: 'tabs' },
                ['all', 'unread', 'alerts', 'tasks'].map(f => h('button', {
                    key: f,
                    className: `tab ${filter === f ? 'active' : ''}`,
                    onClick: () => setFilter(f),
                    style: { fontSize: 12, padding: '6px 12px' }
                }, f === 'all' ? 'Toutes' : f === 'unread' ? 'Non lues' : f === 'alerts' ? 'Alertes' : 'TÃ¢ches'))
            )
        ),
        h('div', { style: { flex: 1, overflowY: 'auto' } },
            filteredNotifications.length === 0
                ? h(EmptyState, { icon: 'ðŸ””', title: 'Aucune notification' })
                : filteredNotifications.map(notif => h('div', {
                    key: notif.id,
                    style: {
                        padding: '16px 20px',
                        borderBottom: '1px solid var(--border)',
                        background: notif.read ? 'transparent' : 'var(--primary-light)',
                        cursor: 'pointer'
                    }
                },
                    h('div', { style: { display: 'flex', gap: 12 } },
                        h('span', { style: { fontSize: 20 } }, notif.icon || 'ðŸ“Œ'),
                        h('div', { style: { flex: 1 } },
                            h('div', { style: { fontWeight: 600, marginBottom: 4 } }, notif.title),
                            h('div', { style: { fontSize: 13, color: 'var(--muted)' } }, notif.message),
                            h('div', { style: { fontSize: 11, color: 'var(--muted)', marginTop: 8 } }, formatRelative(notif.created_at))
                        )
                    )
                ))
        ),
        h('div', { style: { padding: 16, borderTop: '1px solid var(--border)' } },
            h('button', { className: 'btn btn-ghost', style: { width: '100%' } }, 'Tout marquer comme lu')
        )
    );
});

// ============================================
// WIDGET PICKER MODAL
// ============================================
const WidgetPicker = memo(({ isOpen, onClose, currentWidgets, onSave }) => {
    const [selectedWidgets, setSelectedWidgets] = useState(currentWidgets || WidgetService.getUserWidgets());
    
    const toggleWidget = (widgetId) => {
        const exists = selectedWidgets.find(w => w.id === widgetId);
        if (exists) {
            setSelectedWidgets(prev => prev.filter(w => w.id !== widgetId));
        } else {
            const widget = WidgetService.availableWidgets.find(w => w.id === widgetId);
            if (widget) {
                setSelectedWidgets(prev => [...prev, { ...widget, position: { x: 0, y: prev.length } }]);
            }
        }
    };
    
    const handleSave = () => {
        WidgetService.saveWidgets(selectedWidgets);
        onSave(selectedWidgets);
        onClose();
    };
    
    return h(Modal, {
        isOpen,
        onClose,
        title: 'âš™ï¸ Personnaliser le Dashboard',
        size: 'lg',
        footer: h('div', { style: { display: 'flex', gap: 12 } },
            h('button', { className: 'btn btn-secondary', onClick: () => { setSelectedWidgets(WidgetService.resetWidgets()); } }, 'RÃ©initialiser'),
            h('button', { className: 'btn btn-primary', onClick: handleSave }, 'Enregistrer')
        )
    },
        h('p', { style: { marginBottom: 20, color: 'var(--muted)' } }, 
            'SÃ©lectionnez les widgets Ã  afficher sur votre tableau de bord'
        ),
        h('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 12 } },
            WidgetService.availableWidgets.map(widget => {
                const isSelected = selectedWidgets.some(w => w.id === widget.id);
                return h('div', {
                    key: widget.id,
                    style: {
                        padding: 16,
                        borderRadius: 12,
                        border: `2px solid ${isSelected ? 'var(--primary)' : 'var(--border)'}`,
                        background: isSelected ? 'var(--primary-light)' : 'var(--card)',
                        cursor: 'pointer',
                        textAlign: 'center',
                        transition: 'all 0.15s'
                    },
                    onClick: () => toggleWidget(widget.id)
                },
                    h('div', { style: { fontSize: 28, marginBottom: 8 } }, widget.icon),
                    h('div', { style: { fontSize: 13, fontWeight: 500 } }, widget.name),
                    h('div', { style: { fontSize: 11, color: 'var(--muted)' } }, widget.size)
                );
            })
        )
    );
});

// ============================================
// ONBOARDING TOUR
// ============================================
const OnboardingTour = memo(({ isOpen, onComplete }) => {
    const [step, setStep] = useState(0);
    
    const steps = [
        { target: '.sidebar', title: 'Navigation', content: 'AccÃ©dez rapidement Ã  toutes les sections de l\'application', position: 'right' },
        { target: '.header-btn[title*="Recherche"]', title: 'Recherche rapide', content: 'Utilisez âŒ˜K pour rechercher n\'importe quoi', position: 'bottom' },
        { target: '.kpi-card', title: 'KPIs interactifs', content: 'Cliquez sur les cartes pour accÃ©der aux dÃ©tails', position: 'bottom' },
        { target: '.chat-fab', title: 'Messagerie', content: 'Communiquez avec votre Ã©quipe en temps rÃ©el', position: 'left' }
    ];
    
    if (!isOpen || step >= steps.length) return null;
    
    const currentStep = steps[step];
    
    return h('div', {
        style: {
            position: 'fixed',
            inset: 0,
            background: 'rgba(0,0,0,0.5)',
            zIndex: 2000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
        }
    },
        h('div', {
            style: {
                background: 'var(--card)',
                borderRadius: 16,
                padding: 24,
                maxWidth: 400,
                textAlign: 'center'
            }
        },
            h('div', { style: { fontSize: 48, marginBottom: 16 } }, step === 0 ? 'ðŸ‘‹' : step === 1 ? 'ðŸ”' : step === 2 ? 'ðŸ“Š' : 'ðŸ’¬'),
            h('h3', { style: { fontSize: 20, fontWeight: 700, marginBottom: 8 } }, currentStep.title),
            h('p', { style: { color: 'var(--muted)', marginBottom: 24 } }, currentStep.content),
            h('div', { style: { display: 'flex', gap: 8, marginBottom: 16 } },
                steps.map((_, i) => h('div', {
                    key: i,
                    style: {
                        width: 8,
                        height: 8,
                        borderRadius: '50%',
                        background: i === step ? 'var(--primary)' : 'var(--border)'
                    }
                }))
            ),
            h('div', { style: { display: 'flex', gap: 12, justifyContent: 'center' } },
                h('button', { className: 'btn btn-ghost', onClick: onComplete }, 'Passer'),
                h('button', { 
                    className: 'btn btn-primary',
                    onClick: () => step < steps.length - 1 ? setStep(step + 1) : onComplete()
                }, step < steps.length - 1 ? 'Suivant' : 'Terminer')
            )
        )
    );
});

console.log('âœ… StockApp v8.0 Panels loaded');

// ============================================
// MAIN APP COMPONENT
// ============================================
const App = () => {
    // ============ STATE ============
    // Auth & User
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [authLoading, setAuthLoading] = useState(true);
    
    // Navigation
    const [currentPage, setCurrentPage] = useState('dashboard');
    const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
    const [sidebarOpen, setSidebarOpen] = useState(false);
    
    // Theme
    const [theme, setTheme] = useLocalStorage('stockapp_theme', 'light');
    
    // Data (with reducer for complex state)
    const [data, dispatch] = useReducer(dataReducer, initialDataState);
    
    // UI State
    const [toasts, setToasts] = useState([]);
    const [showCommandPalette, setShowCommandPalette] = useState(false);
    const [showShortcutsHelp, setShowShortcutsHelp] = useState(false);
    const [showNotificationCenter, setShowNotificationCenter] = useState(false);
    const [showChatPanel, setShowChatPanel] = useState(false);
    const [showWidgetPicker, setShowWidgetPicker] = useState(false);
    const [showOnboarding, setShowOnboarding] = useState(false);
    const [notifications, setNotifications] = useState([]);
    const [chatUnreadCount, setChatUnreadCount] = useState(2);
    
    // Realtime
    const isOnline = useOnlineStatus();
    const [realtimeStatus, setRealtimeStatus] = useState('connecting');
    
    // Widgets config
    const [widgets, setWidgets] = useState(WidgetService.getUserWidgets());
    
    // ============ THEME EFFECT ============
    useEffect(() => {
        document.documentElement.setAttribute('data-theme', theme);
    }, [theme]);
    
    // ============ AUTH CHECK ============
    useEffect(() => {
        // En mode demo, pas de verification auth
        if (IS_DEMO_MODE) {
            setAuthLoading(false);
            return;
        }
        
        const checkAuth = async () => {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session?.user) {
                    // Get user profile
                    const { data: profile } = await supabaseClient
                        .from('users')
                        .select('*')
                        .eq('id', session.user.id)
                        .single();
                    
                    setUser({ ...session.user, ...profile });
                    
                    // Check if first login for onboarding
                    const hasSeenOnboarding = localStorage.getItem('stockapp_onboarding_complete');
                    if (!hasSeenOnboarding) {
                        setShowOnboarding(true);
                    }
                }
            } catch (error) {
                console.error('Auth check error:', error);
            } finally {
                setAuthLoading(false);
            }
        };
        
        checkAuth();
        
        // Listen for auth changes
        const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session?.user) {
                const { data: profile } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('id', session.user.id)
                    .single();
                setUser({ ...session.user, ...profile });
            } else if (event === 'SIGNED_OUT') {
                setUser(null);
            }
        });
        
        return () => subscription.unsubscribe();
    }, []);
    
    // ============ DEMO DATA ============
    const DEMO_DATA = {
        categories: [
            { id: 'cat-1', name: 'PiÃ¨ces mÃ©caniques', color: '#3B82F6', icon: 'âš™ï¸' },
            { id: 'cat-2', name: 'Ã‰lectronique', color: '#10B981', icon: 'ðŸ”Œ' },
            { id: 'cat-3', name: 'SÃ©curitÃ©', color: '#F59E0B', icon: 'ðŸ”’' },
            { id: 'cat-4', name: 'Hydraulique', color: '#8B5CF6', icon: 'ðŸ’§' }
        ],
        parts: [
            { id: 'part-1', name: 'CÃ¢ble de traction 8mm', reference: 'CAB-TR-008', category_id: 'cat-1', quantity: 45, min_stock: 20, price: 125.50, location: 'A1-01', supplier: 'Otis' },
            { id: 'part-2', name: 'Contacteur de porte', reference: 'CTR-PT-001', category_id: 'cat-2', quantity: 8, min_stock: 10, price: 89.00, location: 'B2-03', supplier: 'Schindler' },
            { id: 'part-3', name: 'Bouton appel cabine', reference: 'BTN-CAB-01', category_id: 'cat-2', quantity: 32, min_stock: 15, price: 45.00, location: 'B2-05', supplier: 'ThyssenKrupp' },
            { id: 'part-4', name: 'Huile hydraulique 5L', reference: 'HYD-OIL-5L', category_id: 'cat-4', quantity: 3, min_stock: 5, price: 78.00, location: 'C1-02', supplier: 'Total' },
            { id: 'part-5', name: 'Photocellule sÃ©curitÃ©', reference: 'SEC-PHO-01', category_id: 'cat-3', quantity: 12, min_stock: 8, price: 156.00, location: 'A2-04', supplier: 'Kone' },
            { id: 'part-6', name: 'Variateur de frÃ©quence', reference: 'VAR-FRQ-01', category_id: 'cat-2', quantity: 2, min_stock: 3, price: 890.00, location: 'D1-01', supplier: 'ABB' },
            { id: 'part-7', name: 'Amortisseur de fosse', reference: 'AMO-FOS-01', category_id: 'cat-3', quantity: 6, min_stock: 4, price: 320.00, location: 'C2-03', supplier: 'Otis' },
            { id: 'part-8', name: 'Guide cabine', reference: 'GUI-CAB-01', category_id: 'cat-1', quantity: 18, min_stock: 10, price: 65.00, location: 'A1-03', supplier: 'Schindler' }
        ],
        tasks: [
            { id: 'task-1', type: 'Maintenance', description: 'Entretien prÃ©ventif ascenseur', location: 'RÃ©sidence Les Cerisiers', status: 'en_cours', priority: 'normale', scheduled_date: new Date().toISOString().split('T')[0], assigned_to: 'demo-user-001' },
            { id: 'task-2', type: 'DÃ©pannage', description: 'Porte cabine bloquÃ©e', location: 'Immeuble Voltaire', status: 'nouveau', priority: 'urgente', due_date: new Date().toISOString().split('T')[0], assigned_to: 'demo-user-001' },
            { id: 'task-3', type: 'Installation', description: 'Pose nouveau variateur', location: 'Clinique St Jean', status: 'en_attente', priority: 'haute', scheduled_date: new Date(Date.now() + 86400000).toISOString().split('T')[0] },
            { id: 'task-4', type: 'ContrÃ´le', description: 'VÃ©rification quinquennale', location: 'Mairie Annexe', status: 'termine', priority: 'normale', completed_date: new Date(Date.now() - 86400000).toISOString() },
            { id: 'task-5', type: 'DÃ©pannage', description: 'Alarme cabine dÃ©fectueuse', location: 'Centre Commercial Jaude', status: 'nouveau', priority: 'critique', due_date: new Date().toISOString().split('T')[0] }
        ],
        orders: [
            { id: 'order-1', reference: 'CMD-20260107-0001', supplier: 'Otis', status: 'en-commande', total_amount: 1250.00, expected_date: new Date(Date.now() + 604800000).toISOString().split('T')[0], items: [{ part_id: 'part-1', quantity: 10 }] },
            { id: 'order-2', reference: 'CMD-20260105-0001', supplier: 'Schindler', status: 'expedie', total_amount: 890.00, items: [{ part_id: 'part-2', quantity: 10 }] }
        ],
        requests: [
            { id: 'req-1', type: 'DÃ©pannage', title: 'Ascenseur bloquÃ©', description: 'Ascenseur bloquÃ© au 3Ã¨me Ã©tage', status: 'nouveau', priority: 'urgente', sector: 'Clermont-Nord', location: 'RÃ©sidence du Parc' },
            { id: 'req-2', type: 'Information', title: 'Demande devis modernisation', description: 'Client souhaite moderniser son ascenseur', status: 'en_cours', priority: 'normale', sector: 'Clermont-Sud', location: 'Cabinet MÃ©dical Blatin' }
        ],
        equipements: [
            { id: 'equip-1', nom: 'ASC-001', immeuble: 'RÃ©sidence Les Cerisiers', adresse: '12 rue des Fleurs', ville: 'Clermont-Ferrand', secteur: 'Clermont-Nord', client: 'Syndic ABC', marque: 'Otis', modele: 'Gen2', annee_installation: 2015, statut: 'actif', en_panne: false, prochain_entretien: new Date(Date.now() + 604800000).toISOString().split('T')[0], score_ml: 25 },
            { id: 'equip-2', nom: 'ASC-002', immeuble: 'Immeuble Voltaire', adresse: '45 av. Voltaire', ville: 'Clermont-Ferrand', secteur: 'Clermont-Nord', client: 'Copro Voltaire', marque: 'Schindler', modele: '3300', annee_installation: 2008, statut: 'arret', en_panne: true, score_ml: 78 },
            { id: 'equip-3', nom: 'ASC-003', immeuble: 'Clinique St Jean', adresse: '8 rue St Jean', ville: 'Clermont-Ferrand', secteur: 'Clermont-Sud', client: 'Clinique St Jean', marque: 'Kone', modele: 'MonoSpace', annee_installation: 2020, statut: 'actif', en_panne: false, prochain_controle: new Date(Date.now() + 2592000000).toISOString().split('T')[0], score_ml: 12 }
        ],
        pannes: [
            { id: 'panne-1', equipement_id: 'equip-2', date_signalement: new Date().toISOString(), statut: 'signalee', type_panne: 'MÃ©canique', description: 'Porte paliÃ¨re bloquÃ©e', signale_par: 'Gardien' }
        ],
        entretiens: [
            { id: 'entr-1', equipement_id: 'equip-1', type_entretien: 'preventif', date_planifiee: new Date(Date.now() + 604800000).toISOString().split('T')[0], statut: 'planifie', technicien_id: 'demo-user-001' }
        ],
        users: [
            { id: 'demo-user-001', email: 'demo@stockapp.fr', first_name: 'Nicolas', last_name: 'Demo', role: 'admin', is_active: true },
            { id: 'demo-user-002', email: 'tech@stockapp.fr', first_name: 'Pierre', last_name: 'Martin', role: 'technicien', is_active: true }
        ]
    };
    
    // ============ INITIAL DATA LOAD ============
    useEffect(() => {
        if (!user) return;
        
        const loadData = async () => {
            dispatch({ type: 'SET_LOADING', payload: true });
            
            // Mode demo - utiliser les donnees locales
            if (IS_DEMO_MODE || user.id === 'demo-user-001') {
                dispatch({
                    type: 'SET_DATA',
                    payload: {
                        ...DEMO_DATA,
                        loading: false
                    }
                });
                
                // Analyze data for AI suggestions
                AIAssistant.analyze(DEMO_DATA);
                
                console.log('âœ… Demo data loaded');
                return;
            }
            
            // Mode production - charger depuis Supabase
            try {
                const [
                    { data: tasks },
                    { data: parts },
                    { data: orders },
                    { data: requests },
                    { data: equipements },
                    { data: pannes },
                    { data: entretiens },
                    { data: users },
                    { data: categories }
                ] = await Promise.all([
                    supabaseClient.from('tasks').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('parts').select('*').order('name'),
                    supabaseClient.from('orders').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('requests').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('equipements').select('*').order('nom'),
                    supabaseClient.from('pannes').select('*').order('date_signalement', { ascending: false }),
                    supabaseClient.from('entretiens').select('*').order('date_planifiee', { ascending: false }),
                    supabaseClient.from('users').select('*'),
                    supabaseClient.from('categories').select('*').order('name')
                ]);
                
                dispatch({
                    type: 'SET_DATA',
                    payload: {
                        tasks: tasks || [],
                        parts: parts || [],
                        orders: orders || [],
                        requests: requests || [],
                        equipements: equipements || [],
                        pannes: pannes || [],
                        entretiens: entretiens || [],
                        users: users || [],
                        categories: categories || [],
                        loading: false
                    }
                });
                
                // Analyze data for AI suggestions
                AIAssistant.analyze({
                    tasks: tasks || [],
                    parts: parts || [],
                    equipements: equipements || [],
                    requests: requests || []
                });
                
                // Check notification rules
                const triggered = NotificationService.checkRules({
                    tasks: tasks || [],
                    parts: parts || [],
                    equipements: equipements || []
                });
                
                if (triggered.length > 0) {
                    setNotifications(prev => [
                        ...triggered.map(t => ({
                            id: generateId(),
                            title: t.title,
                            message: '',
                            icon: t.id.includes('equipment') ? 'ðŸš¨' : t.id.includes('task') ? 'â°' : 'ðŸ“¦',
                            type: t.priority,
                            read: false,
                            created_at: new Date().toISOString()
                        })),
                        ...prev
                    ]);
                }
                
            } catch (error) {
                console.error('Data load error:', error);
                showToast('Erreur lors du chargement des donnÃ©es', 'error');
            }
        };
        
        loadData();
    }, [user]);
    
    // ============ REALTIME SUBSCRIPTIONS ============
    useEffect(() => {
        if (!user) return;
        
        const tables = ['tasks', 'parts', 'orders', 'requests', 'equipements', 'pannes', 'entretiens'];
        const channels = [];
        
        tables.forEach(table => {
            const channel = supabaseClient
                .channel(`realtime:${table}:${user.id}`)
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table },
                    (payload) => {
                        console.log(`Realtime ${table}:`, payload);
                        
                        // Update local state
                        dispatch({
                            type: 'REALTIME_UPDATE',
                            payload: { ...payload, table }
                        });
                        
                        // Invalidate cache
                        DataCache.invalidate();
                        
                        // Show toast for important changes
                        if (payload.eventType === 'INSERT') {
                            if (table === 'requests') {
                                const req = payload.new;
                                showToast(`Nouvelle demande: ${req.type || 'Demande'}`, 'info');
                                playSound('notification');
                                haptic('medium');
                                
                                // Add to notifications
                                setNotifications(prev => [{
                                    id: generateId(),
                                    title: `Nouvelle demande: ${req.type || 'Demande'}`,
                                    message: req.description?.substring(0, 50) || '',
                                    icon: 'ðŸ“©',
                                    type: 'info',
                                    read: false,
                                    created_at: new Date().toISOString()
                                }, ...prev]);
                            } else if (table === 'pannes') {
                                showToast('ðŸš¨ Nouvelle panne signalÃ©e !', 'error');
                                playSound('error');
                                haptic('heavy');
                                
                                // Send push notification
                                NotificationService.send('ðŸš¨ Nouvelle panne signalÃ©e', {
                                    body: payload.new.description || 'Une panne a Ã©tÃ© signalÃ©e',
                                    tag: 'panne'
                                });
                            }
                        }
                        
                        if (payload.eventType === 'UPDATE' && table === 'equipements') {
                            const eq = payload.new;
                            const oldEq = payload.old;
                            
                            // Equipment went to arrÃªt
                            if (eq.statut === 'arret' && oldEq.statut !== 'arret') {
                                showToast(`âš ï¸ ${eq.nom || 'Ã‰quipement'} est Ã  l'arrÃªt`, 'warning');
                                playSound('error');
                                haptic('heavy');
                            }
                        }
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        setRealtimeStatus('connected');
                    } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                        setRealtimeStatus('disconnected');
                    } else {
                        setRealtimeStatus('connecting');
                    }
                });
            
            channels.push(channel);
        });
        
        // Cleanup
        return () => {
            channels.forEach(channel => supabaseClient.removeChannel(channel));
        };
    }, [user]);
    
    // ============ KEYBOARD SHORTCUTS ============
    useEffect(() => {
        KeyboardService.init({
            search: () => setShowCommandPalette(true),
            new: () => {
                // Context-aware new action
                if (currentPage === 'tasks') {
                    // Open new task modal
                } else if (currentPage === 'stock') {
                    // Open new part modal
                }
            },
            save: () => {
                showToast('SauvegardÃ©', 'success');
            },
            close: () => {
                setShowCommandPalette(false);
                setShowShortcutsHelp(false);
                setShowNotificationCenter(false);
                setShowWidgetPicker(false);
            },
            help: () => setShowShortcutsHelp(true),
            goto_dashboard: () => setCurrentPage('dashboard'),
            goto_stock: () => setCurrentPage('stock'),
            goto_tasks: () => setCurrentPage('tasks'),
            goto_planning: () => setCurrentPage('planning')
        });
    }, [currentPage]);
    
    // ============ OFFLINE SYNC ============
    useEffect(() => {
        if (isOnline) {
            OfflineQueue.process();
        }
    }, [isOnline]);
    
    // ============ NOTIFICATION PERMISSION ============
    useEffect(() => {
        NotificationService.init();
    }, []);
    
    // ============ HELPER FUNCTIONS ============
    const showToast = useCallback((title, type = 'info', message = '') => {
        const id = generateId();
        setToasts(prev => [...prev, { id, title, type, message }]);
    }, []);
    
    const removeToast = useCallback((id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
    }, []);
    
    const handleNavigate = useCallback((page) => {
        setCurrentPage(page);
        setSidebarOpen(false);
        haptic('light');
    }, []);
    
    const handleThemeChange = useCallback((newTheme) => {
        setTheme(newTheme);
    }, []);
    
    const handleToolAction = useCallback((toolId) => {
        switch (toolId) {
            case 'widgets':
                setShowWidgetPicker(true);
                break;
            case 'settings':
                setCurrentPage('settings');
                break;
            default:
                showToast(`Outil ${toolId} ouvert`, 'info');
        }
    }, []);
    
    const completeOnboarding = useCallback(() => {
        localStorage.setItem('stockapp_onboarding_complete', 'true');
        setShowOnboarding(false);
    }, []);
    
    // ============ BADGES CALCULATION ============
    const badges = useMemo(() => ({
        stockCritique: (data.parts || []).filter(p => p.quantity <= (p.min_stock || 0)).length,
        tasksUrgent: (data.tasks || []).filter(t => ['haute', 'urgente', 'critique'].includes(t.priority) && t.status !== 'termine').length,
        requestsNew: (data.requests || []).filter(r => r.status === 'nouveau').length
    }), [data.parts, data.tasks, data.requests]);
    
    // ============ RENDER PAGE ============
    const renderPage = () => {
        const pageProps = {
            data,
            user,
            onNavigate: handleNavigate,
            showToast,
            loading: data.loading
        };
        
        switch (currentPage) {
            case 'dashboard':
                return h(DashboardPage, pageProps);
            case 'stock':
                return h(StockPage, pageProps);
            case 'tasks':
                return h(TasksPage, pageProps);
            case 'settings':
                return h(SettingsPage, { 
                    user, 
                    theme, 
                    onThemeChange: handleThemeChange,
                    showToast 
                });
            case 'orders':
                return h(PlaceholderPage, { title: 'Commandes', icon: 'ðŸ›’' });
            case 'requests':
                return h(PlaceholderPage, { title: 'Demandes', icon: 'ðŸ“©' });
            case 'planning':
                return h(PlaceholderPage, { title: 'Planning', icon: 'ðŸ“…' });
            case 'interventions':
                return h(PlaceholderPage, { title: 'Interventions', icon: 'ðŸ”§' });
            case 'map':
                return h(PlaceholderPage, { title: 'Carte', icon: 'ðŸ—ºï¸' });
            case 'parc':
                return h(PlaceholderPage, { title: 'Parc ascenseurs', icon: 'ðŸ›—' });
            case 'ai':
                return h(PlaceholderPage, { title: 'IA PrÃ©dictive', icon: 'ðŸ¤–' });
            default:
                return h(DashboardPage, pageProps);
        }
    };
    
    // ============ AUTH LOADING ============
    if (authLoading) {
        return null; // Keep showing the loading screen
    }
    
    // ============ LOGIN SCREEN ============
    if (!user) {
        return h(LoginPage, { 
            onLogin: (userData) => setUser(userData),
            showToast 
        });
    }
    
    // ============ MAIN RENDER ============
    return h('div', { className: `app ${sidebarCollapsed ? 'sidebar-collapsed' : ''}` },
        // Sidebar
        h(Sidebar, {
            collapsed: sidebarCollapsed,
            currentPage,
            onNavigate: handleNavigate,
            onToggleCollapse: () => setSidebarCollapsed(!sidebarCollapsed),
            badges
        }),
        
        // Main Content
        h('main', { className: 'main-content' },
            // Header
            h(Header, {
                user,
                realtimeStatus: isOnline ? realtimeStatus : 'disconnected',
                onSearch: () => setShowCommandPalette(true),
                onNotifications: () => setShowNotificationCenter(true),
                onTools: handleToolAction,
                onThemeToggle: () => setTheme(theme === 'dark' ? 'light' : 'dark'),
                onUserMenu: () => setCurrentPage('settings'),
                notificationCount: notifications.filter(n => !n.read).length,
                theme
            }),
            
            // Page Content
            h('div', { className: 'page-content' },
                // Offline Banner
                !isOnline && h('div', {
                    style: {
                        background: 'var(--warning-light)',
                        color: 'var(--warning)',
                        padding: '12px 20px',
                        borderRadius: 'var(--radius)',
                        marginBottom: 16,
                        display: 'flex',
                        alignItems: 'center',
                        gap: 12
                    }
                },
                    h('span', { style: { fontSize: 20 } }, 'ðŸ“´'),
                    h('div', null,
                        h('strong', null, 'Mode hors-ligne'),
                        h('div', { style: { fontSize: 13 } }, 
                            `${OfflineQueue.getCount()} action(s) en attente de synchronisation`
                        )
                    )
                ),
                
                // Page
                renderPage()
            )
        ),
        
        // Chat FAB
        h('button', {
            className: 'chat-fab',
            onClick: () => setShowChatPanel(true),
            'aria-label': 'Ouvrir le chat'
        },
            'ðŸ’¬',
            chatUnreadCount > 0 && h('span', { className: 'badge' }, chatUnreadCount)
        ),
        
        // Chat Panel
        h(ChatPanel, {
            isOpen: showChatPanel,
            onClose: () => setShowChatPanel(false),
            user,
            users: data.users
        }),
        
        // Notification Center
        h(NotificationCenter, {
            isOpen: showNotificationCenter,
            onClose: () => setShowNotificationCenter(false),
            notifications
        }),
        
        // Command Palette
        h(CommandPalette, {
            isOpen: showCommandPalette,
            onClose: () => setShowCommandPalette(false),
            onNavigate: handleNavigate,
            data
        }),
        
        // Shortcuts Help
        h(ShortcutsHelp, {
            isOpen: showShortcutsHelp,
            onClose: () => setShowShortcutsHelp(false)
        }),
        
        // Widget Picker
        h(WidgetPicker, {
            isOpen: showWidgetPicker,
            onClose: () => setShowWidgetPicker(false),
            currentWidgets: widgets,
            onSave: setWidgets
        }),
        
        // Onboarding Tour
        h(OnboardingTour, {
            isOpen: showOnboarding,
            onComplete: completeOnboarding
        }),
        
        // Toast Container
        h('div', { className: 'toast-container', role: 'status', 'aria-live': 'polite' },
            toasts.map(toast => h(Toast, {
                key: toast.id,
                ...toast,
                onClose: removeToast
            }))
        )
    );
};

// ============================================
// LOGIN PAGE
// ============================================
const LoginPage = memo(({ onLogin, showToast }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);
    
    const handleSubmit = async (e) => {
        e.preventDefault();
        
        // Si mode demo, utiliser le login demo
        if (IS_DEMO_MODE) {
            handleDemoLogin();
            return;
        }
        
        setLoading(true);
        
        try {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) throw error;
            
            // Get user profile
            const { data: profile } = await supabaseClient
                .from('users')
                .select('*')
                .eq('id', data.user.id)
                .single();
            
            onLogin({ ...data.user, ...profile });
            playSound('success');
            
        } catch (error) {
            showToast(error.message || 'Erreur de connexion', 'error');
        } finally {
            setLoading(false);
        }
    };
    
    // Demo login
    const handleDemoLogin = () => {
        onLogin({
            id: 'demo-user-001',
            email: 'demo@stockapp.fr',
            first_name: 'Nicolas',
            last_name: 'Demo',
            role: 'admin',
            sectors: ['Clermont-Nord', 'Clermont-Sud'],
            is_active: true
        });
        playSound('success');
    };
    
    return h('div', {
        style: {
            minHeight: '100vh',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            background: 'linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%)',
            padding: 24
        }
    },
        h('div', {
            style: {
                background: 'var(--card)',
                borderRadius: 24,
                padding: 40,
                width: '100%',
                maxWidth: 400,
                boxShadow: 'var(--shadow-xl)'
            }
        },
            h('div', { style: { textAlign: 'center', marginBottom: 32 } },
                h('div', {
                    style: {
                        width: 64,
                        height: 64,
                        background: 'linear-gradient(135deg, var(--primary), var(--secondary))',
                        borderRadius: 16,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        color: 'white',
                        fontSize: 28,
                        fontWeight: 800,
                        margin: '0 auto 16px'
                    }
                }, 'S'),
                h('h1', { style: { fontSize: 24, fontWeight: 700, marginBottom: 4 } }, 'StockApp'),
                h('p', { style: { color: 'var(--muted)' } }, 'Connectez-vous pour continuer')
            ),
            
            h('form', { onSubmit: handleSubmit },
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Email'),
                    h('input', {
                        className: 'form-input',
                        type: 'email',
                        value: email,
                        onChange: (e) => setEmail(e.target.value),
                        placeholder: 'votre@email.com',
                        required: true,
                        autoComplete: 'email'
                    })
                ),
                h('div', { className: 'form-group' },
                    h('label', { className: 'form-label' }, 'Mot de passe'),
                    h('input', {
                        className: 'form-input',
                        type: 'password',
                        value: password,
                        onChange: (e) => setPassword(e.target.value),
                        placeholder: 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢',
                        required: true,
                        autoComplete: 'current-password'
                    })
                ),
                h('button', {
                    className: 'btn btn-primary',
                    type: 'submit',
                    disabled: loading,
                    style: { width: '100%', marginTop: 8 }
                }, loading ? 'Connexion...' : 'Se connecter'),
                
                h('div', { style: { textAlign: 'center', marginTop: 24 } },
                    h('button', {
                        type: 'button',
                        className: 'btn btn-ghost',
                        onClick: handleDemoLogin
                    }, 'ðŸŽ® Mode DÃ©mo')
                )
            )
        )
    );
});

// ============================================
// INITIALIZE APP
// ============================================
document.getElementById('loading').style.display = 'none';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(h(App));

console.log('ðŸš€ StockApp v8.0 Optimized - Ready!');
console.log('ðŸ“Š Features: Realtime, PWA, AI Assistant, Skeleton Loaders, Keyboard Shortcuts, Chat, Notifications');
</script>

</body>
</html>
